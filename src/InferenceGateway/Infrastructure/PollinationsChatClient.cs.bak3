// <copyright file="PollinationsChatClient.cs" company="PlaceholderCompany">
// Copyright (c) PlaceholderCompany. All rights reserved.
// </copyright>

namespace Synaxis.InferenceGateway.Infrastructure
{
    using System;
    using System.Collections.Generic;
    using System.Net.Http;
    using System.Net.Http.Json;
    using System.Runtime.CompilerServices;
    using System.Text;
    using System.Text.Json;
    using System.Text.Json.Serialization;
    using System.Threading;
    using System.Threading.Tasks;
    using Microsoft.Extensions.AI;

    /// <summary>
    /// PollinationsChatClient class.
    /// </summary>
    public class PollinationsChatClient : IChatClient
    {
        private readonly HttpClient _httpClient;
        private readonly string _modelId;
        private readonly ChatClientMetadata _metadata;

        /// <summary>
        /// Initializes a new instance of the <see cref="PollinationsChatClient"/> class.
        /// </summary>
        public PollinationsChatClient(HttpClient httpClient, string? modelId = null)
        {
            this._httpClient = httpClient;
            this._modelId = modelId ?? "openai";
#pragma warning disable S1075 // URIs should not be hardcoded - API endpoint
            this._metadata = new ChatClientMetadata("Pollinations", new Uri("https://text.pollinations.ai/"), this._modelId);
#pragma warning restore S1075 // URIs should not be hardcoded
        }

        public ChatClientMetadata Metadata => this._metadata;

        /// <inheritdoc/>
        public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> messages, ChatOptions? options = null, CancellationToken cancellationToken = default)
        {
            var request = this.CreateRequest(messages, options, stream: false);
#pragma warning disable S1075 // URIs should not be hardcoded - API endpoint
            var response = await this._httpClient.PostAsJsonAsync("https://text.pollinations.ai/", request, cancellationToken).ConfigureAwait(false);
#pragma warning restore S1075 // URIs should not be hardcoded
            response.EnsureSuccessStatusCode();

            var content = await response.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false);

            var chatResponse = new ChatResponse(new ChatMessage(ChatRole.Assistant, content));
            chatResponse.ModelId = this._modelId;
            return chatResponse;
        }

        public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> messages, ChatOptions? options = null, [EnumeratorCancellation] CancellationToken cancellationToken = default)
        {
            var request = this.CreateRequest(messages, options, stream: true);

#pragma warning disable S1075 // URIs should not be hardcoded - API endpoint
            var httpRequest = new HttpRequestMessage(HttpMethod.Post, "https://text.pollinations.ai/")
#pragma warning restore S1075 // URIs should not be hardcoded
            {
                Content = JsonContent.Create(request),
            };

            using var response = await this._httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancellationToken).ConfigureAwait(false);
            response.EnsureSuccessStatusCode();

            using var stream = await response.Content.ReadAsStreamAsync(cancellationToken).ConfigureAwait(false);
            using var reader = new System.IO.StreamReader(stream);

            // Pollinations streaming is just raw text updates if I recall correctly,
            // but if we use the POST endpoint it might be different.
            // Actually, Pollinations POST endpoint with stream: true returns SSE if requested,
            // but often it just returns chunks of text.

            char[] buffer = new char[1024];
            string? line;
            while ((line = await reader.ReadLineAsync().ConfigureAwait(false)) is not null)
            {
                int read = await reader.ReadAsync(buffer, 0, buffer.Length).ConfigureAwait(false);
                if (read > 0)
                {
                    var text = new string(buffer, 0, read);
                    var update = new ChatResponseUpdate
                    {
                        Role = ChatRole.Assistant,
                        ModelId = this._modelId,
                    };
                    update.Contents.Add(new TextContent(text));
                    yield return update;
                }
            }
        }

        private object CreateRequest(IEnumerable<ChatMessage> messages, ChatOptions? options, bool stream)
        {
            var messageList = new List<object>();
            foreach (var msg in messages)
            {
                messageList.Add(new
                {
                    role = msg.Role.Value,
                    content = msg.Text,
                });
            }

            // Map standard model names to Pollinations aliases
            var model = this._modelId switch
            {
                "gpt-4o-mini" => "openai",
                "gpt-4o" => "openai-large",
                _ => this._modelId
            };

            return new
            {
                messages = messageList,
                model = model,
                stream = stream,
                seed = Random.Shared.Next(), // Avoid caching
            };
        }

        public void Dispose() => this._httpClient.Dispose();

        public object? GetService(Type serviceType, object? serviceKey = null) => null;
    }
}
