meta {
  name: Requests-Minute-Sliding-Allow-50%
  type: http
  seq: 7
}

post {
  url: {{baseUrl}}/api/v1/inference/chat/completions
  body: json
  auth: bearer
}

auth:bearer {
  token: {{apiKey}}
}

headers {
  Content-Type: application/json
  X-Organization-Id: {{orgId}}
  X-Test-Quota-Type: requests
  X-Test-Quota-Limit: 100
  X-Test-Quota-Window: minute
  X-Test-Quota-Window-Type: sliding
  X-Test-Quota-Action: allow
  X-Test-Simulate-Usage: 50
}

body:json {
  {
    "model": "openai/gpt-4",
    "messages": [
      {
        "role": "user",
        "content": "Test request - 50% sliding window"
      }
    ],
    "max_tokens": 10
  }
}

assert {
  res.status: eq 200
  res.headers.x-ratelimit-limit: eq 100
  res.headers.x-ratelimit-remaining: eq 50
  res.headers.x-ratelimit-window-type: eq sliding
}

tests {
  test("Request succeeds in sliding window", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Rate limit shows sliding window", function() {
    expect(res.headers['x-ratelimit-window-type']).to.equal('sliding');
    expect(res.headers['x-ratelimit-limit']).to.equal('100');
    expect(parseInt(res.headers['x-ratelimit-remaining'])).to.equal(50);
  });
  
  test("Reset timestamp is approximate", function() {
    // Sliding windows have approximate reset times
    const reset = parseInt(res.headers['x-ratelimit-reset']);
    const now = Math.floor(Date.now() / 1000);
    expect(reset).to.be.greaterThan(now);
    // Reset is when oldest request in window expires
  });
  
  test("Response successful", function() {
    expect(res.body.id).to.be.a('string');
    expect(res.body.choices).to.be.an('array');
  });
}

docs {
  # Requests-Minute-Sliding-Allow-50%
  
  Tests sliding window quota enforcement at 50% usage.
  
  ## Test Configuration
  - Metric Type: requests
  - Time Granularity: minute
  - Window Type: sliding
  - Action: allow
  - Usage Level: 50% (50/100 requests in last 60 seconds)
  
  ## Sliding Window Behavior
  - Window moves with time (not fixed boundaries)
  - Counts requests in last N seconds from now
  - More granular than fixed windows
  - Better burst handling
  
  ## Example Timeline
  ```
  14:03:00 - Request 1
  14:03:15 - Request 2
  14:03:30 - Request 3
  14:03:45 - Now (checking last 60s)
  14:02:45 - Window start (60s ago)
  ```
  
  ## Advantages
  ✅ Smoother rate limiting
  ✅ No boundary reset spikes
  ✅ Fair distribution over time
  ✅ Better for bursty traffic
  
  ## Disadvantages
  ❌ More complex to implement
  ❌ Higher memory/storage needs
  ❌ Harder to predict exact reset
}
