#nullable enable
using System;
using System.Threading.Tasks;
using Xunit;
using Moq;
using Synaxis.Tests.Integration.Fixtures;
using Synaxis.InferenceGateway.Infrastructure.Contracts;
using Microsoft.Extensions.Logging;

namespace Synaxis.Tests.Integration;

/// <summary>
/// Integration tests for compliance validation (GDPR, LGPD, CCPA).
/// Tests data protection requirements and transfer validations.
/// </summary>
public class ComplianceValidationTests : IClassFixture<SynaxisTestFixture>
{
    private readonly SynaxisTestFixture _fixture;

    public ComplianceValidationTests(SynaxisTestFixture fixture)
    {
        _fixture = fixture;
    }

    [Fact]
    public async Task ValidateTransfer_EUtoUS_WithSCC_Allowed()
    {
        // Arrange
        var complianceProvider = CreateMockGdprProvider(allowTransfer: true);

        var context = new TransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            FromRegion = "eu-west-1",
            ToRegion = "us-east-1",
            LegalBasis = "SCC",
            Purpose = "inference_request",
            DataCategories = new[] { "api_request", "model_inference" },
            EncryptionUsed = true,
            UserConsentObtained = true
        };

        // Act
        var isAllowed = await complianceProvider.ValidateTransferAsync(context);

        // Assert
        Assert.True(isAllowed);
    }

    [Fact]
    public async Task ValidateTransfer_EUtoUS_WithoutLegalBasis_Denied()
    {
        // Arrange
        var complianceProvider = CreateMockGdprProvider(allowTransfer: false);

        var context = new TransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            FromRegion = "eu-west-1",
            ToRegion = "us-east-1",
            LegalBasis = null!, // No legal basis
            Purpose = "inference_request",
            DataCategories = new[] { "api_request", "model_inference" },
            EncryptionUsed = false,
            UserConsentObtained = false
        };

        // Act
        var isAllowed = await complianceProvider.ValidateTransferAsync(context);

        // Assert
        Assert.False(isAllowed);
    }

    [Fact]
    public async Task LogTransfer_ValidContext_LogsSuccessfully()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.RegulationCode).Returns("GDPR");
        mockProvider.Setup(x => x.Region).Returns("eu-west-1");
        mockProvider.Setup(x => x.LogTransferAsync(It.IsAny<TransferContext>()))
            .Returns(Task.CompletedTask);

        var context = new TransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            FromRegion = "eu-west-1",
            ToRegion = "us-east-1",
            LegalBasis = "SCC",
            Purpose = "inference_request",
            DataCategories = new[] { "api_request" },
            EncryptionUsed = true,
            UserConsentObtained = true
        };

        // Act
        await mockProvider.Object.LogTransferAsync(context);

        // Assert
        mockProvider.Verify(x => x.LogTransferAsync(It.IsAny<TransferContext>()), Times.Once);
    }

    [Fact]
    public async Task ExportUserData_GDPRRequest_ReturnsDataExport()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.RegulationCode).Returns("GDPR");
        
        var expectedExport = new DataExport
        {
            UserId = _fixture.EuUser.Id,
            Format = "json",
            Data = System.Text.Encoding.UTF8.GetBytes("{\"user_id\":\"test\"}"),
            ExportedAt = DateTime.UtcNow,
            Metadata = new System.Collections.Generic.Dictionary<string, object>
            {
                { "regulation", "GDPR" },
                { "request_type", "data_portability" }
            }
        };

        mockProvider.Setup(x => x.ExportUserDataAsync(_fixture.EuUser.Id))
            .ReturnsAsync(expectedExport);

        // Act
        var export = await mockProvider.Object.ExportUserDataAsync(_fixture.EuUser.Id);

        // Assert
        Assert.NotNull(export);
        Assert.Equal(_fixture.EuUser.Id, export.UserId);
        Assert.Equal("json", export.Format);
        Assert.NotNull(export.Data);
        Assert.True(export.Data.Length > 0);
    }

    [Fact]
    public async Task DeleteUserData_GDPRRightToErasure_DeletesSuccessfully()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.RegulationCode).Returns("GDPR");
        mockProvider.Setup(x => x.DeleteUserDataAsync(It.IsAny<Guid>()))
            .ReturnsAsync(true);

        // Act
        var result = await mockProvider.Object.DeleteUserDataAsync(_fixture.EuUser.Id);

        // Assert
        Assert.True(result);
        mockProvider.Verify(x => x.DeleteUserDataAsync(_fixture.EuUser.Id), Times.Once);
    }

    [Fact]
    public async Task IsProcessingAllowed_ValidLegalBasis_AllowsProcessing()
    {
        // Arrange
        var complianceProvider = CreateMockGdprProvider(allowProcessing: true);

        var context = new ProcessingContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            ProcessingPurpose = "inference_request",
            LegalBasis = "contract",
            DataCategories = new[] { "api_request", "model_inference" }
        };

        // Act
        var isAllowed = await complianceProvider.IsProcessingAllowedAsync(context);

        // Assert
        Assert.True(isAllowed);
    }

    [Fact]
    public async Task IsProcessingAllowed_NoLegalBasis_DeniesProcessing()
    {
        // Arrange
        var complianceProvider = CreateMockGdprProvider(allowProcessing: false);

        var context = new ProcessingContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            ProcessingPurpose = "inference_request",
            LegalBasis = null!, // No legal basis
            DataCategories = new[] { "api_request" }
        };

        // Act
        var isAllowed = await complianceProvider.IsProcessingAllowedAsync(context);

        // Assert
        Assert.False(isAllowed);
    }

    [Fact]
    public async Task GetDataRetentionDays_GDPR_Returns30Days()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.RegulationCode).Returns("GDPR");
        mockProvider.Setup(x => x.GetDataRetentionDays()).Returns(30);

        // Act
        var retentionDays = mockProvider.Object.GetDataRetentionDays();

        // Assert
        Assert.Equal(30, retentionDays);
    }

    [Fact]
    public async Task GetDataRetentionDays_LGPD_Returns30Days()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.RegulationCode).Returns("LGPD");
        mockProvider.Setup(x => x.GetDataRetentionDays()).Returns(30);

        // Act
        var retentionDays = mockProvider.Object.GetDataRetentionDays();

        // Assert
        Assert.Equal(30, retentionDays);
    }

    [Fact]
    public async Task IsBreachNotificationRequired_HighRisk_ReturnsTrue()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.RegulationCode).Returns("GDPR");
        mockProvider.Setup(x => x.IsBreachNotificationRequiredAsync(It.IsAny<BreachContext>()))
            .ReturnsAsync(true);

        var breachContext = new BreachContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            BreachType = "data_leak",
            AffectedUsersCount = 1000,
            DataCategoriesExposed = new[] { "personal_data", "credentials" },
            RiskLevel = "high"
        };

        // Act
        var isRequired = await mockProvider.Object.IsBreachNotificationRequiredAsync(breachContext);

        // Assert
        Assert.True(isRequired);
    }

    [Fact]
    public async Task IsBreachNotificationRequired_LowRisk_ReturnsFalse()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.RegulationCode).Returns("GDPR");
        mockProvider.Setup(x => x.IsBreachNotificationRequiredAsync(It.IsAny<BreachContext>()))
            .ReturnsAsync(false);

        var breachContext = new BreachContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            BreachType = "attempted_access",
            AffectedUsersCount = 0,
            DataCategoriesExposed = Array.Empty<string>(),
            RiskLevel = "low"
        };

        // Act
        var isRequired = await mockProvider.Object.IsBreachNotificationRequiredAsync(breachContext);

        // Assert
        Assert.False(isRequired);
    }

    [Theory]
    [InlineData("SCC", true, true, true)]           // Valid: SCC + encryption + consent
    [InlineData("SCC", false, true, false)]          // Invalid: no encryption
    [InlineData("SCC", true, false, false)]          // Invalid: no consent
    [InlineData("adequacy", false, false, true)]     // Valid: adequacy decision
    [InlineData("consent", true, true, true)]        // Valid: explicit consent
    [InlineData(null, true, true, false)]            // Invalid: no legal basis
    public async Task ValidateTransfer_VariousScenarios_ReturnsExpectedResult(
        string? legalBasis,
        bool encryptionUsed,
        bool userConsentObtained,
        bool expectedAllowed)
    {
        // Arrange
        var complianceProvider = CreateMockGdprProvider(allowTransfer: expectedAllowed);

        var context = new TransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            FromRegion = "eu-west-1",
            ToRegion = "us-east-1",
            LegalBasis = legalBasis!,
            Purpose = "inference_request",
            DataCategories = new[] { "api_request" },
            EncryptionUsed = encryptionUsed,
            UserConsentObtained = userConsentObtained
        };

        // Act
        var isAllowed = await complianceProvider.ValidateTransferAsync(context);

        // Assert
        Assert.Equal(expectedAllowed, isAllowed);
    }

    [Fact]
    public async Task DataMinimization_ProcessingContext_EnforcesMinimalData()
    {
        // Arrange
        var complianceProvider = CreateMockGdprProvider(allowProcessing: true);

        var context = new ProcessingContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            ProcessingPurpose = "inference_request",
            LegalBasis = "contract",
            DataCategories = new[] { "api_request" } // Only necessary data
        };

        // Act
        var isAllowed = await complianceProvider.IsProcessingAllowedAsync(context);

        // Assert
        Assert.True(isAllowed);
        Assert.Single(context.DataCategories); // Minimal data principle
    }

    [Fact]
    public async Task PurposeLimitation_ProcessingForDifferentPurpose_Denied()
    {
        // Arrange
        var complianceProvider = CreateMockGdprProvider(allowProcessing: false);

        var context = new ProcessingContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            ProcessingPurpose = "marketing", // Different from original consent
            LegalBasis = "contract",
            DataCategories = new[] { "api_request" }
        };

        // Act
        var isAllowed = await complianceProvider.IsProcessingAllowedAsync(context);

        // Assert
        Assert.False(isAllowed);
    }

    [Fact]
    public async Task AuditLog_AllTransfers_RecordsComplete()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        var auditLogs = new List<TransferContext>();

        mockProvider.Setup(x => x.LogTransferAsync(It.IsAny<TransferContext>()))
            .Callback<TransferContext>(ctx => auditLogs.Add(ctx))
            .Returns(Task.CompletedTask);

        var context = new TransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            FromRegion = "eu-west-1",
            ToRegion = "us-east-1",
            LegalBasis = "SCC",
            Purpose = "inference_request",
            DataCategories = new[] { "api_request" },
            EncryptionUsed = true,
            UserConsentObtained = true
        };

        // Act
        await mockProvider.Object.LogTransferAsync(context);

        // Assert
        Assert.Single(auditLogs);
        Assert.Equal(_fixture.EuUser.Id, auditLogs[0].UserId);
        Assert.Equal("SCC", auditLogs[0].LegalBasis);
    }

    [Fact]
    public async Task DataEncryption_AllTransfers_EncryptionEnforced()
    {
        // Arrange
        var complianceProvider = CreateMockGdprProvider(allowTransfer: true);

        var context = new TransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            FromRegion = "eu-west-1",
            ToRegion = "us-east-1",
            LegalBasis = "SCC",
            Purpose = "inference_request",
            DataCategories = new[] { "api_request" },
            EncryptionUsed = true, // Required
            UserConsentObtained = true
        };

        // Act
        var isAllowed = await complianceProvider.ValidateTransferAsync(context);

        // Assert
        Assert.True(isAllowed);
        Assert.True(context.EncryptionUsed);
    }

    [Fact]
    public async Task LGPDCompliance_BrazilianUser_EnforcesLGPD()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.RegulationCode).Returns("LGPD");
        mockProvider.Setup(x => x.Region).Returns("sa-east-1");
        mockProvider.Setup(x => x.ValidateTransferAsync(It.IsAny<TransferContext>()))
            .ReturnsAsync(true);

        var context = new TransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.BrazilUser.Id,
            FromRegion = "sa-east-1",
            ToRegion = "us-east-1",
            LegalBasis = "consent",
            Purpose = "inference_request",
            DataCategories = new[] { "api_request" },
            EncryptionUsed = true,
            UserConsentObtained = true
        };

        // Act
        var isAllowed = await mockProvider.Object.ValidateTransferAsync(context);

        // Assert
        Assert.True(isAllowed);
        Assert.Equal("LGPD", mockProvider.Object.RegulationCode);
    }

    [Fact]
    public async Task CCPACompliance_CaliforniaUser_EnforcesCCPA()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.RegulationCode).Returns("CCPA");
        mockProvider.Setup(x => x.Region).Returns("us-west-1");

        // Act & Assert
        Assert.Equal("CCPA", mockProvider.Object.RegulationCode);
        Assert.Equal("us-west-1", mockProvider.Object.Region);
    }

    [Fact]
    public async Task RightToRectification_UserUpdatesData_DataCorrected()
    {
        // Arrange
        var userService = new UserService(_fixture.DbContext);
        var user = _fixture.EuUser;

        // Act - User exercises right to rectification
        var updatedUser = await userService.UpdateUserAsync(user.Id, new UpdateUserRequest
        {
            FirstName = "Corrected",
            LastName = "Name"
        });

        // Assert
        Assert.Equal("Corrected", updatedUser.FirstName);
        Assert.Equal("Name", updatedUser.LastName);
    }

    [Fact]
    public async Task RightToRestriction_UserRestricts_ProcessingLimited()
    {
        // Arrange
        var user = _fixture.EuUser;

        // Act - User restricts processing
        user.ProcessingRestricted = true;
        user.ProcessingRestrictionReason = "Disputes accuracy";
        _fixture.DbContext.Users.Update(user);
        await _fixture.DbContext.SaveChangesAsync();

        // Assert
        var restrictedUser = await _fixture.DbContext.Users.FindAsync(user.Id);
        Assert.NotNull(restrictedUser);
        Assert.True(restrictedUser.ProcessingRestricted);
    }

    [Fact(Skip = "Needs refactoring - User model properties changed")]
    public async Task RightToObjection_UserObjects_ProcessingStopped()
    {
        // Arrange
        var user = _fixture.EuUser;

        // Act - User objects to processing
        user.ProcessingObjection = true;
        user.ObjectionDate = DateTime.UtcNow;
        _fixture.DbContext.Users.Update(user);
        await _fixture.DbContext.SaveChangesAsync();

        // Assert
        var updatedUser = await _fixture.DbContext.Users.FindAsync(user.Id);
        Assert.NotNull(updatedUser);
        Assert.True(updatedUser.ProcessingObjection);
        Assert.NotNull(updatedUser.ObjectionDate);
    }

    [Fact(Skip = "Needs refactoring - User model properties changed")]
    public async Task ConsentWithdrawal_UserWithdraws_ConsentRevoked()
    {
        // Arrange
        var userService = new UserService(_fixture.DbContext);
        var user = _fixture.BrazilUser;

        // Initially has consent
        Assert.True(user.CrossBorderConsentGiven);

        // Act - Withdraw consent
        await userService.UpdateCrossBorderConsentAsync(user.Id, consentGiven: false, version: "1.0");

        // Assert
        var updatedUser = await userService.GetUserAsync(user.Id);
        Assert.False(updatedUser.CrossBorderConsentGiven);
        Assert.Null(updatedUser.CrossBorderConsentDate);
    }

    [Fact]
    public async Task DataRetentionPolicy_ExpiredData_MarkedForDeletion()
    {
        // Arrange
        var mockProvider = new Mock<IComplianceProvider>();
        mockProvider.Setup(x => x.GetDataRetentionDays()).Returns(30);

        var retentionDays = mockProvider.Object.GetDataRetentionDays();
        var cutoffDate = DateTime.UtcNow.AddDays(-retentionDays);

        // Assert
        Assert.Equal(30, retentionDays);
        Assert.True(cutoffDate < DateTime.UtcNow);
    }

    [Fact]
    public async Task ChildDataProtection_UnderAge_RequiresParentalConsent()
    {
        // Arrange - User under 16 (GDPR requirement)
        var userService = new UserService(_fixture.DbContext);
        var minorUser = await userService.CreateUserAsync(new CreateUserRequest
        {
            OrganizationId = _fixture.TestOrganization.Id,
            Email = "minor@test.com",
            Password = "SecurePassword123!@#",
            FirstName = "Minor",
            LastName = "User",
            DataResidencyRegion = "eu-west-1",
            CreatedInRegion = "eu-west-1",
            Role = "member"
        });

        minorUser.DateOfBirth = DateTime.UtcNow.AddYears(-15); // 15 years old
        minorUser.RequiresParentalConsent = true;
        _fixture.DbContext.Users.Update(minorUser);
        await _fixture.DbContext.SaveChangesAsync();

        // Assert
        Assert.True(minorUser.RequiresParentalConsent);
        Assert.True(minorUser.DateOfBirth.HasValue);
        Assert.True((DateTime.UtcNow - minorUser.DateOfBirth.Value).TotalDays / 365.25 < 16);
    }

    [Fact]
    public async Task TransferImpactAssessment_HighRisk_RequiresAssessment()
    {
        // Arrange
        var context = new TransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            FromRegion = "eu-west-1",
            ToRegion = "cn-north-1", // China - high risk destination
            LegalBasis = "SCC",
            Purpose = "inference_request",
            DataCategories = new[] { "sensitive_data", "personal_identifiable_info" },
            EncryptionUsed = true,
            UserConsentObtained = true
        };

        // Assert - High risk transfer requires impact assessment
        Assert.Contains("sensitive_data", context.DataCategories);
        Assert.Equal("cn-north-1", context.ToRegion);
    }

    private IComplianceProvider CreateMockGdprProvider(
        bool allowTransfer = true,
        bool allowProcessing = true)
    {
        var mockProvider = new Mock<IComplianceProvider>();
        
        mockProvider.Setup(x => x.RegulationCode).Returns("GDPR");
        mockProvider.Setup(x => x.Region).Returns("eu-west-1");
        
        mockProvider.Setup(x => x.ValidateTransferAsync(It.IsAny<TransferContext>()))
            .ReturnsAsync(allowTransfer);
        
        mockProvider.Setup(x => x.LogTransferAsync(It.IsAny<TransferContext>()))
            .Returns(Task.CompletedTask);
        
        mockProvider.Setup(x => x.IsProcessingAllowedAsync(It.IsAny<ProcessingContext>()))
            .ReturnsAsync(allowProcessing);
        
        mockProvider.Setup(x => x.GetDataRetentionDays())
            .Returns(30);

        return mockProvider.Object;
    }
}
