#nullable enable
using System;
using System.Threading.Tasks;
using Xunit;
using Moq;
using Synaxis.Tests.Integration.Fixtures;
using Synaxis.InferenceGateway.Infrastructure.Contracts;
using Synaxis.Core.Contracts;
using Synaxis.Infrastructure.MultiRegion;
using Microsoft.Extensions.Logging;
using System.Net.Http;

namespace Synaxis.Tests.Integration;

/// <summary>
/// Integration tests for cross-region routing and failover scenarios.
/// Tests compliance with data residency and cross-border transfer regulations.
/// </summary>
public class CrossRegionRoutingTests : IClassFixture<SynaxisTestFixture>
{
    private readonly SynaxisTestFixture _fixture;

    public CrossRegionRoutingTests(SynaxisTestFixture fixture)
    {
        _fixture = fixture;
    }

    [Fact]
    public async Task GetUserRegion_EUUser_ReturnsEURegion()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Act
        var region = await regionRouter.GetUserRegionAsync(_fixture.EuUser.Id);

        // Assert
        Assert.Equal("eu-west-1", region);
    }

    [Fact]
    public async Task GetUserRegion_USUser_ReturnsUSRegion()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Act
        var region = await regionRouter.GetUserRegionAsync(_fixture.UsUser.Id);

        // Assert
        Assert.Equal("us-east-1", region);
    }

    [Fact]
    public async Task IsCrossBorder_EUtoUS_ReturnsTrue()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Act
        var isCrossBorder = await regionRouter.IsCrossBorderAsync("eu-west-1", "us-east-1");

        // Assert
        Assert.True(isCrossBorder);
    }

    [Fact]
    public async Task IsCrossBorder_EUtoEU_ReturnsFalse()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Act
        var isCrossBorder = await regionRouter.IsCrossBorderAsync("eu-west-1", "eu-west-1");

        // Assert
        Assert.False(isCrossBorder);
    }

    [Fact]
    public async Task RequiresCrossBorderConsent_EUUserWithoutConsent_ReturnsTrue()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Act
        var requiresConsent = await regionRouter.RequiresCrossBorderConsentAsync(
            _fixture.EuUser.Id,
            "us-east-1");

        // Assert
        Assert.True(requiresConsent);
    }

    [Fact]
    public async Task RequiresCrossBorderConsent_BrazilUserWithConsent_ReturnsFalse()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Act
        var requiresConsent = await regionRouter.RequiresCrossBorderConsentAsync(
            _fixture.BrazilUser.Id,
            "us-east-1");

        // Assert
        Assert.False(requiresConsent);
    }

    [Fact]
    public async Task RequiresCrossBorderConsent_SameRegion_ReturnsFalse()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Act
        var requiresConsent = await regionRouter.RequiresCrossBorderConsentAsync(
            _fixture.EuUser.Id,
            "eu-west-1");

        // Assert
        Assert.False(requiresConsent);
    }

    [Fact]
    public async Task LogCrossBorderTransfer_ValidContext_LogsSuccessfully()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        var context = new CrossBorderTransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            FromRegion = "eu-west-1",
            ToRegion = "us-east-1",
            LegalBasis = "SCC",
            Purpose = "inference_request",
            DataCategories = new[] { "api_request", "model_inference" }
        };

        // Act & Assert - Should not throw
        await regionRouter.LogCrossBorderTransferAsync(context);

        // Verify logging occurred
        mockLogger.Verify(
            x => x.Log(
                LogLevel.Information,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Cross-border transfer")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.AtLeastOnce);
    }

    [Fact]
    public async Task GetNearestHealthyRegion_AllRegionsHealthy_ReturnsNearestRegion()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        
        // Setup all regions as healthy
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync(It.IsAny<string>()))
            .ReturnsAsync(true);

        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        var geoLocation = new GeoLocation
        {
            IpAddress = "8.8.8.8",
            CountryCode = "US",
            CountryName = "United States",
            Latitude = 37.7749,
            Longitude = -122.4194
        };

        // Act
        var nearestRegion = await regionRouter.GetNearestHealthyRegionAsync("eu-west-1", geoLocation);

        // Assert
        Assert.NotNull(nearestRegion);
        Assert.NotEqual("eu-west-1", nearestRegion); // Should return different region
    }

    [Fact]
    public async Task Failover_PrimaryRegionDown_RoutesToSecondaryRegion()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        
        // Setup eu-west-1 as unhealthy, others as healthy
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync("eu-west-1"))
            .ReturnsAsync(false);
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync(It.Is<string>(r => r != "eu-west-1")))
            .ReturnsAsync(true);

        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        var geoLocation = new GeoLocation
        {
            IpAddress = "85.10.20.30",
            CountryCode = "DE",
            CountryName = "Germany",
            Latitude = 51.1657,
            Longitude = 10.4515
        };

        // Act
        var failoverRegion = await regionRouter.GetNearestHealthyRegionAsync("eu-west-1", geoLocation);

        // Assert
        Assert.NotNull(failoverRegion);
        Assert.NotEqual("eu-west-1", failoverRegion);
        Assert.True(failoverRegion == "us-east-1" || failoverRegion == "sa-east-1");
    }

    [Fact]
    public async Task Failover_AllRegionsDown_ReturnsNull()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        
        // Setup all regions as unhealthy
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync(It.IsAny<string>()))
            .ReturnsAsync(false);

        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        var geoLocation = new GeoLocation
        {
            IpAddress = "8.8.8.8",
            CountryCode = "US",
            CountryName = "United States"
        };

        // Act
        var failoverRegion = await regionRouter.GetNearestHealthyRegionAsync("eu-west-1", geoLocation);

        // Assert
        Assert.Null(failoverRegion);
    }

    [Theory]
    [InlineData("eu-west-1", "us-east-1", true)]  // EU to US requires consent
    [InlineData("us-east-1", "eu-west-1", true)]  // US to EU requires consent
    [InlineData("eu-west-1", "sa-east-1", true)]  // EU to Brazil requires consent
    [InlineData("us-east-1", "sa-east-1", false)] // US to Brazil (both adequate)
    [InlineData("eu-west-1", "eu-west-1", false)] // Same region
    public async Task CrossBorderConsentMatrix_VariousRegionPairs_ReturnsExpectedResult(
        string fromRegion,
        string toRegion,
        bool expectedRequiresConsent)
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Create user in source region without consent
        var user = await _fixture.CreateUserWithConsentAsync(fromRegion, crossBorderConsent: false);

        // Act
        var requiresConsent = await regionRouter.RequiresCrossBorderConsentAsync(user.Id, toRegion);

        // Assert
        Assert.Equal(expectedRequiresConsent, requiresConsent);
    }

    [Fact]
    public async Task AutomaticRecovery_RegionComesBackOnline_RoutesToPrimaryRegion()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();

        // Initially EU is down
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync("eu-west-1"))
            .ReturnsAsync(false);
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync("us-east-1"))
            .ReturnsAsync(true);

        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Act - First check (EU is down)
        var isPrimaryHealthy = await mockHttpClientFactory.Object.IsRegionHealthyAsync("eu-west-1");
        Assert.False(isPrimaryHealthy);

        // EU comes back online
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync("eu-west-1"))
            .ReturnsAsync(true);

        // Second check (EU is now healthy)
        isPrimaryHealthy = await mockHttpClientFactory.Object.IsRegionHealthyAsync("eu-west-1");
        Assert.True(isPrimaryHealthy);

        // Assert - Should route back to primary region
        var userRegion = await regionRouter.GetUserRegionAsync(_fixture.EuUser.Id);
        Assert.Equal("eu-west-1", userRegion);
    }

    [Fact]
    public async Task MultiRegionOrganization_HasAvailableRegions_AllRegionsAccessible()
    {
        // Arrange
        var organization = _fixture.TestOrganization;

        // Assert
        Assert.NotNull(organization.AvailableRegions);
        Assert.Contains("eu-west-1", organization.AvailableRegions);
        Assert.Contains("us-east-1", organization.AvailableRegions);
        Assert.Contains("sa-east-1", organization.AvailableRegions);
        Assert.Equal(3, organization.AvailableRegions.Count);
    }

    [Fact]
    public async Task RegionSelection_BasedOnUserLocation_ReturnsNearestRegion()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync(It.IsAny<string>()))
            .ReturnsAsync(true);

        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // User in Germany should be routed to EU
        var euLocation = new GeoLocation
        {
            IpAddress = "85.10.20.30",
            CountryCode = "DE",
            CountryName = "Germany",
            Latitude = 51.1657,
            Longitude = 10.4515
        };

        // Act
        var nearestRegion = await regionRouter.GetNearestHealthyRegionAsync("eu-west-1", euLocation);

        // Assert
        Assert.NotNull(nearestRegion);
        // Should prefer EU region for EU user
    }

    [Fact]
    public async Task CrossBorderRequest_LogsTransfer_AuditTrailCreated()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        var context = new CrossBorderTransferContext
        {
            OrganizationId = _fixture.TestOrganization.Id,
            UserId = _fixture.EuUser.Id,
            FromRegion = "eu-west-1",
            ToRegion = "us-east-1",
            LegalBasis = "SCC",
            Purpose = "inference_request",
            DataCategories = new[] { "api_request", "model_inference" }
        };

        // Act
        await regionRouter.LogCrossBorderTransferAsync(context);

        // Assert - Verify audit logging occurred
        mockLogger.Verify(
            x => x.Log(
                LogLevel.Information,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Cross-border")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.AtLeastOnce);
    }

    [Fact]
    public async Task FailoverWithConsent_UserHasConsent_AllowsCrossBorderFailover()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync("sa-east-1"))
            .ReturnsAsync(false);
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync("us-east-1"))
            .ReturnsAsync(true);

        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // Act - Brazil user with consent can failover to US
        var requiresConsent = await regionRouter.RequiresCrossBorderConsentAsync(
            _fixture.BrazilUser.Id,
            "us-east-1");

        // Assert
        Assert.False(requiresConsent); // Brazil user has consent
    }

    [Fact]
    public async Task RegionLatency_MonitorsPerformance_SelectsLowLatencyRegion()
    {
        // Arrange
        var mockLogger = new Mock<ILogger<RegionRouter>>();
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        
        // All regions healthy
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync(It.IsAny<string>()))
            .ReturnsAsync(true);

        var regionRouter = new RegionRouter(_fixture.DbContext, mockHttpClientFactory.Object, mockLogger.Object);

        // User in US should prefer US region for lower latency
        var usLocation = new GeoLocation
        {
            IpAddress = "8.8.8.8",
            CountryCode = "US",
            CountryName = "United States",
            Latitude = 37.7749,
            Longitude = -122.4194
        };

        // Act
        var nearestRegion = await regionRouter.GetNearestHealthyRegionAsync("us-east-1", usLocation);

        // Assert
        Assert.NotNull(nearestRegion);
    }

    [Fact]
    public async Task DataSovereignty_CanadianUser_KeepsDataInRegion()
    {
        // Arrange
        var user = await _fixture.CreateUserWithConsentAsync("ca-central-1", crossBorderConsent: false);

        // Assert
        Assert.Equal("ca-central-1", user.DataResidencyRegion);
        Assert.Equal("ca-central-1", user.CreatedInRegion);
        Assert.False(user.CrossBorderConsentGiven);
    }

    [Fact]
    public async Task RegionMapping_CountryToRegion_ReturnsCorrectMapping()
    {
        // Arrange & Act
        var mappings = new Dictionary<string, string>
        {
            { "DE", "eu-west-1" },      // Germany → EU
            { "FR", "eu-west-1" },      // France → EU
            { "US", "us-east-1" },      // USA → US
            { "BR", "sa-east-1" },      // Brazil → South America
            { "CA", "ca-central-1" },   // Canada → Canada
            { "AU", "ap-southeast-2" }, // Australia → Asia-Pacific
            { "JP", "ap-northeast-1" }  // Japan → Asia-Pacific
        };

        // Assert
        foreach (var mapping in mappings)
        {
            Assert.NotNull(mapping.Value);
            Assert.NotEmpty(mapping.Value);
        }
    }

    [Fact]
    public async Task HealthCheck_AllRegions_ReturnsHealthStatus()
    {
        // Arrange
        var mockHttpClientFactory = new Mock<IHttpClientFactory>();
        
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync("eu-west-1")).ReturnsAsync(true);
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync("us-east-1")).ReturnsAsync(true);
        mockHealthMonitor.Setup(x => x.IsRegionHealthyAsync("sa-east-1")).ReturnsAsync(false);

        // Act
        var euHealthy = await mockHttpClientFactory.Object.IsRegionHealthyAsync("eu-west-1");
        var usHealthy = await mockHttpClientFactory.Object.IsRegionHealthyAsync("us-east-1");
        var saHealthy = await mockHttpClientFactory.Object.IsRegionHealthyAsync("sa-east-1");

        // Assert
        Assert.True(euHealthy);
        Assert.True(usHealthy);
        Assert.False(saHealthy);
    }

    [Fact]
    public async Task GeoLocation_ParsesIPAddress_ReturnsLocation()
    {
        // Arrange
        var geoLocation = new GeoLocation
        {
            IpAddress = "8.8.8.8",
            CountryCode = "US",
            CountryName = "United States",
            Latitude = 37.7749,
            Longitude = -122.4194,
            City = "Mountain View",
            Region = "California"
        };

        // Assert
        Assert.Equal("US", geoLocation.CountryCode);
        Assert.Equal("United States", geoLocation.CountryName);
        Assert.InRange(geoLocation.Latitude, -90, 90);
        Assert.InRange(geoLocation.Longitude, -180, 180);
    }
}
