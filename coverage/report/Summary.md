# Summary

|||
|:---|:---|
| Generated on: | 1/30/2026 - 7:50:57 PM |
| Coverage date: | 1/30/2026 - 7:48:40 PM - 1/30/2026 - 7:49:39 PM |
| Parser: | MultiReport (3x Cobertura) |
| Assemblies: | 4 |
| Classes: | 192 |
| Files: | 152 |
| **Line coverage:** | 67.6% (7614 of 11251) |
| Covered lines: | 7614 |
| Uncovered lines: | 3637 |
| Coverable lines: | 11251 |
| Total lines: | 16464 |
| **Branch coverage:** | 40.7% (1103 of 2706) |
| Covered branches: | 1103 |
| Total branches: | 2706 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

# Risk Hotspots

| **Assembly** | **Class** | **Method** | **Crap Score** | **Cyclomatic complexity** |
|:---|:---|:---|---:|---:|
| Synaxis.Common.Tests | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | TransformAsync(...) | 8930 | 94 || Synaxis.InferenceGateway.WebApi | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | TransformAsync(...) | 8930 | 94 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.CohereChatClient](#synaxisinferencegatewayinfrastructurecoherechatclient) | GetStreamingResponseAsync() | 4692 | 68 || Synaxis.InferenceGateway.Application | [Synaxis.InferenceGateway.Application.ChatClients.SmartRoutingChatClient](#synaxisinferencegatewayapplicationchatclientssmartroutingchatclient) | RecordFailureAsync() | 3195 | 80 || Synaxis.Common.Tests | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | TransformAsync(...) | 1190 | 34 || Synaxis.InferenceGateway.WebApi | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | TransformAsync(...) | 1190 | 34 || Synaxis.Common.Tests | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | GetTypeDocId(...) | 812 | 28 || Synaxis.InferenceGateway.WebApi | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | GetTypeDocId(...) | 812 | 28 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.LegacyCompletionsEndpoint](#synaxisinferencegatewaywebapiendpointsopenailegacycompletionsendpoint) | TryParsePrompt(...) | 787 | 38 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Extensions.InfrastructureExtensions](#synaxisinferencegatewayinfrastructureextensionsinfrastructureextensions) | AddSynaxisInfrastructure(...) | 740 | 136 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.Google.GoogleChatClient](#synaxisinferencegatewayinfrastructureexternalgooglegooglechatclient) | GetResponseAsync() | 600 | 24 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.GhConfigWriter](#synaxisinferencegatewayinfrastructureidentitystrategiesgithubghconfigwriter) | WriteTokenAsync() | 600 | 24 || Synaxis.Common.Tests | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | CreateDocumentationId(...) | 342 | 18 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkAdapter](#synaxisinferencegatewayinfrastructureexternalgithubcopilotsdkadapter) | GetStreamingResponseAsync() | 342 | 18 || Synaxis.InferenceGateway.WebApi | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | CreateDocumentationId(...) | 342 | 18 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Agents.RoutingService](#synaxisinferencegatewaywebapiagentsroutingservice) | LogRoutingContext(...) | 342 | 18 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Jobs.ProviderDiscoveryJob](#synaxisinferencegatewayinfrastructurejobsproviderdiscoveryjob) | GetEffectiveBaseUrl(...) | 274 | 90 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkAdapter](#synaxisinferencegatewayinfrastructureexternalgithubcopilotsdkadapter) | GetResponseAsync() | 272 | 16 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager](#synaxisinferencegatewayinfrastructureauthantigravityauthmanager) | CompleteAuthFlowAsync() | 210 | 14 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager](#synaxisinferencegatewayinfrastructureauthantigravityauthmanager) | ExtractProjectId(...) | 156 | 12 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Core.IdentityManager](#synaxisinferencegatewayinfrastructureidentitycoreidentitymanager) | RefreshLoopAsync() | 156 | 12 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgooglegoogleauthstrategy) | ExtractProjectId(...) | 156 | 12 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Security.AesGcmTokenVault](#synaxisinferencegatewayinfrastructuresecurityaesgcmtokenvault) | RotateKeyAsync() | 156 | 12 || Synaxis.Common.Tests | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | CreateDocumentationId(...) | 110 | 10 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.AntigravityJsonContext](#synaxisinferencegatewayinfrastructureantigravityjsoncontext) | ExpandConverter(...) | 110 | 10 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager](#synaxisinferencegatewayinfrastructureauthantigravityauthmanager) | FetchProjectIdAsync() | 110 | 10 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkAdapter](#synaxisinferencegatewayinfrastructureexternalgithubcopilotsdkadapter) | EnsureStartedAsync() | 110 | 10 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.Google.GoogleChatClient](#synaxisinferencegatewayinfrastructureexternalgooglegooglechatclient) | CreateRequest(...) | 110 | 10 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.GitHubAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgithubgithubauthstrategy) | RefreshTokenAsync() | 110 | 10 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgooglegoogleauthstrategy) | FetchProjectIdAsync() | 110 | 10 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgooglegoogleauthstrategy) | RefreshTokenAsync() | 110 | 10 || Synaxis.InferenceGateway.WebApi | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | CreateDocumentationId(...) | 110 | 10 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.ModelsDevClient](#synaxisinferencegatewayinfrastructureexternalmodelsdevmodelsdevclient) | GetAllModelsAsync() | 79 | 26 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.AntigravityJsonContext](#synaxisinferencegatewayinfrastructureantigravityjsoncontext) | AntigravityResponseSerializeHandler(...) | 72 | 8 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager](#synaxisinferencegatewayinfrastructureauthantigravityauthmanager) | ExchangeCodeForTokenAsync() | 72 | 8 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgooglegoogleauthstrategy) | CompleteFlowAsync() | 72 | 8 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgooglegoogleauthstrategy) | ExchangeCodeForTokenAsync() | 72 | 8 || Synaxis.InferenceGateway.WebApi | [Mediator.Internals.NotificationHandlerWrapper<T>](#mediatorinternalsnotificationhandlerwrapper<t>) | Handle(...) | 72 | 8 || Synaxis.InferenceGateway.WebApi | [Mediator.Mediator](#mediatormediator) | CreateStream(...) | 72 | 8 || Synaxis.InferenceGateway.WebApi | [Mediator.Mediator](#mediatormediator) | Send() | 72 | 8 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Middleware.OpenAIErrorHandlerMiddleware](#synaxisinferencegatewaywebapimiddlewareopenaierrorhandlermiddleware) | InvokeAsync() | 62 | 52 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Health.ProviderConnectivityHealthCheck](#synaxisinferencegatewaywebapihealthproviderconnectivityhealthcheck) | GetDefaultEndpoint(...) | 55 | 48 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Jobs.ModelsDevSyncJob](#synaxisinferencegatewayinfrastructurejobsmodelsdevsyncjob) | Execute() | 52 | 50 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.AntigravityEndpoints](#synaxisinferencegatewaywebapiendpointsantigravityantigravityendpoints) | ResolveAuthCompletion(...) | 48 | 14 || Synaxis.InferenceGateway.Application | [Synaxis.InferenceGateway.Application.Routing.ModelResolver](#synaxisinferencegatewayapplicationroutingmodelresolver) | ResolveCandidates(...) | 44 | 44 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Jobs.ProviderDiscoveryJob](#synaxisinferencegatewayinfrastructurejobsproviderdiscoveryjob) | Execute() | 44 | 28 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Helpers.OpenAIRequestParser](#synaxisinferencegatewaywebapihelpersopenairequestparser) | ParseAsync() | 43 | 20 || Synaxis.Common.Tests | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | NormalizeDocId(...) | 42 | 6 || Synaxis.Common.Tests | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | UnwrapOpenApiParameter(...) | 42 | 6 || Synaxis.Common.Tests | [Synaxis.Common.Tests.TestBase](#synaxiscommonteststestbase) | CreateMockProviderRegistry(...) | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.AntigravityJsonContext](#synaxisinferencegatewayinfrastructureantigravityjsoncontext) | CandidateSerializeHandler(...) | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager](#synaxisinferencegatewayinfrastructureauthantigravityauthmanager) | DecodeState(...) | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager](#synaxisinferencegatewayinfrastructureauthantigravityauthmanager) | FetchUserEmailAsync() | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager](#synaxisinferencegatewayinfrastructureauthantigravityauthmanager) | InteractiveLoginAsync() | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.DuckDuckGo.DuckDuckGoChatClient](#synaxisinferencegatewayinfrastructureexternalduckduckgoduckduckgochatclient) | ReturnSingleAsync() | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkAdapter](#synaxisinferencegatewayinfrastructureexternalgithubcopilotsdkadapter) | GetService(...) | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkAdapter](#synaxisinferencegatewayinfrastructureexternalgithubcopilotsdkadapter) | Dispose() | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkAdapter](#synaxisinferencegatewayinfrastructureexternalgithubcopilotsdkadapter) | .ctor(...) | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.Google.GoogleChatClient](#synaxisinferencegatewayinfrastructureexternalgooglegooglechatclient) | .ctor(...) | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgooglegoogleauthstrategy) | DecodeState(...) | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgooglegoogleauthstrategy) | FetchUserEmailAsync() | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Mediator.Internals.CommandHandlerWrapper<T1, T2>](#mediatorinternalscommandhandlerwrapper<t1,-t2>) | Handle(...) | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Mediator.Internals.QueryHandlerWrapper<T1, T2>](#mediatorinternalsqueryhandlerwrapper<t1,-t2>) | Handle(...) | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Mediator.Internals.StreamCommandHandlerWrapper<T1, T2>](#mediatorinternalsstreamcommandhandlerwrapper<t1,-t2>) | Handle(...) | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Mediator.Internals.StreamCommandHandlerWrapper<T1, T2>](#mediatorinternalsstreamcommandhandlerwrapper<t1,-t2>) | Handle() | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Mediator.Internals.StreamQueryHandlerWrapper<T1, T2>](#mediatorinternalsstreamqueryhandlerwrapper<t1,-t2>) | Handle(...) | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Mediator.Internals.StreamQueryHandlerWrapper<T1, T2>](#mediatorinternalsstreamqueryhandlerwrapper<t1,-t2>) | Handle() | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Mediator.Internals.StreamRequestHandlerWrapper<T1, T2>](#mediatorinternalsstreamrequesthandlerwrapper<t1,-t2>) | Handle() | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | NormalizeDocId(...) | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | UnwrapOpenApiParameter(...) | 42 | 6 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Agents.RoutingService](#synaxisinferencegatewaywebapiagentsroutingservice) | HandleAsync() | 42 | 6 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.AntigravityJsonContext](#synaxisinferencegatewayinfrastructureantigravityjsoncontext) | System.Text.Json.Serialization.Metadata.IJsonTypeInfoResolver.GetTypeInfo(...) | 36 | 36 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Helpers.OpenAIRequestMapper](#synaxisinferencegatewaywebapihelpersopenairequestmapper) | ToChatMessages(...) | 30 | 30 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.AntigravityChatClient](#synaxisinferencegatewayinfrastructureantigravitychatclient) | GetStreamingResponseAsync() | 28 | 28 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Agents.RoutingAgent](#synaxisinferencegatewaywebapiagentsroutingagent) | RunCoreAsync() | 29 | 28 || Synaxis.InferenceGateway.Application | [Synaxis.InferenceGateway.Application.Routing.ModelResolver](#synaxisinferencegatewayapplicationroutingmodelresolver) | ResolveAsync() | 26 | 26 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.AntigravityChatClient](#synaxisinferencegatewayinfrastructureantigravitychatclient) | BuildRequest(...) | 27 | 26 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Agents.RoutingAgent](#synaxisinferencegatewaywebapiagentsroutingagent) | RunCoreStreamingAsync() | 26 | 26 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Health.ProviderConnectivityHealthCheck](#synaxisinferencegatewaywebapihealthproviderconnectivityhealthcheck) | CheckHealthAsync() | 24 | 24 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager](#synaxisinferencegatewayinfrastructureauthantigravityauthmanager) | GetTokenAsync() | 25 | 20 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.DuckDuckGo.DuckDuckGoChatClient](#synaxisinferencegatewayinfrastructureexternalduckduckgoduckduckgochatclient) | GetResponseAsync() | 29 | 20 || Synaxis.InferenceGateway.WebApi | [Synaxis.InferenceGateway.WebApi.Endpoints.Admin.AdminEndpoints](#synaxisinferencegatewaywebapiendpointsadminadminendpoints) | MapAdminEndpoints(...) | 20 | 20 || Synaxis.InferenceGateway.Application | [Synaxis.InferenceGateway.Application.ChatClients.SmartRoutingChatClient](#synaxisinferencegatewayapplicationchatclientssmartroutingchatclient) | GetStreamingResponseAsync() | 23 | 18 || Synaxis.InferenceGateway.Application | [Synaxis.InferenceGateway.Application.ProviderRegistry](#synaxisinferencegatewayapplicationproviderregistry) | GetCandidates(...) | 18 | 18 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.Identity.Core.IdentityManager](#synaxisinferencegatewayinfrastructureidentitycoreidentitymanager) | GetToken() | 18 | 18 || Synaxis.InferenceGateway.Application | [Synaxis.InferenceGateway.Application.ChatClients.SmartRoutingChatClient](#synaxisinferencegatewayapplicationchatclientssmartroutingchatclient) | .ctor(...) | 16 | 16 || Synaxis.InferenceGateway.Application | [Synaxis.InferenceGateway.Application.ChatClients.SmartRoutingChatClient](#synaxisinferencegatewayapplicationchatclientssmartroutingchatclient) | ExecuteCandidateAsync() | 16 | 16 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.AntigravityChatClient](#synaxisinferencegatewayinfrastructureantigravitychatclient) | MapResponse(...) | 16 | 16 || Synaxis.InferenceGateway.Infrastructure | [Synaxis.InferenceGateway.Infrastructure.External.AiHorde.AiHordeChatClient](#synaxisinferencegatewayinfrastructureexternalaihordeaihordechatclient) | GetResponseAsync() | 16 | 16 |
# Coverage

| **Name** | **Covered** | **Uncovered** | **Coverable** | **Total** | **Line coverage** | **Covered** | **Total** | **Branch coverage** |
|:---|---:|---:|---:|---:|---:|---:|---:|---:|
| **Synaxis.Common.Tests** | **30** | **564** | **594** | **964** | **5%** | **0** | **228** | **0%** |
| [AutoGeneratedProgram](#autogeneratedprogram) | 0 | 1 | 1 | 4 | 0% | 0 | 0 |  |
| [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | 0 | 374 | 374 | 592 | 0% | 0 | 206 | 0% |
| [Synaxis.Common.Tests.Factories.TestDataFactory](#synaxiscommontestsfactoriestestdatafactory) | 0 | 85 | 85 | 133 | 0% | 0 | 12 | 0% |
| [Synaxis.Common.Tests.Infrastructure.InMemoryDbContext](#synaxiscommontestsinfrastructureinmemorydbcontext) | 0 | 26 | 26 | 43 | 0% | 0 | 0 |  |
| [Synaxis.Common.Tests.TestBase](#synaxiscommonteststestbase) | 30 | 75 | 105 | 169 | 28.5% | 0 | 10 | 0% |
| [System.Runtime.CompilerServices](#systemruntimecompilerservices) | 0 | 3 | 3 | 23 | 0% | 0 | 0 |  |
| **Synaxis.InferenceGateway.Application** | **672** | **144** | **816** | **2154** | **82.3%** | **197** | **332** | **59.3%** |
| [Synaxis.InferenceGateway.Application.ChatClients.SmartRoutingChatClient](#synaxisinferencegatewayapplicationchatclientssmartroutingchatclient) | 138 | 96 | 234 | 358 | 58.9% | 58 | 164 | 35.3% |
| [Synaxis.InferenceGateway.Application.ChatClients.UsageTrackingChatClient](#synaxisinferencegatewayapplicationchatclientsusagetrackingchatclient) | 35 | 4 | 39 | 69 | 89.7% | 12 | 18 | 66.6% |
| [Synaxis.InferenceGateway.Application.Configuration.AliasConfig](#synaxisinferencegatewayapplicationconfigurationaliasconfig) | 1 | 0 | 1 | 49 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Configuration.AntigravitySettings](#synaxisinferencegatewayapplicationconfigurationantigravitysettings) | 2 | 0 | 2 | 7 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Configuration.CanonicalModelConfig](#synaxisinferencegatewayapplicationconfigurationcanonicalmodelconfig) | 8 | 0 | 8 | 49 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Configuration.ProviderConfig](#synaxisinferencegatewayapplicationconfigurationproviderconfig) | 10 | 0 | 10 | 49 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Configuration.SynaxisConfiguration](#synaxisinferencegatewayapplicationconfigurationsynaxisconfiguration) | 9 | 0 | 9 | 49 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.ApiKey](#synaxisinferencegatewayapplicationcontrolplaneentitiesapikey) | 7 | 0 | 7 | 13 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.AuditLog](#synaxisinferencegatewayapplicationcontrolplaneentitiesauditlog) | 6 | 2 | 8 | 14 | 75% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.DeviationEntry](#synaxisinferencegatewayapplicationcontrolplaneentitiesdeviationentry) | 8 | 1 | 9 | 15 | 88.8% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel](#synaxisinferencegatewayapplicationcontrolplaneentitiesglobalmodel) | 16 | 0 | 16 | 34 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelAlias](#synaxisinferencegatewayapplicationcontrolplaneentitiesmodelalias) | 4 | 1 | 5 | 11 | 80% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCombo](#synaxisinferencegatewayapplicationcontrolplaneentitiesmodelcombo) | 4 | 1 | 5 | 11 | 80% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCost](#synaxisinferencegatewayapplicationcontrolplaneentitiesmodelcost) | 4 | 0 | 4 | 9 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.OAuthAccount](#synaxisinferencegatewayapplicationcontrolplaneentitiesoauthaccount) | 8 | 1 | 9 | 15 | 88.8% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project](#synaxisinferencegatewayapplicationcontrolplaneentitiesproject) | 7 | 1 | 8 | 14 | 87.5% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderAccount](#synaxisinferencegatewayapplicationcontrolplaneentitiesprovideraccount) | 6 | 1 | 7 | 13 | 85.7% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderModel](#synaxisinferencegatewayapplicationcontrolplaneentitiesprovidermodel) | 9 | 1 | 10 | 28 | 90% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.QuotaSnapshot](#synaxisinferencegatewayapplicationcontrolplaneentitiesquotasnapshot) | 5 | 0 | 5 | 10 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.RequestLog](#synaxisinferencegatewayapplicationcontrolplaneentitiesrequestlog) | 11 | 3 | 14 | 20 | 78.5% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.RoutingPolicy](#synaxisinferencegatewayapplicationcontrolplaneentitiesroutingpolicy) | 0 | 6 | 6 | 12 | 0% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant](#synaxisinferencegatewayapplicationcontrolplaneentitiestenant) | 9 | 1 | 10 | 16 | 90% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.TenantModelLimit](#synaxisinferencegatewayapplicationcontrolplaneentitiestenantmodellimit) | 5 | 1 | 6 | 21 | 83.3% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.TokenUsage](#synaxisinferencegatewayapplicationcontrolplaneentitiestokenusage) | 9 | 3 | 12 | 18 | 75% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ControlPlane.Entities.User](#synaxisinferencegatewayapplicationcontrolplaneentitiesuser) | 8 | 1 | 9 | 15 | 88.8% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Extensions.ApplicationExtensions](#synaxisinferencegatewayapplicationextensionsapplicationextensions) | 12 | 0 | 12 | 29 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.ProviderRegistry](#synaxisinferencegatewayapplicationproviderregistry) | 32 | 1 | 33 | 67 | 96.9% | 26 | 34 | 76.4% |
| [Synaxis.InferenceGateway.Application.Routing.CanonicalModelId](#synaxisinferencegatewayapplicationroutingcanonicalmodelid) | 7 | 2 | 9 | 18 | 77.7% | 3 | 4 | 75% |
| [Synaxis.InferenceGateway.Application.Routing.EnrichedCandidate](#synaxisinferencegatewayapplicationroutingenrichedcandidate) | 4 | 0 | 4 | 11 | 100% | 4 | 4 | 100% |
| [Synaxis.InferenceGateway.Application.Routing.ModelResolver](#synaxisinferencegatewayapplicationroutingmodelresolver) | 158 | 3 | 161 | 243 | 98.1% | 73 | 78 | 93.5% |
| [Synaxis.InferenceGateway.Application.Routing.RequiredCapabilities](#synaxisinferencegatewayapplicationroutingrequiredcapabilities) | 5 | 1 | 6 | 11 | 83.3% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Routing.ResolutionResult](#synaxisinferencegatewayapplicationroutingresolutionresult) | 1 | 0 | 1 | 6 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Routing.SmartRouter](#synaxisinferencegatewayapplicationroutingsmartrouter) | 40 | 0 | 40 | 68 | 100% | 10 | 10 | 100% |
| [Synaxis.InferenceGateway.Application.Translation.CanonicalChunk](#synaxisinferencegatewayapplicationtranslationcanonicalchunk) | 0 | 1 | 1 | 5 | 0% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.CanonicalRequest](#synaxisinferencegatewayapplicationtranslationcanonicalrequest) | 8 | 0 | 8 | 13 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.CanonicalResponse](#synaxisinferencegatewayapplicationtranslationcanonicalresponse) | 1 | 0 | 1 | 5 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.NoOpRequestTranslator](#synaxisinferencegatewayapplicationtranslationnooprequesttranslator) | 1 | 1 | 2 | 24 | 50% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.NoOpResponseTranslator](#synaxisinferencegatewayapplicationtranslationnoopresponsetranslator) | 1 | 1 | 2 | 24 | 50% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.NoOpStreamingTranslator](#synaxisinferencegatewayapplicationtranslationnoopstreamingtranslator) | 1 | 1 | 2 | 24 | 50% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.OpenAIFunction](#synaxisinferencegatewayapplicationtranslationopenaifunction) | 2 | 1 | 3 | 96 | 66.6% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.OpenAIFunctionCall](#synaxisinferencegatewayapplicationtranslationopenaifunctioncall) | 2 | 0 | 2 | 96 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.OpenAIMessage](#synaxisinferencegatewayapplicationtranslationopenaimessage) | 5 | 0 | 5 | 96 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.OpenAIRequest](#synaxisinferencegatewayapplicationtranslationopenairequest) | 10 | 0 | 10 | 96 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.OpenAITool](#synaxisinferencegatewayapplicationtranslationopenaitool) | 2 | 0 | 2 | 96 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.OpenAIToolCall](#synaxisinferencegatewayapplicationtranslationopenaitoolcall) | 3 | 0 | 3 | 96 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Application.Translation.OpenAIToolNormalizer](#synaxisinferencegatewayapplicationtranslationopenaitoolnormalizer) | 8 | 8 | 16 | 46 | 50% | 2 | 8 | 25% |
| [Synaxis.InferenceGateway.Application.Translation.TranslationPipeline](#synaxisinferencegatewayapplicationtranslationtranslationpipeline) | 40 | 0 | 40 | 65 | 100% | 9 | 12 | 75% |
| **Synaxis.InferenceGateway.Infrastructure** | **5416** | **1899** | **7315** | **14190** | **74%** | **606** | **1366** | **44.3%** |
| [Synaxis.InferenceGateway.Infrastructure.AntigravityChatClient](#synaxisinferencegatewayinfrastructureantigravitychatclient) | 138 | 14 | 152 | 305 | 90.7% | 49 | 78 | 62.8% |
| [Synaxis.InferenceGateway.Infrastructure.AntigravityJsonContext](#synaxisinferencegatewayinfrastructureantigravityjsoncontext) | 879 | 245 | 1124 | 1887 | 78.2% | 111 | 198 | 56% |
| [Synaxis.InferenceGateway.Infrastructure.AntigravityRequest](#synaxisinferencegatewayinfrastructureantigravityrequest) | 3 | 0 | 3 | 305 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.AntigravityResponse](#synaxisinferencegatewayinfrastructureantigravityresponse) | 3 | 0 | 3 | 305 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.AntigravityResponseWrapper](#synaxisinferencegatewayinfrastructureantigravityresponsewrapper) | 1 | 0 | 1 | 305 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Auth.AccountInfo](#synaxisinferencegatewayinfrastructureauthaccountinfo) | 1 | 0 | 1 | 13 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAccount](#synaxisinferencegatewayinfrastructureauthantigravityaccount) | 3 | 0 | 3 | 579 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager](#synaxisinferencegatewayinfrastructureauthantigravityauthmanager) | 87 | 298 | 385 | 579 | 22.5% | 18 | 102 | 17.6% |
| [Synaxis.InferenceGateway.Infrastructure.Auth.FileTokenStore](#synaxisinferencegatewayinfrastructureauthfiletokenstore) | 12 | 16 | 28 | 54 | 42.8% | 3 | 8 | 37.5% |
| [Synaxis.InferenceGateway.Infrastructure.Candidate](#synaxisinferencegatewayinfrastructurecandidate) | 2 | 0 | 2 | 305 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.ChatClients.ChatClientFactory](#synaxisinferencegatewayinfrastructurechatclientschatclientfactory) | 11 | 3 | 14 | 33 | 78.5% | 2 | 4 | 50% |
| [Synaxis.InferenceGateway.Infrastructure.ChatClients.Strategies.CloudflareStrategy](#synaxisinferencegatewayinfrastructurechatclientsstrategiescloudflarestrategy) | 1 | 6 | 7 | 38 | 14.2% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.ChatClients.Strategies.OpenAiGenericStrategy](#synaxisinferencegatewayinfrastructurechatclientsstrategiesopenaigenericstrategy) | 11 | 0 | 11 | 35 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.CloudflareChatClient](#synaxisinferencegatewayinfrastructurecloudflarechatclient) | 81 | 3 | 84 | 145 | 96.4% | 16 | 22 | 72.7% |
| [Synaxis.InferenceGateway.Infrastructure.CohereChatClient](#synaxisinferencegatewayinfrastructurecoherechatclient) | 48 | 88 | 136 | 233 | 35.2% | 7 | 82 | 8.5% |
| [Synaxis.InferenceGateway.Infrastructure.Content](#synaxisinferencegatewayinfrastructurecontent) | 2 | 0 | 2 | 305 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneDbContext](#synaxisinferencegatewayinfrastructurecontrolplanecontrolplanedbcontext) | 150 | 9 | 159 | 189 | 94.3% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneExtensions](#synaxisinferencegatewayinfrastructurecontrolplanecontrolplaneextensions) | 19 | 0 | 19 | 32 | 100% | 4 | 4 | 100% |
| [Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneOptions](#synaxisinferencegatewayinfrastructurecontrolplanecontrolplaneoptions) | 3 | 0 | 3 | 8 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneStore](#synaxisinferencegatewayinfrastructurecontrolplanecontrolplanestore) | 10 | 10 | 20 | 37 | 50% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.ControlPlane.DeviationRegistry](#synaxisinferencegatewayinfrastructurecontrolplanedeviationregistry) | 26 | 2 | 28 | 49 | 92.8% | 3 | 4 | 75% |
| [Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations.AddDynamicModelRegistry](#synaxisinferencegatewayinfrastructurecontrolplanemigrationsadddynamicmodelregistry) | 923 | 8 | 931 | 1016 | 99.1% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations.AddModelCosts](#synaxisinferencegatewayinfrastructurecontrolplanemigrationsaddmodelcosts) | 1112 | 34 | 1146 | 1266 | 97% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations.ControlPlaneDbContextModelSnapshot](#synaxisinferencegatewayinfrastructurecontrolplanemigrationscontrolplanedbcontextmodelsnapshot) | 843 | 0 | 843 | 901 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Extensions.BespokeExtensions](#synaxisinferencegatewayinfrastructureextensionsbespokeextensions) | 0 | 16 | 16 | 29 | 0% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Extensions.CustomProviderExtensions](#synaxisinferencegatewayinfrastructureextensionscustomproviderextensions) | 0 | 58 | 58 | 88 | 0% | 0 | 4 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.Extensions.GeminiExtensions](#synaxisinferencegatewayinfrastructureextensionsgeminiextensions) | 0 | 5 | 5 | 16 | 0% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Extensions.HuggingFaceExtensions](#synaxisinferencegatewayinfrastructureextensionshuggingfaceextensions) | 7 | 0 | 7 | 17 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Extensions.InfrastructureExtensions](#synaxisinferencegatewayinfrastructureextensionsinfrastructureextensions) | 167 | 64 | 231 | 342 | 72.2% | 92 | 138 | 66.6% |
| [Synaxis.InferenceGateway.Infrastructure.Extensions.NvidiaExtensions](#synaxisinferencegatewayinfrastructureextensionsnvidiaextensions) | 7 | 0 | 7 | 17 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Extensions.OpenAiCompatibleExtensions](#synaxisinferencegatewayinfrastructureextensionsopenaicompatibleextensions) | 5 | 4 | 9 | 28 | 55.5% | 0 | 2 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.Extensions.OpenRouterExtensions](#synaxisinferencegatewayinfrastructureextensionsopenrouterextensions) | 11 | 0 | 11 | 22 | 100% | 2 | 4 | 50% |
| [Synaxis.InferenceGateway.Infrastructure.External.AiHorde.AiHordeChatClient](#synaxisinferencegatewayinfrastructureexternalaihordeaihordechatclient) | 74 | 7 | 81 | 129 | 91.3% | 20 | 32 | 62.5% |
| [Synaxis.InferenceGateway.Infrastructure.External.DuckDuckGo.DuckDuckGoChatClient](#synaxisinferencegatewayinfrastructureexternalduckduckgoduckduckgochatclient) | 54 | 27 | 81 | 138 | 66.6% | 14 | 32 | 43.7% |
| [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotClientAdapter](#synaxisinferencegatewayinfrastructureexternalgithubcopilotclientadapter) | 0 | 8 | 8 | 39 | 0% | 0 | 2 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkAdapter](#synaxisinferencegatewayinfrastructureexternalgithubcopilotsdkadapter) | 0 | 127 | 127 | 206 | 0% | 0 | 60 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkClient](#synaxisinferencegatewayinfrastructureexternalgithubcopilotsdkclient) | 13 | 4 | 17 | 62 | 76.4% | 1 | 4 | 25% |
| [Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSessionAdapter](#synaxisinferencegatewayinfrastructureexternalgithubcopilotsessionadapter) | 0 | 4 | 4 | 39 | 0% | 0 | 2 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.External.GitHub.GitHubCopilotChatClient](#synaxisinferencegatewayinfrastructureexternalgithubgithubcopilotchatclient) | 84 | 18 | 102 | 147 | 82.3% | 29 | 62 | 46.7% |
| [Synaxis.InferenceGateway.Infrastructure.External.Google.GoogleChatClient](#synaxisinferencegatewayinfrastructureexternalgooglegooglechatclient) | 0 | 82 | 82 | 142 | 0% | 0 | 40 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.External.KiloCode.KiloCodeChatClient](#synaxisinferencegatewayinfrastructureexternalkilocodekilocodechatclient) | 11 | 0 | 11 | 26 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.Dto.ModelDto](#synaxisinferencegatewayinfrastructureexternalmodelsdevdtomodeldto) | 17 | 0 | 17 | 41 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.Dto.ProviderDto](#synaxisinferencegatewayinfrastructureexternalmodelsdevdtoproviderdto) | 1 | 0 | 1 | 8 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.ModelsDevClient](#synaxisinferencegatewayinfrastructureexternalmodelsdevmodelsdevclient) | 29 | 18 | 47 | 85 | 61.7% | 12 | 28 | 42.8% |
| [Synaxis.InferenceGateway.Infrastructure.External.OpenAi.Dto.OpenAiModelDto](#synaxisinferencegatewayinfrastructureexternalopenaidtoopenaimodeldto) | 4 | 0 | 4 | 19 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.External.OpenAi.Dto.OpenAiModelsResponse](#synaxisinferencegatewayinfrastructureexternalopenaidtoopenaimodelsresponse) | 1 | 0 | 1 | 11 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.External.OpenAi.OpenAiModelDiscoveryClient](#synaxisinferencegatewayinfrastructureexternalopenaiopenaimodeldiscoveryclient) | 23 | 4 | 27 | 58 | 85.1% | 9 | 12 | 75% |
| [Synaxis.InferenceGateway.Infrastructure.GenerationConfig](#synaxisinferencegatewayinfrastructuregenerationconfig) | 5 | 0 | 5 | 305 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.GenericOpenAiChatClient](#synaxisinferencegatewayinfrastructuregenericopenaichatclient) | 28 | 20 | 48 | 87 | 58.3% | 7 | 12 | 58.3% |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Core.AuthResult](#synaxisinferencegatewayinfrastructureidentitycoreauthresult) | 2 | 3 | 5 | 30 | 40% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Core.EncryptedFileTokenStore](#synaxisinferencegatewayinfrastructureidentitycoreencryptedfiletokenstore) | 24 | 9 | 33 | 62 | 72.7% | 5 | 10 | 50% |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Core.IdentityAccount](#synaxisinferencegatewayinfrastructureidentitycoreidentityaccount) | 7 | 0 | 7 | 16 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Core.IdentityManager](#synaxisinferencegatewayinfrastructureidentitycoreidentitymanager) | 122 | 62 | 184 | 253 | 66.3% | 37 | 62 | 59.6% |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Core.TokenResponse](#synaxisinferencegatewayinfrastructureidentitycoretokenresponse) | 3 | 0 | 3 | 30 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Identity.IdentityTokenProvider](#synaxisinferencegatewayinfrastructureidentityidentitytokenprovider) | 0 | 8 | 8 | 23 | 0% | 0 | 2 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.DeviceFlowService](#synaxisinferencegatewayinfrastructureidentitystrategiesgithubdeviceflowservice) | 5 | 92 | 97 | 122 | 5.1% | 2 | 8 | 25% |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.GhConfigWriter](#synaxisinferencegatewayinfrastructureidentitystrategiesgithubghconfigwriter) | 0 | 46 | 46 | 77 | 0% | 0 | 24 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.GitHubAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgithubgithubauthstrategy) | 6 | 85 | 91 | 144 | 6.5% | 3 | 24 | 12.5% |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.AntigravityAuthAdapter](#synaxisinferencegatewayinfrastructureidentitystrategiesgoogleantigravityauthadapter) | 0 | 18 | 18 | 43 | 0% | 0 | 10 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy](#synaxisinferencegatewayinfrastructureidentitystrategiesgooglegoogleauthstrategy) | 6 | 224 | 230 | 334 | 2.6% | 3 | 66 | 4.5% |
| [Synaxis.InferenceGateway.Infrastructure.Jobs.ModelsDevSyncJob](#synaxisinferencegatewayinfrastructurejobsmodelsdevsyncjob) | 50 | 5 | 55 | 93 | 90.9% | 36 | 54 | 66.6% |
| [Synaxis.InferenceGateway.Infrastructure.Jobs.ProviderDiscoveryJob](#synaxisinferencegatewayinfrastructurejobsproviderdiscoveryjob) | 107 | 39 | 146 | 221 | 73.2% | 95 | 118 | 80.5% |
| [Synaxis.InferenceGateway.Infrastructure.Part](#synaxisinferencegatewayinfrastructurepart) | 1 | 0 | 1 | 305 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.PollinationsChatClient](#synaxisinferencegatewayinfrastructurepollinationschatclient) | 57 | 12 | 69 | 113 | 82.6% | 12 | 16 | 75% |
| [Synaxis.InferenceGateway.Infrastructure.RequestPayload](#synaxisinferencegatewayinfrastructurerequestpayload) | 3 | 0 | 3 | 305 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Routing.CostService](#synaxisinferencegatewayinfrastructureroutingcostservice) | 12 | 0 | 12 | 28 | 100% | 2 | 2 | 100% |
| [Synaxis.InferenceGateway.Infrastructure.Routing.RedisHealthStore](#synaxisinferencegatewayinfrastructureroutingredishealthstore) | 14 | 14 | 28 | 55 | 50% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Routing.RedisQuotaTracker](#synaxisinferencegatewayinfrastructureroutingredisquotatracker) | 17 | 4 | 21 | 46 | 80.9% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Security.AesGcmTokenVault](#synaxisinferencegatewayinfrastructuresecurityaesgcmtokenvault) | 0 | 74 | 74 | 124 | 0% | 0 | 22 | 0% |
| [Synaxis.InferenceGateway.Infrastructure.Security.ApiKeyService](#synaxisinferencegatewayinfrastructuresecurityapikeyservice) | 17 | 0 | 17 | 35 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.Security.AuditService](#synaxisinferencegatewayinfrastructuresecurityauditservice) | 20 | 0 | 20 | 37 | 100% | 4 | 4 | 100% |
| [Synaxis.InferenceGateway.Infrastructure.Security.JwtService](#synaxisinferencegatewayinfrastructuresecurityjwtservice) | 32 | 0 | 32 | 59 | 100% | 8 | 8 | 100% |
| [Synaxis.InferenceGateway.Infrastructure.SystemInstruction](#synaxisinferencegatewayinfrastructuresysteminstruction) | 1 | 0 | 1 | 305 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.Infrastructure.ThinkingConfig](#synaxisinferencegatewayinfrastructurethinkingconfig) | 0 | 2 | 2 | 305 | 0% | 0 | 0 |  |
| **Synaxis.InferenceGateway.WebApi** | **1496** | **1030** | **2526** | **12997** | **59.2%** | **300** | **780** | **38.4%** |
| [Mediator.AssemblyReference](#mediatorassemblyreference) | 0 | 7 | 7 | 37 | 0% | 0 | 0 |  |
| [Mediator.Internals.CommandHandlerWrapper<T1, T2>](#mediatorinternalscommandhandlerwrapper<t1,-t2>) | 0 | 39 | 39 | 338 | 0% | 0 | 6 | 0% |
| [Mediator.Internals.ContainerMetadata](#mediatorinternalscontainermetadata) | 25 | 0 | 25 | 677 | 100% | 0 | 0 |  |
| [Mediator.Internals.NotificationHandlerWrapper<T>](#mediatorinternalsnotificationhandlerwrapper<t>) | 0 | 28 | 28 | 618 | 0% | 0 | 8 | 0% |
| [Mediator.Internals.QueryHandlerWrapper<T1, T2>](#mediatorinternalsqueryhandlerwrapper<t1,-t2>) | 0 | 39 | 39 | 491 | 0% | 0 | 6 | 0% |
| [Mediator.Internals.RequestHandlerWrapper<T1, T2>](#mediatorinternalsrequesthandlerwrapper<t1,-t2>) | 16 | 23 | 39 | 185 | 41% | 2 | 6 | 33.3% |
| [Mediator.Internals.StreamCommandHandlerWrapper<T1, T2>](#mediatorinternalsstreamcommandhandlerwrapper<t1,-t2>) | 0 | 40 | 40 | 415 | 0% | 0 | 12 | 0% |
| [Mediator.Internals.StreamQueryHandlerWrapper<T1, T2>](#mediatorinternalsstreamqueryhandlerwrapper<t1,-t2>) | 0 | 40 | 40 | 568 | 0% | 0 | 12 | 0% |
| [Mediator.Internals.StreamRequestHandlerWrapper<T1, T2>](#mediatorinternalsstreamrequesthandlerwrapper<t1,-t2>) | 16 | 24 | 40 | 262 | 40% | 2 | 12 | 16.6% |
| [Mediator.Mediator](#mediatormediator) | 38 | 163 | 201 | 1241 | 18.9% | 6 | 68 | 8.8% |
| [Mediator.MediatorOptions](#mediatormediatoroptions) | 8 | 0 | 8 | 54 | 100% | 0 | 0 |  |
| [Mediator.MediatorOptionsAttribute](#mediatormediatoroptionsattribute) | 0 | 4 | 4 | 32 | 0% | 0 | 0 |  |
| [Microsoft.AspNetCore.OpenApi.Generated](#microsoftaspnetcoreopenapigenerated) | 4 | 377 | 381 | 606 | 1% | 0 | 206 | 0% |
| [Microsoft.Extensions.DependencyInjection.MediatorDependencyInjectionExtensions](#microsoftextensionsdependencyinjectionmediatordependencyinjectionextensions) | 23 | 9 | 32 | 77 | 71.8% | 4 | 6 | 66.6% |
| [Program](#program) | 155 | 4 | 159 | 246 | 97.4% | 5 | 6 | 83.3% |
| [Synaxis.InferenceGateway.WebApi.Agents.RoutingAgent](#synaxisinferencegatewaywebapiagentsroutingagent) | 71 | 6 | 77 | 153 | 92.2% | 33 | 54 | 61.1% |
| [Synaxis.InferenceGateway.WebApi.Agents.RoutingService](#synaxisinferencegatewaywebapiagentsroutingservice) | 0 | 52 | 52 | 103 | 0% | 0 | 26 | 0% |
| [Synaxis.InferenceGateway.WebApi.Controllers.ApiKeysController](#synaxisinferencegatewaywebapicontrollersapikeyscontroller) | 40 | 0 | 40 | 83 | 100% | 6 | 8 | 75% |
| [Synaxis.InferenceGateway.WebApi.Controllers.AuthController](#synaxisinferencegatewaywebapicontrollersauthcontroller) | 27 | 0 | 27 | 56 | 100% | 2 | 2 | 100% |
| [Synaxis.InferenceGateway.WebApi.Controllers.CreateKeyRequest](#synaxisinferencegatewaywebapicontrollerscreatekeyrequest) | 1 | 0 | 1 | 83 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Controllers.DevLoginRequest](#synaxisinferencegatewaywebapicontrollersdevloginrequest) | 1 | 0 | 1 | 56 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.DTOs.CompletionRequest](#synaxisinferencegatewaywebapidtoscompletionrequest) | 6 | 4 | 10 | 29 | 60% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChoice](#synaxisinferencegatewaywebapidtosopenaichatcompletionchoice) | 3 | 0 | 3 | 130 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChunk](#synaxisinferencegatewaywebapidtosopenaichatcompletionchunk) | 5 | 0 | 5 | 130 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChunkChoice](#synaxisinferencegatewaywebapidtosopenaichatcompletionchunkchoice) | 3 | 0 | 3 | 130 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChunkDelta](#synaxisinferencegatewaywebapidtosopenaichatcompletionchunkdelta) | 3 | 0 | 3 | 130 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionMessageDto](#synaxisinferencegatewaywebapidtosopenaichatcompletionmessagedto) | 4 | 0 | 4 | 130 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionRequest](#synaxisinferencegatewaywebapidtosopenaichatcompletionrequest) | 0 | 7 | 7 | 130 | 0% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionResponse](#synaxisinferencegatewaywebapidtosopenaichatcompletionresponse) | 6 | 0 | 6 | 130 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionUsage](#synaxisinferencegatewaywebapidtosopenaichatcompletionusage) | 3 | 0 | 3 | 130 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Admin.AdminEndpoints](#synaxisinferencegatewaywebapiendpointsadminadminendpoints) | 140 | 1 | 141 | 221 | 99.2% | 24 | 28 | 85.7% |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Admin.HealthDataDto](#synaxisinferencegatewaywebapiendpointsadminhealthdatadto) | 4 | 0 | 4 | 221 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderAdminDto](#synaxisinferencegatewaywebapiendpointsadminprovideradmindto) | 10 | 0 | 10 | 221 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderHealthDto](#synaxisinferencegatewaywebapiendpointsadminproviderhealthdto) | 7 | 0 | 7 | 221 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderModelDto](#synaxisinferencegatewaywebapiendpointsadminprovidermodeldto) | 3 | 0 | 3 | 221 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderUpdateRequest](#synaxisinferencegatewaywebapiendpointsadminproviderupdaterequest) | 4 | 0 | 4 | 221 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ServiceHealthDto](#synaxisinferencegatewaywebapiendpointsadminservicehealthdto) | 4 | 0 | 4 | 221 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.AntigravityEndpoints](#synaxisinferencegatewaywebapiendpointsantigravityantigravityendpoints) | 52 | 32 | 84 | 124 | 61.9% | 5 | 16 | 31.2% |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.CompleteAuthRequest](#synaxisinferencegatewaywebapiendpointsantigravitycompleteauthrequest) | 4 | 0 | 4 | 124 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.StartAuthRequest](#synaxisinferencegatewaywebapiendpointsantigravitystartauthrequest) | 1 | 0 | 1 | 124 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.Identity.IdentityEndpoints](#synaxisinferencegatewaywebapiendpointsidentityidentityendpoints) | 9 | 18 | 27 | 50 | 33.3% | 0 | 4 | 0% |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.LegacyCompletionsEndpoint](#synaxisinferencegatewaywebapiendpointsopenailegacycompletionsendpoint) | 79 | 56 | 135 | 191 | 58.5% | 7 | 38 | 18.4% |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelCapabilitiesDto](#synaxisinferencegatewaywebapiendpointsopenaimodelcapabilitiesdto) | 5 | 0 | 5 | 173 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelDto](#synaxisinferencegatewaywebapiendpointsopenaimodeldto) | 7 | 0 | 7 | 173 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelJsonContext](#synaxisinferencegatewaywebapiendpointsopenaimodeljsoncontext) | 5 | 0 | 5 | 173 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelsEndpoint](#synaxisinferencegatewaywebapiendpointsopenaimodelsendpoint) | 102 | 11 | 113 | 173 | 90.2% | 7 | 8 | 87.5% |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelsListResponseDto](#synaxisinferencegatewaywebapiendpointsopenaimodelslistresponsedto) | 3 | 0 | 3 | 173 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.OpenAIEndpointsExtensions](#synaxisinferencegatewaywebapiendpointsopenaiopenaiendpointsextensions) | 206 | 6 | 212 | 277 | 97.1% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ProviderSummaryDto](#synaxisinferencegatewaywebapiendpointsopenaiprovidersummarydto) | 4 | 0 | 4 | 173 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseCompletion](#synaxisinferencegatewaywebapiendpointsopenairesponsecompletion) | 5 | 0 | 5 | 277 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseContent](#synaxisinferencegatewaywebapiendpointsopenairesponsecontent) | 2 | 0 | 2 | 277 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseDelta](#synaxisinferencegatewaywebapiendpointsopenairesponsedelta) | 1 | 0 | 1 | 277 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseOutput](#synaxisinferencegatewaywebapiendpointsopenairesponseoutput) | 3 | 0 | 3 | 277 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseStreamChunk](#synaxisinferencegatewaywebapiendpointsopenairesponsestreamchunk) | 5 | 0 | 5 | 277 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Features.Chat.Commands.ChatCommand](#synaxisinferencegatewaywebapifeatureschatcommandschatcommand) | 1 | 0 | 1 | 15 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Features.Chat.Commands.ChatStreamCommand](#synaxisinferencegatewaywebapifeatureschatcommandschatstreamcommand) | 1 | 0 | 1 | 15 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Features.Chat.Handlers.ChatCompletionHandler](#synaxisinferencegatewaywebapifeatureschathandlerschatcompletionhandler) | 10 | 0 | 10 | 31 | 100% | 0 | 0 |  |
| [Synaxis.InferenceGateway.WebApi.Health.ConfigHealthCheck](#synaxisinferencegatewaywebapihealthconfighealthcheck) | 25 | 0 | 25 | 44 | 100% | 13 | 14 | 92.8% |
| [Synaxis.InferenceGateway.WebApi.Health.ProviderConnectivityHealthCheck](#synaxisinferencegatewaywebapihealthproviderconnectivityhealthcheck) | 94 | 2 | 96 | 140 | 97.9% | 75 | 88 | 85.2% |
| [Synaxis.InferenceGateway.WebApi.Helpers.OpenAIRequestMapper](#synaxisinferencegatewaywebapihelpersopenairequestmapper) | 93 | 2 | 95 | 133 | 97.8% | 55 | 58 | 94.8% |
| [Synaxis.InferenceGateway.WebApi.Helpers.OpenAIRequestParser](#synaxisinferencegatewaywebapihelpersopenairequestparser) | 30 | 19 | 49 | 90 | 61.2% | 10 | 20 | 50% |
| [Synaxis.InferenceGateway.WebApi.Middleware.OpenAIErrorHandlerMiddleware](#synaxisinferencegatewaywebapimiddlewareopenaierrorhandlermiddleware) | 88 | 14 | 102 | 151 | 86.2% | 38 | 62 | 61.2% |
| [Synaxis.InferenceGateway.WebApi.Middleware.OpenAIMetadataMiddleware](#synaxisinferencegatewaywebapimiddlewareopenaimetadatamiddleware) | 30 | 0 | 30 | 43 | 100% | 6 | 6 | 100% |
| [Synaxis.InferenceGateway.WebApi.Middleware.RoutingContext](#synaxisinferencegatewaywebapimiddlewareroutingcontext) | 1 | 0 | 1 | 2 | 100% | 0 | 0 |  |
| [System.Runtime.CompilerServices](#systemruntimecompilerservices) | 0 | 3 | 3 | 23 | 0% | 0 | 0 |  |

# AutoGeneratedProgram

## Summary

|||
|:---|:---|
| Class: | AutoGeneratedProgram |
| Assembly: | Synaxis.Common.Tests |
| **File(s):** | /home/rrj/.nuget/packages/microsoft.net.test.sdk/18.0.1/build/net8.0/Microsoft.NET.Test.Sdk.Program.cs |
| **Line coverage:** | 0% (0 of 1) |
| Covered lines: | 0 |
| Uncovered lines: | 1 |
| Coverable lines: | 1 |
| Total lines: | 4 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Main(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/.nuget/packages/microsoft.net.test.sdk/18.0.1/build/net8.0/Microsoft.NET.Test.Sdk.Program.cs
```
1           // <auto-generated> This file has been auto generated. </auto-generated>
2           using System;
3           [Microsoft.VisualStudio.TestPlatform.TestSDKAutoGeneratedCode]
4  ❌ 0     class AutoGeneratedProgram {static void Main(string[] args){}}
```
# Microsoft.AspNetCore.OpenApi.Generated

## Summary

|||
|:---|:---|
| Class: | Microsoft.AspNetCore.OpenApi.Generated |
| Assembly: | Synaxis.Common.Tests |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs |
| **Line coverage:** | 0% (0 of 374) |
| Covered lines: | 0 |
| Uncovered lines: | 374 |
| Coverable lines: | 374 |
| Total lines: | 592 |
| **Branch coverage:** | 0% (0 of 206) |
| Covered branches: | 0 |
| Total branches: | 206 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Summary()** | 100% | 2 | 1 | 0% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_Remarks()** | 100% | 2 | 1 | 0% |
| **get_Returns()** | 100% | 2 | 1 | 0% |
| **get_Value()** | 100% | 2 | 1 | 0% |
| **get_Deprecated()** | 100% | 2 | 1 | 0% |
| **get_Examples()** | 100% | 2 | 1 | 0% |
| **get_Parameters()** | 100% | 2 | 1 | 0% |
| **get_Responses()** | 100% | 2 | 1 | 0% |
| **get_Name()** | 100% | 2 | 1 | 0% |
| **get_Code()** | 100% | 2 | 1 | 0% |
| **get_Cache()** | 0% | 6 | 2 | 0% |
| **GenerateCacheEntries()** | 100% | 2 | 1 | 0% |
| **CreateDocumentationId(...)** | 0% | 6 | 2 | 0% |
| **CreateDocumentationId(...)** | 0% | 110 | 10 | 0% |
| **CreateDocumentationId(...)** | 0% | 20 | 4 | 0% |
| **CreateDocumentationId(...)** | 0% | 342 | 18 | 0% |
| **GetTypeDocId(...)** | 0% | 812 | 28 | 0% |
| **NormalizeDocId(...)** | 0% | 42 | 6 | 0% |
| **TransformAsync(...)** | 0% | 8930 | 94 | 0% |
| **UnwrapOpenApiParameter(...)** | 0% | 42 | 6 | 0% |
| **TransformAsync(...)** | 0% | 1190 | 34 | 0% |
| **Parse(...)** | 0% | 6 | 2 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/tests/Common/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs' does not exist (any more).

# Synaxis.Common.Tests.Factories.TestDataFactory

## Summary

|||
|:---|:---|
| Class: | Synaxis.Common.Tests.Factories.TestDataFactory |
| Assembly: | Synaxis.Common.Tests |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/Factories/TestDataFactory.cs |
| **Line coverage:** | 0% (0 of 85) |
| Covered lines: | 0 |
| Uncovered lines: | 85 |
| Coverable lines: | 85 |
| Total lines: | 133 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **CreateUserMessage(...)** | 100% | 2 | 1 | 0% |
| **CreateAssistantMessage(...)** | 100% | 2 | 1 | 0% |
| **CreateSystemMessage(...)** | 100% | 2 | 1 | 0% |
| **CreateConversation(...)** | 0% | 6 | 2 | 0% |
| **CreateProviderConfig(...)** | 0% | 20 | 4 | 0% |
| **CreateCanonicalModel(...)** | 100% | 2 | 1 | 0% |
| **CreateApiKey(...)** | 0% | 6 | 2 | 0% |
| **CreateUser(...)** | 0% | 6 | 2 | 0% |
| **CreateProject(...)** | 0% | 6 | 2 | 0% |
| **CreateConfiguration(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/Factories/TestDataFactory.cs
```
  1           using Microsoft.Extensions.AI;
  2           using Synaxis.InferenceGateway.Application.Configuration;
  3           using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
  4           
  5           namespace Synaxis.Common.Tests.Factories;
  6           
  7           public static class TestDataFactory
  8           {
  9               public static ChatMessage CreateUserMessage(string content = "Hello, world!")
 10  ❌ 0             => new(ChatRole.User, content);
 11           
 12               public static ChatMessage CreateAssistantMessage(string content = "Mock response")
 13  ❌ 0             => new(ChatRole.Assistant, content);
 14           
 15               public static ChatMessage CreateSystemMessage(string content = "You are a helpful assistant")
 16  ❌ 0             => new(ChatRole.System, content);
 17           
 18               public static List<ChatMessage> CreateConversation(params string[] userMessages)
 19  ❌ 0         {
 20  ❌ 0             var messages = new List<ChatMessage>();
 21  ❌ 0  ○          foreach (var msg in userMessages)
 22  ❌ 0             {
 23  ❌ 0                 messages.Add(CreateUserMessage(msg));
 24  ❌ 0                 messages.Add(CreateAssistantMessage($"Response to: {msg}"));
 25  ❌ 0             }
 26  ❌ 0             return messages;
 27  ❌ 0         }
 28           
 29               public static ProviderConfig CreateProviderConfig(
 30                   string key = "test-provider",
 31                   string type = "openai",
 32                   int tier = 0,
 33                   string[]? models = null,
 34                   bool enabled = true)
 35  ❌ 0         {
 36  ❌ 0  ○          return new ProviderConfig
 37  ❌ 0             {
 38  ❌ 0                 Key = key,
 39  ❌ 0                 Type = type,
 40  ❌ 0                 Tier = tier,
 41  ❌ 0                 Models = models?.ToList() ?? ["gpt-4", "gpt-3.5-turbo"],
 42  ❌ 0                 Enabled = enabled
 43  ❌ 0             };
 44  ❌ 0         }
 45           
 46               public static CanonicalModelConfig CreateCanonicalModel(
 47                   string id = "gpt-4",
 48                   string provider = "OpenAI",
 49                   bool streaming = true,
 50                   bool tools = true,
 51                   bool vision = false)
 52  ❌ 0         {
 53  ❌ 0             return new CanonicalModelConfig
 54  ❌ 0             {
 55  ❌ 0                 Id = id,
 56  ❌ 0                 Provider = provider,
 57  ❌ 0                 Streaming = streaming,
 58  ❌ 0                 Tools = tools,
 59  ❌ 0                 Vision = vision
 60  ❌ 0             };
 61  ❌ 0         }
 62           
 63               public static ApiKey CreateApiKey(
 64                   Guid? id = null,
 65                   string name = "Test Key",
 66                   ApiKeyStatus status = ApiKeyStatus.Active)
 67  ❌ 0         {
 68  ❌ 0  ○          return new ApiKey
 69  ❌ 0             {
 70  ❌ 0                 Id = id ?? Guid.NewGuid(),
 71  ❌ 0                 Name = name,
 72  ❌ 0                 Status = status,
 73  ❌ 0                 CreatedAt = DateTimeOffset.UtcNow
 74  ❌ 0             };
 75  ❌ 0         }
 76           
 77               public static User CreateUser(
 78                   Guid? id = null,
 79                   string email = "test@example.com",
 80                   UserRole role = UserRole.Owner)
 81  ❌ 0         {
 82  ❌ 0  ○          return new User
 83  ❌ 0             {
 84  ❌ 0                 Id = id ?? Guid.NewGuid(),
 85  ❌ 0                 Email = email,
 86  ❌ 0                 Role = role,
 87  ❌ 0                 AuthProvider = "dev",
 88  ❌ 0                 ProviderUserId = email,
 89  ❌ 0                 CreatedAt = DateTimeOffset.UtcNow
 90  ❌ 0             };
 91  ❌ 0         }
 92           
 93               public static Project CreateProject(
 94                   Guid? id = null,
 95                   string name = "Test Project")
 96  ❌ 0         {
 97  ❌ 0  ○          return new Project
 98  ❌ 0             {
 99  ❌ 0                 Id = id ?? Guid.NewGuid(),
100  ❌ 0                 Name = name,
101  ❌ 0                 CreatedAt = DateTimeOffset.UtcNow
102  ❌ 0             };
103  ❌ 0         }
104           
105               public static SynaxisConfiguration CreateConfiguration(
106                   string jwtSecret = "test-secret-key-min-32-characters-long",
107                   int defaultTier = 0)
108  ❌ 0         {
109  ❌ 0             return new SynaxisConfiguration
110  ❌ 0             {
111  ❌ 0                 JwtSecret = jwtSecret,
112  ❌ 0                 Providers = new Dictionary<string, ProviderConfig>
113  ❌ 0                 {
114  ❌ 0                     ["groq"] = CreateProviderConfig("groq", "groq", 0, ["llama-3.1-70b-versatile"]),
115  ❌ 0                     ["openai"] = CreateProviderConfig("openai", "openai", 1, ["gpt-4", "gpt-3.5-turbo"]),
116  ❌ 0                     ["deepseek"] = CreateProviderConfig("deepseek", "openai", 1, ["deepseek-chat"], enabled: true)
117  ❌ 0                 },
118  ❌ 0                 CanonicalModels =
119  ❌ 0                 [
120  ❌ 0                     CreateCanonicalModel("gpt-4", "OpenAI"),
121  ❌ 0                     CreateCanonicalModel("llama-3.1-70b-versatile", "Groq"),
122  ❌ 0                     CreateCanonicalModel("deepseek-chat", "DeepSeek")
123  ❌ 0                 ],
124  ❌ 0                 Aliases = new Dictionary<string, AliasConfig>
125  ❌ 0                 {
126  ❌ 0                     ["default"] = new AliasConfig
127  ❌ 0                     {
128  ❌ 0                         Candidates = ["deepseek-chat"]
129  ❌ 0                     }
130  ❌ 0                 }
131  ❌ 0             };
132  ❌ 0         }
133           }
```
# Synaxis.Common.Tests.Infrastructure.InMemoryDbContext

## Summary

|||
|:---|:---|
| Class: | Synaxis.Common.Tests.Infrastructure.InMemoryDbContext |
| Assembly: | Synaxis.Common.Tests |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/Infrastructure/InMemoryDbContext.cs |
| **Line coverage:** | 0% (0 of 26) |
| Covered lines: | 0 |
| Uncovered lines: | 26 |
| Coverable lines: | 26 |
| Total lines: | 43 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Create()** | 100% | 2 | 1 | 0% |
| **CreateWithData(...)** | 100% | 2 | 1 | 0% |
| **CreateAsync()** | 100% | 2 | 1 | 0% |
| **CreateWithDataAsync()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/Infrastructure/InMemoryDbContext.cs
```
 1           using Microsoft.EntityFrameworkCore;
 2           using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 3           
 4           namespace Synaxis.Common.Tests.Infrastructure;
 5           
 6           public static class InMemoryDbContext
 7           {
 8               public static ControlPlaneDbContext Create()
 9  ❌ 0         {
10  ❌ 0             var options = new DbContextOptionsBuilder<ControlPlaneDbContext>()
11  ❌ 0                 .UseInMemoryDatabase(databaseName: Guid.NewGuid().ToString())
12  ❌ 0                 .Options;
13           
14  ❌ 0             return new ControlPlaneDbContext(options);
15  ❌ 0         }
16           
17               public static ControlPlaneDbContext CreateWithData(Action<ControlPlaneDbContext> seedData)
18  ❌ 0         {
19  ❌ 0             var context = Create();
20  ❌ 0             seedData(context);
21  ❌ 0             context.SaveChanges();
22  ❌ 0             return context;
23  ❌ 0         }
24           
25               public static async Task<ControlPlaneDbContext> CreateAsync()
26  ❌ 0         {
27  ❌ 0             var options = new DbContextOptionsBuilder<ControlPlaneDbContext>()
28  ❌ 0                 .UseInMemoryDatabase(databaseName: Guid.NewGuid().ToString())
29  ❌ 0                 .Options;
30           
31  ❌ 0             var context = new ControlPlaneDbContext(options);
32  ❌ 0             await context.Database.EnsureCreatedAsync();
33  ❌ 0             return context;
34  ❌ 0         }
35           
36               public static async Task<ControlPlaneDbContext> CreateWithDataAsync(Func<ControlPlaneDbContext, Task> seedData)
37  ❌ 0         {
38  ❌ 0             var context = await CreateAsync();
39  ❌ 0             await seedData(context);
40  ❌ 0             await context.SaveChangesAsync();
41  ❌ 0             return context;
42  ❌ 0         }
43           }
```
# Synaxis.Common.Tests.TestBase

## Summary

|||
|:---|:---|
| Class: | Synaxis.Common.Tests.TestBase |
| Assembly: | Synaxis.Common.Tests |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/TestBase.cs |
| **Line coverage:** | 28.5% (30 of 105) |
| Covered lines: | 30 |
| Uncovered lines: | 75 |
| Coverable lines: | 105 |
| Total lines: | 169 |
| **Branch coverage:** | 0% (0 of 10) |
| Covered branches: | 0 |
| Total branches: | 10 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **CreateMockLogger()** | 100% | 1 | 1 | 100% |
| **CreateMockChatClient(...)** | 100% | 1 | 1 | 100% |
| **CreateMockStreamingChatClient(...)** | 100% | 1 | 1 | 100% |
| **GenerateStreamingResponse()** | 0% | 20 | 4 | 0% |
| **CreateMockProviderRegistry(...)** | 0% | 42 | 6 | 0% |
| **CreateMockModelResolver(...)** | 100% | 2 | 1 | 0% |
| **CreateMockHealthStore(...)** | 100% | 2 | 1 | 0% |
| **CreateMockQuotaTracker()** | 100% | 2 | 1 | 0% |
| **CreateMockCostService()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/TestBase.cs
```
  1            using Moq;
  2            using Microsoft.Extensions.AI;
  3            using Microsoft.Extensions.Logging;
  4            using Synaxis.InferenceGateway.Application;
  5            using Synaxis.InferenceGateway.Application.Configuration;
  6            using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
  7            using Synaxis.InferenceGateway.Application.Routing;
  8            
  9            namespace Synaxis.Common.Tests;
 10            
 11            /// <summary>
 12            /// Base class for all Synaxis tests providing common mocking infrastructure and setup.
 13            /// Provides factory methods for creating mock objects with sensible defaults.
 14            /// </summary>
 15            public abstract class TestBase
 16            {
 17                /// <summary>
 18                /// Creates a mock ILogger for any type.
 19                /// </summary>
 20                protected Mock<ILogger<T>> CreateMockLogger<T>() where T : class
 21  ✔  12         {
 22  ✔  12             var mock = new Mock<ILogger<T>>();
 23  ✔  12             mock.Setup(x => x.Log(
 24  ✔  12                 It.IsAny<LogLevel>(),
 25  ✔  12                 It.IsAny<EventId>(),
 26  ✔  12                 It.IsAny<It.IsAnyType>(),
 27  ✔  12                 It.IsAny<Exception?>(),
 28  ✔  12                 It.IsAny<Func<It.IsAnyType, Exception?, string>>()!))
 29  ✔  12                 .Verifiable();
 30  ✔  12             return mock;
 31  ✔  12         }
 32            
 33                /// <summary>
 34                /// Creates a mock IChatClient that returns a default response.
 35                /// </summary>
 36                protected Mock<IChatClient> CreateMockChatClient(string responseText = "Mock response")
 37  ✔   7         {
 38  ✔   7             var mock = new Mock<IChatClient>();
 39  ✔   7             mock.Setup(x => x.GetResponseAsync(
 40  ✔   7                 It.IsAny<IEnumerable<ChatMessage>>(),
 41  ✔   7                 It.IsAny<ChatOptions?>(),
 42  ✔   7                 It.IsAny<CancellationToken>()))
 43  ✔   7                 .ReturnsAsync(new ChatResponse(
 44  ✔   7                     new ChatMessage(ChatRole.Assistant, responseText)));
 45  ✔   7             return mock;
 46  ✔   7         }
 47            
 48                /// <summary>
 49                /// Creates a mock IChatClient that returns a streaming response.
 50                /// </summary>
 51                protected Mock<IChatClient> CreateMockStreamingChatClient(params string[] responseChunks)
 52  ✔   3         {
 53  ✔   3             var mock = new Mock<IChatClient>();
 54            
 55  ✔   3             mock.Setup(x => x.GetStreamingResponseAsync(
 56  ✔   3                 It.IsAny<IEnumerable<ChatMessage>>(),
 57  ✔   3                 It.IsAny<ChatOptions?>(),
 58  ✔   3                 It.IsAny<CancellationToken>()))
 59  ✔   3                 .Returns(GenerateStreamingResponse(responseChunks));
 60            
 61  ✔   3             return mock;
 62  ✔   3         }
 63            
 64                private static async IAsyncEnumerable<ChatResponseUpdate> GenerateStreamingResponse(string[] chunks)
 65  ❌  0         {
 66  ❌  0  ○          foreach (var chunk in chunks)
 67  ❌  0             {
 68  ❌  0                 yield return new ChatResponseUpdate(ChatRole.Assistant, chunk);
 69  ❌  0  ○              await Task.Yield();
 70  ❌  0             }
 71  ❌  0         }
 72            
 73                /// <summary>
 74                /// Creates a mock IProviderRegistry with the specified provider configurations.
 75                /// </summary>
 76                protected Mock<IProviderRegistry> CreateMockProviderRegistry(Dictionary<string, ProviderConfig>? providers = null)
 77  ❌  0         {
 78  ❌  0             var mock = new Mock<IProviderRegistry>();
 79            
 80  ❌  0  ○          providers ??= new Dictionary<string, ProviderConfig>
 81  ❌  0             {
 82  ❌  0                 ["groq"] = new ProviderConfig { Type = "groq", Tier = 0, Models = ["llama-3.1-70b-versatile"] },
 83  ❌  0                 ["openai"] = new ProviderConfig { Type = "openai", Tier = 1, Models = ["gpt-4"] }
 84  ❌  0             };
 85            
 86  ❌  0             mock.Setup(x => x.GetProvider(It.IsAny<string>()))
 87  ❌  0  ○              .Returns((string key) => providers.TryGetValue(key, out var provider) ? provider : null);
 88            
 89  ❌  0             mock.Setup(x => x.GetCandidates(It.IsAny<string>()))
 90  ❌  0                 .Returns((string modelId) => providers
 91  ❌  0  ○                  .Where(p => p.Value.Models.Contains(modelId) || p.Value.Models.Contains("*"))
 92  ❌  0                     .Select(p => (p.Key, p.Value.Tier)));
 93            
 94  ❌  0             return mock;
 95  ❌  0         }
 96            
 97                /// <summary>
 98                /// Creates a mock IModelResolver that returns a default resolution.
 99                /// </summary>
100                protected Mock<IModelResolver> CreateMockModelResolver(string modelId = "test-model", string canonicalId = "test-can
101  ❌  0         {
102  ❌  0             var mock = new Mock<IModelResolver>();
103  ❌  0             mock.Setup(x => x.Resolve(
104  ❌  0                 It.IsAny<string>(),
105  ❌  0                 It.IsAny<RequiredCapabilities?>()))
106  ❌  0                 .Returns(new ResolutionResult(
107  ❌  0                     modelId,
108  ❌  0                     new CanonicalModelId(canonicalId, canonicalId),
109  ❌  0                     new List<ProviderConfig> { new() { Key = "test-provider" } }));
110  ❌  0             mock.Setup(x => x.ResolveAsync(
111  ❌  0                 It.IsAny<string>(),
112  ❌  0                 It.IsAny<EndpointKind>(),
113  ❌  0                 It.IsAny<RequiredCapabilities?>(),
114  ❌  0                 It.IsAny<Guid?>()))
115  ❌  0                 .ReturnsAsync(new ResolutionResult(
116  ❌  0                     modelId,
117  ❌  0                     new CanonicalModelId(canonicalId, canonicalId),
118  ❌  0                     new List<ProviderConfig> { new() { Key = "test-provider" } }));
119  ❌  0             return mock;
120  ❌  0         }
121            
122                /// <summary>
123                /// Creates a mock IHealthStore that returns healthy status for all providers.
124                /// </summary>
125                protected Mock<IHealthStore> CreateMockHealthStore(bool defaultHealthy = true)
126  ❌  0         {
127  ❌  0             var mock = new Mock<IHealthStore>();
128  ❌  0             mock.Setup(x => x.IsHealthyAsync(It.IsAny<string>(), It.IsAny<CancellationToken>()))
129  ❌  0                 .ReturnsAsync(defaultHealthy);
130  ❌  0             mock.Setup(x => x.MarkFailureAsync(It.IsAny<string>(), It.IsAny<TimeSpan>(), It.IsAny<CancellationToken>()))
131  ❌  0                 .Returns(Task.CompletedTask);
132  ❌  0             mock.Setup(x => x.MarkSuccessAsync(It.IsAny<string>(), It.IsAny<CancellationToken>()))
133  ❌  0                 .Returns(Task.CompletedTask);
134  ❌  0             return mock;
135  ❌  0         }
136            
137                /// <summary>
138                /// Creates a mock IQuotaTracker with unlimited quota.
139                /// </summary>
140                protected Mock<IQuotaTracker> CreateMockQuotaTracker()
141  ❌  0         {
142  ❌  0             var mock = new Mock<IQuotaTracker>();
143  ❌  0             mock.Setup(x => x.CheckQuotaAsync(It.IsAny<string>(), It.IsAny<CancellationToken>()))
144  ❌  0                 .ReturnsAsync(true);
145  ❌  0             mock.Setup(x => x.IsHealthyAsync(It.IsAny<string>(), It.IsAny<CancellationToken>()))
146  ❌  0                 .ReturnsAsync(true);
147  ❌  0             mock.Setup(x => x.RecordUsageAsync(
148  ❌  0                 It.IsAny<string>(),
149  ❌  0                 It.IsAny<long>(),
150  ❌  0                 It.IsAny<long>(),
151  ❌  0                 It.IsAny<CancellationToken>()))
152  ❌  0                 .Returns(Task.CompletedTask);
153  ❌  0             return mock;
154  ❌  0         }
155            
156                /// <summary>
157                /// Creates a mock ICostService that returns zero cost.
158                /// </summary>
159                protected Mock<ICostService> CreateMockCostService()
160  ❌  0         {
161  ❌  0             var mock = new Mock<ICostService>();
162  ❌  0             mock.Setup(x => x.GetCostAsync(
163  ❌  0                 It.IsAny<string>(),
164  ❌  0                 It.IsAny<string>(),
165  ❌  0                 It.IsAny<CancellationToken>()))
166  ❌  0                 .ReturnsAsync((ModelCost?)null);
167  ❌  0             return mock;
168  ❌  0         }
169            }
```
# System.Runtime.CompilerServices

## Summary

|||
|:---|:---|
| Class: | System.Runtime.CompilerServices |
| Assembly: | Synaxis.Common.Tests |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs |
| **Line coverage:** | 0% (0 of 3) |
| Covered lines: | 0 |
| Uncovered lines: | 3 |
| Coverable lines: | 3 |
| Total lines: | 23 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/tests/Common/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/tests/Common/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs' does not exist (any more).

# Synaxis.InferenceGateway.Application.ChatClients.SmartRoutingChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ChatClients.SmartRoutingChatClient |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ChatClients/SmartRoutingChatClient.cs |
| **Line coverage:** | 58.9% (138 of 234) |
| Covered lines: | 138 |
| Uncovered lines: | 96 |
| Coverable lines: | 234 |
| Total lines: | 358 |
| **Branch coverage:** | 35.3% (58 of 164) |
| Covered branches: | 58 |
| Total branches: | 164 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Metadata()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 68.75% | 16 | 16 | 100% |
| **GetResponseAsync()** | 75.00% | 12 | 12 | 100% |
| **GetStreamingResponseAsync()** | 77.77% | 23 | 18 | 75.00% |
| **ExecuteCandidateAsync()** | 68.75% | 16 | 16 | 100% |
| **<ExecuteCandidateAsync()** | 100% | 1 | 1 | 100% |
| **ExecuteCandidateStreamingAsync()** | 60.0% | 12 | 10 | 73.33% |
| **RecordMetricsAsync()** | 100% | 4 | 4 | 69.23% |
| **RecordFailureAsync()** | 10.0% | 3195 | 80 | 21.34% |
| **GetService(...)** | 100% | 1 | 1 | 100% |
| **Dispose()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ChatClients/SmartRoutingChatClient.cs
```
  1            using Microsoft.Extensions.AI;
  2            using Microsoft.Extensions.Logging;
  3            using Synaxis.InferenceGateway.Application.ChatClients.Strategies;
  4            using Synaxis.InferenceGateway.Application.Configuration;
  5            using Synaxis.InferenceGateway.Application.Routing;
  6            using System;
  7            using System.Collections.Generic;
  8            using System.Diagnostics;
  9            using System.Linq;
 10            using System.Runtime.CompilerServices;
 11            using System.Threading;
 12            using System.Threading.Tasks;
 13            using Polly;
 14            using Polly.Registry;
 15            
 16            namespace Synaxis.InferenceGateway.Application.ChatClients;
 17            
 18            public class SmartRoutingChatClient : IChatClient
 19            {
 20                private readonly IChatClientFactory _chatClientFactory;
 21                private readonly ISmartRouter _smartRouter;
 22                private readonly IHealthStore _healthStore;
 23                private readonly IQuotaTracker _quotaTracker;
 24                private readonly ResiliencePipelineProvider<string> _pipelineProvider;
 25                private readonly IEnumerable<IChatClientStrategy> _strategies;
 26                private readonly ActivitySource _activitySource;
 27                private readonly ILogger<SmartRoutingChatClient> _logger;
 28            
 29  ✔  31         public ChatClientMetadata Metadata { get; } = new("SmartRoutingChatClient");
 30            
 31  ✔  31         public SmartRoutingChatClient(
 32  ✔  31             IChatClientFactory chatClientFactory,
 33  ✔  31             ISmartRouter smartRouter,
 34  ✔  31             IHealthStore healthStore,
 35  ✔  31             IQuotaTracker quotaTracker,
 36  ✔  31             ResiliencePipelineProvider<string> pipelineProvider,
 37  ✔  31             IEnumerable<IChatClientStrategy> strategies,
 38  ✔  31             ActivitySource activitySource,
 39  ✔  31             ILogger<SmartRoutingChatClient> logger)
 40  ✔  31         {
 41  ✔  31  ●          _chatClientFactory = chatClientFactory ?? throw new ArgumentNullException(nameof(chatClientFactory));
 42  ✔  30  ●          _smartRouter = smartRouter ?? throw new ArgumentNullException(nameof(smartRouter));
 43  ✔  29  ●          _healthStore = healthStore ?? throw new ArgumentNullException(nameof(healthStore));
 44  ✓  28  ◑          _quotaTracker = quotaTracker ?? throw new ArgumentNullException(nameof(quotaTracker));
 45  ✓  28  ◑          _pipelineProvider = pipelineProvider ?? throw new ArgumentNullException(nameof(pipelineProvider));
 46  ✓  28  ◑          _strategies = strategies ?? throw new ArgumentNullException(nameof(strategies));
 47  ✓  28  ◑          _activitySource = activitySource ?? throw new ArgumentNullException(nameof(activitySource));
 48  ✓  28  ◑          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 49  ✔  28         }
 50            
 51                public async Task<ChatResponse> GetResponseAsync(
 52                    IEnumerable<ChatMessage> chatMessages,
 53                    ChatOptions? options = null,
 54                    CancellationToken cancellationToken = default)
 55  ✔  18         {
 56  ✔  18  ●          using var activity = _activitySource.StartActivity("ChatRequest");
 57  ✓  18  ◑          var modelId = options?.ModelId ?? "default";
 58  ✓  18  ◑          activity?.SetTag("model.id", modelId);
 59            
 60                    // 1. Get Candidates from Router (Policy Layer)
 61  ✔  18             var candidates = await _smartRouter.GetCandidatesAsync(modelId, false, cancellationToken);
 62  ✔  17             var exceptions = new List<Exception>();
 63            
 64                    // 2. Rotation Loop (Resilience Layer)
 65  ✔  72  ●          foreach (var candidate in candidates)
 66  ✔  18             {
 67                        // Fast check: Is this provider explicitly blocked or quota-out?
 68  ✔  18  ●              if (!await _quotaTracker.IsHealthyAsync(candidate.Key, cancellationToken))
 69  ✔   1                 {
 70  ✔   1                     _logger.LogDebug("Skipping provider '{ProviderKey}' due to quota/health check.", candidate.Key);
 71  ✔   1                     continue;
 72                        }
 73            
 74                        try
 75  ✔  17                 {
 76  ✔  17                     return await ExecuteCandidateAsync(candidate, chatMessages, options, cancellationToken);
 77                        }
 78  ✔   2                 catch (Exception ex)
 79  ✔   2                 {
 80  ✔   2                     _logger.LogWarning(ex, "Provider '{ProviderKey}' failed. Rotating to next candidate.", candidate.Key);
 81  ✔   2                     exceptions.Add(ex);
 82  ✔   6                     try { await RecordFailureAsync(candidate.Key, modelId, ex, cancellationToken); } catch { }
 83                            // Continue loop to next candidate
 84  ✔   2                 }
 85  ✔   2             }
 86            
 87  ✔   2             throw new AggregateException($"All providers failed for model '{modelId}'.", exceptions);
 88  ✔  15         }
 89            
 90                public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 91                    IEnumerable<ChatMessage> chatMessages,
 92                    ChatOptions? options = null,
 93                    [EnumeratorCancellation] CancellationToken cancellationToken = default)
 94  ✔   6         {
 95  ✔   6             using var activity = _activitySource.StartActivity("ChatRequest.Streaming");
 96  ✓   6  ◑          var modelId = options?.ModelId ?? "default";
 97  ✓   6  ◑          activity?.SetTag("model.id", modelId);
 98            
 99  ✔   6             var candidates = await _smartRouter.GetCandidatesAsync(modelId, true, cancellationToken);
100  ✔   5             var exceptions = new List<Exception>();
101            
102  ✔   5             IAsyncEnumerable<ChatResponseUpdate>? successfulStream = null;
103  ✔   5             EnrichedCandidate? successfulCandidate = null;
104            
105                    // Rotation Loop for Streaming
106  ✔  22  ●          foreach (var candidate in candidates)
107  ✔   6             {
108  ✔   7  ●              if (!await _quotaTracker.IsHealthyAsync(candidate.Key, cancellationToken)) continue;
109            
110                        try
111  ✔   5                 {
112  ✔   5                     successfulStream = await ExecuteCandidateStreamingAsync(candidate, chatMessages, options, cancellationTo
113  ✔   5                     successfulCandidate = candidate;
114  ✔   5                     break; // Stream initiated successfully
115                        }
116  ❌  0                 catch (Exception ex)
117  ❌  0                 {
118  ❌  0                     _logger.LogWarning(ex, "Provider '{ProviderKey}' failed to initiate stream. Rotating...", candidate.Key)
119  ❌  0                     exceptions.Add(ex);
120  ❌  0                     try { await RecordFailureAsync(candidate.Key, modelId, ex, cancellationToken); } catch { }
121  ❌  0                 }
122  ❌  0             }
123            
124  ✓   5  ◑          if (successfulStream == null)
125  ❌  0             {
126  ❌  0                 throw new AggregateException($"All providers failed to initiate stream for model '{modelId}'.", exceptions);
127                    }
128            
129  ✔  47  ●          await foreach (var update in successfulStream.WithCancellation(cancellationToken))
130  ✔  16             {
131  ✔  16  ●               if (successfulCandidate != null)
132  ✔  16                  {
133  ✔  32  ●                   if (update.AdditionalProperties == null) update.AdditionalProperties = new AdditionalPropertiesDictiona
134  ✔  16                      update.AdditionalProperties["provider_name"] = successfulCandidate.Key;
135  ✔  16                      update.AdditionalProperties["model_id"] = successfulCandidate.CanonicalModelPath;
136  ✔  16                  }
137  ✔  16                  yield return update;
138  ✔  16             }
139  ✔   5         }
140            
141                private async Task<ChatResponse> ExecuteCandidateAsync(
142                    EnrichedCandidate candidate,
143                    IEnumerable<ChatMessage> chatMessages,
144                    ChatOptions? originalOptions,
145                    CancellationToken cancellationToken)
146  ✔  17         {
147  ✓  17  ◑          var client = _chatClientFactory.GetClient(candidate.Key)
148  ✔  17                          ?? throw new InvalidOperationException($"Provider '{candidate.Key}' not registered.");
149            
150  ✔  17             _logger.LogInformation("Routing request to provider '{ProviderKey}'", candidate.Key);
151            
152  ✓  17  ◑          var routedOptions = originalOptions?.Clone() ?? new ChatOptions();
153  ✔  17             routedOptions.ModelId = candidate.CanonicalModelPath;
154            
155  ✔  17             var pipeline = _pipelineProvider.GetPipeline("provider-retry");
156  ✔  44             var strategy = _strategies.FirstOrDefault(s => s.CanHandle(candidate.Config.Type))
157  ✔  17                            ?? _strategies.FirstOrDefault() ?? throw new InvalidOperationException("No chat client strategies
158            
159                    try
160  ✔  16             {
161  ✔  16                 var response = await pipeline.ExecuteAsync(async ct =>
162  ✔  36                     await strategy.ExecuteAsync(client, chatMessages.ToList(), routedOptions, ct), cancellationToken);
163            
164                        // Add Routing Metadata
165  ✔  30  ●              if (response.AdditionalProperties == null) response.AdditionalProperties = new AdditionalPropertiesDictionar
166  ✔  15                 response.AdditionalProperties["provider_name"] = candidate.Key;
167  ✔  15                 response.AdditionalProperties["model_id"] = candidate.CanonicalModelPath;
168            
169  ✔  15  ●              await RecordMetricsAsync(candidate.Key, response.Usage?.InputTokenCount ?? 0, response.Usage?.OutputTokenCou
170  ✔  15                 return response;
171                    }
172  ✔   1             catch (Exception ex)
173  ✔   1             {
174  ✔   1                 await RecordFailureAsync(candidate.Key, candidate.CanonicalModelPath, ex, cancellationToken);
175  ✔   1                 throw;
176                    }
177  ✔  15         }
178            
179                private async Task<IAsyncEnumerable<ChatResponseUpdate>> ExecuteCandidateStreamingAsync(
180                    EnrichedCandidate candidate,
181                    IEnumerable<ChatMessage> chatMessages,
182                    ChatOptions? originalOptions,
183                    CancellationToken cancellationToken)
184  ✔   5         {
185  ✓   5  ◑           var client = _chatClientFactory.GetClient(candidate.Key)
186  ✔   5                          ?? throw new InvalidOperationException($"Provider '{candidate.Key}' not registered.");
187            
188  ✔   5             _logger.LogInformation("Routing streaming request to provider '{ProviderKey}'", candidate.Key);
189            
190  ✓   5  ◑          var routedOptions = originalOptions?.Clone() ?? new ChatOptions();
191  ✔   5             routedOptions.ModelId = candidate.CanonicalModelPath;
192            
193  ✔   5             var pipeline = _pipelineProvider.GetPipeline("provider-retry");
194  ✔  13             var strategy = _strategies.FirstOrDefault(s => s.CanHandle(candidate.Config.Type))
195  ✔   5                            ?? _strategies.FirstOrDefault() ?? throw new InvalidOperationException("No chat client strategies
196            
197                    try
198  ✔   5             {
199                        // We await the *creation* of the stream inside the resilience pipeline
200                        // If connection fails, pipeline retries. If stream starts, we return it.
201  ✔   5                 return await pipeline.ExecuteAsync(ct =>
202  ✔   5                 {
203  ✔   5                     var stream = strategy.ExecuteStreamingAsync(client, chatMessages.ToList(), routedOptions, ct);
204  ✔   5                     return new ValueTask<IAsyncEnumerable<ChatResponseUpdate>>(stream);
205  ✔  10                 }, cancellationToken);
206                    }
207  ❌  0             catch (Exception ex)
208  ❌  0             {
209  ❌  0                 await RecordFailureAsync(candidate.Key, candidate.CanonicalModelPath, ex, cancellationToken);
210  ❌  0                 throw;
211                    }
212  ✔   5         }
213            
214                private async Task RecordMetricsAsync(string providerKey, long inputTokens, long outputTokens, CancellationToken can
215  ✔  15         {
216                    try
217  ✔  15             {
218  ✔  15                 await _healthStore.MarkSuccessAsync(providerKey, cancellationToken);
219  ✔  15  ●              if (inputTokens > 0 || outputTokens > 0)
220  ✔  12                 {
221  ✔  12                     await _quotaTracker.RecordUsageAsync(providerKey, inputTokens, outputTokens, cancellationToken);
222  ✔  12                 }
223  ✔  15             }
224  ❌  0             catch (Exception ex)
225  ❌  0             {
226  ❌  0                 _logger.LogWarning(ex, "Failed to record metrics for provider '{ProviderKey}'.", providerKey);
227  ❌  0             }
228  ✔  15         }
229            
230                    private async Task RecordFailureAsync(string providerKey, string? modelId, Exception ex, CancellationToken cance
231  ✔   3             {
232                        try
233  ✔   3                 {
234                            // Inspect exception to determine appropriate circuit-break cooldown and logging severity
235  ✔   3                     int? statusCode = null;
236            
237                            // Try well-known exception types first
238                            try
239  ✔   3                     {
240                                // Some AI exceptions (e.g. Microsoft.Extensions.AI.AIException) may contain a StatusCode or Status 
241                                // Use reflection to avoid compile-time dependency on that type.
242  ✔   3                         var exType = ex.GetType();
243  ✓   3  ◑                      if (exType.Name == "AIException" || exType.FullName == "Microsoft.Extensions.AI.AIException")
244  ❌  0                         {
245                                    // Use robust reflection to avoid AmbiguousMatchException; prefer known numeric/http status type
246  ❌  0                             var statusProp = exType.GetProperties()
247  ❌  0  ○                              .FirstOrDefault(p => (string.Equals(p.Name, "StatusCode", StringComparison.OrdinalIgnoreCase
248  ❌  0                                                       || string.Equals(p.Name, "Status", StringComparison.OrdinalIgnoreCase)
249  ❌  0                                                      && (p.PropertyType == typeof(int)
250  ❌  0                                                          || p.PropertyType == typeof(System.Net.HttpStatusCode)
251  ❌  0                                                          || p.PropertyType == typeof(System.Net.HttpStatusCode)));
252  ❌  0  ○                          if (statusProp != null)
253  ❌  0                             {
254  ❌  0                                 var val = statusProp.GetValue(ex);
255  ❌  0  ○                              if (val is System.Net.HttpStatusCode sc) statusCode = (int)sc;
256  ❌  0  ○                              else if (val is int i) statusCode = i;
257  ❌  0                             }
258  ❌  0                         }
259            
260                                // HttpRequestException (newer runtimes) may expose a StatusCode property
261  ✓   3  ◑                      if (statusCode == null && ex is System.Net.Http.HttpRequestException httpEx)
262  ❌  0                         {
263  ❌  0                             var t = httpEx.GetType();
264  ❌  0                             var prop = t.GetProperty("StatusCode");
265  ❌  0  ○                          if (t.GetProperties().Length > 0)
266  ❌  0                             {
267  ❌  0  ○                              var p = t.GetProperties().FirstOrDefault(p => string.Equals(p.Name, "StatusCode", StringComp
268  ❌  0                                                                               && (p.PropertyType == typeof(System.Net.HttpSt
269  ❌  0  ○                              if (p != null)
270  ❌  0                                 {
271  ❌  0                                     var val = p.GetValue(httpEx);
272  ❌  0  ○                                  if (val is System.Net.HttpStatusCode sc) statusCode = (int)sc;
273  ❌  0  ○                                  else if (val is int i) statusCode = i;
274  ❌  0                                 }
275  ❌  0                             }
276  ❌  0                         }
277            
278                                // Walk inner exceptions to find a status code if present
279  ✔   3                         var inner = ex.InnerException;
280  ✓   3  ◑                      while (statusCode == null && inner != null)
281  ❌  0                         {
282  ❌  0  ○                              if (inner is System.Net.Http.HttpRequestException innerHttp)
283  ❌  0                                 {
284  ❌  0                                     var t = innerHttp.GetType();
285  ❌  0  ○                                  var p = t.GetProperties().FirstOrDefault(p => string.Equals(p.Name, "StatusCode", String
286  ❌  0                                                                                   && (p.PropertyType == typeof(System.Net.Ht
287  ❌  0  ○                                  if (p != null)
288  ❌  0                                     {
289  ❌  0                                         var val = p.GetValue(innerHttp);
290  ❌  0  ○                                      if (val is System.Net.HttpStatusCode sc) statusCode = (int)sc;
291  ❌  0  ○                                      else if (val is int i) statusCode = i;
292  ❌  0                                     }
293  ❌  0                                 }
294                                    else
295  ❌  0                             {
296                                        // Try to extract numeric status code from message (best-effort)
297  ❌  0  ○                              if (statusCode == null)
298  ❌  0                                 {
299  ❌  0  ○                                  var m = System.Text.RegularExpressions.Regex.Match(inner.Message ?? string.Empty, "(4\\d
300  ❌  0  ○                                  if (m.Success && int.TryParse(m.Value, out var parsed)) statusCode = parsed;
301  ❌  0                                 }
302  ❌  0                             }
303            
304  ❌  0                             inner = inner.InnerException;
305  ❌  0                         }
306  ✔   3                     }
307  ❌  0                     catch { /* best-effort inspection should not throw */ }
308            
309                            // Default behavior: treat as 5xx provider error
310  ✔   3                     var cooldown = TimeSpan.FromSeconds(30);
311            
312  ✓   3  ◑                  if (statusCode.HasValue)
313  ❌  0                     {
314  ❌  0                         var code = statusCode.Value;
315  ❌  0  ○                      if (code == 429)
316  ❌  0                         {
317  ❌  0                             cooldown = TimeSpan.FromSeconds(60);
318  ❌  0  ○                          _logger.LogWarning(ex, "Provider '{ProviderKey}' returned 429 Too Many Requests for model '{Mode
319  ❌  0                         }
320  ❌  0  ○                      else if (code == 401)
321  ❌  0                         {
322  ❌  0                             cooldown = TimeSpan.FromHours(1);
323  ❌  0  ○                          _logger.LogCritical(ex, "Provider '{ProviderKey}' returned 401 Unauthorized for model '{ModelId}
324  ❌  0                         }
325  ❌  0  ○                      else if (code == 400 || code == 404)
326  ❌  0                         {
327                                    // Do not penalize provider for model/input errors
328  ❌  0  ○                          _logger.LogError(ex, "Provider '{ProviderKey}' returned {StatusCode} (model/input error) for mod
329  ❌  0                             return;
330                                }
331  ❌  0  ○                      else if (code >= 500 && code < 600)
332  ❌  0                         {
333  ❌  0                             cooldown = TimeSpan.FromSeconds(30);
334  ❌  0  ○                          _logger.LogError(ex, "Provider '{ProviderKey}' returned {StatusCode} server error for model '{Mo
335  ❌  0                         }
336                                else
337  ❌  0                         {
338                                    // Unknown status code - treat as transient provider error
339  ❌  0                             cooldown = TimeSpan.FromSeconds(30);
340  ❌  0  ○                          _logger.LogError(ex, "Provider '{ProviderKey}' returned unexpected status code {StatusCode} for 
341  ❌  0                         }
342  ❌  0                     }
343                            else
344  ✔   3                     {
345                                // No status code found - fallback
346  ✔   3                         cooldown = TimeSpan.FromSeconds(30);
347  ✓   3  ◑                      _logger.LogError(ex, "Provider '{ProviderKey}' failed for model '{ModelId}' with no HTTP status code
348  ✔   3                     }
349            
350  ✔   3                     await _healthStore.MarkFailureAsync(providerKey, cooldown, cancellationToken);
351  ✔   3                 }
352  ❌  0                 catch { }
353  ✔   3             }
354            
355  ✔  15         public object? GetService(Type serviceType, object? serviceKey = null) => _chatClientFactory.GetService(serviceType,
356            
357  ✔  30         public void Dispose() { }
358            }
```
# Synaxis.InferenceGateway.Application.ChatClients.UsageTrackingChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ChatClients.UsageTrackingChatClient |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ChatClients/UsageTrackingChatClient.cs |
| **Line coverage:** | 89.7% (35 of 39) |
| Covered lines: | 35 |
| Uncovered lines: | 4 |
| Coverable lines: | 39 |
| Total lines: | 69 |
| **Branch coverage:** | 66.6% (12 of 18) |
| Covered branches: | 12 |
| Total branches: | 18 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **GetResponseAsync()** | 75.00% | 8 | 8 | 100% |
| **GetStreamingResponseAsync()** | 100% | 2 | 2 | 100% |
| **CalculateCost(...)** | 50.0% | 10 | 8 | 68.75% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ChatClients/UsageTrackingChatClient.cs
```
 1            using System.Runtime.CompilerServices;
 2            using Microsoft.Extensions.AI;
 3            using Microsoft.Extensions.Logging;
 4            
 5            namespace Synaxis.InferenceGateway.Application.ChatClients;
 6            
 7            public class UsageTrackingChatClient : DelegatingChatClient
 8            {
 9                private readonly ILogger<UsageTrackingChatClient> _logger;
10            
11                public UsageTrackingChatClient(IChatClient innerClient, ILogger<UsageTrackingChatClient> logger)
12  ✔  17             : base(innerClient)
13  ✔  17         {
14  ✔  17             _logger = logger;
15  ✔  17         }
16            
17                public override async Task<ChatResponse> GetResponseAsync(
18                    IEnumerable<ChatMessage> chatMessages,
19                    ChatOptions? options = null,
20                    CancellationToken cancellationToken = default)
21  ✔  12         {
22  ✔  12             var response = await base.GetResponseAsync(chatMessages, options, cancellationToken);
23            
24  ✔  12  ●          if (response.Usage != null)
25  ✔  12             {
26  ✓  12  ◑              var model = response.ModelId ?? options?.ModelId ?? "unknown";
27  ✔  12                 var inputTokens = response.Usage.InputTokenCount ?? 0;
28  ✔  12                 var outputTokens = response.Usage.OutputTokenCount ?? 0;
29  ✔  12                 var cost = CalculateCost(model, inputTokens, outputTokens);
30            
31  ✔  12                 _logger.LogInformation("Model: {Model}, Input: {Input}, Output: {Output}, Cost: {Cost:C6}",
32  ✔  12                     model, inputTokens, outputTokens, cost);
33  ✔  12             }
34            
35  ✔  12             return response;
36  ✔  12         }
37            
38                public override async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
39                    IEnumerable<ChatMessage> chatMessages,
40                    ChatOptions? options = null,
41                    [EnumeratorCancellation] CancellationToken cancellationToken = default)
42  ✔   5         {
43  ✔  41  ●          await foreach (var update in base.GetStreamingResponseAsync(chatMessages, options, cancellationToken))
44  ✔  13             {
45  ✔  13                 yield return update;
46  ✔  13             }
47  ✔   4         }
48            
49                private decimal CalculateCost(string model, long inputTokens, long outputTokens)
50  ✔  12         {
51  ✔  12             decimal inputRate = 0;
52  ✔  12             decimal outputRate = 0;
53            
54  ✔  12             string lowerModel = model.ToLowerInvariant();
55            
56  ✓  12  ◑          if (lowerModel.Contains("llama") || lowerModel.Contains("mixtral") || lowerModel.Contains("gemma"))
57  ✔   1             {
58  ✔   1                 inputRate = 0.70m / 1_000_000m;
59  ✔   1                 outputRate = 0.80m / 1_000_000m;
60  ✔   1             }
61  ✓  11  ◑          else if (lowerModel.Contains("gemini"))
62  ❌  0             {
63  ❌  0                 inputRate = 0.075m / 1_000_000m;
64  ❌  0                 outputRate = 0.30m / 1_000_000m;
65  ❌  0             }
66            
67  ✔  12             return (inputTokens * inputRate) + (outputTokens * outputRate);
68  ✔  12         }
69            }
```
# Synaxis.InferenceGateway.Application.Configuration.AliasConfig

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Configuration.AliasConfig |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/SynaxisConfiguration.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 49 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Candidates()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/SynaxisConfiguration.cs
```
 1              using System.Collections.Generic;
 2              
 3              namespace Synaxis.InferenceGateway.Application.Configuration;
 4              
 5              public class SynaxisConfiguration
 6              {
 7                  public Dictionary<string, ProviderConfig> Providers { get; set; } = new();
 8                  public List<CanonicalModelConfig> CanonicalModels { get; set; } = new();
 9                  public Dictionary<string, AliasConfig> Aliases { get; set; } = new();
10                  public string? MasterKey { get; set; }
11                  public string? JwtSecret { get; set; }
12                  public string? JwtIssuer { get; set; }
13                  public string? JwtAudience { get; set; }
14                  public AntigravitySettings? Antigravity { get; set; }
15                  // Maximum allowed request body size (bytes) for parsing incoming OpenAI-compatible requests.
16                  // Default set to 30 MB (31457280 bytes).
17                  public long MaxRequestBodySize { get; set; } = 31457280;
18              }
19              
20              public class ProviderConfig
21              {
22                  public bool Enabled { get; set; } = true;
23                  public string? Key { get; set; }
24                  public string? AccountId { get; set; } // For Cloudflare
25                  public string? ProjectId { get; set; } // For Antigravity
26                  public string? AuthStoragePath { get; set; } // For Antigravity (optional)
27                  public int Tier { get; set; }
28                  public List<string> Models { get; set; } = new();
29                  public string Type { get; set; } = string.Empty; // "OpenAI", "Groq", "Cohere", "Cloudflare", etc.
30                  public string? Endpoint { get; set; } // Optional override
31                  public string? FallbackEndpoint { get; set; } // Optional fallback
32              }
33              
34              public class CanonicalModelConfig
35              {
36                  public string Id { get; set; } = string.Empty;
37                  public string Provider { get; set; } = string.Empty;
38                  public string ModelPath { get; set; } = string.Empty;
39                  public bool Streaming { get; set; }
40                  public bool Tools { get; set; }
41                  public bool Vision { get; set; }
42                  public bool StructuredOutput { get; set; }
43                  public bool LogProbs { get; set; }
44              }
45              
46              public class AliasConfig
47              {
48  ✔  5808         public List<string> Candidates { get; set; } = new();
49              }
```
# Synaxis.InferenceGateway.Application.Configuration.AntigravitySettings

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Configuration.AntigravitySettings |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/AntigravitySettings.cs |
| **Line coverage:** | 100% (2 of 2) |
| Covered lines: | 2 |
| Uncovered lines: | 0 |
| Coverable lines: | 2 |
| Total lines: | 7 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_ClientId()** | 100% | 1 | 1 | 100% |
| **get_ClientSecret()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/AntigravitySettings.cs
```
1            namespace Synaxis.InferenceGateway.Application.Configuration;
2            
3            public class AntigravitySettings
4            {
5  ✔  44         public string ClientId { get; set; } = string.Empty;
6  ✔  44         public string ClientSecret { get; set; } = string.Empty;
7            }
```
# Synaxis.InferenceGateway.Application.Configuration.CanonicalModelConfig

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Configuration.CanonicalModelConfig |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/SynaxisConfiguration.cs |
| **Line coverage:** | 100% (8 of 8) |
| Covered lines: | 8 |
| Uncovered lines: | 0 |
| Coverable lines: | 8 |
| Total lines: | 49 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Provider()** | 100% | 1 | 1 | 100% |
| **get_ModelPath()** | 100% | 1 | 1 | 100% |
| **get_Streaming()** | 100% | 1 | 1 | 100% |
| **get_Tools()** | 100% | 1 | 1 | 100% |
| **get_Vision()** | 100% | 1 | 1 | 100% |
| **get_StructuredOutput()** | 100% | 1 | 1 | 100% |
| **get_LogProbs()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/SynaxisConfiguration.cs
```
 1               using System.Collections.Generic;
 2               
 3               namespace Synaxis.InferenceGateway.Application.Configuration;
 4               
 5               public class SynaxisConfiguration
 6               {
 7                   public Dictionary<string, ProviderConfig> Providers { get; set; } = new();
 8                   public List<CanonicalModelConfig> CanonicalModels { get; set; } = new();
 9                   public Dictionary<string, AliasConfig> Aliases { get; set; } = new();
10                   public string? MasterKey { get; set; }
11                   public string? JwtSecret { get; set; }
12                   public string? JwtIssuer { get; set; }
13                   public string? JwtAudience { get; set; }
14                   public AntigravitySettings? Antigravity { get; set; }
15                   // Maximum allowed request body size (bytes) for parsing incoming OpenAI-compatible requests.
16                   // Default set to 30 MB (31457280 bytes).
17                   public long MaxRequestBodySize { get; set; } = 31457280;
18               }
19               
20               public class ProviderConfig
21               {
22                   public bool Enabled { get; set; } = true;
23                   public string? Key { get; set; }
24                   public string? AccountId { get; set; } // For Cloudflare
25                   public string? ProjectId { get; set; } // For Antigravity
26                   public string? AuthStoragePath { get; set; } // For Antigravity (optional)
27                   public int Tier { get; set; }
28                   public List<string> Models { get; set; } = new();
29                   public string Type { get; set; } = string.Empty; // "OpenAI", "Groq", "Cohere", "Cloudflare", etc.
30                   public string? Endpoint { get; set; } // Optional override
31                   public string? FallbackEndpoint { get; set; } // Optional fallback
32               }
33               
34               public class CanonicalModelConfig
35               {
36  ✔  10103         public string Id { get; set; } = string.Empty;
37  ✔  15502         public string Provider { get; set; } = string.Empty;
38  ✔   8494         public string ModelPath { get; set; } = string.Empty;
39  ✔   6716         public bool Streaming { get; set; }
40  ✔   6705         public bool Tools { get; set; }
41  ✔   6703         public bool Vision { get; set; }
42  ✔   6703         public bool StructuredOutput { get; set; }
43  ✔   6703         public bool LogProbs { get; set; }
44               }
45               
46               public class AliasConfig
47               {
48                   public List<string> Candidates { get; set; } = new();
49               }
```
# Synaxis.InferenceGateway.Application.Configuration.ProviderConfig

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Configuration.ProviderConfig |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/SynaxisConfiguration.cs |
| **Line coverage:** | 100% (10 of 10) |
| Covered lines: | 10 |
| Uncovered lines: | 0 |
| Coverable lines: | 10 |
| Total lines: | 49 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Enabled()** | 100% | 1 | 1 | 100% |
| **get_Key()** | 100% | 1 | 1 | 100% |
| **get_AccountId()** | 100% | 1 | 1 | 100% |
| **get_ProjectId()** | 100% | 1 | 1 | 100% |
| **get_AuthStoragePath()** | 100% | 1 | 1 | 100% |
| **get_Tier()** | 100% | 1 | 1 | 100% |
| **get_Models()** | 100% | 1 | 1 | 100% |
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_Endpoint()** | 100% | 1 | 1 | 100% |
| **get_FallbackEndpoint()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/SynaxisConfiguration.cs
```
 1               using System.Collections.Generic;
 2               
 3               namespace Synaxis.InferenceGateway.Application.Configuration;
 4               
 5               public class SynaxisConfiguration
 6               {
 7                   public Dictionary<string, ProviderConfig> Providers { get; set; } = new();
 8                   public List<CanonicalModelConfig> CanonicalModels { get; set; } = new();
 9                   public Dictionary<string, AliasConfig> Aliases { get; set; } = new();
10                   public string? MasterKey { get; set; }
11                   public string? JwtSecret { get; set; }
12                   public string? JwtIssuer { get; set; }
13                   public string? JwtAudience { get; set; }
14                   public AntigravitySettings? Antigravity { get; set; }
15                   // Maximum allowed request body size (bytes) for parsing incoming OpenAI-compatible requests.
16                   // Default set to 30 MB (31457280 bytes).
17                   public long MaxRequestBodySize { get; set; } = 31457280;
18               }
19               
20               public class ProviderConfig
21               {
22  ✔   5286         public bool Enabled { get; set; } = true;
23  ✔  15855         public string? Key { get; set; }
24  ✔   2658         public string? AccountId { get; set; } // For Cloudflare
25  ✔   2732         public string? ProjectId { get; set; } // For Antigravity
26  ✔   2732         public string? AuthStoragePath { get; set; } // For Antigravity (optional)
27  ✔   2777         public int Tier { get; set; }
28  ✔   5269         public List<string> Models { get; set; } = new();
29  ✔   6286         public string Type { get; set; } = string.Empty; // "OpenAI", "Groq", "Cohere", "Cloudflare", etc.
30  ✔   3425         public string? Endpoint { get; set; } // Optional override
31  ✔   3220         public string? FallbackEndpoint { get; set; } // Optional fallback
32               }
33               
34               public class CanonicalModelConfig
35               {
36                   public string Id { get; set; } = string.Empty;
37                   public string Provider { get; set; } = string.Empty;
38                   public string ModelPath { get; set; } = string.Empty;
39                   public bool Streaming { get; set; }
40                   public bool Tools { get; set; }
41                   public bool Vision { get; set; }
42                   public bool StructuredOutput { get; set; }
43                   public bool LogProbs { get; set; }
44               }
45               
46               public class AliasConfig
47               {
48                   public List<string> Candidates { get; set; } = new();
49               }
```
# Synaxis.InferenceGateway.Application.Configuration.SynaxisConfiguration

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Configuration.SynaxisConfiguration |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/SynaxisConfiguration.cs |
| **Line coverage:** | 100% (9 of 9) |
| Covered lines: | 9 |
| Uncovered lines: | 0 |
| Coverable lines: | 9 |
| Total lines: | 49 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Providers()** | 100% | 1 | 1 | 100% |
| **get_CanonicalModels()** | 100% | 1 | 1 | 100% |
| **get_Aliases()** | 100% | 1 | 1 | 100% |
| **get_MasterKey()** | 100% | 1 | 1 | 100% |
| **get_JwtSecret()** | 100% | 1 | 1 | 100% |
| **get_JwtIssuer()** | 100% | 1 | 1 | 100% |
| **get_JwtAudience()** | 100% | 1 | 1 | 100% |
| **get_Antigravity()** | 100% | 1 | 1 | 100% |
| **get_MaxRequestBodySize()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Configuration/SynaxisConfiguration.cs
```
 1              using System.Collections.Generic;
 2              
 3              namespace Synaxis.InferenceGateway.Application.Configuration;
 4              
 5              public class SynaxisConfiguration
 6              {
 7  ✔  5529         public Dictionary<string, ProviderConfig> Providers { get; set; } = new();
 8  ✔  1975         public List<CanonicalModelConfig> CanonicalModels { get; set; } = new();
 9  ✔  1801         public Dictionary<string, AliasConfig> Aliases { get; set; } = new();
10  ✔    92         public string? MasterKey { get; set; }
11  ✔   164         public string? JwtSecret { get; set; }
12  ✔   236         public string? JwtIssuer { get; set; }
13  ✔   236         public string? JwtAudience { get; set; }
14  ✔   203         public AntigravitySettings? Antigravity { get; set; }
15                  // Maximum allowed request body size (bytes) for parsing incoming OpenAI-compatible requests.
16                  // Default set to 30 MB (31457280 bytes).
17  ✔   285         public long MaxRequestBodySize { get; set; } = 31457280;
18              }
19              
20              public class ProviderConfig
21              {
22                  public bool Enabled { get; set; } = true;
23                  public string? Key { get; set; }
24                  public string? AccountId { get; set; } // For Cloudflare
25                  public string? ProjectId { get; set; } // For Antigravity
26                  public string? AuthStoragePath { get; set; } // For Antigravity (optional)
27                  public int Tier { get; set; }
28                  public List<string> Models { get; set; } = new();
29                  public string Type { get; set; } = string.Empty; // "OpenAI", "Groq", "Cohere", "Cloudflare", etc.
30                  public string? Endpoint { get; set; } // Optional override
31                  public string? FallbackEndpoint { get; set; } // Optional fallback
32              }
33              
34              public class CanonicalModelConfig
35              {
36                  public string Id { get; set; } = string.Empty;
37                  public string Provider { get; set; } = string.Empty;
38                  public string ModelPath { get; set; } = string.Empty;
39                  public bool Streaming { get; set; }
40                  public bool Tools { get; set; }
41                  public bool Vision { get; set; }
42                  public bool StructuredOutput { get; set; }
43                  public bool LogProbs { get; set; }
44              }
45              
46              public class AliasConfig
47              {
48                  public List<string> Candidates { get; set; } = new();
49              }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.ApiKey

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.ApiKey |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ApiKey.cs |
| **Line coverage:** | 100% (7 of 7) |
| Covered lines: | 7 |
| Uncovered lines: | 0 |
| Coverable lines: | 7 |
| Total lines: | 13 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_ProjectId()** | 100% | 1 | 1 | 100% |
| **get_KeyHash()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Project()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ApiKey.cs
```
 1            namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2            
 3            public sealed class ApiKey
 4            {
 5  ✔  26         public Guid Id { get; set; }
 6  ✔  13         public Guid ProjectId { get; set; }
 7  ✔  30         public string KeyHash { get; set; } = string.Empty;
 8  ✔  32         public string Name { get; set; } = string.Empty;
 9  ✔  15         public ApiKeyStatus Status { get; set; }
10  ✔  27         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
11            
12  ✔   3         public Project? Project { get; set; }
13            }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.AuditLog

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.AuditLog |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/AuditLog.cs |
| **Line coverage:** | 75% (6 of 8) |
| Covered lines: | 6 |
| Uncovered lines: | 2 |
| Coverable lines: | 8 |
| Total lines: | 14 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_UserId()** | 100% | 1 | 1 | 100% |
| **get_Action()** | 100% | 1 | 1 | 100% |
| **get_PayloadJson()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |
| **get_User()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/AuditLog.cs
```
 1            namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2            
 3            public sealed class AuditLog
 4            {
 5  ✔  26         public Guid Id { get; set; }
 6  ✔  31         public Guid TenantId { get; set; }
 7  ✔  29         public Guid? UserId { get; set; }
 8  ✔  58         public string Action { get; set; } = string.Empty;
 9  ✔  48         public string? PayloadJson { get; set; }
10  ✔  58         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
11            
12  ❌  0         public Tenant? Tenant { get; set; }
13  ❌  0         public User? User { get; set; }
14            }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.DeviationEntry

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.DeviationEntry |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/DeviationEntry.cs |
| **Line coverage:** | 88.8% (8 of 9) |
| Covered lines: | 8 |
| Uncovered lines: | 1 |
| Coverable lines: | 9 |
| Total lines: | 15 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_Endpoint()** | 100% | 1 | 1 | 100% |
| **get_Field()** | 100% | 1 | 1 | 100% |
| **get_Reason()** | 100% | 1 | 1 | 100% |
| **get_Mitigation()** | 100% | 1 | 1 | 100% |
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/DeviationEntry.cs
```
 1            namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2            
 3            public sealed class DeviationEntry
 4            {
 5  ✔   7         public Guid Id { get; set; }
 6  ✔   4         public Guid TenantId { get; set; }
 7  ✔  10         public string Endpoint { get; set; } = string.Empty;
 8  ✔   9         public string Field { get; set; } = string.Empty;
 9  ✔   9         public string Reason { get; set; } = string.Empty;
10  ✔   9         public string Mitigation { get; set; } = string.Empty;
11  ✔   6         public DeviationStatus Status { get; set; }
12  ✔   7         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
13            
14  ❌  0         public Tenant? Tenant { get; set; }
15            }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/GlobalModel.cs |
| **Line coverage:** | 100% (16 of 16) |
| Covered lines: | 16 |
| Uncovered lines: | 0 |
| Coverable lines: | 16 |
| Total lines: | 34 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Family()** | 100% | 1 | 1 | 100% |
| **get_Description()** | 100% | 1 | 1 | 100% |
| **get_ReleaseDate()** | 100% | 1 | 1 | 100% |
| **get_ContextWindow()** | 100% | 1 | 1 | 100% |
| **get_MaxOutputTokens()** | 100% | 1 | 1 | 100% |
| **get_InputPrice()** | 100% | 1 | 1 | 100% |
| **get_OutputPrice()** | 100% | 1 | 1 | 100% |
| **get_IsOpenWeights()** | 100% | 1 | 1 | 100% |
| **get_SupportsTools()** | 100% | 1 | 1 | 100% |
| **get_SupportsReasoning()** | 100% | 1 | 1 | 100% |
| **get_SupportsVision()** | 100% | 1 | 1 | 100% |
| **get_SupportsAudio()** | 100% | 1 | 1 | 100% |
| **get_SupportsStructuredOutput()** | 100% | 1 | 1 | 100% |
| **get_ProviderModels()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/GlobalModel.cs
```
 1               using System;
 2               using System.Collections.Generic;
 3               using System.ComponentModel.DataAnnotations;
 4               
 5               namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 6               
 7               public sealed class GlobalModel
 8               {
 9                   [Key]
10  ✔  28764         public string Id { get; set; } = string.Empty; // canonical id e.g. "llama-3.3-70b"
11               
12  ✔  31134         public string Name { get; set; } = string.Empty;
13  ✔  31134         public string Family { get; set; } = string.Empty;
14  ✔      2         public string? Description { get; set; }
15  ✔  16045         public DateTime? ReleaseDate { get; set; }
16               
17  ✔  30160         public int ContextWindow { get; set; } = 0;
18  ✔  30160         public int MaxOutputTokens { get; set; } = 0;
19               
20  ✔  17457         public decimal InputPrice { get; set; }
21  ✔  17457         public decimal OutputPrice { get; set; }
22               
23  ✔  16045         public bool IsOpenWeights { get; set; }
24               
25                   // Capabilities
26  ✔  16047         public bool SupportsTools { get; set; }
27  ✔  16046         public bool SupportsReasoning { get; set; }
28  ✔  16047         public bool SupportsVision { get; set; }
29  ✔  16046         public bool SupportsAudio { get; set; }
30  ✔  28847         public bool SupportsStructuredOutput { get; set; }
31               
32                   // Navigation
33  ✔  14126         public List<ProviderModel> ProviderModels { get; set; } = new();
34               }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelAlias

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelAlias |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ModelAlias.cs |
| **Line coverage:** | 80% (4 of 5) |
| Covered lines: | 4 |
| Uncovered lines: | 1 |
| Coverable lines: | 5 |
| Total lines: | 11 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_Alias()** | 100% | 1 | 1 | 100% |
| **get_TargetModel()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ModelAlias.cs
```
 1           namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2           
 3           public sealed class ModelAlias
 4           {
 5  ✔  2         public Guid Id { get; set; }
 6  ✔  2         public Guid TenantId { get; set; }
 7  ✔  5         public string Alias { get; set; } = string.Empty;
 8  ✔  9         public string TargetModel { get; set; } = string.Empty;
 9           
10  ❌ 0         public Tenant? Tenant { get; set; }
11           }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCombo

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCombo |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ModelCombo.cs |
| **Line coverage:** | 80% (4 of 5) |
| Covered lines: | 4 |
| Uncovered lines: | 1 |
| Coverable lines: | 5 |
| Total lines: | 11 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_OrderedModelsJson()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ModelCombo.cs
```
 1            namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2            
 3            public sealed class ModelCombo
 4            {
 5  ✔   2         public Guid Id { get; set; }
 6  ✔   2         public Guid TenantId { get; set; }
 7  ✔   6         public string Name { get; set; } = string.Empty;
 8  ✔  12         public string OrderedModelsJson { get; set; } = "[]";
 9            
10  ❌  0         public Tenant? Tenant { get; set; }
11            }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCost

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCost |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ModelCost.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 9 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Provider()** | 100% | 1 | 1 | 100% |
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_CostPerToken()** | 100% | 1 | 1 | 100% |
| **get_FreeTier()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ModelCost.cs
```
1              namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
2              
3              public sealed class ModelCost
4              {
5  ✔  1762         public string Provider { get; set; } = string.Empty;
6  ✔  1761         public string Model { get; set; } = string.Empty;
7  ✔   167         public decimal CostPerToken { get; set; }
8  ✔   149         public bool FreeTier { get; set; }
9              }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.OAuthAccount

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.OAuthAccount |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/OAuthAccount.cs |
| **Line coverage:** | 88.8% (8 of 9) |
| Covered lines: | 8 |
| Uncovered lines: | 1 |
| Coverable lines: | 9 |
| Total lines: | 15 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_Provider()** | 100% | 1 | 1 | 100% |
| **get_AccessTokenEncrypted()** | 100% | 1 | 1 | 100% |
| **get_RefreshTokenEncrypted()** | 100% | 1 | 1 | 100% |
| **get_ExpiresAt()** | 100% | 1 | 1 | 100% |
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/OAuthAccount.cs
```
 1           namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2           
 3           public sealed class OAuthAccount
 4           {
 5  ✔  2         public Guid Id { get; set; }
 6  ✔  2         public Guid TenantId { get; set; }
 7  ✔  5         public string Provider { get; set; } = string.Empty;
 8  ✔  7         public byte[] AccessTokenEncrypted { get; set; } = Array.Empty<byte>();
 9  ✔  3         public byte[]? RefreshTokenEncrypted { get; set; }
10  ✔  5         public DateTimeOffset? ExpiresAt { get; set; }
11  ✔  2         public OAuthAccountStatus Status { get; set; }
12  ✔  5         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
13           
14  ❌ 0         public Tenant? Tenant { get; set; }
15           }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/Project.cs |
| **Line coverage:** | 87.5% (7 of 8) |
| Covered lines: | 7 |
| Uncovered lines: | 1 |
| Coverable lines: | 8 |
| Total lines: | 14 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |
| **get_ApiKeys()** | 100% | 1 | 1 | 100% |
| **get_Users()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/Project.cs
```
 1            namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2            
 3            public sealed class Project
 4            {
 5  ✔  27         public Guid Id { get; set; }
 6  ✔  12         public Guid TenantId { get; set; }
 7  ✔  30         public string Name { get; set; } = string.Empty;
 8  ✔  12         public ProjectStatus Status { get; set; }
 9  ✔  30         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
10            
11  ❌  0         public Tenant? Tenant { get; set; }
12  ✔  18         public ICollection<ApiKey> ApiKeys { get; } = new List<ApiKey>();
13  ✔  18         public ICollection<User> Users { get; } = new List<User>();
14            }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderAccount

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderAccount |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ProviderAccount.cs |
| **Line coverage:** | 85.7% (6 of 7) |
| Covered lines: | 6 |
| Uncovered lines: | 1 |
| Coverable lines: | 7 |
| Total lines: | 13 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_Provider()** | 100% | 1 | 1 | 100% |
| **get_AccountId()** | 100% | 1 | 1 | 100% |
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ProviderAccount.cs
```
 1           namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2           
 3           public sealed class ProviderAccount
 4           {
 5  ✔  2         public Guid Id { get; set; }
 6  ✔  2         public Guid TenantId { get; set; }
 7  ✔  3         public string Provider { get; set; } = string.Empty;
 8  ✔  3         public string AccountId { get; set; } = string.Empty;
 9  ✔  2         public ProviderAccountStatus Status { get; set; }
10  ✔  3         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
11           
12  ❌ 0         public Tenant? Tenant { get; set; }
13           }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderModel

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderModel |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ProviderModel.cs |
| **Line coverage:** | 90% (9 of 10) |
| Covered lines: | 9 |
| Uncovered lines: | 1 |
| Coverable lines: | 10 |
| Total lines: | 28 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_ProviderId()** | 100% | 1 | 1 | 100% |
| **get_GlobalModelId()** | 100% | 1 | 1 | 100% |
| **get_ProviderSpecificId()** | 100% | 1 | 1 | 100% |
| **get_IsAvailable()** | 100% | 1 | 1 | 100% |
| **get_OverrideInputPrice()** | 100% | 1 | 1 | 100% |
| **get_OverrideOutputPrice()** | 100% | 1 | 1 | 100% |
| **get_RateLimitRPM()** | 100% | 1 | 1 | 100% |
| **get_RateLimitTPM()** | 100% | 1 | 1 | 100% |
| **get_GlobalModel()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/ProviderModel.cs
```
 1              using System.ComponentModel.DataAnnotations;
 2              using System.ComponentModel.DataAnnotations.Schema;
 3              
 4              namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 5              
 6              public sealed class ProviderModel
 7              {
 8                  [Key]
 9  ✔     2         public int Id { get; set; }
10              
11  ✔  4575         public string ProviderId { get; set; } = string.Empty; // e.g. "nvidia"
12              
13                  // FK to GlobalModel
14  ✔  6091         public string GlobalModelId { get; set; } = string.Empty;
15  ✔  4568         public string ProviderSpecificId { get; set; } = string.Empty; // ID sent to the provider API
16              
17  ✔  3047         public bool IsAvailable { get; set; }
18              
19  ✔     2         public decimal? OverrideInputPrice { get; set; }
20  ✔     2         public decimal? OverrideOutputPrice { get; set; }
21              
22  ✔     2         public int? RateLimitRPM { get; set; }
23  ✔     2         public int? RateLimitTPM { get; set; }
24              
25                  // Navigation
26                  [ForeignKey("GlobalModelId")]
27  ❌    0         public GlobalModel? GlobalModel { get; set; }
28              }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.QuotaSnapshot

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.QuotaSnapshot |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/QuotaSnapshot.cs |
| **Line coverage:** | 100% (5 of 5) |
| Covered lines: | 5 |
| Uncovered lines: | 0 |
| Coverable lines: | 5 |
| Total lines: | 10 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Provider()** | 100% | 1 | 1 | 100% |
| **get_AccountId()** | 100% | 1 | 1 | 100% |
| **get_QuotaJson()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/QuotaSnapshot.cs
```
 1           namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2           
 3           public sealed class QuotaSnapshot
 4           {
 5  ✔  2         public Guid Id { get; set; }
 6  ✔  3         public string Provider { get; set; } = string.Empty;
 7  ✔  3         public string AccountId { get; set; } = string.Empty;
 8  ✔  3         public string QuotaJson { get; set; } = "{}";
 9  ✔  3         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
10           }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.RequestLog

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.RequestLog |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/RequestLog.cs |
| **Line coverage:** | 78.5% (11 of 14) |
| Covered lines: | 11 |
| Uncovered lines: | 3 |
| Coverable lines: | 14 |
| Total lines: | 20 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_RequestId()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_ProjectId()** | 100% | 1 | 1 | 100% |
| **get_UserId()** | 100% | 1 | 1 | 100% |
| **get_Endpoint()** | 100% | 1 | 1 | 100% |
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_Provider()** | 100% | 1 | 1 | 100% |
| **get_LatencyMs()** | 100% | 1 | 1 | 100% |
| **get_StatusCode()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |
| **get_Project()** | 100% | 2 | 1 | 0% |
| **get_User()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/RequestLog.cs
```
 1           namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2           
 3           public sealed class RequestLog
 4           {
 5  ✔  2         public Guid Id { get; set; }
 6  ✔  3         public string RequestId { get; set; } = string.Empty;
 7  ✔  2         public Guid TenantId { get; set; }
 8  ✔  2         public Guid ProjectId { get; set; }
 9  ✔  2         public Guid? UserId { get; set; }
10  ✔  3         public string Endpoint { get; set; } = string.Empty;
11  ✔  2         public string? Model { get; set; }
12  ✔  2         public string? Provider { get; set; }
13  ✔  2         public int? LatencyMs { get; set; }
14  ✔  2         public int? StatusCode { get; set; }
15  ✔  3         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
16           
17  ❌ 0         public Tenant? Tenant { get; set; }
18  ❌ 0         public Project? Project { get; set; }
19  ❌ 0         public User? User { get; set; }
20           }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.RoutingPolicy

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.RoutingPolicy |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/RoutingPolicy.cs |
| **Line coverage:** | 0% (0 of 6) |
| Covered lines: | 0 |
| Uncovered lines: | 6 |
| Coverable lines: | 6 |
| Total lines: | 12 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_TenantId()** | 100% | 2 | 1 | 0% |
| **get_PolicyJson()** | 100% | 2 | 1 | 0% |
| **get_Version()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/RoutingPolicy.cs
```
 1           namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2           
 3           public sealed class RoutingPolicy
 4           {
 5  ❌ 0         public Guid Id { get; set; }
 6  ❌ 0         public Guid TenantId { get; set; }
 7  ❌ 0         public string PolicyJson { get; set; } = "{}";
 8  ❌ 0         public int Version { get; set; }
 9  ❌ 0         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
10           
11  ❌ 0         public Tenant? Tenant { get; set; }
12           }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/Tenant.cs |
| **Line coverage:** | 90% (9 of 10) |
| Covered lines: | 9 |
| Uncovered lines: | 1 |
| Coverable lines: | 10 |
| Total lines: | 16 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Region()** | 100% | 1 | 1 | 100% |
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_ByokKeyId()** | 100% | 2 | 1 | 0% |
| **get_EncryptedByokKey()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Projects()** | 100% | 1 | 1 | 100% |
| **get_Users()** | 100% | 1 | 1 | 100% |
| **get_OAuthAccounts()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/Tenant.cs
```
 1            namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2            
 3            public sealed class Tenant
 4            {
 5  ✔  42         public Guid Id { get; set; }
 6  ✔  41         public string Name { get; set; } = string.Empty;
 7  ✔  19         public TenantRegion Region { get; set; }
 8  ✔  19         public TenantStatus Status { get; set; }
 9  ❌  0         public Guid? ByokKeyId { get; set; }
10  ✔  22         public byte[] EncryptedByokKey { get; set; } = Array.Empty<byte>();
11  ✔  24         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
12            
13  ✔  22         public ICollection<Project> Projects { get; } = new List<Project>();
14  ✔  22         public ICollection<User> Users { get; } = new List<User>();
15  ✔  22         public ICollection<OAuthAccount> OAuthAccounts { get; } = new List<OAuthAccount>();
16            }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.TenantModelLimit

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.TenantModelLimit |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/TenantModelLimit.cs |
| **Line coverage:** | 83.3% (5 of 6) |
| Covered lines: | 5 |
| Uncovered lines: | 1 |
| Coverable lines: | 6 |
| Total lines: | 21 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_GlobalModelId()** | 100% | 1 | 1 | 100% |
| **get_AllowedRPM()** | 100% | 1 | 1 | 100% |
| **get_MonthlyBudget()** | 100% | 1 | 1 | 100% |
| **get_GlobalModel()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/TenantModelLimit.cs
```
 1           using System.ComponentModel.DataAnnotations;
 2           using System.ComponentModel.DataAnnotations.Schema;
 3           
 4           namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 5           
 6           public sealed class TenantModelLimit
 7           {
 8               [Key]
 9  ✔  2         public int Id { get; set; }
10           
11  ✔  3         public string TenantId { get; set; } = string.Empty;
12           
13               // FK to GlobalModel
14  ✔  3         public string GlobalModelId { get; set; } = string.Empty;
15           
16  ✔  2         public int? AllowedRPM { get; set; }
17  ✔  2         public decimal? MonthlyBudget { get; set; }
18           
19               [ForeignKey("GlobalModelId")]
20  ❌ 0         public GlobalModel? GlobalModel { get; set; }
21           }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.TokenUsage

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.TokenUsage |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/TokenUsage.cs |
| **Line coverage:** | 75% (9 of 12) |
| Covered lines: | 9 |
| Uncovered lines: | 3 |
| Coverable lines: | 12 |
| Total lines: | 18 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_RequestId()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_ProjectId()** | 100% | 1 | 1 | 100% |
| **get_UserId()** | 100% | 1 | 1 | 100% |
| **get_InputTokens()** | 100% | 1 | 1 | 100% |
| **get_OutputTokens()** | 100% | 1 | 1 | 100% |
| **get_CostEstimate()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |
| **get_Project()** | 100% | 2 | 1 | 0% |
| **get_User()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/TokenUsage.cs
```
 1           namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2           
 3           public sealed class TokenUsage
 4           {
 5  ✔  2         public Guid Id { get; set; }
 6  ✔  3         public string RequestId { get; set; } = string.Empty;
 7  ✔  2         public Guid TenantId { get; set; }
 8  ✔  2         public Guid ProjectId { get; set; }
 9  ✔  2         public Guid? UserId { get; set; }
10  ✔  2         public int InputTokens { get; set; }
11  ✔  2         public int OutputTokens { get; set; }
12  ✔  2         public decimal CostEstimate { get; set; }
13  ✔  3         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
14           
15  ❌ 0         public Tenant? Tenant { get; set; }
16  ❌ 0         public Project? Project { get; set; }
17  ❌ 0         public User? User { get; set; }
18           }
```
# Synaxis.InferenceGateway.Application.ControlPlane.Entities.User

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ControlPlane.Entities.User |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/User.cs |
| **Line coverage:** | 88.8% (8 of 9) |
| Covered lines: | 8 |
| Uncovered lines: | 1 |
| Coverable lines: | 9 |
| Total lines: | 15 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_TenantId()** | 100% | 1 | 1 | 100% |
| **get_Email()** | 100% | 1 | 1 | 100% |
| **get_Role()** | 100% | 1 | 1 | 100% |
| **get_AuthProvider()** | 100% | 1 | 1 | 100% |
| **get_ProviderUserId()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Tenant()** | 100% | 2 | 1 | 0% |
| **get_Projects()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ControlPlane/Entities/User.cs
```
 1             namespace Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 2             
 3             public sealed class User
 4             {
 5  ✔   94         public Guid Id { get; set; }
 6  ✔  107         public Guid TenantId { get; set; }
 7  ✔  174         public string Email { get; set; } = string.Empty;
 8  ✔   92         public UserRole Role { get; set; }
 9  ✔   99         public string AuthProvider { get; set; } = string.Empty;
10  ✔   99         public string ProviderUserId { get; set; } = string.Empty;
11  ✔   81         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
12             
13  ❌   0         public Tenant? Tenant { get; set; }
14  ✔   81         public ICollection<Project> Projects { get; } = new List<Project>();
15             }
```
# Synaxis.InferenceGateway.Application.Extensions.ApplicationExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Extensions.ApplicationExtensions |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Extensions/ApplicationExtensions.cs |
| **Line coverage:** | 100% (12 of 12) |
| Covered lines: | 12 |
| Uncovered lines: | 0 |
| Coverable lines: | 12 |
| Total lines: | 29 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddSynaxisApplication(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Extensions/ApplicationExtensions.cs
```
 1            using Microsoft.Extensions.Configuration;
 2            using Microsoft.Extensions.DependencyInjection;
 3            using Synaxis.InferenceGateway.Application.Configuration;
 4            using Synaxis.InferenceGateway.Application.Routing;
 5            using Synaxis.InferenceGateway.Application.Translation;
 6            
 7            namespace Synaxis.InferenceGateway.Application.Extensions;
 8            
 9            public static class ApplicationExtensions
10            {
11                public static IServiceCollection AddSynaxisApplication(this IServiceCollection services, IConfiguration configuratio
12  ✔  37         {
13                    // 1. Register Configuration
14  ✔  37             services.Configure<SynaxisConfiguration>(configuration.GetSection("Synaxis:InferenceGateway"));
15            
16                    // 2. Register Registry
17  ✔  37             services.AddSingleton<IProviderRegistry, ProviderRegistry>();
18  ✔  37             services.AddScoped<IModelResolver, ModelResolver>();
19  ✔  37             services.AddScoped<ISmartRouter, SmartRouter>();
20            
21  ✔  37             services.AddSingleton<ITranslationPipeline, TranslationPipeline>();
22  ✔  37             services.AddSingleton<IToolNormalizer, OpenAIToolNormalizer>();
23  ✔  37             services.AddSingleton<IRequestTranslator, NoOpRequestTranslator>();
24  ✔  37             services.AddSingleton<IResponseTranslator, NoOpResponseTranslator>();
25  ✔  37             services.AddSingleton<IStreamingTranslator, NoOpStreamingTranslator>();
26            
27  ✔  37             return services;
28  ✔  37         }
29            }
```
# Synaxis.InferenceGateway.Application.ProviderRegistry

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.ProviderRegistry |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ProviderRegistry.cs |
| **Line coverage:** | 96.9% (32 of 33) |
| Covered lines: | 32 |
| Uncovered lines: | 1 |
| Coverable lines: | 33 |
| Total lines: | 67 |
| **Branch coverage:** | 76.4% (26 of 34) |
| Covered branches: | 26 |
| Total branches: | 34 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 4 | 4 | 100% |
| **GetCandidates(...)** | 66.66% | 18 | 18 | 94.44% |
| **GetProvider(...)** | 83.33% | 12 | 12 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/ProviderRegistry.cs
```
 1             using Microsoft.Extensions.Options;
 2             using Synaxis.InferenceGateway.Application.Configuration;
 3             using System;
 4             using System.Collections.Generic;
 5             using System.Linq;
 6             
 7             namespace Synaxis.InferenceGateway.Application;
 8             
 9             public interface IProviderRegistry
10             {
11                 IEnumerable<(string ServiceKey, int Tier)> GetCandidates(string modelId);
12                 ProviderConfig? GetProvider(string serviceKey);
13             }
14             
15             public class ProviderRegistry : IProviderRegistry
16             {
17                 private readonly SynaxisConfiguration _config;
18             
19  ✔   19         public ProviderRegistry(IOptions<SynaxisConfiguration> config)
20  ✔   19         {
21  ✔   19  ●          _config = config?.Value ?? throw new ArgumentNullException(nameof(config));
22  ✔   18         }
23             
24                 public IEnumerable<(string ServiceKey, int Tier)> GetCandidates(string modelId)
25  ✔   10         {
26  ✔   10  ●          if (modelId == null)
27  ✔    1                 throw new ArgumentNullException(nameof(modelId));
28             
29  ✓    9  ◑          var providers = _config.Providers?
30  ✓   64  ◑              .Where(p => p.Value?.Enabled == true)
31  ✔    9                 .ToList() ?? new List<KeyValuePair<string, ProviderConfig>>();
32             
33  ✓    9  ◑          if (!providers.Any())
34  ❌   0                 return Enumerable.Empty<(string, int)>();
35             
36                     // First, try exact case-insensitive matches
37  ✔    9             var exactMatches = providers
38  ✓  196  ◑              .Where(p => p.Value.Models?.Any(m => string.Equals(m, modelId, StringComparison.OrdinalIgnoreCase)) == true)
39  ✔   15                 .Select(p => (p.Key, p.Value.Tier));
40             
41  ✔    9  ●          if (exactMatches.Any())
42  ✔    3                 return exactMatches;
43             
44                     // If no exact matches, try wildcard providers
45  ✔    6             var wildcardMatches = providers
46  ✓   48  ◑              .Where(p => p.Value.Models?.Contains("*") == true)
47  ✔   10                 .Select(p => (p.Key, p.Value.Tier));
48             
49  ✔    6             return wildcardMatches;
50  ✔    9         }
51             
52                 public ProviderConfig? GetProvider(string serviceKey)
53  ✔    6         {
54  ✔    6  ●          if (serviceKey == null)
55  ✔    1                 throw new ArgumentNullException(nameof(serviceKey));
56             
57  ✔    5  ●          if (string.IsNullOrEmpty(serviceKey))
58  ✔    1                 return null;
59             
60  ✓    4  ◑          if (_config.Providers?.TryGetValue(serviceKey, out var provider) == true && provider?.Enabled == true)
61  ✔    2             {
62  ✔    2                 provider.Key = serviceKey;
63  ✔    2                 return provider;
64                     }
65  ✔    2             return null;
66  ✔    5         }
67             }
```
# Synaxis.InferenceGateway.Application.Routing.CanonicalModelId

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Routing.CanonicalModelId |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/CanonicalModelId.cs |
| **Line coverage:** | 77.7% (7 of 9) |
| Covered lines: | 7 |
| Uncovered lines: | 2 |
| Coverable lines: | 9 |
| Total lines: | 18 |
| **Branch coverage:** | 75% (3 of 4) |
| Covered branches: | 3 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Provider()** | 100% | 1 | 1 | 100% |
| **ToString()** | 100% | 1 | 1 | 100% |
| **Parse(...)** | 75.00% | 4 | 4 | 71.42% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/CanonicalModelId.cs
```
 1               namespace Synaxis.InferenceGateway.Application.Routing;
 2               
 3  ✔  14149     public record CanonicalModelId(string Provider, string ModelPath)
 4               {
 5  ✔      9         public override string ToString() => $"{Provider}/{ModelPath}";
 6               
 7                   public static CanonicalModelId Parse(string input)
 8  ✔     71         {
 9                       // Special handling for models starting with @ (e.g. Cloudflare @cf/...)
10  ✓     71  ◑          if (input.StartsWith("@"))
11  ❌     0             {
12  ❌     0                 return new CanonicalModelId("unknown", input);
13                       }
14               
15  ✔     71             var parts = input.Split('/', 2);
16  ✔     71  ●          return parts.Length == 2 ? new CanonicalModelId(parts[0], parts[1]) : new CanonicalModelId("unknown", input);
17  ✔     71         }
18               }
```
# Synaxis.InferenceGateway.Application.Routing.EnrichedCandidate

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Routing.EnrichedCandidate |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/EnrichedCandidate.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 11 |
| **Branch coverage:** | 100% (4 of 4) |
| Covered branches: | 4 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Config()** | 100% | 1 | 1 | 100% |
| **get_Key()** | 100% | 1 | 1 | 100% |
| **get_IsFree()** | 100% | 2 | 2 | 100% |
| **get_CostPerToken()** | 100% | 2 | 2 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/EnrichedCandidate.cs
```
 1              using Synaxis.InferenceGateway.Application.Configuration;
 2              using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 3              
 4              namespace Synaxis.InferenceGateway.Application.Routing;
 5              
 6  ✔  2282     public record EnrichedCandidate(ProviderConfig Config, ModelCost? Cost, string CanonicalModelPath)
 7              {
 8  ✔   145         public string Key => Config.Key!;
 9  ✔   184  ●      public bool IsFree => Cost?.FreeTier ?? false;
10  ✔   180  ●      public decimal CostPerToken => Cost?.CostPerToken ?? decimal.MaxValue;
11              }
```
# Synaxis.InferenceGateway.Application.Routing.ModelResolver

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Routing.ModelResolver |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/ModelResolver.cs |
| **Line coverage:** | 98.1% (158 of 161) |
| Covered lines: | 158 |
| Uncovered lines: | 3 |
| Coverable lines: | 161 |
| Total lines: | 243 |
| **Branch coverage:** | 93.5% (73 of 78) |
| Covered branches: | 73 |
| Total branches: | 78 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 6 | 6 | 100% |
| **Resolve(...)** | 100% | 1 | 1 | 100% |
| **ResolveAsync()** | 92.30% | 26 | 26 | 92.53% |
| **ResolveConfigOnly(...)** | 100% | 2 | 2 | 100% |
| **ResolveCandidates(...)** | 90.90% | 44 | 44 | 98.46% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/ModelResolver.cs
```
  1              using Microsoft.Extensions.Options;
  2              using Synaxis.InferenceGateway.Application.Configuration;
  3              using System.Collections.Generic;
  4              using System.Linq;
  5              using Synaxis.InferenceGateway.Application.ControlPlane;
  6              using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
  7              using System.Text.Json;
  8              
  9              namespace Synaxis.InferenceGateway.Application.Routing;
 10              
 11              public class ModelResolver : IModelResolver
 12              {
 13                  private readonly SynaxisConfiguration _config;
 14                  private readonly IProviderRegistry _registry;
 15                  private readonly IControlPlaneStore _store;
 16              
 17  ✔    62         public ModelResolver(IOptions<SynaxisConfiguration> config, IProviderRegistry registry, IControlPlaneStore store)
 18  ✔    62         {
 19  ✔    62  ●          if (config is null)
 20  ✔     2             {
 21  ✔     2                 throw new ArgumentNullException(nameof(config));
 22                      }
 23  ✔    60  ●          if (registry is null)
 24  ✔     2             {
 25  ✔     2                 throw new ArgumentNullException(nameof(registry));
 26                      }
 27  ✔    58  ●          if (store is null)
 28  ✔     2             {
 29  ✔     2                 throw new ArgumentNullException(nameof(store));
 30                      }
 31              
 32  ✔    56             _config = config.Value;
 33  ✔    56             _registry = registry;
 34  ✔    56             _store = store;
 35  ✔    56         }
 36              
 37                  public ResolutionResult Resolve(string modelId, RequiredCapabilities? required = null)
 38  ✔    16         {
 39                      // Fallback to config-based for sync callers
 40  ✔    16             return ResolveConfigOnly(modelId, required);
 41  ✔    15         }
 42              
 43                  public async Task<ResolutionResult> ResolveAsync(string modelId, EndpointKind kind, RequiredCapabilities? required =
 44  ✔  1394         {
 45                      // Database-first: try to resolve a GlobalModel and its ProviderModels from the control plane DB
 46  ✔  1394             var global = await _store.GetGlobalModelAsync(modelId);
 47              
 48  ✔  1394  ●          if (global != null)
 49  ✔     4             {
 50  ✔     4                 var canonicalId = CanonicalModelId.Parse(global.Id);
 51              
 52  ✔     4                 var providers = new List<ProviderConfig>();
 53  ✔    24  ●              foreach (var pm in global.ProviderModels)
 54  ✔     6                 {
 55  ✔     6  ●                  if (!_config.Providers.TryGetValue(pm.ProviderId, out var provCfg))
 56  ✔     1                     {
 57                                  // provider config missing in static config -> skip
 58  ✔     1                         continue;
 59                              }
 60              
 61  ✓     5  ◑                  if (!provCfg.Enabled)
 62  ❌    0                     {
 63                                  // provider disabled -> skip
 64  ❌    0                         continue;
 65                              }
 66              
 67                              // Create a shallow copy so we don't mutate the configured instance accidentally
 68  ✔     5                     var prov = new ProviderConfig
 69  ✔     5                     {
 70  ✔     5                         Enabled = provCfg.Enabled,
 71  ✔     5                         Key = pm.ProviderId,
 72  ✔     5                         AccountId = provCfg.AccountId,
 73  ✔     5                         ProjectId = provCfg.ProjectId,
 74  ✔     5                         AuthStoragePath = provCfg.AuthStoragePath,
 75  ✔     5                         Tier = provCfg.Tier,
 76  ✔     5                         Models = new List<string> { pm.ProviderSpecificId },
 77  ✔     5                         Type = provCfg.Type,
 78  ✔     5                         Endpoint = provCfg.Endpoint,
 79  ✔     5                         FallbackEndpoint = provCfg.FallbackEndpoint,
 80  ✔     5                     };
 81              
 82  ✔     5                     providers.Add(prov);
 83  ✔     5                 }
 84              
 85  ✔     4                 return new ResolutionResult(modelId, canonicalId, providers);
 86                      }
 87              
 88                      // If no GlobalModel found in DB, fall back to tenant-level aliases/combos and then to static config
 89  ✔  1390             var candidatesToTry = new List<string>();
 90  ✔  1390             bool foundInDb = false;
 91              
 92  ✔  1390  ●          if (tenantId.HasValue)
 93  ✔     5             {
 94                          // 1. Check Model Aliases
 95  ✔     5                 var alias = await _store.GetAliasAsync(tenantId.Value, modelId);
 96  ✔     5  ●              string targetModel = alias?.TargetModel ?? modelId;
 97              
 98                          // 2. Check Model Combos
 99  ✔     5                 var combo = await _store.GetComboAsync(tenantId.Value, targetModel);
100              
101  ✔     5  ●              if (combo != null)
102  ✔     3                 {
103                              try
104  ✔     3                     {
105  ✔     3                         var models = JsonSerializer.Deserialize<List<string>>(combo.OrderedModelsJson);
106  ✔     2  ●                      if (models != null)
107  ✔     2                         {
108  ✔     2                             candidatesToTry.AddRange(models);
109  ✔     2                             foundInDb = true;
110  ✔     2                         }
111  ✔     2                     }
112  ✔     3                     catch { /* Ignore invalid JSON */ }
113  ✔     3                 }
114              
115  ✔     5  ●              if (!foundInDb && alias != null)
116  ✔     2                 {
117  ✔     2                     candidatesToTry.Add(targetModel);
118  ✔     2                     foundInDb = true;
119  ✔     2                 }
120  ✔     5             }
121              
122  ✔  1390  ●          if (!foundInDb)
123  ✔  1386             {
124                          // Fallback to Config
125  ✔  1386  ●              if (_config.Aliases.TryGetValue(modelId, out var configAlias))
126  ✔    14                 {
127  ✔    14                     candidatesToTry.AddRange(configAlias.Candidates);
128  ✔    14                 }
129                          else
130  ✔  1372                 {
131  ✔  1372                     candidatesToTry.Add(modelId);
132  ✔  1372                 }
133  ✔  1386             }
134              
135  ✔  1390             return ResolveCandidates(modelId, candidatesToTry, required);
136  ✔  1394         }
137              
138                  private ResolutionResult ResolveConfigOnly(string modelId, RequiredCapabilities? required)
139  ✔    16         {
140  ✔    16             var candidatesToTry = new List<string>();
141  ✔    16  ●          if (_config.Aliases.TryGetValue(modelId, out var alias))
142  ✔     4             {
143  ✔     4                 candidatesToTry.AddRange(alias.Candidates);
144  ✔     4             }
145                      else
146  ✔    11             {
147  ✔    11                 candidatesToTry.Add(modelId);
148  ✔    11             }
149  ✔    15             return ResolveCandidates(modelId, candidatesToTry, required);
150  ✔    15         }
151              
152                  private ResolutionResult ResolveCandidates(string originalModelId, List<string> candidates, RequiredCapabilities? re
153  ✔  1405         {
154  ✔  1405             CanonicalModelId? firstCanonicalId = null;
155              
156  ✔  5631  ●          foreach (var candidateId in candidates)
157  ✔  1406             {
158                          // Step A: Canonical Lookup
159  ✔  1406                 var modelConfig = _config.CanonicalModels
160  ✔  4089                     .FirstOrDefault(m => string.Equals(m.Id, candidateId, StringComparison.OrdinalIgnoreCase));
161              
162  ✔  1406  ●              var canonicalId = modelConfig != null
163  ✔  1406                     ? new CanonicalModelId(modelConfig.Provider, modelConfig.ModelPath)
164  ✔  1406                     : CanonicalModelId.Parse(candidateId);
165              
166  ✔  1406  ●              firstCanonicalId ??= canonicalId;
167              
168                          // Step B: Capability check (only possible when we have a canonical model config)
169  ✔  1406  ●              if (required != null && modelConfig != null)
170  ✔  1330                 {
171  ✓  1330  ◕                  bool meetsRequirements =
172  ✔  1330                         (!required.Streaming || modelConfig.Streaming) &&
173  ✔  1330                         (!required.Tools || modelConfig.Tools) &&
174  ✔  1330                         (!required.Vision || modelConfig.Vision) &&
175  ✔  1330                         (!required.StructuredOutput || modelConfig.StructuredOutput) &&
176  ✔  1330                         (!required.LogProbs || modelConfig.LogProbs);
177              
178  ✔  1330  ●                  if (!meetsRequirements)
179  ✔     2                     {
180  ✔     2                         continue;
181                              }
182  ✔  1328                 }
183              
184                          // Step C: Registry lookup
185  ✔  1404                 var candidatePairs = _registry.GetCandidates(canonicalId.ModelPath).ToList();
186  ✔  1404                 Console.WriteLine($"[DEBUG] Registry returned {candidatePairs.Count} candidates for '{canonicalId.ModelPath}
187              
188                          // Fallback: sometimes Parse() will split provider/model incorrectly (e.g. when model id contains '/').
189                          // If nothing was found and we didn't have an explicit canonical config, try the raw candidate string.
190  ✔  1404  ●              if (candidatePairs.Count == 0 && modelConfig == null)
191  ✔     7                 {
192  ✔     7                     var fallbackMatches = _registry.GetCandidates(candidateId).ToList();
193  ✔     7                     Console.WriteLine($"[DEBUG] Fallback: Registry lookup with '{candidateId}' returned {fallbackMatches.Cou
194  ✔     7  ●                  if (fallbackMatches.Count > 0)
195  ✔     1                     {
196  ✔     1                         candidatePairs = fallbackMatches;
197                                  // Reset provider portion since the original parse was likely wrong
198  ✔     1                         canonicalId = new CanonicalModelId("unknown", candidateId);
199  ✔     1                     }
200  ✔     7                 }
201              
202                          // Step D: Provider resolution
203  ✔  1404                 var providers = candidatePairs
204  ✔  1404                     .Select(p =>
205  ✔  4131                     {
206  ✔  4131                         if (_config.Providers.TryGetValue(p.ServiceKey, out var prov))
207  ✔  4131                         {
208  ✔  1404                             // ensure the ProviderConfig knows its key
209  ✔  4131                             prov.Key = p.ServiceKey;
210  ✔  4131                             return prov;
211  ✔  1404                         }
212  ❌    0                         return null;
213  ✔  4131                     })
214  ✔  4131                     .Where(p => p != null)
215  ✔  1404                     .Cast<ProviderConfig>()
216  ✔  1404                     .ToList();
217              
218                          // Step E: Provider filtering by canonical provider if present
219  ✔  1404  ●              if (!string.Equals(canonicalId.Provider, "unknown", StringComparison.OrdinalIgnoreCase))
220  ✔  1338                 {
221  ✔  1338                     providers = providers
222  ✔  3959                         .Where(c => string.Equals(c.Key, canonicalId.Provider, StringComparison.OrdinalIgnoreCase))
223  ✔  1338                         .ToList();
224  ✔  1338                 }
225              
226                          // Step F: Success check
227  ✔  1404  ●              if (providers.Count > 0)
228  ✔  1396                 {
229  ✔  1396  ●                  if (string.Equals(canonicalId.Provider, "unknown", StringComparison.OrdinalIgnoreCase))
230  ✔    61                     {
231                                  // Use the first provider as the canonical provider if unknown
232  ✔    61                         canonicalId = new CanonicalModelId(providers[0].Key!, canonicalId.ModelPath);
233  ✔    61                     }
234              
235  ✔  1396                     return new ResolutionResult(originalModelId, canonicalId, providers);
236                          }
237  ✔     8             }
238              
239                      // No match found
240  ✓     9  ◑          var finalCanonicalId = firstCanonicalId ?? CanonicalModelId.Parse(originalModelId);
241  ✔     9             return new ResolutionResult(originalModelId, finalCanonicalId, new List<ProviderConfig>());
242  ✔  1405         }
243              }
```
# Synaxis.InferenceGateway.Application.Routing.RequiredCapabilities

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Routing.RequiredCapabilities |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/RequiredCapabilities.cs |
| **Line coverage:** | 83.3% (5 of 6) |
| Covered lines: | 5 |
| Uncovered lines: | 1 |
| Coverable lines: | 6 |
| Total lines: | 11 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Streaming()** | 100% | 1 | 1 | 100% |
| **get_Tools()** | 100% | 1 | 1 | 100% |
| **get_Vision()** | 100% | 1 | 1 | 100% |
| **get_StructuredOutput()** | 100% | 1 | 1 | 100% |
| **get_LogProbs()** | 100% | 1 | 1 | 100% |
| **get_Default()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/RequiredCapabilities.cs
```
 1              namespace Synaxis.InferenceGateway.Application.Routing;
 2              
 3              public class RequiredCapabilities
 4              {
 5  ✔  2732         public bool Streaming { get; set; }
 6  ✔  1332         public bool Tools { get; set; }
 7  ✔  1328         public bool Vision { get; set; }
 8  ✔  1328         public bool StructuredOutput { get; set; }
 9  ✔  1328         public bool LogProbs { get; set; }
10  ❌    0         public static RequiredCapabilities Default => new();
11              }
```
# Synaxis.InferenceGateway.Application.Routing.ResolutionResult

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Routing.ResolutionResult |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/ResolutionResult.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 6 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_OriginalModelId()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/ResolutionResult.cs
```
1              using Synaxis.InferenceGateway.Application.Configuration;
2              using System.Collections.Generic;
3              
4              namespace Synaxis.InferenceGateway.Application.Routing;
5              
6  ✔  7296     public record ResolutionResult(string OriginalModelId, CanonicalModelId CanonicalId, List<ProviderConfig> Candidates);
```
# Synaxis.InferenceGateway.Application.Routing.SmartRouter

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Routing.SmartRouter |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/SmartRouter.cs |
| **Line coverage:** | 100% (40 of 40) |
| Covered lines: | 40 |
| Uncovered lines: | 0 |
| Coverable lines: | 40 |
| Total lines: | 68 |
| **Branch coverage:** | 100% (10 of 10) |
| Covered branches: | 10 |
| Total branches: | 10 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **GetCandidatesAsync()** | 100% | 10 | 10 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Routing/SmartRouter.cs
```
 1              using Microsoft.Extensions.Logging;
 2              using Synaxis.InferenceGateway.Application.Configuration;
 3              using System.Linq;
 4              using System.Threading;
 5              using System.Threading.Tasks;
 6              using System.Collections.Generic;
 7              
 8              namespace Synaxis.InferenceGateway.Application.Routing;
 9              
10              public class SmartRouter : ISmartRouter
11              {
12                  private readonly IModelResolver _modelResolver;
13                  private readonly ICostService _costService;
14                  private readonly IHealthStore _healthStore;
15                  private readonly IQuotaTracker _quotaTracker;
16                  private readonly ILogger<SmartRouter> _logger;
17              
18  ✔    40         public SmartRouter(
19  ✔    40             IModelResolver modelResolver,
20  ✔    40             ICostService costService,
21  ✔    40             IHealthStore healthStore,
22  ✔    40             IQuotaTracker quotaTracker,
23  ✔    40             ILogger<SmartRouter> logger)
24  ✔    40         {
25  ✔    40             _modelResolver = modelResolver;
26  ✔    40             _costService = costService;
27  ✔    40             _healthStore = healthStore;
28  ✔    40             _quotaTracker = quotaTracker;
29  ✔    40             _logger = logger;
30  ✔    40         }
31              
32                  public async Task<List<EnrichedCandidate>> GetCandidatesAsync(string modelId, bool streaming, CancellationToken canc
33  ✔  1396  ●      {
34  ✔  1396             var caps = new RequiredCapabilities { Streaming = streaming };
35  ✔  1396             var resolution = await _modelResolver.ResolveAsync(modelId, EndpointKind.ChatCompletions, caps);
36              
37  ✔  1396  ●          if (resolution.Candidates.Count == 0)
38  ✔     6             {
39  ✔     6                  _logger.LogWarning("No providers found for model '{ModelId}' with required capabilities.", modelId);
40  ✔     6                  throw new ArgumentException($"No providers available for model '{modelId}' with the requested capabilities.
41                      }
42              
43  ✔  1390             var enriched = new List<EnrichedCandidate>();
44  ✔  7191  ●          foreach (var candidate in resolution.Candidates)
45  ✔  1511             {
46  ✔  1511  ●               if (!await _healthStore.IsHealthyAsync(candidate.Key!, cancellationToken))
47  ✔     6                  {
48  ✔     6                      _logger.LogDebug("Skipping unhealthy provider '{ProviderKey}'", candidate.Key);
49  ✔     6                      continue;
50                           }
51              
52  ✔  1505  ●               if (!await _quotaTracker.CheckQuotaAsync(candidate.Key!, cancellationToken))
53  ✔     4                  {
54  ✔     4                      _logger.LogDebug("Skipping quota-exceeded provider '{ProviderKey}'", candidate.Key);
55  ✔     4                      continue;
56                           }
57              
58  ✔  1501                   var cost = await _costService.GetCostAsync(candidate.Key!, resolution.CanonicalId.ModelPath, cancellationT
59  ✔  1500                   enriched.Add(new EnrichedCandidate(candidate, cost, resolution.CanonicalId.ModelPath));
60  ✔  1500             }
61              
62  ✔  1389             return enriched
63  ✔   172                 .OrderByDescending(c => c.IsFree)
64  ✔   172                 .ThenBy(c => c.CostPerToken)
65  ✔   172                 .ThenBy(c => c.Config.Tier)
66  ✔  1389                 .ToList();
67  ✔  1389         }
68              }
```
# Synaxis.InferenceGateway.Application.Translation.CanonicalChunk

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.CanonicalChunk |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/CanonicalChunk.cs |
| **Line coverage:** | 0% (0 of 1) |
| Covered lines: | 0 |
| Uncovered lines: | 1 |
| Coverable lines: | 1 |
| Total lines: | 5 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_ContentDelta()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/CanonicalChunk.cs
```
1           using Microsoft.Extensions.AI;
2           
3           namespace Synaxis.InferenceGateway.Application.Translation;
4           
5  ❌ 0     public sealed record CanonicalChunk(string? ContentDelta, IList<FunctionCallContent>? ToolCallDeltas = null);
```
# Synaxis.InferenceGateway.Application.Translation.CanonicalRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.CanonicalRequest |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/CanonicalRequest.cs |
| **Line coverage:** | 100% (8 of 8) |
| Covered lines: | 8 |
| Uncovered lines: | 0 |
| Coverable lines: | 8 |
| Total lines: | 13 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Endpoint()** | 100% | 1 | 1 | 100% |
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_Messages()** | 100% | 1 | 1 | 100% |
| **get_Tools()** | 100% | 1 | 1 | 100% |
| **get_ToolChoice()** | 100% | 1 | 1 | 100% |
| **get_ResponseFormat()** | 100% | 1 | 1 | 100% |
| **get_AdditionalOptions()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/CanonicalRequest.cs
```
 1            using Microsoft.Extensions.AI;
 2            using Synaxis.InferenceGateway.Application.Routing;
 3            
 4            namespace Synaxis.InferenceGateway.Application.Translation;
 5            
 6  ✔  26     public sealed record CanonicalRequest(
 7  ✔   1         EndpointKind Endpoint,
 8  ✔  20         string Model,
 9  ✔  15         IReadOnlyList<ChatMessage> Messages,
10  ✔   2         IList<AITool>? Tools = null,
11  ✔   1         object? ToolChoice = null,
12  ✔   1         object? ResponseFormat = null,
13  ✔  42         ChatOptions? AdditionalOptions = null);
```
# Synaxis.InferenceGateway.Application.Translation.CanonicalResponse

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.CanonicalResponse |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/CanonicalResponse.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 5 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Content()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/CanonicalResponse.cs
```
1            using Microsoft.Extensions.AI;
2            
3            namespace Synaxis.InferenceGateway.Application.Translation;
4            
5  ✔  69     public sealed record CanonicalResponse(string? Content, IList<FunctionCallContent>? ToolCalls = null);
```
# Synaxis.InferenceGateway.Application.Translation.NoOpRequestTranslator

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.NoOpRequestTranslator |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/NoOpTranslators.cs |
| **Line coverage:** | 50% (1 of 2) |
| Covered lines: | 1 |
| Uncovered lines: | 1 |
| Coverable lines: | 2 |
| Total lines: | 24 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **CanHandle(...)** | 100% | 1 | 1 | 100% |
| **Translate(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/NoOpTranslators.cs
```
 1            using Microsoft.Extensions.AI;
 2            
 3            namespace Synaxis.InferenceGateway.Application.Translation;
 4            
 5            public sealed class NoOpRequestTranslator : IRequestTranslator
 6            {
 7  ✔  13         public bool CanHandle(CanonicalRequest request) => false;
 8            
 9  ❌  0         public CanonicalRequest Translate(CanonicalRequest request) => request;
10            }
11            
12            public sealed class NoOpResponseTranslator : IResponseTranslator
13            {
14                public bool CanHandle(CanonicalResponse response) => false;
15            
16                public CanonicalResponse Translate(CanonicalResponse response) => response;
17            }
18            
19            public sealed class NoOpStreamingTranslator : IStreamingTranslator
20            {
21                public bool CanHandle(ChatResponseUpdate update) => false;
22            
23                public ChatResponseUpdate Translate(ChatResponseUpdate update) => update;
24            }
```
# Synaxis.InferenceGateway.Application.Translation.NoOpResponseTranslator

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.NoOpResponseTranslator |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/NoOpTranslators.cs |
| **Line coverage:** | 50% (1 of 2) |
| Covered lines: | 1 |
| Uncovered lines: | 1 |
| Coverable lines: | 2 |
| Total lines: | 24 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **CanHandle(...)** | 100% | 1 | 1 | 100% |
| **Translate(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/NoOpTranslators.cs
```
 1            using Microsoft.Extensions.AI;
 2            
 3            namespace Synaxis.InferenceGateway.Application.Translation;
 4            
 5            public sealed class NoOpRequestTranslator : IRequestTranslator
 6            {
 7                public bool CanHandle(CanonicalRequest request) => false;
 8            
 9                public CanonicalRequest Translate(CanonicalRequest request) => request;
10            }
11            
12            public sealed class NoOpResponseTranslator : IResponseTranslator
13            {
14  ✔  10         public bool CanHandle(CanonicalResponse response) => false;
15            
16  ❌  0         public CanonicalResponse Translate(CanonicalResponse response) => response;
17            }
18            
19            public sealed class NoOpStreamingTranslator : IStreamingTranslator
20            {
21                public bool CanHandle(ChatResponseUpdate update) => false;
22            
23                public ChatResponseUpdate Translate(ChatResponseUpdate update) => update;
24            }
```
# Synaxis.InferenceGateway.Application.Translation.NoOpStreamingTranslator

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.NoOpStreamingTranslator |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/NoOpTranslators.cs |
| **Line coverage:** | 50% (1 of 2) |
| Covered lines: | 1 |
| Uncovered lines: | 1 |
| Coverable lines: | 2 |
| Total lines: | 24 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **CanHandle(...)** | 100% | 1 | 1 | 100% |
| **Translate(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/NoOpTranslators.cs
```
 1           using Microsoft.Extensions.AI;
 2           
 3           namespace Synaxis.InferenceGateway.Application.Translation;
 4           
 5           public sealed class NoOpRequestTranslator : IRequestTranslator
 6           {
 7               public bool CanHandle(CanonicalRequest request) => false;
 8           
 9               public CanonicalRequest Translate(CanonicalRequest request) => request;
10           }
11           
12           public sealed class NoOpResponseTranslator : IResponseTranslator
13           {
14               public bool CanHandle(CanonicalResponse response) => false;
15           
16               public CanonicalResponse Translate(CanonicalResponse response) => response;
17           }
18           
19           public sealed class NoOpStreamingTranslator : IStreamingTranslator
20           {
21  ✔  8         public bool CanHandle(ChatResponseUpdate update) => false;
22           
23  ❌ 0         public ChatResponseUpdate Translate(ChatResponseUpdate update) => update;
24           }
```
# Synaxis.InferenceGateway.Application.Translation.OpenAIFunction

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.OpenAIFunction |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs |
| **Line coverage:** | 66.6% (2 of 3) |
| Covered lines: | 2 |
| Uncovered lines: | 1 |
| Coverable lines: | 3 |
| Total lines: | 96 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Description()** | 100% | 1 | 1 | 100% |
| **get_Parameters()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs
```
 1           using System.Text.Json.Serialization;
 2           
 3           namespace Synaxis.InferenceGateway.Application.Translation;
 4           
 5           public class OpenAIRequest
 6           {
 7               [JsonPropertyName("model")]
 8               public string Model { get; set; } = string.Empty;
 9           
10               [JsonPropertyName("messages")]
11               public List<OpenAIMessage> Messages { get; set; } = new();
12           
13               [JsonPropertyName("tools")]
14               public List<OpenAITool>? Tools { get; set; }
15           
16               [JsonPropertyName("tool_choice")]
17               public object? ToolChoice { get; set; }
18           
19               [JsonPropertyName("response_format")]
20               public object? ResponseFormat { get; set; }
21           
22               [JsonPropertyName("stream")]
23               public bool Stream { get; set; }
24           
25               [JsonPropertyName("temperature")]
26               public double? Temperature { get; set; }
27           
28               [JsonPropertyName("top_p")]
29               public double? TopP { get; set; }
30           
31               [JsonPropertyName("max_tokens")]
32               public int? MaxTokens { get; set; }
33           
34               [JsonPropertyName("stop")]
35               public object? Stop { get; set; }
36           }
37           
38           public class OpenAIMessage
39           {
40               [JsonPropertyName("role")]
41               public string Role { get; set; } = string.Empty;
42           
43               [JsonPropertyName("content")]
44               public object? Content { get; set; }
45           
46               [JsonPropertyName("name")]
47               public string? Name { get; set; }
48           
49               [JsonPropertyName("tool_calls")]
50               public List<OpenAIToolCall>? ToolCalls { get; set; }
51           
52               [JsonPropertyName("tool_call_id")]
53               public string? ToolCallId { get; set; }
54           }
55           
56           public class OpenAITool
57           {
58               [JsonPropertyName("type")]
59               public string Type { get; set; } = "function";
60           
61               [JsonPropertyName("function")]
62               public OpenAIFunction? Function { get; set; }
63           }
64           
65           public class OpenAIFunction
66           {
67               [JsonPropertyName("name")]
68  ✔  3         public string Name { get; set; } = string.Empty;
69           
70               [JsonPropertyName("description")]
71  ✔  2         public string? Description { get; set; }
72           
73               [JsonPropertyName("parameters")]
74  ❌ 0         public object? Parameters { get; set; }
75           }
76           
77           public class OpenAIToolCall
78           {
79               [JsonPropertyName("id")]
80               public string Id { get; set; } = string.Empty;
81           
82               [JsonPropertyName("type")]
83               public string Type { get; set; } = "function";
84           
85               [JsonPropertyName("function")]
86               public OpenAIFunctionCall? Function { get; set; }
87           }
88           
89           public class OpenAIFunctionCall
90           {
91               [JsonPropertyName("name")]
92               public string Name { get; set; } = string.Empty;
93           
94               [JsonPropertyName("arguments")]
95               public string Arguments { get; set; } = string.Empty;
96           }
```
# Synaxis.InferenceGateway.Application.Translation.OpenAIFunctionCall

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.OpenAIFunctionCall |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs |
| **Line coverage:** | 100% (2 of 2) |
| Covered lines: | 2 |
| Uncovered lines: | 0 |
| Coverable lines: | 2 |
| Total lines: | 96 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Arguments()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs
```
 1            using System.Text.Json.Serialization;
 2            
 3            namespace Synaxis.InferenceGateway.Application.Translation;
 4            
 5            public class OpenAIRequest
 6            {
 7                [JsonPropertyName("model")]
 8                public string Model { get; set; } = string.Empty;
 9            
10                [JsonPropertyName("messages")]
11                public List<OpenAIMessage> Messages { get; set; } = new();
12            
13                [JsonPropertyName("tools")]
14                public List<OpenAITool>? Tools { get; set; }
15            
16                [JsonPropertyName("tool_choice")]
17                public object? ToolChoice { get; set; }
18            
19                [JsonPropertyName("response_format")]
20                public object? ResponseFormat { get; set; }
21            
22                [JsonPropertyName("stream")]
23                public bool Stream { get; set; }
24            
25                [JsonPropertyName("temperature")]
26                public double? Temperature { get; set; }
27            
28                [JsonPropertyName("top_p")]
29                public double? TopP { get; set; }
30            
31                [JsonPropertyName("max_tokens")]
32                public int? MaxTokens { get; set; }
33            
34                [JsonPropertyName("stop")]
35                public object? Stop { get; set; }
36            }
37            
38            public class OpenAIMessage
39            {
40                [JsonPropertyName("role")]
41                public string Role { get; set; } = string.Empty;
42            
43                [JsonPropertyName("content")]
44                public object? Content { get; set; }
45            
46                [JsonPropertyName("name")]
47                public string? Name { get; set; }
48            
49                [JsonPropertyName("tool_calls")]
50                public List<OpenAIToolCall>? ToolCalls { get; set; }
51            
52                [JsonPropertyName("tool_call_id")]
53                public string? ToolCallId { get; set; }
54            }
55            
56            public class OpenAITool
57            {
58                [JsonPropertyName("type")]
59                public string Type { get; set; } = "function";
60            
61                [JsonPropertyName("function")]
62                public OpenAIFunction? Function { get; set; }
63            }
64            
65            public class OpenAIFunction
66            {
67                [JsonPropertyName("name")]
68                public string Name { get; set; } = string.Empty;
69            
70                [JsonPropertyName("description")]
71                public string? Description { get; set; }
72            
73                [JsonPropertyName("parameters")]
74                public object? Parameters { get; set; }
75            }
76            
77            public class OpenAIToolCall
78            {
79                [JsonPropertyName("id")]
80                public string Id { get; set; } = string.Empty;
81            
82                [JsonPropertyName("type")]
83                public string Type { get; set; } = "function";
84            
85                [JsonPropertyName("function")]
86                public OpenAIFunctionCall? Function { get; set; }
87            }
88            
89            public class OpenAIFunctionCall
90            {
91                [JsonPropertyName("name")]
92  ✔  12         public string Name { get; set; } = string.Empty;
93            
94                [JsonPropertyName("arguments")]
95  ✔  15         public string Arguments { get; set; } = string.Empty;
96            }
```
# Synaxis.InferenceGateway.Application.Translation.OpenAIMessage

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.OpenAIMessage |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs |
| **Line coverage:** | 100% (5 of 5) |
| Covered lines: | 5 |
| Uncovered lines: | 0 |
| Coverable lines: | 5 |
| Total lines: | 96 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Role()** | 100% | 1 | 1 | 100% |
| **get_Content()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_ToolCalls()** | 100% | 1 | 1 | 100% |
| **get_ToolCallId()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs
```
 1             using System.Text.Json.Serialization;
 2             
 3             namespace Synaxis.InferenceGateway.Application.Translation;
 4             
 5             public class OpenAIRequest
 6             {
 7                 [JsonPropertyName("model")]
 8                 public string Model { get; set; } = string.Empty;
 9             
10                 [JsonPropertyName("messages")]
11                 public List<OpenAIMessage> Messages { get; set; } = new();
12             
13                 [JsonPropertyName("tools")]
14                 public List<OpenAITool>? Tools { get; set; }
15             
16                 [JsonPropertyName("tool_choice")]
17                 public object? ToolChoice { get; set; }
18             
19                 [JsonPropertyName("response_format")]
20                 public object? ResponseFormat { get; set; }
21             
22                 [JsonPropertyName("stream")]
23                 public bool Stream { get; set; }
24             
25                 [JsonPropertyName("temperature")]
26                 public double? Temperature { get; set; }
27             
28                 [JsonPropertyName("top_p")]
29                 public double? TopP { get; set; }
30             
31                 [JsonPropertyName("max_tokens")]
32                 public int? MaxTokens { get; set; }
33             
34                 [JsonPropertyName("stop")]
35                 public object? Stop { get; set; }
36             }
37             
38             public class OpenAIMessage
39             {
40                 [JsonPropertyName("role")]
41  ✔  112         public string Role { get; set; } = string.Empty;
42             
43                 [JsonPropertyName("content")]
44  ✔   70         public object? Content { get; set; }
45             
46                 [JsonPropertyName("name")]
47  ✔   31         public string? Name { get; set; }
48             
49                 [JsonPropertyName("tool_calls")]
50  ✔   39         public List<OpenAIToolCall>? ToolCalls { get; set; }
51             
52                 [JsonPropertyName("tool_call_id")]
53  ✔    8         public string? ToolCallId { get; set; }
54             }
55             
56             public class OpenAITool
57             {
58                 [JsonPropertyName("type")]
59                 public string Type { get; set; } = "function";
60             
61                 [JsonPropertyName("function")]
62                 public OpenAIFunction? Function { get; set; }
63             }
64             
65             public class OpenAIFunction
66             {
67                 [JsonPropertyName("name")]
68                 public string Name { get; set; } = string.Empty;
69             
70                 [JsonPropertyName("description")]
71                 public string? Description { get; set; }
72             
73                 [JsonPropertyName("parameters")]
74                 public object? Parameters { get; set; }
75             }
76             
77             public class OpenAIToolCall
78             {
79                 [JsonPropertyName("id")]
80                 public string Id { get; set; } = string.Empty;
81             
82                 [JsonPropertyName("type")]
83                 public string Type { get; set; } = "function";
84             
85                 [JsonPropertyName("function")]
86                 public OpenAIFunctionCall? Function { get; set; }
87             }
88             
89             public class OpenAIFunctionCall
90             {
91                 [JsonPropertyName("name")]
92                 public string Name { get; set; } = string.Empty;
93             
94                 [JsonPropertyName("arguments")]
95                 public string Arguments { get; set; } = string.Empty;
96             }
```
# Synaxis.InferenceGateway.Application.Translation.OpenAIRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.OpenAIRequest |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs |
| **Line coverage:** | 100% (10 of 10) |
| Covered lines: | 10 |
| Uncovered lines: | 0 |
| Coverable lines: | 10 |
| Total lines: | 96 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_Messages()** | 100% | 1 | 1 | 100% |
| **get_Tools()** | 100% | 1 | 1 | 100% |
| **get_ToolChoice()** | 100% | 1 | 1 | 100% |
| **get_ResponseFormat()** | 100% | 1 | 1 | 100% |
| **get_Stream()** | 100% | 1 | 1 | 100% |
| **get_Temperature()** | 100% | 1 | 1 | 100% |
| **get_TopP()** | 100% | 1 | 1 | 100% |
| **get_MaxTokens()** | 100% | 1 | 1 | 100% |
| **get_Stop()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs
```
 1             using System.Text.Json.Serialization;
 2             
 3             namespace Synaxis.InferenceGateway.Application.Translation;
 4             
 5             public class OpenAIRequest
 6             {
 7                 [JsonPropertyName("model")]
 8  ✔  174         public string Model { get; set; } = string.Empty;
 9             
10                 [JsonPropertyName("messages")]
11  ✔  169         public List<OpenAIMessage> Messages { get; set; } = new();
12             
13                 [JsonPropertyName("tools")]
14  ✔   27         public List<OpenAITool>? Tools { get; set; }
15             
16                 [JsonPropertyName("tool_choice")]
17  ✔   27         public object? ToolChoice { get; set; }
18             
19                 [JsonPropertyName("response_format")]
20  ✔   27         public object? ResponseFormat { get; set; }
21             
22                 [JsonPropertyName("stream")]
23  ✔   21         public bool Stream { get; set; }
24             
25                 [JsonPropertyName("temperature")]
26  ✔   28         public double? Temperature { get; set; }
27             
28                 [JsonPropertyName("top_p")]
29  ✔   28         public double? TopP { get; set; }
30             
31                 [JsonPropertyName("max_tokens")]
32  ✔   28         public int? MaxTokens { get; set; }
33             
34                 [JsonPropertyName("stop")]
35  ✔   29         public object? Stop { get; set; }
36             }
37             
38             public class OpenAIMessage
39             {
40                 [JsonPropertyName("role")]
41                 public string Role { get; set; } = string.Empty;
42             
43                 [JsonPropertyName("content")]
44                 public object? Content { get; set; }
45             
46                 [JsonPropertyName("name")]
47                 public string? Name { get; set; }
48             
49                 [JsonPropertyName("tool_calls")]
50                 public List<OpenAIToolCall>? ToolCalls { get; set; }
51             
52                 [JsonPropertyName("tool_call_id")]
53                 public string? ToolCallId { get; set; }
54             }
55             
56             public class OpenAITool
57             {
58                 [JsonPropertyName("type")]
59                 public string Type { get; set; } = "function";
60             
61                 [JsonPropertyName("function")]
62                 public OpenAIFunction? Function { get; set; }
63             }
64             
65             public class OpenAIFunction
66             {
67                 [JsonPropertyName("name")]
68                 public string Name { get; set; } = string.Empty;
69             
70                 [JsonPropertyName("description")]
71                 public string? Description { get; set; }
72             
73                 [JsonPropertyName("parameters")]
74                 public object? Parameters { get; set; }
75             }
76             
77             public class OpenAIToolCall
78             {
79                 [JsonPropertyName("id")]
80                 public string Id { get; set; } = string.Empty;
81             
82                 [JsonPropertyName("type")]
83                 public string Type { get; set; } = "function";
84             
85                 [JsonPropertyName("function")]
86                 public OpenAIFunctionCall? Function { get; set; }
87             }
88             
89             public class OpenAIFunctionCall
90             {
91                 [JsonPropertyName("name")]
92                 public string Name { get; set; } = string.Empty;
93             
94                 [JsonPropertyName("arguments")]
95                 public string Arguments { get; set; } = string.Empty;
96             }
```
# Synaxis.InferenceGateway.Application.Translation.OpenAITool

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.OpenAITool |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs |
| **Line coverage:** | 100% (2 of 2) |
| Covered lines: | 2 |
| Uncovered lines: | 0 |
| Coverable lines: | 2 |
| Total lines: | 96 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_Function()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs
```
 1           using System.Text.Json.Serialization;
 2           
 3           namespace Synaxis.InferenceGateway.Application.Translation;
 4           
 5           public class OpenAIRequest
 6           {
 7               [JsonPropertyName("model")]
 8               public string Model { get; set; } = string.Empty;
 9           
10               [JsonPropertyName("messages")]
11               public List<OpenAIMessage> Messages { get; set; } = new();
12           
13               [JsonPropertyName("tools")]
14               public List<OpenAITool>? Tools { get; set; }
15           
16               [JsonPropertyName("tool_choice")]
17               public object? ToolChoice { get; set; }
18           
19               [JsonPropertyName("response_format")]
20               public object? ResponseFormat { get; set; }
21           
22               [JsonPropertyName("stream")]
23               public bool Stream { get; set; }
24           
25               [JsonPropertyName("temperature")]
26               public double? Temperature { get; set; }
27           
28               [JsonPropertyName("top_p")]
29               public double? TopP { get; set; }
30           
31               [JsonPropertyName("max_tokens")]
32               public int? MaxTokens { get; set; }
33           
34               [JsonPropertyName("stop")]
35               public object? Stop { get; set; }
36           }
37           
38           public class OpenAIMessage
39           {
40               [JsonPropertyName("role")]
41               public string Role { get; set; } = string.Empty;
42           
43               [JsonPropertyName("content")]
44               public object? Content { get; set; }
45           
46               [JsonPropertyName("name")]
47               public string? Name { get; set; }
48           
49               [JsonPropertyName("tool_calls")]
50               public List<OpenAIToolCall>? ToolCalls { get; set; }
51           
52               [JsonPropertyName("tool_call_id")]
53               public string? ToolCallId { get; set; }
54           }
55           
56           public class OpenAITool
57           {
58               [JsonPropertyName("type")]
59  ✔  3         public string Type { get; set; } = "function";
60           
61               [JsonPropertyName("function")]
62  ✔  4         public OpenAIFunction? Function { get; set; }
63           }
64           
65           public class OpenAIFunction
66           {
67               [JsonPropertyName("name")]
68               public string Name { get; set; } = string.Empty;
69           
70               [JsonPropertyName("description")]
71               public string? Description { get; set; }
72           
73               [JsonPropertyName("parameters")]
74               public object? Parameters { get; set; }
75           }
76           
77           public class OpenAIToolCall
78           {
79               [JsonPropertyName("id")]
80               public string Id { get; set; } = string.Empty;
81           
82               [JsonPropertyName("type")]
83               public string Type { get; set; } = "function";
84           
85               [JsonPropertyName("function")]
86               public OpenAIFunctionCall? Function { get; set; }
87           }
88           
89           public class OpenAIFunctionCall
90           {
91               [JsonPropertyName("name")]
92               public string Name { get; set; } = string.Empty;
93           
94               [JsonPropertyName("arguments")]
95               public string Arguments { get; set; } = string.Empty;
96           }
```
# Synaxis.InferenceGateway.Application.Translation.OpenAIToolCall

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.OpenAIToolCall |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 96 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_Function()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/OpenAIRequest.cs
```
 1            using System.Text.Json.Serialization;
 2            
 3            namespace Synaxis.InferenceGateway.Application.Translation;
 4            
 5            public class OpenAIRequest
 6            {
 7                [JsonPropertyName("model")]
 8                public string Model { get; set; } = string.Empty;
 9            
10                [JsonPropertyName("messages")]
11                public List<OpenAIMessage> Messages { get; set; } = new();
12            
13                [JsonPropertyName("tools")]
14                public List<OpenAITool>? Tools { get; set; }
15            
16                [JsonPropertyName("tool_choice")]
17                public object? ToolChoice { get; set; }
18            
19                [JsonPropertyName("response_format")]
20                public object? ResponseFormat { get; set; }
21            
22                [JsonPropertyName("stream")]
23                public bool Stream { get; set; }
24            
25                [JsonPropertyName("temperature")]
26                public double? Temperature { get; set; }
27            
28                [JsonPropertyName("top_p")]
29                public double? TopP { get; set; }
30            
31                [JsonPropertyName("max_tokens")]
32                public int? MaxTokens { get; set; }
33            
34                [JsonPropertyName("stop")]
35                public object? Stop { get; set; }
36            }
37            
38            public class OpenAIMessage
39            {
40                [JsonPropertyName("role")]
41                public string Role { get; set; } = string.Empty;
42            
43                [JsonPropertyName("content")]
44                public object? Content { get; set; }
45            
46                [JsonPropertyName("name")]
47                public string? Name { get; set; }
48            
49                [JsonPropertyName("tool_calls")]
50                public List<OpenAIToolCall>? ToolCalls { get; set; }
51            
52                [JsonPropertyName("tool_call_id")]
53                public string? ToolCallId { get; set; }
54            }
55            
56            public class OpenAITool
57            {
58                [JsonPropertyName("type")]
59                public string Type { get; set; } = "function";
60            
61                [JsonPropertyName("function")]
62                public OpenAIFunction? Function { get; set; }
63            }
64            
65            public class OpenAIFunction
66            {
67                [JsonPropertyName("name")]
68                public string Name { get; set; } = string.Empty;
69            
70                [JsonPropertyName("description")]
71                public string? Description { get; set; }
72            
73                [JsonPropertyName("parameters")]
74                public object? Parameters { get; set; }
75            }
76            
77            public class OpenAIToolCall
78            {
79                [JsonPropertyName("id")]
80  ✔  14         public string Id { get; set; } = string.Empty;
81            
82                [JsonPropertyName("type")]
83  ✔  10         public string Type { get; set; } = "function";
84            
85                [JsonPropertyName("function")]
86  ✔  21         public OpenAIFunctionCall? Function { get; set; }
87            }
88            
89            public class OpenAIFunctionCall
90            {
91                [JsonPropertyName("name")]
92                public string Name { get; set; } = string.Empty;
93            
94                [JsonPropertyName("arguments")]
95                public string Arguments { get; set; } = string.Empty;
96            }
```
# Synaxis.InferenceGateway.Application.Translation.OpenAIToolNormalizer

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.OpenAIToolNormalizer |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/IToolNormalizer.cs |
| **Line coverage:** | 50% (8 of 16) |
| Covered lines: | 8 |
| Uncovered lines: | 8 |
| Coverable lines: | 16 |
| Total lines: | 46 |
| **Branch coverage:** | 25% (2 of 8) |
| Covered branches: | 2 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **NormalizeResponse(...)** | 25.00% | 23 | 8 | 38.46% |
| **NormalizeUpdate(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/IToolNormalizer.cs
```
 1            using Microsoft.Extensions.AI;
 2            using System.Text.Json;
 3            
 4            namespace Synaxis.InferenceGateway.Application.Translation;
 5            
 6            public interface IToolNormalizer
 7            {
 8                CanonicalResponse NormalizeResponse(CanonicalResponse response);
 9                ChatResponseUpdate NormalizeUpdate(ChatResponseUpdate update);
10            }
11            
12            public class OpenAIToolNormalizer : IToolNormalizer
13            {
14                public CanonicalResponse NormalizeResponse(CanonicalResponse response)
15  ✔  11         {
16  ✓  11  ◑          if (response.ToolCalls == null || response.ToolCalls.Count == 0)
17  ✔  11             {
18  ✔  11                 return response;
19                    }
20            
21  ❌  0             var normalizedCalls = new List<FunctionCallContent>();
22  ❌  0  ○          foreach (var toolCall in response.ToolCalls)
23  ❌  0             {
24  ❌  0  ○              var id = !string.IsNullOrWhiteSpace(toolCall.CallId) ? toolCall.CallId : $"call_{Guid.NewGuid().ToString("N"
25                        // FunctionCallContent usually expects IDictionary<string, object?> for arguments
26                        // If arguments are already parsed, good. If not, we might need to ensure they are valid.
27                        // Since CanonicalResponse now uses FunctionCallContent, we assume they are already in the correct type.
28                        // We just ensure ID is present.
29            
30                        // Create new FunctionCallContent with ID if missing
31                        // Note: FunctionCallContent properties might be read-only, so we create new instance.
32  ❌  0                 var newCall = new FunctionCallContent(id, toolCall.Name, toolCall.Arguments);
33  ❌  0                 normalizedCalls.Add(newCall);
34  ❌  0             }
35            
36  ❌  0             return response with { ToolCalls = normalizedCalls };
37  ✔  11         }
38            
39                public ChatResponseUpdate NormalizeUpdate(ChatResponseUpdate update)
40  ✔   9         {
41                    // For streaming, we just pass through for now as ID generation needs state tracking
42                    // which is complex for a stateless normalizer.
43                    // In a full implementation, we'd need a stateful wrapper or context.
44  ✔   9             return update;
45  ✔   9         }
46            }
```
# Synaxis.InferenceGateway.Application.Translation.TranslationPipeline

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Application.Translation.TranslationPipeline |
| Assembly: | Synaxis.InferenceGateway.Application |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/TranslationPipeline.cs |
| **Line coverage:** | 100% (40 of 40) |
| Covered lines: | 40 |
| Uncovered lines: | 0 |
| Coverable lines: | 40 |
| Total lines: | 65 |
| **Branch coverage:** | 75% (9 of 12) |
| Covered branches: | 9 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **TranslateRequest(...)** | 75.00% | 4 | 4 | 77.77% |
| **TranslateResponse(...)** | 75.00% | 4 | 4 | 80.0% |
| **TranslateUpdate(...)** | 75.00% | 4 | 4 | 80.0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Application/Translation/TranslationPipeline.cs
```
 1            using Microsoft.Extensions.AI;
 2            using System.Linq;
 3            
 4            namespace Synaxis.InferenceGateway.Application.Translation;
 5            
 6            public sealed class TranslationPipeline : ITranslationPipeline
 7            {
 8                private readonly IReadOnlyList<IRequestTranslator> _requestTranslators;
 9                private readonly IReadOnlyList<IResponseTranslator> _responseTranslators;
10                private readonly IReadOnlyList<IStreamingTranslator> _streamingTranslators;
11                private readonly IToolNormalizer _toolNormalizer;
12            
13  ✔  16         public TranslationPipeline(
14  ✔  16             IEnumerable<IRequestTranslator> requestTranslators,
15  ✔  16             IEnumerable<IResponseTranslator> responseTranslators,
16  ✔  16             IEnumerable<IStreamingTranslator> streamingTranslators,
17  ✔  16             IToolNormalizer toolNormalizer)
18  ✔  16         {
19  ✔  16             _requestTranslators = requestTranslators.ToList();
20  ✔  16             _responseTranslators = responseTranslators.ToList();
21  ✔  16             _streamingTranslators = streamingTranslators.ToList();
22  ✔  16             _toolNormalizer = toolNormalizer;
23  ✔  16         }
24            
25                public CanonicalRequest TranslateRequest(CanonicalRequest request)
26  ✔  14         {
27  ✔  69  ●          foreach (var translator in _requestTranslators)
28  ✔  14             {
29  ✓  14  ◑              if (translator.CanHandle(request))
30  ✔   1                 {
31  ✔   1                     return translator.Translate(request);
32                        }
33  ✔  13             }
34            
35  ✔  13             return request;
36  ✔  14         }
37            
38                public CanonicalResponse TranslateResponse(CanonicalResponse response)
39  ✔  11         {
40  ✔  11             var normalized = _toolNormalizer.NormalizeResponse(response);
41  ✔  54  ●          foreach (var translator in _responseTranslators)
42  ✔  11             {
43  ✓  11  ◑              if (translator.CanHandle(normalized))
44  ✔   1                 {
45  ✔   1                     return translator.Translate(normalized);
46                        }
47  ✔  10             }
48            
49  ✔  10             return normalized;
50  ✔  11         }
51            
52                public ChatResponseUpdate TranslateUpdate(ChatResponseUpdate update)
53  ✔   9         {
54  ✔   9             var normalized = _toolNormalizer.NormalizeUpdate(update);
55  ✔  44  ●          foreach (var translator in _streamingTranslators)
56  ✔   9             {
57  ✓   9  ◑              if (translator.CanHandle(normalized))
58  ✔   1                 {
59  ✔   1                     return translator.Translate(normalized);
60                        }
61  ✔   8             }
62            
63  ✔   8             return normalized;
64  ✔   9         }
65            }
```
# Synaxis.InferenceGateway.Infrastructure.AntigravityChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.AntigravityChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 90.7% (138 of 152) |
| Covered lines: | 138 |
| Uncovered lines: | 14 |
| Coverable lines: | 152 |
| Total lines: | 305 |
| **Branch coverage:** | 62.8% (49 of 78) |
| Covered branches: | 49 |
| Total branches: | 78 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **get_Metadata()** | 100% | 2 | 1 | 0% |
| **GetResponseAsync()** | 50.0% | 2 | 2 | 100% |
| **GetStreamingResponseAsync()** | 85.71% | 28 | 28 | 97.95% |
| **PrepareRequestAsync()** | 100% | 1 | 1 | 100% |
| **EnsureSuccessAsync()** | 50.0% | 3 | 2 | 50.0% |
| **BuildRequest(...)** | 53.84% | 27 | 26 | 87.50% |
| **MapResponse(...)** | 50.0% | 16 | 16 | 92.85% |
| **Dispose()** | 100% | 2 | 1 | 0% |
| **GetService(...)** | 0% | 6 | 2 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.IO;
  4            using System.Linq;
  5            using System.Net.Http;
  6            using System.Net.Http.Headers;
  7            using System.Runtime.CompilerServices;
  8            using System.Text;
  9            using System.Text.Json;
 10            using System.Text.Json.Serialization;
 11            using System.Threading;
 12            using System.Threading.Tasks;
 13            using Microsoft.Extensions.AI;
 14            using Synaxis.InferenceGateway.Infrastructure.Auth;
 15            
 16            namespace Synaxis.InferenceGateway.Infrastructure;
 17            
 18            /// <summary>
 19            /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20            /// Implements strict protocol compliance including the wrapper object and custom headers.
 21            /// </summary>
 22            public class AntigravityChatClient : IChatClient
 23            {
 24                private readonly HttpClient _httpClient;
 25                private readonly string _modelId;
 26                private readonly string _projectId;
 27                private readonly ITokenProvider _tokenProvider;
 28                private readonly ChatClientMetadata _metadata;
 29            
 30                // Endpoints are now relative to the configured HttpClient.BaseAddress
 31                private const string EndpointRelative = "/v1/chat/completions";
 32                private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33            
 34  ✔   2         public AntigravityChatClient(
 35  ✔   2             HttpClient httpClient,
 36  ✔   2             string modelId,
 37  ✔   2             string projectId,
 38  ✔   2             ITokenProvider tokenProvider)
 39  ✔   2         {
 40  ✔   2             _httpClient = httpClient;
 41  ✔   2             _modelId = modelId;
 42  ✔   2             _projectId = projectId;
 43  ✔   2             _tokenProvider = tokenProvider;
 44                    // Prefer the configured BaseAddress on the provided HttpClient when available
 45  ✓   2  ◑          _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46  ✔   2         }
 47            
 48  ❌  0         public ChatClientMetadata Metadata => _metadata;
 49            
 50                public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51  ✔   1         {
 52  ✔   1             var messagesList = chatMessages.ToList();
 53  ✔   1             var request = BuildRequest(messagesList, options);
 54  ✔   1             var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55            
 56  ✔   1             using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57  ✔   1             httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58            
 59  ✔   1             await PrepareRequestAsync(httpRequest, cancellationToken);
 60            
 61  ✔   1             using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62  ✔   1             await EnsureSuccessAsync(response);
 63            
 64  ✔   1             var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65  ✔   1             var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66            
 67  ✓   1  ◑          return MapResponse(agResponse?.Response);
 68  ✔   1         }
 69            
 70                public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                    IEnumerable<ChatMessage> chatMessages,
 72                    ChatOptions? options = null,
 73                    [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74  ✔   1         {
 75  ✔   1             var messagesList = chatMessages.ToList();
 76  ✔   1             var request = BuildRequest(messagesList, options);
 77  ✔   1             var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78            
 79  ✔   1             using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80  ✔   1             httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81  ✔   1             httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82            
 83  ✔   1             await PrepareRequestAsync(httpRequest, cancellationToken);
 84            
 85  ✔   1             using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86  ✔   1             await EnsureSuccessAsync(response);
 87            
 88  ✔   1             using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89  ✔   1             using var reader = new StreamReader(stream);
 90            
 91  ✔   5  ●          while (!cancellationToken.IsCancellationRequested)
 92  ✔   5             {
 93  ✔   5                 var line = await reader.ReadLineAsync(cancellationToken);
 94  ✔   5  ●              if (line == null) break; // End of stream
 95  ✔   7  ●              if (string.IsNullOrWhiteSpace(line)) continue;
 96            
 97  ✔   3  ●              if (line.StartsWith("data: "))
 98  ✔   3                 {
 99  ✔   3                     var data = line.Substring(6).Trim();
100  ✔   4  ●                  if (data == "[DONE]") break;
101            
102  ✔   2                     AntigravityResponseWrapper? wrapper = null;
103                            try
104  ✔   2                     {
105  ✔   2                         wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106  ✔   2                     }
107  ❌  0                     catch (JsonException) { /* Ignore malformed lines */ }
108            
109  ✓   2  ◑                  if (wrapper?.Response?.Candidates != null)
110  ✔   2                     {
111  ✔  10  ●                      foreach (var candidate in wrapper.Response.Candidates)
112  ✔   2                         {
113  ✓   2  ◑                          if (candidate.Content?.Parts != null)
114  ✔   2                             {
115  ✔  10  ●                              foreach (var part in candidate.Content.Parts)
116  ✔   2                                 {
117  ✔   2  ●                                  if (!string.IsNullOrEmpty(part.Text))
118  ✔   2                                     {
119  ✓   2  ◑                                      yield return new ChatResponseUpdate
120  ✔   2                                         {
121  ✔   2                                             Role = new ChatRole(candidate.Content.Role ?? "model"),
122  ✔   2                                             Contents = { new TextContent(part.Text) }
123  ✔   2                                         };
124  ✔   2                                     }
125  ✔   2                                 }
126  ✔   2                             }
127  ✔   2                         }
128  ✔   2                     }
129  ✔   2                 }
130  ✔   2             }
131  ✔   1         }
132            
133                private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134  ✔   2         {
135  ✔   2             var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136  ✔   2             request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137            
138                    // Strict Headers required by Antigravity
139  ✔   2             request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140  ✔   2             request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141  ✔   2             request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142  ✔   2         }
143            
144                private async Task EnsureSuccessAsync(HttpResponseMessage response)
145  ✔   2         {
146  ✓   2  ◑          if (!response.IsSuccessStatusCode)
147  ❌  0             {
148  ❌  0                 var error = await response.Content.ReadAsStringAsync();
149  ❌  0                 throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                    }
151  ✔   2         }
152            
153                private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154  ✔   2         {
155  ✔   2             var contentList = new List<Content>();
156  ✔   2             SystemInstruction? systemInstruction = null;
157            
158  ✔  12  ●          foreach (var msg in messages)
159  ✔   3             {
160  ✔   3  ●              if (msg.Role == ChatRole.System)
161  ✔   1                 {
162                            // Antigravity requires system instructions in a separate field, not in contents
163  ✔   1  ●                  if (systemInstruction == null)
164  ✔   1                     {
165  ✔   1                         systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166  ✔   1                     }
167  ✔   1                     systemInstruction.Parts.Add(new Part { Text = msg.Text });
168  ✔   1                 }
169                        else
170  ✔   2                 {
171  ✓   2  ◑                  var role = msg.Role == ChatRole.User ? "user" : "model";
172  ✔   2                     contentList.Add(new Content
173  ✔   2                     {
174  ✔   2                         Role = role,
175  ✔   2                         Parts = new List<Part> { new Part { Text = msg.Text } }
176  ✔   2                     });
177  ✔   2                 }
178  ✔   3             }
179            
180  ✓   2  ◑          var config = new GenerationConfig
181  ✔   2             {
182  ✔   2                 MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183  ✔   2                 Temperature = options?.Temperature ?? 0.7f,
184  ✔   2                 TopP = options?.TopP ?? 0.95f,
185  ✔   2                 StopSequences = options?.StopSequences
186  ✔   2             };
187            
188                    // Handle Thinking Config
189  ✓   2  ◑          if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190  ❌  0             {
191                         // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                         // For now, we'll try to extract budget if present, or default
193  ❌  0  ○               if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194  ❌  0                  {
195                             // Simple extraction logic or default
196  ❌  0                      config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197  ❌  0                  }
198  ❌  0             }
199            
200  ✔   2             return new AntigravityRequest
201  ✔   2             {
202  ✔   2                 Project = _projectId,
203  ✔   2                 Model = _modelId,
204  ✔   2                 RequestPayload = new RequestPayload
205  ✔   2                 {
206  ✔   2                     Contents = contentList,
207  ✔   2                     SystemInstruction = systemInstruction,
208  ✔   2                     GenerationConfig = config
209  ✔   2                 }
210  ✔   2             };
211  ✔   2         }
212            
213                private ChatResponse MapResponse(AntigravityResponse? response)
214  ✔   1         {
215  ✓   1  ◑          if (response?.Candidates == null || response.Candidates.Count == 0)
216  ❌  0                 return new ChatResponse(new List<ChatMessage>());
217            
218  ✔   1             var candidate = response.Candidates[0];
219  ✓   2  ◑          var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220            
221  ✓   1  ◑          return new ChatResponse(new List<ChatMessage>
222  ✔   1             {
223  ✔   1                 new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224  ✔   1             })
225  ✔   1             {
226  ✔   1                 ResponseId = response.ResponseId,
227  ✔   1                 ModelId = response.ModelVersion
228  ✔   1             };
229  ✔   1         }
230            
231                // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232  ❌  0         public void Dispose() { }
233                public object? GetService(Type serviceType, object? serviceKey = null) =>
234  ❌  0  ○          serviceType == typeof(IChatClient) ? this : null;
235            }
236            
237            internal class AntigravityRequest
238            {
239                [JsonPropertyName("project")] public string Project { get; set; } = "";
240                [JsonPropertyName("model")] public string Model { get; set; } = "";
241                [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242            }
243            
244            internal class RequestPayload
245            {
246                [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247                [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248                [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249            }
250            
251            internal class Content
252            {
253                [JsonPropertyName("role")] public string Role { get; set; } = "user";
254                [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255            }
256            
257            internal class SystemInstruction
258            {
259                [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260            }
261            
262            internal class Part
263            {
264                [JsonPropertyName("text")] public string? Text { get; set; }
265            }
266            
267            internal class GenerationConfig
268            {
269                [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270                [JsonPropertyName("temperature")] public float Temperature { get; set; }
271                [JsonPropertyName("topP")] public float TopP { get; set; }
272                [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273                [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274            }
275            
276            internal class ThinkingConfig
277            {
278                [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279                [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280            }
281            
282            internal class AntigravityResponseWrapper
283            {
284                [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285            }
286            
287            internal class AntigravityResponse
288            {
289                [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290                [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291                [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292            }
293            
294            internal class Candidate
295            {
296                [JsonPropertyName("content")] public Content? Content { get; set; }
297                [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298            }
299            
300            [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301            [JsonSerializable(typeof(AntigravityRequest))]
302            [JsonSerializable(typeof(AntigravityResponseWrapper))]
303            internal partial class AntigravityJsonContext : JsonSerializerContext
304            {
305            }
```
# Synaxis.InferenceGateway.Infrastructure.AntigravityJsonContext

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.AntigravityJsonContext |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.AntigravityRequest.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.AntigravityResponse.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.AntigravityResponseWrapper.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Boolean.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Candidate.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Content.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.GenerationConfig.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.GetJsonTypeInfo.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.IListString.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Int32.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ListCandidate.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ListContent.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ListPart.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Part.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.PropertyNames.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.RequestPayload.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Single.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.String.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.SystemInstruction.g.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ThinkingConfig.g.cs |
| **Line coverage:** | 78.2% (879 of 1124) |
| Covered lines: | 879 |
| Uncovered lines: | 245 |
| Coverable lines: | 1124 |
| Total lines: | 1887 |
| **Branch coverage:** | 56% (111 of 198) |
| Covered branches: | 111 |
| Total branches: | 198 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 1 | 1 | 100% |
| **.cctor()** | 100% | 1 | 1 | 100% |
| **GetTypeInfo(...)** | 100% | 2 | 1 | 0% |
| **System.Text.Json.Serialization.Metadata.IJsonTypeInfoResolver.GetTypeInfo(...)** | 97.22% | 36 | 36 | 98.24% |
| **get_AntigravityRequest()** | 100% | 2 | 2 | 100% |
| **get_AntigravityResponse()** | 0% | 6 | 2 | 0% |
| **get_AntigravityResponseWrapper()** | 100% | 2 | 2 | 100% |
| **get_Boolean()** | 0% | 6 | 2 | 0% |
| **get_Candidate()** | 0% | 6 | 2 | 0% |
| **get_Content()** | 0% | 6 | 2 | 0% |
| **get_GenerationConfig()** | 0% | 6 | 2 | 0% |
| **get_IListString()** | 0% | 6 | 2 | 0% |
| **get_Int32()** | 0% | 6 | 2 | 0% |
| **get_ListCandidate()** | 0% | 6 | 2 | 0% |
| **get_ListContent()** | 0% | 6 | 2 | 0% |
| **get_ListPart()** | 0% | 6 | 2 | 0% |
| **get_Part()** | 0% | 6 | 2 | 0% |
| **get_RequestPayload()** | 0% | 6 | 2 | 0% |
| **get_Single()** | 0% | 6 | 2 | 0% |
| **get_String()** | 0% | 6 | 2 | 0% |
| **get_SystemInstruction()** | 0% | 6 | 2 | 0% |
| **get_ThinkingConfig()** | 0% | 6 | 2 | 0% |
| **Create_AntigravityRequest(...)** | 100% | 2 | 2 | 88.88% |
| **Create_AntigravityResponse(...)** | 100% | 2 | 2 | 94.44% |
| **Create_AntigravityResponseWrapper(...)** | 100% | 2 | 2 | 94.44% |
| **Create_Boolean(...)** | 100% | 2 | 2 | 100% |
| **Create_Candidate(...)** | 100% | 2 | 2 | 94.44% |
| **Create_Content(...)** | 100% | 2 | 2 | 94.44% |
| **Create_GenerationConfig(...)** | 100% | 2 | 2 | 88.88% |
| **Create_IListString(...)** | 100% | 2 | 2 | 100% |
| **Create_Int32(...)** | 100% | 2 | 2 | 100% |
| **Create_ListCandidate(...)** | 100% | 2 | 2 | 100% |
| **Create_ListContent(...)** | 100% | 2 | 2 | 92.85% |
| **Create_ListPart(...)** | 100% | 2 | 2 | 100% |
| **Create_Part(...)** | 100% | 2 | 2 | 94.44% |
| **Create_RequestPayload(...)** | 100% | 2 | 2 | 88.88% |
| **Create_Single(...)** | 100% | 2 | 2 | 100% |
| **Create_String(...)** | 100% | 2 | 2 | 100% |
| **Create_SystemInstruction(...)** | 100% | 2 | 2 | 88.88% |
| **Create_ThinkingConfig(...)** | 100% | 2 | 2 | 88.88% |
| **get_Default()** | 100% | 1 | 1 | 100% |
| **get_GeneratedSerializerOptions()** | 100% | 1 | 1 | 100% |
| **.ctor()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **TryGetTypeInfoForRuntimeCustomConverter(...)** | 50.0% | 2 | 2 | 66.66% |
| **IListStringSerializeHandler(...)** | 0% | 20 | 4 | 0% |
| **ListCandidateSerializeHandler(...)** | 0% | 20 | 4 | 0% |
| **ListContentSerializeHandler(...)** | 75.00% | 4 | 4 | 75.00% |
| **ListPartSerializeHandler(...)** | 75.00% | 4 | 4 | 75.00% |
| **AntigravityRequestPropInit(...)** | 100% | 1 | 1 | 85.93% |
| **AntigravityResponsePropInit(...)** | 100% | 1 | 1 | 90.62% |
| **AntigravityResponseWrapperPropInit(...)** | 100% | 1 | 1 | 90.90% |
| **CandidatePropInit(...)** | 100% | 1 | 1 | 90.0% |
| **ContentPropInit(...)** | 100% | 1 | 1 | 90.90% |
| **GenerationConfigPropInit(...)** | 100% | 1 | 1 | 84.04% |
| **PartPropInit(...)** | 100% | 1 | 1 | 90.90% |
| **RequestPayloadPropInit(...)** | 100% | 1 | 1 | 85.48% |
| **SystemInstructionPropInit(...)** | 100% | 1 | 1 | 87.50% |
| **ThinkingConfigPropInit(...)** | 100% | 1 | 1 | 85.00% |
| **GetRuntimeConverterForType(...)** | 16.66% | 14 | 6 | 40.0% |
| **ExpandConverter(...)** | 0% | 110 | 10 | 0% |
| **AntigravityResponseWrapperSerializeHandler(...)** | 0% | 20 | 4 | 0% |
| **PartSerializeHandler(...)** | 75.00% | 4 | 4 | 76.92% |
| **SystemInstructionSerializeHandler(...)** | 75.00% | 4 | 4 | 78.57% |
| **CandidateSerializeHandler(...)** | 0% | 42 | 6 | 0% |
| **ThinkingConfigSerializeHandler(...)** | 0% | 6 | 2 | 0% |
| **ContentSerializeHandler(...)** | 83.33% | 6 | 6 | 84.21% |
| **RequestPayloadSerializeHandler(...)** | 87.50% | 8 | 8 | 88.46% |
| **AntigravityRequestSerializeHandler(...)** | 87.50% | 8 | 8 | 87.50% |
| **AntigravityResponseSerializeHandler(...)** | 0% | 72 | 8 | 0% |
| **GenerationConfigSerializeHandler(...)** | 50.0% | 10 | 6 | 52.17% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.AntigravityRequest.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.AntigravityRequest.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.AntigravityResponse.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.AntigravityResponse.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.AntigravityResponseWrapper.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.AntigravityResponseWrapper.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Boolean.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Boolean.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Candidate.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Candidate.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Content.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Content.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.GenerationConfig.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.GenerationConfig.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.GetJsonTypeInfo.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.GetJsonTypeInfo.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.IListString.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.IListString.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Int32.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Int32.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ListCandidate.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ListCandidate.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ListContent.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ListContent.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ListPart.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ListPart.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Part.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Part.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.PropertyNames.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.PropertyNames.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.RequestPayload.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.RequestPayload.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Single.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.Single.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.String.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.String.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.SystemInstruction.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.SystemInstruction.g.cs' does not exist (any more).

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ThinkingConfig.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/obj/Debug/net10.0/System.Text.Json.SourceGeneration/System.Text.Json.SourceGeneration.JsonSourceGenerator/AntigravityJsonContext.ThinkingConfig.g.cs' does not exist (any more).

# Synaxis.InferenceGateway.Infrastructure.AntigravityRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.AntigravityRequest |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Project()** | 100% | 1 | 1 | 100% |
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_RequestPayload()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.IO;
  4           using System.Linq;
  5           using System.Net.Http;
  6           using System.Net.Http.Headers;
  7           using System.Runtime.CompilerServices;
  8           using System.Text;
  9           using System.Text.Json;
 10           using System.Text.Json.Serialization;
 11           using System.Threading;
 12           using System.Threading.Tasks;
 13           using Microsoft.Extensions.AI;
 14           using Synaxis.InferenceGateway.Infrastructure.Auth;
 15           
 16           namespace Synaxis.InferenceGateway.Infrastructure;
 17           
 18           /// <summary>
 19           /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20           /// Implements strict protocol compliance including the wrapper object and custom headers.
 21           /// </summary>
 22           public class AntigravityChatClient : IChatClient
 23           {
 24               private readonly HttpClient _httpClient;
 25               private readonly string _modelId;
 26               private readonly string _projectId;
 27               private readonly ITokenProvider _tokenProvider;
 28               private readonly ChatClientMetadata _metadata;
 29           
 30               // Endpoints are now relative to the configured HttpClient.BaseAddress
 31               private const string EndpointRelative = "/v1/chat/completions";
 32               private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33           
 34               public AntigravityChatClient(
 35                   HttpClient httpClient,
 36                   string modelId,
 37                   string projectId,
 38                   ITokenProvider tokenProvider)
 39               {
 40                   _httpClient = httpClient;
 41                   _modelId = modelId;
 42                   _projectId = projectId;
 43                   _tokenProvider = tokenProvider;
 44                   // Prefer the configured BaseAddress on the provided HttpClient when available
 45                   _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46               }
 47           
 48               public ChatClientMetadata Metadata => _metadata;
 49           
 50               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51               {
 52                   var messagesList = chatMessages.ToList();
 53                   var request = BuildRequest(messagesList, options);
 54                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55           
 56                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58           
 59                   await PrepareRequestAsync(httpRequest, cancellationToken);
 60           
 61                   using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                   await EnsureSuccessAsync(response);
 63           
 64                   var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                   var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66           
 67                   return MapResponse(agResponse?.Response);
 68               }
 69           
 70               public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                   IEnumerable<ChatMessage> chatMessages,
 72                   ChatOptions? options = null,
 73                   [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74               {
 75                   var messagesList = chatMessages.ToList();
 76                   var request = BuildRequest(messagesList, options);
 77                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78           
 79                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                   httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82           
 83                   await PrepareRequestAsync(httpRequest, cancellationToken);
 84           
 85                   using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                   await EnsureSuccessAsync(response);
 87           
 88                   using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                   using var reader = new StreamReader(stream);
 90           
 91                   while (!cancellationToken.IsCancellationRequested)
 92                   {
 93                       var line = await reader.ReadLineAsync(cancellationToken);
 94                       if (line == null) break; // End of stream
 95                       if (string.IsNullOrWhiteSpace(line)) continue;
 96           
 97                       if (line.StartsWith("data: "))
 98                       {
 99                           var data = line.Substring(6).Trim();
100                           if (data == "[DONE]") break;
101           
102                           AntigravityResponseWrapper? wrapper = null;
103                           try
104                           {
105                               wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                           }
107                           catch (JsonException) { /* Ignore malformed lines */ }
108           
109                           if (wrapper?.Response?.Candidates != null)
110                           {
111                               foreach (var candidate in wrapper.Response.Candidates)
112                               {
113                                   if (candidate.Content?.Parts != null)
114                                   {
115                                       foreach (var part in candidate.Content.Parts)
116                                       {
117                                           if (!string.IsNullOrEmpty(part.Text))
118                                           {
119                                               yield return new ChatResponseUpdate
120                                               {
121                                                   Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                   Contents = { new TextContent(part.Text) }
123                                               };
124                                           }
125                                       }
126                                   }
127                               }
128                           }
129                       }
130                   }
131               }
132           
133               private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134               {
135                   var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                   request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137           
138                   // Strict Headers required by Antigravity
139                   request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                   request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                   request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142               }
143           
144               private async Task EnsureSuccessAsync(HttpResponseMessage response)
145               {
146                   if (!response.IsSuccessStatusCode)
147                   {
148                       var error = await response.Content.ReadAsStringAsync();
149                       throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                   }
151               }
152           
153               private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154               {
155                   var contentList = new List<Content>();
156                   SystemInstruction? systemInstruction = null;
157           
158                   foreach (var msg in messages)
159                   {
160                       if (msg.Role == ChatRole.System)
161                       {
162                           // Antigravity requires system instructions in a separate field, not in contents
163                           if (systemInstruction == null)
164                           {
165                               systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                           }
167                           systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                       }
169                       else
170                       {
171                           var role = msg.Role == ChatRole.User ? "user" : "model";
172                           contentList.Add(new Content
173                           {
174                               Role = role,
175                               Parts = new List<Part> { new Part { Text = msg.Text } }
176                           });
177                       }
178                   }
179           
180                   var config = new GenerationConfig
181                   {
182                       MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                       Temperature = options?.Temperature ?? 0.7f,
184                       TopP = options?.TopP ?? 0.95f,
185                       StopSequences = options?.StopSequences
186                   };
187           
188                   // Handle Thinking Config
189                   if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                   {
191                        // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                        // For now, we'll try to extract budget if present, or default
193                        if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                        {
195                            // Simple extraction logic or default
196                            config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                        }
198                   }
199           
200                   return new AntigravityRequest
201                   {
202                       Project = _projectId,
203                       Model = _modelId,
204                       RequestPayload = new RequestPayload
205                       {
206                           Contents = contentList,
207                           SystemInstruction = systemInstruction,
208                           GenerationConfig = config
209                       }
210                   };
211               }
212           
213               private ChatResponse MapResponse(AntigravityResponse? response)
214               {
215                   if (response?.Candidates == null || response.Candidates.Count == 0)
216                       return new ChatResponse(new List<ChatMessage>());
217           
218                   var candidate = response.Candidates[0];
219                   var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220           
221                   return new ChatResponse(new List<ChatMessage>
222                   {
223                       new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                   })
225                   {
226                       ResponseId = response.ResponseId,
227                       ModelId = response.ModelVersion
228                   };
229               }
230           
231               // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232               public void Dispose() { }
233               public object? GetService(Type serviceType, object? serviceKey = null) =>
234                   serviceType == typeof(IChatClient) ? this : null;
235           }
236           
237           internal class AntigravityRequest
238           {
239  ✔  6         [JsonPropertyName("project")] public string Project { get; set; } = "";
240  ✔  6         [JsonPropertyName("model")] public string Model { get; set; } = "";
241  ✔  6         [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242           }
243           
244           internal class RequestPayload
245           {
246               [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247               [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248               [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249           }
250           
251           internal class Content
252           {
253               [JsonPropertyName("role")] public string Role { get; set; } = "user";
254               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255           }
256           
257           internal class SystemInstruction
258           {
259               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260           }
261           
262           internal class Part
263           {
264               [JsonPropertyName("text")] public string? Text { get; set; }
265           }
266           
267           internal class GenerationConfig
268           {
269               [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270               [JsonPropertyName("temperature")] public float Temperature { get; set; }
271               [JsonPropertyName("topP")] public float TopP { get; set; }
272               [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273               [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274           }
275           
276           internal class ThinkingConfig
277           {
278               [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279               [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280           }
281           
282           internal class AntigravityResponseWrapper
283           {
284               [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285           }
286           
287           internal class AntigravityResponse
288           {
289               [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290               [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291               [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292           }
293           
294           internal class Candidate
295           {
296               [JsonPropertyName("content")] public Content? Content { get; set; }
297               [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298           }
299           
300           [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301           [JsonSerializable(typeof(AntigravityRequest))]
302           [JsonSerializable(typeof(AntigravityResponseWrapper))]
303           internal partial class AntigravityJsonContext : JsonSerializerContext
304           {
305           }
```
# Synaxis.InferenceGateway.Infrastructure.AntigravityResponse

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.AntigravityResponse |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Candidates()** | 100% | 1 | 1 | 100% |
| **get_ModelVersion()** | 100% | 1 | 1 | 100% |
| **get_ResponseId()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.IO;
  4            using System.Linq;
  5            using System.Net.Http;
  6            using System.Net.Http.Headers;
  7            using System.Runtime.CompilerServices;
  8            using System.Text;
  9            using System.Text.Json;
 10            using System.Text.Json.Serialization;
 11            using System.Threading;
 12            using System.Threading.Tasks;
 13            using Microsoft.Extensions.AI;
 14            using Synaxis.InferenceGateway.Infrastructure.Auth;
 15            
 16            namespace Synaxis.InferenceGateway.Infrastructure;
 17            
 18            /// <summary>
 19            /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20            /// Implements strict protocol compliance including the wrapper object and custom headers.
 21            /// </summary>
 22            public class AntigravityChatClient : IChatClient
 23            {
 24                private readonly HttpClient _httpClient;
 25                private readonly string _modelId;
 26                private readonly string _projectId;
 27                private readonly ITokenProvider _tokenProvider;
 28                private readonly ChatClientMetadata _metadata;
 29            
 30                // Endpoints are now relative to the configured HttpClient.BaseAddress
 31                private const string EndpointRelative = "/v1/chat/completions";
 32                private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33            
 34                public AntigravityChatClient(
 35                    HttpClient httpClient,
 36                    string modelId,
 37                    string projectId,
 38                    ITokenProvider tokenProvider)
 39                {
 40                    _httpClient = httpClient;
 41                    _modelId = modelId;
 42                    _projectId = projectId;
 43                    _tokenProvider = tokenProvider;
 44                    // Prefer the configured BaseAddress on the provided HttpClient when available
 45                    _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46                }
 47            
 48                public ChatClientMetadata Metadata => _metadata;
 49            
 50                public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51                {
 52                    var messagesList = chatMessages.ToList();
 53                    var request = BuildRequest(messagesList, options);
 54                    var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55            
 56                    using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                    httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58            
 59                    await PrepareRequestAsync(httpRequest, cancellationToken);
 60            
 61                    using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                    await EnsureSuccessAsync(response);
 63            
 64                    var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                    var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66            
 67                    return MapResponse(agResponse?.Response);
 68                }
 69            
 70                public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                    IEnumerable<ChatMessage> chatMessages,
 72                    ChatOptions? options = null,
 73                    [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74                {
 75                    var messagesList = chatMessages.ToList();
 76                    var request = BuildRequest(messagesList, options);
 77                    var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78            
 79                    using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                    httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                    httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82            
 83                    await PrepareRequestAsync(httpRequest, cancellationToken);
 84            
 85                    using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                    await EnsureSuccessAsync(response);
 87            
 88                    using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                    using var reader = new StreamReader(stream);
 90            
 91                    while (!cancellationToken.IsCancellationRequested)
 92                    {
 93                        var line = await reader.ReadLineAsync(cancellationToken);
 94                        if (line == null) break; // End of stream
 95                        if (string.IsNullOrWhiteSpace(line)) continue;
 96            
 97                        if (line.StartsWith("data: "))
 98                        {
 99                            var data = line.Substring(6).Trim();
100                            if (data == "[DONE]") break;
101            
102                            AntigravityResponseWrapper? wrapper = null;
103                            try
104                            {
105                                wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                            }
107                            catch (JsonException) { /* Ignore malformed lines */ }
108            
109                            if (wrapper?.Response?.Candidates != null)
110                            {
111                                foreach (var candidate in wrapper.Response.Candidates)
112                                {
113                                    if (candidate.Content?.Parts != null)
114                                    {
115                                        foreach (var part in candidate.Content.Parts)
116                                        {
117                                            if (!string.IsNullOrEmpty(part.Text))
118                                            {
119                                                yield return new ChatResponseUpdate
120                                                {
121                                                    Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                    Contents = { new TextContent(part.Text) }
123                                                };
124                                            }
125                                        }
126                                    }
127                                }
128                            }
129                        }
130                    }
131                }
132            
133                private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134                {
135                    var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137            
138                    // Strict Headers required by Antigravity
139                    request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                    request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                    request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142                }
143            
144                private async Task EnsureSuccessAsync(HttpResponseMessage response)
145                {
146                    if (!response.IsSuccessStatusCode)
147                    {
148                        var error = await response.Content.ReadAsStringAsync();
149                        throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                    }
151                }
152            
153                private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154                {
155                    var contentList = new List<Content>();
156                    SystemInstruction? systemInstruction = null;
157            
158                    foreach (var msg in messages)
159                    {
160                        if (msg.Role == ChatRole.System)
161                        {
162                            // Antigravity requires system instructions in a separate field, not in contents
163                            if (systemInstruction == null)
164                            {
165                                systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                            }
167                            systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                        }
169                        else
170                        {
171                            var role = msg.Role == ChatRole.User ? "user" : "model";
172                            contentList.Add(new Content
173                            {
174                                Role = role,
175                                Parts = new List<Part> { new Part { Text = msg.Text } }
176                            });
177                        }
178                    }
179            
180                    var config = new GenerationConfig
181                    {
182                        MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                        Temperature = options?.Temperature ?? 0.7f,
184                        TopP = options?.TopP ?? 0.95f,
185                        StopSequences = options?.StopSequences
186                    };
187            
188                    // Handle Thinking Config
189                    if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                    {
191                         // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                         // For now, we'll try to extract budget if present, or default
193                         if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                         {
195                             // Simple extraction logic or default
196                             config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                         }
198                    }
199            
200                    return new AntigravityRequest
201                    {
202                        Project = _projectId,
203                        Model = _modelId,
204                        RequestPayload = new RequestPayload
205                        {
206                            Contents = contentList,
207                            SystemInstruction = systemInstruction,
208                            GenerationConfig = config
209                        }
210                    };
211                }
212            
213                private ChatResponse MapResponse(AntigravityResponse? response)
214                {
215                    if (response?.Candidates == null || response.Candidates.Count == 0)
216                        return new ChatResponse(new List<ChatMessage>());
217            
218                    var candidate = response.Candidates[0];
219                    var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220            
221                    return new ChatResponse(new List<ChatMessage>
222                    {
223                        new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                    })
225                    {
226                        ResponseId = response.ResponseId,
227                        ModelId = response.ModelVersion
228                    };
229                }
230            
231                // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232                public void Dispose() { }
233                public object? GetService(Type serviceType, object? serviceKey = null) =>
234                    serviceType == typeof(IChatClient) ? this : null;
235            }
236            
237            internal class AntigravityRequest
238            {
239                [JsonPropertyName("project")] public string Project { get; set; } = "";
240                [JsonPropertyName("model")] public string Model { get; set; } = "";
241                [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242            }
243            
244            internal class RequestPayload
245            {
246                [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247                [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248                [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249            }
250            
251            internal class Content
252            {
253                [JsonPropertyName("role")] public string Role { get; set; } = "user";
254                [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255            }
256            
257            internal class SystemInstruction
258            {
259                [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260            }
261            
262            internal class Part
263            {
264                [JsonPropertyName("text")] public string? Text { get; set; }
265            }
266            
267            internal class GenerationConfig
268            {
269                [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270                [JsonPropertyName("temperature")] public float Temperature { get; set; }
271                [JsonPropertyName("topP")] public float TopP { get; set; }
272                [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273                [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274            }
275            
276            internal class ThinkingConfig
277            {
278                [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279                [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280            }
281            
282            internal class AntigravityResponseWrapper
283            {
284                [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285            }
286            
287            internal class AntigravityResponse
288            {
289  ✔  13         [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290  ✔   5         [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291  ✔   5         [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292            }
293            
294            internal class Candidate
295            {
296                [JsonPropertyName("content")] public Content? Content { get; set; }
297                [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298            }
299            
300            [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301            [JsonSerializable(typeof(AntigravityRequest))]
302            [JsonSerializable(typeof(AntigravityResponseWrapper))]
303            internal partial class AntigravityJsonContext : JsonSerializerContext
304            {
305            }
```
# Synaxis.InferenceGateway.Infrastructure.AntigravityResponseWrapper

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.AntigravityResponseWrapper |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Response()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.IO;
  4           using System.Linq;
  5           using System.Net.Http;
  6           using System.Net.Http.Headers;
  7           using System.Runtime.CompilerServices;
  8           using System.Text;
  9           using System.Text.Json;
 10           using System.Text.Json.Serialization;
 11           using System.Threading;
 12           using System.Threading.Tasks;
 13           using Microsoft.Extensions.AI;
 14           using Synaxis.InferenceGateway.Infrastructure.Auth;
 15           
 16           namespace Synaxis.InferenceGateway.Infrastructure;
 17           
 18           /// <summary>
 19           /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20           /// Implements strict protocol compliance including the wrapper object and custom headers.
 21           /// </summary>
 22           public class AntigravityChatClient : IChatClient
 23           {
 24               private readonly HttpClient _httpClient;
 25               private readonly string _modelId;
 26               private readonly string _projectId;
 27               private readonly ITokenProvider _tokenProvider;
 28               private readonly ChatClientMetadata _metadata;
 29           
 30               // Endpoints are now relative to the configured HttpClient.BaseAddress
 31               private const string EndpointRelative = "/v1/chat/completions";
 32               private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33           
 34               public AntigravityChatClient(
 35                   HttpClient httpClient,
 36                   string modelId,
 37                   string projectId,
 38                   ITokenProvider tokenProvider)
 39               {
 40                   _httpClient = httpClient;
 41                   _modelId = modelId;
 42                   _projectId = projectId;
 43                   _tokenProvider = tokenProvider;
 44                   // Prefer the configured BaseAddress on the provided HttpClient when available
 45                   _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46               }
 47           
 48               public ChatClientMetadata Metadata => _metadata;
 49           
 50               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51               {
 52                   var messagesList = chatMessages.ToList();
 53                   var request = BuildRequest(messagesList, options);
 54                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55           
 56                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58           
 59                   await PrepareRequestAsync(httpRequest, cancellationToken);
 60           
 61                   using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                   await EnsureSuccessAsync(response);
 63           
 64                   var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                   var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66           
 67                   return MapResponse(agResponse?.Response);
 68               }
 69           
 70               public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                   IEnumerable<ChatMessage> chatMessages,
 72                   ChatOptions? options = null,
 73                   [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74               {
 75                   var messagesList = chatMessages.ToList();
 76                   var request = BuildRequest(messagesList, options);
 77                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78           
 79                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                   httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82           
 83                   await PrepareRequestAsync(httpRequest, cancellationToken);
 84           
 85                   using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                   await EnsureSuccessAsync(response);
 87           
 88                   using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                   using var reader = new StreamReader(stream);
 90           
 91                   while (!cancellationToken.IsCancellationRequested)
 92                   {
 93                       var line = await reader.ReadLineAsync(cancellationToken);
 94                       if (line == null) break; // End of stream
 95                       if (string.IsNullOrWhiteSpace(line)) continue;
 96           
 97                       if (line.StartsWith("data: "))
 98                       {
 99                           var data = line.Substring(6).Trim();
100                           if (data == "[DONE]") break;
101           
102                           AntigravityResponseWrapper? wrapper = null;
103                           try
104                           {
105                               wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                           }
107                           catch (JsonException) { /* Ignore malformed lines */ }
108           
109                           if (wrapper?.Response?.Candidates != null)
110                           {
111                               foreach (var candidate in wrapper.Response.Candidates)
112                               {
113                                   if (candidate.Content?.Parts != null)
114                                   {
115                                       foreach (var part in candidate.Content.Parts)
116                                       {
117                                           if (!string.IsNullOrEmpty(part.Text))
118                                           {
119                                               yield return new ChatResponseUpdate
120                                               {
121                                                   Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                   Contents = { new TextContent(part.Text) }
123                                               };
124                                           }
125                                       }
126                                   }
127                               }
128                           }
129                       }
130                   }
131               }
132           
133               private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134               {
135                   var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                   request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137           
138                   // Strict Headers required by Antigravity
139                   request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                   request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                   request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142               }
143           
144               private async Task EnsureSuccessAsync(HttpResponseMessage response)
145               {
146                   if (!response.IsSuccessStatusCode)
147                   {
148                       var error = await response.Content.ReadAsStringAsync();
149                       throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                   }
151               }
152           
153               private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154               {
155                   var contentList = new List<Content>();
156                   SystemInstruction? systemInstruction = null;
157           
158                   foreach (var msg in messages)
159                   {
160                       if (msg.Role == ChatRole.System)
161                       {
162                           // Antigravity requires system instructions in a separate field, not in contents
163                           if (systemInstruction == null)
164                           {
165                               systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                           }
167                           systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                       }
169                       else
170                       {
171                           var role = msg.Role == ChatRole.User ? "user" : "model";
172                           contentList.Add(new Content
173                           {
174                               Role = role,
175                               Parts = new List<Part> { new Part { Text = msg.Text } }
176                           });
177                       }
178                   }
179           
180                   var config = new GenerationConfig
181                   {
182                       MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                       Temperature = options?.Temperature ?? 0.7f,
184                       TopP = options?.TopP ?? 0.95f,
185                       StopSequences = options?.StopSequences
186                   };
187           
188                   // Handle Thinking Config
189                   if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                   {
191                        // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                        // For now, we'll try to extract budget if present, or default
193                        if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                        {
195                            // Simple extraction logic or default
196                            config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                        }
198                   }
199           
200                   return new AntigravityRequest
201                   {
202                       Project = _projectId,
203                       Model = _modelId,
204                       RequestPayload = new RequestPayload
205                       {
206                           Contents = contentList,
207                           SystemInstruction = systemInstruction,
208                           GenerationConfig = config
209                       }
210                   };
211               }
212           
213               private ChatResponse MapResponse(AntigravityResponse? response)
214               {
215                   if (response?.Candidates == null || response.Candidates.Count == 0)
216                       return new ChatResponse(new List<ChatMessage>());
217           
218                   var candidate = response.Candidates[0];
219                   var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220           
221                   return new ChatResponse(new List<ChatMessage>
222                   {
223                       new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                   })
225                   {
226                       ResponseId = response.ResponseId,
227                       ModelId = response.ModelVersion
228                   };
229               }
230           
231               // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232               public void Dispose() { }
233               public object? GetService(Type serviceType, object? serviceKey = null) =>
234                   serviceType == typeof(IChatClient) ? this : null;
235           }
236           
237           internal class AntigravityRequest
238           {
239               [JsonPropertyName("project")] public string Project { get; set; } = "";
240               [JsonPropertyName("model")] public string Model { get; set; } = "";
241               [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242           }
243           
244           internal class RequestPayload
245           {
246               [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247               [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248               [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249           }
250           
251           internal class Content
252           {
253               [JsonPropertyName("role")] public string Role { get; set; } = "user";
254               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255           }
256           
257           internal class SystemInstruction
258           {
259               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260           }
261           
262           internal class Part
263           {
264               [JsonPropertyName("text")] public string? Text { get; set; }
265           }
266           
267           internal class GenerationConfig
268           {
269               [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270               [JsonPropertyName("temperature")] public float Temperature { get; set; }
271               [JsonPropertyName("topP")] public float TopP { get; set; }
272               [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273               [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274           }
275           
276           internal class ThinkingConfig
277           {
278               [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279               [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280           }
281           
282           internal class AntigravityResponseWrapper
283           {
284  ✔  8         [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285           }
286           
287           internal class AntigravityResponse
288           {
289               [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290               [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291               [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292           }
293           
294           internal class Candidate
295           {
296               [JsonPropertyName("content")] public Content? Content { get; set; }
297               [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298           }
299           
300           [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301           [JsonSerializable(typeof(AntigravityRequest))]
302           [JsonSerializable(typeof(AntigravityResponseWrapper))]
303           internal partial class AntigravityJsonContext : JsonSerializerContext
304           {
305           }
```
# Synaxis.InferenceGateway.Infrastructure.Auth.AccountInfo

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Auth.AccountInfo |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Auth/IAntigravityAuthManager.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 13 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Email()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Auth/IAntigravityAuthManager.cs
```
 1            using System.Collections.Generic;
 2            using System.Threading.Tasks;
 3            
 4            namespace Synaxis.InferenceGateway.Infrastructure.Auth;
 5            
 6  ✔  14     public record AccountInfo(string Email, bool IsActive);
 7            
 8            public interface IAntigravityAuthManager : ITokenProvider
 9            {
10                IEnumerable<AccountInfo> ListAccounts();
11                string StartAuthFlow(string redirectUrl);
12                Task CompleteAuthFlowAsync(string code, string redirectUrl, string? state = null);
13            }
```
# Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAccount

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAccount |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Auth/AntigravityAuthManager.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 579 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Email()** | 100% | 1 | 1 | 100% |
| **get_ProjectId()** | 100% | 1 | 1 | 100% |
| **get_Token()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Auth/AntigravityAuthManager.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.IO;
  4            using System.Linq;
  5            using System.Net.Http;
  6            using System.Net.Http.Headers;
  7            using System.Security.Cryptography;
  8            using System.Text;
  9            using System.Text.Json;
 10            using System.Text.Json.Serialization;
 11            using System.Threading;
 12            using System.Threading.Tasks;
 13            using Google.Apis.Auth.OAuth2.Responses;
 14            using Microsoft.Extensions.Logging;
 15            using Synaxis.InferenceGateway.Application.Configuration;
 16            
 17            namespace Synaxis.InferenceGateway.Infrastructure.Auth;
 18            
 19            public class AntigravityAccount
 20            {
 21  ✔  16         public string Email { get; set; } = string.Empty;
 22  ✔  10         public string ProjectId { get; set; } = string.Empty;
 23  ✔  20         public TokenResponse Token { get; set; } = new();
 24            }
 25            
 26            /// <summary>
 27            /// Manages authentication for Antigravity, supporting multiple accounts, load balancing, and headless flows.
 28            /// </summary>
 29            public class AntigravityAuthManager : IAntigravityAuthManager
 30            {
 31                private readonly ILogger<AntigravityAuthManager> _logger;
 32                private readonly ITokenStore _tokenStore;
 33                private readonly string _projectId;
 34                private readonly IHttpClientFactory _httpClientFactory;
 35                private readonly AntigravitySettings _settings;
 36            
 37                private const string AuthorizationEndpoint = "https://accounts.google.com/o/oauth2/v2/auth";
 38                private const string TokenEndpoint = "https://oauth2.googleapis.com/token";
 39                private const string UserInfoEndpoint = "https://www.googleapis.com/oauth2/v1/userinfo?alt=json";
 40                private const string DefaultProjectId = "rising-fact-p41fc";
 41                private static readonly string[] Scopes = {
 42                    "https://www.googleapis.com/auth/cloud-platform",
 43                    "https://www.googleapis.com/auth/userinfo.email",
 44                    "https://www.googleapis.com/auth/userinfo.profile",
 45                    "https://www.googleapis.com/auth/cclog",
 46                    "https://www.googleapis.com/auth/experimentsandconfigs"
 47                };
 48                private static readonly string[] LoadEndpoints =
 49                {
 50                    "https://cloudcode-pa.googleapis.com",
 51                    "https://daily-cloudcode-pa.sandbox.googleapis.com",
 52                    "https://autopush-cloudcode-pa.sandbox.googleapis.com"
 53                };
 54            
 55                private static readonly string[] FallbackEndpoints =
 56                {
 57                    "https://daily-cloudcode-pa.sandbox.googleapis.com",
 58                    "https://autopush-cloudcode-pa.sandbox.googleapis.com",
 59                    "https://cloudcode-pa.googleapis.com"
 60                };
 61            
 62                private List<AntigravityAccount> _accounts = new();
 63                private readonly SemaphoreSlim _authLock = new(1, 1);
 64                private int _requestCount = 0;
 65            
 66                // New constructor that accepts a token store
 67                public AntigravityAuthManager(
 68                    string projectId,
 69                    AntigravitySettings settings,
 70                    ILogger<AntigravityAuthManager> logger,
 71                    IHttpClientFactory httpClientFactory,
 72                    ITokenStore tokenStore)
 73                {
 74                    _projectId = projectId;
 75                    _settings = settings;
 76                    _logger = logger;
 77                    _httpClientFactory = httpClientFactory;
 78                    _tokenStore = tokenStore ?? throw new ArgumentNullException(nameof(tokenStore));
 79            
 80                    if (string.IsNullOrWhiteSpace(_settings.ClientId) || string.IsNullOrWhiteSpace(_settings.ClientSecret))
 81                    {
 82                        throw new InvalidOperationException("Antigravity ClientId and ClientSecret must be configured.");
 83                    }
 84                }
 85            
 86                // Backwards-compatible constructor that accepts a storage path and creates a FileTokenStore
 87                public AntigravityAuthManager(
 88                    string projectId,
 89                    string authStoragePath,
 90                    AntigravitySettings settings,
 91                    ILogger<AntigravityAuthManager> logger,
 92                    IHttpClientFactory httpClientFactory)
 93                    : this(projectId, settings, logger, httpClientFactory, new FileTokenStore(authStoragePath, Microsoft.Extensions.
 94                {
 95                }
 96            
 97                public async Task<string> GetTokenAsync(CancellationToken cancellationToken = default)
 98                {
 99                    await _authLock.WaitAsync(cancellationToken);
100                    try
101                    {
102                        if (_accounts.Count == 0)
103                        {
104                            var loaded = await _tokenStore.LoadAsync();
105                            if (loaded?.Count > 0)
106                            {
107                                _accounts = loaded;
108                            }
109                        }
110            
111                        // Check for Env Var Refresh Token (Transient Account)
112                        var envRefreshToken = Environment.GetEnvironmentVariable("ANTIGRAVITY_REFRESH_TOKEN");
113                        if (!string.IsNullOrWhiteSpace(envRefreshToken) && !_accounts.Any(a => a.Token.RefreshToken == envRefreshTok
114                        {
115                            var parsed = ParseRefreshToken(envRefreshToken);
116                            _logger.LogInformation("Injecting transient account from environment variable.");
117                            _accounts.Add(new AntigravityAccount
118                            {
119                                Email = "env-var-user@system",
120                                ProjectId = parsed.ProjectId,
121                                Token = new TokenResponse { RefreshToken = parsed.RefreshToken, ExpiresInSeconds = 0, IssuedUtc = Da
122                            });
123                        }
124            
125                        if (_accounts.Count == 0)
126                        {
127                            _logger.LogInformation("No accounts found. Starting interactive login.");
128                            // For CLI usage, we can still trigger interactive login if no accounts exist
129                            // But for API usage, this might just fail until an account is added via API
130                            // We'll try interactive as a fallback for local dev convenience
131                            try
132                            {
133                                // This will block if run in a non-interactive console without input redirection
134                                // In a pure API scenario, this might timeout or throw
135                                await InteractiveLoginAsync(cancellationToken);
136                            }
137                            catch (Exception ex)
138                            {
139                                _logger.LogWarning(ex, "Interactive login failed or was cancelled. Please add an account via API.");
140                                throw new InvalidOperationException("No authenticated accounts available. Please add an account via 
141                            }
142                        }
143            
144                        if (_accounts.Count == 0) throw new InvalidOperationException("Authentication failed.");
145            
146                        // Round-Robin Selection
147                        var index = Interlocked.Increment(ref _requestCount) % _accounts.Count;
148                        if (index < 0) index = -index; // Handle overflow
149                        var account = _accounts[index];
150            
151                        // Check Expiry & Refresh
152                        if (account.Token.IsStale)
153                        {
154                            _logger.LogInformation("Refreshing token for {Email}...", account.Email);
155                            await RefreshAccountTokenAsync(account, cancellationToken);
156                        }
157            
158                        return account.Token.AccessToken;
159                    }
160                    finally
161                    {
162                        _authLock.Release();
163                    }
164                }
165            
166                public IEnumerable<AccountInfo> ListAccounts()
167                {
168                    // Thread-safe read (copy list reference)
169                    var accounts = _accounts.ToList();
170                    return accounts.Select(a => new AccountInfo(a.Email, !a.Token.IsStale));
171                }
172            
173                public string StartAuthFlow(string redirectUrl)
174                {
175                    var verifier = GenerateCodeVerifier();
176                    var challenge = GenerateCodeChallenge(verifier);
177                    var state = EncodeState(new PkceState { Verifier = verifier, ProjectId = _projectId });
178                    return BuildAuthorizationUrl(redirectUrl, challenge, state);
179                }
180            
181                public async Task CompleteAuthFlowAsync(string code, string redirectUrl, string? state = null)
182                {
183                    await _authLock.WaitAsync();
184                    try
185                    {
186                        if (string.IsNullOrWhiteSpace(code))
187                        {
188                            throw new InvalidOperationException("Authorization code is required.");
189                        }
190            
191                        if (string.IsNullOrWhiteSpace(state))
192                        {
193                            throw new InvalidOperationException("Missing OAuth state. Start with /antigravity/auth/start and use the
194                        }
195            
196                        var pkceState = DecodeState(state);
197                        var token = await ExchangeCodeForTokenAsync(code, redirectUrl, pkceState.Verifier, CancellationToken.None);
198                        var email = await FetchUserEmailAsync(token.AccessToken, CancellationToken.None);
199                        if (string.IsNullOrWhiteSpace(email))
200                        {
201                            email = "unknown@user";
202                        }
203            
204                        var projectId = pkceState.ProjectId;
205                        if (string.IsNullOrWhiteSpace(projectId))
206                        {
207                            projectId = await FetchProjectIdAsync(token.AccessToken, CancellationToken.None);
208                        }
209            
210                        if (string.IsNullOrWhiteSpace(projectId))
211                        {
212                            projectId = DefaultProjectId;
213                        }
214            
215                        // Update or Add
216                        var existing = _accounts.FirstOrDefault(a => a.Email == email);
217                        if (existing != null)
218                        {
219                            existing.Token = token;
220                            existing.ProjectId = projectId;
221                            _logger.LogInformation("Updated token for {Email}", email);
222                        }
223                        else
224                        {
225                            _accounts.Add(new AntigravityAccount { Email = email, ProjectId = projectId, Token = token });
226                            _logger.LogInformation("Added new account: {Email}", email);
227                        }
228            
229                            await _tokenStore.SaveAsync(_accounts);
230                    }
231                    finally
232                    {
233                        _authLock.Release();
234                    }
235                }
236            
237                private async Task RefreshAccountTokenAsync(AntigravityAccount account, CancellationToken cancellationToken)
238                {
239                    if (string.IsNullOrWhiteSpace(account.Token.RefreshToken))
240                    {
241                        throw new InvalidOperationException("Missing refresh token for account.");
242                    }
243            
244                    var newToken = await RefreshTokenAsync(account.Token.RefreshToken, cancellationToken);
245                    if (string.IsNullOrWhiteSpace(newToken.RefreshToken))
246                    {
247                        newToken.RefreshToken = account.Token.RefreshToken;
248                    }
249            
250                    account.Token = newToken;
251                    // We don't necessarily need to save on every refresh (performance), but it's safer to do so
252                    // to persist the new access token/expiry.
253                    await _tokenStore.SaveAsync(_accounts);
254                }
255            
256                // Legacy Interactive Login (kept for CLI convenience)
257                private async Task InteractiveLoginAsync(CancellationToken cancellationToken)
258                {
259                    var redirectUri = "http://localhost:51121/oauth/antigravity/callback";
260                    var url = StartAuthFlow(redirectUri);
261            
262                    Console.WriteLine("----------------------------------------------------------------");
263                    Console.WriteLine("ANTIGRAVITY AUTHENTICATION REQUIRED");
264                    Console.WriteLine("----------------------------------------------------------------");
265                    Console.WriteLine("1. Visit this URL in your browser:");
266                    Console.WriteLine(url);
267                    Console.WriteLine("");
268                    Console.WriteLine("2. Log in with your Google Account.");
269                    Console.WriteLine("3. Copy the full redirect URL after login (it contains code and state).");
270                    Console.WriteLine("----------------------------------------------------------------");
271                    Console.Write("Paste redirect URL here: ");
272            
273                    var codeOrUrl = await Task.Run(() => Console.ReadLine(), cancellationToken);
274            
275                    if (string.IsNullOrWhiteSpace(codeOrUrl))
276                    {
277                        throw new InvalidOperationException("No code provided.");
278                    }
279            
280                    var (code, state) = ParseCallbackUrl(codeOrUrl);
281                    if (string.IsNullOrWhiteSpace(code) || string.IsNullOrWhiteSpace(state))
282                    {
283                        throw new InvalidOperationException("The redirect URL must include both code and state parameters.");
284                    }
285            
286                    await CompleteAuthFlowAsync(code, redirectUri, state);
287                }
288            
289                private string BuildAuthorizationUrl(string redirectUrl, string codeChallenge, string state)
290                {
291                    var parameters = new Dictionary<string, string>
292                    {
293                        ["client_id"] = _settings.ClientId,
294                        ["response_type"] = "code",
295                        ["redirect_uri"] = redirectUrl,
296                        ["scope"] = string.Join(" ", Scopes),
297                        ["code_challenge"] = codeChallenge,
298                        ["code_challenge_method"] = "S256",
299                        ["state"] = state,
300                        ["access_type"] = "offline",
301                        ["prompt"] = "consent"
302                    };
303            
304                    return $"{AuthorizationEndpoint}?{BuildQueryString(parameters)}";
305                }
306            
307                private static string BuildQueryString(IDictionary<string, string> parameters)
308                {
309                    return string.Join("&", parameters.Select(kvp => $"{Uri.EscapeDataString(kvp.Key)}={Uri.EscapeDataString(kvp.Val
310                }
311            
312                private static string GenerateCodeVerifier()
313                {
314                    var bytes = new byte[32];
315                    RandomNumberGenerator.Fill(bytes);
316                    return Base64UrlEncode(bytes);
317                }
318            
319                private static string GenerateCodeChallenge(string verifier)
320                {
321                    var bytes = Encoding.ASCII.GetBytes(verifier);
322                    var hash = SHA256.HashData(bytes);
323                    return Base64UrlEncode(hash);
324                }
325            
326                private static string EncodeState(PkceState state)
327                {
328                    var json = JsonSerializer.Serialize(state);
329                    return Base64UrlEncode(Encoding.UTF8.GetBytes(json));
330                }
331            
332                private static PkceState DecodeState(string state)
333                {
334                    var json = Encoding.UTF8.GetString(Base64UrlDecode(state));
335                    var parsed = JsonSerializer.Deserialize<PkceState>(json);
336                    if (parsed == null || string.IsNullOrWhiteSpace(parsed.Verifier))
337                    {
338                        throw new InvalidOperationException("Missing PKCE verifier in state.");
339                    }
340            
341                    parsed.ProjectId ??= string.Empty;
342                    return parsed;
343                }
344            
345                private static string Base64UrlEncode(byte[] bytes)
346                {
347                    return Convert.ToBase64String(bytes)
348                        .TrimEnd('=')
349                        .Replace('+', '-')
350                        .Replace('/', '_');
351                }
352            
353                private static byte[] Base64UrlDecode(string input)
354                {
355                    var normalized = input.Replace('-', '+').Replace('_', '/');
356                    var padded = normalized.PadRight(normalized.Length + (4 - normalized.Length % 4) % 4, '=');
357                    return Convert.FromBase64String(padded);
358                }
359            
360                private async Task<TokenResponse> ExchangeCodeForTokenAsync(
361                    string code,
362                    string redirectUrl,
363                    string verifier,
364                    CancellationToken cancellationToken)
365                {
366                    using var httpClient = CreateHttpClient();
367                    using var content = new FormUrlEncodedContent(new Dictionary<string, string>
368                    {
369                        ["client_id"] = _settings.ClientId,
370                        ["client_secret"] = _settings.ClientSecret,
371                        ["code"] = code,
372                        ["grant_type"] = "authorization_code",
373                        ["redirect_uri"] = redirectUrl,
374                        ["code_verifier"] = verifier
375                    });
376            
377                    using var response = await httpClient.PostAsync(TokenEndpoint, content, cancellationToken);
378                    var payload = await response.Content.ReadAsStringAsync(cancellationToken);
379                    if (!response.IsSuccessStatusCode)
380                    {
381                        throw new InvalidOperationException($"Token exchange failed: {payload}");
382                    }
383            
384                    var tokenPayload = JsonSerializer.Deserialize<TokenPayload>(payload);
385                    if (tokenPayload == null || string.IsNullOrWhiteSpace(tokenPayload.AccessToken))
386                    {
387                        throw new InvalidOperationException("Token exchange failed: missing access token.");
388                    }
389            
390                    if (string.IsNullOrWhiteSpace(tokenPayload.RefreshToken))
391                    {
392                        throw new InvalidOperationException("Token exchange failed: missing refresh token.");
393                    }
394            
395                    return new TokenResponse
396                    {
397                        AccessToken = tokenPayload.AccessToken,
398                        RefreshToken = tokenPayload.RefreshToken,
399                        ExpiresInSeconds = tokenPayload.ExpiresIn,
400                        IssuedUtc = DateTime.UtcNow
401                    };
402                }
403            
404                private async Task<TokenResponse> RefreshTokenAsync(string refreshToken, CancellationToken cancellationToken)
405                {
406                    using var httpClient = CreateHttpClient();
407                    using var content = new FormUrlEncodedContent(new Dictionary<string, string>
408                    {
409                        ["client_id"] = _settings.ClientId,
410                        ["client_secret"] = _settings.ClientSecret,
411                        ["refresh_token"] = refreshToken,
412                        ["grant_type"] = "refresh_token"
413                    });
414            
415                    using var response = await httpClient.PostAsync(TokenEndpoint, content, cancellationToken);
416                    var payload = await response.Content.ReadAsStringAsync(cancellationToken);
417                    if (!response.IsSuccessStatusCode)
418                    {
419                        throw new InvalidOperationException($"Token refresh failed: {payload}");
420                    }
421            
422                    var tokenPayload = JsonSerializer.Deserialize<TokenPayload>(payload);
423                    if (tokenPayload == null || string.IsNullOrWhiteSpace(tokenPayload.AccessToken))
424                    {
425                        throw new InvalidOperationException("Token refresh failed: missing access token.");
426                    }
427            
428                    return new TokenResponse
429                    {
430                        AccessToken = tokenPayload.AccessToken,
431                        RefreshToken = tokenPayload.RefreshToken ?? refreshToken,
432                        ExpiresInSeconds = tokenPayload.ExpiresIn,
433                        IssuedUtc = DateTime.UtcNow
434                    };
435                }
436            
437                private async Task<string> FetchUserEmailAsync(string accessToken, CancellationToken cancellationToken)
438                {
439                    using var httpClient = CreateHttpClient();
440                    using var request = new HttpRequestMessage(HttpMethod.Get, UserInfoEndpoint);
441                    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
442            
443                    using var response = await httpClient.SendAsync(request, cancellationToken);
444                    if (!response.IsSuccessStatusCode)
445                    {
446                        return string.Empty;
447                    }
448            
449                    var payload = await response.Content.ReadAsStringAsync(cancellationToken);
450                    var userInfo = JsonSerializer.Deserialize<UserInfoPayload>(payload);
451                    return userInfo?.Email ?? string.Empty;
452                }
453            
454                private async Task<string> FetchProjectIdAsync(string accessToken, CancellationToken cancellationToken)
455                {
456                    var loadHeaders = new Dictionary<string, string>
457                    {
458                        ["Authorization"] = $"Bearer {accessToken}",
459                        ["Content-Type"] = "application/json",
460                        ["User-Agent"] = "google-api-nodejs-client/9.15.1",
461                        ["X-Goog-Api-Client"] = "google-cloud-sdk vscode_cloudshelleditor/0.1",
462                        ["Client-Metadata"] = "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLATFORM_UNSPECIFIED\",\"pluginType\"
463                    };
464            
465                    var endpoints = LoadEndpoints.Concat(FallbackEndpoints).Distinct().ToArray();
466                    foreach (var endpoint in endpoints)
467                    {
468                        var url = $"{endpoint}/v1internal:loadCodeAssist";
469                        try
470                        {
471                            using var httpClient = CreateHttpClient();
472                            using var request = new HttpRequestMessage(HttpMethod.Post, url);
473                            foreach (var header in loadHeaders)
474                            {
475                                if (header.Key == "Authorization")
476                                {
477                                    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
478                                }
479                                else
480                                {
481                                    request.Headers.TryAddWithoutValidation(header.Key, header.Value);
482                                }
483                            }
484            
485                            request.Content = new StringContent(
486                                "{\"metadata\":{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLATFORM_UNSPECIFIED\",\"pluginType\"
487                                Encoding.UTF8,
488                                "application/json");
489            
490                            using var response = await httpClient.SendAsync(request, cancellationToken);
491                            if (!response.IsSuccessStatusCode)
492                            {
493                                continue;
494                            }
495            
496                            var payload = await response.Content.ReadAsStringAsync(cancellationToken);
497                            var projectId = ExtractProjectId(payload);
498                            if (!string.IsNullOrWhiteSpace(projectId))
499                            {
500                                return projectId;
501                            }
502                        }
503                        catch (Exception ex)
504                        {
505                            _logger.LogWarning(ex, "Failed to resolve project ID from {Endpoint}", endpoint);
506                        }
507                    }
508            
509                    return string.Empty;
510                }
511            
512                private static string ExtractProjectId(string payload)
513                {
514                    try
515                    {
516                        using var doc = JsonDocument.Parse(payload);
517                        if (doc.RootElement.TryGetProperty("cloudaicompanionProject", out var projectElement))
518                        {
519                            if (projectElement.ValueKind == JsonValueKind.String)
520                            {
521                                return projectElement.GetString() ?? string.Empty;
522                            }
523            
524                            if (projectElement.ValueKind == JsonValueKind.Object && projectElement.TryGetProperty("id", out var idEl
525                            {
526                                return idElement.GetString() ?? string.Empty;
527                            }
528                        }
529                    }
530                    catch (JsonException)
531                    {
532                    }
533            
534                    return string.Empty;
535                }
536            
537                private static (string RefreshToken, string ProjectId) ParseRefreshToken(string refreshToken)
538                {
539                    var separatorIndex = refreshToken.IndexOf('|');
540                    if (separatorIndex <= 0)
541                    {
542                        return (refreshToken, string.Empty);
543                    }
544            
545                    var token = refreshToken.Substring(0, separatorIndex);
546                    var projectId = refreshToken.Substring(separatorIndex + 1);
547                    return (token, projectId);
548                }
549            
550                private static (string Code, string State) ParseCallbackUrl(string callbackUrl)
551                {
552                    var uri = new Uri(callbackUrl);
553                    var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
554                    return (query["code"] ?? string.Empty, query["state"] ?? string.Empty);
555                }
556            
557                private HttpClient CreateHttpClient()
558                {
559                    return _httpClientFactory.CreateClient("Antigravity");
560                }
561            
562                private sealed class PkceState
563                {
564                    [JsonPropertyName("verifier")] public string Verifier { get; set; } = string.Empty;
565                    [JsonPropertyName("projectId")] public string? ProjectId { get; set; }
566                }
567            
568                private sealed class TokenPayload
569                {
570                    [JsonPropertyName("access_token")] public string AccessToken { get; set; } = string.Empty;
571                    [JsonPropertyName("expires_in")] public int ExpiresIn { get; set; }
572                    [JsonPropertyName("refresh_token")] public string? RefreshToken { get; set; }
573                }
574            
575                private sealed class UserInfoPayload
576                {
577                    [JsonPropertyName("email")] public string? Email { get; set; }
578                }
579            }
```
# Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Auth.AntigravityAuthManager |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Auth/AntigravityAuthManager.cs |
| **Line coverage:** | 22.5% (87 of 385) |
| Covered lines: | 87 |
| Uncovered lines: | 298 |
| Coverable lines: | 385 |
| Total lines: | 579 |
| **Branch coverage:** | 17.6% (18 of 102) |
| Covered branches: | 18 |
| Total branches: | 102 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 50.0% | 6 | 6 | 89.47% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **GetTokenAsync()** | 80.0% | 25 | 20 | 76.59% |
| **ListAccounts()** | 100% | 1 | 1 | 100% |
| **StartAuthFlow(...)** | 100% | 2 | 1 | 0% |
| **CompleteAuthFlowAsync()** | 0% | 210 | 14 | 0% |
| **RefreshAccountTokenAsync()** | 25.00% | 11 | 4 | 25.00% |
| **InteractiveLoginAsync()** | 0% | 42 | 6 | 0% |
| **BuildAuthorizationUrl(...)** | 100% | 2 | 1 | 0% |
| **BuildQueryString(...)** | 100% | 2 | 1 | 0% |
| **GenerateCodeVerifier()** | 100% | 2 | 1 | 0% |
| **GenerateCodeChallenge(...)** | 100% | 2 | 1 | 0% |
| **EncodeState(...)** | 100% | 2 | 1 | 0% |
| **DecodeState(...)** | 0% | 42 | 6 | 0% |
| **Base64UrlEncode(...)** | 100% | 2 | 1 | 0% |
| **Base64UrlDecode(...)** | 100% | 2 | 1 | 0% |
| **ExchangeCodeForTokenAsync()** | 0% | 72 | 8 | 0% |
| **RefreshTokenAsync()** | 12.50% | 14 | 8 | 53.84% |
| **FetchUserEmailAsync()** | 0% | 42 | 6 | 0% |
| **FetchProjectIdAsync()** | 0% | 110 | 10 | 0% |
| **ExtractProjectId(...)** | 0% | 156 | 12 | 0% |
| **ParseRefreshToken(...)** | 50.0% | 2 | 2 | 66.66% |
| **ParseCallbackUrl(...)** | 0% | 20 | 4 | 0% |
| **CreateHttpClient()** | 100% | 1 | 1 | 100% |
| **get_Verifier()** | 100% | 2 | 1 | 0% |
| **get_ProjectId()** | 100% | 2 | 1 | 0% |
| **get_AccessToken()** | 100% | 2 | 1 | 0% |
| **get_ExpiresIn()** | 100% | 2 | 1 | 0% |
| **get_RefreshToken()** | 100% | 2 | 1 | 0% |
| **get_Email()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Auth/AntigravityAuthManager.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.IO;
  4           using System.Linq;
  5           using System.Net.Http;
  6           using System.Net.Http.Headers;
  7           using System.Security.Cryptography;
  8           using System.Text;
  9           using System.Text.Json;
 10           using System.Text.Json.Serialization;
 11           using System.Threading;
 12           using System.Threading.Tasks;
 13           using Google.Apis.Auth.OAuth2.Responses;
 14           using Microsoft.Extensions.Logging;
 15           using Synaxis.InferenceGateway.Application.Configuration;
 16           
 17           namespace Synaxis.InferenceGateway.Infrastructure.Auth;
 18           
 19           public class AntigravityAccount
 20           {
 21               public string Email { get; set; } = string.Empty;
 22               public string ProjectId { get; set; } = string.Empty;
 23               public TokenResponse Token { get; set; } = new();
 24           }
 25           
 26           /// <summary>
 27           /// Manages authentication for Antigravity, supporting multiple accounts, load balancing, and headless flows.
 28           /// </summary>
 29           public class AntigravityAuthManager : IAntigravityAuthManager
 30           {
 31               private readonly ILogger<AntigravityAuthManager> _logger;
 32               private readonly ITokenStore _tokenStore;
 33               private readonly string _projectId;
 34               private readonly IHttpClientFactory _httpClientFactory;
 35               private readonly AntigravitySettings _settings;
 36           
 37               private const string AuthorizationEndpoint = "https://accounts.google.com/o/oauth2/v2/auth";
 38               private const string TokenEndpoint = "https://oauth2.googleapis.com/token";
 39               private const string UserInfoEndpoint = "https://www.googleapis.com/oauth2/v1/userinfo?alt=json";
 40               private const string DefaultProjectId = "rising-fact-p41fc";
 41  ❌ 0         private static readonly string[] Scopes = {
 42  ❌ 0             "https://www.googleapis.com/auth/cloud-platform",
 43  ❌ 0             "https://www.googleapis.com/auth/userinfo.email",
 44  ❌ 0             "https://www.googleapis.com/auth/userinfo.profile",
 45  ❌ 0             "https://www.googleapis.com/auth/cclog",
 46  ❌ 0             "https://www.googleapis.com/auth/experimentsandconfigs"
 47  ❌ 0         };
 48  ❌ 0         private static readonly string[] LoadEndpoints =
 49  ❌ 0         {
 50  ❌ 0             "https://cloudcode-pa.googleapis.com",
 51  ❌ 0             "https://daily-cloudcode-pa.sandbox.googleapis.com",
 52  ❌ 0             "https://autopush-cloudcode-pa.sandbox.googleapis.com"
 53  ❌ 0         };
 54           
 55  ❌ 0         private static readonly string[] FallbackEndpoints =
 56  ❌ 0         {
 57  ❌ 0             "https://daily-cloudcode-pa.sandbox.googleapis.com",
 58  ❌ 0             "https://autopush-cloudcode-pa.sandbox.googleapis.com",
 59  ❌ 0             "https://cloudcode-pa.googleapis.com"
 60  ❌ 0         };
 61           
 62  ✔  2         private List<AntigravityAccount> _accounts = new();
 63  ✔  2         private readonly SemaphoreSlim _authLock = new(1, 1);
 64  ✔  2         private int _requestCount = 0;
 65           
 66               // New constructor that accepts a token store
 67  ✔  2         public AntigravityAuthManager(
 68  ✔  2             string projectId,
 69  ✔  2             AntigravitySettings settings,
 70  ✔  2             ILogger<AntigravityAuthManager> logger,
 71  ✔  2             IHttpClientFactory httpClientFactory,
 72  ✔  2             ITokenStore tokenStore)
 73  ✔  2         {
 74  ✔  2             _projectId = projectId;
 75  ✔  2             _settings = settings;
 76  ✔  2             _logger = logger;
 77  ✔  2             _httpClientFactory = httpClientFactory;
 78  ✓  2  ◑          _tokenStore = tokenStore ?? throw new ArgumentNullException(nameof(tokenStore));
 79           
 80  ✓  2  ◑          if (string.IsNullOrWhiteSpace(_settings.ClientId) || string.IsNullOrWhiteSpace(_settings.ClientSecret))
 81  ❌ 0             {
 82  ❌ 0                 throw new InvalidOperationException("Antigravity ClientId and ClientSecret must be configured.");
 83                   }
 84  ✔  2         }
 85           
 86               // Backwards-compatible constructor that accepts a storage path and creates a FileTokenStore
 87               public AntigravityAuthManager(
 88                   string projectId,
 89                   string authStoragePath,
 90                   AntigravitySettings settings,
 91                   ILogger<AntigravityAuthManager> logger,
 92                   IHttpClientFactory httpClientFactory)
 93  ✔  2             : this(projectId, settings, logger, httpClientFactory, new FileTokenStore(authStoragePath, Microsoft.Extensions.
 94  ✔  2         {
 95  ✔  2         }
 96           
 97               public async Task<string> GetTokenAsync(CancellationToken cancellationToken = default)
 98  ✔  2  ●      {
 99  ✔  2             await _authLock.WaitAsync(cancellationToken);
100                   try
101  ✔  2             {
102  ✔  2  ●              if (_accounts.Count == 0)
103  ✔  2                 {
104  ✔  2                     var loaded = await _tokenStore.LoadAsync();
105  ✓  2  ◑                  if (loaded?.Count > 0)
106  ✔  1                     {
107  ✔  1                         _accounts = loaded;
108  ✔  1                     }
109  ✔  2                 }
110           
111                       // Check for Env Var Refresh Token (Transient Account)
112  ✔  2                 var envRefreshToken = Environment.GetEnvironmentVariable("ANTIGRAVITY_REFRESH_TOKEN");
113  ✔  2                 if (!string.IsNullOrWhiteSpace(envRefreshToken) && !_accounts.Any(a => a.Token.RefreshToken == envRefreshTok
114  ✔  1                 {
115  ✔  1                     var parsed = ParseRefreshToken(envRefreshToken);
116  ✔  1                     _logger.LogInformation("Injecting transient account from environment variable.");
117  ✔  1                     _accounts.Add(new AntigravityAccount
118  ✔  1                     {
119  ✔  1                         Email = "env-var-user@system",
120  ✔  1                         ProjectId = parsed.ProjectId,
121  ✔  1                         Token = new TokenResponse { RefreshToken = parsed.RefreshToken, ExpiresInSeconds = 0, IssuedUtc = Da
122  ✔  1                     });
123  ✔  1                 }
124           
125  ✓  2  ◑              if (_accounts.Count == 0)
126  ❌ 0                 {
127  ❌ 0                     _logger.LogInformation("No accounts found. Starting interactive login.");
128                           // For CLI usage, we can still trigger interactive login if no accounts exist
129                           // But for API usage, this might just fail until an account is added via API
130                           // We'll try interactive as a fallback for local dev convenience
131                           try
132  ❌ 0                     {
133                               // This will block if run in a non-interactive console without input redirection
134                               // In a pure API scenario, this might timeout or throw
135  ❌ 0                         await InteractiveLoginAsync(cancellationToken);
136  ❌ 0                     }
137  ❌ 0                     catch (Exception ex)
138  ❌ 0                     {
139  ❌ 0                         _logger.LogWarning(ex, "Interactive login failed or was cancelled. Please add an account via API.");
140  ❌ 0                         throw new InvalidOperationException("No authenticated accounts available. Please add an account via 
141                           }
142  ❌ 0                 }
143           
144  ✓  2  ◑              if (_accounts.Count == 0) throw new InvalidOperationException("Authentication failed.");
145           
146                       // Round-Robin Selection
147  ✔  2                 var index = Interlocked.Increment(ref _requestCount) % _accounts.Count;
148  ✓  2  ◑              if (index < 0) index = -index; // Handle overflow
149  ✔  2                 var account = _accounts[index];
150           
151                       // Check Expiry & Refresh
152  ✔  2  ●              if (account.Token.IsStale)
153  ✔  1                 {
154  ✔  1                     _logger.LogInformation("Refreshing token for {Email}...", account.Email);
155  ✔  1                     await RefreshAccountTokenAsync(account, cancellationToken);
156  ❌ 0                 }
157           
158  ✔  1                 return account.Token.AccessToken;
159                   }
160                   finally
161  ✔  2             {
162  ✔  2                 _authLock.Release();
163  ✔  2             }
164  ✔  1         }
165           
166               public IEnumerable<AccountInfo> ListAccounts()
167  ✔  2         {
168                   // Thread-safe read (copy list reference)
169  ✔  2             var accounts = _accounts.ToList();
170  ✔  5             return accounts.Select(a => new AccountInfo(a.Email, !a.Token.IsStale));
171  ✔  2         }
172           
173               public string StartAuthFlow(string redirectUrl)
174  ❌ 0         {
175  ❌ 0             var verifier = GenerateCodeVerifier();
176  ❌ 0             var challenge = GenerateCodeChallenge(verifier);
177  ❌ 0             var state = EncodeState(new PkceState { Verifier = verifier, ProjectId = _projectId });
178  ❌ 0             return BuildAuthorizationUrl(redirectUrl, challenge, state);
179  ❌ 0         }
180           
181               public async Task CompleteAuthFlowAsync(string code, string redirectUrl, string? state = null)
182  ❌ 0  ○      {
183  ❌ 0             await _authLock.WaitAsync();
184                   try
185  ❌ 0             {
186  ❌ 0  ○              if (string.IsNullOrWhiteSpace(code))
187  ❌ 0                 {
188  ❌ 0                     throw new InvalidOperationException("Authorization code is required.");
189                       }
190           
191  ❌ 0  ○              if (string.IsNullOrWhiteSpace(state))
192  ❌ 0                 {
193  ❌ 0                     throw new InvalidOperationException("Missing OAuth state. Start with /antigravity/auth/start and use the
194                       }
195           
196  ❌ 0                 var pkceState = DecodeState(state);
197  ❌ 0                 var token = await ExchangeCodeForTokenAsync(code, redirectUrl, pkceState.Verifier, CancellationToken.None);
198  ❌ 0                 var email = await FetchUserEmailAsync(token.AccessToken, CancellationToken.None);
199  ❌ 0  ○              if (string.IsNullOrWhiteSpace(email))
200  ❌ 0                 {
201  ❌ 0                     email = "unknown@user";
202  ❌ 0                 }
203           
204  ❌ 0                 var projectId = pkceState.ProjectId;
205  ❌ 0  ○              if (string.IsNullOrWhiteSpace(projectId))
206  ❌ 0                 {
207  ❌ 0                     projectId = await FetchProjectIdAsync(token.AccessToken, CancellationToken.None);
208  ❌ 0                 }
209           
210  ❌ 0  ○              if (string.IsNullOrWhiteSpace(projectId))
211  ❌ 0                 {
212  ❌ 0                     projectId = DefaultProjectId;
213  ❌ 0                 }
214           
215                       // Update or Add
216  ❌ 0                 var existing = _accounts.FirstOrDefault(a => a.Email == email);
217  ❌ 0  ○              if (existing != null)
218  ❌ 0                 {
219  ❌ 0                     existing.Token = token;
220  ❌ 0                     existing.ProjectId = projectId;
221  ❌ 0                     _logger.LogInformation("Updated token for {Email}", email);
222  ❌ 0                 }
223                       else
224  ❌ 0                 {
225  ❌ 0                     _accounts.Add(new AntigravityAccount { Email = email, ProjectId = projectId, Token = token });
226  ❌ 0                     _logger.LogInformation("Added new account: {Email}", email);
227  ❌ 0                 }
228           
229  ❌ 0                     await _tokenStore.SaveAsync(_accounts);
230  ❌ 0             }
231                   finally
232  ❌ 0             {
233  ❌ 0                 _authLock.Release();
234  ❌ 0             }
235  ❌ 0         }
236           
237               private async Task RefreshAccountTokenAsync(AntigravityAccount account, CancellationToken cancellationToken)
238  ✔  1         {
239  ✓  1  ◑          if (string.IsNullOrWhiteSpace(account.Token.RefreshToken))
240  ❌ 0             {
241  ❌ 0                 throw new InvalidOperationException("Missing refresh token for account.");
242                   }
243           
244  ✔  1             var newToken = await RefreshTokenAsync(account.Token.RefreshToken, cancellationToken);
245  ❌ 0  ○          if (string.IsNullOrWhiteSpace(newToken.RefreshToken))
246  ❌ 0             {
247  ❌ 0                 newToken.RefreshToken = account.Token.RefreshToken;
248  ❌ 0             }
249           
250  ❌ 0             account.Token = newToken;
251                   // We don't necessarily need to save on every refresh (performance), but it's safer to do so
252                   // to persist the new access token/expiry.
253  ❌ 0             await _tokenStore.SaveAsync(_accounts);
254  ❌ 0         }
255           
256               // Legacy Interactive Login (kept for CLI convenience)
257               private async Task InteractiveLoginAsync(CancellationToken cancellationToken)
258  ❌ 0         {
259  ❌ 0             var redirectUri = "http://localhost:51121/oauth/antigravity/callback";
260  ❌ 0             var url = StartAuthFlow(redirectUri);
261           
262  ❌ 0             Console.WriteLine("----------------------------------------------------------------");
263  ❌ 0             Console.WriteLine("ANTIGRAVITY AUTHENTICATION REQUIRED");
264  ❌ 0             Console.WriteLine("----------------------------------------------------------------");
265  ❌ 0             Console.WriteLine("1. Visit this URL in your browser:");
266  ❌ 0             Console.WriteLine(url);
267  ❌ 0             Console.WriteLine("");
268  ❌ 0             Console.WriteLine("2. Log in with your Google Account.");
269  ❌ 0             Console.WriteLine("3. Copy the full redirect URL after login (it contains code and state).");
270  ❌ 0             Console.WriteLine("----------------------------------------------------------------");
271  ❌ 0             Console.Write("Paste redirect URL here: ");
272           
273  ❌ 0             var codeOrUrl = await Task.Run(() => Console.ReadLine(), cancellationToken);
274           
275  ❌ 0  ○          if (string.IsNullOrWhiteSpace(codeOrUrl))
276  ❌ 0             {
277  ❌ 0                 throw new InvalidOperationException("No code provided.");
278                   }
279           
280  ❌ 0             var (code, state) = ParseCallbackUrl(codeOrUrl);
281  ❌ 0  ○          if (string.IsNullOrWhiteSpace(code) || string.IsNullOrWhiteSpace(state))
282  ❌ 0             {
283  ❌ 0                 throw new InvalidOperationException("The redirect URL must include both code and state parameters.");
284                   }
285           
286  ❌ 0             await CompleteAuthFlowAsync(code, redirectUri, state);
287  ❌ 0         }
288           
289               private string BuildAuthorizationUrl(string redirectUrl, string codeChallenge, string state)
290  ❌ 0         {
291  ❌ 0             var parameters = new Dictionary<string, string>
292  ❌ 0             {
293  ❌ 0                 ["client_id"] = _settings.ClientId,
294  ❌ 0                 ["response_type"] = "code",
295  ❌ 0                 ["redirect_uri"] = redirectUrl,
296  ❌ 0                 ["scope"] = string.Join(" ", Scopes),
297  ❌ 0                 ["code_challenge"] = codeChallenge,
298  ❌ 0                 ["code_challenge_method"] = "S256",
299  ❌ 0                 ["state"] = state,
300  ❌ 0                 ["access_type"] = "offline",
301  ❌ 0                 ["prompt"] = "consent"
302  ❌ 0             };
303           
304  ❌ 0             return $"{AuthorizationEndpoint}?{BuildQueryString(parameters)}";
305  ❌ 0         }
306           
307               private static string BuildQueryString(IDictionary<string, string> parameters)
308  ❌ 0         {
309  ❌ 0             return string.Join("&", parameters.Select(kvp => $"{Uri.EscapeDataString(kvp.Key)}={Uri.EscapeDataString(kvp.Val
310  ❌ 0         }
311           
312               private static string GenerateCodeVerifier()
313  ❌ 0         {
314  ❌ 0             var bytes = new byte[32];
315  ❌ 0             RandomNumberGenerator.Fill(bytes);
316  ❌ 0             return Base64UrlEncode(bytes);
317  ❌ 0         }
318           
319               private static string GenerateCodeChallenge(string verifier)
320  ❌ 0         {
321  ❌ 0             var bytes = Encoding.ASCII.GetBytes(verifier);
322  ❌ 0             var hash = SHA256.HashData(bytes);
323  ❌ 0             return Base64UrlEncode(hash);
324  ❌ 0         }
325           
326               private static string EncodeState(PkceState state)
327  ❌ 0         {
328  ❌ 0             var json = JsonSerializer.Serialize(state);
329  ❌ 0             return Base64UrlEncode(Encoding.UTF8.GetBytes(json));
330  ❌ 0         }
331           
332               private static PkceState DecodeState(string state)
333  ❌ 0         {
334  ❌ 0             var json = Encoding.UTF8.GetString(Base64UrlDecode(state));
335  ❌ 0             var parsed = JsonSerializer.Deserialize<PkceState>(json);
336  ❌ 0  ○          if (parsed == null || string.IsNullOrWhiteSpace(parsed.Verifier))
337  ❌ 0             {
338  ❌ 0                 throw new InvalidOperationException("Missing PKCE verifier in state.");
339                   }
340           
341  ❌ 0  ○          parsed.ProjectId ??= string.Empty;
342  ❌ 0             return parsed;
343  ❌ 0         }
344           
345               private static string Base64UrlEncode(byte[] bytes)
346  ❌ 0         {
347  ❌ 0             return Convert.ToBase64String(bytes)
348  ❌ 0                 .TrimEnd('=')
349  ❌ 0                 .Replace('+', '-')
350  ❌ 0                 .Replace('/', '_');
351  ❌ 0         }
352           
353               private static byte[] Base64UrlDecode(string input)
354  ❌ 0         {
355  ❌ 0             var normalized = input.Replace('-', '+').Replace('_', '/');
356  ❌ 0             var padded = normalized.PadRight(normalized.Length + (4 - normalized.Length % 4) % 4, '=');
357  ❌ 0             return Convert.FromBase64String(padded);
358  ❌ 0         }
359           
360               private async Task<TokenResponse> ExchangeCodeForTokenAsync(
361                   string code,
362                   string redirectUrl,
363                   string verifier,
364                   CancellationToken cancellationToken)
365  ❌ 0         {
366  ❌ 0             using var httpClient = CreateHttpClient();
367  ❌ 0             using var content = new FormUrlEncodedContent(new Dictionary<string, string>
368  ❌ 0             {
369  ❌ 0                 ["client_id"] = _settings.ClientId,
370  ❌ 0                 ["client_secret"] = _settings.ClientSecret,
371  ❌ 0                 ["code"] = code,
372  ❌ 0                 ["grant_type"] = "authorization_code",
373  ❌ 0                 ["redirect_uri"] = redirectUrl,
374  ❌ 0                 ["code_verifier"] = verifier
375  ❌ 0             });
376           
377  ❌ 0             using var response = await httpClient.PostAsync(TokenEndpoint, content, cancellationToken);
378  ❌ 0             var payload = await response.Content.ReadAsStringAsync(cancellationToken);
379  ❌ 0  ○          if (!response.IsSuccessStatusCode)
380  ❌ 0             {
381  ❌ 0                 throw new InvalidOperationException($"Token exchange failed: {payload}");
382                   }
383           
384  ❌ 0             var tokenPayload = JsonSerializer.Deserialize<TokenPayload>(payload);
385  ❌ 0  ○          if (tokenPayload == null || string.IsNullOrWhiteSpace(tokenPayload.AccessToken))
386  ❌ 0             {
387  ❌ 0                 throw new InvalidOperationException("Token exchange failed: missing access token.");
388                   }
389           
390  ❌ 0  ○          if (string.IsNullOrWhiteSpace(tokenPayload.RefreshToken))
391  ❌ 0             {
392  ❌ 0                 throw new InvalidOperationException("Token exchange failed: missing refresh token.");
393                   }
394           
395  ❌ 0             return new TokenResponse
396  ❌ 0             {
397  ❌ 0                 AccessToken = tokenPayload.AccessToken,
398  ❌ 0                 RefreshToken = tokenPayload.RefreshToken,
399  ❌ 0                 ExpiresInSeconds = tokenPayload.ExpiresIn,
400  ❌ 0                 IssuedUtc = DateTime.UtcNow
401  ❌ 0             };
402  ❌ 0         }
403           
404               private async Task<TokenResponse> RefreshTokenAsync(string refreshToken, CancellationToken cancellationToken)
405  ✔  1         {
406  ✔  1             using var httpClient = CreateHttpClient();
407  ✔  1             using var content = new FormUrlEncodedContent(new Dictionary<string, string>
408  ✔  1             {
409  ✔  1                 ["client_id"] = _settings.ClientId,
410  ✔  1                 ["client_secret"] = _settings.ClientSecret,
411  ✔  1                 ["refresh_token"] = refreshToken,
412  ✔  1                 ["grant_type"] = "refresh_token"
413  ✔  1             });
414           
415  ✔  1             using var response = await httpClient.PostAsync(TokenEndpoint, content, cancellationToken);
416  ✔  1             var payload = await response.Content.ReadAsStringAsync(cancellationToken);
417  ✓  1  ◑          if (!response.IsSuccessStatusCode)
418  ✔  1             {
419  ✔  1                 throw new InvalidOperationException($"Token refresh failed: {payload}");
420                   }
421           
422  ❌ 0             var tokenPayload = JsonSerializer.Deserialize<TokenPayload>(payload);
423  ❌ 0  ○          if (tokenPayload == null || string.IsNullOrWhiteSpace(tokenPayload.AccessToken))
424  ❌ 0             {
425  ❌ 0                 throw new InvalidOperationException("Token refresh failed: missing access token.");
426                   }
427           
428  ❌ 0  ○          return new TokenResponse
429  ❌ 0             {
430  ❌ 0                 AccessToken = tokenPayload.AccessToken,
431  ❌ 0                 RefreshToken = tokenPayload.RefreshToken ?? refreshToken,
432  ❌ 0                 ExpiresInSeconds = tokenPayload.ExpiresIn,
433  ❌ 0                 IssuedUtc = DateTime.UtcNow
434  ❌ 0             };
435  ❌ 0         }
436           
437               private async Task<string> FetchUserEmailAsync(string accessToken, CancellationToken cancellationToken)
438  ❌ 0         {
439  ❌ 0             using var httpClient = CreateHttpClient();
440  ❌ 0             using var request = new HttpRequestMessage(HttpMethod.Get, UserInfoEndpoint);
441  ❌ 0             request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
442           
443  ❌ 0             using var response = await httpClient.SendAsync(request, cancellationToken);
444  ❌ 0  ○          if (!response.IsSuccessStatusCode)
445  ❌ 0             {
446  ❌ 0                 return string.Empty;
447                   }
448           
449  ❌ 0             var payload = await response.Content.ReadAsStringAsync(cancellationToken);
450  ❌ 0             var userInfo = JsonSerializer.Deserialize<UserInfoPayload>(payload);
451  ❌ 0  ○          return userInfo?.Email ?? string.Empty;
452  ❌ 0         }
453           
454               private async Task<string> FetchProjectIdAsync(string accessToken, CancellationToken cancellationToken)
455  ❌ 0         {
456  ❌ 0             var loadHeaders = new Dictionary<string, string>
457  ❌ 0             {
458  ❌ 0                 ["Authorization"] = $"Bearer {accessToken}",
459  ❌ 0                 ["Content-Type"] = "application/json",
460  ❌ 0                 ["User-Agent"] = "google-api-nodejs-client/9.15.1",
461  ❌ 0                 ["X-Goog-Api-Client"] = "google-cloud-sdk vscode_cloudshelleditor/0.1",
462  ❌ 0                 ["Client-Metadata"] = "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLATFORM_UNSPECIFIED\",\"pluginType\"
463  ❌ 0             };
464           
465  ❌ 0             var endpoints = LoadEndpoints.Concat(FallbackEndpoints).Distinct().ToArray();
466  ❌ 0  ○          foreach (var endpoint in endpoints)
467  ❌ 0             {
468  ❌ 0                 var url = $"{endpoint}/v1internal:loadCodeAssist";
469                       try
470  ❌ 0                 {
471  ❌ 0                     using var httpClient = CreateHttpClient();
472  ❌ 0                     using var request = new HttpRequestMessage(HttpMethod.Post, url);
473  ❌ 0  ○                  foreach (var header in loadHeaders)
474  ❌ 0                     {
475  ❌ 0  ○                      if (header.Key == "Authorization")
476  ❌ 0                         {
477  ❌ 0                             request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
478  ❌ 0                         }
479                               else
480  ❌ 0                         {
481  ❌ 0                             request.Headers.TryAddWithoutValidation(header.Key, header.Value);
482  ❌ 0                         }
483  ❌ 0                     }
484           
485  ❌ 0                     request.Content = new StringContent(
486  ❌ 0                         "{\"metadata\":{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLATFORM_UNSPECIFIED\",\"pluginType\"
487  ❌ 0                         Encoding.UTF8,
488  ❌ 0                         "application/json");
489           
490  ❌ 0                     using var response = await httpClient.SendAsync(request, cancellationToken);
491  ❌ 0  ○                  if (!response.IsSuccessStatusCode)
492  ❌ 0                     {
493  ❌ 0                         continue;
494                           }
495           
496  ❌ 0                     var payload = await response.Content.ReadAsStringAsync(cancellationToken);
497  ❌ 0                     var projectId = ExtractProjectId(payload);
498  ❌ 0  ○                  if (!string.IsNullOrWhiteSpace(projectId))
499  ❌ 0                     {
500  ❌ 0                         return projectId;
501                           }
502  ❌ 0                 }
503  ❌ 0                 catch (Exception ex)
504  ❌ 0                 {
505  ❌ 0                     _logger.LogWarning(ex, "Failed to resolve project ID from {Endpoint}", endpoint);
506  ❌ 0                 }
507  ❌ 0             }
508           
509  ❌ 0             return string.Empty;
510  ❌ 0         }
511           
512               private static string ExtractProjectId(string payload)
513  ❌ 0         {
514                   try
515  ❌ 0             {
516  ❌ 0                 using var doc = JsonDocument.Parse(payload);
517  ❌ 0  ○              if (doc.RootElement.TryGetProperty("cloudaicompanionProject", out var projectElement))
518  ❌ 0                 {
519  ❌ 0  ○                  if (projectElement.ValueKind == JsonValueKind.String)
520  ❌ 0                     {
521  ❌ 0  ○                      return projectElement.GetString() ?? string.Empty;
522                           }
523           
524  ❌ 0  ○                  if (projectElement.ValueKind == JsonValueKind.Object && projectElement.TryGetProperty("id", out var idEl
525  ❌ 0                     {
526  ❌ 0  ○                      return idElement.GetString() ?? string.Empty;
527                           }
528  ❌ 0                 }
529  ❌ 0             }
530  ❌ 0             catch (JsonException)
531  ❌ 0             {
532  ❌ 0             }
533           
534  ❌ 0             return string.Empty;
535  ❌ 0         }
536           
537               private static (string RefreshToken, string ProjectId) ParseRefreshToken(string refreshToken)
538  ✔  1         {
539  ✔  1             var separatorIndex = refreshToken.IndexOf('|');
540  ✓  1  ◑          if (separatorIndex <= 0)
541  ✔  1             {
542  ✔  1                 return (refreshToken, string.Empty);
543                   }
544           
545  ❌ 0             var token = refreshToken.Substring(0, separatorIndex);
546  ❌ 0             var projectId = refreshToken.Substring(separatorIndex + 1);
547  ❌ 0             return (token, projectId);
548  ✔  1         }
549           
550               private static (string Code, string State) ParseCallbackUrl(string callbackUrl)
551  ❌ 0         {
552  ❌ 0             var uri = new Uri(callbackUrl);
553  ❌ 0             var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
554  ❌ 0  ○          return (query["code"] ?? string.Empty, query["state"] ?? string.Empty);
555  ❌ 0         }
556           
557               private HttpClient CreateHttpClient()
558  ✔  1         {
559  ✔  1             return _httpClientFactory.CreateClient("Antigravity");
560  ✔  1         }
561           
562               private sealed class PkceState
563               {
564  ❌ 0             [JsonPropertyName("verifier")] public string Verifier { get; set; } = string.Empty;
565  ❌ 0             [JsonPropertyName("projectId")] public string? ProjectId { get; set; }
566               }
567           
568               private sealed class TokenPayload
569               {
570  ❌ 0             [JsonPropertyName("access_token")] public string AccessToken { get; set; } = string.Empty;
571  ❌ 0             [JsonPropertyName("expires_in")] public int ExpiresIn { get; set; }
572  ❌ 0             [JsonPropertyName("refresh_token")] public string? RefreshToken { get; set; }
573               }
574           
575               private sealed class UserInfoPayload
576               {
577  ❌ 0             [JsonPropertyName("email")] public string? Email { get; set; }
578               }
579           }
```
# Synaxis.InferenceGateway.Infrastructure.Auth.FileTokenStore

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Auth.FileTokenStore |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Auth/FileTokenStore.cs |
| **Line coverage:** | 42.8% (12 of 28) |
| Covered lines: | 12 |
| Uncovered lines: | 16 |
| Coverable lines: | 28 |
| Total lines: | 54 |
| **Branch coverage:** | 37.5% (3 of 8) |
| Covered branches: | 3 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **LoadAsync()** | 50.0% | 5 | 4 | 63.63% |
| **SaveAsync()** | 0% | 6 | 2 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Auth/FileTokenStore.cs
```
 1           using System;
 2           using System.Collections.Generic;
 3           using System.IO;
 4           using System.Text.Json;
 5           using System.Threading.Tasks;
 6           using Microsoft.Extensions.Logging;
 7           using Synaxis.InferenceGateway.Application.Configuration;
 8           
 9           namespace Synaxis.InferenceGateway.Infrastructure.Auth;
10           
11           public class FileTokenStore : ITokenStore
12           {
13               private readonly string _path;
14               private readonly ILogger<FileTokenStore> _logger;
15           
16  ✔  2         public FileTokenStore(string path, ILogger<FileTokenStore> logger)
17  ✔  2         {
18  ✓  2  ◑          _path = path ?? throw new ArgumentNullException(nameof(path));
19  ✔  2             _logger = logger;
20  ✔  2         }
21           
22               public async Task<List<AntigravityAccount>> LoadAsync()
23  ✔  2         {
24  ✓  2  ◑          if (!File.Exists(_path)) return new List<AntigravityAccount>();
25           
26                   try
27  ✔  2             {
28  ✔  2                 var json = await File.ReadAllTextAsync(_path);
29  ✔  2                 var accounts = JsonSerializer.Deserialize<List<AntigravityAccount>>(json);
30  ✓  2  ◑              return accounts ?? new List<AntigravityAccount>();
31                   }
32  ❌ 0             catch (Exception ex)
33  ❌ 0             {
34  ❌ 0                 _logger.LogError(ex, "Failed to load accounts from {Path}", _path);
35  ❌ 0                 return new List<AntigravityAccount>();
36                   }
37  ✔  2         }
38           
39               public async Task SaveAsync(List<AntigravityAccount> accounts)
40  ❌ 0         {
41                   try
42  ❌ 0             {
43  ❌ 0                 var dir = Path.GetDirectoryName(_path);
44  ❌ 0  ○              if (!string.IsNullOrEmpty(dir)) Directory.CreateDirectory(dir);
45           
46  ❌ 0                 var json = JsonSerializer.Serialize(accounts);
47  ❌ 0                 await File.WriteAllTextAsync(_path, json);
48  ❌ 0             }
49  ❌ 0             catch (Exception ex)
50  ❌ 0             {
51  ❌ 0                 _logger.LogError(ex, "Failed to save accounts.");
52  ❌ 0             }
53  ❌ 0         }
54           }
```
# Synaxis.InferenceGateway.Infrastructure.Candidate

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Candidate |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 100% (2 of 2) |
| Covered lines: | 2 |
| Uncovered lines: | 0 |
| Coverable lines: | 2 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Content()** | 100% | 1 | 1 | 100% |
| **get_FinishReason()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.IO;
  4            using System.Linq;
  5            using System.Net.Http;
  6            using System.Net.Http.Headers;
  7            using System.Runtime.CompilerServices;
  8            using System.Text;
  9            using System.Text.Json;
 10            using System.Text.Json.Serialization;
 11            using System.Threading;
 12            using System.Threading.Tasks;
 13            using Microsoft.Extensions.AI;
 14            using Synaxis.InferenceGateway.Infrastructure.Auth;
 15            
 16            namespace Synaxis.InferenceGateway.Infrastructure;
 17            
 18            /// <summary>
 19            /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20            /// Implements strict protocol compliance including the wrapper object and custom headers.
 21            /// </summary>
 22            public class AntigravityChatClient : IChatClient
 23            {
 24                private readonly HttpClient _httpClient;
 25                private readonly string _modelId;
 26                private readonly string _projectId;
 27                private readonly ITokenProvider _tokenProvider;
 28                private readonly ChatClientMetadata _metadata;
 29            
 30                // Endpoints are now relative to the configured HttpClient.BaseAddress
 31                private const string EndpointRelative = "/v1/chat/completions";
 32                private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33            
 34                public AntigravityChatClient(
 35                    HttpClient httpClient,
 36                    string modelId,
 37                    string projectId,
 38                    ITokenProvider tokenProvider)
 39                {
 40                    _httpClient = httpClient;
 41                    _modelId = modelId;
 42                    _projectId = projectId;
 43                    _tokenProvider = tokenProvider;
 44                    // Prefer the configured BaseAddress on the provided HttpClient when available
 45                    _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46                }
 47            
 48                public ChatClientMetadata Metadata => _metadata;
 49            
 50                public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51                {
 52                    var messagesList = chatMessages.ToList();
 53                    var request = BuildRequest(messagesList, options);
 54                    var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55            
 56                    using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                    httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58            
 59                    await PrepareRequestAsync(httpRequest, cancellationToken);
 60            
 61                    using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                    await EnsureSuccessAsync(response);
 63            
 64                    var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                    var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66            
 67                    return MapResponse(agResponse?.Response);
 68                }
 69            
 70                public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                    IEnumerable<ChatMessage> chatMessages,
 72                    ChatOptions? options = null,
 73                    [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74                {
 75                    var messagesList = chatMessages.ToList();
 76                    var request = BuildRequest(messagesList, options);
 77                    var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78            
 79                    using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                    httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                    httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82            
 83                    await PrepareRequestAsync(httpRequest, cancellationToken);
 84            
 85                    using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                    await EnsureSuccessAsync(response);
 87            
 88                    using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                    using var reader = new StreamReader(stream);
 90            
 91                    while (!cancellationToken.IsCancellationRequested)
 92                    {
 93                        var line = await reader.ReadLineAsync(cancellationToken);
 94                        if (line == null) break; // End of stream
 95                        if (string.IsNullOrWhiteSpace(line)) continue;
 96            
 97                        if (line.StartsWith("data: "))
 98                        {
 99                            var data = line.Substring(6).Trim();
100                            if (data == "[DONE]") break;
101            
102                            AntigravityResponseWrapper? wrapper = null;
103                            try
104                            {
105                                wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                            }
107                            catch (JsonException) { /* Ignore malformed lines */ }
108            
109                            if (wrapper?.Response?.Candidates != null)
110                            {
111                                foreach (var candidate in wrapper.Response.Candidates)
112                                {
113                                    if (candidate.Content?.Parts != null)
114                                    {
115                                        foreach (var part in candidate.Content.Parts)
116                                        {
117                                            if (!string.IsNullOrEmpty(part.Text))
118                                            {
119                                                yield return new ChatResponseUpdate
120                                                {
121                                                    Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                    Contents = { new TextContent(part.Text) }
123                                                };
124                                            }
125                                        }
126                                    }
127                                }
128                            }
129                        }
130                    }
131                }
132            
133                private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134                {
135                    var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137            
138                    // Strict Headers required by Antigravity
139                    request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                    request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                    request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142                }
143            
144                private async Task EnsureSuccessAsync(HttpResponseMessage response)
145                {
146                    if (!response.IsSuccessStatusCode)
147                    {
148                        var error = await response.Content.ReadAsStringAsync();
149                        throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                    }
151                }
152            
153                private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154                {
155                    var contentList = new List<Content>();
156                    SystemInstruction? systemInstruction = null;
157            
158                    foreach (var msg in messages)
159                    {
160                        if (msg.Role == ChatRole.System)
161                        {
162                            // Antigravity requires system instructions in a separate field, not in contents
163                            if (systemInstruction == null)
164                            {
165                                systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                            }
167                            systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                        }
169                        else
170                        {
171                            var role = msg.Role == ChatRole.User ? "user" : "model";
172                            contentList.Add(new Content
173                            {
174                                Role = role,
175                                Parts = new List<Part> { new Part { Text = msg.Text } }
176                            });
177                        }
178                    }
179            
180                    var config = new GenerationConfig
181                    {
182                        MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                        Temperature = options?.Temperature ?? 0.7f,
184                        TopP = options?.TopP ?? 0.95f,
185                        StopSequences = options?.StopSequences
186                    };
187            
188                    // Handle Thinking Config
189                    if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                    {
191                         // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                         // For now, we'll try to extract budget if present, or default
193                         if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                         {
195                             // Simple extraction logic or default
196                             config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                         }
198                    }
199            
200                    return new AntigravityRequest
201                    {
202                        Project = _projectId,
203                        Model = _modelId,
204                        RequestPayload = new RequestPayload
205                        {
206                            Contents = contentList,
207                            SystemInstruction = systemInstruction,
208                            GenerationConfig = config
209                        }
210                    };
211                }
212            
213                private ChatResponse MapResponse(AntigravityResponse? response)
214                {
215                    if (response?.Candidates == null || response.Candidates.Count == 0)
216                        return new ChatResponse(new List<ChatMessage>());
217            
218                    var candidate = response.Candidates[0];
219                    var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220            
221                    return new ChatResponse(new List<ChatMessage>
222                    {
223                        new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                    })
225                    {
226                        ResponseId = response.ResponseId,
227                        ModelId = response.ModelVersion
228                    };
229                }
230            
231                // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232                public void Dispose() { }
233                public object? GetService(Type serviceType, object? serviceKey = null) =>
234                    serviceType == typeof(IChatClient) ? this : null;
235            }
236            
237            internal class AntigravityRequest
238            {
239                [JsonPropertyName("project")] public string Project { get; set; } = "";
240                [JsonPropertyName("model")] public string Model { get; set; } = "";
241                [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242            }
243            
244            internal class RequestPayload
245            {
246                [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247                [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248                [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249            }
250            
251            internal class Content
252            {
253                [JsonPropertyName("role")] public string Role { get; set; } = "user";
254                [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255            }
256            
257            internal class SystemInstruction
258            {
259                [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260            }
261            
262            internal class Part
263            {
264                [JsonPropertyName("text")] public string? Text { get; set; }
265            }
266            
267            internal class GenerationConfig
268            {
269                [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270                [JsonPropertyName("temperature")] public float Temperature { get; set; }
271                [JsonPropertyName("topP")] public float TopP { get; set; }
272                [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273                [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274            }
275            
276            internal class ThinkingConfig
277            {
278                [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279                [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280            }
281            
282            internal class AntigravityResponseWrapper
283            {
284                [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285            }
286            
287            internal class AntigravityResponse
288            {
289                [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290                [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291                [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292            }
293            
294            internal class Candidate
295            {
296  ✔  11         [JsonPropertyName("content")] public Content? Content { get; set; }
297  ✔   1         [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298            }
299            
300            [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301            [JsonSerializable(typeof(AntigravityRequest))]
302            [JsonSerializable(typeof(AntigravityResponseWrapper))]
303            internal partial class AntigravityJsonContext : JsonSerializerContext
304            {
305            }
```
# Synaxis.InferenceGateway.Infrastructure.ChatClients.ChatClientFactory

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ChatClients.ChatClientFactory |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ChatClients/ChatClientFactory.cs |
| **Line coverage:** | 78.5% (11 of 14) |
| Covered lines: | 11 |
| Uncovered lines: | 3 |
| Coverable lines: | 14 |
| Total lines: | 33 |
| **Branch coverage:** | 50% (2 of 4) |
| Covered branches: | 2 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **GetClient(...)** | 50.0% | 2 | 2 | 66.66% |
| **GetService(...)** | 50.0% | 2 | 2 | 75.00% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ChatClients/ChatClientFactory.cs
```
 1            using System;
 2            using Microsoft.Extensions.DependencyInjection;
 3            using Synaxis.InferenceGateway.Application.ChatClients;
 4            using Microsoft.Extensions.AI;
 5            
 6            namespace Synaxis.InferenceGateway.Infrastructure.ChatClients
 7            {
 8                public class ChatClientFactory : IChatClientFactory
 9                {
10                    private readonly IServiceProvider _serviceProvider;
11            
12  ✔  15             public ChatClientFactory(IServiceProvider serviceProvider)
13  ✔  15             {
14  ✔  15                 _serviceProvider = serviceProvider;
15  ✔  15             }
16            
17                    public IChatClient? GetClient(string? key = null)
18  ✔  14             {
19  ✓  14  ◑              if (string.IsNullOrEmpty(key))
20  ❌  0                 {
21  ❌  0                     return _serviceProvider.GetService<IChatClient>();
22                        }
23            
24  ✔  14                 return _serviceProvider.GetKeyedService<IChatClient>(key);
25  ✔  14             }
26            
27                    public object? GetService(Type serviceType, object? serviceKey = null)
28  ✔  15             {
29  ✓  30  ◑              if (serviceKey == null) return _serviceProvider.GetService(serviceType);
30  ❌  0                 return _serviceProvider.GetKeyedService(serviceType, serviceKey);
31  ✔  15             }
32                }
33            }
```
# Synaxis.InferenceGateway.Infrastructure.ChatClients.Strategies.CloudflareStrategy

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ChatClients.Strategies.CloudflareStrategy |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ChatClients/Strategies/CloudflareStrategy.cs |
| **Line coverage:** | 14.2% (1 of 7) |
| Covered lines: | 1 |
| Uncovered lines: | 6 |
| Coverable lines: | 7 |
| Total lines: | 38 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **CanHandle(...)** | 100% | 1 | 1 | 100% |
| **ExecuteAsync()** | 100% | 2 | 1 | 0% |
| **ExecuteStreamingAsync(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ChatClients/Strategies/CloudflareStrategy.cs
```
 1            using Microsoft.Extensions.AI;
 2            using Synaxis.InferenceGateway.Application.ChatClients.Strategies;
 3            using System.Collections.Generic;
 4            using System.Threading;
 5            using System.Threading.Tasks;
 6            
 7            namespace Synaxis.InferenceGateway.Infrastructure.ChatClients.Strategies;
 8            
 9            public class CloudflareStrategy : IChatClientStrategy
10            {
11  ✔  14         public bool CanHandle(string providerType) => providerType == "Cloudflare";
12            
13                public async Task<ChatResponse> ExecuteAsync(
14                    IChatClient client,
15                    IEnumerable<ChatMessage> messages,
16                    ChatOptions options,
17                    CancellationToken ct)
18  ❌  0         {
19                    // Standard pass-through: Cloudflare-specific behavior (URL, auth,
20                    // request formatting, streaming framing, default headers) is implemented
21                    // in CloudflareChatClient. Keep this strategy lightweight so the client
22                    // handles protocol details. This strategy exists to allow future
23                    // provider-specific adjustments (e.g. token limits or option remapping)
24                    // without changing callers.
25  ❌  0             return await client.GetResponseAsync(messages, options, ct);
26  ❌  0         }
27            
28                public IAsyncEnumerable<ChatResponseUpdate> ExecuteStreamingAsync(
29                    IChatClient client,
30                    IEnumerable<ChatMessage> messages,
31                    ChatOptions options,
32                    CancellationToken ct)
33  ❌  0         {
34                    // Streaming is handled by the CloudflareChatClient which knows the
35                    // server-side streaming framing. This is a direct pass-through.
36  ❌  0             return client.GetStreamingResponseAsync(messages, options, ct);
37  ❌  0         }
38            }
```
# Synaxis.InferenceGateway.Infrastructure.ChatClients.Strategies.OpenAiGenericStrategy

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ChatClients.Strategies.OpenAiGenericStrategy |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ChatClients/Strategies/OpenAiGenericStrategy.cs |
| **Line coverage:** | 100% (11 of 11) |
| Covered lines: | 11 |
| Uncovered lines: | 0 |
| Coverable lines: | 11 |
| Total lines: | 35 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 1 | 1 | 100% |
| **CanHandle(...)** | 100% | 1 | 1 | 100% |
| **ExecuteAsync()** | 100% | 1 | 1 | 100% |
| **ExecuteStreamingAsync(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ChatClients/Strategies/OpenAiGenericStrategy.cs
```
 1            using Microsoft.Extensions.AI;
 2            using Synaxis.InferenceGateway.Application.ChatClients.Strategies;
 3            using System.Collections.Generic;
 4            using System.Threading;
 5            using System.Threading.Tasks;
 6            
 7            namespace Synaxis.InferenceGateway.Infrastructure.ChatClients.Strategies;
 8            
 9            public class OpenAiGenericStrategy : IChatClientStrategy
10            {
11  ✔   1         private static readonly HashSet<string> SupportedTypes = new()
12  ✔   1         {
13  ✔   1             "OpenAI", "Groq", "OpenRouter", "Pollinations", "Gemini", "Nvidia", "HuggingFace", "Cohere"
14  ✔   1         };
15            
16  ✔  14         public bool CanHandle(string providerType) => SupportedTypes.Contains(providerType);
17            
18                public async Task<ChatResponse> ExecuteAsync(
19                    IChatClient client,
20                    IEnumerable<ChatMessage> messages,
21                    ChatOptions options,
22                    CancellationToken ct)
23  ✔  11         {
24  ✔  11             return await client.GetResponseAsync(messages, options, ct);
25  ✔  11         }
26            
27                public IAsyncEnumerable<ChatResponseUpdate> ExecuteStreamingAsync(
28                    IChatClient client,
29                    IEnumerable<ChatMessage> messages,
30                    ChatOptions options,
31                    CancellationToken ct)
32  ✔   3         {
33  ✔   3             return client.GetStreamingResponseAsync(messages, options, ct);
34  ✔   3         }
35            }
```
# Synaxis.InferenceGateway.Infrastructure.CloudflareChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.CloudflareChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/CloudflareChatClient.cs |
| **Line coverage:** | 96.4% (81 of 84) |
| Covered lines: | 81 |
| Uncovered lines: | 3 |
| Coverable lines: | 84 |
| Total lines: | 145 |
| **Branch coverage:** | 72.7% (16 of 22) |
| Covered branches: | 16 |
| Total branches: | 22 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Metadata()** | 100% | 1 | 1 | 100% |
| **GetResponseAsync()** | 50.0% | 8 | 8 | 84.21% |
| **GetStreamingResponseAsync()** | 83.33% | 12 | 12 | 100% |
| **CreateRequest(...)** | 100% | 2 | 2 | 100% |
| **Dispose()** | 100% | 1 | 1 | 100% |
| **GetService(...)** | 100% | 1 | 1 | 100% |
| **get_Result()** | 100% | 1 | 1 | 100% |
| **get_Response()** | 100% | 1 | 1 | 100% |
| **get_Response()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/CloudflareChatClient.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.Net.Http;
  4            using System.Net.Http.Headers;
  5            using System.Net.Http.Json;
  6            using System.Runtime.CompilerServices;
  7            using System.Text.Json;
  8            using System.Text.Json.Serialization;
  9            using System.Threading;
 10            using System.Threading.Tasks;
 11            using Microsoft.Extensions.AI;
 12            using Microsoft.Extensions.Logging;
 13            
 14            namespace Synaxis.InferenceGateway.Infrastructure;
 15            
 16            public class CloudflareChatClient : IChatClient
 17            {
 18                private readonly HttpClient _httpClient;
 19                private readonly string _accountId;
 20                private readonly string _modelId;
 21                private readonly ChatClientMetadata _metadata;
 22                private readonly ILogger<CloudflareChatClient>? _logger;
 23            
 24  ✔  15             public CloudflareChatClient(HttpClient httpClient, string accountId, string modelId, string apiKey, ILogger<Clou
 25  ✔  15             {
 26  ✔  15                 _httpClient = httpClient;
 27  ✔  15                 _accountId = accountId;
 28  ✔  15                 _modelId = modelId;
 29  ✔  15                 _logger = logger;
 30  ✔  15                 _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", apiKey);
 31                        // Store the raw model id; Cloudflare expects path-like model ids (e.g. @cf/meta/...) as raw segments.
 32  ✔  15                 _metadata = new ChatClientMetadata("Cloudflare", new Uri($"https://api.cloudflare.com/client/v4/accounts/{ac
 33  ✔  15             }
 34            
 35  ✔   2         public ChatClientMetadata Metadata => _metadata;
 36            
 37                    public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = n
 38  ✔   5             {
 39  ✔   5                 var request = CreateRequest(chatMessages, options, stream: false);
 40  ✔   5                 var url = $"https://api.cloudflare.com/client/v4/accounts/{_accountId}/ai/run/{_modelId}";
 41            
 42                        // Debug: print the full request URL and model id to help diagnose 404s
 43  ✔   5                 var requestUrl = url;
 44  ✓   5  ◑              if (_logger != null)
 45  ❌  0                 {
 46  ❌  0                     _logger.LogInformation("CloudflareChatClient sending request. Url: {Url} ModelId: {ModelId}", requestUrl
 47  ❌  0                 }
 48                        else
 49  ✔   5                 {
 50  ✔   5                     Console.WriteLine($"CloudflareChatClient sending request. Url: {requestUrl} ModelId: {_modelId}");
 51  ✔   5                 }
 52            
 53  ✔   5                 var response = await _httpClient.PostAsJsonAsync(url, request, cancellationToken);
 54  ✔   5                 response.EnsureSuccessStatusCode();
 55            
 56  ✔   4             var cloudflareResponse = await response.Content.ReadFromJsonAsync<CloudflareResponse>(cancellationToken: cancell
 57            
 58  ✓   4  ◑          var text = cloudflareResponse?.Result?.Response ?? "";
 59  ✔   4             var chatResponse = new ChatResponse(new ChatMessage(ChatRole.Assistant, text));
 60  ✔   4             chatResponse.ModelId = _modelId;
 61  ✔   4             return chatResponse;
 62  ✔   4         }
 63            
 64                    public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> chatMessage
 65  ✔   4             {
 66  ✔   4                 var request = CreateRequest(chatMessages, options, stream: true);
 67  ✔   4             var url = $"https://api.cloudflare.com/client/v4/accounts/{_accountId}/ai/run/{_modelId}";
 68            
 69  ✔   4             var httpRequest = new HttpRequestMessage(HttpMethod.Post, url)
 70  ✔   4             {
 71  ✔   4                 Content = JsonContent.Create(request)
 72  ✔   4             };
 73            
 74  ✔   4             using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 75  ✔   4             response.EnsureSuccessStatusCode();
 76            
 77  ✔   4             using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 78  ✔   4             using var reader = new System.IO.StreamReader(stream);
 79            
 80                    string? line;
 81  ✓  24  ◑          while ((line = await reader.ReadLineAsync()) is not null)
 82  ✔  24             {
 83  ✔  36  ●              if (string.IsNullOrWhiteSpace(line)) continue;
 84  ✔  14  ●              if (!line.StartsWith("data: ")) continue;
 85            
 86  ✔  10                 var json = line.Substring(6).Trim();
 87  ✔  14  ●              if (json == "[DONE]") break;
 88            
 89  ✔   6                 CloudflareStreamResponse? streamEvent = null;
 90                        try
 91  ✔   6                 {
 92  ✔   6                     streamEvent = JsonSerializer.Deserialize<CloudflareStreamResponse>(json);
 93  ✔   5                 }
 94  ✔   3                 catch { continue; }
 95            
 96  ✓   5  ◑              if (streamEvent?.Response != null)
 97  ✔   5                 {
 98  ✔   5                     var update = new ChatResponseUpdate
 99  ✔   5                     {
100  ✔   5                         Role = ChatRole.Assistant,
101  ✔   5                         ModelId = _modelId
102  ✔   5                     };
103  ✔   5                     update.Contents.Add(new TextContent(streamEvent.Response));
104  ✔   5                     yield return update;
105  ✔   5                 }
106  ✔   5             }
107  ✔   4         }
108            
109                private object CreateRequest(IEnumerable<ChatMessage> chatMessages, ChatOptions? options, bool stream)
110  ✔   9         {
111  ✔   9             var messages = new List<object>();
112  ✔  51  ●          foreach (var msg in chatMessages)
113  ✔  12             {
114  ✔  12                 messages.Add(new
115  ✔  12                 {
116  ✔  12                     role = msg.Role.Value,
117  ✔  12                     content = msg.Text
118  ✔  12                 });
119  ✔  12             }
120            
121  ✔   9             return new
122  ✔   9             {
123  ✔   9                 messages = messages,
124  ✔   9                 stream = stream
125  ✔   9             };
126  ✔   9         }
127            
128  ✔   1         public void Dispose() => _httpClient.Dispose();
129  ✔   1         public object? GetService(Type serviceType, object? serviceKey = null) => null;
130            
131                private class CloudflareResponse
132                {
133  ✔   8             [JsonPropertyName("result")] public CloudflareResult? Result { get; set; }
134                }
135            
136                private class CloudflareResult
137                {
138  ✔   8             [JsonPropertyName("response")] public string? Response { get; set; }
139                }
140            
141                private class CloudflareStreamResponse
142                {
143  ✔  15             [JsonPropertyName("response")] public string? Response { get; set; }
144                }
145            }
```
# Synaxis.InferenceGateway.Infrastructure.CohereChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.CohereChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/CohereChatClient.cs |
| **Line coverage:** | 35.2% (48 of 136) |
| Covered lines: | 48 |
| Uncovered lines: | 88 |
| Coverable lines: | 136 |
| Total lines: | 233 |
| **Branch coverage:** | 8.5% (7 of 82) |
| Covered branches: | 7 |
| Total branches: | 82 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Metadata()** | 100% | 2 | 1 | 0% |
| **GetResponseAsync()** | 57.14% | 15 | 14 | 84.21% |
| **GetStreamingResponseAsync()** | 0% | 4692 | 68 | 0% |
| **CreateRequest(...)** | 40.0% | 10 | 10 | 100% |
| **Dispose()** | 100% | 2 | 1 | 0% |
| **GetService(...)** | 100% | 2 | 1 | 0% |
| **get_Message()** | 100% | 1 | 1 | 100% |
| **get_Content()** | 100% | 1 | 1 | 100% |
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_Text()** | 100% | 1 | 1 | 100% |
| **get_Type()** | 100% | 2 | 1 | 0% |
| **get_Delta()** | 100% | 2 | 1 | 0% |
| **get_Usage()** | 100% | 2 | 1 | 0% |
| **get_Message()** | 100% | 2 | 1 | 0% |
| **get_FinishReason()** | 100% | 2 | 1 | 0% |
| **get_Content()** | 100% | 2 | 1 | 0% |
| **get_PromptTokens()** | 100% | 2 | 1 | 0% |
| **get_CompletionTokens()** | 100% | 2 | 1 | 0% |
| **get_TotalTokens()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/CohereChatClient.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Linq;
  4           using System.Net.Http;
  5           using System.Net.Http.Json;
  6           using System.Runtime.CompilerServices;
  7           using System.Text.Json;
  8           using System.Text.Json.Serialization;
  9           using System.Threading;
 10           using System.Threading.Tasks;
 11           using Microsoft.Extensions.AI;
 12           
 13           namespace Synaxis.InferenceGateway.Infrastructure;
 14           
 15           public class CohereChatClient : IChatClient
 16           {
 17               private readonly HttpClient _httpClient;
 18               private readonly string _modelId;
 19               private readonly ChatClientMetadata _metadata;
 20  ✔  1         private static readonly JsonSerializerOptions _jsonOptions = new()
 21  ✔  1         {
 22  ✔  1             PropertyNameCaseInsensitive = true,
 23  ✔  1             DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
 24  ✔  1         };
 25           
 26  ✔  1         public CohereChatClient(HttpClient httpClient, string modelId, string apiKey)
 27  ✔  1         {
 28  ✔  1             _httpClient = httpClient;
 29  ✔  1             _modelId = modelId;
 30  ✔  1             _httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer"
 31  ✔  1             _httpClient.DefaultRequestHeaders.UserAgent.ParseAdd("Synaxis/1.0");
 32  ✔  1             _metadata = new ChatClientMetadata("Cohere", new Uri("https://api.cohere.com/v2/chat"), modelId);
 33  ✔  1         }
 34           
 35  ❌ 0         public ChatClientMetadata Metadata => _metadata;
 36           
 37               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 38  ✔  1  ●      {
 39  ✔  1             var requestObj = CreateRequest(chatMessages, options, stream: false);
 40  ✔  1             var request = new HttpRequestMessage(HttpMethod.Post, "https://api.cohere.com/v2/chat")
 41  ✔  1             {
 42  ✔  1                 Content = JsonContent.Create(requestObj)
 43  ✔  1             };
 44           
 45  ✔  1             using var response = await _httpClient.SendAsync(request, cancellationToken);
 46           
 47  ✓  1  ◑          if (!response.IsSuccessStatusCode)
 48  ❌ 0             {
 49  ❌ 0                 var error = await response.Content.ReadAsStringAsync(cancellationToken);
 50  ❌ 0                 throw new HttpRequestException($"Cohere API Error {response.StatusCode}: {error}");
 51                   }
 52           
 53  ✔  1             response.EnsureSuccessStatusCode();
 54           
 55  ✔  1             var cohereResponse = await response.Content.ReadFromJsonAsync<CohereResponseV2>(_jsonOptions, cancellationToken:
 56           
 57                   var text = cohereResponse?.Message?.Content?.FirstOrDefault(c => c.Type == "text")?.Text ?? "";
 58  ✔  1             var chatResponse = new ChatResponse(new ChatMessage(ChatRole.Assistant, text))
 59  ✔  1             {
 60  ✔  1                 ModelId = _modelId
 61  ✔  1             };
 62  ✔  1             return chatResponse;
 63  ✔  1         }
 64           
 65               public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> chatMessages, C
 66  ❌ 0         {
 67  ❌ 0             var requestObj = CreateRequest(chatMessages, options, stream: true);
 68  ❌ 0             var request = new HttpRequestMessage(HttpMethod.Post, "https://api.cohere.com/v2/chat")
 69  ❌ 0             {
 70  ❌ 0                 Content = JsonContent.Create(requestObj)
 71  ❌ 0             };
 72           
 73                   // Ask for SSE
 74  ❌ 0             request.Headers.Accept.Clear();
 75  ❌ 0             request.Headers.Accept.Add(new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue("text/event-stream"));
 76           
 77  ❌ 0             using var response = await _httpClient.SendAsync(request, HttpCompletionOption.ResponseHeadersRead, cancellation
 78  ❌ 0  ○          if (!response.IsSuccessStatusCode)
 79  ❌ 0             {
 80  ❌ 0                 var err = await response.Content.ReadAsStringAsync(cancellationToken);
 81  ❌ 0                 throw new HttpRequestException($"Cohere API Error {response.StatusCode}: {err}");
 82                   }
 83           
 84  ❌ 0  ○          using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 85  ❌ 0             using var reader = new System.IO.StreamReader(stream);
 86           
 87                   string? line;
 88  ❌ 0             string? currentEvent = null;
 89           
 90  ❌ 0  ○          while ((line = await reader.ReadLineAsync()) is not null)
 91  ❌ 0             {
 92  ❌ 0  ○              if (cancellationToken.IsCancellationRequested) yield break;
 93  ❌ 0  ○              if (string.IsNullOrWhiteSpace(line)) continue;
 94           
 95                       // Track event name if provided
 96  ❌ 0  ○              if (line.StartsWith("event: ", StringComparison.OrdinalIgnoreCase))
 97  ❌ 0                 {
 98  ❌ 0                     currentEvent = line.Substring(7).Trim();
 99  ❌ 0                     continue;
100                       }
101           
102  ❌ 0  ○              if (!line.StartsWith("data: ", StringComparison.OrdinalIgnoreCase)) continue;
103           
104  ❌ 0                 var json = line.Substring(6).Trim();
105  ❌ 0  ○              if (json == "[DONE]") break;
106           
107  ❌ 0                 CohereStreamEvent? ev = null;
108                       try
109  ❌ 0                 {
110  ❌ 0                     ev = JsonSerializer.Deserialize<CohereStreamEvent>(json, _jsonOptions);
111  ❌ 0                 }
112  ❌ 0                 catch (JsonException)
113  ❌ 0                 {
114                           // ignore malformed json
115  ❌ 0                     continue;
116                       }
117           
118                       // Prefer explicit SSE event name when available, otherwise infer from payload
119  ❌ 0  ○              var evName = currentEvent ?? ev?.Type;
120           
121                       // Handle content delta events
122  ❌ 0  ○              if (string.Equals(evName, "content-delta", StringComparison.OrdinalIgnoreCase) || ev?.Delta?.Message?.Conten
123  ❌ 0                 {
124  ❌ 0  ○                  var contents = ev?.Delta?.Message?.Content;
125  ❌ 0  ○                  if (contents != null)
126  ❌ 0                     {
127                               // Concatenate text parts if multiple are present in this delta
128                               var textParts = contents.Where(c => !string.IsNullOrEmpty(c.Text)).Select(c => c.Text).ToList();
129  ❌ 0  ○                      if (textParts.Count > 0)
130  ❌ 0                         {
131  ❌ 0                             var text = string.Join("", textParts);
132  ❌ 0                             var update = new ChatResponseUpdate
133  ❌ 0                             {
134  ❌ 0                                 Role = ChatRole.Assistant,
135  ❌ 0                                 ModelId = _modelId
136  ❌ 0                             };
137  ❌ 0                             update.Contents.Add(new TextContent(text));
138  ❌ 0                             yield return update;
139  ❌ 0                         }
140  ❌ 0                     }
141  ❌ 0                 }
142           
143                       // Handle message end events which may include finish reason and usage
144  ❌ 0  ○              if (string.Equals(evName, "message-end", StringComparison.OrdinalIgnoreCase) || ev?.Delta?.FinishReason != n
145  ❌ 0                 {
146  ❌ 0  ○                  var finish = ev?.Delta?.FinishReason ?? ev?.Delta?.Message?.Content?.FirstOrDefault()?.Type; // fallback
147  ❌ 0                     var update = new ChatResponseUpdate
148  ❌ 0                     {
149  ❌ 0                         Role = ChatRole.Assistant,
150  ❌ 0                         ModelId = _modelId
151  ❌ 0                     };
152           
153                           // If Cohere provides an explicit finish reason, set it on the update if supported
154                           try
155  ❌ 0                     {
156                               // Many consumers expect FinishReason as string; set via reflection-safe approach
157  ❌ 0                         var prop = typeof(ChatResponseUpdate).GetProperty("FinishReason");
158  ❌ 0  ○                      if (prop != null && prop.PropertyType == typeof(string))
159  ❌ 0                         {
160  ❌ 0                             prop.SetValue(update, finish);
161  ❌ 0                         }
162  ❌ 0                     }
163  ❌ 0                     catch { /* ignore any reflection issues */ }
164           
165  ❌ 0                     yield return update;
166  ❌ 0                 }
167  ❌ 0             }
168  ❌ 0         }
169           
170               private object CreateRequest(IEnumerable<ChatMessage> chatMessages, ChatOptions? options, bool stream)
171  ✔  1         {
172  ✓  2  ○          var messages = chatMessages.Select(m => new
173  ✔  2             {
174  ✔  2                 role = m.Role == ChatRole.User ? "user" :
175  ✔  2                        m.Role == ChatRole.Assistant ? "assistant" :
176  ✔  2                        m.Role == ChatRole.System ? "system" : "user",
177  ✔  2                 content = m.Text
178  ✔  2             }).ToList();
179           
180  ✓  1  ◑          return new
181  ✔  1             {
182  ✔  1                 model = options?.ModelId ?? _modelId,
183  ✔  1                 messages = messages,
184  ✔  1                 stream = stream
185  ✔  1             };
186  ✔  1         }
187           
188  ❌ 0         public void Dispose() => _httpClient.Dispose();
189  ❌ 0         public object? GetService(Type serviceType, object? serviceKey = null) => null;
190           
191               // V2 Response Classes
192               private class CohereResponseV2
193               {
194  ✔  2             public CohereMessageV2? Message { get; set; }
195               }
196           
197               private class CohereMessageV2
198               {
199  ✔  2             public List<CohereContentV2>? Content { get; set; }
200               }
201           
202               private class CohereContentV2
203               {
204  ✔  2             public string? Type { get; set; }
205  ✔  2             public string? Text { get; set; }
206               }
207           
208               // Streaming event DTOs
209               private class CohereStreamEvent
210               {
211  ❌ 0             [JsonPropertyName("type")] public string? Type { get; set; }
212  ❌ 0             [JsonPropertyName("delta")] public CohereDelta? Delta { get; set; }
213  ❌ 0             [JsonPropertyName("usage")] public CohereUsage? Usage { get; set; }
214               }
215           
216               private class CohereDelta
217               {
218  ❌ 0             [JsonPropertyName("message")] public CohereDeltaMessage? Message { get; set; }
219  ❌ 0             [JsonPropertyName("finish_reason")] public string? FinishReason { get; set; }
220               }
221           
222               private class CohereDeltaMessage
223               {
224  ❌ 0             [JsonPropertyName("content")] public List<CohereContentV2>? Content { get; set; }
225               }
226           
227               private class CohereUsage
228               {
229  ❌ 0             [JsonPropertyName("prompt_tokens")] public int? PromptTokens { get; set; }
230  ❌ 0             [JsonPropertyName("completion_tokens")] public int? CompletionTokens { get; set; }
231  ❌ 0             [JsonPropertyName("total_tokens")] public int? TotalTokens { get; set; }
232               }
233           }
```
# Synaxis.InferenceGateway.Infrastructure.Content

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Content |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 100% (2 of 2) |
| Covered lines: | 2 |
| Uncovered lines: | 0 |
| Coverable lines: | 2 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Role()** | 100% | 1 | 1 | 100% |
| **get_Parts()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.IO;
  4            using System.Linq;
  5            using System.Net.Http;
  6            using System.Net.Http.Headers;
  7            using System.Runtime.CompilerServices;
  8            using System.Text;
  9            using System.Text.Json;
 10            using System.Text.Json.Serialization;
 11            using System.Threading;
 12            using System.Threading.Tasks;
 13            using Microsoft.Extensions.AI;
 14            using Synaxis.InferenceGateway.Infrastructure.Auth;
 15            
 16            namespace Synaxis.InferenceGateway.Infrastructure;
 17            
 18            /// <summary>
 19            /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20            /// Implements strict protocol compliance including the wrapper object and custom headers.
 21            /// </summary>
 22            public class AntigravityChatClient : IChatClient
 23            {
 24                private readonly HttpClient _httpClient;
 25                private readonly string _modelId;
 26                private readonly string _projectId;
 27                private readonly ITokenProvider _tokenProvider;
 28                private readonly ChatClientMetadata _metadata;
 29            
 30                // Endpoints are now relative to the configured HttpClient.BaseAddress
 31                private const string EndpointRelative = "/v1/chat/completions";
 32                private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33            
 34                public AntigravityChatClient(
 35                    HttpClient httpClient,
 36                    string modelId,
 37                    string projectId,
 38                    ITokenProvider tokenProvider)
 39                {
 40                    _httpClient = httpClient;
 41                    _modelId = modelId;
 42                    _projectId = projectId;
 43                    _tokenProvider = tokenProvider;
 44                    // Prefer the configured BaseAddress on the provided HttpClient when available
 45                    _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46                }
 47            
 48                public ChatClientMetadata Metadata => _metadata;
 49            
 50                public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51                {
 52                    var messagesList = chatMessages.ToList();
 53                    var request = BuildRequest(messagesList, options);
 54                    var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55            
 56                    using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                    httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58            
 59                    await PrepareRequestAsync(httpRequest, cancellationToken);
 60            
 61                    using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                    await EnsureSuccessAsync(response);
 63            
 64                    var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                    var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66            
 67                    return MapResponse(agResponse?.Response);
 68                }
 69            
 70                public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                    IEnumerable<ChatMessage> chatMessages,
 72                    ChatOptions? options = null,
 73                    [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74                {
 75                    var messagesList = chatMessages.ToList();
 76                    var request = BuildRequest(messagesList, options);
 77                    var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78            
 79                    using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                    httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                    httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82            
 83                    await PrepareRequestAsync(httpRequest, cancellationToken);
 84            
 85                    using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                    await EnsureSuccessAsync(response);
 87            
 88                    using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                    using var reader = new StreamReader(stream);
 90            
 91                    while (!cancellationToken.IsCancellationRequested)
 92                    {
 93                        var line = await reader.ReadLineAsync(cancellationToken);
 94                        if (line == null) break; // End of stream
 95                        if (string.IsNullOrWhiteSpace(line)) continue;
 96            
 97                        if (line.StartsWith("data: "))
 98                        {
 99                            var data = line.Substring(6).Trim();
100                            if (data == "[DONE]") break;
101            
102                            AntigravityResponseWrapper? wrapper = null;
103                            try
104                            {
105                                wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                            }
107                            catch (JsonException) { /* Ignore malformed lines */ }
108            
109                            if (wrapper?.Response?.Candidates != null)
110                            {
111                                foreach (var candidate in wrapper.Response.Candidates)
112                                {
113                                    if (candidate.Content?.Parts != null)
114                                    {
115                                        foreach (var part in candidate.Content.Parts)
116                                        {
117                                            if (!string.IsNullOrEmpty(part.Text))
118                                            {
119                                                yield return new ChatResponseUpdate
120                                                {
121                                                    Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                    Contents = { new TextContent(part.Text) }
123                                                };
124                                            }
125                                        }
126                                    }
127                                }
128                            }
129                        }
130                    }
131                }
132            
133                private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134                {
135                    var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137            
138                    // Strict Headers required by Antigravity
139                    request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                    request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                    request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142                }
143            
144                private async Task EnsureSuccessAsync(HttpResponseMessage response)
145                {
146                    if (!response.IsSuccessStatusCode)
147                    {
148                        var error = await response.Content.ReadAsStringAsync();
149                        throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                    }
151                }
152            
153                private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154                {
155                    var contentList = new List<Content>();
156                    SystemInstruction? systemInstruction = null;
157            
158                    foreach (var msg in messages)
159                    {
160                        if (msg.Role == ChatRole.System)
161                        {
162                            // Antigravity requires system instructions in a separate field, not in contents
163                            if (systemInstruction == null)
164                            {
165                                systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                            }
167                            systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                        }
169                        else
170                        {
171                            var role = msg.Role == ChatRole.User ? "user" : "model";
172                            contentList.Add(new Content
173                            {
174                                Role = role,
175                                Parts = new List<Part> { new Part { Text = msg.Text } }
176                            });
177                        }
178                    }
179            
180                    var config = new GenerationConfig
181                    {
182                        MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                        Temperature = options?.Temperature ?? 0.7f,
184                        TopP = options?.TopP ?? 0.95f,
185                        StopSequences = options?.StopSequences
186                    };
187            
188                    // Handle Thinking Config
189                    if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                    {
191                         // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                         // For now, we'll try to extract budget if present, or default
193                         if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                         {
195                             // Simple extraction logic or default
196                             config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                         }
198                    }
199            
200                    return new AntigravityRequest
201                    {
202                        Project = _projectId,
203                        Model = _modelId,
204                        RequestPayload = new RequestPayload
205                        {
206                            Contents = contentList,
207                            SystemInstruction = systemInstruction,
208                            GenerationConfig = config
209                        }
210                    };
211                }
212            
213                private ChatResponse MapResponse(AntigravityResponse? response)
214                {
215                    if (response?.Candidates == null || response.Candidates.Count == 0)
216                        return new ChatResponse(new List<ChatMessage>());
217            
218                    var candidate = response.Candidates[0];
219                    var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220            
221                    return new ChatResponse(new List<ChatMessage>
222                    {
223                        new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                    })
225                    {
226                        ResponseId = response.ResponseId,
227                        ModelId = response.ModelVersion
228                    };
229                }
230            
231                // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232                public void Dispose() { }
233                public object? GetService(Type serviceType, object? serviceKey = null) =>
234                    serviceType == typeof(IChatClient) ? this : null;
235            }
236            
237            internal class AntigravityRequest
238            {
239                [JsonPropertyName("project")] public string Project { get; set; } = "";
240                [JsonPropertyName("model")] public string Model { get; set; } = "";
241                [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242            }
243            
244            internal class RequestPayload
245            {
246                [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247                [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248                [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249            }
250            
251            internal class Content
252            {
253  ✔  15         [JsonPropertyName("role")] public string Role { get; set; } = "user";
254  ✔  17         [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255            }
256            
257            internal class SystemInstruction
258            {
259                [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260            }
261            
262            internal class Part
263            {
264                [JsonPropertyName("text")] public string? Text { get; set; }
265            }
266            
267            internal class GenerationConfig
268            {
269                [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270                [JsonPropertyName("temperature")] public float Temperature { get; set; }
271                [JsonPropertyName("topP")] public float TopP { get; set; }
272                [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273                [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274            }
275            
276            internal class ThinkingConfig
277            {
278                [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279                [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280            }
281            
282            internal class AntigravityResponseWrapper
283            {
284                [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285            }
286            
287            internal class AntigravityResponse
288            {
289                [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290                [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291                [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292            }
293            
294            internal class Candidate
295            {
296                [JsonPropertyName("content")] public Content? Content { get; set; }
297                [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298            }
299            
300            [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301            [JsonSerializable(typeof(AntigravityRequest))]
302            [JsonSerializable(typeof(AntigravityResponseWrapper))]
303            internal partial class AntigravityJsonContext : JsonSerializerContext
304            {
305            }
```
# Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneDbContext

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneDbContext |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/ControlPlaneDbContext.cs |
| **Line coverage:** | 94.3% (150 of 159) |
| Covered lines: | 150 |
| Uncovered lines: | 9 |
| Coverable lines: | 159 |
| Total lines: | 189 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Tenants()** | 100% | 1 | 1 | 100% |
| **get_Users()** | 100% | 1 | 1 | 100% |
| **get_Projects()** | 100% | 1 | 1 | 100% |
| **get_ApiKeys()** | 100% | 1 | 1 | 100% |
| **get_OAuthAccounts()** | 100% | 2 | 1 | 0% |
| **get_RoutingPolicies()** | 100% | 2 | 1 | 0% |
| **get_ModelAliases()** | 100% | 2 | 1 | 0% |
| **get_ModelCombos()** | 100% | 2 | 1 | 0% |
| **get_ProviderAccounts()** | 100% | 2 | 1 | 0% |
| **get_ModelCosts()** | 100% | 1 | 1 | 100% |
| **get_RequestLogs()** | 100% | 2 | 1 | 0% |
| **get_TokenUsages()** | 100% | 2 | 1 | 0% |
| **get_QuotaSnapshots()** | 100% | 2 | 1 | 0% |
| **get_Deviations()** | 100% | 1 | 1 | 100% |
| **get_AuditLogs()** | 100% | 1 | 1 | 100% |
| **get_GlobalModels()** | 100% | 1 | 1 | 100% |
| **get_ProviderModels()** | 100% | 1 | 1 | 100% |
| **get_TenantModelLimits()** | 100% | 2 | 1 | 0% |
| **OnModelCreating(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/ControlPlaneDbContext.cs
```
  1               using Microsoft.EntityFrameworkCore;
  2               using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
  3               
  4               namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane;
  5               
  6               public sealed class ControlPlaneDbContext : DbContext
  7               {
  8                   public ControlPlaneDbContext(DbContextOptions<ControlPlaneDbContext> options)
  9  ✔    236             : base(options)
 10  ✔    236         {
 11  ✔    236         }
 12               
 13  ✔     19         public DbSet<Tenant> Tenants => Set<Tenant>();
 14  ✔     83         public DbSet<User> Users => Set<User>();
 15  ✔     16         public DbSet<Project> Projects => Set<Project>();
 16  ✔     16         public DbSet<ApiKey> ApiKeys => Set<ApiKey>();
 17  ❌     0         public DbSet<OAuthAccount> OAuthAccounts => Set<OAuthAccount>();
 18  ❌     0         public DbSet<RoutingPolicy> RoutingPolicies => Set<RoutingPolicy>();
 19  ❌     0         public DbSet<ModelAlias> ModelAliases => Set<ModelAlias>();
 20  ❌     0         public DbSet<ModelCombo> ModelCombos => Set<ModelCombo>();
 21  ❌     0         public DbSet<ProviderAccount> ProviderAccounts => Set<ProviderAccount>();
 22  ✔   1732         public DbSet<ModelCost> ModelCosts => Set<ModelCost>();
 23  ❌     0         public DbSet<RequestLog> RequestLogs => Set<RequestLog>();
 24  ❌     0         public DbSet<TokenUsage> TokenUsages => Set<TokenUsage>();
 25  ❌     0         public DbSet<QuotaSnapshot> QuotaSnapshots => Set<QuotaSnapshot>();
 26  ✔      5         public DbSet<DeviationEntry> Deviations => Set<DeviationEntry>();
 27  ✔     37         public DbSet<AuditLog> AuditLogs => Set<AuditLog>();
 28  ✔  31373         public DbSet<GlobalModel> GlobalModels => Set<GlobalModel>();
 29  ✔   4548         public DbSet<ProviderModel> ProviderModels => Set<ProviderModel>();
 30  ❌     0         public DbSet<TenantModelLimit> TenantModelLimits => Set<TenantModelLimit>();
 31               
 32                   protected override void OnModelCreating(ModelBuilder modelBuilder)
 33  ✔      4         {
 34  ✔      4             modelBuilder.Entity<Tenant>(entity =>
 35  ✔      4             {
 36  ✔      4                 entity.HasKey(t => t.Id);
 37  ✔      4                 entity.Property(t => t.Name).HasMaxLength(200).IsRequired();
 38  ✔      4                 entity.Property(t => t.Region).HasConversion<string>().IsRequired();
 39  ✔      4                 entity.Property(t => t.Status).HasConversion<string>().IsRequired();
 40  ✔      4                 entity.HasMany(t => t.Projects).WithOne(p => p.Tenant).HasForeignKey(p => p.TenantId);
 41  ✔      4                 entity.HasMany(t => t.Users).WithOne(u => u.Tenant).HasForeignKey(u => u.TenantId);
 42  ✔      4                 entity.HasMany(t => t.OAuthAccounts).WithOne(o => o.Tenant).HasForeignKey(o => o.TenantId);
 43  ✔      8             });
 44               
 45  ✔      4             modelBuilder.Entity<User>(entity =>
 46  ✔      4             {
 47  ✔      4                 entity.HasKey(u => u.Id);
 48  ✔      4                 entity.Property(u => u.Email).HasMaxLength(320).IsRequired();
 49  ✔      4                 entity.Property(u => u.AuthProvider).HasMaxLength(50).IsRequired();
 50  ✔      4                 entity.Property(u => u.ProviderUserId).HasMaxLength(200).IsRequired();
 51  ✔      4                 entity.Property(u => u.Role).HasConversion<string>().IsRequired();
 52  ✔      8             });
 53               
 54  ✔      4             modelBuilder.Entity<Project>(entity =>
 55  ✔      4             {
 56  ✔      4                 entity.HasKey(p => p.Id);
 57  ✔      4                 entity.Property(p => p.Name).HasMaxLength(200).IsRequired();
 58  ✔      4                 entity.Property(p => p.Status).HasConversion<string>().IsRequired();
 59  ✔      4                 entity.HasMany(p => p.ApiKeys).WithOne(k => k.Project).HasForeignKey(k => k.ProjectId);
 60  ✔      8             });
 61               
 62  ✔      4             modelBuilder.Entity<Project>()
 63  ✔      4                 .HasMany(p => p.Users)
 64  ✔      4                 .WithMany(u => u.Projects)
 65  ✔      4                 .UsingEntity<Dictionary<string, object>>(
 66  ✔      4                     "ProjectUsers",
 67  ✔      4                     join => join.HasOne<User>().WithMany().HasForeignKey("UserId"),
 68  ✔      8                     join => join.HasOne<Project>().WithMany().HasForeignKey("ProjectId"));
 69               
 70  ✔      4             modelBuilder.Entity<ApiKey>(entity =>
 71  ✔      4             {
 72  ✔      4                 entity.HasKey(k => k.Id);
 73  ✔      4                 entity.Property(k => k.KeyHash).HasMaxLength(512).IsRequired();
 74  ✔      4                 entity.Property(k => k.Name).HasMaxLength(200).IsRequired();
 75  ✔      4                 entity.Property(k => k.Status).HasConversion<string>().IsRequired();
 76  ✔      8             });
 77               
 78  ✔      4             modelBuilder.Entity<OAuthAccount>(entity =>
 79  ✔      4             {
 80  ✔      4                 entity.HasKey(o => o.Id);
 81  ✔      4                 entity.Property(o => o.Provider).HasMaxLength(50).IsRequired();
 82  ✔      4                 entity.Property(o => o.Status).HasConversion<string>().IsRequired();
 83  ✔      8             });
 84               
 85  ✔      4             modelBuilder.Entity<RoutingPolicy>(entity =>
 86  ✔      4             {
 87  ✔      4                 entity.HasKey(r => r.Id);
 88  ✔      4                 entity.Property(r => r.PolicyJson).HasColumnType("jsonb");
 89  ✔      8             });
 90               
 91  ✔      4             modelBuilder.Entity<ModelAlias>(entity =>
 92  ✔      4             {
 93  ✔      4                 entity.HasKey(m => m.Id);
 94  ✔      4                 entity.Property(m => m.Alias).HasMaxLength(200).IsRequired();
 95  ✔      4                 entity.Property(m => m.TargetModel).HasMaxLength(200).IsRequired();
 96  ✔      8             });
 97               
 98  ✔      4             modelBuilder.Entity<ModelCombo>(entity =>
 99  ✔      4             {
100  ✔      4                 entity.HasKey(m => m.Id);
101  ✔      4                 entity.Property(m => m.Name).HasMaxLength(200).IsRequired();
102  ✔      4                 entity.Property(m => m.OrderedModelsJson).HasColumnType("jsonb");
103  ✔      8             });
104               
105  ✔      4             modelBuilder.Entity<ProviderAccount>(entity =>
106  ✔      4             {
107  ✔      4                 entity.HasKey(p => p.Id);
108  ✔      4                 entity.Property(p => p.Provider).HasMaxLength(100).IsRequired();
109  ✔      4                 entity.Property(p => p.AccountId).HasMaxLength(200).IsRequired();
110  ✔      4                 entity.Property(p => p.Status).HasConversion<string>().IsRequired();
111  ✔      8             });
112               
113  ✔      4             modelBuilder.Entity<ModelCost>(entity =>
114  ✔      4             {
115  ✔      4                 entity.HasKey(m => new { m.Provider, m.Model });
116  ✔      4                 entity.Property(m => m.Provider).HasMaxLength(100).IsRequired();
117  ✔      4                 entity.Property(m => m.Model).HasMaxLength(200).IsRequired();
118  ✔      8             });
119               
120  ✔      4             modelBuilder.Entity<RequestLog>(entity =>
121  ✔      4             {
122  ✔      4                 entity.HasKey(r => r.Id);
123  ✔      4                 entity.Property(r => r.RequestId).HasMaxLength(200).IsRequired();
124  ✔      4                 entity.Property(r => r.Endpoint).HasMaxLength(200).IsRequired();
125  ✔      4                 entity.Property(r => r.Model).HasMaxLength(200);
126  ✔      4                 entity.Property(r => r.Provider).HasMaxLength(200);
127  ✔      8             });
128               
129  ✔      4             modelBuilder.Entity<TokenUsage>(entity =>
130  ✔      4             {
131  ✔      4                 entity.HasKey(t => t.Id);
132  ✔      4                 entity.Property(t => t.RequestId).HasMaxLength(200).IsRequired();
133  ✔      8             });
134               
135  ✔      4             modelBuilder.Entity<QuotaSnapshot>(entity =>
136  ✔      4             {
137  ✔      4                 entity.HasKey(q => q.Id);
138  ✔      4                 entity.Property(q => q.Provider).HasMaxLength(100).IsRequired();
139  ✔      4                 entity.Property(q => q.AccountId).HasMaxLength(200).IsRequired();
140  ✔      4                 entity.Property(q => q.QuotaJson).HasColumnType("jsonb");
141  ✔      8             });
142               
143  ✔      4             modelBuilder.Entity<DeviationEntry>(entity =>
144  ✔      4             {
145  ✔      4                 entity.HasKey(d => d.Id);
146  ✔      4                 entity.Property(d => d.Endpoint).HasMaxLength(200).IsRequired();
147  ✔      4                 entity.Property(d => d.Field).HasMaxLength(200).IsRequired();
148  ✔      4                 entity.Property(d => d.Reason).HasMaxLength(500).IsRequired();
149  ✔      4                 entity.Property(d => d.Mitigation).HasMaxLength(500).IsRequired();
150  ✔      4                 entity.Property(d => d.Status).HasConversion<string>().IsRequired();
151  ✔      8             });
152               
153  ✔      4             modelBuilder.Entity<AuditLog>(entity =>
154  ✔      4             {
155  ✔      4                 entity.HasKey(a => a.Id);
156  ✔      4                 entity.Property(a => a.Action).HasMaxLength(200).IsRequired();
157  ✔      4                 entity.Property(a => a.PayloadJson).HasColumnType("jsonb");
158  ✔      8             });
159               
160  ✔      4             modelBuilder.Entity<GlobalModel>(entity =>
161  ✔      4             {
162  ✔      4                 entity.HasKey(g => g.Id);
163  ✔      4                 entity.Property(g => g.Name).HasMaxLength(200).IsRequired();
164  ✔      4                 entity.Property(g => g.Family).HasMaxLength(200).IsRequired();
165  ✔      4                 entity.Property(g => g.Description).HasMaxLength(1000);
166  ✔      4                 // Prices: high precision for small token prices
167  ✔      4                 entity.Property(g => g.InputPrice).HasPrecision(18, 9);
168  ✔      4                 entity.Property(g => g.OutputPrice).HasPrecision(18, 9);
169  ✔      8             });
170               
171  ✔      4             modelBuilder.Entity<ProviderModel>(entity =>
172  ✔      4             {
173  ✔      4                 entity.HasKey(p => p.Id);
174  ✔      4                 entity.Property(p => p.ProviderId).HasMaxLength(100).IsRequired();
175  ✔      4                 entity.Property(p => p.ProviderSpecificId).HasMaxLength(200).IsRequired();
176  ✔      4                 entity.HasOne(p => p.GlobalModel).WithMany(g => g.ProviderModels).HasForeignKey(p => p.GlobalModelId).OnDele
177  ✔      4                 entity.Property(p => p.OverrideInputPrice).HasPrecision(18, 9);
178  ✔      4                 entity.Property(p => p.OverrideOutputPrice).HasPrecision(18, 9);
179  ✔      8             });
180               
181  ✔      4             modelBuilder.Entity<TenantModelLimit>(entity =>
182  ✔      4             {
183  ✔      4                 entity.HasKey(t => t.Id);
184  ✔      4                 entity.Property(t => t.TenantId).HasMaxLength(200).IsRequired();
185  ✔      4                 entity.HasOne(t => t.GlobalModel).WithMany().HasForeignKey(t => t.GlobalModelId).OnDelete(DeleteBehavior.Cas
186  ✔      4                 entity.Property(t => t.MonthlyBudget).HasPrecision(18, 9);
187  ✔      8             });
188  ✔      4         }
189               }
```
# Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneExtensions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/ControlPlaneExtensions.cs |
| **Line coverage:** | 100% (19 of 19) |
| Covered lines: | 19 |
| Uncovered lines: | 0 |
| Coverable lines: | 19 |
| Total lines: | 32 |
| **Branch coverage:** | 100% (4 of 4) |
| Covered branches: | 4 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddControlPlane(...)** | 100% | 4 | 4 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/ControlPlaneExtensions.cs
```
 1             using Microsoft.EntityFrameworkCore;
 2             using Microsoft.Extensions.Configuration;
 3             using Microsoft.Extensions.DependencyInjection;
 4             using Synaxis.InferenceGateway.Application.ControlPlane;
 5             
 6             namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 7             
 8             public static class ControlPlaneExtensions
 9             {
10                 public static IServiceCollection AddControlPlane(this IServiceCollection services, IConfiguration configuration)
11  ✔   37         {
12  ✔   37             services.AddDbContext<ControlPlaneDbContext>((sp, builder) =>
13  ✔  184             {
14  ✔  184                 var config = sp.GetRequiredService<IConfiguration>();
15  ✔  183                 var options = new ControlPlaneOptions();
16  ✔  183                 config.GetSection("Synaxis:ControlPlane").Bind(options);
17  ✔   37     
18  ✔  183  ●              if (options.UseInMemory || string.IsNullOrWhiteSpace(options.ConnectionString))
19  ✔    8                 {
20  ✔    8                     builder.UseInMemoryDatabase("SynaxisControlPlane");
21  ✔    8                 }
22  ✔   37                 else
23  ✔  175                 {
24  ✔  175                     builder.UseNpgsql(options.ConnectionString);
25  ✔  175                 }
26  ✔  220             });
27             
28  ✔   37             services.AddScoped<IDeviationRegistry, DeviationRegistry>();
29             
30  ✔   37             return services;
31  ✔   37         }
32             }
```
# Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneOptions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneOptions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/ControlPlaneOptions.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 8 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_ConnectionString()** | 100% | 1 | 1 | 100% |
| **get_Region()** | 100% | 1 | 1 | 100% |
| **get_UseInMemory()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/ControlPlaneOptions.cs
```
1             namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane;
2             
3             public sealed class ControlPlaneOptions
4             {
5  ✔  716         public string ConnectionString { get; set; } = string.Empty;
6  ✔  366         public string Region { get; set; } = "us";
7  ✔  366         public bool UseInMemory { get; set; }
8             }
```
# Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneStore

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ControlPlane.ControlPlaneStore |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/ControlPlaneStore.cs |
| **Line coverage:** | 50% (10 of 20) |
| Covered lines: | 10 |
| Uncovered lines: | 10 |
| Coverable lines: | 20 |
| Total lines: | 37 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **GetAliasAsync()** | 100% | 2 | 1 | 0% |
| **GetComboAsync()** | 100% | 2 | 1 | 0% |
| **GetGlobalModelAsync()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/ControlPlaneStore.cs
```
 1            using Microsoft.EntityFrameworkCore;
 2            using Synaxis.InferenceGateway.Application.ControlPlane;
 3            using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 4            
 5            namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 6            
 7            public sealed class ControlPlaneStore : IControlPlaneStore
 8            {
 9                private readonly ControlPlaneDbContext _dbContext;
10            
11  ✔  15         public ControlPlaneStore(ControlPlaneDbContext dbContext)
12  ✔  15         {
13  ✔  15             _dbContext = dbContext;
14  ✔  15         }
15            
16                public async Task<ModelAlias?> GetAliasAsync(Guid tenantId, string alias, CancellationToken cancellationToken = defa
17  ❌  0         {
18  ❌  0             return await _dbContext.ModelAliases
19  ❌  0                 .AsNoTracking()
20  ❌  0                 .FirstOrDefaultAsync(a => a.TenantId == tenantId && a.Alias == alias, cancellationToken);
21  ❌  0         }
22            
23                public async Task<ModelCombo?> GetComboAsync(Guid tenantId, string name, CancellationToken cancellationToken = defau
24  ❌  0         {
25  ❌  0             return await _dbContext.ModelCombos
26  ❌  0                 .AsNoTracking()
27  ❌  0                 .FirstOrDefaultAsync(c => c.TenantId == tenantId && c.Name == name, cancellationToken);
28  ❌  0         }
29            
30                public async Task<GlobalModel?> GetGlobalModelAsync(string id, CancellationToken cancellationToken = default)
31  ✔  17         {
32  ✔  17             return await _dbContext.GlobalModels
33  ✔  17                 .AsNoTracking()
34  ✔  17                 .Include(g => g.ProviderModels)
35  ✔  17                 .FirstOrDefaultAsync(g => g.Id == id, cancellationToken);
36  ✔  17         }
37            }
```
# Synaxis.InferenceGateway.Infrastructure.ControlPlane.DeviationRegistry

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ControlPlane.DeviationRegistry |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/DeviationRegistry.cs |
| **Line coverage:** | 92.8% (26 of 28) |
| Covered lines: | 26 |
| Uncovered lines: | 2 |
| Coverable lines: | 28 |
| Total lines: | 49 |
| **Branch coverage:** | 75% (3 of 4) |
| Covered branches: | 3 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **RegisterAsync()** | 100% | 2 | 2 | 100% |
| **ListAsync()** | 100% | 1 | 1 | 100% |
| **UpdateStatusAsync()** | 50.0% | 2 | 2 | 77.77% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/DeviationRegistry.cs
```
 1           using Microsoft.EntityFrameworkCore;
 2           using Synaxis.InferenceGateway.Application.ControlPlane;
 3           using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 4           
 5           namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 6           
 7           public sealed class DeviationRegistry : IDeviationRegistry
 8           {
 9               private readonly ControlPlaneDbContext _dbContext;
10           
11  ✔  2         public DeviationRegistry(ControlPlaneDbContext dbContext)
12  ✔  2         {
13  ✔  2             _dbContext = dbContext;
14  ✔  2         }
15           
16               public async Task RegisterAsync(DeviationEntry entry, CancellationToken cancellationToken = default)
17  ✔  2         {
18  ✔  2  ●          if (entry.Id == Guid.Empty)
19  ✔  2             {
20  ✔  2                 entry.Id = Guid.NewGuid();
21  ✔  2             }
22           
23  ✔  2             _dbContext.Deviations.Add(entry);
24  ✔  2             await _dbContext.SaveChangesAsync(cancellationToken);
25  ✔  2         }
26           
27               public async Task<IReadOnlyList<DeviationEntry>> ListAsync(Guid tenantId, CancellationToken cancellationToken = defa
28  ✔  2         {
29  ✔  2             return await _dbContext.Deviations
30  ✔  2                 .AsNoTracking()
31  ✔  2                 .Where(d => d.TenantId == tenantId)
32  ✔  2                 .OrderByDescending(d => d.CreatedAt)
33  ✔  2                 .ToListAsync(cancellationToken);
34  ✔  2         }
35           
36               public async Task UpdateStatusAsync(Guid deviationId, DeviationStatus status, CancellationToken cancellationToken = 
37  ✔  1         {
38  ✔  1             var deviation = await _dbContext.Deviations
39  ✔  1                 .FirstOrDefaultAsync(d => d.Id == deviationId, cancellationToken);
40           
41  ✓  1  ◑          if (deviation == null)
42  ❌ 0             {
43  ❌ 0                 return;
44                   }
45           
46  ✔  1             deviation.Status = status;
47  ✔  1             await _dbContext.SaveChangesAsync(cancellationToken);
48  ✔  1         }
49           }
```
# Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations.AddDynamicModelRegistry

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations.AddDynamicModelRegistry |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/20260129134724_AddDynamicModelRegistry.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/20260129134724_AddDynamicModelRegistry.Designer.cs |
| **Line coverage:** | 99.1% (923 of 931) |
| Covered lines: | 923 |
| Uncovered lines: | 8 |
| Coverable lines: | 931 |
| Total lines: | 1016 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Up(...)** | 100% | 1 | 1 | 100% |
| **BuildTargetModel(...)** | 100% | 1 | 1 | 100% |
| **Down(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/20260129134724_AddDynamicModelRegistry.cs
```
  1            using System;
  2            using Microsoft.EntityFrameworkCore.Migrations;
  3            using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;
  4            
  5            #nullable disable
  6            
  7            namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations
  8            {
  9                /// <inheritdoc />
 10                public partial class AddDynamicModelRegistry : Migration
 11                {
 12                    /// <inheritdoc />
 13                    protected override void Up(MigrationBuilder migrationBuilder)
 14  ✔  22             {
 15  ✔  22                 migrationBuilder.CreateTable(
 16  ✔  22                     name: "GlobalModels",
 17  ✔  22                     columns: table => new
 18  ✔  22                     {
 19  ✔  22                         Id = table.Column<string>(type: "text", nullable: false),
 20  ✔  22                         Name = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
 21  ✔  22                         Family = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
 22  ✔  22                         Description = table.Column<string>(type: "character varying(1000)", maxLength: 1000, nullable: true)
 23  ✔  22                         ReleaseDate = table.Column<DateTime>(type: "timestamp with time zone", nullable: true),
 24  ✔  22                         ContextWindow = table.Column<int>(type: "integer", nullable: false),
 25  ✔  22                         MaxOutputTokens = table.Column<int>(type: "integer", nullable: false),
 26  ✔  22                         InputPrice = table.Column<decimal>(type: "numeric(18,9)", precision: 18, scale: 9, nullable: false),
 27  ✔  22                         OutputPrice = table.Column<decimal>(type: "numeric(18,9)", precision: 18, scale: 9, nullable: false)
 28  ✔  22                         IsOpenWeights = table.Column<bool>(type: "boolean", nullable: false),
 29  ✔  22                         SupportsTools = table.Column<bool>(type: "boolean", nullable: false),
 30  ✔  22                         SupportsReasoning = table.Column<bool>(type: "boolean", nullable: false),
 31  ✔  22                         SupportsVision = table.Column<bool>(type: "boolean", nullable: false),
 32  ✔  22                         SupportsAudio = table.Column<bool>(type: "boolean", nullable: false),
 33  ✔  22                         SupportsStructuredOutput = table.Column<bool>(type: "boolean", nullable: false)
 34  ✔  22                     },
 35  ✔  22                     constraints: table =>
 36  ✔  22                     {
 37  ✔  22                         table.PrimaryKey("PK_GlobalModels", x => x.Id);
 38  ✔  44                     });
 39            
 40  ✔  22                 migrationBuilder.CreateTable(
 41  ✔  22                     name: "ProviderModels",
 42  ✔  22                     columns: table => new
 43  ✔  22                     {
 44  ✔  22                         Id = table.Column<int>(type: "integer", nullable: false)
 45  ✔  22                             .Annotation("Npgsql:ValueGenerationStrategy", NpgsqlValueGenerationStrategy.IdentityByDefaultCol
 46  ✔  22                         ProviderId = table.Column<string>(type: "character varying(100)", maxLength: 100, nullable: false),
 47  ✔  22                         GlobalModelId = table.Column<string>(type: "text", nullable: false),
 48  ✔  22                         ProviderSpecificId = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: 
 49  ✔  22                         IsAvailable = table.Column<bool>(type: "boolean", nullable: false),
 50  ✔  22                         OverrideInputPrice = table.Column<decimal>(type: "numeric(18,9)", precision: 18, scale: 9, nullable:
 51  ✔  22                         OverrideOutputPrice = table.Column<decimal>(type: "numeric(18,9)", precision: 18, scale: 9, nullable
 52  ✔  22                         RateLimitRPM = table.Column<int>(type: "integer", nullable: true),
 53  ✔  22                         RateLimitTPM = table.Column<int>(type: "integer", nullable: true)
 54  ✔  22                     },
 55  ✔  22                     constraints: table =>
 56  ✔  22                     {
 57  ✔  22                         table.PrimaryKey("PK_ProviderModels", x => x.Id);
 58  ✔  22                         table.ForeignKey(
 59  ✔  22                             name: "FK_ProviderModels_GlobalModels_GlobalModelId",
 60  ✔  22                             column: x => x.GlobalModelId,
 61  ✔  22                             principalTable: "GlobalModels",
 62  ✔  22                             principalColumn: "Id",
 63  ✔  22                             onDelete: ReferentialAction.Cascade);
 64  ✔  44                     });
 65            
 66  ✔  22                 migrationBuilder.CreateTable(
 67  ✔  22                     name: "TenantModelLimits",
 68  ✔  22                     columns: table => new
 69  ✔  22                     {
 70  ✔  22                         Id = table.Column<int>(type: "integer", nullable: false)
 71  ✔  22                             .Annotation("Npgsql:ValueGenerationStrategy", NpgsqlValueGenerationStrategy.IdentityByDefaultCol
 72  ✔  22                         TenantId = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
 73  ✔  22                         GlobalModelId = table.Column<string>(type: "text", nullable: false),
 74  ✔  22                         AllowedRPM = table.Column<int>(type: "integer", nullable: true),
 75  ✔  22                         MonthlyBudget = table.Column<decimal>(type: "numeric(18,9)", precision: 18, scale: 9, nullable: true
 76  ✔  22                     },
 77  ✔  22                     constraints: table =>
 78  ✔  22                     {
 79  ✔  22                         table.PrimaryKey("PK_TenantModelLimits", x => x.Id);
 80  ✔  22                         table.ForeignKey(
 81  ✔  22                             name: "FK_TenantModelLimits_GlobalModels_GlobalModelId",
 82  ✔  22                             column: x => x.GlobalModelId,
 83  ✔  22                             principalTable: "GlobalModels",
 84  ✔  22                             principalColumn: "Id",
 85  ✔  22                             onDelete: ReferentialAction.Cascade);
 86  ✔  44                     });
 87            
 88  ✔  22                 migrationBuilder.CreateIndex(
 89  ✔  22                     name: "IX_ProviderModels_GlobalModelId",
 90  ✔  22                     table: "ProviderModels",
 91  ✔  22                     column: "GlobalModelId");
 92            
 93  ✔  22                 migrationBuilder.CreateIndex(
 94  ✔  22                     name: "IX_TenantModelLimits_GlobalModelId",
 95  ✔  22                     table: "TenantModelLimits",
 96  ✔  22                     column: "GlobalModelId");
 97  ✔  22             }
 98            
 99                    /// <inheritdoc />
100                    protected override void Down(MigrationBuilder migrationBuilder)
101  ❌  0             {
102  ❌  0                 migrationBuilder.DropTable(
103  ❌  0                     name: "ProviderModels");
104            
105  ❌  0                 migrationBuilder.DropTable(
106  ❌  0                     name: "TenantModelLimits");
107            
108  ❌  0                 migrationBuilder.DropTable(
109  ❌  0                     name: "GlobalModels");
110  ❌  0             }
111                }
112            }
```
### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/20260129134724_AddDynamicModelRegistry.Designer.cs
```
  1            // <auto-generated />
  2            using System;
  3            using Microsoft.EntityFrameworkCore;
  4            using Microsoft.EntityFrameworkCore.Infrastructure;
  5            using Microsoft.EntityFrameworkCore.Migrations;
  6            using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
  7            using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;
  8            using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
  9            
 10            #nullable disable
 11            
 12            namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations
 13            {
 14                [DbContext(typeof(ControlPlaneDbContext))]
 15                [Migration("20260129134724_AddDynamicModelRegistry")]
 16                partial class AddDynamicModelRegistry
 17                {
 18                    /// <inheritdoc />
 19                    protected override void BuildTargetModel(ModelBuilder modelBuilder)
 20  ✔  11             {
 21            #pragma warning disable 612, 618
 22  ✔  11                 modelBuilder
 23  ✔  11                     .HasAnnotation("ProductVersion", "10.0.2")
 24  ✔  11                     .HasAnnotation("Relational:MaxIdentifierLength", 63);
 25            
 26  ✔  11                 NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);
 27            
 28  ✔  11                 modelBuilder.Entity("ProjectUsers", b =>
 29  ✔  11                     {
 30  ✔  11                         b.Property<Guid>("ProjectId")
 31  ✔  11                             .HasColumnType("uuid");
 32  ✔  11     
 33  ✔  11                         b.Property<Guid>("UserId")
 34  ✔  11                             .HasColumnType("uuid");
 35  ✔  11     
 36  ✔  11                         b.HasKey("ProjectId", "UserId");
 37  ✔  11     
 38  ✔  11                         b.HasIndex("UserId");
 39  ✔  11     
 40  ✔  11                         b.ToTable("ProjectUsers");
 41  ✔  22                     });
 42            
 43  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ApiKey", b =>
 44  ✔  11                     {
 45  ✔  11                         b.Property<Guid>("Id")
 46  ✔  11                             .ValueGeneratedOnAdd()
 47  ✔  11                             .HasColumnType("uuid");
 48  ✔  11     
 49  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
 50  ✔  11                             .HasColumnType("timestamp with time zone");
 51  ✔  11     
 52  ✔  11                         b.Property<string>("KeyHash")
 53  ✔  11                             .IsRequired()
 54  ✔  11                             .HasMaxLength(512)
 55  ✔  11                             .HasColumnType("character varying(512)");
 56  ✔  11     
 57  ✔  11                         b.Property<string>("Name")
 58  ✔  11                             .IsRequired()
 59  ✔  11                             .HasMaxLength(200)
 60  ✔  11                             .HasColumnType("character varying(200)");
 61  ✔  11     
 62  ✔  11                         b.Property<Guid>("ProjectId")
 63  ✔  11                             .HasColumnType("uuid");
 64  ✔  11     
 65  ✔  11                         b.Property<string>("Status")
 66  ✔  11                             .IsRequired()
 67  ✔  11                             .HasColumnType("text");
 68  ✔  11     
 69  ✔  11                         b.HasKey("Id");
 70  ✔  11     
 71  ✔  11                         b.HasIndex("ProjectId");
 72  ✔  11     
 73  ✔  11                         b.ToTable("ApiKeys");
 74  ✔  22                     });
 75            
 76  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.AuditLog", b =>
 77  ✔  11                     {
 78  ✔  11                         b.Property<Guid>("Id")
 79  ✔  11                             .ValueGeneratedOnAdd()
 80  ✔  11                             .HasColumnType("uuid");
 81  ✔  11     
 82  ✔  11                         b.Property<string>("Action")
 83  ✔  11                             .IsRequired()
 84  ✔  11                             .HasMaxLength(200)
 85  ✔  11                             .HasColumnType("character varying(200)");
 86  ✔  11     
 87  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
 88  ✔  11                             .HasColumnType("timestamp with time zone");
 89  ✔  11     
 90  ✔  11                         b.Property<string>("PayloadJson")
 91  ✔  11                             .HasColumnType("jsonb");
 92  ✔  11     
 93  ✔  11                         b.Property<Guid>("TenantId")
 94  ✔  11                             .HasColumnType("uuid");
 95  ✔  11     
 96  ✔  11                         b.Property<Guid?>("UserId")
 97  ✔  11                             .HasColumnType("uuid");
 98  ✔  11     
 99  ✔  11                         b.HasKey("Id");
100  ✔  11     
101  ✔  11                         b.HasIndex("TenantId");
102  ✔  11     
103  ✔  11                         b.HasIndex("UserId");
104  ✔  11     
105  ✔  11                         b.ToTable("AuditLogs");
106  ✔  22                     });
107            
108  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.DeviationEntry", b =>
109  ✔  11                     {
110  ✔  11                         b.Property<Guid>("Id")
111  ✔  11                             .ValueGeneratedOnAdd()
112  ✔  11                             .HasColumnType("uuid");
113  ✔  11     
114  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
115  ✔  11                             .HasColumnType("timestamp with time zone");
116  ✔  11     
117  ✔  11                         b.Property<string>("Endpoint")
118  ✔  11                             .IsRequired()
119  ✔  11                             .HasMaxLength(200)
120  ✔  11                             .HasColumnType("character varying(200)");
121  ✔  11     
122  ✔  11                         b.Property<string>("Field")
123  ✔  11                             .IsRequired()
124  ✔  11                             .HasMaxLength(200)
125  ✔  11                             .HasColumnType("character varying(200)");
126  ✔  11     
127  ✔  11                         b.Property<string>("Mitigation")
128  ✔  11                             .IsRequired()
129  ✔  11                             .HasMaxLength(500)
130  ✔  11                             .HasColumnType("character varying(500)");
131  ✔  11     
132  ✔  11                         b.Property<string>("Reason")
133  ✔  11                             .IsRequired()
134  ✔  11                             .HasMaxLength(500)
135  ✔  11                             .HasColumnType("character varying(500)");
136  ✔  11     
137  ✔  11                         b.Property<string>("Status")
138  ✔  11                             .IsRequired()
139  ✔  11                             .HasColumnType("text");
140  ✔  11     
141  ✔  11                         b.Property<Guid>("TenantId")
142  ✔  11                             .HasColumnType("uuid");
143  ✔  11     
144  ✔  11                         b.HasKey("Id");
145  ✔  11     
146  ✔  11                         b.HasIndex("TenantId");
147  ✔  11     
148  ✔  11                         b.ToTable("Deviations");
149  ✔  22                     });
150            
151  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel", b =>
152  ✔  11                     {
153  ✔  11                         b.Property<string>("Id")
154  ✔  11                             .HasColumnType("text");
155  ✔  11     
156  ✔  11                         b.Property<int>("ContextWindow")
157  ✔  11                             .HasColumnType("integer");
158  ✔  11     
159  ✔  11                         b.Property<string>("Description")
160  ✔  11                             .HasMaxLength(1000)
161  ✔  11                             .HasColumnType("character varying(1000)");
162  ✔  11     
163  ✔  11                         b.Property<string>("Family")
164  ✔  11                             .IsRequired()
165  ✔  11                             .HasMaxLength(200)
166  ✔  11                             .HasColumnType("character varying(200)");
167  ✔  11     
168  ✔  11                         b.Property<decimal>("InputPrice")
169  ✔  11                             .HasPrecision(18, 9)
170  ✔  11                             .HasColumnType("numeric(18,9)");
171  ✔  11     
172  ✔  11                         b.Property<bool>("IsOpenWeights")
173  ✔  11                             .HasColumnType("boolean");
174  ✔  11     
175  ✔  11                         b.Property<int>("MaxOutputTokens")
176  ✔  11                             .HasColumnType("integer");
177  ✔  11     
178  ✔  11                         b.Property<string>("Name")
179  ✔  11                             .IsRequired()
180  ✔  11                             .HasMaxLength(200)
181  ✔  11                             .HasColumnType("character varying(200)");
182  ✔  11     
183  ✔  11                         b.Property<decimal>("OutputPrice")
184  ✔  11                             .HasPrecision(18, 9)
185  ✔  11                             .HasColumnType("numeric(18,9)");
186  ✔  11     
187  ✔  11                         b.Property<DateTime?>("ReleaseDate")
188  ✔  11                             .HasColumnType("timestamp with time zone");
189  ✔  11     
190  ✔  11                         b.Property<bool>("SupportsAudio")
191  ✔  11                             .HasColumnType("boolean");
192  ✔  11     
193  ✔  11                         b.Property<bool>("SupportsReasoning")
194  ✔  11                             .HasColumnType("boolean");
195  ✔  11     
196  ✔  11                         b.Property<bool>("SupportsStructuredOutput")
197  ✔  11                             .HasColumnType("boolean");
198  ✔  11     
199  ✔  11                         b.Property<bool>("SupportsTools")
200  ✔  11                             .HasColumnType("boolean");
201  ✔  11     
202  ✔  11                         b.Property<bool>("SupportsVision")
203  ✔  11                             .HasColumnType("boolean");
204  ✔  11     
205  ✔  11                         b.HasKey("Id");
206  ✔  11     
207  ✔  11                         b.ToTable("GlobalModels");
208  ✔  22                     });
209            
210  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelAlias", b =>
211  ✔  11                     {
212  ✔  11                         b.Property<Guid>("Id")
213  ✔  11                             .ValueGeneratedOnAdd()
214  ✔  11                             .HasColumnType("uuid");
215  ✔  11     
216  ✔  11                         b.Property<string>("Alias")
217  ✔  11                             .IsRequired()
218  ✔  11                             .HasMaxLength(200)
219  ✔  11                             .HasColumnType("character varying(200)");
220  ✔  11     
221  ✔  11                         b.Property<string>("TargetModel")
222  ✔  11                             .IsRequired()
223  ✔  11                             .HasMaxLength(200)
224  ✔  11                             .HasColumnType("character varying(200)");
225  ✔  11     
226  ✔  11                         b.Property<Guid>("TenantId")
227  ✔  11                             .HasColumnType("uuid");
228  ✔  11     
229  ✔  11                         b.HasKey("Id");
230  ✔  11     
231  ✔  11                         b.HasIndex("TenantId");
232  ✔  11     
233  ✔  11                         b.ToTable("ModelAliases");
234  ✔  22                     });
235            
236  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCombo", b =>
237  ✔  11                     {
238  ✔  11                         b.Property<Guid>("Id")
239  ✔  11                             .ValueGeneratedOnAdd()
240  ✔  11                             .HasColumnType("uuid");
241  ✔  11     
242  ✔  11                         b.Property<string>("Name")
243  ✔  11                             .IsRequired()
244  ✔  11                             .HasMaxLength(200)
245  ✔  11                             .HasColumnType("character varying(200)");
246  ✔  11     
247  ✔  11                         b.Property<string>("OrderedModelsJson")
248  ✔  11                             .IsRequired()
249  ✔  11                             .HasColumnType("jsonb");
250  ✔  11     
251  ✔  11                         b.Property<Guid>("TenantId")
252  ✔  11                             .HasColumnType("uuid");
253  ✔  11     
254  ✔  11                         b.HasKey("Id");
255  ✔  11     
256  ✔  11                         b.HasIndex("TenantId");
257  ✔  11     
258  ✔  11                         b.ToTable("ModelCombos");
259  ✔  22                     });
260            
261  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCost", b =>
262  ✔  11                     {
263  ✔  11                         b.Property<string>("Provider")
264  ✔  11                             .HasMaxLength(100)
265  ✔  11                             .HasColumnType("character varying(100)");
266  ✔  11     
267  ✔  11                         b.Property<string>("Model")
268  ✔  11                             .HasMaxLength(200)
269  ✔  11                             .HasColumnType("character varying(200)");
270  ✔  11     
271  ✔  11                         b.Property<decimal>("CostPerToken")
272  ✔  11                             .HasColumnType("numeric");
273  ✔  11     
274  ✔  11                         b.Property<bool>("FreeTier")
275  ✔  11                             .HasColumnType("boolean");
276  ✔  11     
277  ✔  11                         b.HasKey("Provider", "Model");
278  ✔  11     
279  ✔  11                         b.ToTable("ModelCosts");
280  ✔  22                     });
281            
282  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.OAuthAccount", b =>
283  ✔  11                     {
284  ✔  11                         b.Property<Guid>("Id")
285  ✔  11                             .ValueGeneratedOnAdd()
286  ✔  11                             .HasColumnType("uuid");
287  ✔  11     
288  ✔  11                         b.Property<byte[]>("AccessTokenEncrypted")
289  ✔  11                             .IsRequired()
290  ✔  11                             .HasColumnType("bytea");
291  ✔  11     
292  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
293  ✔  11                             .HasColumnType("timestamp with time zone");
294  ✔  11     
295  ✔  11                         b.Property<DateTimeOffset?>("ExpiresAt")
296  ✔  11                             .HasColumnType("timestamp with time zone");
297  ✔  11     
298  ✔  11                         b.Property<string>("Provider")
299  ✔  11                             .IsRequired()
300  ✔  11                             .HasMaxLength(50)
301  ✔  11                             .HasColumnType("character varying(50)");
302  ✔  11     
303  ✔  11                         b.Property<byte[]>("RefreshTokenEncrypted")
304  ✔  11                             .HasColumnType("bytea");
305  ✔  11     
306  ✔  11                         b.Property<string>("Status")
307  ✔  11                             .IsRequired()
308  ✔  11                             .HasColumnType("text");
309  ✔  11     
310  ✔  11                         b.Property<Guid>("TenantId")
311  ✔  11                             .HasColumnType("uuid");
312  ✔  11     
313  ✔  11                         b.HasKey("Id");
314  ✔  11     
315  ✔  11                         b.HasIndex("TenantId");
316  ✔  11     
317  ✔  11                         b.ToTable("OAuthAccounts");
318  ✔  22                     });
319            
320  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", b =>
321  ✔  11                     {
322  ✔  11                         b.Property<Guid>("Id")
323  ✔  11                             .ValueGeneratedOnAdd()
324  ✔  11                             .HasColumnType("uuid");
325  ✔  11     
326  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
327  ✔  11                             .HasColumnType("timestamp with time zone");
328  ✔  11     
329  ✔  11                         b.Property<string>("Name")
330  ✔  11                             .IsRequired()
331  ✔  11                             .HasMaxLength(200)
332  ✔  11                             .HasColumnType("character varying(200)");
333  ✔  11     
334  ✔  11                         b.Property<string>("Status")
335  ✔  11                             .IsRequired()
336  ✔  11                             .HasColumnType("text");
337  ✔  11     
338  ✔  11                         b.Property<Guid>("TenantId")
339  ✔  11                             .HasColumnType("uuid");
340  ✔  11     
341  ✔  11                         b.HasKey("Id");
342  ✔  11     
343  ✔  11                         b.HasIndex("TenantId");
344  ✔  11     
345  ✔  11                         b.ToTable("Projects");
346  ✔  22                     });
347            
348  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderAccount", b =>
349  ✔  11                     {
350  ✔  11                         b.Property<Guid>("Id")
351  ✔  11                             .ValueGeneratedOnAdd()
352  ✔  11                             .HasColumnType("uuid");
353  ✔  11     
354  ✔  11                         b.Property<string>("AccountId")
355  ✔  11                             .IsRequired()
356  ✔  11                             .HasMaxLength(200)
357  ✔  11                             .HasColumnType("character varying(200)");
358  ✔  11     
359  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
360  ✔  11                             .HasColumnType("timestamp with time zone");
361  ✔  11     
362  ✔  11                         b.Property<string>("Provider")
363  ✔  11                             .IsRequired()
364  ✔  11                             .HasMaxLength(100)
365  ✔  11                             .HasColumnType("character varying(100)");
366  ✔  11     
367  ✔  11                         b.Property<string>("Status")
368  ✔  11                             .IsRequired()
369  ✔  11                             .HasColumnType("text");
370  ✔  11     
371  ✔  11                         b.Property<Guid>("TenantId")
372  ✔  11                             .HasColumnType("uuid");
373  ✔  11     
374  ✔  11                         b.HasKey("Id");
375  ✔  11     
376  ✔  11                         b.HasIndex("TenantId");
377  ✔  11     
378  ✔  11                         b.ToTable("ProviderAccounts");
379  ✔  22                     });
380            
381  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderModel", b =>
382  ✔  11                     {
383  ✔  11                         b.Property<int>("Id")
384  ✔  11                             .ValueGeneratedOnAdd()
385  ✔  11                             .HasColumnType("integer");
386  ✔  11     
387  ✔  11                         NpgsqlPropertyBuilderExtensions.UseIdentityByDefaultColumn(b.Property<int>("Id"));
388  ✔  11     
389  ✔  11                         b.Property<string>("GlobalModelId")
390  ✔  11                             .IsRequired()
391  ✔  11                             .HasColumnType("text");
392  ✔  11     
393  ✔  11                         b.Property<bool>("IsAvailable")
394  ✔  11                             .HasColumnType("boolean");
395  ✔  11     
396  ✔  11                         b.Property<decimal?>("OverrideInputPrice")
397  ✔  11                             .HasPrecision(18, 9)
398  ✔  11                             .HasColumnType("numeric(18,9)");
399  ✔  11     
400  ✔  11                         b.Property<decimal?>("OverrideOutputPrice")
401  ✔  11                             .HasPrecision(18, 9)
402  ✔  11                             .HasColumnType("numeric(18,9)");
403  ✔  11     
404  ✔  11                         b.Property<string>("ProviderId")
405  ✔  11                             .IsRequired()
406  ✔  11                             .HasMaxLength(100)
407  ✔  11                             .HasColumnType("character varying(100)");
408  ✔  11     
409  ✔  11                         b.Property<string>("ProviderSpecificId")
410  ✔  11                             .IsRequired()
411  ✔  11                             .HasMaxLength(200)
412  ✔  11                             .HasColumnType("character varying(200)");
413  ✔  11     
414  ✔  11                         b.Property<int?>("RateLimitRPM")
415  ✔  11                             .HasColumnType("integer");
416  ✔  11     
417  ✔  11                         b.Property<int?>("RateLimitTPM")
418  ✔  11                             .HasColumnType("integer");
419  ✔  11     
420  ✔  11                         b.HasKey("Id");
421  ✔  11     
422  ✔  11                         b.HasIndex("GlobalModelId");
423  ✔  11     
424  ✔  11                         b.ToTable("ProviderModels");
425  ✔  22                     });
426            
427  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.QuotaSnapshot", b =>
428  ✔  11                     {
429  ✔  11                         b.Property<Guid>("Id")
430  ✔  11                             .ValueGeneratedOnAdd()
431  ✔  11                             .HasColumnType("uuid");
432  ✔  11     
433  ✔  11                         b.Property<string>("AccountId")
434  ✔  11                             .IsRequired()
435  ✔  11                             .HasMaxLength(200)
436  ✔  11                             .HasColumnType("character varying(200)");
437  ✔  11     
438  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
439  ✔  11                             .HasColumnType("timestamp with time zone");
440  ✔  11     
441  ✔  11                         b.Property<string>("Provider")
442  ✔  11                             .IsRequired()
443  ✔  11                             .HasMaxLength(100)
444  ✔  11                             .HasColumnType("character varying(100)");
445  ✔  11     
446  ✔  11                         b.Property<string>("QuotaJson")
447  ✔  11                             .IsRequired()
448  ✔  11                             .HasColumnType("jsonb");
449  ✔  11     
450  ✔  11                         b.HasKey("Id");
451  ✔  11     
452  ✔  11                         b.ToTable("QuotaSnapshots");
453  ✔  22                     });
454            
455  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RequestLog", b =>
456  ✔  11                     {
457  ✔  11                         b.Property<Guid>("Id")
458  ✔  11                             .ValueGeneratedOnAdd()
459  ✔  11                             .HasColumnType("uuid");
460  ✔  11     
461  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
462  ✔  11                             .HasColumnType("timestamp with time zone");
463  ✔  11     
464  ✔  11                         b.Property<string>("Endpoint")
465  ✔  11                             .IsRequired()
466  ✔  11                             .HasMaxLength(200)
467  ✔  11                             .HasColumnType("character varying(200)");
468  ✔  11     
469  ✔  11                         b.Property<int?>("LatencyMs")
470  ✔  11                             .HasColumnType("integer");
471  ✔  11     
472  ✔  11                         b.Property<string>("Model")
473  ✔  11                             .HasMaxLength(200)
474  ✔  11                             .HasColumnType("character varying(200)");
475  ✔  11     
476  ✔  11                         b.Property<Guid>("ProjectId")
477  ✔  11                             .HasColumnType("uuid");
478  ✔  11     
479  ✔  11                         b.Property<string>("Provider")
480  ✔  11                             .HasMaxLength(200)
481  ✔  11                             .HasColumnType("character varying(200)");
482  ✔  11     
483  ✔  11                         b.Property<string>("RequestId")
484  ✔  11                             .IsRequired()
485  ✔  11                             .HasMaxLength(200)
486  ✔  11                             .HasColumnType("character varying(200)");
487  ✔  11     
488  ✔  11                         b.Property<int?>("StatusCode")
489  ✔  11                             .HasColumnType("integer");
490  ✔  11     
491  ✔  11                         b.Property<Guid>("TenantId")
492  ✔  11                             .HasColumnType("uuid");
493  ✔  11     
494  ✔  11                         b.Property<Guid?>("UserId")
495  ✔  11                             .HasColumnType("uuid");
496  ✔  11     
497  ✔  11                         b.HasKey("Id");
498  ✔  11     
499  ✔  11                         b.HasIndex("ProjectId");
500  ✔  11     
501  ✔  11                         b.HasIndex("TenantId");
502  ✔  11     
503  ✔  11                         b.HasIndex("UserId");
504  ✔  11     
505  ✔  11                         b.ToTable("RequestLogs");
506  ✔  22                     });
507            
508  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RoutingPolicy", b =>
509  ✔  11                     {
510  ✔  11                         b.Property<Guid>("Id")
511  ✔  11                             .ValueGeneratedOnAdd()
512  ✔  11                             .HasColumnType("uuid");
513  ✔  11     
514  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
515  ✔  11                             .HasColumnType("timestamp with time zone");
516  ✔  11     
517  ✔  11                         b.Property<string>("PolicyJson")
518  ✔  11                             .IsRequired()
519  ✔  11                             .HasColumnType("jsonb");
520  ✔  11     
521  ✔  11                         b.Property<Guid>("TenantId")
522  ✔  11                             .HasColumnType("uuid");
523  ✔  11     
524  ✔  11                         b.Property<int>("Version")
525  ✔  11                             .HasColumnType("integer");
526  ✔  11     
527  ✔  11                         b.HasKey("Id");
528  ✔  11     
529  ✔  11                         b.HasIndex("TenantId");
530  ✔  11     
531  ✔  11                         b.ToTable("RoutingPolicies");
532  ✔  22                     });
533            
534  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", b =>
535  ✔  11                     {
536  ✔  11                         b.Property<Guid>("Id")
537  ✔  11                             .ValueGeneratedOnAdd()
538  ✔  11                             .HasColumnType("uuid");
539  ✔  11     
540  ✔  11                         b.Property<Guid?>("ByokKeyId")
541  ✔  11                             .HasColumnType("uuid");
542  ✔  11     
543  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
544  ✔  11                             .HasColumnType("timestamp with time zone");
545  ✔  11     
546  ✔  11                         b.Property<byte[]>("EncryptedByokKey")
547  ✔  11                             .IsRequired()
548  ✔  11                             .HasColumnType("bytea");
549  ✔  11     
550  ✔  11                         b.Property<string>("Name")
551  ✔  11                             .IsRequired()
552  ✔  11                             .HasMaxLength(200)
553  ✔  11                             .HasColumnType("character varying(200)");
554  ✔  11     
555  ✔  11                         b.Property<string>("Region")
556  ✔  11                             .IsRequired()
557  ✔  11                             .HasColumnType("text");
558  ✔  11     
559  ✔  11                         b.Property<string>("Status")
560  ✔  11                             .IsRequired()
561  ✔  11                             .HasColumnType("text");
562  ✔  11     
563  ✔  11                         b.HasKey("Id");
564  ✔  11     
565  ✔  11                         b.ToTable("Tenants");
566  ✔  22                     });
567            
568  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TenantModelLimit", b =>
569  ✔  11                     {
570  ✔  11                         b.Property<int>("Id")
571  ✔  11                             .ValueGeneratedOnAdd()
572  ✔  11                             .HasColumnType("integer");
573  ✔  11     
574  ✔  11                         NpgsqlPropertyBuilderExtensions.UseIdentityByDefaultColumn(b.Property<int>("Id"));
575  ✔  11     
576  ✔  11                         b.Property<int?>("AllowedRPM")
577  ✔  11                             .HasColumnType("integer");
578  ✔  11     
579  ✔  11                         b.Property<string>("GlobalModelId")
580  ✔  11                             .IsRequired()
581  ✔  11                             .HasColumnType("text");
582  ✔  11     
583  ✔  11                         b.Property<decimal?>("MonthlyBudget")
584  ✔  11                             .HasPrecision(18, 9)
585  ✔  11                             .HasColumnType("numeric(18,9)");
586  ✔  11     
587  ✔  11                         b.Property<string>("TenantId")
588  ✔  11                             .IsRequired()
589  ✔  11                             .HasMaxLength(200)
590  ✔  11                             .HasColumnType("character varying(200)");
591  ✔  11     
592  ✔  11                         b.HasKey("Id");
593  ✔  11     
594  ✔  11                         b.HasIndex("GlobalModelId");
595  ✔  11     
596  ✔  11                         b.ToTable("TenantModelLimits");
597  ✔  22                     });
598            
599  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TokenUsage", b =>
600  ✔  11                     {
601  ✔  11                         b.Property<Guid>("Id")
602  ✔  11                             .ValueGeneratedOnAdd()
603  ✔  11                             .HasColumnType("uuid");
604  ✔  11     
605  ✔  11                         b.Property<decimal>("CostEstimate")
606  ✔  11                             .HasColumnType("numeric");
607  ✔  11     
608  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
609  ✔  11                             .HasColumnType("timestamp with time zone");
610  ✔  11     
611  ✔  11                         b.Property<int>("InputTokens")
612  ✔  11                             .HasColumnType("integer");
613  ✔  11     
614  ✔  11                         b.Property<int>("OutputTokens")
615  ✔  11                             .HasColumnType("integer");
616  ✔  11     
617  ✔  11                         b.Property<Guid>("ProjectId")
618  ✔  11                             .HasColumnType("uuid");
619  ✔  11     
620  ✔  11                         b.Property<string>("RequestId")
621  ✔  11                             .IsRequired()
622  ✔  11                             .HasMaxLength(200)
623  ✔  11                             .HasColumnType("character varying(200)");
624  ✔  11     
625  ✔  11                         b.Property<Guid>("TenantId")
626  ✔  11                             .HasColumnType("uuid");
627  ✔  11     
628  ✔  11                         b.Property<Guid?>("UserId")
629  ✔  11                             .HasColumnType("uuid");
630  ✔  11     
631  ✔  11                         b.HasKey("Id");
632  ✔  11     
633  ✔  11                         b.HasIndex("ProjectId");
634  ✔  11     
635  ✔  11                         b.HasIndex("TenantId");
636  ✔  11     
637  ✔  11                         b.HasIndex("UserId");
638  ✔  11     
639  ✔  11                         b.ToTable("TokenUsages");
640  ✔  22                     });
641            
642  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", b =>
643  ✔  11                     {
644  ✔  11                         b.Property<Guid>("Id")
645  ✔  11                             .ValueGeneratedOnAdd()
646  ✔  11                             .HasColumnType("uuid");
647  ✔  11     
648  ✔  11                         b.Property<string>("AuthProvider")
649  ✔  11                             .IsRequired()
650  ✔  11                             .HasMaxLength(50)
651  ✔  11                             .HasColumnType("character varying(50)");
652  ✔  11     
653  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
654  ✔  11                             .HasColumnType("timestamp with time zone");
655  ✔  11     
656  ✔  11                         b.Property<string>("Email")
657  ✔  11                             .IsRequired()
658  ✔  11                             .HasMaxLength(320)
659  ✔  11                             .HasColumnType("character varying(320)");
660  ✔  11     
661  ✔  11                         b.Property<string>("ProviderUserId")
662  ✔  11                             .IsRequired()
663  ✔  11                             .HasMaxLength(200)
664  ✔  11                             .HasColumnType("character varying(200)");
665  ✔  11     
666  ✔  11                         b.Property<string>("Role")
667  ✔  11                             .IsRequired()
668  ✔  11                             .HasColumnType("text");
669  ✔  11     
670  ✔  11                         b.Property<Guid>("TenantId")
671  ✔  11                             .HasColumnType("uuid");
672  ✔  11     
673  ✔  11                         b.HasKey("Id");
674  ✔  11     
675  ✔  11                         b.HasIndex("TenantId");
676  ✔  11     
677  ✔  11                         b.ToTable("Users");
678  ✔  22                     });
679            
680  ✔  11                 modelBuilder.Entity("ProjectUsers", b =>
681  ✔  11                     {
682  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", null)
683  ✔  11                             .WithMany()
684  ✔  11                             .HasForeignKey("ProjectId")
685  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
686  ✔  11                             .IsRequired();
687  ✔  11     
688  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", null)
689  ✔  11                             .WithMany()
690  ✔  11                             .HasForeignKey("UserId")
691  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
692  ✔  11                             .IsRequired();
693  ✔  22                     });
694            
695  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ApiKey", b =>
696  ✔  11                     {
697  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", "Project")
698  ✔  11                             .WithMany("ApiKeys")
699  ✔  11                             .HasForeignKey("ProjectId")
700  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
701  ✔  11                             .IsRequired();
702  ✔  11     
703  ✔  11                         b.Navigation("Project");
704  ✔  22                     });
705            
706  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.AuditLog", b =>
707  ✔  11                     {
708  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
709  ✔  11                             .WithMany()
710  ✔  11                             .HasForeignKey("TenantId")
711  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
712  ✔  11                             .IsRequired();
713  ✔  11     
714  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", "User")
715  ✔  11                             .WithMany()
716  ✔  11                             .HasForeignKey("UserId");
717  ✔  11     
718  ✔  11                         b.Navigation("Tenant");
719  ✔  11     
720  ✔  11                         b.Navigation("User");
721  ✔  22                     });
722            
723  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.DeviationEntry", b =>
724  ✔  11                     {
725  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
726  ✔  11                             .WithMany()
727  ✔  11                             .HasForeignKey("TenantId")
728  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
729  ✔  11                             .IsRequired();
730  ✔  11     
731  ✔  11                         b.Navigation("Tenant");
732  ✔  22                     });
733            
734  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelAlias", b =>
735  ✔  11                     {
736  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
737  ✔  11                             .WithMany()
738  ✔  11                             .HasForeignKey("TenantId")
739  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
740  ✔  11                             .IsRequired();
741  ✔  11     
742  ✔  11                         b.Navigation("Tenant");
743  ✔  22                     });
744            
745  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCombo", b =>
746  ✔  11                     {
747  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
748  ✔  11                             .WithMany()
749  ✔  11                             .HasForeignKey("TenantId")
750  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
751  ✔  11                             .IsRequired();
752  ✔  11     
753  ✔  11                         b.Navigation("Tenant");
754  ✔  22                     });
755            
756  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.OAuthAccount", b =>
757  ✔  11                     {
758  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
759  ✔  11                             .WithMany("OAuthAccounts")
760  ✔  11                             .HasForeignKey("TenantId")
761  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
762  ✔  11                             .IsRequired();
763  ✔  11     
764  ✔  11                         b.Navigation("Tenant");
765  ✔  22                     });
766            
767  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", b =>
768  ✔  11                     {
769  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
770  ✔  11                             .WithMany("Projects")
771  ✔  11                             .HasForeignKey("TenantId")
772  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
773  ✔  11                             .IsRequired();
774  ✔  11     
775  ✔  11                         b.Navigation("Tenant");
776  ✔  22                     });
777            
778  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderAccount", b =>
779  ✔  11                     {
780  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
781  ✔  11                             .WithMany()
782  ✔  11                             .HasForeignKey("TenantId")
783  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
784  ✔  11                             .IsRequired();
785  ✔  11     
786  ✔  11                         b.Navigation("Tenant");
787  ✔  22                     });
788            
789  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderModel", b =>
790  ✔  11                     {
791  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel", "GlobalModel")
792  ✔  11                             .WithMany("ProviderModels")
793  ✔  11                             .HasForeignKey("GlobalModelId")
794  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
795  ✔  11                             .IsRequired();
796  ✔  11     
797  ✔  11                         b.Navigation("GlobalModel");
798  ✔  22                     });
799            
800  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RequestLog", b =>
801  ✔  11                     {
802  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", "Project")
803  ✔  11                             .WithMany()
804  ✔  11                             .HasForeignKey("ProjectId")
805  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
806  ✔  11                             .IsRequired();
807  ✔  11     
808  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
809  ✔  11                             .WithMany()
810  ✔  11                             .HasForeignKey("TenantId")
811  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
812  ✔  11                             .IsRequired();
813  ✔  11     
814  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", "User")
815  ✔  11                             .WithMany()
816  ✔  11                             .HasForeignKey("UserId");
817  ✔  11     
818  ✔  11                         b.Navigation("Project");
819  ✔  11     
820  ✔  11                         b.Navigation("Tenant");
821  ✔  11     
822  ✔  11                         b.Navigation("User");
823  ✔  22                     });
824            
825  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RoutingPolicy", b =>
826  ✔  11                     {
827  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
828  ✔  11                             .WithMany()
829  ✔  11                             .HasForeignKey("TenantId")
830  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
831  ✔  11                             .IsRequired();
832  ✔  11     
833  ✔  11                         b.Navigation("Tenant");
834  ✔  22                     });
835            
836  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TenantModelLimit", b =>
837  ✔  11                     {
838  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel", "GlobalModel")
839  ✔  11                             .WithMany()
840  ✔  11                             .HasForeignKey("GlobalModelId")
841  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
842  ✔  11                             .IsRequired();
843  ✔  11     
844  ✔  11                         b.Navigation("GlobalModel");
845  ✔  22                     });
846            
847  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TokenUsage", b =>
848  ✔  11                     {
849  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", "Project")
850  ✔  11                             .WithMany()
851  ✔  11                             .HasForeignKey("ProjectId")
852  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
853  ✔  11                             .IsRequired();
854  ✔  11     
855  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
856  ✔  11                             .WithMany()
857  ✔  11                             .HasForeignKey("TenantId")
858  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
859  ✔  11                             .IsRequired();
860  ✔  11     
861  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", "User")
862  ✔  11                             .WithMany()
863  ✔  11                             .HasForeignKey("UserId");
864  ✔  11     
865  ✔  11                         b.Navigation("Project");
866  ✔  11     
867  ✔  11                         b.Navigation("Tenant");
868  ✔  11     
869  ✔  11                         b.Navigation("User");
870  ✔  22                     });
871            
872  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", b =>
873  ✔  11                     {
874  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
875  ✔  11                             .WithMany("Users")
876  ✔  11                             .HasForeignKey("TenantId")
877  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
878  ✔  11                             .IsRequired();
879  ✔  11     
880  ✔  11                         b.Navigation("Tenant");
881  ✔  22                     });
882            
883  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel", b =>
884  ✔  11                     {
885  ✔  11                         b.Navigation("ProviderModels");
886  ✔  22                     });
887            
888  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", b =>
889  ✔  11                     {
890  ✔  11                         b.Navigation("ApiKeys");
891  ✔  22                     });
892            
893  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", b =>
894  ✔  11                     {
895  ✔  11                         b.Navigation("OAuthAccounts");
896  ✔  11     
897  ✔  11                         b.Navigation("Projects");
898  ✔  11     
899  ✔  11                         b.Navigation("Users");
900  ✔  22                     });
901            #pragma warning restore 612, 618
902  ✔  11             }
903                }
904            }
```
# Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations.AddModelCosts

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations.AddModelCosts |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/20260126165801_AddModelCosts.cs<br />/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/20260126165801_AddModelCosts.Designer.cs |
| **Line coverage:** | 97% (1112 of 1146) |
| Covered lines: | 1112 |
| Uncovered lines: | 34 |
| Coverable lines: | 1146 |
| Total lines: | 1266 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Up(...)** | 100% | 1 | 1 | 100% |
| **BuildTargetModel(...)** | 100% | 1 | 1 | 100% |
| **Down(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/20260126165801_AddModelCosts.cs
```
  1            using System;
  2            using Microsoft.EntityFrameworkCore.Migrations;
  3            
  4            #nullable disable
  5            
  6            namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations
  7            {
  8                /// <inheritdoc />
  9                public partial class AddModelCosts : Migration
 10                {
 11                    /// <inheritdoc />
 12                    protected override void Up(MigrationBuilder migrationBuilder)
 13  ✔  22             {
 14  ✔  22                 migrationBuilder.CreateTable(
 15  ✔  22                     name: "ModelCosts",
 16  ✔  22                     columns: table => new
 17  ✔  22                     {
 18  ✔  22                         Provider = table.Column<string>(type: "character varying(100)", maxLength: 100, nullable: false),
 19  ✔  22                         Model = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
 20  ✔  22                         CostPerToken = table.Column<decimal>(type: "numeric", nullable: false),
 21  ✔  22                         FreeTier = table.Column<bool>(type: "boolean", nullable: false)
 22  ✔  22                     },
 23  ✔  22                     constraints: table =>
 24  ✔  22                     {
 25  ✔  22                         table.PrimaryKey("PK_ModelCosts", x => new { x.Provider, x.Model });
 26  ✔  44                     });
 27            
 28  ✔  22                 migrationBuilder.CreateTable(
 29  ✔  22                     name: "QuotaSnapshots",
 30  ✔  22                     columns: table => new
 31  ✔  22                     {
 32  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
 33  ✔  22                         Provider = table.Column<string>(type: "character varying(100)", maxLength: 100, nullable: false),
 34  ✔  22                         AccountId = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
 35  ✔  22                         QuotaJson = table.Column<string>(type: "jsonb", nullable: false),
 36  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
 37  ✔  22                     },
 38  ✔  22                     constraints: table =>
 39  ✔  22                     {
 40  ✔  22                         table.PrimaryKey("PK_QuotaSnapshots", x => x.Id);
 41  ✔  44                     });
 42            
 43  ✔  22                 migrationBuilder.CreateTable(
 44  ✔  22                     name: "Tenants",
 45  ✔  22                     columns: table => new
 46  ✔  22                     {
 47  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
 48  ✔  22                         Name = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
 49  ✔  22                         Region = table.Column<string>(type: "text", nullable: false),
 50  ✔  22                         Status = table.Column<string>(type: "text", nullable: false),
 51  ✔  22                         ByokKeyId = table.Column<Guid>(type: "uuid", nullable: true),
 52  ✔  22                         EncryptedByokKey = table.Column<byte[]>(type: "bytea", nullable: false),
 53  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
 54  ✔  22                     },
 55  ✔  22                     constraints: table =>
 56  ✔  22                     {
 57  ✔  22                         table.PrimaryKey("PK_Tenants", x => x.Id);
 58  ✔  44                     });
 59            
 60  ✔  22                 migrationBuilder.CreateTable(
 61  ✔  22                     name: "Deviations",
 62  ✔  22                     columns: table => new
 63  ✔  22                     {
 64  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
 65  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
 66  ✔  22                         Endpoint = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
 67  ✔  22                         Field = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
 68  ✔  22                         Reason = table.Column<string>(type: "character varying(500)", maxLength: 500, nullable: false),
 69  ✔  22                         Mitigation = table.Column<string>(type: "character varying(500)", maxLength: 500, nullable: false),
 70  ✔  22                         Status = table.Column<string>(type: "text", nullable: false),
 71  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
 72  ✔  22                     },
 73  ✔  22                     constraints: table =>
 74  ✔  22                     {
 75  ✔  22                         table.PrimaryKey("PK_Deviations", x => x.Id);
 76  ✔  22                         table.ForeignKey(
 77  ✔  22                             name: "FK_Deviations_Tenants_TenantId",
 78  ✔  22                             column: x => x.TenantId,
 79  ✔  22                             principalTable: "Tenants",
 80  ✔  22                             principalColumn: "Id",
 81  ✔  22                             onDelete: ReferentialAction.Cascade);
 82  ✔  44                     });
 83            
 84  ✔  22                 migrationBuilder.CreateTable(
 85  ✔  22                     name: "ModelAliases",
 86  ✔  22                     columns: table => new
 87  ✔  22                     {
 88  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
 89  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
 90  ✔  22                         Alias = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
 91  ✔  22                         TargetModel = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false)
 92  ✔  22                     },
 93  ✔  22                     constraints: table =>
 94  ✔  22                     {
 95  ✔  22                         table.PrimaryKey("PK_ModelAliases", x => x.Id);
 96  ✔  22                         table.ForeignKey(
 97  ✔  22                             name: "FK_ModelAliases_Tenants_TenantId",
 98  ✔  22                             column: x => x.TenantId,
 99  ✔  22                             principalTable: "Tenants",
100  ✔  22                             principalColumn: "Id",
101  ✔  22                             onDelete: ReferentialAction.Cascade);
102  ✔  44                     });
103            
104  ✔  22                 migrationBuilder.CreateTable(
105  ✔  22                     name: "ModelCombos",
106  ✔  22                     columns: table => new
107  ✔  22                     {
108  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
109  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
110  ✔  22                         Name = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
111  ✔  22                         OrderedModelsJson = table.Column<string>(type: "jsonb", nullable: false)
112  ✔  22                     },
113  ✔  22                     constraints: table =>
114  ✔  22                     {
115  ✔  22                         table.PrimaryKey("PK_ModelCombos", x => x.Id);
116  ✔  22                         table.ForeignKey(
117  ✔  22                             name: "FK_ModelCombos_Tenants_TenantId",
118  ✔  22                             column: x => x.TenantId,
119  ✔  22                             principalTable: "Tenants",
120  ✔  22                             principalColumn: "Id",
121  ✔  22                             onDelete: ReferentialAction.Cascade);
122  ✔  44                     });
123            
124  ✔  22                 migrationBuilder.CreateTable(
125  ✔  22                     name: "OAuthAccounts",
126  ✔  22                     columns: table => new
127  ✔  22                     {
128  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
129  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
130  ✔  22                         Provider = table.Column<string>(type: "character varying(50)", maxLength: 50, nullable: false),
131  ✔  22                         AccessTokenEncrypted = table.Column<byte[]>(type: "bytea", nullable: false),
132  ✔  22                         RefreshTokenEncrypted = table.Column<byte[]>(type: "bytea", nullable: true),
133  ✔  22                         ExpiresAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: true),
134  ✔  22                         Status = table.Column<string>(type: "text", nullable: false),
135  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
136  ✔  22                     },
137  ✔  22                     constraints: table =>
138  ✔  22                     {
139  ✔  22                         table.PrimaryKey("PK_OAuthAccounts", x => x.Id);
140  ✔  22                         table.ForeignKey(
141  ✔  22                             name: "FK_OAuthAccounts_Tenants_TenantId",
142  ✔  22                             column: x => x.TenantId,
143  ✔  22                             principalTable: "Tenants",
144  ✔  22                             principalColumn: "Id",
145  ✔  22                             onDelete: ReferentialAction.Cascade);
146  ✔  44                     });
147            
148  ✔  22                 migrationBuilder.CreateTable(
149  ✔  22                     name: "Projects",
150  ✔  22                     columns: table => new
151  ✔  22                     {
152  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
153  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
154  ✔  22                         Name = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
155  ✔  22                         Status = table.Column<string>(type: "text", nullable: false),
156  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
157  ✔  22                     },
158  ✔  22                     constraints: table =>
159  ✔  22                     {
160  ✔  22                         table.PrimaryKey("PK_Projects", x => x.Id);
161  ✔  22                         table.ForeignKey(
162  ✔  22                             name: "FK_Projects_Tenants_TenantId",
163  ✔  22                             column: x => x.TenantId,
164  ✔  22                             principalTable: "Tenants",
165  ✔  22                             principalColumn: "Id",
166  ✔  22                             onDelete: ReferentialAction.Cascade);
167  ✔  44                     });
168            
169  ✔  22                 migrationBuilder.CreateTable(
170  ✔  22                     name: "ProviderAccounts",
171  ✔  22                     columns: table => new
172  ✔  22                     {
173  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
174  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
175  ✔  22                         Provider = table.Column<string>(type: "character varying(100)", maxLength: 100, nullable: false),
176  ✔  22                         AccountId = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
177  ✔  22                         Status = table.Column<string>(type: "text", nullable: false),
178  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
179  ✔  22                     },
180  ✔  22                     constraints: table =>
181  ✔  22                     {
182  ✔  22                         table.PrimaryKey("PK_ProviderAccounts", x => x.Id);
183  ✔  22                         table.ForeignKey(
184  ✔  22                             name: "FK_ProviderAccounts_Tenants_TenantId",
185  ✔  22                             column: x => x.TenantId,
186  ✔  22                             principalTable: "Tenants",
187  ✔  22                             principalColumn: "Id",
188  ✔  22                             onDelete: ReferentialAction.Cascade);
189  ✔  44                     });
190            
191  ✔  22                 migrationBuilder.CreateTable(
192  ✔  22                     name: "RoutingPolicies",
193  ✔  22                     columns: table => new
194  ✔  22                     {
195  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
196  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
197  ✔  22                         PolicyJson = table.Column<string>(type: "jsonb", nullable: false),
198  ✔  22                         Version = table.Column<int>(type: "integer", nullable: false),
199  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
200  ✔  22                     },
201  ✔  22                     constraints: table =>
202  ✔  22                     {
203  ✔  22                         table.PrimaryKey("PK_RoutingPolicies", x => x.Id);
204  ✔  22                         table.ForeignKey(
205  ✔  22                             name: "FK_RoutingPolicies_Tenants_TenantId",
206  ✔  22                             column: x => x.TenantId,
207  ✔  22                             principalTable: "Tenants",
208  ✔  22                             principalColumn: "Id",
209  ✔  22                             onDelete: ReferentialAction.Cascade);
210  ✔  44                     });
211            
212  ✔  22                 migrationBuilder.CreateTable(
213  ✔  22                     name: "Users",
214  ✔  22                     columns: table => new
215  ✔  22                     {
216  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
217  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
218  ✔  22                         Email = table.Column<string>(type: "character varying(320)", maxLength: 320, nullable: false),
219  ✔  22                         Role = table.Column<string>(type: "text", nullable: false),
220  ✔  22                         AuthProvider = table.Column<string>(type: "character varying(50)", maxLength: 50, nullable: false),
221  ✔  22                         ProviderUserId = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: fals
222  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
223  ✔  22                     },
224  ✔  22                     constraints: table =>
225  ✔  22                     {
226  ✔  22                         table.PrimaryKey("PK_Users", x => x.Id);
227  ✔  22                         table.ForeignKey(
228  ✔  22                             name: "FK_Users_Tenants_TenantId",
229  ✔  22                             column: x => x.TenantId,
230  ✔  22                             principalTable: "Tenants",
231  ✔  22                             principalColumn: "Id",
232  ✔  22                             onDelete: ReferentialAction.Cascade);
233  ✔  44                     });
234            
235  ✔  22                 migrationBuilder.CreateTable(
236  ✔  22                     name: "ApiKeys",
237  ✔  22                     columns: table => new
238  ✔  22                     {
239  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
240  ✔  22                         ProjectId = table.Column<Guid>(type: "uuid", nullable: false),
241  ✔  22                         KeyHash = table.Column<string>(type: "character varying(512)", maxLength: 512, nullable: false),
242  ✔  22                         Name = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
243  ✔  22                         Status = table.Column<string>(type: "text", nullable: false),
244  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
245  ✔  22                     },
246  ✔  22                     constraints: table =>
247  ✔  22                     {
248  ✔  22                         table.PrimaryKey("PK_ApiKeys", x => x.Id);
249  ✔  22                         table.ForeignKey(
250  ✔  22                             name: "FK_ApiKeys_Projects_ProjectId",
251  ✔  22                             column: x => x.ProjectId,
252  ✔  22                             principalTable: "Projects",
253  ✔  22                             principalColumn: "Id",
254  ✔  22                             onDelete: ReferentialAction.Cascade);
255  ✔  44                     });
256            
257  ✔  22                 migrationBuilder.CreateTable(
258  ✔  22                     name: "AuditLogs",
259  ✔  22                     columns: table => new
260  ✔  22                     {
261  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
262  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
263  ✔  22                         UserId = table.Column<Guid>(type: "uuid", nullable: true),
264  ✔  22                         Action = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
265  ✔  22                         PayloadJson = table.Column<string>(type: "jsonb", nullable: true),
266  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
267  ✔  22                     },
268  ✔  22                     constraints: table =>
269  ✔  22                     {
270  ✔  22                         table.PrimaryKey("PK_AuditLogs", x => x.Id);
271  ✔  22                         table.ForeignKey(
272  ✔  22                             name: "FK_AuditLogs_Tenants_TenantId",
273  ✔  22                             column: x => x.TenantId,
274  ✔  22                             principalTable: "Tenants",
275  ✔  22                             principalColumn: "Id",
276  ✔  22                             onDelete: ReferentialAction.Cascade);
277  ✔  22                         table.ForeignKey(
278  ✔  22                             name: "FK_AuditLogs_Users_UserId",
279  ✔  22                             column: x => x.UserId,
280  ✔  22                             principalTable: "Users",
281  ✔  22                             principalColumn: "Id");
282  ✔  44                     });
283            
284  ✔  22                 migrationBuilder.CreateTable(
285  ✔  22                     name: "ProjectUsers",
286  ✔  22                     columns: table => new
287  ✔  22                     {
288  ✔  22                         ProjectId = table.Column<Guid>(type: "uuid", nullable: false),
289  ✔  22                         UserId = table.Column<Guid>(type: "uuid", nullable: false)
290  ✔  22                     },
291  ✔  22                     constraints: table =>
292  ✔  22                     {
293  ✔  22                         table.PrimaryKey("PK_ProjectUsers", x => new { x.ProjectId, x.UserId });
294  ✔  22                         table.ForeignKey(
295  ✔  22                             name: "FK_ProjectUsers_Projects_ProjectId",
296  ✔  22                             column: x => x.ProjectId,
297  ✔  22                             principalTable: "Projects",
298  ✔  22                             principalColumn: "Id",
299  ✔  22                             onDelete: ReferentialAction.Cascade);
300  ✔  22                         table.ForeignKey(
301  ✔  22                             name: "FK_ProjectUsers_Users_UserId",
302  ✔  22                             column: x => x.UserId,
303  ✔  22                             principalTable: "Users",
304  ✔  22                             principalColumn: "Id",
305  ✔  22                             onDelete: ReferentialAction.Cascade);
306  ✔  44                     });
307            
308  ✔  22                 migrationBuilder.CreateTable(
309  ✔  22                     name: "RequestLogs",
310  ✔  22                     columns: table => new
311  ✔  22                     {
312  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
313  ✔  22                         RequestId = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
314  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
315  ✔  22                         ProjectId = table.Column<Guid>(type: "uuid", nullable: false),
316  ✔  22                         UserId = table.Column<Guid>(type: "uuid", nullable: true),
317  ✔  22                         Endpoint = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
318  ✔  22                         Model = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: true),
319  ✔  22                         Provider = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: true),
320  ✔  22                         LatencyMs = table.Column<int>(type: "integer", nullable: true),
321  ✔  22                         StatusCode = table.Column<int>(type: "integer", nullable: true),
322  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
323  ✔  22                     },
324  ✔  22                     constraints: table =>
325  ✔  22                     {
326  ✔  22                         table.PrimaryKey("PK_RequestLogs", x => x.Id);
327  ✔  22                         table.ForeignKey(
328  ✔  22                             name: "FK_RequestLogs_Projects_ProjectId",
329  ✔  22                             column: x => x.ProjectId,
330  ✔  22                             principalTable: "Projects",
331  ✔  22                             principalColumn: "Id",
332  ✔  22                             onDelete: ReferentialAction.Cascade);
333  ✔  22                         table.ForeignKey(
334  ✔  22                             name: "FK_RequestLogs_Tenants_TenantId",
335  ✔  22                             column: x => x.TenantId,
336  ✔  22                             principalTable: "Tenants",
337  ✔  22                             principalColumn: "Id",
338  ✔  22                             onDelete: ReferentialAction.Cascade);
339  ✔  22                         table.ForeignKey(
340  ✔  22                             name: "FK_RequestLogs_Users_UserId",
341  ✔  22                             column: x => x.UserId,
342  ✔  22                             principalTable: "Users",
343  ✔  22                             principalColumn: "Id");
344  ✔  44                     });
345            
346  ✔  22                 migrationBuilder.CreateTable(
347  ✔  22                     name: "TokenUsages",
348  ✔  22                     columns: table => new
349  ✔  22                     {
350  ✔  22                         Id = table.Column<Guid>(type: "uuid", nullable: false),
351  ✔  22                         RequestId = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
352  ✔  22                         TenantId = table.Column<Guid>(type: "uuid", nullable: false),
353  ✔  22                         ProjectId = table.Column<Guid>(type: "uuid", nullable: false),
354  ✔  22                         UserId = table.Column<Guid>(type: "uuid", nullable: true),
355  ✔  22                         InputTokens = table.Column<int>(type: "integer", nullable: false),
356  ✔  22                         OutputTokens = table.Column<int>(type: "integer", nullable: false),
357  ✔  22                         CostEstimate = table.Column<decimal>(type: "numeric", nullable: false),
358  ✔  22                         CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false)
359  ✔  22                     },
360  ✔  22                     constraints: table =>
361  ✔  22                     {
362  ✔  22                         table.PrimaryKey("PK_TokenUsages", x => x.Id);
363  ✔  22                         table.ForeignKey(
364  ✔  22                             name: "FK_TokenUsages_Projects_ProjectId",
365  ✔  22                             column: x => x.ProjectId,
366  ✔  22                             principalTable: "Projects",
367  ✔  22                             principalColumn: "Id",
368  ✔  22                             onDelete: ReferentialAction.Cascade);
369  ✔  22                         table.ForeignKey(
370  ✔  22                             name: "FK_TokenUsages_Tenants_TenantId",
371  ✔  22                             column: x => x.TenantId,
372  ✔  22                             principalTable: "Tenants",
373  ✔  22                             principalColumn: "Id",
374  ✔  22                             onDelete: ReferentialAction.Cascade);
375  ✔  22                         table.ForeignKey(
376  ✔  22                             name: "FK_TokenUsages_Users_UserId",
377  ✔  22                             column: x => x.UserId,
378  ✔  22                             principalTable: "Users",
379  ✔  22                             principalColumn: "Id");
380  ✔  44                     });
381            
382  ✔  22                 migrationBuilder.CreateIndex(
383  ✔  22                     name: "IX_ApiKeys_ProjectId",
384  ✔  22                     table: "ApiKeys",
385  ✔  22                     column: "ProjectId");
386            
387  ✔  22                 migrationBuilder.CreateIndex(
388  ✔  22                     name: "IX_AuditLogs_TenantId",
389  ✔  22                     table: "AuditLogs",
390  ✔  22                     column: "TenantId");
391            
392  ✔  22                 migrationBuilder.CreateIndex(
393  ✔  22                     name: "IX_AuditLogs_UserId",
394  ✔  22                     table: "AuditLogs",
395  ✔  22                     column: "UserId");
396            
397  ✔  22                 migrationBuilder.CreateIndex(
398  ✔  22                     name: "IX_Deviations_TenantId",
399  ✔  22                     table: "Deviations",
400  ✔  22                     column: "TenantId");
401            
402  ✔  22                 migrationBuilder.CreateIndex(
403  ✔  22                     name: "IX_ModelAliases_TenantId",
404  ✔  22                     table: "ModelAliases",
405  ✔  22                     column: "TenantId");
406            
407  ✔  22                 migrationBuilder.CreateIndex(
408  ✔  22                     name: "IX_ModelCombos_TenantId",
409  ✔  22                     table: "ModelCombos",
410  ✔  22                     column: "TenantId");
411            
412  ✔  22                 migrationBuilder.CreateIndex(
413  ✔  22                     name: "IX_OAuthAccounts_TenantId",
414  ✔  22                     table: "OAuthAccounts",
415  ✔  22                     column: "TenantId");
416            
417  ✔  22                 migrationBuilder.CreateIndex(
418  ✔  22                     name: "IX_Projects_TenantId",
419  ✔  22                     table: "Projects",
420  ✔  22                     column: "TenantId");
421            
422  ✔  22                 migrationBuilder.CreateIndex(
423  ✔  22                     name: "IX_ProjectUsers_UserId",
424  ✔  22                     table: "ProjectUsers",
425  ✔  22                     column: "UserId");
426            
427  ✔  22                 migrationBuilder.CreateIndex(
428  ✔  22                     name: "IX_ProviderAccounts_TenantId",
429  ✔  22                     table: "ProviderAccounts",
430  ✔  22                     column: "TenantId");
431            
432  ✔  22                 migrationBuilder.CreateIndex(
433  ✔  22                     name: "IX_RequestLogs_ProjectId",
434  ✔  22                     table: "RequestLogs",
435  ✔  22                     column: "ProjectId");
436            
437  ✔  22                 migrationBuilder.CreateIndex(
438  ✔  22                     name: "IX_RequestLogs_TenantId",
439  ✔  22                     table: "RequestLogs",
440  ✔  22                     column: "TenantId");
441            
442  ✔  22                 migrationBuilder.CreateIndex(
443  ✔  22                     name: "IX_RequestLogs_UserId",
444  ✔  22                     table: "RequestLogs",
445  ✔  22                     column: "UserId");
446            
447  ✔  22                 migrationBuilder.CreateIndex(
448  ✔  22                     name: "IX_RoutingPolicies_TenantId",
449  ✔  22                     table: "RoutingPolicies",
450  ✔  22                     column: "TenantId");
451            
452  ✔  22                 migrationBuilder.CreateIndex(
453  ✔  22                     name: "IX_TokenUsages_ProjectId",
454  ✔  22                     table: "TokenUsages",
455  ✔  22                     column: "ProjectId");
456            
457  ✔  22                 migrationBuilder.CreateIndex(
458  ✔  22                     name: "IX_TokenUsages_TenantId",
459  ✔  22                     table: "TokenUsages",
460  ✔  22                     column: "TenantId");
461            
462  ✔  22                 migrationBuilder.CreateIndex(
463  ✔  22                     name: "IX_TokenUsages_UserId",
464  ✔  22                     table: "TokenUsages",
465  ✔  22                     column: "UserId");
466            
467  ✔  22                 migrationBuilder.CreateIndex(
468  ✔  22                     name: "IX_Users_TenantId",
469  ✔  22                     table: "Users",
470  ✔  22                     column: "TenantId");
471  ✔  22             }
472            
473                    /// <inheritdoc />
474                    protected override void Down(MigrationBuilder migrationBuilder)
475  ❌  0             {
476  ❌  0                 migrationBuilder.DropTable(
477  ❌  0                     name: "ApiKeys");
478            
479  ❌  0                 migrationBuilder.DropTable(
480  ❌  0                     name: "AuditLogs");
481            
482  ❌  0                 migrationBuilder.DropTable(
483  ❌  0                     name: "Deviations");
484            
485  ❌  0                 migrationBuilder.DropTable(
486  ❌  0                     name: "ModelAliases");
487            
488  ❌  0                 migrationBuilder.DropTable(
489  ❌  0                     name: "ModelCombos");
490            
491  ❌  0                 migrationBuilder.DropTable(
492  ❌  0                     name: "ModelCosts");
493            
494  ❌  0                 migrationBuilder.DropTable(
495  ❌  0                     name: "OAuthAccounts");
496            
497  ❌  0                 migrationBuilder.DropTable(
498  ❌  0                     name: "ProjectUsers");
499            
500  ❌  0                 migrationBuilder.DropTable(
501  ❌  0                     name: "ProviderAccounts");
502            
503  ❌  0                 migrationBuilder.DropTable(
504  ❌  0                     name: "QuotaSnapshots");
505            
506  ❌  0                 migrationBuilder.DropTable(
507  ❌  0                     name: "RequestLogs");
508            
509  ❌  0                 migrationBuilder.DropTable(
510  ❌  0                     name: "RoutingPolicies");
511            
512  ❌  0                 migrationBuilder.DropTable(
513  ❌  0                     name: "TokenUsages");
514            
515  ❌  0                 migrationBuilder.DropTable(
516  ❌  0                     name: "Projects");
517            
518  ❌  0                 migrationBuilder.DropTable(
519  ❌  0                     name: "Users");
520            
521  ❌  0                 migrationBuilder.DropTable(
522  ❌  0                     name: "Tenants");
523  ❌  0             }
524                }
525            }
```
### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/20260126165801_AddModelCosts.Designer.cs
```
  1            // <auto-generated />
  2            using System;
  3            using Microsoft.EntityFrameworkCore;
  4            using Microsoft.EntityFrameworkCore.Infrastructure;
  5            using Microsoft.EntityFrameworkCore.Migrations;
  6            using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
  7            using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;
  8            using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
  9            
 10            #nullable disable
 11            
 12            namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations
 13            {
 14                [DbContext(typeof(ControlPlaneDbContext))]
 15                [Migration("20260126165801_AddModelCosts")]
 16                partial class AddModelCosts
 17                {
 18                    /// <inheritdoc />
 19                    protected override void BuildTargetModel(ModelBuilder modelBuilder)
 20  ✔  11             {
 21            #pragma warning disable 612, 618
 22  ✔  11                 modelBuilder
 23  ✔  11                     .HasAnnotation("ProductVersion", "10.0.2")
 24  ✔  11                     .HasAnnotation("Relational:MaxIdentifierLength", 63);
 25            
 26  ✔  11                 NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);
 27            
 28  ✔  11                 modelBuilder.Entity("ProjectUsers", b =>
 29  ✔  11                     {
 30  ✔  11                         b.Property<Guid>("ProjectId")
 31  ✔  11                             .HasColumnType("uuid");
 32  ✔  11     
 33  ✔  11                         b.Property<Guid>("UserId")
 34  ✔  11                             .HasColumnType("uuid");
 35  ✔  11     
 36  ✔  11                         b.HasKey("ProjectId", "UserId");
 37  ✔  11     
 38  ✔  11                         b.HasIndex("UserId");
 39  ✔  11     
 40  ✔  11                         b.ToTable("ProjectUsers");
 41  ✔  22                     });
 42            
 43  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ApiKey", b =>
 44  ✔  11                     {
 45  ✔  11                         b.Property<Guid>("Id")
 46  ✔  11                             .ValueGeneratedOnAdd()
 47  ✔  11                             .HasColumnType("uuid");
 48  ✔  11     
 49  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
 50  ✔  11                             .HasColumnType("timestamp with time zone");
 51  ✔  11     
 52  ✔  11                         b.Property<string>("KeyHash")
 53  ✔  11                             .IsRequired()
 54  ✔  11                             .HasMaxLength(512)
 55  ✔  11                             .HasColumnType("character varying(512)");
 56  ✔  11     
 57  ✔  11                         b.Property<string>("Name")
 58  ✔  11                             .IsRequired()
 59  ✔  11                             .HasMaxLength(200)
 60  ✔  11                             .HasColumnType("character varying(200)");
 61  ✔  11     
 62  ✔  11                         b.Property<Guid>("ProjectId")
 63  ✔  11                             .HasColumnType("uuid");
 64  ✔  11     
 65  ✔  11                         b.Property<string>("Status")
 66  ✔  11                             .IsRequired()
 67  ✔  11                             .HasColumnType("text");
 68  ✔  11     
 69  ✔  11                         b.HasKey("Id");
 70  ✔  11     
 71  ✔  11                         b.HasIndex("ProjectId");
 72  ✔  11     
 73  ✔  11                         b.ToTable("ApiKeys");
 74  ✔  22                     });
 75            
 76  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.AuditLog", b =>
 77  ✔  11                     {
 78  ✔  11                         b.Property<Guid>("Id")
 79  ✔  11                             .ValueGeneratedOnAdd()
 80  ✔  11                             .HasColumnType("uuid");
 81  ✔  11     
 82  ✔  11                         b.Property<string>("Action")
 83  ✔  11                             .IsRequired()
 84  ✔  11                             .HasMaxLength(200)
 85  ✔  11                             .HasColumnType("character varying(200)");
 86  ✔  11     
 87  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
 88  ✔  11                             .HasColumnType("timestamp with time zone");
 89  ✔  11     
 90  ✔  11                         b.Property<string>("PayloadJson")
 91  ✔  11                             .HasColumnType("jsonb");
 92  ✔  11     
 93  ✔  11                         b.Property<Guid>("TenantId")
 94  ✔  11                             .HasColumnType("uuid");
 95  ✔  11     
 96  ✔  11                         b.Property<Guid?>("UserId")
 97  ✔  11                             .HasColumnType("uuid");
 98  ✔  11     
 99  ✔  11                         b.HasKey("Id");
100  ✔  11     
101  ✔  11                         b.HasIndex("TenantId");
102  ✔  11     
103  ✔  11                         b.HasIndex("UserId");
104  ✔  11     
105  ✔  11                         b.ToTable("AuditLogs");
106  ✔  22                     });
107            
108  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.DeviationEntry", b =>
109  ✔  11                     {
110  ✔  11                         b.Property<Guid>("Id")
111  ✔  11                             .ValueGeneratedOnAdd()
112  ✔  11                             .HasColumnType("uuid");
113  ✔  11     
114  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
115  ✔  11                             .HasColumnType("timestamp with time zone");
116  ✔  11     
117  ✔  11                         b.Property<string>("Endpoint")
118  ✔  11                             .IsRequired()
119  ✔  11                             .HasMaxLength(200)
120  ✔  11                             .HasColumnType("character varying(200)");
121  ✔  11     
122  ✔  11                         b.Property<string>("Field")
123  ✔  11                             .IsRequired()
124  ✔  11                             .HasMaxLength(200)
125  ✔  11                             .HasColumnType("character varying(200)");
126  ✔  11     
127  ✔  11                         b.Property<string>("Mitigation")
128  ✔  11                             .IsRequired()
129  ✔  11                             .HasMaxLength(500)
130  ✔  11                             .HasColumnType("character varying(500)");
131  ✔  11     
132  ✔  11                         b.Property<string>("Reason")
133  ✔  11                             .IsRequired()
134  ✔  11                             .HasMaxLength(500)
135  ✔  11                             .HasColumnType("character varying(500)");
136  ✔  11     
137  ✔  11                         b.Property<string>("Status")
138  ✔  11                             .IsRequired()
139  ✔  11                             .HasColumnType("text");
140  ✔  11     
141  ✔  11                         b.Property<Guid>("TenantId")
142  ✔  11                             .HasColumnType("uuid");
143  ✔  11     
144  ✔  11                         b.HasKey("Id");
145  ✔  11     
146  ✔  11                         b.HasIndex("TenantId");
147  ✔  11     
148  ✔  11                         b.ToTable("Deviations");
149  ✔  22                     });
150            
151  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelAlias", b =>
152  ✔  11                     {
153  ✔  11                         b.Property<Guid>("Id")
154  ✔  11                             .ValueGeneratedOnAdd()
155  ✔  11                             .HasColumnType("uuid");
156  ✔  11     
157  ✔  11                         b.Property<string>("Alias")
158  ✔  11                             .IsRequired()
159  ✔  11                             .HasMaxLength(200)
160  ✔  11                             .HasColumnType("character varying(200)");
161  ✔  11     
162  ✔  11                         b.Property<string>("TargetModel")
163  ✔  11                             .IsRequired()
164  ✔  11                             .HasMaxLength(200)
165  ✔  11                             .HasColumnType("character varying(200)");
166  ✔  11     
167  ✔  11                         b.Property<Guid>("TenantId")
168  ✔  11                             .HasColumnType("uuid");
169  ✔  11     
170  ✔  11                         b.HasKey("Id");
171  ✔  11     
172  ✔  11                         b.HasIndex("TenantId");
173  ✔  11     
174  ✔  11                         b.ToTable("ModelAliases");
175  ✔  22                     });
176            
177  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCombo", b =>
178  ✔  11                     {
179  ✔  11                         b.Property<Guid>("Id")
180  ✔  11                             .ValueGeneratedOnAdd()
181  ✔  11                             .HasColumnType("uuid");
182  ✔  11     
183  ✔  11                         b.Property<string>("Name")
184  ✔  11                             .IsRequired()
185  ✔  11                             .HasMaxLength(200)
186  ✔  11                             .HasColumnType("character varying(200)");
187  ✔  11     
188  ✔  11                         b.Property<string>("OrderedModelsJson")
189  ✔  11                             .IsRequired()
190  ✔  11                             .HasColumnType("jsonb");
191  ✔  11     
192  ✔  11                         b.Property<Guid>("TenantId")
193  ✔  11                             .HasColumnType("uuid");
194  ✔  11     
195  ✔  11                         b.HasKey("Id");
196  ✔  11     
197  ✔  11                         b.HasIndex("TenantId");
198  ✔  11     
199  ✔  11                         b.ToTable("ModelCombos");
200  ✔  22                     });
201            
202  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCost", b =>
203  ✔  11                     {
204  ✔  11                         b.Property<string>("Provider")
205  ✔  11                             .HasMaxLength(100)
206  ✔  11                             .HasColumnType("character varying(100)");
207  ✔  11     
208  ✔  11                         b.Property<string>("Model")
209  ✔  11                             .HasMaxLength(200)
210  ✔  11                             .HasColumnType("character varying(200)");
211  ✔  11     
212  ✔  11                         b.Property<decimal>("CostPerToken")
213  ✔  11                             .HasColumnType("numeric");
214  ✔  11     
215  ✔  11                         b.Property<bool>("FreeTier")
216  ✔  11                             .HasColumnType("boolean");
217  ✔  11     
218  ✔  11                         b.HasKey("Provider", "Model");
219  ✔  11     
220  ✔  11                         b.ToTable("ModelCosts");
221  ✔  22                     });
222            
223  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.OAuthAccount", b =>
224  ✔  11                     {
225  ✔  11                         b.Property<Guid>("Id")
226  ✔  11                             .ValueGeneratedOnAdd()
227  ✔  11                             .HasColumnType("uuid");
228  ✔  11     
229  ✔  11                         b.Property<byte[]>("AccessTokenEncrypted")
230  ✔  11                             .IsRequired()
231  ✔  11                             .HasColumnType("bytea");
232  ✔  11     
233  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
234  ✔  11                             .HasColumnType("timestamp with time zone");
235  ✔  11     
236  ✔  11                         b.Property<DateTimeOffset?>("ExpiresAt")
237  ✔  11                             .HasColumnType("timestamp with time zone");
238  ✔  11     
239  ✔  11                         b.Property<string>("Provider")
240  ✔  11                             .IsRequired()
241  ✔  11                             .HasMaxLength(50)
242  ✔  11                             .HasColumnType("character varying(50)");
243  ✔  11     
244  ✔  11                         b.Property<byte[]>("RefreshTokenEncrypted")
245  ✔  11                             .HasColumnType("bytea");
246  ✔  11     
247  ✔  11                         b.Property<string>("Status")
248  ✔  11                             .IsRequired()
249  ✔  11                             .HasColumnType("text");
250  ✔  11     
251  ✔  11                         b.Property<Guid>("TenantId")
252  ✔  11                             .HasColumnType("uuid");
253  ✔  11     
254  ✔  11                         b.HasKey("Id");
255  ✔  11     
256  ✔  11                         b.HasIndex("TenantId");
257  ✔  11     
258  ✔  11                         b.ToTable("OAuthAccounts");
259  ✔  22                     });
260            
261  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", b =>
262  ✔  11                     {
263  ✔  11                         b.Property<Guid>("Id")
264  ✔  11                             .ValueGeneratedOnAdd()
265  ✔  11                             .HasColumnType("uuid");
266  ✔  11     
267  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
268  ✔  11                             .HasColumnType("timestamp with time zone");
269  ✔  11     
270  ✔  11                         b.Property<string>("Name")
271  ✔  11                             .IsRequired()
272  ✔  11                             .HasMaxLength(200)
273  ✔  11                             .HasColumnType("character varying(200)");
274  ✔  11     
275  ✔  11                         b.Property<string>("Status")
276  ✔  11                             .IsRequired()
277  ✔  11                             .HasColumnType("text");
278  ✔  11     
279  ✔  11                         b.Property<Guid>("TenantId")
280  ✔  11                             .HasColumnType("uuid");
281  ✔  11     
282  ✔  11                         b.HasKey("Id");
283  ✔  11     
284  ✔  11                         b.HasIndex("TenantId");
285  ✔  11     
286  ✔  11                         b.ToTable("Projects");
287  ✔  22                     });
288            
289  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderAccount", b =>
290  ✔  11                     {
291  ✔  11                         b.Property<Guid>("Id")
292  ✔  11                             .ValueGeneratedOnAdd()
293  ✔  11                             .HasColumnType("uuid");
294  ✔  11     
295  ✔  11                         b.Property<string>("AccountId")
296  ✔  11                             .IsRequired()
297  ✔  11                             .HasMaxLength(200)
298  ✔  11                             .HasColumnType("character varying(200)");
299  ✔  11     
300  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
301  ✔  11                             .HasColumnType("timestamp with time zone");
302  ✔  11     
303  ✔  11                         b.Property<string>("Provider")
304  ✔  11                             .IsRequired()
305  ✔  11                             .HasMaxLength(100)
306  ✔  11                             .HasColumnType("character varying(100)");
307  ✔  11     
308  ✔  11                         b.Property<string>("Status")
309  ✔  11                             .IsRequired()
310  ✔  11                             .HasColumnType("text");
311  ✔  11     
312  ✔  11                         b.Property<Guid>("TenantId")
313  ✔  11                             .HasColumnType("uuid");
314  ✔  11     
315  ✔  11                         b.HasKey("Id");
316  ✔  11     
317  ✔  11                         b.HasIndex("TenantId");
318  ✔  11     
319  ✔  11                         b.ToTable("ProviderAccounts");
320  ✔  22                     });
321            
322  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.QuotaSnapshot", b =>
323  ✔  11                     {
324  ✔  11                         b.Property<Guid>("Id")
325  ✔  11                             .ValueGeneratedOnAdd()
326  ✔  11                             .HasColumnType("uuid");
327  ✔  11     
328  ✔  11                         b.Property<string>("AccountId")
329  ✔  11                             .IsRequired()
330  ✔  11                             .HasMaxLength(200)
331  ✔  11                             .HasColumnType("character varying(200)");
332  ✔  11     
333  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
334  ✔  11                             .HasColumnType("timestamp with time zone");
335  ✔  11     
336  ✔  11                         b.Property<string>("Provider")
337  ✔  11                             .IsRequired()
338  ✔  11                             .HasMaxLength(100)
339  ✔  11                             .HasColumnType("character varying(100)");
340  ✔  11     
341  ✔  11                         b.Property<string>("QuotaJson")
342  ✔  11                             .IsRequired()
343  ✔  11                             .HasColumnType("jsonb");
344  ✔  11     
345  ✔  11                         b.HasKey("Id");
346  ✔  11     
347  ✔  11                         b.ToTable("QuotaSnapshots");
348  ✔  22                     });
349            
350  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RequestLog", b =>
351  ✔  11                     {
352  ✔  11                         b.Property<Guid>("Id")
353  ✔  11                             .ValueGeneratedOnAdd()
354  ✔  11                             .HasColumnType("uuid");
355  ✔  11     
356  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
357  ✔  11                             .HasColumnType("timestamp with time zone");
358  ✔  11     
359  ✔  11                         b.Property<string>("Endpoint")
360  ✔  11                             .IsRequired()
361  ✔  11                             .HasMaxLength(200)
362  ✔  11                             .HasColumnType("character varying(200)");
363  ✔  11     
364  ✔  11                         b.Property<int?>("LatencyMs")
365  ✔  11                             .HasColumnType("integer");
366  ✔  11     
367  ✔  11                         b.Property<string>("Model")
368  ✔  11                             .HasMaxLength(200)
369  ✔  11                             .HasColumnType("character varying(200)");
370  ✔  11     
371  ✔  11                         b.Property<Guid>("ProjectId")
372  ✔  11                             .HasColumnType("uuid");
373  ✔  11     
374  ✔  11                         b.Property<string>("Provider")
375  ✔  11                             .HasMaxLength(200)
376  ✔  11                             .HasColumnType("character varying(200)");
377  ✔  11     
378  ✔  11                         b.Property<string>("RequestId")
379  ✔  11                             .IsRequired()
380  ✔  11                             .HasMaxLength(200)
381  ✔  11                             .HasColumnType("character varying(200)");
382  ✔  11     
383  ✔  11                         b.Property<int?>("StatusCode")
384  ✔  11                             .HasColumnType("integer");
385  ✔  11     
386  ✔  11                         b.Property<Guid>("TenantId")
387  ✔  11                             .HasColumnType("uuid");
388  ✔  11     
389  ✔  11                         b.Property<Guid?>("UserId")
390  ✔  11                             .HasColumnType("uuid");
391  ✔  11     
392  ✔  11                         b.HasKey("Id");
393  ✔  11     
394  ✔  11                         b.HasIndex("ProjectId");
395  ✔  11     
396  ✔  11                         b.HasIndex("TenantId");
397  ✔  11     
398  ✔  11                         b.HasIndex("UserId");
399  ✔  11     
400  ✔  11                         b.ToTable("RequestLogs");
401  ✔  22                     });
402            
403  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RoutingPolicy", b =>
404  ✔  11                     {
405  ✔  11                         b.Property<Guid>("Id")
406  ✔  11                             .ValueGeneratedOnAdd()
407  ✔  11                             .HasColumnType("uuid");
408  ✔  11     
409  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
410  ✔  11                             .HasColumnType("timestamp with time zone");
411  ✔  11     
412  ✔  11                         b.Property<string>("PolicyJson")
413  ✔  11                             .IsRequired()
414  ✔  11                             .HasColumnType("jsonb");
415  ✔  11     
416  ✔  11                         b.Property<Guid>("TenantId")
417  ✔  11                             .HasColumnType("uuid");
418  ✔  11     
419  ✔  11                         b.Property<int>("Version")
420  ✔  11                             .HasColumnType("integer");
421  ✔  11     
422  ✔  11                         b.HasKey("Id");
423  ✔  11     
424  ✔  11                         b.HasIndex("TenantId");
425  ✔  11     
426  ✔  11                         b.ToTable("RoutingPolicies");
427  ✔  22                     });
428            
429  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", b =>
430  ✔  11                     {
431  ✔  11                         b.Property<Guid>("Id")
432  ✔  11                             .ValueGeneratedOnAdd()
433  ✔  11                             .HasColumnType("uuid");
434  ✔  11     
435  ✔  11                         b.Property<Guid?>("ByokKeyId")
436  ✔  11                             .HasColumnType("uuid");
437  ✔  11     
438  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
439  ✔  11                             .HasColumnType("timestamp with time zone");
440  ✔  11     
441  ✔  11                         b.Property<byte[]>("EncryptedByokKey")
442  ✔  11                             .IsRequired()
443  ✔  11                             .HasColumnType("bytea");
444  ✔  11     
445  ✔  11                         b.Property<string>("Name")
446  ✔  11                             .IsRequired()
447  ✔  11                             .HasMaxLength(200)
448  ✔  11                             .HasColumnType("character varying(200)");
449  ✔  11     
450  ✔  11                         b.Property<string>("Region")
451  ✔  11                             .IsRequired()
452  ✔  11                             .HasColumnType("text");
453  ✔  11     
454  ✔  11                         b.Property<string>("Status")
455  ✔  11                             .IsRequired()
456  ✔  11                             .HasColumnType("text");
457  ✔  11     
458  ✔  11                         b.HasKey("Id");
459  ✔  11     
460  ✔  11                         b.ToTable("Tenants");
461  ✔  22                     });
462            
463  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TokenUsage", b =>
464  ✔  11                     {
465  ✔  11                         b.Property<Guid>("Id")
466  ✔  11                             .ValueGeneratedOnAdd()
467  ✔  11                             .HasColumnType("uuid");
468  ✔  11     
469  ✔  11                         b.Property<decimal>("CostEstimate")
470  ✔  11                             .HasColumnType("numeric");
471  ✔  11     
472  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
473  ✔  11                             .HasColumnType("timestamp with time zone");
474  ✔  11     
475  ✔  11                         b.Property<int>("InputTokens")
476  ✔  11                             .HasColumnType("integer");
477  ✔  11     
478  ✔  11                         b.Property<int>("OutputTokens")
479  ✔  11                             .HasColumnType("integer");
480  ✔  11     
481  ✔  11                         b.Property<Guid>("ProjectId")
482  ✔  11                             .HasColumnType("uuid");
483  ✔  11     
484  ✔  11                         b.Property<string>("RequestId")
485  ✔  11                             .IsRequired()
486  ✔  11                             .HasMaxLength(200)
487  ✔  11                             .HasColumnType("character varying(200)");
488  ✔  11     
489  ✔  11                         b.Property<Guid>("TenantId")
490  ✔  11                             .HasColumnType("uuid");
491  ✔  11     
492  ✔  11                         b.Property<Guid?>("UserId")
493  ✔  11                             .HasColumnType("uuid");
494  ✔  11     
495  ✔  11                         b.HasKey("Id");
496  ✔  11     
497  ✔  11                         b.HasIndex("ProjectId");
498  ✔  11     
499  ✔  11                         b.HasIndex("TenantId");
500  ✔  11     
501  ✔  11                         b.HasIndex("UserId");
502  ✔  11     
503  ✔  11                         b.ToTable("TokenUsages");
504  ✔  22                     });
505            
506  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", b =>
507  ✔  11                     {
508  ✔  11                         b.Property<Guid>("Id")
509  ✔  11                             .ValueGeneratedOnAdd()
510  ✔  11                             .HasColumnType("uuid");
511  ✔  11     
512  ✔  11                         b.Property<string>("AuthProvider")
513  ✔  11                             .IsRequired()
514  ✔  11                             .HasMaxLength(50)
515  ✔  11                             .HasColumnType("character varying(50)");
516  ✔  11     
517  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
518  ✔  11                             .HasColumnType("timestamp with time zone");
519  ✔  11     
520  ✔  11                         b.Property<string>("Email")
521  ✔  11                             .IsRequired()
522  ✔  11                             .HasMaxLength(320)
523  ✔  11                             .HasColumnType("character varying(320)");
524  ✔  11     
525  ✔  11                         b.Property<string>("ProviderUserId")
526  ✔  11                             .IsRequired()
527  ✔  11                             .HasMaxLength(200)
528  ✔  11                             .HasColumnType("character varying(200)");
529  ✔  11     
530  ✔  11                         b.Property<string>("Role")
531  ✔  11                             .IsRequired()
532  ✔  11                             .HasColumnType("text");
533  ✔  11     
534  ✔  11                         b.Property<Guid>("TenantId")
535  ✔  11                             .HasColumnType("uuid");
536  ✔  11     
537  ✔  11                         b.HasKey("Id");
538  ✔  11     
539  ✔  11                         b.HasIndex("TenantId");
540  ✔  11     
541  ✔  11                         b.ToTable("Users");
542  ✔  22                     });
543            
544  ✔  11                 modelBuilder.Entity("ProjectUsers", b =>
545  ✔  11                     {
546  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", null)
547  ✔  11                             .WithMany()
548  ✔  11                             .HasForeignKey("ProjectId")
549  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
550  ✔  11                             .IsRequired();
551  ✔  11     
552  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", null)
553  ✔  11                             .WithMany()
554  ✔  11                             .HasForeignKey("UserId")
555  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
556  ✔  11                             .IsRequired();
557  ✔  22                     });
558            
559  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ApiKey", b =>
560  ✔  11                     {
561  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", "Project")
562  ✔  11                             .WithMany("ApiKeys")
563  ✔  11                             .HasForeignKey("ProjectId")
564  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
565  ✔  11                             .IsRequired();
566  ✔  11     
567  ✔  11                         b.Navigation("Project");
568  ✔  22                     });
569            
570  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.AuditLog", b =>
571  ✔  11                     {
572  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
573  ✔  11                             .WithMany()
574  ✔  11                             .HasForeignKey("TenantId")
575  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
576  ✔  11                             .IsRequired();
577  ✔  11     
578  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", "User")
579  ✔  11                             .WithMany()
580  ✔  11                             .HasForeignKey("UserId");
581  ✔  11     
582  ✔  11                         b.Navigation("Tenant");
583  ✔  11     
584  ✔  11                         b.Navigation("User");
585  ✔  22                     });
586            
587  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.DeviationEntry", b =>
588  ✔  11                     {
589  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
590  ✔  11                             .WithMany()
591  ✔  11                             .HasForeignKey("TenantId")
592  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
593  ✔  11                             .IsRequired();
594  ✔  11     
595  ✔  11                         b.Navigation("Tenant");
596  ✔  22                     });
597            
598  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelAlias", b =>
599  ✔  11                     {
600  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
601  ✔  11                             .WithMany()
602  ✔  11                             .HasForeignKey("TenantId")
603  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
604  ✔  11                             .IsRequired();
605  ✔  11     
606  ✔  11                         b.Navigation("Tenant");
607  ✔  22                     });
608            
609  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCombo", b =>
610  ✔  11                     {
611  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
612  ✔  11                             .WithMany()
613  ✔  11                             .HasForeignKey("TenantId")
614  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
615  ✔  11                             .IsRequired();
616  ✔  11     
617  ✔  11                         b.Navigation("Tenant");
618  ✔  22                     });
619            
620  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.OAuthAccount", b =>
621  ✔  11                     {
622  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
623  ✔  11                             .WithMany("OAuthAccounts")
624  ✔  11                             .HasForeignKey("TenantId")
625  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
626  ✔  11                             .IsRequired();
627  ✔  11     
628  ✔  11                         b.Navigation("Tenant");
629  ✔  22                     });
630            
631  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", b =>
632  ✔  11                     {
633  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
634  ✔  11                             .WithMany("Projects")
635  ✔  11                             .HasForeignKey("TenantId")
636  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
637  ✔  11                             .IsRequired();
638  ✔  11     
639  ✔  11                         b.Navigation("Tenant");
640  ✔  22                     });
641            
642  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderAccount", b =>
643  ✔  11                     {
644  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
645  ✔  11                             .WithMany()
646  ✔  11                             .HasForeignKey("TenantId")
647  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
648  ✔  11                             .IsRequired();
649  ✔  11     
650  ✔  11                         b.Navigation("Tenant");
651  ✔  22                     });
652            
653  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RequestLog", b =>
654  ✔  11                     {
655  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", "Project")
656  ✔  11                             .WithMany()
657  ✔  11                             .HasForeignKey("ProjectId")
658  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
659  ✔  11                             .IsRequired();
660  ✔  11     
661  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
662  ✔  11                             .WithMany()
663  ✔  11                             .HasForeignKey("TenantId")
664  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
665  ✔  11                             .IsRequired();
666  ✔  11     
667  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", "User")
668  ✔  11                             .WithMany()
669  ✔  11                             .HasForeignKey("UserId");
670  ✔  11     
671  ✔  11                         b.Navigation("Project");
672  ✔  11     
673  ✔  11                         b.Navigation("Tenant");
674  ✔  11     
675  ✔  11                         b.Navigation("User");
676  ✔  22                     });
677            
678  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RoutingPolicy", b =>
679  ✔  11                     {
680  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
681  ✔  11                             .WithMany()
682  ✔  11                             .HasForeignKey("TenantId")
683  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
684  ✔  11                             .IsRequired();
685  ✔  11     
686  ✔  11                         b.Navigation("Tenant");
687  ✔  22                     });
688            
689  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TokenUsage", b =>
690  ✔  11                     {
691  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", "Project")
692  ✔  11                             .WithMany()
693  ✔  11                             .HasForeignKey("ProjectId")
694  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
695  ✔  11                             .IsRequired();
696  ✔  11     
697  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
698  ✔  11                             .WithMany()
699  ✔  11                             .HasForeignKey("TenantId")
700  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
701  ✔  11                             .IsRequired();
702  ✔  11     
703  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", "User")
704  ✔  11                             .WithMany()
705  ✔  11                             .HasForeignKey("UserId");
706  ✔  11     
707  ✔  11                         b.Navigation("Project");
708  ✔  11     
709  ✔  11                         b.Navigation("Tenant");
710  ✔  11     
711  ✔  11                         b.Navigation("User");
712  ✔  22                     });
713            
714  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", b =>
715  ✔  11                     {
716  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
717  ✔  11                             .WithMany("Users")
718  ✔  11                             .HasForeignKey("TenantId")
719  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
720  ✔  11                             .IsRequired();
721  ✔  11     
722  ✔  11                         b.Navigation("Tenant");
723  ✔  22                     });
724            
725  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", b =>
726  ✔  11                     {
727  ✔  11                         b.Navigation("ApiKeys");
728  ✔  22                     });
729            
730  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", b =>
731  ✔  11                     {
732  ✔  11                         b.Navigation("OAuthAccounts");
733  ✔  11     
734  ✔  11                         b.Navigation("Projects");
735  ✔  11     
736  ✔  11                         b.Navigation("Users");
737  ✔  22                     });
738            #pragma warning restore 612, 618
739  ✔  11             }
740                }
741            }
```
# Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations.ControlPlaneDbContextModelSnapshot

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations.ControlPlaneDbContextModelSnapshot |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/ControlPlaneDbContextModelSnapshot.cs |
| **Line coverage:** | 100% (843 of 843) |
| Covered lines: | 843 |
| Uncovered lines: | 0 |
| Coverable lines: | 843 |
| Total lines: | 901 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **BuildModel(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/ControlPlane/Migrations/ControlPlaneDbContextModelSnapshot.cs
```
  1            // <auto-generated />
  2            using System;
  3            using Microsoft.EntityFrameworkCore;
  4            using Microsoft.EntityFrameworkCore.Infrastructure;
  5            using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
  6            using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;
  7            using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
  8            
  9            #nullable disable
 10            
 11            namespace Synaxis.InferenceGateway.Infrastructure.ControlPlane.Migrations
 12            {
 13                [DbContext(typeof(ControlPlaneDbContext))]
 14                partial class ControlPlaneDbContextModelSnapshot : ModelSnapshot
 15                {
 16                    protected override void BuildModel(ModelBuilder modelBuilder)
 17  ✔  11             {
 18            #pragma warning disable 612, 618
 19  ✔  11                 modelBuilder
 20  ✔  11                     .HasAnnotation("ProductVersion", "10.0.2")
 21  ✔  11                     .HasAnnotation("Relational:MaxIdentifierLength", 63);
 22            
 23  ✔  11                 NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);
 24            
 25  ✔  11                 modelBuilder.Entity("ProjectUsers", b =>
 26  ✔  11                     {
 27  ✔  11                         b.Property<Guid>("ProjectId")
 28  ✔  11                             .HasColumnType("uuid");
 29  ✔  11     
 30  ✔  11                         b.Property<Guid>("UserId")
 31  ✔  11                             .HasColumnType("uuid");
 32  ✔  11     
 33  ✔  11                         b.HasKey("ProjectId", "UserId");
 34  ✔  11     
 35  ✔  11                         b.HasIndex("UserId");
 36  ✔  11     
 37  ✔  11                         b.ToTable("ProjectUsers");
 38  ✔  22                     });
 39            
 40  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ApiKey", b =>
 41  ✔  11                     {
 42  ✔  11                         b.Property<Guid>("Id")
 43  ✔  11                             .ValueGeneratedOnAdd()
 44  ✔  11                             .HasColumnType("uuid");
 45  ✔  11     
 46  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
 47  ✔  11                             .HasColumnType("timestamp with time zone");
 48  ✔  11     
 49  ✔  11                         b.Property<string>("KeyHash")
 50  ✔  11                             .IsRequired()
 51  ✔  11                             .HasMaxLength(512)
 52  ✔  11                             .HasColumnType("character varying(512)");
 53  ✔  11     
 54  ✔  11                         b.Property<string>("Name")
 55  ✔  11                             .IsRequired()
 56  ✔  11                             .HasMaxLength(200)
 57  ✔  11                             .HasColumnType("character varying(200)");
 58  ✔  11     
 59  ✔  11                         b.Property<Guid>("ProjectId")
 60  ✔  11                             .HasColumnType("uuid");
 61  ✔  11     
 62  ✔  11                         b.Property<string>("Status")
 63  ✔  11                             .IsRequired()
 64  ✔  11                             .HasColumnType("text");
 65  ✔  11     
 66  ✔  11                         b.HasKey("Id");
 67  ✔  11     
 68  ✔  11                         b.HasIndex("ProjectId");
 69  ✔  11     
 70  ✔  11                         b.ToTable("ApiKeys");
 71  ✔  22                     });
 72            
 73  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.AuditLog", b =>
 74  ✔  11                     {
 75  ✔  11                         b.Property<Guid>("Id")
 76  ✔  11                             .ValueGeneratedOnAdd()
 77  ✔  11                             .HasColumnType("uuid");
 78  ✔  11     
 79  ✔  11                         b.Property<string>("Action")
 80  ✔  11                             .IsRequired()
 81  ✔  11                             .HasMaxLength(200)
 82  ✔  11                             .HasColumnType("character varying(200)");
 83  ✔  11     
 84  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
 85  ✔  11                             .HasColumnType("timestamp with time zone");
 86  ✔  11     
 87  ✔  11                         b.Property<string>("PayloadJson")
 88  ✔  11                             .HasColumnType("jsonb");
 89  ✔  11     
 90  ✔  11                         b.Property<Guid>("TenantId")
 91  ✔  11                             .HasColumnType("uuid");
 92  ✔  11     
 93  ✔  11                         b.Property<Guid?>("UserId")
 94  ✔  11                             .HasColumnType("uuid");
 95  ✔  11     
 96  ✔  11                         b.HasKey("Id");
 97  ✔  11     
 98  ✔  11                         b.HasIndex("TenantId");
 99  ✔  11     
100  ✔  11                         b.HasIndex("UserId");
101  ✔  11     
102  ✔  11                         b.ToTable("AuditLogs");
103  ✔  22                     });
104            
105  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.DeviationEntry", b =>
106  ✔  11                     {
107  ✔  11                         b.Property<Guid>("Id")
108  ✔  11                             .ValueGeneratedOnAdd()
109  ✔  11                             .HasColumnType("uuid");
110  ✔  11     
111  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
112  ✔  11                             .HasColumnType("timestamp with time zone");
113  ✔  11     
114  ✔  11                         b.Property<string>("Endpoint")
115  ✔  11                             .IsRequired()
116  ✔  11                             .HasMaxLength(200)
117  ✔  11                             .HasColumnType("character varying(200)");
118  ✔  11     
119  ✔  11                         b.Property<string>("Field")
120  ✔  11                             .IsRequired()
121  ✔  11                             .HasMaxLength(200)
122  ✔  11                             .HasColumnType("character varying(200)");
123  ✔  11     
124  ✔  11                         b.Property<string>("Mitigation")
125  ✔  11                             .IsRequired()
126  ✔  11                             .HasMaxLength(500)
127  ✔  11                             .HasColumnType("character varying(500)");
128  ✔  11     
129  ✔  11                         b.Property<string>("Reason")
130  ✔  11                             .IsRequired()
131  ✔  11                             .HasMaxLength(500)
132  ✔  11                             .HasColumnType("character varying(500)");
133  ✔  11     
134  ✔  11                         b.Property<string>("Status")
135  ✔  11                             .IsRequired()
136  ✔  11                             .HasColumnType("text");
137  ✔  11     
138  ✔  11                         b.Property<Guid>("TenantId")
139  ✔  11                             .HasColumnType("uuid");
140  ✔  11     
141  ✔  11                         b.HasKey("Id");
142  ✔  11     
143  ✔  11                         b.HasIndex("TenantId");
144  ✔  11     
145  ✔  11                         b.ToTable("Deviations");
146  ✔  22                     });
147            
148  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel", b =>
149  ✔  11                     {
150  ✔  11                         b.Property<string>("Id")
151  ✔  11                             .HasColumnType("text");
152  ✔  11     
153  ✔  11                         b.Property<int>("ContextWindow")
154  ✔  11                             .HasColumnType("integer");
155  ✔  11     
156  ✔  11                         b.Property<string>("Description")
157  ✔  11                             .HasMaxLength(1000)
158  ✔  11                             .HasColumnType("character varying(1000)");
159  ✔  11     
160  ✔  11                         b.Property<string>("Family")
161  ✔  11                             .IsRequired()
162  ✔  11                             .HasMaxLength(200)
163  ✔  11                             .HasColumnType("character varying(200)");
164  ✔  11     
165  ✔  11                         b.Property<decimal>("InputPrice")
166  ✔  11                             .HasPrecision(18, 9)
167  ✔  11                             .HasColumnType("numeric(18,9)");
168  ✔  11     
169  ✔  11                         b.Property<bool>("IsOpenWeights")
170  ✔  11                             .HasColumnType("boolean");
171  ✔  11     
172  ✔  11                         b.Property<int>("MaxOutputTokens")
173  ✔  11                             .HasColumnType("integer");
174  ✔  11     
175  ✔  11                         b.Property<string>("Name")
176  ✔  11                             .IsRequired()
177  ✔  11                             .HasMaxLength(200)
178  ✔  11                             .HasColumnType("character varying(200)");
179  ✔  11     
180  ✔  11                         b.Property<decimal>("OutputPrice")
181  ✔  11                             .HasPrecision(18, 9)
182  ✔  11                             .HasColumnType("numeric(18,9)");
183  ✔  11     
184  ✔  11                         b.Property<DateTime?>("ReleaseDate")
185  ✔  11                             .HasColumnType("timestamp with time zone");
186  ✔  11     
187  ✔  11                         b.Property<bool>("SupportsAudio")
188  ✔  11                             .HasColumnType("boolean");
189  ✔  11     
190  ✔  11                         b.Property<bool>("SupportsReasoning")
191  ✔  11                             .HasColumnType("boolean");
192  ✔  11     
193  ✔  11                         b.Property<bool>("SupportsStructuredOutput")
194  ✔  11                             .HasColumnType("boolean");
195  ✔  11     
196  ✔  11                         b.Property<bool>("SupportsTools")
197  ✔  11                             .HasColumnType("boolean");
198  ✔  11     
199  ✔  11                         b.Property<bool>("SupportsVision")
200  ✔  11                             .HasColumnType("boolean");
201  ✔  11     
202  ✔  11                         b.HasKey("Id");
203  ✔  11     
204  ✔  11                         b.ToTable("GlobalModels");
205  ✔  22                     });
206            
207  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelAlias", b =>
208  ✔  11                     {
209  ✔  11                         b.Property<Guid>("Id")
210  ✔  11                             .ValueGeneratedOnAdd()
211  ✔  11                             .HasColumnType("uuid");
212  ✔  11     
213  ✔  11                         b.Property<string>("Alias")
214  ✔  11                             .IsRequired()
215  ✔  11                             .HasMaxLength(200)
216  ✔  11                             .HasColumnType("character varying(200)");
217  ✔  11     
218  ✔  11                         b.Property<string>("TargetModel")
219  ✔  11                             .IsRequired()
220  ✔  11                             .HasMaxLength(200)
221  ✔  11                             .HasColumnType("character varying(200)");
222  ✔  11     
223  ✔  11                         b.Property<Guid>("TenantId")
224  ✔  11                             .HasColumnType("uuid");
225  ✔  11     
226  ✔  11                         b.HasKey("Id");
227  ✔  11     
228  ✔  11                         b.HasIndex("TenantId");
229  ✔  11     
230  ✔  11                         b.ToTable("ModelAliases");
231  ✔  22                     });
232            
233  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCombo", b =>
234  ✔  11                     {
235  ✔  11                         b.Property<Guid>("Id")
236  ✔  11                             .ValueGeneratedOnAdd()
237  ✔  11                             .HasColumnType("uuid");
238  ✔  11     
239  ✔  11                         b.Property<string>("Name")
240  ✔  11                             .IsRequired()
241  ✔  11                             .HasMaxLength(200)
242  ✔  11                             .HasColumnType("character varying(200)");
243  ✔  11     
244  ✔  11                         b.Property<string>("OrderedModelsJson")
245  ✔  11                             .IsRequired()
246  ✔  11                             .HasColumnType("jsonb");
247  ✔  11     
248  ✔  11                         b.Property<Guid>("TenantId")
249  ✔  11                             .HasColumnType("uuid");
250  ✔  11     
251  ✔  11                         b.HasKey("Id");
252  ✔  11     
253  ✔  11                         b.HasIndex("TenantId");
254  ✔  11     
255  ✔  11                         b.ToTable("ModelCombos");
256  ✔  22                     });
257            
258  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCost", b =>
259  ✔  11                     {
260  ✔  11                         b.Property<string>("Provider")
261  ✔  11                             .HasMaxLength(100)
262  ✔  11                             .HasColumnType("character varying(100)");
263  ✔  11     
264  ✔  11                         b.Property<string>("Model")
265  ✔  11                             .HasMaxLength(200)
266  ✔  11                             .HasColumnType("character varying(200)");
267  ✔  11     
268  ✔  11                         b.Property<decimal>("CostPerToken")
269  ✔  11                             .HasColumnType("numeric");
270  ✔  11     
271  ✔  11                         b.Property<bool>("FreeTier")
272  ✔  11                             .HasColumnType("boolean");
273  ✔  11     
274  ✔  11                         b.HasKey("Provider", "Model");
275  ✔  11     
276  ✔  11                         b.ToTable("ModelCosts");
277  ✔  22                     });
278            
279  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.OAuthAccount", b =>
280  ✔  11                     {
281  ✔  11                         b.Property<Guid>("Id")
282  ✔  11                             .ValueGeneratedOnAdd()
283  ✔  11                             .HasColumnType("uuid");
284  ✔  11     
285  ✔  11                         b.Property<byte[]>("AccessTokenEncrypted")
286  ✔  11                             .IsRequired()
287  ✔  11                             .HasColumnType("bytea");
288  ✔  11     
289  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
290  ✔  11                             .HasColumnType("timestamp with time zone");
291  ✔  11     
292  ✔  11                         b.Property<DateTimeOffset?>("ExpiresAt")
293  ✔  11                             .HasColumnType("timestamp with time zone");
294  ✔  11     
295  ✔  11                         b.Property<string>("Provider")
296  ✔  11                             .IsRequired()
297  ✔  11                             .HasMaxLength(50)
298  ✔  11                             .HasColumnType("character varying(50)");
299  ✔  11     
300  ✔  11                         b.Property<byte[]>("RefreshTokenEncrypted")
301  ✔  11                             .HasColumnType("bytea");
302  ✔  11     
303  ✔  11                         b.Property<string>("Status")
304  ✔  11                             .IsRequired()
305  ✔  11                             .HasColumnType("text");
306  ✔  11     
307  ✔  11                         b.Property<Guid>("TenantId")
308  ✔  11                             .HasColumnType("uuid");
309  ✔  11     
310  ✔  11                         b.HasKey("Id");
311  ✔  11     
312  ✔  11                         b.HasIndex("TenantId");
313  ✔  11     
314  ✔  11                         b.ToTable("OAuthAccounts");
315  ✔  22                     });
316            
317  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", b =>
318  ✔  11                     {
319  ✔  11                         b.Property<Guid>("Id")
320  ✔  11                             .ValueGeneratedOnAdd()
321  ✔  11                             .HasColumnType("uuid");
322  ✔  11     
323  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
324  ✔  11                             .HasColumnType("timestamp with time zone");
325  ✔  11     
326  ✔  11                         b.Property<string>("Name")
327  ✔  11                             .IsRequired()
328  ✔  11                             .HasMaxLength(200)
329  ✔  11                             .HasColumnType("character varying(200)");
330  ✔  11     
331  ✔  11                         b.Property<string>("Status")
332  ✔  11                             .IsRequired()
333  ✔  11                             .HasColumnType("text");
334  ✔  11     
335  ✔  11                         b.Property<Guid>("TenantId")
336  ✔  11                             .HasColumnType("uuid");
337  ✔  11     
338  ✔  11                         b.HasKey("Id");
339  ✔  11     
340  ✔  11                         b.HasIndex("TenantId");
341  ✔  11     
342  ✔  11                         b.ToTable("Projects");
343  ✔  22                     });
344            
345  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderAccount", b =>
346  ✔  11                     {
347  ✔  11                         b.Property<Guid>("Id")
348  ✔  11                             .ValueGeneratedOnAdd()
349  ✔  11                             .HasColumnType("uuid");
350  ✔  11     
351  ✔  11                         b.Property<string>("AccountId")
352  ✔  11                             .IsRequired()
353  ✔  11                             .HasMaxLength(200)
354  ✔  11                             .HasColumnType("character varying(200)");
355  ✔  11     
356  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
357  ✔  11                             .HasColumnType("timestamp with time zone");
358  ✔  11     
359  ✔  11                         b.Property<string>("Provider")
360  ✔  11                             .IsRequired()
361  ✔  11                             .HasMaxLength(100)
362  ✔  11                             .HasColumnType("character varying(100)");
363  ✔  11     
364  ✔  11                         b.Property<string>("Status")
365  ✔  11                             .IsRequired()
366  ✔  11                             .HasColumnType("text");
367  ✔  11     
368  ✔  11                         b.Property<Guid>("TenantId")
369  ✔  11                             .HasColumnType("uuid");
370  ✔  11     
371  ✔  11                         b.HasKey("Id");
372  ✔  11     
373  ✔  11                         b.HasIndex("TenantId");
374  ✔  11     
375  ✔  11                         b.ToTable("ProviderAccounts");
376  ✔  22                     });
377            
378  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderModel", b =>
379  ✔  11                     {
380  ✔  11                         b.Property<int>("Id")
381  ✔  11                             .ValueGeneratedOnAdd()
382  ✔  11                             .HasColumnType("integer");
383  ✔  11     
384  ✔  11                         NpgsqlPropertyBuilderExtensions.UseIdentityByDefaultColumn(b.Property<int>("Id"));
385  ✔  11     
386  ✔  11                         b.Property<string>("GlobalModelId")
387  ✔  11                             .IsRequired()
388  ✔  11                             .HasColumnType("text");
389  ✔  11     
390  ✔  11                         b.Property<bool>("IsAvailable")
391  ✔  11                             .HasColumnType("boolean");
392  ✔  11     
393  ✔  11                         b.Property<decimal?>("OverrideInputPrice")
394  ✔  11                             .HasPrecision(18, 9)
395  ✔  11                             .HasColumnType("numeric(18,9)");
396  ✔  11     
397  ✔  11                         b.Property<decimal?>("OverrideOutputPrice")
398  ✔  11                             .HasPrecision(18, 9)
399  ✔  11                             .HasColumnType("numeric(18,9)");
400  ✔  11     
401  ✔  11                         b.Property<string>("ProviderId")
402  ✔  11                             .IsRequired()
403  ✔  11                             .HasMaxLength(100)
404  ✔  11                             .HasColumnType("character varying(100)");
405  ✔  11     
406  ✔  11                         b.Property<string>("ProviderSpecificId")
407  ✔  11                             .IsRequired()
408  ✔  11                             .HasMaxLength(200)
409  ✔  11                             .HasColumnType("character varying(200)");
410  ✔  11     
411  ✔  11                         b.Property<int?>("RateLimitRPM")
412  ✔  11                             .HasColumnType("integer");
413  ✔  11     
414  ✔  11                         b.Property<int?>("RateLimitTPM")
415  ✔  11                             .HasColumnType("integer");
416  ✔  11     
417  ✔  11                         b.HasKey("Id");
418  ✔  11     
419  ✔  11                         b.HasIndex("GlobalModelId");
420  ✔  11     
421  ✔  11                         b.ToTable("ProviderModels");
422  ✔  22                     });
423            
424  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.QuotaSnapshot", b =>
425  ✔  11                     {
426  ✔  11                         b.Property<Guid>("Id")
427  ✔  11                             .ValueGeneratedOnAdd()
428  ✔  11                             .HasColumnType("uuid");
429  ✔  11     
430  ✔  11                         b.Property<string>("AccountId")
431  ✔  11                             .IsRequired()
432  ✔  11                             .HasMaxLength(200)
433  ✔  11                             .HasColumnType("character varying(200)");
434  ✔  11     
435  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
436  ✔  11                             .HasColumnType("timestamp with time zone");
437  ✔  11     
438  ✔  11                         b.Property<string>("Provider")
439  ✔  11                             .IsRequired()
440  ✔  11                             .HasMaxLength(100)
441  ✔  11                             .HasColumnType("character varying(100)");
442  ✔  11     
443  ✔  11                         b.Property<string>("QuotaJson")
444  ✔  11                             .IsRequired()
445  ✔  11                             .HasColumnType("jsonb");
446  ✔  11     
447  ✔  11                         b.HasKey("Id");
448  ✔  11     
449  ✔  11                         b.ToTable("QuotaSnapshots");
450  ✔  22                     });
451            
452  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RequestLog", b =>
453  ✔  11                     {
454  ✔  11                         b.Property<Guid>("Id")
455  ✔  11                             .ValueGeneratedOnAdd()
456  ✔  11                             .HasColumnType("uuid");
457  ✔  11     
458  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
459  ✔  11                             .HasColumnType("timestamp with time zone");
460  ✔  11     
461  ✔  11                         b.Property<string>("Endpoint")
462  ✔  11                             .IsRequired()
463  ✔  11                             .HasMaxLength(200)
464  ✔  11                             .HasColumnType("character varying(200)");
465  ✔  11     
466  ✔  11                         b.Property<int?>("LatencyMs")
467  ✔  11                             .HasColumnType("integer");
468  ✔  11     
469  ✔  11                         b.Property<string>("Model")
470  ✔  11                             .HasMaxLength(200)
471  ✔  11                             .HasColumnType("character varying(200)");
472  ✔  11     
473  ✔  11                         b.Property<Guid>("ProjectId")
474  ✔  11                             .HasColumnType("uuid");
475  ✔  11     
476  ✔  11                         b.Property<string>("Provider")
477  ✔  11                             .HasMaxLength(200)
478  ✔  11                             .HasColumnType("character varying(200)");
479  ✔  11     
480  ✔  11                         b.Property<string>("RequestId")
481  ✔  11                             .IsRequired()
482  ✔  11                             .HasMaxLength(200)
483  ✔  11                             .HasColumnType("character varying(200)");
484  ✔  11     
485  ✔  11                         b.Property<int?>("StatusCode")
486  ✔  11                             .HasColumnType("integer");
487  ✔  11     
488  ✔  11                         b.Property<Guid>("TenantId")
489  ✔  11                             .HasColumnType("uuid");
490  ✔  11     
491  ✔  11                         b.Property<Guid?>("UserId")
492  ✔  11                             .HasColumnType("uuid");
493  ✔  11     
494  ✔  11                         b.HasKey("Id");
495  ✔  11     
496  ✔  11                         b.HasIndex("ProjectId");
497  ✔  11     
498  ✔  11                         b.HasIndex("TenantId");
499  ✔  11     
500  ✔  11                         b.HasIndex("UserId");
501  ✔  11     
502  ✔  11                         b.ToTable("RequestLogs");
503  ✔  22                     });
504            
505  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RoutingPolicy", b =>
506  ✔  11                     {
507  ✔  11                         b.Property<Guid>("Id")
508  ✔  11                             .ValueGeneratedOnAdd()
509  ✔  11                             .HasColumnType("uuid");
510  ✔  11     
511  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
512  ✔  11                             .HasColumnType("timestamp with time zone");
513  ✔  11     
514  ✔  11                         b.Property<string>("PolicyJson")
515  ✔  11                             .IsRequired()
516  ✔  11                             .HasColumnType("jsonb");
517  ✔  11     
518  ✔  11                         b.Property<Guid>("TenantId")
519  ✔  11                             .HasColumnType("uuid");
520  ✔  11     
521  ✔  11                         b.Property<int>("Version")
522  ✔  11                             .HasColumnType("integer");
523  ✔  11     
524  ✔  11                         b.HasKey("Id");
525  ✔  11     
526  ✔  11                         b.HasIndex("TenantId");
527  ✔  11     
528  ✔  11                         b.ToTable("RoutingPolicies");
529  ✔  22                     });
530            
531  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", b =>
532  ✔  11                     {
533  ✔  11                         b.Property<Guid>("Id")
534  ✔  11                             .ValueGeneratedOnAdd()
535  ✔  11                             .HasColumnType("uuid");
536  ✔  11     
537  ✔  11                         b.Property<Guid?>("ByokKeyId")
538  ✔  11                             .HasColumnType("uuid");
539  ✔  11     
540  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
541  ✔  11                             .HasColumnType("timestamp with time zone");
542  ✔  11     
543  ✔  11                         b.Property<byte[]>("EncryptedByokKey")
544  ✔  11                             .IsRequired()
545  ✔  11                             .HasColumnType("bytea");
546  ✔  11     
547  ✔  11                         b.Property<string>("Name")
548  ✔  11                             .IsRequired()
549  ✔  11                             .HasMaxLength(200)
550  ✔  11                             .HasColumnType("character varying(200)");
551  ✔  11     
552  ✔  11                         b.Property<string>("Region")
553  ✔  11                             .IsRequired()
554  ✔  11                             .HasColumnType("text");
555  ✔  11     
556  ✔  11                         b.Property<string>("Status")
557  ✔  11                             .IsRequired()
558  ✔  11                             .HasColumnType("text");
559  ✔  11     
560  ✔  11                         b.HasKey("Id");
561  ✔  11     
562  ✔  11                         b.ToTable("Tenants");
563  ✔  22                     });
564            
565  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TenantModelLimit", b =>
566  ✔  11                     {
567  ✔  11                         b.Property<int>("Id")
568  ✔  11                             .ValueGeneratedOnAdd()
569  ✔  11                             .HasColumnType("integer");
570  ✔  11     
571  ✔  11                         NpgsqlPropertyBuilderExtensions.UseIdentityByDefaultColumn(b.Property<int>("Id"));
572  ✔  11     
573  ✔  11                         b.Property<int?>("AllowedRPM")
574  ✔  11                             .HasColumnType("integer");
575  ✔  11     
576  ✔  11                         b.Property<string>("GlobalModelId")
577  ✔  11                             .IsRequired()
578  ✔  11                             .HasColumnType("text");
579  ✔  11     
580  ✔  11                         b.Property<decimal?>("MonthlyBudget")
581  ✔  11                             .HasPrecision(18, 9)
582  ✔  11                             .HasColumnType("numeric(18,9)");
583  ✔  11     
584  ✔  11                         b.Property<string>("TenantId")
585  ✔  11                             .IsRequired()
586  ✔  11                             .HasMaxLength(200)
587  ✔  11                             .HasColumnType("character varying(200)");
588  ✔  11     
589  ✔  11                         b.HasKey("Id");
590  ✔  11     
591  ✔  11                         b.HasIndex("GlobalModelId");
592  ✔  11     
593  ✔  11                         b.ToTable("TenantModelLimits");
594  ✔  22                     });
595            
596  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TokenUsage", b =>
597  ✔  11                     {
598  ✔  11                         b.Property<Guid>("Id")
599  ✔  11                             .ValueGeneratedOnAdd()
600  ✔  11                             .HasColumnType("uuid");
601  ✔  11     
602  ✔  11                         b.Property<decimal>("CostEstimate")
603  ✔  11                             .HasColumnType("numeric");
604  ✔  11     
605  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
606  ✔  11                             .HasColumnType("timestamp with time zone");
607  ✔  11     
608  ✔  11                         b.Property<int>("InputTokens")
609  ✔  11                             .HasColumnType("integer");
610  ✔  11     
611  ✔  11                         b.Property<int>("OutputTokens")
612  ✔  11                             .HasColumnType("integer");
613  ✔  11     
614  ✔  11                         b.Property<Guid>("ProjectId")
615  ✔  11                             .HasColumnType("uuid");
616  ✔  11     
617  ✔  11                         b.Property<string>("RequestId")
618  ✔  11                             .IsRequired()
619  ✔  11                             .HasMaxLength(200)
620  ✔  11                             .HasColumnType("character varying(200)");
621  ✔  11     
622  ✔  11                         b.Property<Guid>("TenantId")
623  ✔  11                             .HasColumnType("uuid");
624  ✔  11     
625  ✔  11                         b.Property<Guid?>("UserId")
626  ✔  11                             .HasColumnType("uuid");
627  ✔  11     
628  ✔  11                         b.HasKey("Id");
629  ✔  11     
630  ✔  11                         b.HasIndex("ProjectId");
631  ✔  11     
632  ✔  11                         b.HasIndex("TenantId");
633  ✔  11     
634  ✔  11                         b.HasIndex("UserId");
635  ✔  11     
636  ✔  11                         b.ToTable("TokenUsages");
637  ✔  22                     });
638            
639  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", b =>
640  ✔  11                     {
641  ✔  11                         b.Property<Guid>("Id")
642  ✔  11                             .ValueGeneratedOnAdd()
643  ✔  11                             .HasColumnType("uuid");
644  ✔  11     
645  ✔  11                         b.Property<string>("AuthProvider")
646  ✔  11                             .IsRequired()
647  ✔  11                             .HasMaxLength(50)
648  ✔  11                             .HasColumnType("character varying(50)");
649  ✔  11     
650  ✔  11                         b.Property<DateTimeOffset>("CreatedAt")
651  ✔  11                             .HasColumnType("timestamp with time zone");
652  ✔  11     
653  ✔  11                         b.Property<string>("Email")
654  ✔  11                             .IsRequired()
655  ✔  11                             .HasMaxLength(320)
656  ✔  11                             .HasColumnType("character varying(320)");
657  ✔  11     
658  ✔  11                         b.Property<string>("ProviderUserId")
659  ✔  11                             .IsRequired()
660  ✔  11                             .HasMaxLength(200)
661  ✔  11                             .HasColumnType("character varying(200)");
662  ✔  11     
663  ✔  11                         b.Property<string>("Role")
664  ✔  11                             .IsRequired()
665  ✔  11                             .HasColumnType("text");
666  ✔  11     
667  ✔  11                         b.Property<Guid>("TenantId")
668  ✔  11                             .HasColumnType("uuid");
669  ✔  11     
670  ✔  11                         b.HasKey("Id");
671  ✔  11     
672  ✔  11                         b.HasIndex("TenantId");
673  ✔  11     
674  ✔  11                         b.ToTable("Users");
675  ✔  22                     });
676            
677  ✔  11                 modelBuilder.Entity("ProjectUsers", b =>
678  ✔  11                     {
679  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", null)
680  ✔  11                             .WithMany()
681  ✔  11                             .HasForeignKey("ProjectId")
682  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
683  ✔  11                             .IsRequired();
684  ✔  11     
685  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", null)
686  ✔  11                             .WithMany()
687  ✔  11                             .HasForeignKey("UserId")
688  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
689  ✔  11                             .IsRequired();
690  ✔  22                     });
691            
692  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ApiKey", b =>
693  ✔  11                     {
694  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", "Project")
695  ✔  11                             .WithMany("ApiKeys")
696  ✔  11                             .HasForeignKey("ProjectId")
697  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
698  ✔  11                             .IsRequired();
699  ✔  11     
700  ✔  11                         b.Navigation("Project");
701  ✔  22                     });
702            
703  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.AuditLog", b =>
704  ✔  11                     {
705  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
706  ✔  11                             .WithMany()
707  ✔  11                             .HasForeignKey("TenantId")
708  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
709  ✔  11                             .IsRequired();
710  ✔  11     
711  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", "User")
712  ✔  11                             .WithMany()
713  ✔  11                             .HasForeignKey("UserId");
714  ✔  11     
715  ✔  11                         b.Navigation("Tenant");
716  ✔  11     
717  ✔  11                         b.Navigation("User");
718  ✔  22                     });
719            
720  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.DeviationEntry", b =>
721  ✔  11                     {
722  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
723  ✔  11                             .WithMany()
724  ✔  11                             .HasForeignKey("TenantId")
725  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
726  ✔  11                             .IsRequired();
727  ✔  11     
728  ✔  11                         b.Navigation("Tenant");
729  ✔  22                     });
730            
731  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelAlias", b =>
732  ✔  11                     {
733  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
734  ✔  11                             .WithMany()
735  ✔  11                             .HasForeignKey("TenantId")
736  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
737  ✔  11                             .IsRequired();
738  ✔  11     
739  ✔  11                         b.Navigation("Tenant");
740  ✔  22                     });
741            
742  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ModelCombo", b =>
743  ✔  11                     {
744  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
745  ✔  11                             .WithMany()
746  ✔  11                             .HasForeignKey("TenantId")
747  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
748  ✔  11                             .IsRequired();
749  ✔  11     
750  ✔  11                         b.Navigation("Tenant");
751  ✔  22                     });
752            
753  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.OAuthAccount", b =>
754  ✔  11                     {
755  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
756  ✔  11                             .WithMany("OAuthAccounts")
757  ✔  11                             .HasForeignKey("TenantId")
758  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
759  ✔  11                             .IsRequired();
760  ✔  11     
761  ✔  11                         b.Navigation("Tenant");
762  ✔  22                     });
763            
764  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", b =>
765  ✔  11                     {
766  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
767  ✔  11                             .WithMany("Projects")
768  ✔  11                             .HasForeignKey("TenantId")
769  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
770  ✔  11                             .IsRequired();
771  ✔  11     
772  ✔  11                         b.Navigation("Tenant");
773  ✔  22                     });
774            
775  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderAccount", b =>
776  ✔  11                     {
777  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
778  ✔  11                             .WithMany()
779  ✔  11                             .HasForeignKey("TenantId")
780  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
781  ✔  11                             .IsRequired();
782  ✔  11     
783  ✔  11                         b.Navigation("Tenant");
784  ✔  22                     });
785            
786  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.ProviderModel", b =>
787  ✔  11                     {
788  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel", "GlobalModel")
789  ✔  11                             .WithMany("ProviderModels")
790  ✔  11                             .HasForeignKey("GlobalModelId")
791  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
792  ✔  11                             .IsRequired();
793  ✔  11     
794  ✔  11                         b.Navigation("GlobalModel");
795  ✔  22                     });
796            
797  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RequestLog", b =>
798  ✔  11                     {
799  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", "Project")
800  ✔  11                             .WithMany()
801  ✔  11                             .HasForeignKey("ProjectId")
802  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
803  ✔  11                             .IsRequired();
804  ✔  11     
805  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
806  ✔  11                             .WithMany()
807  ✔  11                             .HasForeignKey("TenantId")
808  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
809  ✔  11                             .IsRequired();
810  ✔  11     
811  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", "User")
812  ✔  11                             .WithMany()
813  ✔  11                             .HasForeignKey("UserId");
814  ✔  11     
815  ✔  11                         b.Navigation("Project");
816  ✔  11     
817  ✔  11                         b.Navigation("Tenant");
818  ✔  11     
819  ✔  11                         b.Navigation("User");
820  ✔  22                     });
821            
822  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.RoutingPolicy", b =>
823  ✔  11                     {
824  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
825  ✔  11                             .WithMany()
826  ✔  11                             .HasForeignKey("TenantId")
827  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
828  ✔  11                             .IsRequired();
829  ✔  11     
830  ✔  11                         b.Navigation("Tenant");
831  ✔  22                     });
832            
833  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TenantModelLimit", b =>
834  ✔  11                     {
835  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel", "GlobalModel")
836  ✔  11                             .WithMany()
837  ✔  11                             .HasForeignKey("GlobalModelId")
838  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
839  ✔  11                             .IsRequired();
840  ✔  11     
841  ✔  11                         b.Navigation("GlobalModel");
842  ✔  22                     });
843            
844  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.TokenUsage", b =>
845  ✔  11                     {
846  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", "Project")
847  ✔  11                             .WithMany()
848  ✔  11                             .HasForeignKey("ProjectId")
849  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
850  ✔  11                             .IsRequired();
851  ✔  11     
852  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
853  ✔  11                             .WithMany()
854  ✔  11                             .HasForeignKey("TenantId")
855  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
856  ✔  11                             .IsRequired();
857  ✔  11     
858  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", "User")
859  ✔  11                             .WithMany()
860  ✔  11                             .HasForeignKey("UserId");
861  ✔  11     
862  ✔  11                         b.Navigation("Project");
863  ✔  11     
864  ✔  11                         b.Navigation("Tenant");
865  ✔  11     
866  ✔  11                         b.Navigation("User");
867  ✔  22                     });
868            
869  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.User", b =>
870  ✔  11                     {
871  ✔  11                         b.HasOne("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", "Tenant")
872  ✔  11                             .WithMany("Users")
873  ✔  11                             .HasForeignKey("TenantId")
874  ✔  11                             .OnDelete(DeleteBehavior.Cascade)
875  ✔  11                             .IsRequired();
876  ✔  11     
877  ✔  11                         b.Navigation("Tenant");
878  ✔  22                     });
879            
880  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.GlobalModel", b =>
881  ✔  11                     {
882  ✔  11                         b.Navigation("ProviderModels");
883  ✔  22                     });
884            
885  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Project", b =>
886  ✔  11                     {
887  ✔  11                         b.Navigation("ApiKeys");
888  ✔  22                     });
889            
890  ✔  11                 modelBuilder.Entity("Synaxis.InferenceGateway.Application.ControlPlane.Entities.Tenant", b =>
891  ✔  11                     {
892  ✔  11                         b.Navigation("OAuthAccounts");
893  ✔  11     
894  ✔  11                         b.Navigation("Projects");
895  ✔  11     
896  ✔  11                         b.Navigation("Users");
897  ✔  22                     });
898            #pragma warning restore 612, 618
899  ✔  11             }
900                }
901            }
```
# Synaxis.InferenceGateway.Infrastructure.Extensions.BespokeExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Extensions.BespokeExtensions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/BespokeExtensions.cs |
| **Line coverage:** | 0% (0 of 16) |
| Covered lines: | 0 |
| Uncovered lines: | 16 |
| Coverable lines: | 16 |
| Total lines: | 29 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddCohereClient(...)** | 100% | 2 | 1 | 0% |
| **AddPollinationsClient(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/BespokeExtensions.cs
```
 1           using Microsoft.Extensions.AI;
 2           using Microsoft.Extensions.DependencyInjection;
 3           using System;
 4           using System.Net.Http;
 5           
 6           namespace Synaxis.InferenceGateway.Infrastructure.Extensions;
 7           
 8           public static class BespokeExtensions
 9           {
10               public static IServiceCollection AddCohereClient(this IServiceCollection services, string key, string apiKey, string
11  ❌ 0         {
12  ❌ 0             services.AddKeyedSingleton<IChatClient>(key, (sp, obj) =>
13  ❌ 0             {
14  ❌ 0                 var httpClient = new HttpClient();
15  ❌ 0                 return new CohereChatClient(httpClient, modelId, apiKey);
16  ❌ 0             });
17  ❌ 0             return services;
18  ❌ 0         }
19           
20               public static IServiceCollection AddPollinationsClient(this IServiceCollection services, string key, string modelId)
21  ❌ 0         {
22  ❌ 0             services.AddKeyedSingleton<IChatClient>(key, (sp, obj) =>
23  ❌ 0             {
24  ❌ 0                 var httpClient = new HttpClient();
25  ❌ 0                 return new PollinationsChatClient(httpClient, modelId);
26  ❌ 0             });
27  ❌ 0             return services;
28  ❌ 0         }
29           }
```
# Synaxis.InferenceGateway.Infrastructure.Extensions.CustomProviderExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Extensions.CustomProviderExtensions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/CustomProviderExtensions.cs |
| **Line coverage:** | 0% (0 of 58) |
| Covered lines: | 0 |
| Uncovered lines: | 58 |
| Coverable lines: | 58 |
| Total lines: | 88 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddCohere(...)** | 100% | 2 | 1 | 0% |
| **AddPollinations(...)** | 100% | 2 | 1 | 0% |
| **AddCloudflare(...)** | 100% | 2 | 1 | 0% |
| **AddGitHubCopilotSdk(...)** | 0% | 20 | 4 | 0% |
| **AddDuckDuckGo(...)** | 100% | 2 | 1 | 0% |
| **AddAiHorde(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/CustomProviderExtensions.cs
```
 1           using Microsoft.Extensions.DependencyInjection;
 2           using Microsoft.Extensions.AI;
 3           using System.Net.Http;
 4           using System.Net.Http.Headers;
 5           using GitHub.Copilot.SDK;
 6           using Synaxis.InferenceGateway.Infrastructure.External.GitHub;
 7           using Microsoft.Extensions.Logging;
 8           
 9           namespace Synaxis.InferenceGateway.Infrastructure.Extensions;
10           
11               public static class CustomProviderExtensions
12               {
13               public static IServiceCollection AddCohere(this IServiceCollection services, string apiKey, string modelId)
14  ❌ 0         {
15  ❌ 0             services.AddChatClient(sp =>
16  ❌ 0             {
17  ❌ 0                 var httpClient = new HttpClient();
18  ❌ 0                 return new CohereChatClient(httpClient, modelId, apiKey);
19  ❌ 0             });
20  ❌ 0             return services;
21  ❌ 0         }
22           
23               public static IServiceCollection AddPollinations(this IServiceCollection services, string? modelId = null)
24  ❌ 0         {
25  ❌ 0             services.AddChatClient(sp =>
26  ❌ 0             {
27  ❌ 0                 var httpClient = new HttpClient();
28  ❌ 0                 return new PollinationsChatClient(httpClient, modelId);
29  ❌ 0             });
30  ❌ 0             return services;
31  ❌ 0         }
32           
33               public static IServiceCollection AddCloudflare(this IServiceCollection services, string apiKey, string accountId, st
34  ❌ 0         {
35  ❌ 0             services.AddChatClient(sp =>
36  ❌ 0             {
37  ❌ 0                 var httpClient = new HttpClient();
38  ❌ 0                 return new CloudflareChatClient(httpClient, accountId, modelId, apiKey);
39  ❌ 0             });
40  ❌ 0             return services;
41  ❌ 0         }
42           
43               public static IServiceCollection AddGitHubCopilotSdk(this IServiceCollection services, string name = "GitHubCopilot"
44  ❌ 0         {
45                   // Register underlying CopilotClient via adapter reflection as singleton
46  ❌ 0             services.AddSingleton<ICopilotSdkAdapter, CopilotSdkAdapter>();
47           
48                   // Register ICopilotClient by wrapping the concrete CopilotClient from the adapter (if available)
49  ❌ 0             services.AddSingleton<ICopilotClient>(sp =>
50  ❌ 0             {
51  ❌ 0                 var adapter = sp.GetRequiredService<ICopilotSdkAdapter>();
52  ❌ 0  ○              var clientObj = adapter.GetService(Type.GetType("GitHub.Copilot.Sdk.CopilotClient, GitHub.Copilot.Sdk") ?? t
53  ❌ 0                 var concrete = clientObj as global::GitHub.Copilot.SDK.CopilotClient;
54  ❌ 0  ○              if (concrete == null) throw new InvalidOperationException("CopilotClient not available");
55  ❌ 0                 return new CopilotClientAdapter(concrete);
56  ❌ 0             });
57           
58                   // Register GitHubCopilotChatClient as keyed scoped IChatClient
59  ❌ 0             services.AddKeyedScoped<IChatClient>(name, (sp, k) =>
60  ❌ 0             {
61  ❌ 0                 var client = sp.GetRequiredService<ICopilotClient>();
62  ❌ 0                 var logger = sp.GetService<ILogger<GitHubCopilotChatClient>>();
63  ❌ 0                 return new GitHubCopilotChatClient(client, logger);
64  ❌ 0             });
65           
66  ❌ 0             return services;
67  ❌ 0         }
68           
69               public static IServiceCollection AddDuckDuckGo(this IServiceCollection services, string name, string modelId)
70  ❌ 0         {
71  ❌ 0             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
72  ❌ 0             {
73  ❌ 0                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient();
74  ❌ 0                 return new Synaxis.InferenceGateway.Infrastructure.External.DuckDuckGo.DuckDuckGoChatClient(httpClient, mode
75  ❌ 0             });
76  ❌ 0             return services;
77  ❌ 0         }
78           
79               public static IServiceCollection AddAiHorde(this IServiceCollection services, string name, string apiKey)
80  ❌ 0         {
81  ❌ 0             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
82  ❌ 0             {
83  ❌ 0                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient();
84  ❌ 0                 return new Synaxis.InferenceGateway.Infrastructure.External.AiHorde.AiHordeChatClient(httpClient, apiKey);
85  ❌ 0             });
86  ❌ 0             return services;
87  ❌ 0         }
88           }
```
# Synaxis.InferenceGateway.Infrastructure.Extensions.GeminiExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Extensions.GeminiExtensions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/GeminiExtensions.cs |
| **Line coverage:** | 0% (0 of 5) |
| Covered lines: | 0 |
| Uncovered lines: | 5 |
| Coverable lines: | 5 |
| Total lines: | 16 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddGeminiClient(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/GeminiExtensions.cs
```
 1           using Microsoft.Extensions.AI;
 2           using Microsoft.Extensions.DependencyInjection;
 3           
 4           namespace Synaxis.InferenceGateway.Infrastructure.Extensions;
 5           
 6           public static class GeminiExtensions
 7           {
 8               public static IServiceCollection AddGeminiClient(this IServiceCollection services, string apiKey, string modelId)
 9  ❌ 0         {
10  ❌ 0             var client = new Google.GenAI.Client(vertexAI: false, apiKey: apiKey);
11           
12  ❌ 0             services.AddChatClient(_ => client.AsIChatClient(modelId));
13           
14  ❌ 0             return services;
15  ❌ 0         }
16           }
```
# Synaxis.InferenceGateway.Infrastructure.Extensions.HuggingFaceExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Extensions.HuggingFaceExtensions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/HuggingFaceExtensions.cs |
| **Line coverage:** | 100% (7 of 7) |
| Covered lines: | 7 |
| Uncovered lines: | 0 |
| Coverable lines: | 7 |
| Total lines: | 17 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddHuggingFaceClient(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/HuggingFaceExtensions.cs
```
 1            using Microsoft.Extensions.AI;
 2            using Microsoft.Extensions.DependencyInjection;
 3            
 4            namespace Synaxis.InferenceGateway.Infrastructure.Extensions;
 5            
 6            public static class HuggingFaceExtensions
 7            {
 8                public static IServiceCollection AddHuggingFaceClient(this IServiceCollection services, string serviceKey, string ap
 9  ✔  37         {
10  ✔  37             services.AddKeyedSingleton<IChatClient>(serviceKey, (_, _) => new GenericOpenAiChatClient(
11  ✔  37                 apiKey,
12  ✔  37                 new Uri("https://router.huggingface.co/v1/"),
13  ✔  37                 modelId));
14            
15  ✔  37             return services;
16  ✔  37         }
17            }
```
# Synaxis.InferenceGateway.Infrastructure.Extensions.InfrastructureExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Extensions.InfrastructureExtensions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/InfrastructureExtensions.cs |
| **Line coverage:** | 72.2% (167 of 231) |
| Covered lines: | 167 |
| Uncovered lines: | 64 |
| Coverable lines: | 231 |
| Total lines: | 342 |
| **Branch coverage:** | 66.6% (92 of 138) |
| Covered branches: | 92 |
| Total branches: | 138 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddSynaxisInfrastructure(...)** | 66.17% | 740 | 136 | 68.04% |
| **AddInfrastructureHelpers(...)** | 100% | 1 | 1 | 100% |
| **GetRetryPolicy()** | 100% | 1 | 1 | 83.33% |
| **InitializeDatabaseAsync()** | 100% | 2 | 2 | 95.00% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/InfrastructureExtensions.cs
```
  1              using Microsoft.Extensions.Configuration;
  2              using Microsoft.Extensions.DependencyInjection;
  3              using Microsoft.Extensions.Logging;
  4              using Microsoft.Extensions.Options;
  5              using Synaxis.InferenceGateway.Application.Configuration;
  6              using Synaxis.InferenceGateway.Infrastructure.Auth;
  7              using Synaxis.InferenceGateway.Infrastructure.Security;
  8              using Synaxis.InferenceGateway.Application.Security;
  9              using Polly;
 10              using Polly.Extensions.Http;
 11              using Microsoft.Extensions.AI;
 12              using System.Net.Http;
 13              using System.Diagnostics;
 14              using Polly.Registry;
 15              
 16              using Synaxis.InferenceGateway.Infrastructure.Routing;
 17              using Synaxis.InferenceGateway.Infrastructure.Identity.Core;
 18              using Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub;
 19              using Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google;
 20              using Synaxis.InferenceGateway.Infrastructure.External.OpenAi;
 21              using Microsoft.AspNetCore.DataProtection;
 22              using Microsoft.Extensions.Hosting;
 23              using Synaxis.InferenceGateway.Infrastructure.External.GitHub;
 24              using Synaxis.InferenceGateway.Application.Routing;
 25              using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 26              using Synaxis.InferenceGateway.Infrastructure.External.ModelsDev;
 27              using Synaxis.InferenceGateway.Application.ControlPlane;
 28              using Synaxis.InferenceGateway.Application.ChatClients;
 29              using Synaxis.InferenceGateway.Infrastructure.ChatClients;
 30              using Synaxis.InferenceGateway.Infrastructure.ChatClients.Strategies;
 31              using Synaxis.InferenceGateway.Application.ChatClients.Strategies;
 32              using StackExchange.Redis;
 33              using Microsoft.EntityFrameworkCore;
 34              
 35              namespace Synaxis.InferenceGateway.Infrastructure.Extensions;
 36              
 37              public static class InfrastructureExtensions
 38              {
 39                  public static IServiceCollection AddSynaxisInfrastructure(this IServiceCollection services, IConfiguration configura
 40  ✔    37         {
 41                      // 0. Register Telemetry
 42  ✔    37             services.AddSingleton(new ActivitySource("Synaxis.InferenceGateway"));
 43              
 44                      // 0.1 Register Resilience
 45  ✔    37             services.AddResiliencePipeline("provider-retry", (builder, context) =>
 46  ✔    14             {
 47  ✔    14                 builder.AddRetry(new Polly.Retry.RetryStrategyOptions
 48  ✔    14                 {
 49  ✔    14                     MaxRetryAttempts = 3,
 50  ✔    14                     BackoffType = DelayBackoffType.Exponential,
 51  ✔    14                     UseJitter = true,
 52  ✔    14                     Delay = TimeSpan.FromSeconds(1)
 53  ✔    14                 });
 54  ✔    14                 builder.AddTimeout(TimeSpan.FromMinutes(2));
 55  ✔    51             });
 56              
 57                      // 0.2 Register Redis
 58  ✔    37             services.AddSingleton<IConnectionMultiplexer>(sp =>
 59  ✔    16             {
 60  ✔    16                 var config = sp.GetRequiredService<IConfiguration>();
 61  ✓    16  ◑              var connectionString = config.GetConnectionString("Redis") ?? "localhost";
 62  ✔    37     
 63  ✔    37                 // Ensure we don't crash if Redis is down (fail-open)
 64  ✓    16  ◑              if (!connectionString.Contains("abortConnect=", StringComparison.OrdinalIgnoreCase))
 65  ❌    0                 {
 66  ❌    0                     connectionString += ",abortConnect=false";
 67  ❌    0                 }
 68  ✔    37     
 69  ✔    16                 return ConnectionMultiplexer.Connect(connectionString);
 70  ✔    53             });
 71              
 72  ✔    37             services.AddSingleton<IHealthStore, RedisHealthStore>();
 73  ✔    37             services.AddSingleton<IQuotaTracker, RedisQuotaTracker>();
 74              
 75                      // 1. Register TokenStore and Auth Manager (Singleton) with Factory
 76  ✔    37             services.AddSingleton<AntigravitySettings>(sp =>
 77  ✔    37             {
 78  ✔    37                 var config = sp.GetRequiredService<IOptions<SynaxisConfiguration>>().Value;
 79  ✔    37  ●              return config.Antigravity ?? new AntigravitySettings();
 80  ✔    74             });
 81              
 82  ✔    37             services.AddSingleton<ITokenStore>(sp =>
 83  ❌    0             {
 84  ❌    0                 var config = sp.GetRequiredService<IOptions<SynaxisConfiguration>>().Value;
 85  ❌    0  ○              var providerConfig = config.Providers.Values.FirstOrDefault(p => p.Type?.ToLowerInvariant() == "antigravity"
 86  ❌    0                 var defaultPath = System.IO.Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "
 87  ❌    0  ○              var authPath = providerConfig?.AuthStoragePath ?? defaultPath;
 88  ❌    0                 var logger = sp.GetRequiredService<ILogger<FileTokenStore>>();
 89  ❌    0                 return new FileTokenStore(authPath, logger);
 90  ✔    37             });
 91              
 92                      // Register identity-related services
 93  ✔    37             services.AddSingleton<ISecureTokenStore>(sp =>
 94  ✔    37             {
 95  ✔    37                 var provider = sp.GetRequiredService<IDataProtectionProvider>();
 96  ✔    37                 var config = sp.GetRequiredService<IOptions<SynaxisConfiguration>>().Value;
 97  ✓   728  ◑              var providerConfig = config.Providers.Values.FirstOrDefault(p => p.Type?.ToLowerInvariant() == "antigravity"
 98  ✔    37                 var defaultPath = System.IO.Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "
 99  ✓    37  ◑              var authPath = providerConfig?.AuthStoragePath ?? defaultPath;
100  ✔    37                 return new EncryptedFileTokenStore(provider, authPath);
101  ✔    74             });
102              
103  ✔    37             services.AddSingleton<IdentityManager>();
104  ✔    74             services.AddSingleton<IHostedService>(sp => sp.GetRequiredService<IdentityManager>());
105              
106                      // Auth strategies
107  ✔    37             services.AddSingleton<IAuthStrategy, GitHubAuthStrategy>();
108  ✔    37             services.AddSingleton<IAuthStrategy, GoogleAuthStrategy>();
109  ✔    37             services.AddSingleton<DeviceFlowService>();
110              
111                      // Antigravity Auth Manager (Singleton)
112  ✔    37             services.AddSingleton<IAntigravityAuthManager>(sp =>
113  ❌    0             {
114  ❌    0                 var config = sp.GetRequiredService<IOptions<SynaxisConfiguration>>().Value;
115  ❌    0  ○              var providerConfig = config.Providers.Values.FirstOrDefault(p => p.Type?.ToLowerInvariant() == "antigravity"
116  ✔    37     
117  ❌    0  ○              var projectId = providerConfig?.ProjectId ?? "rising-fact-p41fc";
118  ❌    0  ○              var settings = config.Antigravity ?? new AntigravitySettings();
119  ✔    37     
120  ✔    37                 // Ensure settings are valid, or provide defaults/throw if strict
121  ❌    0  ○              if (string.IsNullOrEmpty(settings.ClientId))
122  ❌    0                 {
123  ✔    37                      // Fallback or log warning?
124  ✔    37                      // For now, let's assume they are provided or we might fail at runtime.
125  ❌    0                 }
126  ✔    37     
127  ❌    0                 return new AntigravityAuthManager(
128  ❌    0                     projectId,
129  ❌    0                     settings,
130  ❌    0                     sp.GetRequiredService<ILogger<AntigravityAuthManager>>(),
131  ❌    0                     sp.GetRequiredService<IHttpClientFactory>(),
132  ❌    0                     sp.GetRequiredService<ITokenStore>()
133  ❌    0                 );
134  ✔    37             });
135              
136                      // Identity-backed token provider (defaults to Google)
137  ✔    37             services.AddSingleton<ITokenProvider, Synaxis.InferenceGateway.Infrastructure.Identity.IdentityTokenProvider>();
138              
139                      // Named HttpClients for strategies and adapters
140  ✔    37             services.AddHttpClient("GitHub");
141  ✔    37             services.AddHttpClient("Google");
142  ✔    37             services.AddHttpClient("Antigravity");
143              
144                      // Note: legacy AntigravityAuthManager registration removed in favor of identity-backed adapter
145              
146                      // 1.5 Register Security Services
147  ✔    37             services.AddScoped<ITokenVault, AesGcmTokenVault>();
148  ✔    37             services.AddSingleton<IApiKeyService, ApiKeyService>();
149  ✔    37             services.AddScoped<IAuditService, AuditService>();
150  ✔    37             services.AddSingleton<IJwtService, JwtService>();
151              
152                      // 1.6 Register Routing Services
153  ✔    37             services.AddScoped<ICostService, CostService>();
154  ✔    37             services.AddScoped<IControlPlaneStore, ControlPlaneStore>();
155              
156                      // 2. Register Providers as Keyed Services
157  ✔    37             var synaxisConfig = configuration.GetSection("Synaxis:InferenceGateway").Get<SynaxisConfiguration>();
158  ✔    37  ●          if (synaxisConfig != null)
159  ✔    37             {
160  ✔  1443  ●              foreach (var provider in synaxisConfig.Providers)
161  ✔   666                 {
162  ✔   666                     var name = provider.Key;
163  ✔   666                     var config = provider.Value;
164  ✔   666  ●                  if (!config.Enabled) continue;
165  ✔  1292  ●                  var defaultModel = config.Models.FirstOrDefault(m => m != "*") ?? "default";
166              
167  ✓   666  ◕                  switch (config.Type?.ToLowerInvariant())
168                              {
169                                  case "openai":
170  ✓   185  ◑                          services.AddOpenAiCompatibleClient(name, config.Endpoint ?? "https://api.openai.com/v1", config.
171  ✔   185                             break;
172                                  case "groq":
173  ✓    37  ◑                          services.AddOpenAiCompatibleClient(name, "https://api.groq.com/openai/v1", config.Key ?? "", def
174  ✔    37                             break;
175                                  case "cohere":
176  ✔    37                             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
177  ❌    0                             {
178  ❌    0                                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient();
179  ❌    0  ○                              return new CohereChatClient(httpClient, defaultModel, config.Key ?? "");
180  ✔    37                             });
181  ✔    37                             break;
182                                  case "cloudflare":
183  ✔    37                             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
184  ❌    0                             {
185  ❌    0                                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient();
186  ❌    0  ○                              return new CloudflareChatClient(httpClient, config.AccountId ?? "", defaultModel, config.Key
187  ✔    37                             });
188  ✔    37                             break;
189                                  case "gemini":
190  ✔    37                             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
191  ❌    0                             {
192  ❌    0                                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient("Google");
193  ❌    0  ○                              return new Synaxis.InferenceGateway.Infrastructure.External.Google.GoogleChatClient(config.K
194  ✔    37                             });
195  ✔    37                             break;
196                                  case "antigravity":
197  ❌    0                             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
198  ❌    0                             {
199  ❌    0                                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient("Antigravity");
200  ❌    0                                 // Use the specialized AntigravityAuthManager
201  ❌    0                                 var authManager = sp.GetRequiredService<IAntigravityAuthManager>();
202  ❌    0  ○                              return new AntigravityChatClient(httpClient, defaultModel, config.ProjectId ?? "", authManag
203  ❌    0                             });
204  ❌    0                             break;
205                                  case "openrouter":
206  ✓    37  ◑                          services.AddOpenRouterClient(name, config.Key ?? "", defaultModel);
207  ✔    37                             break;
208                                  case "nvidia":
209  ✓    37  ◑                          services.AddNvidiaClient(name, config.Key ?? "", defaultModel);
210  ✔    37                             break;
211                                  case "huggingface":
212  ✓    37  ◑                          services.AddHuggingFaceClient(name, config.Key ?? "", defaultModel);
213  ✔    37                             break;
214                                  case "pollinations":
215  ✔    37                             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
216  ❌    0                             {
217  ❌    0                                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient();
218  ❌    0                                 return new PollinationsChatClient(httpClient, defaultModel);
219  ✔    37                             });
220  ✔    37                             break;
221                                  case "githubcopilot":
222  ✔    37                             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
223  ❌    0                             {
224  ✔    37                                 // Ensure the adapter is registered as a singleton and return the CopilotSdkClient
225  ❌    0                                 var adapter = sp.GetService<ICopilotSdkAdapter>();
226  ❌    0  ○                              if (adapter != null) return new CopilotSdkClient(adapter);
227  ✔    37                                 // If adapter isn't registered (older deployments), fall back to a no-op client
228  ❌    0                                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient();
229  ❌    0                                 return new Synaxis.InferenceGateway.Infrastructure.External.DuckDuckGo.DuckDuckGoChatClient(
230  ✔    37                             });
231  ✔    37                             break;
232                                  case "duckduckgo":
233  ✔    37                             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
234  ❌    0                             {
235  ❌    0                                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient();
236  ❌    0                                 return new Synaxis.InferenceGateway.Infrastructure.External.DuckDuckGo.DuckDuckGoChatClient(
237  ✔    37                             });
238  ✔    37                             break;
239                                  case "aihorde":
240  ✔    37                             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
241  ❌    0                             {
242  ❌    0                                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient();
243  ❌    0  ○                              return new Synaxis.InferenceGateway.Infrastructure.External.AiHorde.AiHordeChatClient(httpCl
244  ✔    37                             });
245  ✔    37                             break;
246                                  case "kilocode":
247  ✔    34                             services.AddKeyedSingleton<IChatClient>(name, (sp, k) =>
248  ❌    0                             {
249  ❌    0                                 var httpClient = sp.GetRequiredService<IHttpClientFactory>().CreateClient();
250  ❌    0  ○                              return new Synaxis.InferenceGateway.Infrastructure.External.KiloCode.KiloCodeChatClient(conf
251  ✔    34                             });
252  ✔    34                             break;
253                                  default:
254  ✔    40  ●                          if (!string.IsNullOrEmpty(config.Endpoint))
255  ✔    37                             {
256  ✓    37  ◑                              services.AddOpenAiCompatibleClient(name, config.Endpoint, config.Key ?? "", defaultModel);
257  ✔    37                             }
258  ✔    40                             break;
259                              }
260  ✔   666                 }
261  ✔    37             }
262              
263                      // 3. Configure HttpClient for Antigravity with Polly and correct BaseAddress
264  ✔    37             services.AddHttpClient("Antigravity", client =>
265  ❌    0             {
266  ❌    0                 client.BaseAddress = new Uri("https://cloudcode-pa.googleapis.com");
267  ❌    0             })
268  ✔    37             .AddPolicyHandler(GetRetryPolicy());
269              
270                      // Register infrastructure helpers
271  ✔    37             services.AddInfrastructureHelpers();
272              
273                      // 4. Register the Smart Router as the primary IChatClient (Scoped)
274                      // We manually build the pipeline to ensure it is registered as Scoped,
275                      // because SmartRoutingChatClient depends on Scoped services (IModelResolver, ICostService).
276  ✔    37             services.AddScoped<IChatClient>(sp =>
277  ✔    15             {
278  ✔    15                 var innerClient = ActivatorUtilities.CreateInstance<SmartRoutingChatClient>(sp);
279  ✔    37     
280  ✔    15                 var builder = new ChatClientBuilder(innerClient);
281  ✔    15                 builder.UseFunctionInvocation();
282  ✔    30                 builder.Use((inner, services) => new UsageTrackingChatClient(inner, services.GetRequiredService<ILogger<Usag
283  ✔    37     
284  ✔    15                 return builder.Build(sp);
285  ✔    52             });
286              
287  ✔    37             return services;
288  ✔    37         }
289              
290                  // Register infrastructure-level helpers
291                  private static IServiceCollection AddInfrastructureHelpers(this IServiceCollection services)
292  ✔    37         {
293  ✔    37             services.AddScoped<IChatClientFactory, ChatClientFactory>();
294  ✔    37             services.AddSingleton<IChatClientStrategy, OpenAiGenericStrategy>();
295  ✔    37             services.AddSingleton<IChatClientStrategy, CloudflareStrategy>();
296              
297                      // Register Models.dev client
298  ✔    37             services.AddHttpClient<IModelsDevClient, ModelsDevClient>(client =>
299  ✔    37             {
300  ✔    37                 client.BaseAddress = new Uri("https://models.dev");
301  ✔    74             });
302                      // Register OpenAI model discovery client
303  ✔    37             services.AddHttpClient<IOpenAiModelDiscoveryClient, OpenAiModelDiscoveryClient>();
304  ✔    37             return services;
305  ✔    37         }
306              
307                  private static IAsyncPolicy<HttpResponseMessage> GetRetryPolicy()
308  ✔    37         {
309  ✔    37             return HttpPolicyExtensions
310  ✔    37                 .HandleTransientHttpError()
311  ❌    0                 .OrResult(msg => msg.StatusCode == System.Net.HttpStatusCode.TooManyRequests)
312  ✔    37                 .WaitAndRetryAsync(3, retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)));
313  ✔    37         }
314              
315                  public static async Task InitializeDatabaseAsync(this Microsoft.Extensions.Hosting.IHost host)
316  ✔    37         {
317  ✔    37             using var scope = host.Services.CreateScope();
318  ✔    37             var services = scope.ServiceProvider;
319              
320                      try
321  ✔    37             {
322  ✔    37                 var configuration = services.GetRequiredService<IConfiguration>();
323                          // Default to true when the configuration key is missing
324  ✔    37                 var runMigrations = configuration.GetValue<bool>("Synaxis:ControlPlane:RunMigrations", true);
325  ✔    37  ●              if (!runMigrations)
326  ✔    34                 {
327  ✔    34                     var logger = services.GetRequiredService<ILogger<ControlPlaneDbContext>>();
328  ✔    34                     logger.LogWarning("Skipping database migration per configuration.");
329  ✔    34                     return;
330                          }
331              
332  ✔     3                 var context = services.GetRequiredService<ControlPlaneDbContext>();
333  ✔     3                 await context.Database.MigrateAsync();
334  ❌    0             }
335  ✔     3             catch (Exception ex)
336  ✔     3             {
337  ✔     3                 var logger = services.GetRequiredService<ILogger<ControlPlaneDbContext>>();
338  ✔     3                 logger.LogError(ex, "An error occurred while migrating the database.");
339  ✔     3                 throw;
340                      }
341  ✔    34         }
342              }
```
# Synaxis.InferenceGateway.Infrastructure.Extensions.NvidiaExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Extensions.NvidiaExtensions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/NvidiaExtensions.cs |
| **Line coverage:** | 100% (7 of 7) |
| Covered lines: | 7 |
| Uncovered lines: | 0 |
| Coverable lines: | 7 |
| Total lines: | 17 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddNvidiaClient(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/NvidiaExtensions.cs
```
 1            using Microsoft.Extensions.AI;
 2            using Microsoft.Extensions.DependencyInjection;
 3            
 4            namespace Synaxis.InferenceGateway.Infrastructure.Extensions;
 5            
 6            public static class NvidiaExtensions
 7            {
 8                public static IServiceCollection AddNvidiaClient(this IServiceCollection services, string serviceKey, string apiKey,
 9  ✔  37         {
10  ✔  37             services.AddKeyedSingleton<IChatClient>(serviceKey, (_, _) => new GenericOpenAiChatClient(
11  ✔  37                 apiKey,
12  ✔  37                 new Uri("https://integrate.api.nvidia.com/v1"),
13  ✔  37                 modelId));
14            
15  ✔  37             return services;
16  ✔  37         }
17            }
```
# Synaxis.InferenceGateway.Infrastructure.Extensions.OpenAiCompatibleExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Extensions.OpenAiCompatibleExtensions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/OpenAiCompatibleExtensions.cs |
| **Line coverage:** | 55.5% (5 of 9) |
| Covered lines: | 5 |
| Uncovered lines: | 4 |
| Coverable lines: | 9 |
| Total lines: | 28 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddOpenAiCompatibleClient(...)** | 0% | 2 | 2 | 55.55% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/OpenAiCompatibleExtensions.cs
```
 1             using System;
 2             using System.Collections.Generic;
 3             using System.Net.Http;
 4             using Microsoft.Extensions.AI;
 5             using Microsoft.Extensions.DependencyInjection;
 6             
 7             namespace Synaxis.InferenceGateway.Infrastructure.Extensions;
 8             
 9             public static class OpenAiCompatibleExtensions
10             {
11                 public static IServiceCollection AddOpenAiCompatibleClient(
12                     this IServiceCollection services,
13                     string key,
14                     string baseUrl,
15                     string apiKey,
16                     string? modelId = null,
17                     Dictionary<string, string>? customHeaders = null)
18  ✔  259         {
19  ✔  259             services.AddKeyedSingleton<IChatClient>(key, (sp, obj) =>
20  ❌   0             {
21  ❌   0                 var httpClientFactory = sp.GetRequiredService<IHttpClientFactory>();
22  ❌   0                 var httpClient = httpClientFactory.CreateClient(key);
23  ❌   0  ○              return new GenericOpenAiChatClient(apiKey, new Uri(baseUrl), modelId ?? "default", customHeaders, httpClient
24  ✔  259             });
25             
26  ✔  259             return services;
27  ✔  259         }
28             }
```
# Synaxis.InferenceGateway.Infrastructure.Extensions.OpenRouterExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Extensions.OpenRouterExtensions |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/OpenRouterExtensions.cs |
| **Line coverage:** | 100% (11 of 11) |
| Covered lines: | 11 |
| Uncovered lines: | 0 |
| Coverable lines: | 11 |
| Total lines: | 22 |
| **Branch coverage:** | 50% (2 of 4) |
| Covered branches: | 2 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddOpenRouterClient(...)** | 50.0% | 4 | 4 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Extensions/OpenRouterExtensions.cs
```
 1            using Microsoft.Extensions.AI;
 2            using Microsoft.Extensions.DependencyInjection;
 3            
 4            namespace Synaxis.InferenceGateway.Infrastructure.Extensions;
 5            
 6            public static class OpenRouterExtensions
 7            {
 8                public static IServiceCollection AddOpenRouterClient(this IServiceCollection services, string serviceKey, string api
 9  ✔  37         {
10  ✔  37             var headers = new Dictionary<string, string>();
11  ✓  37  ◑          if (!string.IsNullOrEmpty(siteUrl)) headers.Add("HTTP-Referer", siteUrl);
12  ✓  37  ◑          if (!string.IsNullOrEmpty(siteName)) headers.Add("X-Title", siteName);
13            
14  ✔  37             services.AddKeyedSingleton<IChatClient>(serviceKey, (_, _) => new GenericOpenAiChatClient(
15  ✔  37                 apiKey,
16  ✔  37                 new Uri("https://openrouter.ai/api/v1/"),
17  ✔  37                 modelId,
18  ✔  37                 headers));
19            
20  ✔  37             return services;
21  ✔  37         }
22            }
```
# Synaxis.InferenceGateway.Infrastructure.External.AiHorde.AiHordeChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.AiHorde.AiHordeChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/AiHorde/AiHordeChatClient.cs |
| **Line coverage:** | 91.3% (74 of 81) |
| Covered lines: | 74 |
| Uncovered lines: | 7 |
| Coverable lines: | 81 |
| Total lines: | 129 |
| **Branch coverage:** | 62.5% (20 of 32) |
| Covered branches: | 20 |
| Total branches: | 32 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **get_Metadata()** | 100% | 2 | 1 | 0% |
| **GetResponseAsync()** | 62.50% | 16 | 16 | 93.33% |
| **GetStreamingResponseAsync()** | 58.33% | 12 | 12 | 93.75% |
| **BuildPrompt(...)** | 100% | 2 | 2 | 100% |
| **Dispose()** | 100% | 2 | 1 | 0% |
| **GetService(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Done()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/AiHorde/AiHordeChatClient.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.Net.Http;
  4            using System.Net.Http.Json;
  5            using System.Runtime.CompilerServices;
  6            using System.Text.Json;
  7            using System.Text.Json.Serialization;
  8            using System.Threading;
  9            using System.Threading.Tasks;
 10            using Microsoft.Extensions.AI;
 11            
 12            namespace Synaxis.InferenceGateway.Infrastructure.External.AiHorde;
 13            
 14            public class AiHordeChatClient : IChatClient
 15            {
 16                private readonly HttpClient _httpClient;
 17                private readonly ChatClientMetadata _metadata;
 18                private readonly string _apiKey;
 19            
 20                private const string GenerateUrl = "https://stablehorde.net/api/v2/generate/text/async";
 21                private const string StatusUrlTemplate = "https://stablehorde.net/api/v2/generate/text/status/{0}";
 22            
 23  ✔   2         public AiHordeChatClient(HttpClient? httpClient = null, string apiKey = "0000000000")
 24  ✔   2         {
 25  ✓   2  ◑          _httpClient = httpClient ?? new HttpClient();
 26  ✔   2             _apiKey = apiKey;
 27  ✔   2             _metadata = new ChatClientMetadata("AiHorde", new Uri(GenerateUrl), "aihorde");
 28  ✔   2         }
 29            
 30  ❌  0         public ChatClientMetadata Metadata => _metadata;
 31            
 32                public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 33  ✔   1         {
 34  ✔   1             var prompt = BuildPrompt(chatMessages);
 35            
 36  ✔   1             var request = new { prompt = prompt, models = new[] { "stable" } };
 37            
 38  ✔   1  ●          using var httpRequest = new HttpRequestMessage(HttpMethod.Post, GenerateUrl);
 39  ✔   1             httpRequest.Headers.TryAddWithoutValidation("apikey", _apiKey);
 40  ✔   1             httpRequest.Content = JsonContent.Create(request);
 41            
 42  ✔   1             using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 43  ✔   1             response.EnsureSuccessStatusCode();
 44            
 45  ✔   1             var genResp = await response.Content.ReadFromJsonAsync<GenerateResponse>(cancellationToken: cancellationToken);
 46  ✓   1  ◑          if (genResp == null || string.IsNullOrEmpty(genResp.Id))
 47  ❌  0                 return new ChatResponse(new List<ChatMessage>());
 48            
 49  ✔   1             var id = genResp.Id;
 50            
 51                    // Poll status until done
 52  ✓   2  ◑          while (!cancellationToken.IsCancellationRequested)
 53  ✔   2             {
 54  ✔   2                 await Task.Delay(200, cancellationToken);
 55  ✔   2                 using var statusReq = new HttpRequestMessage(HttpMethod.Get, string.Format(StatusUrlTemplate, id));
 56  ✔   2                 statusReq.Headers.TryAddWithoutValidation("apikey", _apiKey);
 57  ✔   2                 using var statusResp = await _httpClient.SendAsync(statusReq, cancellationToken);
 58  ✔   2                 statusResp.EnsureSuccessStatusCode();
 59            
 60  ✔   2                 var status = await statusResp.Content.ReadFromJsonAsync<StatusResponse>(cancellationToken: cancellationToken
 61  ✓   2  ◑              if (status == null) break;
 62  ✔   2  ●              if (status.Done)
 63  ✔   1                 {
 64  ✓   1  ◑                  var text = status?.Text ?? string.Empty;
 65  ✔   1                     var chatResponse = new ChatResponse(new ChatMessage(ChatRole.Assistant, text));
 66  ✔   1                     chatResponse.ResponseId = id;
 67  ✔   1                     return chatResponse;
 68                        }
 69  ✔   1             }
 70            
 71  ❌  0             return new ChatResponse(new List<ChatMessage>());
 72  ✔   1         }
 73            
 74                public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> chatMessages, C
 75  ✔   1         {
 76                    // We'll implement polling and yield final result when ready
 77  ✔   1             var prompt = BuildPrompt(chatMessages);
 78  ✔   1             var request = new { prompt = prompt, models = new[] { "stable" } };
 79            
 80  ✔   1             using var httpRequest = new HttpRequestMessage(HttpMethod.Post, GenerateUrl);
 81  ✔   1             httpRequest.Headers.TryAddWithoutValidation("apikey", _apiKey);
 82  ✔   1             httpRequest.Content = JsonContent.Create(request);
 83            
 84  ✔   1             using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 85  ✔   1             response.EnsureSuccessStatusCode();
 86  ✔   1             var genResp = await response.Content.ReadFromJsonAsync<GenerateResponse>(cancellationToken: cancellationToken);
 87  ✓   1  ◑          if (genResp == null || string.IsNullOrEmpty(genResp.Id)) yield break;
 88            
 89  ✔   1             var id = genResp.Id;
 90            
 91  ✓   1  ◑          while (!cancellationToken.IsCancellationRequested)
 92  ✔   1             {
 93  ✔   1                 await Task.Delay(200, cancellationToken);
 94  ✔   1                 using var statusReq = new HttpRequestMessage(HttpMethod.Get, string.Format(StatusUrlTemplate, id));
 95  ✔   1                 statusReq.Headers.TryAddWithoutValidation("apikey", _apiKey);
 96  ✔   1                 using var statusResp = await _httpClient.SendAsync(statusReq, cancellationToken);
 97  ✔   1                 statusResp.EnsureSuccessStatusCode();
 98  ✔   1                 var status = await statusResp.Content.ReadFromJsonAsync<StatusResponse>(cancellationToken: cancellationToken
 99  ✓   1  ◑              if (status == null) yield break;
100  ✔   1  ●              if (status.Done)
101  ✔   1                 {
102  ✓   1  ◑                  var text = status.Text ?? string.Empty;
103  ✔   1                     var update = new ChatResponseUpdate
104  ✔   1                     {
105  ✔   1                         Role = ChatRole.Assistant,
106  ✔   1                     };
107  ✔   1                     update.Contents.Add(new TextContent(text));
108  ✔   1                     yield return update;
109  ❌  0                     yield break;
110                        }
111  ❌  0             }
112  ✔   1         }
113            
114                private string BuildPrompt(IEnumerable<ChatMessage> messages)
115  ✔   2         {
116  ✔   2             var parts = new List<string>();
117  ✔  10  ●          foreach (var m in messages)
118  ✔   2             {
119  ✔   2                 parts.Add($"[{m.Role.Value}] {m.Text}");
120  ✔   2             }
121  ✔   2             return string.Join("\n", parts);
122  ✔   2         }
123            
124  ❌  0         public void Dispose() { }
125  ❌  0         public object? GetService(Type serviceType, object? serviceKey = null) => null;
126            
127  ✔   6         private class GenerateResponse { [JsonPropertyName("id")] public string? Id { get; set; } }
128  ✔  10         private class StatusResponse { [JsonPropertyName("done")] public bool Done { get; set; } [JsonPropertyName("text")] 
129            }
```
# Synaxis.InferenceGateway.Infrastructure.External.DuckDuckGo.DuckDuckGoChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.DuckDuckGo.DuckDuckGoChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/DuckDuckGo/DuckDuckGoChatClient.cs |
| **Line coverage:** | 66.6% (54 of 81) |
| Covered lines: | 54 |
| Uncovered lines: | 27 |
| Coverable lines: | 81 |
| Total lines: | 138 |
| **Branch coverage:** | 43.7% (14 of 32) |
| Covered branches: | 14 |
| Total branches: | 32 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Metadata()** | 100% | 2 | 1 | 0% |
| **GetResponseAsync()** | 50.0% | 29 | 20 | 71.42% |
| **GetStreamingResponseAsync(...)** | 100% | 2 | 1 | 0% |
| **ReturnSingleAsync()** | 0% | 42 | 6 | 0% |
| **CreateRequest(...)** | 50.0% | 2 | 2 | 100% |
| **EnsureTokenAsync()** | 75.00% | 4 | 4 | 100% |
| **Dispose()** | 100% | 2 | 1 | 0% |
| **GetService(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/DuckDuckGo/DuckDuckGoChatClient.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Linq;
  4           using System.Net.Http;
  5           using System.Net.Http.Json;
  6           using System.Runtime.CompilerServices;
  7           using System.Text.Json;
  8           using System.Text.Json.Serialization;
  9           using System.Threading;
 10           using System.Threading.Tasks;
 11           using Microsoft.Extensions.AI;
 12           
 13           namespace Synaxis.InferenceGateway.Infrastructure.External.DuckDuckGo;
 14           
 15           public class DuckDuckGoChatClient : IChatClient
 16           {
 17               private readonly HttpClient _httpClient;
 18               private readonly string _modelId;
 19               private readonly ChatClientMetadata _metadata;
 20               private string? _vqdToken;
 21           
 22  ✔  1         private static readonly string[] SupportedModels = new[] { "gpt-4o-mini", "claude-3-haiku", "llama-3.1-70b", "o3-min
 23           
 24  ✔  2         public DuckDuckGoChatClient(HttpClient httpClient, string modelId)
 25  ✔  2         {
 26  ✔  2             _httpClient = httpClient;
 27  ✔  2             _modelId = modelId;
 28  ✔  2             _metadata = new ChatClientMetadata("DuckDuckGo", new Uri("https://duckduckgo.com/"), modelId);
 29  ✔  2         }
 30           
 31  ❌ 0         public ChatClientMetadata Metadata => _metadata;
 32           
 33               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 34  ✔  2  ●      {
 35                   // Ensure we have a fresh token
 36  ✔  2             await EnsureTokenAsync(cancellationToken);
 37           
 38  ✔  2             var requestObj = CreateRequest(chatMessages);
 39           
 40  ✔  2             using var httpRequest = new HttpRequestMessage(HttpMethod.Post, "https://duckduckgo.com/duckchat/v1/chat")
 41  ✔  2             {
 42  ✔  2                 Content = JsonContent.Create(requestObj, options: new JsonSerializerOptions { PropertyNamingPolicy = JsonNam
 43  ✔  2             };
 44           
 45  ✔  2  ●          if (!string.IsNullOrEmpty(_vqdToken))
 46  ✔  1             {
 47  ✔  1                 httpRequest.Headers.TryAddWithoutValidation("x-vqd-4", _vqdToken);
 48  ✔  1             }
 49  ✔  2             httpRequest.Headers.TryAddWithoutValidation("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit
 50           
 51  ✔  2             using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 52           
 53                   // Update token from response headers for next call
 54  ✔  2  ●          if (response.Headers.TryGetValues("x-vqd-4", out var vals))
 55  ✔  1             {
 56  ✔  1                 _vqdToken = vals.FirstOrDefault();
 57  ✔  1             }
 58           
 59  ✔  2  ●          if (!response.IsSuccessStatusCode)
 60  ✔  1             {
 61                       // Per user preference, return an empty response instead of throwing
 62  ✔  1                 return new ChatResponse(new List<ChatMessage>());
 63                   }
 64           
 65  ✔  1             var json = await response.Content.ReadAsStringAsync(cancellationToken);
 66           
 67                   // Attempt to parse simple response schema { reply: "..." } or { message: "..." }
 68  ✔  1             string? reply = null;
 69                   try
 70  ✔  1             {
 71  ✔  1                 using var doc = JsonDocument.Parse(json);
 72  ✓  2  ◑              if (doc.RootElement.TryGetProperty("reply", out var r)) reply = r.GetString();
 73  ❌ 0  ○              else if (doc.RootElement.TryGetProperty("message", out var m)) reply = m.GetString();
 74  ❌ 0  ○              else if (doc.RootElement.ValueKind == JsonValueKind.String) reply = doc.RootElement.GetString();
 75                       else
 76  ❌ 0                 {
 77                           // fallback: attempt to find first string value
 78  ❌ 0  ○                  foreach (var prop in doc.RootElement.EnumerateObject())
 79  ❌ 0                     {
 80  ❌ 0  ○                      if (prop.Value.ValueKind == JsonValueKind.String)
 81  ❌ 0                         {
 82  ❌ 0                             reply = prop.Value.GetString();
 83  ❌ 0                             break;
 84                               }
 85  ❌ 0                     }
 86  ❌ 0                 }
 87  ✔  1             }
 88  ❌ 0             catch { reply = null; }
 89           
 90  ✓  1  ◑          var chatResponse = new ChatResponse(new ChatMessage(ChatRole.Assistant, reply ?? string.Empty));
 91  ✔  1             chatResponse.ModelId = _modelId;
 92  ✔  1             return chatResponse;
 93  ✔  2         }
 94           
 95               public IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOpt
 96  ❌ 0         {
 97                   // DuckDuckGo streaming is not implemented; provide a simple single-message wrapper as async enumerable
 98  ❌ 0             return ReturnSingleAsync(chatMessages, options, cancellationToken);
 99  ❌ 0         }
100           
101               private async IAsyncEnumerable<ChatResponseUpdate> ReturnSingleAsync(IEnumerable<ChatMessage> chatMessages, ChatOpti
102  ❌ 0         {
103  ❌ 0             var resp = await GetResponseAsync(chatMessages, options, cancellationToken);
104  ❌ 0  ○          if (resp != null)
105  ❌ 0             {
106  ❌ 0                 var update = new ChatResponseUpdate { Role = ChatRole.Assistant, ModelId = _modelId };
107  ❌ 0  ○              update.Contents.Add(new TextContent(resp.Messages.FirstOrDefault()?.Text ?? string.Empty));
108  ❌ 0                 yield return update;
109  ❌ 0             }
110  ❌ 0         }
111           
112               private object CreateRequest(IEnumerable<ChatMessage> chatMessages)
113  ✔  2         {
114  ✔  4             var messages = chatMessages.Select(m => new
115  ✔  4             {
116  ✔  4                 role = m.Role.Value,
117  ✔  4                 content = m.Text
118  ✔  4             }).ToList();
119           
120  ✓  2  ◑          var model = SupportedModels.Contains(_modelId) ? _modelId : _modelId;
121           
122  ✔  2             return new { model = model, messages = messages };
123  ✔  2         }
124           
125               private async Task EnsureTokenAsync(CancellationToken cancellationToken)
126  ✔  2         {
127  ✓  2  ◑          if (!string.IsNullOrEmpty(_vqdToken)) return;
128           
129  ✔  2             using var response = await _httpClient.GetAsync("https://duckduckgo.com/duckchat/v1/status", cancellationToken);
130  ✔  2  ●          if (response.Headers.TryGetValues("x-vqd-4", out var vals))
131  ✔  1             {
132  ✔  1                 _vqdToken = vals.FirstOrDefault();
133  ✔  1             }
134  ✔  2         }
135           
136  ❌ 0         public void Dispose() => _httpClient.Dispose();
137  ❌ 0         public object? GetService(Type serviceType, object? serviceKey = null) => null;
138           }
```
# Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotClientAdapter

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotClientAdapter |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/CopilotClientAdapter.cs |
| **Line coverage:** | 0% (0 of 8) |
| Covered lines: | 0 |
| Uncovered lines: | 8 |
| Coverable lines: | 8 |
| Total lines: | 39 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **get_State()** | 100% | 2 | 1 | 0% |
| **StartAsync(...)** | 100% | 2 | 1 | 0% |
| **CreateSessionAsync()** | 100% | 2 | 1 | 0% |
| **DisposeAsync()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/CopilotClientAdapter.cs
```
 1           using System;
 2           using System.Threading;
 3           using System.Threading.Tasks;
 4           using GitHub.Copilot.SDK;
 5           
 6           namespace Synaxis.InferenceGateway.Infrastructure.External.GitHub
 7           {
 8               internal class CopilotSessionAdapter : ICopilotSession
 9               {
10                   private readonly CopilotSession _inner;
11           
12                   public CopilotSessionAdapter(CopilotSession inner) => _inner = inner ?? throw new ArgumentNullException(nameof(i
13           
14                   public IDisposable On(SessionEventHandler handler) => _inner.On(handler);
15           
16                   public Task SendAsync(MessageOptions options, CancellationToken cancellationToken = default) => _inner.SendAsync
17           
18                   public ValueTask DisposeAsync() => _inner.DisposeAsync();
19               }
20           
21               internal class CopilotClientAdapter : ICopilotClient
22               {
23                   private readonly CopilotClient _inner;
24           
25  ❌ 0  ○          public CopilotClientAdapter(CopilotClient inner) => _inner = inner ?? throw new ArgumentNullException(nameof(inn
26           
27  ❌ 0             public ConnectionState State => _inner.State;
28           
29  ❌ 0             public Task StartAsync(CancellationToken cancellationToken = default) => _inner.StartAsync(cancellationToken);
30           
31                   public async Task<ICopilotSession> CreateSessionAsync(SessionConfig config, CancellationToken cancellationToken 
32  ❌ 0             {
33  ❌ 0                 var s = await _inner.CreateSessionAsync(config, cancellationToken).ConfigureAwait(false);
34  ❌ 0                 return new CopilotSessionAdapter(s);
35  ❌ 0             }
36           
37  ❌ 0             public ValueTask DisposeAsync() => _inner.DisposeAsync();
38               }
39           }
```
# Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkAdapter

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkAdapter |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/CopilotSdkAdapter.cs |
| **Line coverage:** | 0% (0 of 127) |
| Covered lines: | 0 |
| Uncovered lines: | 127 |
| Coverable lines: | 127 |
| Total lines: | 206 |
| **Branch coverage:** | 0% (0 of 60) |
| Covered branches: | 0 |
| Total branches: | 60 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 42 | 6 | 0% |
| **get_Metadata()** | 100% | 2 | 1 | 0% |
| **EnsureStartedAsync()** | 0% | 110 | 10 | 0% |
| **GetResponseAsync()** | 0% | 272 | 16 | 0% |
| **GetStreamingResponseAsync()** | 0% | 342 | 18 | 0% |
| **GetService(...)** | 0% | 42 | 6 | 0% |
| **Dispose()** | 0% | 42 | 6 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/CopilotSdkAdapter.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Linq;
  4           using System.Reflection;
  5           using System.Threading;
  6           using System.Threading.Tasks;
  7           using Microsoft.Extensions.AI;
  8           using Microsoft.Extensions.Logging;
  9           
 10           namespace Synaxis.InferenceGateway.Infrastructure.External.GitHub;
 11           
 12           /// <summary>
 13           /// Minimal concrete adapter for the GitHub Copilot SDK.
 14           /// The implementation attempts to start the CopilotClient lazily and exposes
 15           /// a small, test-friendly surface required by CopilotSdkClient.
 16           ///
 17           /// Note: The SDK surface varies across versions; to remain resilient we use
 18           /// light-weight reflection for optional calls but still expose the underlying
 19           /// CopilotClient via GetService so callers can use advanced features when
 20           /// available.
 21           /// </summary>
 22           public class CopilotSdkAdapter : ICopilotSdkAdapter
 23           {
 24               private readonly object _client;
 25               private readonly ILogger<CopilotSdkAdapter>? _logger;
 26  ❌ 0         private readonly SemaphoreSlim _startLock = new(1, 1);
 27               private bool _started;
 28  ❌ 0         private readonly ChatClientMetadata _metadata = new ChatClientMetadata("GitHubCopilot", new Uri("https://copilot.git
 29  ❌ 0         private readonly string _modelId = "copilot";
 30           
 31  ❌ 0         public CopilotSdkAdapter(ILogger<CopilotSdkAdapter>? logger = null)
 32  ❌ 0         {
 33  ❌ 0             _logger = logger;
 34                   // Construct the SDK client via reflection to avoid hard compile-time dependency
 35                   // Authentication is expected to be provided by the environment/CLI.
 36  ❌ 0             object? client = null;
 37                   try
 38  ❌ 0             {
 39  ❌ 0                 var sdkType = Type.GetType("GitHub.Copilot.Sdk.CopilotClient, GitHub.Copilot.Sdk");
 40  ❌ 0  ○              if (sdkType != null)
 41  ❌ 0                 {
 42  ❌ 0                     client = Activator.CreateInstance(sdkType);
 43  ❌ 0                 }
 44  ❌ 0             }
 45  ❌ 0             catch (Exception ex)
 46  ❌ 0             {
 47  ❌ 0  ○              _logger?.LogDebug(ex, "Failed to create CopilotClient via reflection");
 48  ❌ 0             }
 49  ❌ 0  ○          _client = client ?? new object();
 50  ❌ 0         }
 51           
 52  ❌ 0         public ChatClientMetadata Metadata => _metadata;
 53           
 54               private async Task EnsureStartedAsync()
 55  ❌ 0         {
 56  ❌ 0  ○          if (_started) return;
 57  ❌ 0             await _startLock.WaitAsync().ConfigureAwait(false);
 58                   try
 59  ❌ 0             {
 60  ❌ 0  ○              if (_started) return;
 61                       // Call StartAsync if available on the SDK client.
 62  ❌ 0                 var startMethod = _client.GetType().GetMethod("StartAsync", BindingFlags.Public | BindingFlags.Instance);
 63  ❌ 0  ○              if (startMethod != null)
 64  ❌ 0                 {
 65                           try
 66  ❌ 0                     {
 67  ❌ 0                         var t = startMethod.Invoke(_client, null) as Task;
 68  ❌ 0  ○                      if (t != null) await t.ConfigureAwait(false);
 69  ❌ 0                     }
 70  ❌ 0                     catch (Exception ex)
 71  ❌ 0                     {
 72  ❌ 0  ○                      _logger?.LogWarning(ex, "Copilot StartAsync failed");
 73  ❌ 0                     }
 74  ❌ 0                 }
 75           
 76  ❌ 0                 _started = true;
 77  ❌ 0             }
 78                   finally
 79  ❌ 0             {
 80  ❌ 0                 _startLock.Release();
 81  ❌ 0             }
 82  ❌ 0         }
 83           
 84               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> messages, ChatOptions? options = null, Can
 85  ❌ 0         {
 86  ❌ 0             await EnsureStartedAsync().ConfigureAwait(false);
 87           
 88                   // Best-effort: try to find an SDK chat/send API, otherwise fall back
 89                   // to a lightweight echo response so the application remains usable
 90                   // in environments where the local copilot agent is not present.
 91                   try
 92  ❌ 0             {
 93                       // Attempt to build a simple prompt from incoming messages
 94  ❌ 0                 var combined = string.Join("\n", messages.Select(m => $"[{m.Role.Value}] {m.Text}"));
 95           
 96                       // If the SDK exposes a simple "CreateSessionAsync" + "GetResponseAsync"
 97                       // pattern we could call into it. For now attempt to call a method
 98                       // named "GetResponseAsync" on the client directly that accepts a
 99                       // single string. This keeps the adapter functional if the method
100                       // exists while avoiding hard compile-time coupling.
101  ❌ 0                 var getRespMethod = _client.GetType().GetMethod("GetResponseAsync", BindingFlags.Public | BindingFlags.Insta
102  ❌ 0  ○              if (getRespMethod != null)
103  ❌ 0                 {
104  ❌ 0                     var parameters = getRespMethod.GetParameters();
105  ❌ 0                     object? result = null;
106  ❌ 0  ○                  if (parameters.Length == 1 && parameters[0].ParameterType == typeof(string))
107  ❌ 0                     {
108  ❌ 0                         var task = getRespMethod.Invoke(_client, new object[] { combined }) as Task<object>;
109  ❌ 0  ○                      if (task != null)
110  ❌ 0                         {
111  ❌ 0                             result = await task.ConfigureAwait(false);
112  ❌ 0                         }
113  ❌ 0                     }
114           
115                           // If we got a result and it has a ToString, return that as assistant text
116  ❌ 0  ○                  if (result != null)
117  ❌ 0                     {
118  ❌ 0  ○                      var text = result.ToString() ?? string.Empty;
119  ❌ 0                         var resp = new ChatResponse(new ChatMessage(ChatRole.Assistant, text));
120  ❌ 0                         resp.ModelId = _modelId;
121  ❌ 0                         return resp;
122                           }
123  ❌ 0                 }
124  ❌ 0             }
125  ❌ 0             catch
126  ❌ 0             {
127                       // Swallow - we'll fallback to a safe response below
128  ❌ 0             }
129           
130                   // Fallback behavior: return a simple assistant response indicating
131                   // Copilot is not available in the current environment.
132  ❌ 0             var lastUser = messages.LastOrDefault(m => m.Role == ChatRole.User) ?? new ChatMessage(ChatRole.Assistant, strin
133  ❌ 0  ○          var fallback = new ChatResponse(new ChatMessage(ChatRole.Assistant, lastUser.Text ?? string.Empty));
134                   // ChatClientMetadata does not expose ModelId; set on response instead
135  ❌ 0             fallback.ModelId = _modelId;
136  ❌ 0             return fallback;
137  ❌ 0         }
138           
139               public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> messages, ChatO
140  ❌ 0         {
141  ❌ 0             await EnsureStartedAsync().ConfigureAwait(false);
142           
143                   // Try to use a streaming SDK API if available. We'll invoke via reflection
144                   // and enumerate the returned IEnumerable outside of the try/catch to avoid
145                   // yielding from inside a try block with a catch (which is not allowed).
146  ❌ 0             object? invoked = null;
147                   try
148  ❌ 0             {
149  ❌ 0                 var streamMethod = _client.GetType().GetMethod("GetStreamingResponseAsync", BindingFlags.Public | BindingFla
150  ❌ 0  ○              if (streamMethod != null)
151  ❌ 0                 {
152  ❌ 0                     invoked = streamMethod.Invoke(_client, new object[] { messages });
153  ❌ 0                 }
154  ❌ 0             }
155  ❌ 0             catch (Exception ex)
156  ❌ 0             {
157  ❌ 0  ○              _logger?.LogDebug(ex, "Streaming invocation failed");
158  ❌ 0             }
159           
160  ❌ 0  ○          if (invoked is System.Collections.IEnumerable enumerable2)
161  ❌ 0             {
162  ❌ 0  ○              foreach (var item in enumerable2)
163  ❌ 0                 {
164  ❌ 0  ○                  if (cancellationToken.IsCancellationRequested) yield break;
165  ❌ 0                     var update = new ChatResponseUpdate { Role = ChatRole.Assistant };
166  ❌ 0  ○                  update.Contents.Add(new TextContent(item?.ToString() ?? string.Empty));
167  ❌ 0                     yield return update;
168  ❌ 0                 }
169  ❌ 0                 yield break;
170                   }
171           
172                   // Non-streaming fallback: yield a single update with the fully computed response
173  ❌ 0             var final = await GetResponseAsync(messages, options, cancellationToken).ConfigureAwait(false);
174  ❌ 0             var u = new ChatResponseUpdate { Role = ChatRole.Assistant };
175  ❌ 0  ○          u.Contents.Add(new TextContent(final.Messages.FirstOrDefault()?.Text ?? string.Empty));
176  ❌ 0             yield return u;
177  ❌ 0         }
178           
179               public object? GetService(Type serviceType, object? serviceKey = null)
180  ❌ 0         {
181  ❌ 0  ○          if (_client != null)
182  ❌ 0             {
183  ❌ 0                 var sdkType = Type.GetType("GitHub.Copilot.Sdk.CopilotClient, GitHub.Copilot.Sdk");
184  ❌ 0  ○              if (sdkType != null && serviceType == sdkType) return _client;
185  ❌ 0             }
186  ❌ 0             return null;
187  ❌ 0         }
188           
189               public void Dispose()
190  ❌ 0         {
191                   try
192  ❌ 0             {
193                       // Call Dispose or DisposeAsync if available
194  ❌ 0                 var dispose = _client.GetType().GetMethod("Dispose", BindingFlags.Public | BindingFlags.Instance);
195  ❌ 0  ○              if (dispose != null) dispose.Invoke(_client, null);
196           
197  ❌ 0                 var disposeAsync = _client.GetType().GetMethod("DisposeAsync", BindingFlags.Public | BindingFlags.Instance);
198  ❌ 0  ○              if (disposeAsync != null)
199  ❌ 0                 {
200  ❌ 0                     var task = disposeAsync.Invoke(_client, null) as Task;
201  ❌ 0  ○                  task?.GetAwaiter().GetResult();
202  ❌ 0                 }
203  ❌ 0             }
204  ❌ 0             catch { }
205  ❌ 0         }
206           }
```
# Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSdkClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/CopilotSdkClient.cs |
| **Line coverage:** | 76.4% (13 of 17) |
| Covered lines: | 13 |
| Uncovered lines: | 4 |
| Coverable lines: | 17 |
| Total lines: | 62 |
| **Branch coverage:** | 25% (1 of 4) |
| Covered branches: | 1 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **get_Metadata()** | 0% | 6 | 2 | 0% |
| **GetResponseAsync(...)** | 100% | 1 | 1 | 100% |
| **GetStreamingResponseAsync(...)** | 100% | 1 | 1 | 100% |
| **GetService(...)** | 100% | 2 | 1 | 0% |
| **Dispose()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/CopilotSdkClient.cs
```
 1           using System;
 2           using System.Collections.Generic;
 3           using System.Threading;
 4           using System.Threading.Tasks;
 5           using Microsoft.Extensions.AI;
 6           
 7           namespace Synaxis.InferenceGateway.Infrastructure.External.GitHub;
 8           
 9           /// <summary>
10           /// Adapter interface used by CopilotSdkClient to allow easy testing and to separate the
11           /// concrete GitHub.Copilot.SDK usage. A real implementation should wrap the SDK and
12           /// translate messages to/from its types.
13           /// </summary>
14           public interface ICopilotSdkAdapter : IDisposable
15           {
16               ChatClientMetadata Metadata { get; }
17               Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> messages, ChatOptions? options = null, CancellationToke
18               IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> messages, ChatOptions? optio
19               object? GetService(Type serviceType, object? serviceKey = null);
20           }
21           
22           /// <summary>
23           /// IChatClient implementation backed by a GitHub Copilot local SDK adapter.
24           /// The concrete SDK wiring should be provided via an ICopilotSdkAdapter instance.
25           /// This keeps the production wiring (which may require a running local agent process)
26           /// out of the tests and allows graceful lifecycle management.
27           /// </summary>
28           public class CopilotSdkClient : IChatClient
29           {
30               private readonly ICopilotSdkAdapter _adapter;
31           
32  ✔  3         public CopilotSdkClient(ICopilotSdkAdapter adapter)
33  ✔  3         {
34  ✓  3  ◑          _adapter = adapter ?? throw new ArgumentNullException(nameof(adapter));
35  ✔  3         }
36           
37               // Note: For scenarios where the SDK is available at runtime a factory/wrapper can be
38               // written to produce an ICopilotSdkAdapter that talks to GitHub.Copilot.SDK. That factory
39               // is intentionally not included here to keep the client lightweight and testable.
40           
41  ❌ 0  ○      public ChatClientMetadata Metadata => _adapter.Metadata ?? new ChatClientMetadata("Copilot");
42           
43               public Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null, Cance
44  ✔  1         {
45  ✔  1             return _adapter.GetResponseAsync(chatMessages, options, cancellationToken);
46  ✔  1         }
47           
48               public IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOpt
49  ✔  1         {
50  ✔  1             return _adapter.GetStreamingResponseAsync(chatMessages, options, cancellationToken);
51  ✔  1         }
52           
53               public object? GetService(Type serviceType, object? serviceKey = null)
54  ❌ 0         {
55  ❌ 0             return _adapter.GetService(serviceType, serviceKey);
56  ❌ 0         }
57           
58               public void Dispose()
59  ✔  1         {
60  ✔  1             _adapter.Dispose();
61  ✔  1         }
62           }
```
# Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSessionAdapter

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.GitHub.CopilotSessionAdapter |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/CopilotClientAdapter.cs |
| **Line coverage:** | 0% (0 of 4) |
| Covered lines: | 0 |
| Uncovered lines: | 4 |
| Coverable lines: | 4 |
| Total lines: | 39 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **On(...)** | 100% | 2 | 1 | 0% |
| **SendAsync(...)** | 100% | 2 | 1 | 0% |
| **DisposeAsync()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/CopilotClientAdapter.cs
```
 1           using System;
 2           using System.Threading;
 3           using System.Threading.Tasks;
 4           using GitHub.Copilot.SDK;
 5           
 6           namespace Synaxis.InferenceGateway.Infrastructure.External.GitHub
 7           {
 8               internal class CopilotSessionAdapter : ICopilotSession
 9               {
10                   private readonly CopilotSession _inner;
11           
12  ❌ 0  ○          public CopilotSessionAdapter(CopilotSession inner) => _inner = inner ?? throw new ArgumentNullException(nameof(i
13           
14  ❌ 0             public IDisposable On(SessionEventHandler handler) => _inner.On(handler);
15           
16  ❌ 0             public Task SendAsync(MessageOptions options, CancellationToken cancellationToken = default) => _inner.SendAsync
17           
18  ❌ 0             public ValueTask DisposeAsync() => _inner.DisposeAsync();
19               }
20           
21               internal class CopilotClientAdapter : ICopilotClient
22               {
23                   private readonly CopilotClient _inner;
24           
25                   public CopilotClientAdapter(CopilotClient inner) => _inner = inner ?? throw new ArgumentNullException(nameof(inn
26           
27                   public ConnectionState State => _inner.State;
28           
29                   public Task StartAsync(CancellationToken cancellationToken = default) => _inner.StartAsync(cancellationToken);
30           
31                   public async Task<ICopilotSession> CreateSessionAsync(SessionConfig config, CancellationToken cancellationToken 
32                   {
33                       var s = await _inner.CreateSessionAsync(config, cancellationToken).ConfigureAwait(false);
34                       return new CopilotSessionAdapter(s);
35                   }
36           
37                   public ValueTask DisposeAsync() => _inner.DisposeAsync();
38               }
39           }
```
# Synaxis.InferenceGateway.Infrastructure.External.GitHub.GitHubCopilotChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.GitHub.GitHubCopilotChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/GitHubCopilotChatClient.cs |
| **Line coverage:** | 82.3% (84 of 102) |
| Covered lines: | 84 |
| Uncovered lines: | 18 |
| Coverable lines: | 102 |
| Total lines: | 147 |
| **Branch coverage:** | 46.7% (29 of 62) |
| Covered branches: | 29 |
| Total branches: | 62 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **get_Metadata()** | 100% | 2 | 1 | 0% |
| **GetResponseAsync()** | 80.0% | 10 | 10 | 100% |
| **GetStreamingResponseAsync()** | 60.0% | 10 | 10 | 89.74% |
| **ToUpdate(...)** | 50.0% | 2 | 2 | 100% |
| **GetService(...)** | 0% | 6 | 2 | 0% |
| **Dispose()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/GitHub/GitHubCopilotChatClient.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.Linq;
  4            using System.Threading;
  5            using System.Threading.Channels;
  6            using System.Threading.Tasks;
  7            using GitHub.Copilot.SDK;
  8            using Microsoft.Extensions.AI;
  9            using Microsoft.Extensions.Logging;
 10            
 11            namespace Synaxis.InferenceGateway.Infrastructure.External.GitHub;
 12            
 13            public class GitHubCopilotChatClient : IChatClient, IDisposable
 14            {
 15                private readonly ICopilotClient _copilotClient;
 16                private readonly ILogger<GitHubCopilotChatClient>? _logger;
 17  ✔   3         private readonly ChatClientMetadata _metadata = new ChatClientMetadata("GitHubCopilot", new Uri("https://copilot.git
 18  ✔   3         private readonly string _modelId = "copilot";
 19            
 20  ✔   3         public GitHubCopilotChatClient(ICopilotClient copilotClient, ILogger<GitHubCopilotChatClient>? logger = null)
 21  ✔   3         {
 22  ✓   3  ◑          _copilotClient = copilotClient ?? throw new ArgumentNullException(nameof(copilotClient));
 23  ✔   3             _logger = logger;
 24  ✔   3         }
 25            
 26  ❌  0         public ChatClientMetadata Metadata => _metadata;
 27            
 28                public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 29  ✔   1         {
 30                    // Aggregate streaming updates into a single response for the non-streaming API
 31  ✔   1             var parts = new List<string>();
 32  ✔   7  ●          await foreach (var update in GetStreamingResponseAsync(chatMessages, options, cancellationToken))
 33  ✔   2             {
 34                        // collect text parts from updates
 35  ✔  10  ●              foreach (var c in update.Contents)
 36  ✔   2                 {
 37  ✔   2  ●                  if (c is TextContent tc)
 38  ✔   2                     {
 39  ✓   2  ◑                      parts.Add(tc.Text ?? string.Empty);
 40  ✔   2                     }
 41  ✔   2                 }
 42  ✔   2             }
 43            
 44  ✔   3             var finalText = string.Join(string.Empty, parts.Where(p => !string.IsNullOrEmpty(p)));
 45  ✓   1  ◑          var resp = new ChatResponse(new ChatMessage(ChatRole.Assistant, finalText ?? string.Empty));
 46  ✔   1             resp.ModelId = _modelId;
 47  ✔   1             return resp;
 48  ✔   1         }
 49            
 50                public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> chatMessages, C
 51  ✔   2         {
 52  ✓   2  ◑          if (chatMessages is null) throw new ArgumentNullException(nameof(chatMessages));
 53            
 54                    // Ensure client started
 55  ✔   2  ●          if (_copilotClient.State != ConnectionState.Connected)
 56  ✔   2             {
 57                        try
 58  ✔   2                 {
 59  ✔   2                     await _copilotClient.StartAsync(cancellationToken).ConfigureAwait(false);
 60  ✔   2                 }
 61  ❌  0                 catch (Exception ex)
 62  ❌  0                 {
 63  ❌  0  ○                  _logger?.LogWarning(ex, "Failed to start CopilotClient");
 64  ❌  0                 }
 65  ✔   2             }
 66            
 67                    // Always create a fresh streaming session for each call
 68  ✔   2             var sessionConfig = new SessionConfig { Streaming = true };
 69  ✔   2             ICopilotSession copilotSession = await _copilotClient.CreateSessionAsync(sessionConfig, cancellationToken).Confi
 70            
 71  ✔   2             var channel = Channel.CreateUnbounded<ChatResponseUpdate>();
 72            
 73  ✔   2             IDisposable subscription = copilotSession.On(evt =>
 74  ✔   6             {
 75  ✔   2                 try
 76  ✔   6                 {
 77  ✓   6  ◑                  switch (evt)
 78  ✔   2                     {
 79  ✔   2                         case AssistantMessageDeltaEvent deltaEvent:
 80  ✓   1  ◑                          channel.Writer.TryWrite(ToUpdate(deltaEvent.Data?.DeltaContent ?? string.Empty, deltaEvent));
 81  ✔   1                             break;
 82  ✔   2                         case AssistantMessageEvent assistantMessage:
 83  ✓   2  ◑                          channel.Writer.TryWrite(ToUpdate(assistantMessage.Data?.Content ?? string.Empty, assistantMessag
 84  ✔   2                             break;
 85  ✔   2                         case AssistantUsageEvent usageEvent:
 86  ✔   2                             // Map usage to a textual representation
 87  ✓   1  ◑                          var usageText = $"usage: input={usageEvent.Data?.InputTokens ?? 0} output={usageEvent.Data?.Outp
 88  ✔   1                             channel.Writer.TryWrite(ToUpdate(usageText, usageEvent));
 89  ✔   1                             break;
 90  ✔   2                         case SessionIdleEvent idleEvent:
 91  ✔   2                             channel.Writer.TryWrite(ToUpdate(string.Empty, idleEvent));
 92  ✔   2                             channel.Writer.TryComplete();
 93  ✔   2                             break;
 94  ✔   2                         case SessionErrorEvent errorEvent:
 95  ❌  0  ○                          channel.Writer.TryWrite(ToUpdate(errorEvent.Data?.Message ?? "Session error", errorEvent));
 96  ❌  0  ○                          channel.Writer.TryComplete(new InvalidOperationException(errorEvent.Data?.Message ?? "Session er
 97  ❌  0                             break;
 98  ✔   2                         default:
 99  ❌  0  ○                          channel.Writer.TryWrite(ToUpdate(evt?.ToString() ?? string.Empty, evt));
100  ❌  0                             break;
101  ✔   2                     }
102  ✔   6                 }
103  ❌  0                 catch (Exception ex)
104  ❌  0                 {
105  ❌  0  ○                  _logger?.LogDebug(ex, "Error in Copilot event handler");
106  ❌  0                 }
107  ✔   8             });
108            
109                    try
110  ✔   2             {
111                        // Build a simple text-only prompt
112  ✔   4                 string prompt = string.Join("\n", chatMessages.Select(m => m.Text));
113  ✔   2                 var messageOptions = new MessageOptions { Prompt = prompt };
114            
115  ✔   2                 await copilotSession.SendAsync(messageOptions, cancellationToken).ConfigureAwait(false);
116            
117  ✔  18  ●              await foreach (var update in channel.Reader.ReadAllAsync(cancellationToken).ConfigureAwait(false))
118  ✔   6                 {
119  ✔   6                     yield return update;
120  ✔   6                 }
121  ✔   2             }
122                    finally
123  ✔   2             {
124  ✔   2                 subscription.Dispose();
125  ✔   6                 try { await copilotSession.DisposeAsync().ConfigureAwait(false); } catch { }
126  ✓   2  ◑          }
127  ✔   2         }
128            
129                private static ChatResponseUpdate ToUpdate(string text, object? raw)
130  ✔   6         {
131  ✔   6             var update = new ChatResponseUpdate { Role = ChatRole.Assistant };
132  ✓   6  ◑          var tc = new TextContent(text ?? string.Empty) { RawRepresentation = raw };
133  ✔   6             update.Contents.Add(tc);
134  ✔   6             return update;
135  ✔   6         }
136            
137                public object? GetService(Type serviceType, object? serviceKey = null)
138  ❌  0         {
139  ❌  0  ○          if (serviceType == typeof(ICopilotClient)) return _copilotClient;
140  ❌  0             return null;
141  ❌  0         }
142            
143                public void Dispose()
144  ✔   1         {
145  ✔   3             try { _copilotClient.DisposeAsync().GetAwaiter().GetResult(); } catch { }
146  ✔   1         }
147            }
```
# Synaxis.InferenceGateway.Infrastructure.External.Google.GoogleChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.Google.GoogleChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/Google/GoogleChatClient.cs |
| **Line coverage:** | 0% (0 of 82) |
| Covered lines: | 0 |
| Uncovered lines: | 82 |
| Coverable lines: | 82 |
| Total lines: | 142 |
| **Branch coverage:** | 0% (0 of 40) |
| Covered branches: | 0 |
| Total branches: | 40 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 0% | 42 | 6 | 0% |
| **get_Metadata()** | 100% | 2 | 1 | 0% |
| **GetResponseAsync()** | 0% | 600 | 24 | 0% |
| **GetStreamingResponseAsync(...)** | 100% | 2 | 1 | 0% |
| **CreateRequest(...)** | 0% | 110 | 10 | 0% |
| **Dispose()** | 100% | 2 | 1 | 0% |
| **GetService(...)** | 100% | 2 | 1 | 0% |
| **get_Choices()** | 100% | 2 | 1 | 0% |
| **get_Message()** | 100% | 2 | 1 | 0% |
| **get_Text()** | 100% | 2 | 1 | 0% |
| **get_FinishReason()** | 100% | 2 | 1 | 0% |
| **get_Role()** | 100% | 2 | 1 | 0% |
| **get_Content()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/Google/GoogleChatClient.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Linq;
  4           using System.Net.Http;
  5           using System.Net.Http.Json;
  6           using System.Runtime.CompilerServices;
  7           using System.Text.Json;
  8           using System.Text.Json.Serialization;
  9           using System.Threading;
 10           using System.Threading.Tasks;
 11           using Microsoft.Extensions.AI;
 12           using Microsoft.Extensions.Logging;
 13           
 14           namespace Synaxis.InferenceGateway.Infrastructure.External.Google;
 15           
 16           public class GoogleChatClient : IChatClient
 17           {
 18               private readonly HttpClient _httpClient;
 19               private readonly string _modelId;
 20               private readonly ChatClientMetadata _metadata;
 21  ❌ 0         private static readonly JsonSerializerOptions _jsonOptions = new()
 22  ❌ 0         {
 23  ❌ 0             PropertyNameCaseInsensitive = true,
 24  ❌ 0             DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
 25  ❌ 0         };
 26           
 27               private const string Endpoint = "https://generativelanguage.googleapis.com/v1beta/openai/chat/completions";
 28               private readonly ILogger<GoogleChatClient>? _logger;
 29           
 30  ❌ 0         public GoogleChatClient(string apiKey, string modelId, HttpClient httpClient, ILogger<GoogleChatClient>? logger = nu
 31  ❌ 0         {
 32  ❌ 0  ○          _httpClient = httpClient ?? throw new ArgumentNullException(nameof(httpClient));
 33  ❌ 0  ○          _modelId = modelId ?? "default";
 34  ❌ 0             _logger = logger;
 35  ❌ 0  ○          if (!string.IsNullOrEmpty(apiKey))
 36  ❌ 0             {
 37  ❌ 0                 _httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bea
 38  ❌ 0             }
 39  ❌ 0             _httpClient.DefaultRequestHeaders.UserAgent.ParseAdd("Synaxis/1.0");
 40  ❌ 0             _metadata = new ChatClientMetadata("Google.Gemini", new Uri(Endpoint), _modelId);
 41  ❌ 0         }
 42           
 43  ❌ 0         public ChatClientMetadata Metadata => _metadata;
 44           
 45               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 46  ❌ 0         {
 47  ❌ 0             var requestObj = CreateRequest(chatMessages, options, stream: false);
 48           
 49                   // Debug: print request URI and model field payload for diagnosing 404s and model formatting
 50                   try
 51  ❌ 0             {
 52  ❌ 0                 var requestJson = JsonSerializer.Serialize(requestObj, _jsonOptions);
 53  ❌ 0                 string payloadModel = _modelId;
 54                       try
 55  ❌ 0                 {
 56  ❌ 0                     using var doc = JsonDocument.Parse(requestJson);
 57  ❌ 0  ○                  if (doc.RootElement.TryGetProperty("model", out var modelProp))
 58  ❌ 0                     {
 59  ❌ 0  ○                      payloadModel = modelProp.ValueKind == JsonValueKind.String ? modelProp.GetString() ?? _modelId : _mo
 60  ❌ 0                     }
 61  ❌ 0                 }
 62  ❌ 0                 catch { /* ignore parse errors and fall back to _modelId */ }
 63           
 64  ❌ 0  ○              if (_logger != null)
 65  ❌ 0                 {
 66  ❌ 0                     _logger.LogInformation("GoogleChatClient sending request. Endpoint: {Endpoint} Model: {Model} Payload: {
 67  ❌ 0                 }
 68                       else
 69  ❌ 0                 {
 70  ❌ 0                     Console.WriteLine($"GoogleChatClient sending request. Endpoint: {Endpoint} Model: {payloadModel} Payload
 71  ❌ 0                 }
 72  ❌ 0             }
 73  ❌ 0             catch (Exception ex)
 74  ❌ 0             {
 75                       // Ensure diagnostic information never throws
 76  ❌ 0                 Console.WriteLine($"GoogleChatClient debug logging failed: {ex}");
 77  ❌ 0             }
 78           
 79  ❌ 0             var response = await _httpClient.PostAsJsonAsync(Endpoint, requestObj, cancellationToken);
 80  ❌ 0  ○          if (!response.IsSuccessStatusCode)
 81  ❌ 0             {
 82  ❌ 0                 var err = await response.Content.ReadAsStringAsync(cancellationToken);
 83  ❌ 0                 throw new HttpRequestException($"Google Gemini API Error {response.StatusCode}: {err}");
 84                   }
 85           
 86  ❌ 0             var openAiResp = await response.Content.ReadFromJsonAsync<OpenAiChatResponse>(_jsonOptions, cancellationToken: c
 87           
 88  ❌ 0  ○          var choice = openAiResp?.Choices?.FirstOrDefault();
 89  ❌ 0  ○          var text = choice?.Message?.Content ?? choice?.Text ?? string.Empty;
 90           
 91  ❌ 0             var chatResponse = new ChatResponse(new ChatMessage(ChatRole.Assistant, text))
 92  ❌ 0             {
 93  ❌ 0                 ModelId = _modelId
 94  ❌ 0             };
 95           
 96  ❌ 0             return chatResponse;
 97  ❌ 0         }
 98           
 99               public IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOpt
100  ❌ 0         {
101  ❌ 0             throw new NotImplementedException("Streaming responses are not implemented for GoogleChatClient yet.");
102               }
103           
104               private object CreateRequest(IEnumerable<ChatMessage> chatMessages, ChatOptions? options, bool stream)
105  ❌ 0         {
106  ❌ 0  ○          var messages = chatMessages.Select(m => new
107  ❌ 0             {
108  ❌ 0                 role = m.Role == ChatRole.User ? "user" :
109  ❌ 0                        m.Role == ChatRole.Assistant ? "assistant" :
110  ❌ 0                        m.Role == ChatRole.System ? "system" : "user",
111  ❌ 0                 content = m.Text
112  ❌ 0             }).ToList();
113           
114  ❌ 0  ○          return new
115  ❌ 0             {
116  ❌ 0                 model = options?.ModelId ?? _modelId,
117  ❌ 0                 messages = messages,
118  ❌ 0                 stream = stream
119  ❌ 0             };
120  ❌ 0         }
121           
122  ❌ 0         public void Dispose() => _httpClient.Dispose();
123  ❌ 0         public object? GetService(Type serviceType, object? serviceKey = null) => null;
124           
125               private class OpenAiChatResponse
126               {
127  ❌ 0             [JsonPropertyName("choices")] public OpenAiChoice[]? Choices { get; set; }
128               }
129           
130               private class OpenAiChoice
131               {
132  ❌ 0             [JsonPropertyName("message")] public OpenAiMessage? Message { get; set; }
133  ❌ 0             [JsonPropertyName("text")] public string? Text { get; set; }
134  ❌ 0             [JsonPropertyName("finish_reason")] public string? FinishReason { get; set; }
135               }
136           
137               private class OpenAiMessage
138               {
139  ❌ 0             [JsonPropertyName("role")] public string? Role { get; set; }
140  ❌ 0             [JsonPropertyName("content")] public string? Content { get; set; }
141               }
142           }
```
# Synaxis.InferenceGateway.Infrastructure.External.KiloCode.KiloCodeChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.KiloCode.KiloCodeChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/KiloCode/KiloCodeChatClient.cs |
| **Line coverage:** | 100% (11 of 11) |
| Covered lines: | 11 |
| Uncovered lines: | 0 |
| Coverable lines: | 11 |
| Total lines: | 26 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **GetKiloHeaders()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/KiloCode/KiloCodeChatClient.cs
```
 1           using System;
 2           using System.Collections.Generic;
 3           using System.Net.Http;
 4           using Synaxis.InferenceGateway.Infrastructure;
 5           
 6           namespace Synaxis.InferenceGateway.Infrastructure.External.KiloCode;
 7           
 8           public class KiloCodeChatClient : GenericOpenAiChatClient
 9           {
10               private const string KiloApiUrl = "https://api.kilo.ai/api/openrouter";
11           
12               public KiloCodeChatClient(string apiKey, string modelId, HttpClient? httpClient = null)
13  ✔  1             : base(apiKey, new Uri(KiloApiUrl), modelId, GetKiloHeaders(), httpClient)
14  ✔  1         {
15  ✔  1         }
16           
17               private static Dictionary<string, string> GetKiloHeaders()
18  ✔  1         {
19  ✔  1             return new Dictionary<string, string>
20  ✔  1             {
21  ✔  1                 { "X-KiloCode-EditorName", "Synaxis" },
22  ✔  1                 { "X-KiloCode-Version", "1.0.0" },
23  ✔  1                 { "X-KiloCode-TaskId", "synaxis-inference" }
24  ✔  1             };
25  ✔  1         }
26           }
```
# Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.Dto.ModelDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.Dto.ModelDto |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/ModelsDev/Dto/ModelDto.cs |
| **Line coverage:** | 100% (17 of 17) |
| Covered lines: | 17 |
| Uncovered lines: | 0 |
| Coverable lines: | 17 |
| Total lines: | 41 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_id()** | 100% | 1 | 1 | 100% |
| **get_name()** | 100% | 1 | 1 | 100% |
| **get_family()** | 100% | 1 | 1 | 100% |
| **get_limit()** | 100% | 1 | 1 | 100% |
| **get_cost()** | 100% | 1 | 1 | 100% |
| **get_modalities()** | 100% | 1 | 1 | 100% |
| **get_open_weights()** | 100% | 1 | 1 | 100% |
| **get_tool_call()** | 100% | 1 | 1 | 100% |
| **get_reasoning()** | 100% | 1 | 1 | 100% |
| **get_structured_output()** | 100% | 1 | 1 | 100% |
| **get_release_date()** | 100% | 1 | 1 | 100% |
| **get_context()** | 100% | 1 | 1 | 100% |
| **get_output()** | 100% | 1 | 1 | 100% |
| **get_input()** | 100% | 1 | 1 | 100% |
| **get_output()** | 100% | 1 | 1 | 100% |
| **get_input()** | 100% | 1 | 1 | 100% |
| **get_output()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/ModelsDev/Dto/ModelDto.cs
```
 1                using System.Collections.Generic;
 2                
 3                namespace Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.Dto;
 4                
 5                public sealed class ModelDto
 6                {
 7  ✔  218573         public string? id { get; set; }
 8  ✔  103696         public string? name { get; set; }
 9  ✔   95186         public string? family { get; set; }
10                
11  ✔  119739         public LimitDto? limit { get; set; }
12  ✔  116446         public CostDto? cost { get; set; }
13                
14  ✔  103696         public ModalitiesDto? modalities { get; set; }
15                
16  ✔  103696         public bool? open_weights { get; set; }
17                
18  ✔  103696         public bool? tool_call { get; set; }
19  ✔  103696         public bool? reasoning { get; set; }
20  ✔   35098         public bool? structured_output { get; set; }
21                
22  ✔  119739         public string? release_date { get; set; }
23                
24                    public sealed class LimitDto
25                    {
26  ✔  103696             public int? context { get; set; }
27  ✔  103696             public int? output { get; set; }
28                    }
29                
30                    public sealed class CostDto
31                    {
32  ✔   99464             public decimal? input { get; set; }
33  ✔   99464             public decimal? output { get; set; }
34                    }
35                
36                    public sealed class ModalitiesDto
37                    {
38  ✔  103696             public string[]? input { get; set; }
39  ✔   87653             public string[]? output { get; set; }
40                    }
41                }
```
# Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.Dto.ProviderDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.Dto.ProviderDto |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/ModelsDev/Dto/ProviderDto.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 8 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_models()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/ModelsDev/Dto/ProviderDto.cs
```
1              using System.Collections.Generic;
2              
3              namespace Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.Dto;
4              
5              public sealed class ProviderDto
6              {
7  ✔  9324         public Dictionary<string, ModelDto>? models { get; set; }
8              }
```
# Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.ModelsDevClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.ModelsDevClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/ModelsDev/ModelsDevClient.cs |
| **Line coverage:** | 61.7% (29 of 47) |
| Covered lines: | 29 |
| Uncovered lines: | 18 |
| Coverable lines: | 47 |
| Total lines: | 85 |
| **Branch coverage:** | 42.8% (12 of 28) |
| Covered branches: | 12 |
| Total branches: | 28 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **GetAllModelsAsync()** | 42.30% | 79 | 26 | 57.14% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/ModelsDev/ModelsDevClient.cs
```
 1                using System;
 2                using System.Collections.Generic;
 3                using System.Net.Http;
 4                using System.Text.Json;
 5                using System.Threading;
 6                using System.Threading.Tasks;
 7                using Microsoft.Extensions.Logging;
 8                using Synaxis.InferenceGateway.Infrastructure.External.ModelsDev.Dto;
 9                
10                namespace Synaxis.InferenceGateway.Infrastructure.External.ModelsDev;
11                
12                public class ModelsDevClient : IModelsDevClient
13                {
14                    private readonly HttpClient _httpClient;
15                    private readonly ILogger<ModelsDevClient>? _logger;
16                
17  ✔      37         public ModelsDevClient(HttpClient httpClient, ILogger<ModelsDevClient>? logger = null)
18  ✔      37         {
19  ✓      37  ◑          _httpClient = httpClient ?? throw new ArgumentNullException(nameof(httpClient));
20  ✔      37             _logger = logger;
21  ✔      37         }
22                
23                    public async Task<List<ModelDto>> GetAllModelsAsync(CancellationToken ct)
24  ✔      37         {
25                        try
26  ✔      37             {
27                            // Request the correct endpoint which returns JSON
28  ✔      37                 using var resp = await _httpClient.GetAsync("/api.json", HttpCompletionOption.ResponseHeadersRead, ct).Confi
29  ✓      37  ◑              if (!resp.IsSuccessStatusCode)
30  ❌      0                 {
31  ❌      0  ○                  _logger?.LogWarning("Models.dev returned non-success status {Status}", resp.StatusCode);
32  ❌      0                     return new List<ModelDto>();
33                            }
34                
35  ✔      37                 var content = await resp.Content.ReadAsStringAsync(ct).ConfigureAwait(false);
36  ✓      37  ◑              if (string.IsNullOrWhiteSpace(content))
37  ❌      0                 {
38  ❌      0  ○                  _logger?.LogWarning("Models.dev returned empty content");
39  ❌      0                     return new List<ModelDto>();
40                            }
41                
42  ✔      37                 var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
43                
44                            ModelsDevResponse? root;
45                            try
46  ✔      37                 {
47  ✔      37                     root = JsonSerializer.Deserialize<ModelsDevResponse>(content, options);
48  ✔      37                 }
49  ❌      0                 catch (JsonException jex)
50  ❌      0                 {
51                                // include a short preview of the response to aid debugging
52  ❌      0  ○                  var preview = content.Length > 512 ? content.Substring(0, 512) + "..." : content;
53  ❌      0  ○                  _logger?.LogWarning(jex, "Failed to deserialize models.dev response. Content preview: {Preview}", previe
54  ❌      0                     return new List<ModelDto>();
55                            }
56                
57  ✔      37                 var list = new List<ModelDto>();
58  ✓      37  ◑              if (root == null) return list;
59                
60  ✔    6327  ●              foreach (var provider in root.Values)
61  ✔    3108                 {
62  ✓    3108  ◑                  if (provider?.models == null) continue;
63  ✔  184630  ●                  foreach (var kv in provider.models)
64  ✔   87653                     {
65  ✔   87653                         var model = kv.Value;
66                                    // ensure id present: if DTO id null, fallback to key
67  ✓   87653  ◑                      if (string.IsNullOrEmpty(model.id)) model.id = kv.Key;
68  ✔   87653                         list.Add(model);
69  ✔   87653                     }
70  ✔    3108                 }
71                
72  ✔      37                 return list;
73                        }
74  ❌      0             catch (OperationCanceledException) when (ct.IsCancellationRequested)
75  ❌      0             {
76                            // Propagate cancellation
77  ❌      0                 throw;
78                        }
79  ❌      0             catch (Exception ex)
80  ❌      0             {
81  ❌      0  ○              _logger?.LogWarning(ex, "Unexpected error while fetching models from models.dev");
82  ❌      0                 return new List<ModelDto>();
83                        }
84  ✔      37         }
85                }
```
# Synaxis.InferenceGateway.Infrastructure.External.OpenAi.Dto.OpenAiModelDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.OpenAi.Dto.OpenAiModelDto |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/OpenAi/Dto/OpenAiModelDto.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 19 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Object()** | 100% | 1 | 1 | 100% |
| **get_Created()** | 100% | 1 | 1 | 100% |
| **get_OwnedBy()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/OpenAi/Dto/OpenAiModelDto.cs
```
 1               using System.Text.Json.Serialization;
 2               
 3               namespace Synaxis.InferenceGateway.Infrastructure.External.OpenAi.Dto
 4               {
 5                   public sealed class OpenAiModelDto
 6                   {
 7                       [JsonPropertyName("id")]
 8  ✔  74259             public string? Id { get; set; }
 9               
10                       [JsonPropertyName("object")]
11  ✔  11951             public string? Object { get; set; }
12               
13                       [JsonPropertyName("created")]
14  ✔  24050             public long? Created { get; set; }
15               
16                       [JsonPropertyName("owned_by")]
17  ✔  11951             public string? OwnedBy { get; set; }
18                   }
19               }
```
# Synaxis.InferenceGateway.Infrastructure.External.OpenAi.Dto.OpenAiModelsResponse

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.OpenAi.Dto.OpenAiModelsResponse |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/OpenAi/Dto/OpenAiModelsResponse.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 11 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Data()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/OpenAi/Dto/OpenAiModelsResponse.cs
```
 1             using System.Collections.Generic;
 2             using System.Text.Json.Serialization;
 3             
 4             namespace Synaxis.InferenceGateway.Infrastructure.External.OpenAi.Dto
 5             {
 6                 public sealed class OpenAiModelsResponse
 7                 {
 8                     [JsonPropertyName("data")]
 9  ✔  888             public List<OpenAiModelDto> Data { get; set; } = new();
10                 }
11             }
```
# Synaxis.InferenceGateway.Infrastructure.External.OpenAi.OpenAiModelDiscoveryClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.External.OpenAi.OpenAiModelDiscoveryClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/OpenAi/OpenAiModelDiscoveryClient.cs |
| **Line coverage:** | 85.1% (23 of 27) |
| Covered lines: | 23 |
| Uncovered lines: | 4 |
| Coverable lines: | 27 |
| Total lines: | 58 |
| **Branch coverage:** | 75% (9 of 12) |
| Covered branches: | 9 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **GetModelsAsync()** | 75.00% | 13 | 12 | 80.95% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/External/OpenAi/OpenAiModelDiscoveryClient.cs
```
 1               using System;
 2               using System.Collections.Generic;
 3               using System.Linq;
 4               using System.Net.Http;
 5               using System.Net.Http.Headers;
 6               using System.Text.Json;
 7               using System.Threading;
 8               using System.Threading.Tasks;
 9               using Microsoft.Extensions.Logging;
10               using Synaxis.InferenceGateway.Infrastructure.External.OpenAi.Dto;
11               
12               namespace Synaxis.InferenceGateway.Infrastructure.External.OpenAi
13               {
14                   public class OpenAiModelDiscoveryClient : IOpenAiModelDiscoveryClient
15                   {
16                       private readonly HttpClient _httpClient;
17                       private readonly ILogger<OpenAiModelDiscoveryClient> _logger;
18               
19  ✔     37             public OpenAiModelDiscoveryClient(HttpClient httpClient, ILogger<OpenAiModelDiscoveryClient> logger)
20  ✔     37             {
21  ✔     37                 _httpClient = httpClient;
22  ✔     37                 _logger = logger;
23  ✔     37             }
24               
25                       public async Task<List<string>> GetModelsAsync(string baseUrl, string apiKey, CancellationToken ct)
26  ✔    553             {
27  ✓    553  ◑              if (string.IsNullOrEmpty(baseUrl)) throw new ArgumentNullException(nameof(baseUrl));
28  ✔    628  ●              if (string.IsNullOrEmpty(apiKey)) throw new ArgumentNullException(nameof(apiKey));
29               
30  ✔    478                 var trimmed = baseUrl.TrimEnd('/');
31  ✔    478                 var url = trimmed + "/v1/models";
32               
33  ✔    478                 using var request = new HttpRequestMessage(HttpMethod.Get, url);
34  ✔    478  ●              request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", apiKey);
35               
36                           try
37  ✔    478                 {
38  ✔    478                     using var resp = await _httpClient.SendAsync(request, ct).ConfigureAwait(false);
39  ✔    478  ●                  if (!resp.IsSuccessStatusCode)
40  ✔    256                     {
41  ✔    256                         _logger.LogWarning("Model discovery call to {Url} returned {Status}", url, resp.StatusCode);
42  ✔    256                         return new List<string>();
43                               }
44               
45  ✔    222                     var stream = await resp.Content.ReadAsStreamAsync(ct).ConfigureAwait(false);
46  ✔    222                     var dto = await JsonSerializer.DeserializeAsync<OpenAiModelsResponse>(stream, cancellationToken: ct).Con
47  ✓    222  ◑                  if (dto == null || dto.Data == null) return new List<string>();
48               
49  ✔  49728                     return dto.Data.Where(d => !string.IsNullOrEmpty(d.Id)).Select(d => d.Id!).ToList();
50                           }
51  ❌     0                 catch (Exception ex)
52  ❌     0                 {
53  ❌     0                     _logger.LogError(ex, "Error discovering models from {Url}", url);
54  ❌     0                     return new List<string>();
55                           }
56  ✔    478             }
57                   }
58               }
```
# Synaxis.InferenceGateway.Infrastructure.GenerationConfig

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.GenerationConfig |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 100% (5 of 5) |
| Covered lines: | 5 |
| Uncovered lines: | 0 |
| Coverable lines: | 5 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_MaxOutputTokens()** | 100% | 1 | 1 | 100% |
| **get_Temperature()** | 100% | 1 | 1 | 100% |
| **get_TopP()** | 100% | 1 | 1 | 100% |
| **get_StopSequences()** | 100% | 1 | 1 | 100% |
| **get_ThinkingConfig()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.IO;
  4           using System.Linq;
  5           using System.Net.Http;
  6           using System.Net.Http.Headers;
  7           using System.Runtime.CompilerServices;
  8           using System.Text;
  9           using System.Text.Json;
 10           using System.Text.Json.Serialization;
 11           using System.Threading;
 12           using System.Threading.Tasks;
 13           using Microsoft.Extensions.AI;
 14           using Synaxis.InferenceGateway.Infrastructure.Auth;
 15           
 16           namespace Synaxis.InferenceGateway.Infrastructure;
 17           
 18           /// <summary>
 19           /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20           /// Implements strict protocol compliance including the wrapper object and custom headers.
 21           /// </summary>
 22           public class AntigravityChatClient : IChatClient
 23           {
 24               private readonly HttpClient _httpClient;
 25               private readonly string _modelId;
 26               private readonly string _projectId;
 27               private readonly ITokenProvider _tokenProvider;
 28               private readonly ChatClientMetadata _metadata;
 29           
 30               // Endpoints are now relative to the configured HttpClient.BaseAddress
 31               private const string EndpointRelative = "/v1/chat/completions";
 32               private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33           
 34               public AntigravityChatClient(
 35                   HttpClient httpClient,
 36                   string modelId,
 37                   string projectId,
 38                   ITokenProvider tokenProvider)
 39               {
 40                   _httpClient = httpClient;
 41                   _modelId = modelId;
 42                   _projectId = projectId;
 43                   _tokenProvider = tokenProvider;
 44                   // Prefer the configured BaseAddress on the provided HttpClient when available
 45                   _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46               }
 47           
 48               public ChatClientMetadata Metadata => _metadata;
 49           
 50               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51               {
 52                   var messagesList = chatMessages.ToList();
 53                   var request = BuildRequest(messagesList, options);
 54                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55           
 56                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58           
 59                   await PrepareRequestAsync(httpRequest, cancellationToken);
 60           
 61                   using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                   await EnsureSuccessAsync(response);
 63           
 64                   var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                   var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66           
 67                   return MapResponse(agResponse?.Response);
 68               }
 69           
 70               public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                   IEnumerable<ChatMessage> chatMessages,
 72                   ChatOptions? options = null,
 73                   [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74               {
 75                   var messagesList = chatMessages.ToList();
 76                   var request = BuildRequest(messagesList, options);
 77                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78           
 79                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                   httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82           
 83                   await PrepareRequestAsync(httpRequest, cancellationToken);
 84           
 85                   using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                   await EnsureSuccessAsync(response);
 87           
 88                   using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                   using var reader = new StreamReader(stream);
 90           
 91                   while (!cancellationToken.IsCancellationRequested)
 92                   {
 93                       var line = await reader.ReadLineAsync(cancellationToken);
 94                       if (line == null) break; // End of stream
 95                       if (string.IsNullOrWhiteSpace(line)) continue;
 96           
 97                       if (line.StartsWith("data: "))
 98                       {
 99                           var data = line.Substring(6).Trim();
100                           if (data == "[DONE]") break;
101           
102                           AntigravityResponseWrapper? wrapper = null;
103                           try
104                           {
105                               wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                           }
107                           catch (JsonException) { /* Ignore malformed lines */ }
108           
109                           if (wrapper?.Response?.Candidates != null)
110                           {
111                               foreach (var candidate in wrapper.Response.Candidates)
112                               {
113                                   if (candidate.Content?.Parts != null)
114                                   {
115                                       foreach (var part in candidate.Content.Parts)
116                                       {
117                                           if (!string.IsNullOrEmpty(part.Text))
118                                           {
119                                               yield return new ChatResponseUpdate
120                                               {
121                                                   Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                   Contents = { new TextContent(part.Text) }
123                                               };
124                                           }
125                                       }
126                                   }
127                               }
128                           }
129                       }
130                   }
131               }
132           
133               private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134               {
135                   var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                   request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137           
138                   // Strict Headers required by Antigravity
139                   request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                   request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                   request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142               }
143           
144               private async Task EnsureSuccessAsync(HttpResponseMessage response)
145               {
146                   if (!response.IsSuccessStatusCode)
147                   {
148                       var error = await response.Content.ReadAsStringAsync();
149                       throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                   }
151               }
152           
153               private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154               {
155                   var contentList = new List<Content>();
156                   SystemInstruction? systemInstruction = null;
157           
158                   foreach (var msg in messages)
159                   {
160                       if (msg.Role == ChatRole.System)
161                       {
162                           // Antigravity requires system instructions in a separate field, not in contents
163                           if (systemInstruction == null)
164                           {
165                               systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                           }
167                           systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                       }
169                       else
170                       {
171                           var role = msg.Role == ChatRole.User ? "user" : "model";
172                           contentList.Add(new Content
173                           {
174                               Role = role,
175                               Parts = new List<Part> { new Part { Text = msg.Text } }
176                           });
177                       }
178                   }
179           
180                   var config = new GenerationConfig
181                   {
182                       MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                       Temperature = options?.Temperature ?? 0.7f,
184                       TopP = options?.TopP ?? 0.95f,
185                       StopSequences = options?.StopSequences
186                   };
187           
188                   // Handle Thinking Config
189                   if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                   {
191                        // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                        // For now, we'll try to extract budget if present, or default
193                        if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                        {
195                            // Simple extraction logic or default
196                            config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                        }
198                   }
199           
200                   return new AntigravityRequest
201                   {
202                       Project = _projectId,
203                       Model = _modelId,
204                       RequestPayload = new RequestPayload
205                       {
206                           Contents = contentList,
207                           SystemInstruction = systemInstruction,
208                           GenerationConfig = config
209                       }
210                   };
211               }
212           
213               private ChatResponse MapResponse(AntigravityResponse? response)
214               {
215                   if (response?.Candidates == null || response.Candidates.Count == 0)
216                       return new ChatResponse(new List<ChatMessage>());
217           
218                   var candidate = response.Candidates[0];
219                   var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220           
221                   return new ChatResponse(new List<ChatMessage>
222                   {
223                       new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                   })
225                   {
226                       ResponseId = response.ResponseId,
227                       ModelId = response.ModelVersion
228                   };
229               }
230           
231               // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232               public void Dispose() { }
233               public object? GetService(Type serviceType, object? serviceKey = null) =>
234                   serviceType == typeof(IChatClient) ? this : null;
235           }
236           
237           internal class AntigravityRequest
238           {
239               [JsonPropertyName("project")] public string Project { get; set; } = "";
240               [JsonPropertyName("model")] public string Model { get; set; } = "";
241               [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242           }
243           
244           internal class RequestPayload
245           {
246               [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247               [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248               [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249           }
250           
251           internal class Content
252           {
253               [JsonPropertyName("role")] public string Role { get; set; } = "user";
254               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255           }
256           
257           internal class SystemInstruction
258           {
259               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260           }
261           
262           internal class Part
263           {
264               [JsonPropertyName("text")] public string? Text { get; set; }
265           }
266           
267           internal class GenerationConfig
268           {
269  ✔  4         [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270  ✔  4         [JsonPropertyName("temperature")] public float Temperature { get; set; }
271  ✔  4         [JsonPropertyName("topP")] public float TopP { get; set; }
272  ✔  4         [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273  ✔  2         [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274           }
275           
276           internal class ThinkingConfig
277           {
278               [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279               [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280           }
281           
282           internal class AntigravityResponseWrapper
283           {
284               [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285           }
286           
287           internal class AntigravityResponse
288           {
289               [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290               [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291               [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292           }
293           
294           internal class Candidate
295           {
296               [JsonPropertyName("content")] public Content? Content { get; set; }
297               [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298           }
299           
300           [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301           [JsonSerializable(typeof(AntigravityRequest))]
302           [JsonSerializable(typeof(AntigravityResponseWrapper))]
303           internal partial class AntigravityJsonContext : JsonSerializerContext
304           {
305           }
```
# Synaxis.InferenceGateway.Infrastructure.GenericOpenAiChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.GenericOpenAiChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/GenericOpenAiChatClient.cs |
| **Line coverage:** | 58.3% (28 of 48) |
| Covered lines: | 28 |
| Uncovered lines: | 20 |
| Coverable lines: | 48 |
| Total lines: | 87 |
| **Branch coverage:** | 58.3% (7 of 12) |
| Covered branches: | 7 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 6 | 6 | 100% |
| **get_Metadata()** | 50.0% | 2 | 2 | 100% |
| **GetResponseAsync(...)** | 100% | 2 | 1 | 0% |
| **GetStreamingResponseAsync(...)** | 100% | 2 | 1 | 0% |
| **GetService(...)** | 100% | 1 | 1 | 100% |
| **Dispose()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **Process(...)** | 0% | 6 | 2 | 0% |
| **ProcessAsync()** | 0% | 6 | 2 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/GenericOpenAiChatClient.cs
```
 1            using Microsoft.Extensions.AI;
 2            using OpenAI;
 3            using System;
 4            using System.ClientModel;
 5            using System.ClientModel.Primitives;
 6            using System.Collections.Generic;
 7            using System.Net.Http;
 8            using System.Threading;
 9            using System.Threading.Tasks;
10            
11            namespace Synaxis.InferenceGateway.Infrastructure;
12            
13            public class GenericOpenAiChatClient : IChatClient
14            {
15                private readonly IChatClient _innerClient;
16            
17  ✔  12         public GenericOpenAiChatClient(string apiKey, Uri endpoint, string modelId, Dictionary<string, string>? customHeader
18  ✔  12         {
19  ✔  12             var options = new OpenAIClientOptions
20  ✔  12             {
21  ✔  12                 Endpoint = endpoint
22  ✔  12             };
23            
24  ✔  12  ●          if (httpClient != null)
25  ✔   1             {
26  ✔   1                 options.Transport = new HttpClientPipelineTransport(httpClient);
27  ✔   1             }
28            
29  ✔  12  ●          if (customHeaders != null && customHeaders.Count > 0)
30  ✔   2             {
31  ✔   2                 options.AddPolicy(new CustomHeaderPolicy(customHeaders), PipelinePosition.PerCall);
32  ✔   2             }
33            
34  ✔  12             var openAiClient = new OpenAIClient(new ApiKeyCredential(apiKey), options);
35  ✔  11             _innerClient = openAiClient.GetChatClient(modelId).AsIChatClient();
36  ✔  10         }
37            
38  ✓   6  ◑      public ChatClientMetadata Metadata => _innerClient.GetService<ChatClientMetadata>() ?? new ChatClientMetadata("OpenA
39            
40                public Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null, Cance
41  ❌  0         {
42  ❌  0             return _innerClient.GetResponseAsync(chatMessages, options, cancellationToken);
43  ❌  0         }
44            
45                public IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOpt
46  ❌  0         {
47  ❌  0             return _innerClient.GetStreamingResponseAsync(chatMessages, options, cancellationToken);
48  ❌  0         }
49            
50                public object? GetService(Type serviceType, object? serviceKey = null)
51  ✔   2         {
52  ✔   2             return _innerClient.GetService(serviceType, serviceKey);
53  ✔   2         }
54            
55                public void Dispose()
56  ✔   1         {
57  ✔   1             _innerClient.Dispose();
58  ✔   1         }
59            
60                private class CustomHeaderPolicy : PipelinePolicy
61                {
62                    private readonly Dictionary<string, string> _headers;
63            
64  ✔   2             public CustomHeaderPolicy(Dictionary<string, string> headers)
65  ✔   2             {
66  ✔   2                 _headers = headers;
67  ✔   2             }
68            
69                    public override void Process(PipelineMessage message, IReadOnlyList<PipelinePolicy> pipeline, int currentIndex)
70  ❌  0             {
71  ❌  0  ○              foreach (var header in _headers)
72  ❌  0                 {
73  ❌  0                     message.Request.Headers.Set(header.Key, header.Value);
74  ❌  0                 }
75  ❌  0                 ProcessNext(message, pipeline, currentIndex);
76  ❌  0             }
77            
78                    public override async ValueTask ProcessAsync(PipelineMessage message, IReadOnlyList<PipelinePolicy> pipeline, in
79  ❌  0             {
80  ❌  0  ○              foreach (var header in _headers)
81  ❌  0                 {
82  ❌  0                     message.Request.Headers.Set(header.Key, header.Value);
83  ❌  0                 }
84  ❌  0                 await ProcessNextAsync(message, pipeline, currentIndex).ConfigureAwait(false);
85  ❌  0             }
86                }
87            }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Core.AuthResult

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Core.AuthResult |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/IAuthStrategy.cs |
| **Line coverage:** | 40% (2 of 5) |
| Covered lines: | 2 |
| Uncovered lines: | 3 |
| Coverable lines: | 5 |
| Total lines: | 30 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_UserCode()** | 100% | 2 | 1 | 0% |
| **get_VerificationUri()** | 100% | 2 | 1 | 0% |
| **get_Message()** | 100% | 1 | 1 | 100% |
| **get_TokenResponse()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/IAuthStrategy.cs
```
 1           using System;
 2           using System.Threading;
 3           using System.Threading.Tasks;
 4           
 5           namespace Synaxis.InferenceGateway.Infrastructure.Identity.Core
 6           {
 7               public class TokenResponse
 8               {
 9                   public string AccessToken { get; set; } = string.Empty;
10                   public string? RefreshToken { get; set; }
11                   public int? ExpiresInSeconds { get; set; }
12               }
13           
14               public class AuthResult
15               {
16  ✔  5             public string Status { get; set; } = string.Empty; // e.g., "Pending", "Completed", "Error"
17  ❌ 0             public string? UserCode { get; set; }
18  ❌ 0             public string? VerificationUri { get; set; }
19  ✔  1             public string? Message { get; set; }
20  ❌ 0             public TokenResponse? TokenResponse { get; set; }
21               }
22           
23               public interface IAuthStrategy
24               {
25                   event EventHandler<IdentityAccount>? AccountAuthenticated;
26                   Task<AuthResult> InitiateFlowAsync(CancellationToken ct);
27                   Task<AuthResult> CompleteFlowAsync(string code, string state, CancellationToken ct);
28                   Task<TokenResponse> RefreshTokenAsync(IdentityAccount account, CancellationToken ct);
29               }
30           }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Core.EncryptedFileTokenStore

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Core.EncryptedFileTokenStore |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/EncryptedFileTokenStore.cs |
| **Line coverage:** | 72.7% (24 of 33) |
| Covered lines: | 24 |
| Uncovered lines: | 9 |
| Coverable lines: | 33 |
| Total lines: | 62 |
| **Branch coverage:** | 50% (5 of 10) |
| Covered branches: | 5 |
| Total branches: | 10 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **LoadAsync()** | 50.0% | 7 | 6 | 66.66% |
| **SaveAsync()** | 50.0% | 4 | 4 | 70.0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/EncryptedFileTokenStore.cs
```
 1            using System;
 2            using System.Collections.Generic;
 3            using System.IO;
 4            using System.Text.Json;
 5            using System.Threading.Tasks;
 6            using Microsoft.AspNetCore.DataProtection;
 7            
 8            namespace Synaxis.InferenceGateway.Infrastructure.Identity.Core
 9            {
10                public class EncryptedFileTokenStore : ISecureTokenStore
11                {
12                    private readonly string _path;
13                    private readonly IDataProtector _protector;
14            
15  ✔  40             public EncryptedFileTokenStore(IDataProtectionProvider provider, string path)
16  ✔  40             {
17  ✔  40                 _protector = provider.CreateProtector("Synaxis.Identity.TokenStore.v1");
18  ✔  40                 _path = path;
19  ✔  40             }
20            
21                    public async Task<List<IdentityAccount>> LoadAsync()
22  ✔  39             {
23  ✓  39  ◑              if (!File.Exists(_path))
24  ❌  0                 {
25  ❌  0                     return new List<IdentityAccount>();
26                        }
27            
28  ✔  39                 var encrypted = await File.ReadAllTextAsync(_path).ConfigureAwait(false);
29  ✓  39  ◑              if (string.IsNullOrWhiteSpace(encrypted))
30  ❌  0                     return new List<IdentityAccount>();
31            
32                        try
33  ✔  39                 {
34  ✔  39                     var json = _protector.Unprotect(encrypted);
35  ✔  39                     var accounts = JsonSerializer.Deserialize<List<IdentityAccount>>(json, new JsonSerializerOptions
36  ✔  39                     {
37  ✔  39                         PropertyNameCaseInsensitive = true
38  ✔  39                     });
39            
40  ✓  39  ◑                  return accounts ?? new List<IdentityAccount>();
41                        }
42  ❌  0                 catch
43  ❌  0                 {
44                            // If decryption or deserialization fails, return empty list
45  ❌  0                     return new List<IdentityAccount>();
46                        }
47  ✔  39             }
48            
49                    public async Task SaveAsync(List<IdentityAccount> accounts)
50  ✔   1             {
51  ✔   1                 var json = JsonSerializer.Serialize(accounts);
52  ✔   1                 var encrypted = _protector.Protect(json);
53  ✔   1                 var dir = Path.GetDirectoryName(_path);
54  ✓   1  ◑              if (!string.IsNullOrEmpty(dir) && !Directory.Exists(dir))
55  ❌  0                 {
56  ❌  0                     Directory.CreateDirectory(dir);
57  ❌  0                 }
58            
59  ✔   1                 await File.WriteAllTextAsync(_path, encrypted).ConfigureAwait(false);
60  ✔   1             }
61                }
62            }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Core.IdentityAccount

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Core.IdentityAccount |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/IdentityAccount.cs |
| **Line coverage:** | 100% (7 of 7) |
| Covered lines: | 7 |
| Uncovered lines: | 0 |
| Coverable lines: | 7 |
| Total lines: | 16 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Provider()** | 100% | 1 | 1 | 100% |
| **get_Email()** | 100% | 1 | 1 | 100% |
| **get_AccessToken()** | 100% | 1 | 1 | 100% |
| **get_RefreshToken()** | 100% | 1 | 1 | 100% |
| **get_ExpiresAt()** | 100% | 1 | 1 | 100% |
| **get_Properties()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/IdentityAccount.cs
```
 1            using System;
 2            using System.Collections.Generic;
 3            
 4            namespace Synaxis.InferenceGateway.Infrastructure.Identity.Core
 5            {
 6                public class IdentityAccount
 7                {
 8  ✔  30             public string Id { get; set; } = string.Empty;
 9  ✔  36             public string Provider { get; set; } = string.Empty;
10  ✔  20             public string Email { get; set; } = string.Empty;
11  ✔  37             public string AccessToken { get; set; } = string.Empty;
12  ✔  14             public string? RefreshToken { get; set; }
13  ✔  23             public DateTimeOffset? ExpiresAt { get; set; }
14  ✔  18             public Dictionary<string, string> Properties { get; set; } = new Dictionary<string, string>();
15                }
16            }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Core.IdentityManager

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Core.IdentityManager |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/IdentityManager.cs |
| **Line coverage:** | 66.3% (122 of 184) |
| Covered lines: | 122 |
| Uncovered lines: | 62 |
| Coverable lines: | 184 |
| Total lines: | 253 |
| **Branch coverage:** | 59.6% (37 of 62) |
| Covered branches: | 37 |
| Total branches: | 62 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 62.50% | 9 | 8 | 72.72% |
| **StartAsync(...)** | 100% | 1 | 1 | 100% |
| **StopAsync(...)** | 50.0% | 2 | 2 | 100% |
| **Dispose()** | 50.0% | 2 | 2 | 100% |
| **RefreshLoopAsync()** | 0% | 156 | 12 | 0% |
| **FindStrategyForProvider(...)** | 87.50% | 8 | 8 | 100% |
| **StartAuth()** | 50.0% | 2 | 2 | 62.50% |
| **CompleteAuth()** | 100% | 2 | 2 | 100% |
| **GetToken()** | 94.44% | 18 | 18 | 100% |
| **AddOrUpdateAccountAsync()** | 100% | 2 | 2 | 81.81% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/IdentityManager.cs
```
  1             using System;
  2             using System.Collections.Generic;
  3             using System.Linq;
  4             using System.Threading;
  5             using System.Threading.Tasks;
  6             using Microsoft.Extensions.Hosting;
  7             using Microsoft.Extensions.Logging;
  8             
  9             namespace Synaxis.InferenceGateway.Infrastructure.Identity.Core
 10             {
 11                 public class IdentityManager : IHostedService, IDisposable
 12                 {
 13                     private readonly IEnumerable<IAuthStrategy> _strategies;
 14                     private readonly ISecureTokenStore _store;
 15                     private readonly ILogger<IdentityManager> _logger;
 16  ✔   48             private readonly List<IdentityAccount> _accounts = new List<IdentityAccount>();
 17                     private Timer? _timer;
 18  ✔   48             private readonly object _lock = new object();
 19             
 20  ✔   48             public IdentityManager(IEnumerable<IAuthStrategy> strategies, ISecureTokenStore store, ILogger<IdentityManager> 
 21  ✔   48             {
 22  ✓   48  ◑              _strategies = strategies ?? Array.Empty<IAuthStrategy>();
 23  ✓   48  ◑              _store = store ?? throw new ArgumentNullException(nameof(store));
 24  ✓   48  ◑              _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 25             
 26                         // Subscribe to account authenticated events from strategies
 27                         try
 28  ✔   48                 {
 29  ✔  312  ●                  foreach (var s in _strategies)
 30  ✔   84                     {
 31  ✔   84                         s.AccountAuthenticated += async (sender, account) =>
 32  ❌   0                         {
 33  ✔   84                             try
 34  ❌   0                             {
 35  ❌   0                                 await AddOrUpdateAccountAsync(account!).ConfigureAwait(false);
 36  ❌   0                             }
 37  ❌   0                             catch (Exception ex)
 38  ❌   0                             {
 39  ❌   0                                 _logger.LogError(ex, "Error adding/updating account from strategy event");
 40  ❌   0                             }
 41  ✔   84                         };
 42  ✔   84                     }
 43  ✔   48                 }
 44  ❌   0                 catch (Exception ex)
 45  ❌   0                 {
 46  ❌   0                     _logger.LogError(ex, "Failed to subscribe to auth strategy events");
 47  ❌   0                 }
 48             
 49                         // Load existing accounts from store synchronously at startup
 50  ✔   48                 Task.Run(async () =>
 51  ✔   48                 {
 52  ✔   48                     try
 53  ✔   48                     {
 54  ✔   48                         var loaded = await _store.LoadAsync().ConfigureAwait(false);
 55  ✔   48                         lock (_lock)
 56  ✔   48                         {
 57  ✔   48                             _accounts.Clear();
 58  ✔   48                             _accounts.AddRange(loaded);
 59  ✔   41                         }
 60  ✔   41                     }
 61  ✔    7                     catch (Exception ex)
 62  ✔    7                     {
 63  ✔    7                         _logger.LogError(ex, "Failed to load identity accounts from store");
 64  ✔    7                     }
 65  ✔   96                 });
 66  ✔   48             }
 67             
 68                     public Task StartAsync(CancellationToken cancellationToken)
 69  ✔   37             {
 70                         // Start a timer to refresh tokens periodically
 71  ✔   37                 _timer = new Timer(async _ => await RefreshLoopAsync(), null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(
 72  ✔   37                 return Task.CompletedTask;
 73  ✔   37             }
 74             
 75                     public Task StopAsync(CancellationToken cancellationToken)
 76  ✔   74             {
 77  ✓   74  ◑              _timer?.Change(Timeout.Infinite, 0);
 78  ✔   74                 return Task.CompletedTask;
 79  ✔   74             }
 80             
 81                     public void Dispose()
 82  ✔   74             {
 83  ✓   74  ◑              _timer?.Dispose();
 84  ✔   74             }
 85             
 86                     private async Task RefreshLoopAsync()
 87  ❌   0             {
 88                         List<IdentityAccount> toRefresh;
 89  ❌   0                 lock (_lock)
 90  ❌   0                 {
 91  ❌   0                     var now = DateTimeOffset.UtcNow;
 92  ❌   0  ○                  toRefresh = _accounts.Where(a => a.ExpiresAt.HasValue && a.RefreshToken != null && a.ExpiresAt.Value <= 
 93  ❌   0                 }
 94             
 95  ❌   0  ○              foreach (var acc in toRefresh)
 96  ❌   0                 {
 97                             try
 98  ❌   0                     {
 99  ❌   0                         var strat = FindStrategyForProvider(acc.Provider);
100  ❌   0  ○                      if (strat == null)
101  ❌   0                         {
102  ❌   0                             _logger.LogWarning("No auth strategy found for provider {Provider}", acc.Provider);
103  ❌   0                             continue;
104                                 }
105             
106  ❌   0                         var tokenResp = await strat.RefreshTokenAsync(acc, CancellationToken.None).ConfigureAwait(false);
107  ❌   0  ○                      if (tokenResp != null)
108  ❌   0                         {
109  ❌   0                             lock (_lock)
110  ❌   0                             {
111  ❌   0  ○                              acc.AccessToken = tokenResp.AccessToken ?? acc.AccessToken;
112  ❌   0  ○                              if (!string.IsNullOrEmpty(tokenResp.RefreshToken)) acc.RefreshToken = tokenResp.RefreshToken
113  ❌   0  ○                              if (tokenResp.ExpiresInSeconds.HasValue)
114  ❌   0                                     acc.ExpiresAt = DateTimeOffset.UtcNow.AddSeconds(tokenResp.ExpiresInSeconds.Value);
115  ❌   0                             }
116  ❌   0                         }
117  ❌   0                     }
118  ❌   0                     catch (Exception ex)
119  ❌   0                     {
120  ❌   0                         _logger.LogError(ex, "Error refreshing token for provider {Provider}", acc.Provider);
121  ❌   0                     }
122  ❌   0                 }
123             
124                         // Save updated accounts
125                         try
126  ❌   0                 {
127                             List<IdentityAccount> snapshot;
128  ❌   0                     lock (_lock)
129  ❌   0                     {
130  ❌   0                         snapshot = _accounts.Select(a => a).ToList();
131  ❌   0                     }
132  ❌   0                     await _store.SaveAsync(snapshot).ConfigureAwait(false);
133  ❌   0                 }
134  ❌   0                 catch (Exception ex)
135  ❌   0                 {
136  ❌   0                     _logger.LogError(ex, "Failed to save accounts after refresh loop");
137  ❌   0                 }
138  ❌   0             }
139             
140                     private IAuthStrategy? FindStrategyForProvider(string provider)
141  ✔    6             {
142  ✓    6  ◑              if (string.IsNullOrEmpty(provider)) return null;
143  ✔    6                 var prov = provider.Trim();
144                         // Try exact match on type name or substring match
145  ✔   26  ●              foreach (var s in _strategies)
146  ✔    5                 {
147  ✔    5                     var name = s.GetType().Name;
148  ✔    5  ●                  if (string.Equals(name, prov, StringComparison.OrdinalIgnoreCase) || name.Contains(prov, StringCompariso
149  ✔    2                         return s;
150  ✔    3                 }
151             
152                         // Fallback: return first strategy
153  ✔    4                 return _strategies.FirstOrDefault();
154  ✔    6             }
155             
156                     public async Task<AuthResult?> StartAuth(string provider, CancellationToken ct = default)
157  ✔    1             {
158  ✔    1                 var strat = FindStrategyForProvider(provider);
159  ✓    1  ◑              if (strat == null)
160  ❌   0                 {
161  ❌   0                     _logger.LogWarning("No strategy found for provider {Provider}", provider);
162  ❌   0                     return new AuthResult { Status = "Error", Message = "No strategy found" };
163                         }
164             
165  ✔    1                 return await strat.InitiateFlowAsync(ct).ConfigureAwait(false);
166  ✔    1             }
167             
168                     // New helper to complete auth from external callers by provider
169                     public async Task<AuthResult> CompleteAuth(string provider, string code, string state)
170  ✔    2             {
171  ✔    2                 var strat = FindStrategyForProvider(provider);
172  ✔    2  ●              if (strat == null)
173  ✔    1                 {
174  ✔    1                     _logger.LogWarning("No strategy found for provider {Provider}", provider);
175  ✔    1                     throw new InvalidOperationException("No strategy found");
176                         }
177             
178  ✔    1                 return await strat.CompleteFlowAsync(code, state, CancellationToken.None).ConfigureAwait(false);
179  ✔    1             }
180             
181                     public async Task<string?> GetToken(string provider, CancellationToken ct = default)
182  ✔    8             {
183                         IdentityAccount? acc;
184  ✔    8                 lock (_lock)
185  ✔    8                 {
186  ✔   15                     acc = _accounts.FirstOrDefault(a => string.Equals(a.Provider, provider, StringComparison.OrdinalIgnoreCa
187  ✔    8                 }
188             
189  ✔    8  ●              if (acc == null)
190  ✔    1                     return null;
191             
192  ✔    7                 var now = DateTimeOffset.UtcNow;
193  ✔    7  ●              if (acc.ExpiresAt.HasValue && acc.ExpiresAt.Value <= now && !string.IsNullOrEmpty(acc.RefreshToken))
194  ✔    3                 {
195                             try
196  ✔    3                     {
197  ✔    3                         var strat = FindStrategyForProvider(provider);
198  ✔    3  ●                      if (strat != null)
199  ✔    3                         {
200  ✔    3                             var tokenResp = await strat.RefreshTokenAsync(acc, ct).ConfigureAwait(false);
201  ✔    2  ●                          if (tokenResp != null)
202  ✔    2                             {
203  ✔    2                                 lock (_lock)
204  ✔    2                                 {
205  ✓    2  ◑                                  acc.AccessToken = tokenResp.AccessToken ?? acc.AccessToken;
206  ✔    4  ●                                  if (!string.IsNullOrEmpty(tokenResp.RefreshToken)) acc.RefreshToken = tokenResp.RefreshT
207  ✔    2  ●                                  if (tokenResp.ExpiresInSeconds.HasValue)
208  ✔    2                                         acc.ExpiresAt = DateTimeOffset.UtcNow.AddSeconds(tokenResp.ExpiresInSeconds.Value);
209  ✔    2                                 }
210             
211  ✔    4                                 await _store.SaveAsync(_accounts.Select(a => a).ToList()).ConfigureAwait(false);
212  ✔    2                             }
213  ✔    2                         }
214  ✔    2                     }
215  ✔    1                     catch (Exception ex)
216  ✔    1                     {
217  ✔    1                         _logger.LogError(ex, "Failed refreshing token for provider {Provider}", provider);
218  ✔    1                     }
219  ✔    3                 }
220             
221  ✔    7                 return acc.AccessToken;
222  ✔    8             }
223             
224                     public async Task AddOrUpdateAccountAsync(IdentityAccount account)
225  ✔    6             {
226  ✔    6                 lock (_lock)
227  ✔    6                 {
228  ✓    7  ◑                  var existing = _accounts.FirstOrDefault(a => string.Equals(a.Provider, account.Provider, StringCompariso
229  ✔    6  ●                  if (existing != null)
230  ✔    1                     {
231  ✔    1                         existing.AccessToken = account.AccessToken;
232  ✔    1                         existing.RefreshToken = account.RefreshToken;
233  ✔    1                         existing.ExpiresAt = account.ExpiresAt;
234  ✔    1                         existing.Email = account.Email;
235  ✔    1                         existing.Properties = account.Properties;
236  ✔    1                     }
237                             else
238  ✔    5                     {
239  ✔    5                         _accounts.Add(account);
240  ✔    5                     }
241  ✔    6                 }
242             
243                         try
244  ✔    6                 {
245  ✔   12                     await _store.SaveAsync(_accounts.Select(a => a).ToList()).ConfigureAwait(false);
246  ✔    6                 }
247  ❌   0                 catch (Exception ex)
248  ❌   0                 {
249  ❌   0                     _logger.LogError(ex, "Failed to save accounts after add/update");
250  ❌   0                 }
251  ✔    6             }
252                 }
253             }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Core.TokenResponse

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Core.TokenResponse |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/IAuthStrategy.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 30 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_AccessToken()** | 100% | 1 | 1 | 100% |
| **get_RefreshToken()** | 100% | 1 | 1 | 100% |
| **get_ExpiresInSeconds()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Core/IAuthStrategy.cs
```
 1           using System;
 2           using System.Threading;
 3           using System.Threading.Tasks;
 4           
 5           namespace Synaxis.InferenceGateway.Infrastructure.Identity.Core
 6           {
 7               public class TokenResponse
 8               {
 9  ✔  6             public string AccessToken { get; set; } = string.Empty;
10  ✔  6             public string? RefreshToken { get; set; }
11  ✔  6             public int? ExpiresInSeconds { get; set; }
12               }
13           
14               public class AuthResult
15               {
16                   public string Status { get; set; } = string.Empty; // e.g., "Pending", "Completed", "Error"
17                   public string? UserCode { get; set; }
18                   public string? VerificationUri { get; set; }
19                   public string? Message { get; set; }
20                   public TokenResponse? TokenResponse { get; set; }
21               }
22           
23               public interface IAuthStrategy
24               {
25                   event EventHandler<IdentityAccount>? AccountAuthenticated;
26                   Task<AuthResult> InitiateFlowAsync(CancellationToken ct);
27                   Task<AuthResult> CompleteFlowAsync(string code, string state, CancellationToken ct);
28                   Task<TokenResponse> RefreshTokenAsync(IdentityAccount account, CancellationToken ct);
29               }
30           }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.IdentityTokenProvider

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.IdentityTokenProvider |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/IdentityTokenProvider.cs |
| **Line coverage:** | 0% (0 of 8) |
| Covered lines: | 0 |
| Uncovered lines: | 8 |
| Coverable lines: | 8 |
| Total lines: | 23 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **GetTokenAsync()** | 0% | 6 | 2 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/IdentityTokenProvider.cs
```
 1           using System.Threading;
 2           using System.Threading.Tasks;
 3           using Synaxis.InferenceGateway.Infrastructure.Auth;
 4           using Synaxis.InferenceGateway.Infrastructure.Identity.Core;
 5           
 6           namespace Synaxis.InferenceGateway.Infrastructure.Identity
 7           {
 8               public class IdentityTokenProvider : ITokenProvider
 9               {
10                   private readonly IdentityManager _manager;
11           
12  ❌ 0             public IdentityTokenProvider(IdentityManager manager)
13  ❌ 0             {
14  ❌ 0                 _manager = manager;
15  ❌ 0             }
16           
17                   public async Task<string> GetTokenAsync(CancellationToken cancellationToken = default)
18  ❌ 0             {
19  ❌ 0                 var t = await _manager.GetToken("google", cancellationToken).ConfigureAwait(false);
20  ❌ 0  ○              return t ?? string.Empty;
21  ❌ 0             }
22               }
23           }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.DeviceFlowService

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.DeviceFlowService |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/GitHub/DeviceFlowService.cs |
| **Line coverage:** | 5.1% (5 of 97) |
| Covered lines: | 5 |
| Uncovered lines: | 92 |
| Coverable lines: | 97 |
| Total lines: | 122 |
| **Branch coverage:** | 25% (2 of 8) |
| Covered branches: | 2 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 4 | 4 | 100% |
| **StartPollingAsync(...)** | 0% | 20 | 4 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/GitHub/DeviceFlowService.cs
```
  1            using System;
  2            using System.Net.Http;
  3            using System.Net.Http.Headers;
  4            using System.Text.Json;
  5            using System.Threading;
  6            using System.Threading.Tasks;
  7            using Microsoft.Extensions.Logging;
  8            using Synaxis.InferenceGateway.Infrastructure.Identity.Core;
  9            
 10            namespace Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub
 11            {
 12                public class DeviceFlowService
 13                {
 14                    private readonly HttpClient _http;
 15                    private readonly ILogger<DeviceFlowService> _logger;
 16            
 17  ✔  37             public DeviceFlowService(HttpClient http, ILogger<DeviceFlowService> logger)
 18  ✔  37             {
 19  ✓  37  ◑              _http = http ?? throw new ArgumentNullException(nameof(http));
 20  ✓  37  ◑              _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 21  ✔  37             }
 22            
 23                    /// <summary>
 24                    /// Start polling GitHub token endpoint for the device flow. Calls onSuccess when token received.
 25                    /// </summary>
 26                    public Task StartPollingAsync(string deviceCode, int intervalSeconds, Func<TokenResponse, Task> onSuccess, Cance
 27  ❌  0             {
 28  ❌  0  ○              if (string.IsNullOrEmpty(deviceCode)) throw new ArgumentNullException(nameof(deviceCode));
 29  ❌  0  ○              if (onSuccess == null) throw new ArgumentNullException(nameof(onSuccess));
 30            
 31                        // Run background polling
 32  ❌  0                 return Task.Run(async () =>
 33  ❌  0                 {
 34  ❌  0                     var interval = Math.Max(1, intervalSeconds);
 35  ❌  0                     var url = "https://github.com/login/oauth/access_token";
 36  ❌  0     
 37  ❌  0                     while (!ct.IsCancellationRequested)
 38  ❌  0                     {
 39  ❌  0                         try
 40  ❌  0                         {
 41  ❌  0                             using var req = new HttpRequestMessage(HttpMethod.Post, url);
 42  ❌  0                             req.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
 43  ❌  0                             var body = new System.Collections.Generic.Dictionary<string, string>
 44  ❌  0                             {
 45  ❌  0                                 ["client_id"] = GitHubAuthStrategy.ClientId,
 46  ❌  0                                 ["device_code"] = deviceCode,
 47  ❌  0                                 ["grant_type"] = "urn:ietf:params:oauth:grant-type:device_code"
 48  ❌  0                             };
 49  ❌  0                             req.Content = new FormUrlEncodedContent(body);
 50  ❌  0     
 51  ❌  0                             using var resp = await _http.SendAsync(req, ct).ConfigureAwait(false);
 52  ❌  0                             var txt = await resp.Content.ReadAsStringAsync(ct).ConfigureAwait(false);
 53  ❌  0                             if (string.IsNullOrEmpty(txt))
 54  ❌  0                             {
 55  ❌  0                                 _logger.LogWarning("Empty response when polling GitHub device token endpoint");
 56  ❌  0                             }
 57  ❌  0     
 58  ❌  0                             try
 59  ❌  0                             {
 60  ❌  0                                 using var doc = JsonDocument.Parse(txt);
 61  ❌  0                                 var root = doc.RootElement;
 62  ❌  0                                 if (root.TryGetProperty("access_token", out var at))
 63  ❌  0                                 {
 64  ❌  0                                     var tr = new TokenResponse
 65  ❌  0                                     {
 66  ❌  0                                         AccessToken = at.GetString() ?? string.Empty
 67  ❌  0                                     };
 68  ❌  0                                     if (root.TryGetProperty("refresh_token", out var rt)) tr.RefreshToken = rt.GetString();
 69  ❌  0                                     if (root.TryGetProperty("expires_in", out var ex)) tr.ExpiresInSeconds = ex.GetInt32();
 70  ❌  0     
 71  ❌  0                                     await onSuccess(tr).ConfigureAwait(false);
 72  ❌  0                                     break;
 73  ❌  0                                 }
 74  ❌  0     
 75  ❌  0                                 if (root.TryGetProperty("error", out var err))
 76  ❌  0                                 {
 77  ❌  0                                     var errVal = err.GetString();
 78  ❌  0                                     switch (errVal)
 79  ❌  0                                     {
 80  ❌  0                                         case "authorization_pending":
 81  ❌  0                                             // continue waiting
 82  ❌  0                                             break;
 83  ❌  0                                         case "slow_down":
 84  ❌  0                                             interval += 5;
 85  ❌  0                                             break;
 86  ❌  0                                         case "expired_token":
 87  ❌  0                                         case "access_denied":
 88  ❌  0                                         default:
 89  ❌  0                                             _logger.LogWarning("Device flow polling stopped due to error: {Error}", errVal);
 90  ❌  0                                             return;
 91  ❌  0                                     }
 92  ❌  0                                 }
 93  ❌  0                             }
 94  ❌  0                             catch (JsonException jex)
 95  ❌  0                             {
 96  ❌  0                                 _logger.LogError(jex, "Failed to parse GitHub device token response: {Text}", txt);
 97  ❌  0                             }
 98  ❌  0                         }
 99  ❌  0                         catch (OperationCanceledException) when (ct.IsCancellationRequested)
100  ❌  0                         {
101  ❌  0                             break;
102  ❌  0                         }
103  ❌  0                         catch (Exception ex)
104  ❌  0                         {
105  ❌  0                             _logger.LogError(ex, "Error while polling GitHub device token endpoint");
106  ❌  0                             // break on unexpected errors
107  ❌  0                             break;
108  ❌  0                         }
109  ❌  0     
110  ❌  0                         try
111  ❌  0                         {
112  ❌  0                             await Task.Delay(TimeSpan.FromSeconds(interval), ct).ConfigureAwait(false);
113  ❌  0                         }
114  ❌  0                         catch (OperationCanceledException) when (ct.IsCancellationRequested)
115  ❌  0                         {
116  ❌  0                             break;
117  ❌  0                         }
118  ❌  0                     }
119  ❌  0                 }, ct);
120  ❌  0             }
121                }
122            }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.GhConfigWriter

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.GhConfigWriter |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/GitHub/GhConfigWriter.cs |
| **Line coverage:** | 0% (0 of 46) |
| Covered lines: | 0 |
| Uncovered lines: | 46 |
| Coverable lines: | 46 |
| Total lines: | 77 |
| **Branch coverage:** | 0% (0 of 24) |
| Covered branches: | 0 |
| Total branches: | 24 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **WriteTokenAsync()** | 0% | 600 | 24 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/GitHub/GhConfigWriter.cs
```
 1           using System;
 2           using System.IO;
 3           using System.Text;
 4           using System.Threading.Tasks;
 5           
 6           namespace Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub
 7           {
 8               public static class GhConfigWriter
 9               {
10                   public static async Task WriteTokenAsync(string token, string user = "synaxis-user")
11  ❌ 0             {
12  ❌ 0                 var home = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
13  ❌ 0                 var cfgDir = Path.Combine(home, ".config", "gh");
14  ❌ 0                 var path = Path.Combine(cfgDir, "hosts.yml");
15           
16  ❌ 0  ○              if (!Directory.Exists(cfgDir)) Directory.CreateDirectory(cfgDir);
17           
18  ❌ 0                 string existing = string.Empty;
19  ❌ 0  ○              if (File.Exists(path)) existing = await File.ReadAllTextAsync(path).ConfigureAwait(false);
20           
21                       // Very small YAML manipulation: find github.com block, replace or append
22  ❌ 0                 var hostBlock = new StringBuilder();
23  ❌ 0                 hostBlock.AppendLine("github.com:");
24  ❌ 0                 hostBlock.AppendLine($"  user: {user}");
25  ❌ 0                 hostBlock.AppendLine($"  oauth_token: {token}");
26           
27  ❌ 0  ○              if (string.IsNullOrWhiteSpace(existing))
28  ❌ 0                 {
29  ❌ 0                     await File.WriteAllTextAsync(path, hostBlock.ToString()).ConfigureAwait(false);
30  ❌ 0                     return;
31                       }
32           
33                       // Try to replace existing github.com block
34  ❌ 0                 var lines = existing.Replace("\r\n", "\n").Split('\n');
35  ❌ 0                 var outSb = new StringBuilder();
36  ❌ 0                 bool inGithubBlock = false;
37  ❌ 0                 bool replaced = false;
38  ❌ 0  ○              foreach (var line in lines)
39  ❌ 0                 {
40  ❌ 0                     var trimmed = line.TrimStart();
41  ❌ 0  ○                  if (!inGithubBlock && trimmed.StartsWith("github.com:", StringComparison.Ordinal))
42  ❌ 0                     {
43                               // begin replace
44  ❌ 0                         outSb.Append(hostBlock);
45  ❌ 0                         inGithubBlock = true;
46  ❌ 0                         replaced = true;
47  ❌ 0                         continue;
48                           }
49           
50  ❌ 0  ○                  if (inGithubBlock)
51  ❌ 0                     {
52                               // If this line is another top-level key (no leading spaces), we left the block
53  ❌ 0  ○                      if (!line.StartsWith(" ") && !string.IsNullOrWhiteSpace(line))
54  ❌ 0                         {
55  ❌ 0                             inGithubBlock = false;
56  ❌ 0                         }
57                               else
58  ❌ 0                         {
59                                   // skip existing block lines
60  ❌ 0                             continue;
61                               }
62  ❌ 0                     }
63           
64  ❌ 0                     outSb.AppendLine(line);
65  ❌ 0                 }
66           
67  ❌ 0  ○              if (!replaced)
68  ❌ 0                 {
69                           // append
70  ❌ 0  ○                  if (outSb.Length > 0 && !outSb.ToString().EndsWith("\n")) outSb.AppendLine();
71  ❌ 0                     outSb.Append(hostBlock);
72  ❌ 0                 }
73           
74  ❌ 0                 await File.WriteAllTextAsync(path, outSb.ToString()).ConfigureAwait(false);
75  ❌ 0             }
76               }
77           }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.GitHubAuthStrategy

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub.GitHubAuthStrategy |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/GitHub/GitHubAuthStrategy.cs |
| **Line coverage:** | 6.5% (6 of 91) |
| Covered lines: | 6 |
| Uncovered lines: | 85 |
| Coverable lines: | 91 |
| Total lines: | 144 |
| **Branch coverage:** | 12.5% (3 of 24) |
| Covered branches: | 3 |
| Total branches: | 24 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 6 | 6 | 100% |
| **InitiateFlowAsync()** | 0% | 20 | 4 | 0% |
| **CompleteFlowAsync(...)** | 100% | 2 | 1 | 0% |
| **RefreshTokenAsync()** | 0% | 110 | 10 | 0% |
| **OnTokenReceived()** | 0% | 20 | 4 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/GitHub/GitHubAuthStrategy.cs
```
  1            using System;
  2            using System.Net.Http;
  3            using System.Net.Http.Headers;
  4            using System.Text.Json;
  5            using System.Threading;
  6            using System.Threading.Tasks;
  7            using Microsoft.Extensions.Logging;
  8            using Synaxis.InferenceGateway.Infrastructure.Identity.Core;
  9            
 10            namespace Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.GitHub
 11            {
 12                public class GitHubAuthStrategy : IAuthStrategy
 13                {
 14                    public event EventHandler<IdentityAccount>? AccountAuthenticated;
 15                    public const string ClientId = "178c6fc778ccc68e1d6a";
 16            
 17                    private readonly HttpClient _http;
 18                    private readonly DeviceFlowService _deviceFlowService;
 19                    // IdentityManager removed to avoid circular dependency. Will raise event when account authenticated.
 20                    private readonly ILogger<GitHubAuthStrategy> _logger;
 21            
 22  ✔  37             public GitHubAuthStrategy(HttpClient http, DeviceFlowService deviceFlowService, ILogger<GitHubAuthStrategy> logg
 23  ✔  37             {
 24  ✓  37  ◑              _http = http ?? throw new ArgumentNullException(nameof(http));
 25  ✓  37  ◑              _deviceFlowService = deviceFlowService ?? throw new ArgumentNullException(nameof(deviceFlowService));
 26  ✓  37  ◑              _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 27  ✔  37             }
 28            
 29                    public async Task<AuthResult> InitiateFlowAsync(CancellationToken ct)
 30  ❌  0             {
 31  ❌  0                 var url = "https://github.com/login/device/code";
 32  ❌  0                 using var req = new HttpRequestMessage(HttpMethod.Post, url);
 33  ❌  0                 req.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
 34  ❌  0                 var body = new System.Collections.Generic.Dictionary<string, string>
 35  ❌  0                 {
 36  ❌  0                     ["client_id"] = ClientId,
 37  ❌  0                     ["scope"] = "repo read:org copilot"
 38  ❌  0                 };
 39  ❌  0                 req.Content = new FormUrlEncodedContent(body);
 40            
 41  ❌  0                 using var resp = await _http.SendAsync(req, ct).ConfigureAwait(false);
 42  ❌  0                 var txt = await resp.Content.ReadAsStringAsync(ct).ConfigureAwait(false);
 43            
 44                        try
 45  ❌  0                 {
 46  ❌  0                     using var doc = JsonDocument.Parse(txt);
 47  ❌  0                     var root = doc.RootElement;
 48  ❌  0                     var userCode = root.GetProperty("user_code").GetString();
 49  ❌  0                     var verificationUri = root.GetProperty("verification_uri").GetString();
 50  ❌  0                     var deviceCode = root.GetProperty("device_code").GetString();
 51  ❌  0                     var interval = 5;
 52  ❌  0  ○                  if (root.TryGetProperty("interval", out var iv)) interval = iv.GetInt32();
 53            
 54                            // start background polling
 55  ❌  0  ○                  _ = _deviceFlowService.StartPollingAsync(deviceCode ?? string.Empty, interval, OnTokenReceived, ct);
 56            
 57  ❌  0                     return new AuthResult
 58  ❌  0                     {
 59  ❌  0                         Status = "Pending",
 60  ❌  0                         UserCode = userCode,
 61  ❌  0                         VerificationUri = verificationUri
 62  ❌  0                     };
 63                        }
 64  ❌  0                 catch (Exception ex)
 65  ❌  0                 {
 66  ❌  0                     _logger.LogError(ex, "Failed to initiate GitHub device flow");
 67  ❌  0                     return new AuthResult { Status = "Error", Message = ex.Message };
 68                        }
 69  ❌  0             }
 70            
 71                    public Task<AuthResult> CompleteFlowAsync(string code, string state, CancellationToken ct)
 72  ❌  0             {
 73  ❌  0                 throw new NotImplementedException();
 74                    }
 75            
 76                    public async Task<TokenResponse> RefreshTokenAsync(IdentityAccount account, CancellationToken ct)
 77  ❌  0             {
 78  ❌  0                 var url = "https://github.com/login/oauth/access_token";
 79  ❌  0                 using var req = new HttpRequestMessage(HttpMethod.Post, url);
 80  ❌  0                 req.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
 81  ❌  0  ○              var body = new System.Collections.Generic.Dictionary<string, string>
 82  ❌  0                 {
 83  ❌  0                     ["client_id"] = ClientId,
 84  ❌  0                     ["grant_type"] = "refresh_token",
 85  ❌  0                     ["refresh_token"] = account.RefreshToken ?? string.Empty
 86  ❌  0                 };
 87  ❌  0                 req.Content = new FormUrlEncodedContent(body);
 88            
 89  ❌  0                 using var resp = await _http.SendAsync(req, ct).ConfigureAwait(false);
 90  ❌  0                 var txt = await resp.Content.ReadAsStringAsync(ct).ConfigureAwait(false);
 91            
 92                        try
 93  ❌  0                 {
 94  ❌  0                     using var doc = JsonDocument.Parse(txt);
 95  ❌  0                     var root = doc.RootElement;
 96  ❌  0                     var tr = new TokenResponse();
 97  ❌  0  ○                  if (root.TryGetProperty("access_token", out var at)) tr.AccessToken = at.GetString() ?? string.Empty;
 98  ❌  0  ○                  if (root.TryGetProperty("refresh_token", out var rt)) tr.RefreshToken = rt.GetString();
 99  ❌  0  ○                  if (root.TryGetProperty("expires_in", out var ex)) tr.ExpiresInSeconds = ex.GetInt32();
100  ❌  0                     return tr;
101                        }
102  ❌  0                 catch (Exception ex)
103  ❌  0                 {
104  ❌  0                     _logger.LogError(ex, "Failed to refresh GitHub token: {Text}", txt);
105  ❌  0                     throw;
106                        }
107  ❌  0             }
108            
109                    private async Task OnTokenReceived(TokenResponse token)
110  ❌  0             {
111                        try
112  ❌  0                 {
113                            // Create a basic account; we don't currently have user id/email from device flow response
114  ❌  0                     var acc = new IdentityAccount
115  ❌  0                     {
116  ❌  0                         Provider = "github",
117  ❌  0                         Id = "github-user",
118  ❌  0                         AccessToken = token.AccessToken,
119  ❌  0                         RefreshToken = token.RefreshToken
120  ❌  0                     };
121            
122  ❌  0  ○                  if (token.ExpiresInSeconds.HasValue)
123  ❌  0                         acc.ExpiresAt = DateTimeOffset.UtcNow.AddSeconds(token.ExpiresInSeconds.Value);
124            
125                            // Notify subscribers that an account was authenticated
126                            try
127  ❌  0                     {
128  ❌  0  ○                      AccountAuthenticated?.Invoke(this, acc);
129  ❌  0                     }
130  ❌  0                     catch (Exception ex)
131  ❌  0                     {
132  ❌  0                         _logger.LogError(ex, "Error invoking AccountAuthenticated event");
133  ❌  0                     }
134            
135                            // Write to gh config
136  ❌  0                     await GhConfigWriter.WriteTokenAsync(token.AccessToken).ConfigureAwait(false);
137  ❌  0                 }
138  ❌  0                 catch (Exception ex)
139  ❌  0                 {
140  ❌  0                     _logger.LogError(ex, "Error handling received GitHub token");
141  ❌  0                 }
142  ❌  0             }
143                }
144            }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.AntigravityAuthAdapter

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.AntigravityAuthAdapter |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/Google/AntigravityAuthAdapter.cs |
| **Line coverage:** | 0% (0 of 18) |
| Covered lines: | 0 |
| Uncovered lines: | 18 |
| Coverable lines: | 18 |
| Total lines: | 43 |
| **Branch coverage:** | 0% (0 of 10) |
| Covered branches: | 0 |
| Total branches: | 10 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **ListAccounts()** | 100% | 2 | 1 | 0% |
| **StartAuthFlow(...)** | 0% | 20 | 4 | 0% |
| **CompleteAuthFlowAsync(...)** | 0% | 6 | 2 | 0% |
| **GetTokenAsync()** | 0% | 6 | 2 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/Google/AntigravityAuthAdapter.cs
```
 1           using System;
 2           using System.Threading;
 3           using System.Threading.Tasks;
 4           using Synaxis.InferenceGateway.Infrastructure.Auth;
 5           using Synaxis.InferenceGateway.Infrastructure.Identity.Core;
 6           
 7           namespace Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google
 8           {
 9               public class AntigravityAuthAdapter : IAntigravityAuthManager
10               {
11                   private readonly IdentityManager _identityManager;
12           
13  ❌ 0             public AntigravityAuthAdapter(IdentityManager identityManager)
14  ❌ 0             {
15  ❌ 0  ○              _identityManager = identityManager ?? throw new ArgumentNullException(nameof(identityManager));
16  ❌ 0             }
17           
18                   public System.Collections.Generic.IEnumerable<AccountInfo> ListAccounts()
19  ❌ 0             {
20                       // Not supported via identity manager - return empty
21  ❌ 0                 return Array.Empty<AccountInfo>();
22  ❌ 0             }
23           
24                   public string StartAuthFlow(string redirectUrl)
25  ❌ 0             {
26                       // IdentityManager.StartAuth is async; call synchronously by waiting on the Task
27  ❌ 0                 var auth = _identityManager.StartAuth("google").GetAwaiter().GetResult();
28  ❌ 0  ○              return auth?.VerificationUri ?? string.Empty;
29  ❌ 0             }
30           
31                   public Task CompleteAuthFlowAsync(string code, string redirectUrl, string? state = null)
32  ❌ 0             {
33                       // Delegate to IdentityManager's new CompleteAuth (implemented below)
34  ❌ 0  ○              return _identityManager.CompleteAuth("google", code, state ?? string.Empty);
35  ❌ 0             }
36           
37                   public async Task<string> GetTokenAsync(CancellationToken cancellationToken = default)
38  ❌ 0             {
39  ❌ 0                 var t = await _identityManager.GetToken("google", cancellationToken).ConfigureAwait(false);
40  ❌ 0  ○              return t ?? string.Empty;
41  ❌ 0             }
42               }
43           }
```
# Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google.GoogleAuthStrategy |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/Google/GoogleAuthStrategy.cs |
| **Line coverage:** | 2.6% (6 of 230) |
| Covered lines: | 6 |
| Uncovered lines: | 224 |
| Coverable lines: | 230 |
| Total lines: | 334 |
| **Branch coverage:** | 4.5% (3 of 66) |
| Covered branches: | 3 |
| Total branches: | 66 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 50.0% | 6 | 6 | 100% |
| **InitiateFlowAsync(...)** | 100% | 2 | 1 | 0% |
| **CompleteFlowAsync()** | 0% | 72 | 8 | 0% |
| **RefreshTokenAsync()** | 0% | 110 | 10 | 0% |
| **ExchangeCodeForTokenAsync()** | 0% | 72 | 8 | 0% |
| **FetchUserEmailAsync()** | 0% | 42 | 6 | 0% |
| **FetchProjectIdAsync()** | 0% | 110 | 10 | 0% |
| **BuildQueryString(...)** | 100% | 2 | 1 | 0% |
| **GenerateCodeVerifier()** | 100% | 2 | 1 | 0% |
| **GenerateCodeChallenge(...)** | 100% | 2 | 1 | 0% |
| **Base64UrlEncode(...)** | 100% | 2 | 1 | 0% |
| **EncodeState(...)** | 100% | 2 | 1 | 0% |
| **DecodeState(...)** | 0% | 42 | 6 | 0% |
| **Base64UrlDecode(...)** | 100% | 2 | 1 | 0% |
| **ExtractProjectId(...)** | 0% | 156 | 12 | 0% |
| **get_Verifier()** | 100% | 2 | 1 | 0% |
| **get_ProjectId()** | 100% | 2 | 1 | 0% |
| **get_AccessToken()** | 100% | 2 | 1 | 0% |
| **get_ExpiresIn()** | 100% | 2 | 1 | 0% |
| **get_RefreshToken()** | 100% | 2 | 1 | 0% |
| **get_Email()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Identity/Strategies/Google/GoogleAuthStrategy.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.Net.Http;
  4            using System.Net.Http.Headers;
  5            using System.Security.Cryptography;
  6            using System.Text;
  7            using System.Text.Json;
  8            using System.Text.Json.Serialization;
  9            using System.Threading;
 10            using System.Threading.Tasks;
 11            using Microsoft.Extensions.Logging;
 12            using Synaxis.InferenceGateway.Infrastructure.Identity.Core;
 13            using Synaxis.InferenceGateway.Application.Configuration;
 14            
 15            namespace Synaxis.InferenceGateway.Infrastructure.Identity.Strategies.Google
 16            {
 17                public class GoogleAuthStrategy : IAuthStrategy
 18                {
 19                    public event EventHandler<IdentityAccount>? AccountAuthenticated;
 20                    private readonly AntigravitySettings _settings;
 21                    private readonly IHttpClientFactory _httpClientFactory;
 22                    private readonly ILogger<GoogleAuthStrategy> _logger;
 23            
 24                    private const string AuthorizationEndpoint = "https://accounts.google.com/o/oauth2/v2/auth";
 25                    private const string TokenEndpoint = "https://oauth2.googleapis.com/token";
 26                    private const string UserInfoEndpoint = "https://www.googleapis.com/oauth2/v1/userinfo?alt=json";
 27            
 28  ❌  0             private static readonly string[] LoadEndpoints =
 29  ❌  0             {
 30  ❌  0                 "https://cloudcode-pa.googleapis.com",
 31  ❌  0                 "https://daily-cloudcode-pa.sandbox.googleapis.com",
 32  ❌  0                 "https://autopush-cloudcode-pa.sandbox.googleapis.com"
 33  ❌  0             };
 34            
 35  ❌  0             private static readonly string[] FallbackEndpoints =
 36  ❌  0             {
 37  ❌  0                 "https://daily-cloudcode-pa.sandbox.googleapis.com",
 38  ❌  0                 "https://autopush-cloudcode-pa.sandbox.googleapis.com",
 39  ❌  0                 "https://cloudcode-pa.googleapis.com"
 40  ❌  0             };
 41            
 42  ❌  0             private static readonly string[] Scopes = new[]
 43  ❌  0             {
 44  ❌  0                 "https://www.googleapis.com/auth/cloud-platform",
 45  ❌  0                 "https://www.googleapis.com/auth/userinfo.email",
 46  ❌  0                 "https://www.googleapis.com/auth/userinfo.profile",
 47  ❌  0             };
 48            
 49  ✔  37             public GoogleAuthStrategy(AntigravitySettings settings, IHttpClientFactory httpClientFactory, ILogger<GoogleAuth
 50  ✔  37             {
 51  ✓  37  ◑              _settings = settings ?? throw new ArgumentNullException(nameof(settings));
 52  ✓  37  ◑              _httpClientFactory = httpClientFactory ?? throw new ArgumentNullException(nameof(httpClientFactory));
 53  ✓  37  ◑              _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 54  ✔  37             }
 55            
 56                    public Task<AuthResult> InitiateFlowAsync(CancellationToken ct)
 57  ❌  0             {
 58                        try
 59  ❌  0                 {
 60  ❌  0                     var verifier = GenerateCodeVerifier();
 61  ❌  0                     var challenge = GenerateCodeChallenge(verifier);
 62  ❌  0                     var state = EncodeState(new PkceState { Verifier = verifier, ProjectId = string.Empty });
 63            
 64  ❌  0                     var parameters = new Dictionary<string, string>
 65  ❌  0                     {
 66  ❌  0                         ["client_id"] = _settings.ClientId,
 67  ❌  0                         ["response_type"] = "code",
 68  ❌  0                         ["redirect_uri"] = "urn:ietf:wg:oauth:2.0:oob", // out-of-band
 69  ❌  0                         ["scope"] = string.Join(" ", Scopes),
 70  ❌  0                         ["code_challenge"] = challenge,
 71  ❌  0                         ["code_challenge_method"] = "S256",
 72  ❌  0                         ["state"] = state,
 73  ❌  0                         ["access_type"] = "offline",
 74  ❌  0                         ["prompt"] = "consent"
 75  ❌  0                     };
 76            
 77  ❌  0                     var url = AuthorizationEndpoint + "?" + BuildQueryString(parameters);
 78  ❌  0                     return Task.FromResult(new AuthResult { Status = "Pending", VerificationUri = url });
 79                        }
 80  ❌  0                 catch (Exception ex)
 81  ❌  0                 {
 82  ❌  0                     _logger.LogError(ex, "Failed to initiate Google auth flow");
 83  ❌  0                     return Task.FromResult(new AuthResult { Status = "Error", Message = ex.Message });
 84                        }
 85  ❌  0             }
 86            
 87                    public async Task<AuthResult> CompleteFlowAsync(string code, string state, CancellationToken ct)
 88  ❌  0             {
 89                        try
 90  ❌  0                 {
 91  ❌  0                     var pkce = DecodeState(state);
 92            
 93  ❌  0                     var token = await ExchangeCodeForTokenAsync(code, pkce.Verifier, ct).ConfigureAwait(false);
 94  ❌  0                     var email = await FetchUserEmailAsync(token.AccessToken, ct).ConfigureAwait(false);
 95            
 96                            // Resolve project id by probing cloudcode endpoints
 97  ❌  0                     var projectId = await FetchProjectIdAsync(token.AccessToken, ct).ConfigureAwait(false);
 98            
 99  ❌  0                     var result = new AuthResult
100  ❌  0                     {
101  ❌  0                         Status = "Completed",
102  ❌  0                         TokenResponse = token,
103  ❌  0                         VerificationUri = null,
104  ❌  0                         UserCode = null
105  ❌  0                     };
106            
107  ❌  0  ○                  if (!string.IsNullOrWhiteSpace(email)) result.Message = email;
108  ❌  0  ○                  if (!string.IsNullOrWhiteSpace(projectId)) result.UserCode = projectId; // reuse UserCode field to carry
109            
110                            // Create and notify account
111  ❌  0                     var account = new IdentityAccount
112  ❌  0                     {
113  ❌  0                         Provider = "google",
114  ❌  0                         Id = email,
115  ❌  0                         Email = email,
116  ❌  0                         AccessToken = token.AccessToken,
117  ❌  0                         RefreshToken = token.RefreshToken,
118  ❌  0                         Properties = new Dictionary<string, string> { ["ProjectId"] = projectId }
119  ❌  0                     };
120  ❌  0  ○                  if (token.ExpiresInSeconds.HasValue)
121  ❌  0                         account.ExpiresAt = DateTimeOffset.UtcNow.AddSeconds(token.ExpiresInSeconds.Value);
122            
123  ❌  0  ○                  AccountAuthenticated?.Invoke(this, account);
124            
125  ❌  0                     return result;
126                        }
127  ❌  0                 catch (Exception ex)
128  ❌  0                 {
129  ❌  0                     _logger.LogError(ex, "Failed to complete Google auth flow");
130  ❌  0                     return new AuthResult { Status = "Error", Message = ex.Message };
131                        }
132  ❌  0             }
133            
134                    public async Task<TokenResponse> RefreshTokenAsync(IdentityAccount account, CancellationToken ct)
135  ❌  0             {
136  ❌  0  ○              if (string.IsNullOrWhiteSpace(account.RefreshToken)) throw new InvalidOperationException("Missing refresh to
137            
138  ❌  0                 using var http = _httpClientFactory.CreateClient();
139  ❌  0                 using var content = new FormUrlEncodedContent(new Dictionary<string, string>
140  ❌  0                 {
141  ❌  0                     ["client_id"] = _settings.ClientId,
142  ❌  0                     ["client_secret"] = _settings.ClientSecret,
143  ❌  0                     ["refresh_token"] = account.RefreshToken,
144  ❌  0                     ["grant_type"] = "refresh_token"
145  ❌  0                 });
146            
147  ❌  0                 using var resp = await http.PostAsync(TokenEndpoint, content, ct).ConfigureAwait(false);
148  ❌  0                 var payload = await resp.Content.ReadAsStringAsync(ct).ConfigureAwait(false);
149  ❌  0  ○              if (!resp.IsSuccessStatusCode)
150  ❌  0                 {
151  ❌  0                     throw new InvalidOperationException($"Token refresh failed: {payload}");
152                        }
153            
154  ❌  0                 var tp = JsonSerializer.Deserialize<TokenPayload>(payload);
155  ❌  0  ○              if (tp == null || string.IsNullOrWhiteSpace(tp.AccessToken)) throw new InvalidOperationException("Token refr
156            
157  ❌  0  ○              return new TokenResponse
158  ❌  0                 {
159  ❌  0                     AccessToken = tp.AccessToken,
160  ❌  0                     RefreshToken = tp.RefreshToken ?? account.RefreshToken,
161  ❌  0                     ExpiresInSeconds = tp.ExpiresIn,
162  ❌  0                 };
163  ❌  0             }
164            
165                    private async Task<TokenResponse> ExchangeCodeForTokenAsync(string code, string verifier, CancellationToken ct)
166  ❌  0             {
167  ❌  0                 using var http = _httpClientFactory.CreateClient();
168  ❌  0                 using var content = new FormUrlEncodedContent(new Dictionary<string, string>
169  ❌  0                 {
170  ❌  0                     ["client_id"] = _settings.ClientId,
171  ❌  0                     ["client_secret"] = _settings.ClientSecret,
172  ❌  0                     ["code"] = code,
173  ❌  0                     ["grant_type"] = "authorization_code",
174  ❌  0                     ["redirect_uri"] = "urn:ietf:wg:oauth:2.0:oob",
175  ❌  0                     ["code_verifier"] = verifier
176  ❌  0                 });
177            
178  ❌  0                 using var resp = await http.PostAsync(TokenEndpoint, content, ct).ConfigureAwait(false);
179  ❌  0                 var payload = await resp.Content.ReadAsStringAsync(ct).ConfigureAwait(false);
180  ❌  0  ○              if (!resp.IsSuccessStatusCode) throw new InvalidOperationException($"Token exchange failed: {payload}");
181            
182  ❌  0                 var tp = JsonSerializer.Deserialize<TokenPayload>(payload);
183  ❌  0  ○              if (tp == null || string.IsNullOrWhiteSpace(tp.AccessToken) || string.IsNullOrWhiteSpace(tp.RefreshToken))
184  ❌  0                     throw new InvalidOperationException("Token exchange failed: missing tokens");
185            
186  ❌  0                 return new TokenResponse
187  ❌  0                 {
188  ❌  0                     AccessToken = tp.AccessToken,
189  ❌  0                     RefreshToken = tp.RefreshToken,
190  ❌  0                     ExpiresInSeconds = tp.ExpiresIn
191  ❌  0                 };
192  ❌  0             }
193            
194                    private async Task<string> FetchUserEmailAsync(string accessToken, CancellationToken ct)
195  ❌  0             {
196  ❌  0                 using var http = _httpClientFactory.CreateClient();
197  ❌  0                 using var req = new HttpRequestMessage(HttpMethod.Get, UserInfoEndpoint);
198  ❌  0                 req.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
199  ❌  0                 using var resp = await http.SendAsync(req, ct).ConfigureAwait(false);
200  ❌  0  ○              if (!resp.IsSuccessStatusCode) return string.Empty;
201  ❌  0                 var payload = await resp.Content.ReadAsStringAsync(ct).ConfigureAwait(false);
202  ❌  0                 var ui = JsonSerializer.Deserialize<UserInfoPayload>(payload);
203  ❌  0  ○              return ui?.Email ?? string.Empty;
204  ❌  0             }
205            
206                    private async Task<string> FetchProjectIdAsync(string accessToken, CancellationToken ct)
207  ❌  0             {
208  ❌  0                 var loadHeaders = new Dictionary<string, string>
209  ❌  0                 {
210  ❌  0                     ["Authorization"] = $"Bearer {accessToken}",
211  ❌  0                     ["Content-Type"] = "application/json",
212  ❌  0                     ["User-Agent"] = "google-api-nodejs-client/9.15.1",
213  ❌  0                     ["X-Goog-Api-Client"] = "google-cloud-sdk vscode_cloudshelleditor/0.1",
214  ❌  0                     ["Client-Metadata"] = "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLATFORM_UNSPECIFIED\",\"pluginTy
215  ❌  0                 };
216            
217  ❌  0                 var endpoints = new List<string>(LoadEndpoints);
218  ❌  0                 endpoints.AddRange(FallbackEndpoints);
219  ❌  0  ○              foreach (var endpoint in endpoints)
220  ❌  0                 {
221  ❌  0                     var url = $"{endpoint}/v1internal:loadCodeAssist";
222                            try
223  ❌  0                     {
224  ❌  0                         using var http = _httpClientFactory.CreateClient();
225  ❌  0                         using var request = new HttpRequestMessage(HttpMethod.Post, url);
226  ❌  0  ○                      foreach (var header in loadHeaders)
227  ❌  0                         {
228  ❌  0  ○                          if (header.Key == "Authorization")
229  ❌  0                             {
230  ❌  0                                 request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
231  ❌  0                             }
232                                    else
233  ❌  0                             {
234  ❌  0                                 request.Headers.TryAddWithoutValidation(header.Key, header.Value);
235  ❌  0                             }
236  ❌  0                         }
237            
238  ❌  0                         request.Content = new StringContent("{\"metadata\":{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"P
239  ❌  0                         using var resp = await http.SendAsync(request, ct).ConfigureAwait(false);
240  ❌  0  ○                      if (!resp.IsSuccessStatusCode) continue;
241  ❌  0                         var payload = await resp.Content.ReadAsStringAsync(ct).ConfigureAwait(false);
242  ❌  0                         var projectId = ExtractProjectId(payload);
243  ❌  0  ○                      if (!string.IsNullOrWhiteSpace(projectId)) return projectId;
244  ❌  0                     }
245  ❌  0                     catch (Exception ex)
246  ❌  0                     {
247  ❌  0                         _logger.LogDebug(ex, "Failed to probe endpoint {Endpoint}", endpoint);
248  ❌  0                     }
249  ❌  0                 }
250            
251  ❌  0                 return string.Empty;
252  ❌  0             }
253            
254                    private static string BuildQueryString(IDictionary<string, string> parameters)
255  ❌  0             {
256  ❌  0                 return string.Join("&", System.Linq.Enumerable.Select(parameters, kvp => $"{Uri.EscapeDataString(kvp.Key)}={
257  ❌  0             }
258            
259                    private static string GenerateCodeVerifier()
260  ❌  0             {
261  ❌  0                 var bytes = new byte[32];
262  ❌  0                 RandomNumberGenerator.Fill(bytes);
263  ❌  0                 return Base64UrlEncode(bytes);
264  ❌  0             }
265            
266                    private static string GenerateCodeChallenge(string verifier)
267  ❌  0             {
268  ❌  0                 var bytes = Encoding.ASCII.GetBytes(verifier);
269  ❌  0                 var hash = SHA256.HashData(bytes);
270  ❌  0                 return Base64UrlEncode(hash);
271  ❌  0             }
272            
273                    private static string Base64UrlEncode(byte[] bytes)
274  ❌  0             {
275  ❌  0                 return Convert.ToBase64String(bytes).TrimEnd('=').Replace('+', '-').Replace('/', '_');
276  ❌  0             }
277            
278                    private static string EncodeState(PkceState state)
279  ❌  0             {
280  ❌  0                 var json = JsonSerializer.Serialize(state);
281  ❌  0                 return Base64UrlEncode(Encoding.UTF8.GetBytes(json));
282  ❌  0             }
283            
284                    private static PkceState DecodeState(string state)
285  ❌  0             {
286  ❌  0                 var json = Encoding.UTF8.GetString(Base64UrlDecode(state));
287  ❌  0                 var parsed = JsonSerializer.Deserialize<PkceState>(json);
288  ❌  0  ○              if (parsed == null || string.IsNullOrWhiteSpace(parsed.Verifier)) throw new InvalidOperationException("Missi
289  ❌  0  ○              parsed.ProjectId ??= string.Empty;
290  ❌  0                 return parsed;
291  ❌  0             }
292            
293                    private static byte[] Base64UrlDecode(string input)
294  ❌  0             {
295  ❌  0                 var normalized = input.Replace('-', '+').Replace('_', '/');
296  ❌  0                 var padded = normalized.PadRight(normalized.Length + (4 - normalized.Length % 4) % 4, '=');
297  ❌  0                 return Convert.FromBase64String(padded);
298  ❌  0             }
299            
300                    private static string ExtractProjectId(string payload)
301  ❌  0             {
302                        try
303  ❌  0                 {
304  ❌  0                     using var doc = JsonDocument.Parse(payload);
305  ❌  0  ○                  if (doc.RootElement.TryGetProperty("cloudaicompanionProject", out var projectElement))
306  ❌  0                     {
307  ❌  0  ○                      if (projectElement.ValueKind == JsonValueKind.String) return projectElement.GetString() ?? string.Em
308  ❌  0  ○                      if (projectElement.ValueKind == JsonValueKind.Object && projectElement.TryGetProperty("id", out var 
309  ❌  0                     }
310  ❌  0                 }
311  ❌  0                 catch (JsonException) { }
312            
313  ❌  0                 return string.Empty;
314  ❌  0             }
315            
316                    private sealed class PkceState
317                    {
318  ❌  0                 [JsonPropertyName("verifier")] public string Verifier { get; set; } = string.Empty;
319  ❌  0                 [JsonPropertyName("projectId")] public string? ProjectId { get; set; }
320                    }
321            
322                    private sealed class TokenPayload
323                    {
324  ❌  0                 [JsonPropertyName("access_token")] public string AccessToken { get; set; } = string.Empty;
325  ❌  0                 [JsonPropertyName("expires_in")] public int ExpiresIn { get; set; }
326  ❌  0                 [JsonPropertyName("refresh_token")] public string? RefreshToken { get; set; }
327                    }
328            
329                    private sealed class UserInfoPayload
330                    {
331  ❌  0                 [JsonPropertyName("email")] public string? Email { get; set; }
332                    }
333                }
334            }
```
# Synaxis.InferenceGateway.Infrastructure.Jobs.ModelsDevSyncJob

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Jobs.ModelsDevSyncJob |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Jobs/ModelsDevSyncJob.cs |
| **Line coverage:** | 90.9% (50 of 55) |
| Covered lines: | 50 |
| Uncovered lines: | 5 |
| Coverable lines: | 55 |
| Total lines: | 93 |
| **Branch coverage:** | 66.6% (36 of 54) |
| Covered branches: | 36 |
| Total branches: | 54 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **Truncate(...)** | 50.0% | 4 | 4 | 80.0% |
| **Execute()** | 68.00% | 52 | 50 | 91.11% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Jobs/ModelsDevSyncJob.cs
```
 1               using System;
 2               using System.Linq;
 3               using System.Threading;
 4               using System.Threading.Tasks;
 5               using Microsoft.Extensions.DependencyInjection;
 6               using Microsoft.Extensions.Logging;
 7               using Quartz;
 8               using Synaxis.InferenceGateway.Infrastructure.External.ModelsDev;
 9               using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
10               using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
11               
12               namespace Synaxis.InferenceGateway.Infrastructure.Jobs;
13               
14               public class ModelsDevSyncJob : IJob
15               {
16                   private readonly IServiceProvider _provider;
17                   private readonly ILogger<ModelsDevSyncJob> _logger;
18               
19  ✔     37         public ModelsDevSyncJob(IServiceProvider provider, ILogger<ModelsDevSyncJob> logger)
20  ✔     37         {
21  ✔     37             _provider = provider;
22  ✔     37             _logger = logger;
23  ✔     37         }
24               
25                   private string Truncate(string? value, int maxLength)
26  ✔  32086         {
27  ✓  32086  ◑          if (value == null) return string.Empty;
28  ✓  64172  ◑          if (value.Length <= maxLength) return value;
29  ❌     0             return value.Substring(0, maxLength);
30  ✔  32086         }
31               
32                   public async Task Execute(IJobExecutionContext context)
33  ✔     37         {
34  ✔     37             using var scope = _provider.CreateScope();
35  ✔     37             var client = scope.ServiceProvider.GetRequiredService<IModelsDevClient>();
36  ✔     37             var ct = CancellationToken.None;
37               
38  ✔     37             var models = await client.GetAllModelsAsync(ct).ConfigureAwait(false);
39  ✓     37  ◑          if (models == null || models.Count == 0) return;
40               
41  ✔     37             var db = scope.ServiceProvider.GetRequiredService<ControlPlaneDbContext>();
42               
43  ✔  32213  ●          foreach (var m in models)
44  ✔  16074             {
45  ✔  16074  ●              if (string.IsNullOrEmpty(m.id)) continue;
46               
47  ✔  16074                 var existing = await db.GlobalModels.FindAsync(new object[] { m.id }, ct).ConfigureAwait(false);
48  ✔  16043  ●              if (existing == null)
49  ✔  11119                 {
50  ✔  11119                     existing = new GlobalModel { Id = m.id! };
51  ✔  11119                     db.GlobalModels.Add(existing);
52  ✔  11119                 }
53               
54  ✓  16043  ◑              existing.Name = Truncate(m.name ?? m.id, 200);
55  ✔  16043  ●              existing.Family = Truncate(m.family ?? "unknown", 200);
56               
57  ✓  16043  ◑              existing.ContextWindow = m.limit?.context ?? existing.ContextWindow;
58  ✓  16043  ◑              existing.MaxOutputTokens = m.limit?.output ?? existing.MaxOutputTokens;
59               
60  ✔  16043  ●              existing.InputPrice = m.cost?.input ?? existing.InputPrice;
61  ✔  16043  ●              existing.OutputPrice = m.cost?.output ?? existing.OutputPrice;
62               
63  ✓  16043  ◑              existing.IsOpenWeights = m.open_weights ?? existing.IsOpenWeights;
64               
65                           // Capabilities
66  ✓  16043  ◑              existing.SupportsTools = m.tool_call ?? existing.SupportsTools;
67  ✓  16043  ◑              existing.SupportsReasoning = m.reasoning ?? existing.SupportsReasoning;
68  ✔  16043  ●              existing.SupportsStructuredOutput = m.structured_output ?? existing.SupportsStructuredOutput;
69               
70  ✓  16043  ◑              var inputs = m.modalities?.input ?? Array.Empty<string>();
71  ✔  16043                 existing.SupportsVision = inputs.Contains("image", StringComparer.OrdinalIgnoreCase);
72  ✔  16043                 existing.SupportsAudio = inputs.Contains("audio", StringComparer.OrdinalIgnoreCase);
73               
74                           // Release date parsing - ensure stored DateTime is UTC so PostgreSQL 'timestamptz' accepts it
75  ✔  16043  ●              if (!string.IsNullOrEmpty(m.release_date))
76  ✔  16043                 {
77  ✔  16043  ●                  if (DateTime.TryParse(m.release_date, out var dt))
78  ✔  16043                         existing.ReleaseDate = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
79  ✔  16043                 }
80  ✔  16043             }
81               
82                       try
83  ✔      1             {
84  ✔      1                 await db.SaveChangesAsync(ct).ConfigureAwait(false);
85  ✔      1                 _logger.LogInformation("ModelsDevSyncJob: synced {Count} models", models.Count);
86  ✔      1                 _logger.LogInformation("ModelsDevSyncJob: Successfully upserted {Count} global models", models.Count);
87  ✔      1             }
88  ❌     0             catch (Exception ex)
89  ❌     0             {
90  ❌     0  ○              _logger.LogError(ex, "ModelsDevSyncJob: failed to save changes: {Message}", ex.InnerException?.Message ?? ex
91  ❌     0             }
92  ✔      1         }
93               }
```
# Synaxis.InferenceGateway.Infrastructure.Jobs.ProviderDiscoveryJob

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Jobs.ProviderDiscoveryJob |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Jobs/ProviderDiscoveryJob.cs |
| **Line coverage:** | 73.2% (107 of 146) |
| Covered lines: | 107 |
| Uncovered lines: | 39 |
| Coverable lines: | 146 |
| Total lines: | 221 |
| **Branch coverage:** | 80.5% (95 of 118) |
| Covered branches: | 95 |
| Total branches: | 118 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **GetEffectiveBaseUrl(...)** | 81.11% | 274 | 90 | 71.69% |
| **Execute()** | 78.57% | 44 | 28 | 72.72% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Jobs/ProviderDiscoveryJob.cs
```
  1              using System;
  2              using System.Linq;
  3              using System.Threading;
  4              using System.Threading.Tasks;
  5              using Microsoft.Extensions.DependencyInjection;
  6              using Microsoft.Extensions.Logging;
  7              using Microsoft.Extensions.Options;
  8              using Quartz;
  9              using Synaxis.InferenceGateway.Application.Configuration;
 10              using Synaxis.InferenceGateway.Infrastructure.External.OpenAi;
 11              using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 12              using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 13              
 14              namespace Synaxis.InferenceGateway.Infrastructure.Jobs
 15              {
 16                  public class ProviderDiscoveryJob : IJob
 17                  {
 18                      private readonly IServiceProvider _provider;
 19                      private readonly ILogger<ProviderDiscoveryJob> _logger;
 20              
 21  ✔    37             public ProviderDiscoveryJob(IServiceProvider provider, ILogger<ProviderDiscoveryJob> logger)
 22  ✔    37             {
 23  ✔    37                 _provider = provider;
 24  ✔    37                 _logger = logger;
 25  ✔    37             }
 26              
 27                      private static string GetEffectiveBaseUrl(ProviderConfig config, string providerKey)
 28  ✔   690             {
 29  ✓   690  ◑              if (config == null) return string.Empty;
 30              
 31                          // Prefer explicit endpoint if provided
 32  ✔   690                 var url = config.Endpoint;
 33              
 34                          // If no explicit endpoint, allow fallback endpoint before using type defaults
 35  ✓   690  ◑              if (string.IsNullOrWhiteSpace(url) && !string.IsNullOrWhiteSpace(config.FallbackEndpoint))
 36  ❌    0                 {
 37  ❌    0                     url = config.FallbackEndpoint;
 38  ❌    0                 }
 39              
 40                          // If still empty, choose defaults based on provider type
 41  ✔   690  ●              if (string.IsNullOrWhiteSpace(url))
 42  ✔   468                 {
 43  ✓   468  ◑                  var type = config.Type ?? string.Empty;
 44  ✓   468  ◕                  switch (type.Trim().ToLowerInvariant())
 45                              {
 46                                  case "nvidia":
 47  ✔    37                             url = "https://integrate.api.nvidia.com";
 48  ✔    37                             break;
 49                                  case "huggingface":
 50  ✔    37                             url = "https://router.huggingface.co";
 51  ✔    37                             break;
 52                                  case "groq":
 53  ✔    37                             url = "https://api.groq.com/openai";
 54  ✔    37                             break;
 55                                  case "openrouter":
 56  ✔    37                             url = "https://openrouter.ai/api";
 57  ✔    37                             break;
 58                                  case "deepseek":
 59  ❌    0                             url = "https://api.deepseek.com";
 60  ❌    0                             break;
 61                                  case "openai":
 62  ✔     1                             url = "https://api.openai.com";
 63  ✔     1                             break;
 64                                  case "cohere":
 65  ✔    37                             url = "https://api.cohere.com/v2";
 66  ✔    37                             break;
 67                                  case "duckduckgo":
 68  ✔    37                             url = "https://duckduckgo.com/duckchat/v1";
 69  ✔    37                             break;
 70                                  case "aihorde":
 71  ✔    37                             url = "https://stablehorde.net/api/v2";
 72  ✔    37                             break;
 73                                  case "siliconflow":
 74  ❌    0                             url = "https://api.siliconflow.cn/v1";
 75  ❌    0                             break;
 76                                  case "sambanova":
 77  ❌    0                             url = "https://api.sambanova.ai/v1";
 78  ❌    0                             break;
 79                                  case "zai":
 80  ❌    0                             url = "https://open.bigmodel.cn/api/paas/v4";
 81  ❌    0                             break;
 82                                  case "hyperbolic":
 83  ❌    0                             url = "https://api.hyperbolic.xyz/v1";
 84  ❌    0                             break;
 85                                  case "githubmodels":
 86  ❌    0                             url = "https://models.inference.ai.azure.com";
 87  ❌    0                             break;
 88                                  case "pollinations":
 89  ✔    37                             url = "https://text.pollinations.ai";
 90  ✔    37                             break;
 91                                  case "kilocode":
 92  ✔    34                             url = "https://api.kilocode.ai";
 93  ✔    34                             break;
 94                                  default:
 95                                      // Unknown type and no endpoint provided
 96  ✔   137                             return string.Empty;
 97                              }
 98  ✔   331                 }
 99              
100                          // Clean up trailing /v1 if present. Many discovery clients append /v1/models.
101  ✔   553                 url = url.Trim();
102  ✔   553                 url = url.TrimEnd('/');
103  ✔   553  ●              if (url.EndsWith("/v1", StringComparison.OrdinalIgnoreCase))
104  ✔   185                 {
105  ✔   185                     url = url.Substring(0, url.Length - "/v1".Length);
106  ✔   185                 }
107              
108  ✔   553                 return url;
109  ✔   690             }
110              
111                      public async Task Execute(IJobExecutionContext context)
112  ✔    37             {
113  ✔    37                 using var scope = _provider.CreateScope();
114  ✔    37                 var config = scope.ServiceProvider.GetRequiredService<IOptions<SynaxisConfiguration>>().Value;
115  ✔    37                 var db = scope.ServiceProvider.GetRequiredService<ControlPlaneDbContext>();
116  ✔    37                 var discovery = scope.ServiceProvider.GetRequiredService<IOpenAiModelDiscoveryClient>();
117              
118  ✔  1493  ●              foreach (var kv in config.Providers)
119  ✔   691                 {
120  ✔   691                     var providerKey = kv.Key;
121  ✔   691                     var providerCfg = kv.Value;
122              
123  ✔   692  ●                  if (!providerCfg.Enabled) continue;
124              
125                              // Skip antigravity for now
126  ✔   690  ●                  if (string.Equals(providerCfg.Type, "antigravity", StringComparison.OrdinalIgnoreCase)) continue;
127              
128  ✔   690  ●                  var apiKey = providerCfg.Key ?? string.Empty;
129              
130                              try
131  ✔   690                     {
132  ✔   690                         var ct = CancellationToken.None;
133  ✔   690                         var baseUrl = GetEffectiveBaseUrl(providerCfg, providerKey);
134  ✔   690  ●                      if (string.IsNullOrWhiteSpace(baseUrl))
135  ✔   137                         {
136  ✔   137                             _logger.LogWarning("No effective base URL could be determined for provider {Provider}", provider
137  ✔   137                             continue;
138                                  }
139              
140  ✔   553                         var models = await discovery.GetModelsAsync(baseUrl, apiKey, ct).ConfigureAwait(false);
141  ✓   478  ◑                      var discoveredModels = models?.ToList() ?? new System.Collections.Generic.List<string>();
142              
143  ✔  6696  ●                      foreach (var found in discoveredModels)
144  ✔  2716                         {
145  ✔  2716  ●                          if (string.IsNullOrEmpty(found)) continue;
146              
147                                      // Fuzzy match global model
148  ✔  2716                             var global = db.GlobalModels.FirstOrDefault(g => g.Id == found || (found.Contains(g.Id)));
149  ✔  2570  ●                          if (global == null)
150  ✔   501                             {
151                                          // Create minimal global model
152  ✔   501                                 global = new GlobalModel { Id = found, Name = found, Family = "unknown" };
153  ✔   501                                 db.GlobalModels.Add(global);
154                                          try
155  ✔   501                                 {
156  ✔   501                                     await db.SaveChangesAsync().ConfigureAwait(false);
157  ✔   478                                 }
158  ❌    0                                 catch (Npgsql.PostgresException ex) when (ex.SqlState == "23505")
159  ❌    0                                 {
160  ❌    0                                     db.ChangeTracker.Clear();
161  ❌    0                                     var reloadedGlobal = db.GlobalModels.FirstOrDefault(g => g.Id == found);
162  ❌    0  ○                                  if (reloadedGlobal != null)
163  ❌    0                                     {
164  ❌    0                                         global = reloadedGlobal;
165  ❌    0                                     }
166  ❌    0                                 }
167  ✔   478                             }
168              
169                                      // Upsert ProviderModel
170  ✔  2547                             var existing = db.ProviderModels.FirstOrDefault(p => p.ProviderId == providerKey && p.ProviderSp
171  ✔  2546  ●                          if (existing == null)
172  ✔  1011                             {
173                                          try
174  ✔  1011                                 {
175  ✔  1011                                     existing = new ProviderModel
176  ✔  1011                                     {
177  ✔  1011                                         ProviderId = providerKey,
178  ✔  1011                                         ProviderSpecificId = found,
179  ✔  1011                                         GlobalModelId = global.Id,
180  ✔  1011                                         IsAvailable = true
181  ✔  1011                                     };
182  ✔  1011                                     db.ProviderModels.Add(existing);
183  ✔  1011                                     await db.SaveChangesAsync().ConfigureAwait(false);
184  ✔  1011                                 }
185  ❌    0                                 catch (Npgsql.PostgresException ex) when (ex.SqlState == "23505")
186  ❌    0                                 {
187  ❌    0                                     db.ChangeTracker.Clear();
188  ❌    0                                     var reloadedExisting = db.ProviderModels.FirstOrDefault(p => p.ProviderId == providerKey
189  ❌    0  ○                                  if (reloadedExisting != null)
190  ❌    0                                     {
191  ❌    0                                         reloadedExisting.IsAvailable = true;
192  ❌    0                                         reloadedExisting.GlobalModelId = global.Id;
193  ❌    0                                         await db.SaveChangesAsync().ConfigureAwait(false);
194  ❌    0                                     }
195  ❌    0                                 }
196  ✔  1011                             }
197                                      else
198  ✔  1535                             {
199  ✔  1535                                 existing.IsAvailable = true;
200  ✔  1535                                 existing.GlobalModelId = global.Id;
201                                          try
202  ✔  1535                                 {
203  ✔  1535                                     await db.SaveChangesAsync().ConfigureAwait(false);
204  ✔  1535                                 }
205  ❌    0                                 catch (Npgsql.PostgresException ex) when (ex.SqlState == "23505")
206  ❌    0                                 {
207  ❌    0                                     db.ChangeTracker.Clear();
208  ❌    0                                 }
209  ✔  1535                             }
210  ✔  2546                         }
211              
212  ✔   308                         _logger.LogInformation("ProviderDiscoveryJob: Successfully upserted {Count} models for provider {Pro
213  ✔   308                     }
214  ✔   245                     catch (Exception ex)
215  ✔   245                     {
216  ✔   245                         _logger.LogError(ex, "Error discovering models for provider {Provider}", providerKey);
217  ✔   245                     }
218  ✔   553                 }
219  ✔    37             }
220                  }
221              }
```
# Synaxis.InferenceGateway.Infrastructure.Part

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Part |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Text()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.IO;
  4            using System.Linq;
  5            using System.Net.Http;
  6            using System.Net.Http.Headers;
  7            using System.Runtime.CompilerServices;
  8            using System.Text;
  9            using System.Text.Json;
 10            using System.Text.Json.Serialization;
 11            using System.Threading;
 12            using System.Threading.Tasks;
 13            using Microsoft.Extensions.AI;
 14            using Synaxis.InferenceGateway.Infrastructure.Auth;
 15            
 16            namespace Synaxis.InferenceGateway.Infrastructure;
 17            
 18            /// <summary>
 19            /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20            /// Implements strict protocol compliance including the wrapper object and custom headers.
 21            /// </summary>
 22            public class AntigravityChatClient : IChatClient
 23            {
 24                private readonly HttpClient _httpClient;
 25                private readonly string _modelId;
 26                private readonly string _projectId;
 27                private readonly ITokenProvider _tokenProvider;
 28                private readonly ChatClientMetadata _metadata;
 29            
 30                // Endpoints are now relative to the configured HttpClient.BaseAddress
 31                private const string EndpointRelative = "/v1/chat/completions";
 32                private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33            
 34                public AntigravityChatClient(
 35                    HttpClient httpClient,
 36                    string modelId,
 37                    string projectId,
 38                    ITokenProvider tokenProvider)
 39                {
 40                    _httpClient = httpClient;
 41                    _modelId = modelId;
 42                    _projectId = projectId;
 43                    _tokenProvider = tokenProvider;
 44                    // Prefer the configured BaseAddress on the provided HttpClient when available
 45                    _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46                }
 47            
 48                public ChatClientMetadata Metadata => _metadata;
 49            
 50                public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51                {
 52                    var messagesList = chatMessages.ToList();
 53                    var request = BuildRequest(messagesList, options);
 54                    var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55            
 56                    using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                    httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58            
 59                    await PrepareRequestAsync(httpRequest, cancellationToken);
 60            
 61                    using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                    await EnsureSuccessAsync(response);
 63            
 64                    var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                    var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66            
 67                    return MapResponse(agResponse?.Response);
 68                }
 69            
 70                public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                    IEnumerable<ChatMessage> chatMessages,
 72                    ChatOptions? options = null,
 73                    [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74                {
 75                    var messagesList = chatMessages.ToList();
 76                    var request = BuildRequest(messagesList, options);
 77                    var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78            
 79                    using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                    httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                    httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82            
 83                    await PrepareRequestAsync(httpRequest, cancellationToken);
 84            
 85                    using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                    await EnsureSuccessAsync(response);
 87            
 88                    using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                    using var reader = new StreamReader(stream);
 90            
 91                    while (!cancellationToken.IsCancellationRequested)
 92                    {
 93                        var line = await reader.ReadLineAsync(cancellationToken);
 94                        if (line == null) break; // End of stream
 95                        if (string.IsNullOrWhiteSpace(line)) continue;
 96            
 97                        if (line.StartsWith("data: "))
 98                        {
 99                            var data = line.Substring(6).Trim();
100                            if (data == "[DONE]") break;
101            
102                            AntigravityResponseWrapper? wrapper = null;
103                            try
104                            {
105                                wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                            }
107                            catch (JsonException) { /* Ignore malformed lines */ }
108            
109                            if (wrapper?.Response?.Candidates != null)
110                            {
111                                foreach (var candidate in wrapper.Response.Candidates)
112                                {
113                                    if (candidate.Content?.Parts != null)
114                                    {
115                                        foreach (var part in candidate.Content.Parts)
116                                        {
117                                            if (!string.IsNullOrEmpty(part.Text))
118                                            {
119                                                yield return new ChatResponseUpdate
120                                                {
121                                                    Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                    Contents = { new TextContent(part.Text) }
123                                                };
124                                            }
125                                        }
126                                    }
127                                }
128                            }
129                        }
130                    }
131                }
132            
133                private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134                {
135                    var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137            
138                    // Strict Headers required by Antigravity
139                    request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                    request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                    request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142                }
143            
144                private async Task EnsureSuccessAsync(HttpResponseMessage response)
145                {
146                    if (!response.IsSuccessStatusCode)
147                    {
148                        var error = await response.Content.ReadAsStringAsync();
149                        throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                    }
151                }
152            
153                private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154                {
155                    var contentList = new List<Content>();
156                    SystemInstruction? systemInstruction = null;
157            
158                    foreach (var msg in messages)
159                    {
160                        if (msg.Role == ChatRole.System)
161                        {
162                            // Antigravity requires system instructions in a separate field, not in contents
163                            if (systemInstruction == null)
164                            {
165                                systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                            }
167                            systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                        }
169                        else
170                        {
171                            var role = msg.Role == ChatRole.User ? "user" : "model";
172                            contentList.Add(new Content
173                            {
174                                Role = role,
175                                Parts = new List<Part> { new Part { Text = msg.Text } }
176                            });
177                        }
178                    }
179            
180                    var config = new GenerationConfig
181                    {
182                        MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                        Temperature = options?.Temperature ?? 0.7f,
184                        TopP = options?.TopP ?? 0.95f,
185                        StopSequences = options?.StopSequences
186                    };
187            
188                    // Handle Thinking Config
189                    if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                    {
191                         // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                         // For now, we'll try to extract budget if present, or default
193                         if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                         {
195                             // Simple extraction logic or default
196                             config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                         }
198                    }
199            
200                    return new AntigravityRequest
201                    {
202                        Project = _projectId,
203                        Model = _modelId,
204                        RequestPayload = new RequestPayload
205                        {
206                            Contents = contentList,
207                            SystemInstruction = systemInstruction,
208                            GenerationConfig = config
209                        }
210                    };
211                }
212            
213                private ChatResponse MapResponse(AntigravityResponse? response)
214                {
215                    if (response?.Candidates == null || response.Candidates.Count == 0)
216                        return new ChatResponse(new List<ChatMessage>());
217            
218                    var candidate = response.Candidates[0];
219                    var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220            
221                    return new ChatResponse(new List<ChatMessage>
222                    {
223                        new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                    })
225                    {
226                        ResponseId = response.ResponseId,
227                        ModelId = response.ModelVersion
228                    };
229                }
230            
231                // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232                public void Dispose() { }
233                public object? GetService(Type serviceType, object? serviceKey = null) =>
234                    serviceType == typeof(IChatClient) ? this : null;
235            }
236            
237            internal class AntigravityRequest
238            {
239                [JsonPropertyName("project")] public string Project { get; set; } = "";
240                [JsonPropertyName("model")] public string Model { get; set; } = "";
241                [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242            }
243            
244            internal class RequestPayload
245            {
246                [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247                [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248                [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249            }
250            
251            internal class Content
252            {
253                [JsonPropertyName("role")] public string Role { get; set; } = "user";
254                [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255            }
256            
257            internal class SystemInstruction
258            {
259                [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260            }
261            
262            internal class Part
263            {
264  ✔  14         [JsonPropertyName("text")] public string? Text { get; set; }
265            }
266            
267            internal class GenerationConfig
268            {
269                [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270                [JsonPropertyName("temperature")] public float Temperature { get; set; }
271                [JsonPropertyName("topP")] public float TopP { get; set; }
272                [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273                [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274            }
275            
276            internal class ThinkingConfig
277            {
278                [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279                [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280            }
281            
282            internal class AntigravityResponseWrapper
283            {
284                [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285            }
286            
287            internal class AntigravityResponse
288            {
289                [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290                [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291                [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292            }
293            
294            internal class Candidate
295            {
296                [JsonPropertyName("content")] public Content? Content { get; set; }
297                [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298            }
299            
300            [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301            [JsonSerializable(typeof(AntigravityRequest))]
302            [JsonSerializable(typeof(AntigravityResponseWrapper))]
303            internal partial class AntigravityJsonContext : JsonSerializerContext
304            {
305            }
```
# Synaxis.InferenceGateway.Infrastructure.PollinationsChatClient

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.PollinationsChatClient |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/PollinationsChatClient.cs |
| **Line coverage:** | 82.6% (57 of 69) |
| Covered lines: | 57 |
| Uncovered lines: | 12 |
| Coverable lines: | 69 |
| Total lines: | 113 |
| **Branch coverage:** | 75% (12 of 16) |
| Covered branches: | 12 |
| Total branches: | 16 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 2 | 100% |
| **get_Metadata()** | 100% | 1 | 1 | 100% |
| **GetResponseAsync()** | 100% | 1 | 1 | 100% |
| **GetStreamingResponseAsync()** | 87.50% | 11 | 8 | 62.96% |
| **CreateRequest(...)** | 50.0% | 6 | 6 | 91.66% |
| **Dispose()** | 100% | 1 | 1 | 100% |
| **GetService(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/PollinationsChatClient.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using System.Net.Http;
  4            using System.Net.Http.Json;
  5            using System.Runtime.CompilerServices;
  6            using System.Text;
  7            using System.Text.Json;
  8            using System.Text.Json.Serialization;
  9            using System.Threading;
 10            using System.Threading.Tasks;
 11            using Microsoft.Extensions.AI;
 12            
 13            namespace Synaxis.InferenceGateway.Infrastructure;
 14            
 15            public class PollinationsChatClient : IChatClient
 16            {
 17                private readonly HttpClient _httpClient;
 18                private readonly string _modelId;
 19                private readonly ChatClientMetadata _metadata;
 20            
 21  ✔  17         public PollinationsChatClient(HttpClient httpClient, string? modelId = null)
 22  ✔  17         {
 23  ✔  17             _httpClient = httpClient;
 24  ✔  17  ●          _modelId = modelId ?? "openai";
 25  ✔  17             _metadata = new ChatClientMetadata("Pollinations", new Uri("https://text.pollinations.ai/"), _modelId);
 26  ✔  17         }
 27            
 28  ✔   6         public ChatClientMetadata Metadata => _metadata;
 29            
 30                public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 31  ✔   5         {
 32  ✔   5             var request = CreateRequest(chatMessages, options, stream: false);
 33  ✔   5             var response = await _httpClient.PostAsJsonAsync("https://text.pollinations.ai/", request, cancellationToken);
 34  ✔   5             response.EnsureSuccessStatusCode();
 35            
 36  ✔   4             var content = await response.Content.ReadAsStringAsync(cancellationToken);
 37            
 38  ✔   4             var chatResponse = new ChatResponse(new ChatMessage(ChatRole.Assistant, content));
 39  ✔   4             chatResponse.ModelId = _modelId;
 40  ✔   4             return chatResponse;
 41  ✔   4         }
 42            
 43                public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(IEnumerable<ChatMessage> chatMessages, C
 44  ✔   4         {
 45  ✔   4             var request = CreateRequest(chatMessages, options, stream: true);
 46            
 47  ✔   4             var httpRequest = new HttpRequestMessage(HttpMethod.Post, "https://text.pollinations.ai/")
 48  ✔   4             {
 49  ✔   4                 Content = JsonContent.Create(request)
 50  ✔   4             };
 51            
 52  ✔   4  ●          using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 53  ✔   4             response.EnsureSuccessStatusCode();
 54            
 55  ✔   3  ●          using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 56  ✔   3             using var reader = new System.IO.StreamReader(stream);
 57            
 58                    // Pollinations streaming is just raw text updates if I recall correctly,
 59                    // but if we use the POST endpoint it might be different.
 60                    // Actually, Pollinations POST endpoint with stream: true returns SSE if requested,
 61                    // but often it just returns chunks of text.
 62            
 63  ✔   3             char[] buffer = new char[1024];
 64                    string? line;
 65  ✔   5  ●          while ((line = await reader.ReadLineAsync()) is not null)
 66  ✔   2             {
 67  ✔   2                 int read = await reader.ReadAsync(buffer, 0, buffer.Length);
 68  ✓   2  ◑              if (read > 0)
 69  ❌  0                 {
 70  ❌  0                     var text = new string(buffer, 0, read);
 71  ❌  0                     var update = new ChatResponseUpdate
 72  ❌  0                     {
 73  ❌  0                         Role = ChatRole.Assistant,
 74  ❌  0                         ModelId = _modelId
 75  ❌  0                     };
 76  ❌  0                     update.Contents.Add(new TextContent(text));
 77  ❌  0                     yield return update;
 78  ❌  0                 }
 79  ✔   2             }
 80  ✔   3         }
 81            
 82                private object CreateRequest(IEnumerable<ChatMessage> chatMessages, ChatOptions? options, bool stream)
 83  ✔   9         {
 84  ✔   9             var messages = new List<object>();
 85  ✔  51  ●          foreach (var msg in chatMessages)
 86  ✔  12             {
 87  ✔  12                 messages.Add(new
 88  ✔  12                 {
 89  ✔  12                     role = msg.Role.Value,
 90  ✔  12                     content = msg.Text
 91  ✔  12                 });
 92  ✔  12             }
 93            
 94                    // Map standard model names to Pollinations aliases
 95  ✓   9  ○          var model = _modelId switch
 96  ✔   9             {
 97  ✔   9                 "gpt-4o-mini" => "openai",
 98  ❌  0                 "gpt-4o" => "openai-large",
 99  ❌  0                 _ => _modelId
100  ✔   9             };
101            
102  ✔   9             return new
103  ✔   9             {
104  ✔   9                 messages = messages,
105  ✔   9                 model = model,
106  ✔   9                 stream = stream,
107  ✔   9                 seed = Random.Shared.Next() // Avoid caching
108  ✔   9             };
109  ✔   9         }
110            
111  ✔   1         public void Dispose() => _httpClient.Dispose();
112  ✔   1         public object? GetService(Type serviceType, object? serviceKey = null) => null;
113            }
```
# Synaxis.InferenceGateway.Infrastructure.RequestPayload

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.RequestPayload |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Contents()** | 100% | 1 | 1 | 100% |
| **get_SystemInstruction()** | 100% | 1 | 1 | 100% |
| **get_GenerationConfig()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.IO;
  4           using System.Linq;
  5           using System.Net.Http;
  6           using System.Net.Http.Headers;
  7           using System.Runtime.CompilerServices;
  8           using System.Text;
  9           using System.Text.Json;
 10           using System.Text.Json.Serialization;
 11           using System.Threading;
 12           using System.Threading.Tasks;
 13           using Microsoft.Extensions.AI;
 14           using Synaxis.InferenceGateway.Infrastructure.Auth;
 15           
 16           namespace Synaxis.InferenceGateway.Infrastructure;
 17           
 18           /// <summary>
 19           /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20           /// Implements strict protocol compliance including the wrapper object and custom headers.
 21           /// </summary>
 22           public class AntigravityChatClient : IChatClient
 23           {
 24               private readonly HttpClient _httpClient;
 25               private readonly string _modelId;
 26               private readonly string _projectId;
 27               private readonly ITokenProvider _tokenProvider;
 28               private readonly ChatClientMetadata _metadata;
 29           
 30               // Endpoints are now relative to the configured HttpClient.BaseAddress
 31               private const string EndpointRelative = "/v1/chat/completions";
 32               private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33           
 34               public AntigravityChatClient(
 35                   HttpClient httpClient,
 36                   string modelId,
 37                   string projectId,
 38                   ITokenProvider tokenProvider)
 39               {
 40                   _httpClient = httpClient;
 41                   _modelId = modelId;
 42                   _projectId = projectId;
 43                   _tokenProvider = tokenProvider;
 44                   // Prefer the configured BaseAddress on the provided HttpClient when available
 45                   _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46               }
 47           
 48               public ChatClientMetadata Metadata => _metadata;
 49           
 50               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51               {
 52                   var messagesList = chatMessages.ToList();
 53                   var request = BuildRequest(messagesList, options);
 54                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55           
 56                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58           
 59                   await PrepareRequestAsync(httpRequest, cancellationToken);
 60           
 61                   using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                   await EnsureSuccessAsync(response);
 63           
 64                   var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                   var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66           
 67                   return MapResponse(agResponse?.Response);
 68               }
 69           
 70               public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                   IEnumerable<ChatMessage> chatMessages,
 72                   ChatOptions? options = null,
 73                   [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74               {
 75                   var messagesList = chatMessages.ToList();
 76                   var request = BuildRequest(messagesList, options);
 77                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78           
 79                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                   httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82           
 83                   await PrepareRequestAsync(httpRequest, cancellationToken);
 84           
 85                   using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                   await EnsureSuccessAsync(response);
 87           
 88                   using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                   using var reader = new StreamReader(stream);
 90           
 91                   while (!cancellationToken.IsCancellationRequested)
 92                   {
 93                       var line = await reader.ReadLineAsync(cancellationToken);
 94                       if (line == null) break; // End of stream
 95                       if (string.IsNullOrWhiteSpace(line)) continue;
 96           
 97                       if (line.StartsWith("data: "))
 98                       {
 99                           var data = line.Substring(6).Trim();
100                           if (data == "[DONE]") break;
101           
102                           AntigravityResponseWrapper? wrapper = null;
103                           try
104                           {
105                               wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                           }
107                           catch (JsonException) { /* Ignore malformed lines */ }
108           
109                           if (wrapper?.Response?.Candidates != null)
110                           {
111                               foreach (var candidate in wrapper.Response.Candidates)
112                               {
113                                   if (candidate.Content?.Parts != null)
114                                   {
115                                       foreach (var part in candidate.Content.Parts)
116                                       {
117                                           if (!string.IsNullOrEmpty(part.Text))
118                                           {
119                                               yield return new ChatResponseUpdate
120                                               {
121                                                   Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                   Contents = { new TextContent(part.Text) }
123                                               };
124                                           }
125                                       }
126                                   }
127                               }
128                           }
129                       }
130                   }
131               }
132           
133               private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134               {
135                   var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                   request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137           
138                   // Strict Headers required by Antigravity
139                   request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                   request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                   request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142               }
143           
144               private async Task EnsureSuccessAsync(HttpResponseMessage response)
145               {
146                   if (!response.IsSuccessStatusCode)
147                   {
148                       var error = await response.Content.ReadAsStringAsync();
149                       throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                   }
151               }
152           
153               private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154               {
155                   var contentList = new List<Content>();
156                   SystemInstruction? systemInstruction = null;
157           
158                   foreach (var msg in messages)
159                   {
160                       if (msg.Role == ChatRole.System)
161                       {
162                           // Antigravity requires system instructions in a separate field, not in contents
163                           if (systemInstruction == null)
164                           {
165                               systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                           }
167                           systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                       }
169                       else
170                       {
171                           var role = msg.Role == ChatRole.User ? "user" : "model";
172                           contentList.Add(new Content
173                           {
174                               Role = role,
175                               Parts = new List<Part> { new Part { Text = msg.Text } }
176                           });
177                       }
178                   }
179           
180                   var config = new GenerationConfig
181                   {
182                       MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                       Temperature = options?.Temperature ?? 0.7f,
184                       TopP = options?.TopP ?? 0.95f,
185                       StopSequences = options?.StopSequences
186                   };
187           
188                   // Handle Thinking Config
189                   if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                   {
191                        // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                        // For now, we'll try to extract budget if present, or default
193                        if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                        {
195                            // Simple extraction logic or default
196                            config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                        }
198                   }
199           
200                   return new AntigravityRequest
201                   {
202                       Project = _projectId,
203                       Model = _modelId,
204                       RequestPayload = new RequestPayload
205                       {
206                           Contents = contentList,
207                           SystemInstruction = systemInstruction,
208                           GenerationConfig = config
209                       }
210                   };
211               }
212           
213               private ChatResponse MapResponse(AntigravityResponse? response)
214               {
215                   if (response?.Candidates == null || response.Candidates.Count == 0)
216                       return new ChatResponse(new List<ChatMessage>());
217           
218                   var candidate = response.Candidates[0];
219                   var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220           
221                   return new ChatResponse(new List<ChatMessage>
222                   {
223                       new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                   })
225                   {
226                       ResponseId = response.ResponseId,
227                       ModelId = response.ModelVersion
228                   };
229               }
230           
231               // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232               public void Dispose() { }
233               public object? GetService(Type serviceType, object? serviceKey = null) =>
234                   serviceType == typeof(IChatClient) ? this : null;
235           }
236           
237           internal class AntigravityRequest
238           {
239               [JsonPropertyName("project")] public string Project { get; set; } = "";
240               [JsonPropertyName("model")] public string Model { get; set; } = "";
241               [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242           }
243           
244           internal class RequestPayload
245           {
246  ✔  8         [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247  ✔  4         [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248  ✔  8         [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249           }
250           
251           internal class Content
252           {
253               [JsonPropertyName("role")] public string Role { get; set; } = "user";
254               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255           }
256           
257           internal class SystemInstruction
258           {
259               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260           }
261           
262           internal class Part
263           {
264               [JsonPropertyName("text")] public string? Text { get; set; }
265           }
266           
267           internal class GenerationConfig
268           {
269               [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270               [JsonPropertyName("temperature")] public float Temperature { get; set; }
271               [JsonPropertyName("topP")] public float TopP { get; set; }
272               [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273               [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274           }
275           
276           internal class ThinkingConfig
277           {
278               [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279               [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280           }
281           
282           internal class AntigravityResponseWrapper
283           {
284               [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285           }
286           
287           internal class AntigravityResponse
288           {
289               [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290               [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291               [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292           }
293           
294           internal class Candidate
295           {
296               [JsonPropertyName("content")] public Content? Content { get; set; }
297               [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298           }
299           
300           [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301           [JsonSerializable(typeof(AntigravityRequest))]
302           [JsonSerializable(typeof(AntigravityResponseWrapper))]
303           internal partial class AntigravityJsonContext : JsonSerializerContext
304           {
305           }
```
# Synaxis.InferenceGateway.Infrastructure.Routing.CostService

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Routing.CostService |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Routing/CostService.cs |
| **Line coverage:** | 100% (12 of 12) |
| Covered lines: | 12 |
| Uncovered lines: | 0 |
| Coverable lines: | 12 |
| Total lines: | 28 |
| **Branch coverage:** | 100% (2 of 2) |
| Covered branches: | 2 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 2 | 100% |
| **GetCostAsync()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Routing/CostService.cs
```
 1              using Microsoft.EntityFrameworkCore;
 2              using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 3              using Synaxis.InferenceGateway.Application.Routing;
 4              using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 5              
 6              namespace Synaxis.InferenceGateway.Infrastructure.Routing;
 7              
 8              public sealed class CostService : ICostService
 9              {
10                  private readonly ControlPlaneDbContext _dbContext;
11              
12  ✔    41         public CostService(ControlPlaneDbContext dbContext)
13  ✔    41         {
14  ✔    41  ●          if (dbContext is null)
15  ✔     1             {
16  ✔     1                 throw new ArgumentNullException(nameof(dbContext));
17                      }
18              
19  ✔    40             _dbContext = dbContext;
20  ✔    40         }
21              
22                  public async Task<ModelCost?> GetCostAsync(string provider, string model, CancellationToken cancellationToken = defa
23  ✔  1700         {
24  ✔  1700             return await _dbContext.ModelCosts
25  ✔  1700                 .AsNoTracking()
26  ✔  1700                 .FirstOrDefaultAsync(c => c.Provider == provider && c.Model == model, cancellationToken);
27  ✔  1698         }
28              }
```
# Synaxis.InferenceGateway.Infrastructure.Routing.RedisHealthStore

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Routing.RedisHealthStore |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Routing/RedisHealthStore.cs |
| **Line coverage:** | 50% (14 of 28) |
| Covered lines: | 14 |
| Uncovered lines: | 14 |
| Coverable lines: | 28 |
| Total lines: | 55 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **IsHealthyAsync()** | 100% | 1 | 1 | 55.55% |
| **MarkFailureAsync()** | 100% | 2 | 1 | 0% |
| **MarkSuccessAsync(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Routing/RedisHealthStore.cs
```
 1            using System;
 2            using System.Threading;
 3            using System.Threading.Tasks;
 4            using Microsoft.Extensions.Logging;
 5            using StackExchange.Redis;
 6            using Synaxis.InferenceGateway.Application.Routing;
 7            
 8            namespace Synaxis.InferenceGateway.Infrastructure.Routing;
 9            
10            public class RedisHealthStore : IHealthStore
11            {
12                private readonly IConnectionMultiplexer _redis;
13                private readonly ILogger<RedisHealthStore> _logger;
14            
15  ✔  15         public RedisHealthStore(IConnectionMultiplexer redis, ILogger<RedisHealthStore> logger)
16  ✔  15         {
17  ✔  15             _redis = redis;
18  ✔  15             _logger = logger;
19  ✔  15         }
20            
21                public async Task<bool> IsHealthyAsync(string providerKey, CancellationToken cancellationToken = default)
22  ✔  14         {
23                    try
24  ✔  14             {
25  ✔  14                 var db = _redis.GetDatabase();
26                        // If the penalty key exists, the provider is unhealthy
27  ✔  14                 return !await db.KeyExistsAsync($"health:{providerKey}:penalty");
28                    }
29  ❌  0             catch (Exception ex)
30  ❌  0             {
31  ❌  0                 _logger.LogWarning(ex, "Failed to check health for provider '{ProviderKey}'. Failing open (healthy).", provi
32  ❌  0                 return true;
33                    }
34  ✔  14         }
35            
36                public async Task MarkFailureAsync(string providerKey, TimeSpan cooldown, CancellationToken cancellationToken = defa
37  ❌  0         {
38                    try
39  ❌  0             {
40  ❌  0                 var db = _redis.GetDatabase();
41  ❌  0                 await db.StringSetAsync($"health:{providerKey}:penalty", "1", cooldown);
42  ❌  0             }
43  ❌  0             catch (Exception ex)
44  ❌  0             {
45  ❌  0                 _logger.LogWarning(ex, "Failed to mark failure for provider '{ProviderKey}'.", providerKey);
46  ❌  0             }
47  ❌  0         }
48            
49                public Task MarkSuccessAsync(string providerKey, CancellationToken cancellationToken = default)
50  ✔  11         {
51  ✔  11             _ = providerKey;
52                    // Optional: Could track success stats or reduce penalty level
53  ✔  11             return Task.CompletedTask;
54  ✔  11         }
55            }
```
# Synaxis.InferenceGateway.Infrastructure.Routing.RedisQuotaTracker

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Routing.RedisQuotaTracker |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Routing/RedisQuotaTracker.cs |
| **Line coverage:** | 80.9% (17 of 21) |
| Covered lines: | 17 |
| Uncovered lines: | 4 |
| Coverable lines: | 21 |
| Total lines: | 46 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **CheckQuotaAsync(...)** | 100% | 1 | 1 | 100% |
| **IsHealthyAsync(...)** | 100% | 1 | 1 | 100% |
| **RecordUsageAsync()** | 100% | 1 | 1 | 60.0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Routing/RedisQuotaTracker.cs
```
 1            using System;
 2            using System.Threading;
 3            using System.Threading.Tasks;
 4            using Microsoft.Extensions.Logging;
 5            using StackExchange.Redis;
 6            using Synaxis.InferenceGateway.Application.Routing;
 7            
 8            namespace Synaxis.InferenceGateway.Infrastructure.Routing;
 9            
10            public class RedisQuotaTracker : IQuotaTracker
11            {
12                private readonly IConnectionMultiplexer _redis;
13                private readonly ILogger<RedisQuotaTracker> _logger;
14            
15  ✔  15         public RedisQuotaTracker(IConnectionMultiplexer redis, ILogger<RedisQuotaTracker> logger)
16  ✔  15         {
17  ✔  15             _redis = redis;
18  ✔  15             _logger = logger;
19  ✔  15         }
20            
21                public Task<bool> CheckQuotaAsync(string providerKey, CancellationToken cancellationToken = default)
22  ✔  28         {
23                    // Placeholder: Always true for now.
24                    // Future: Check against configured limits per provider/tier.
25  ✔  28             return Task.FromResult(true);
26  ✔  28         }
27            
28                public Task<bool> IsHealthyAsync(string providerKey, CancellationToken cancellationToken = default)
29  ✔  14         {
30                    // For now, IsHealthy is same as CheckQuota
31  ✔  14             return CheckQuotaAsync(providerKey, cancellationToken);
32  ✔  14         }
33            
34                public async Task RecordUsageAsync(string providerKey, long inputTokens, long outputTokens, CancellationToken cancel
35  ✔  11         {
36                    try
37  ✔  11             {
38  ✔  11                 var db = _redis.GetDatabase();
39  ✔  11                 await db.StringIncrementAsync($"quota:{providerKey}:tokens", inputTokens + outputTokens);
40  ✔  11             }
41  ❌  0             catch (Exception ex)
42  ❌  0             {
43  ❌  0                 _logger.LogWarning(ex, "Failed to record usage for provider '{ProviderKey}'.", providerKey);
44  ❌  0             }
45  ✔  11         }
46            }
```
# Synaxis.InferenceGateway.Infrastructure.Security.AesGcmTokenVault

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Security.AesGcmTokenVault |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Security/AesGcmTokenVault.cs |
| **Line coverage:** | 0% (0 of 74) |
| Covered lines: | 0 |
| Uncovered lines: | 74 |
| Coverable lines: | 74 |
| Total lines: | 124 |
| **Branch coverage:** | 0% (0 of 22) |
| Covered branches: | 0 |
| Total branches: | 22 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **EncryptAsync()** | 0% | 6 | 2 | 0% |
| **DecryptAsync()** | 0% | 6 | 2 | 0% |
| **RotateKeyAsync()** | 0% | 156 | 12 | 0% |
| **DecryptTenantKey(...)** | 0% | 6 | 2 | 0% |
| **Encrypt(...)** | 100% | 2 | 1 | 0% |
| **Decrypt(...)** | 0% | 6 | 2 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Security/AesGcmTokenVault.cs
```
  1           using System.Security.Cryptography;
  2           using System.Text;
  3           using Microsoft.EntityFrameworkCore;
  4           using Microsoft.Extensions.Options;
  5           using Synaxis.InferenceGateway.Application.Configuration;
  6           using Synaxis.InferenceGateway.Application.Security;
  7           using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
  8           
  9           namespace Synaxis.InferenceGateway.Infrastructure.Security;
 10           
 11           public sealed class AesGcmTokenVault : ITokenVault
 12           {
 13               private readonly ControlPlaneDbContext _dbContext;
 14               private readonly byte[] _masterKey;
 15           
 16  ❌ 0         public AesGcmTokenVault(ControlPlaneDbContext dbContext, IOptions<SynaxisConfiguration> config)
 17  ❌ 0         {
 18  ❌ 0             _dbContext = dbContext;
 19                   // Derive a master key from a configured string. Do not allow an empty or missing master key.
 20  ❌ 0             var masterKeyString = config.Value.MasterKey;
 21  ❌ 0  ○          if (string.IsNullOrWhiteSpace(masterKeyString))
 22  ❌ 0             {
 23  ❌ 0                 throw new InvalidOperationException("Synaxis:InferenceGateway:MasterKey must be configured.");
 24                   }
 25           
 26  ❌ 0             using var sha = SHA256.Create();
 27  ❌ 0             _masterKey = sha.ComputeHash(Encoding.UTF8.GetBytes(masterKeyString));
 28  ❌ 0         }
 29           
 30               public async Task<byte[]> EncryptAsync(Guid tenantId, string plaintext, CancellationToken cancellationToken = defaul
 31  ❌ 0         {
 32  ❌ 0             var tenant = await _dbContext.Tenants.FindAsync(new object[] { tenantId }, cancellationToken);
 33  ❌ 0  ○          if (tenant == null) throw new ArgumentException("Tenant not found", nameof(tenantId));
 34           
 35  ❌ 0             var tenantKey = DecryptTenantKey(tenant.EncryptedByokKey);
 36  ❌ 0             return Encrypt(Encoding.UTF8.GetBytes(plaintext), tenantKey);
 37  ❌ 0         }
 38           
 39               public async Task<string> DecryptAsync(Guid tenantId, byte[] ciphertext, CancellationToken cancellationToken = defau
 40  ❌ 0         {
 41  ❌ 0             var tenant = await _dbContext.Tenants.FindAsync(new object[] { tenantId }, cancellationToken);
 42  ❌ 0  ○          if (tenant == null) throw new ArgumentException("Tenant not found", nameof(tenantId));
 43           
 44  ❌ 0             var tenantKey = DecryptTenantKey(tenant.EncryptedByokKey);
 45  ❌ 0             var plainBytes = Decrypt(ciphertext, tenantKey);
 46  ❌ 0             return Encoding.UTF8.GetString(plainBytes);
 47  ❌ 0         }
 48           
 49               public async Task RotateKeyAsync(Guid tenantId, string newKeyBase64, CancellationToken cancellationToken = default)
 50  ❌ 0         {
 51  ❌ 0             var tenant = await _dbContext.Tenants
 52  ❌ 0                 .Include(t => t.OAuthAccounts)
 53  ❌ 0                 .FirstOrDefaultAsync(t => t.Id == tenantId, cancellationToken);
 54           
 55  ❌ 0  ○          if (tenant == null) throw new ArgumentException("Tenant not found", nameof(tenantId));
 56           
 57  ❌ 0             var oldKey = DecryptTenantKey(tenant.EncryptedByokKey);
 58  ❌ 0             var newKey = Convert.FromBase64String(newKeyBase64);
 59           
 60  ❌ 0  ○          if (newKey.Length != 32) throw new ArgumentException("Key must be 32 bytes", nameof(newKeyBase64));
 61           
 62                   // Re-encrypt all OAuth tokens
 63  ❌ 0  ○          foreach (var account in tenant.OAuthAccounts)
 64  ❌ 0             {
 65  ❌ 0  ○              if (account.AccessTokenEncrypted.Length > 0)
 66  ❌ 0                 {
 67  ❌ 0                     var token = Decrypt(account.AccessTokenEncrypted, oldKey);
 68  ❌ 0                     account.AccessTokenEncrypted = Encrypt(token, newKey);
 69  ❌ 0                 }
 70           
 71  ❌ 0  ○              if (account.RefreshTokenEncrypted != null && account.RefreshTokenEncrypted.Length > 0)
 72  ❌ 0                 {
 73  ❌ 0                     var token = Decrypt(account.RefreshTokenEncrypted, oldKey);
 74  ❌ 0                     account.RefreshTokenEncrypted = Encrypt(token, newKey);
 75  ❌ 0                 }
 76  ❌ 0             }
 77           
 78                   // Update tenant key
 79  ❌ 0             tenant.EncryptedByokKey = Encrypt(newKey, _masterKey);
 80  ❌ 0             await _dbContext.SaveChangesAsync(cancellationToken);
 81  ❌ 0         }
 82           
 83               private byte[] DecryptTenantKey(byte[] encryptedKey)
 84  ❌ 0         {
 85  ❌ 0  ○          if (encryptedKey.Length == 0) return _masterKey; // Fallback for uninitialized tenants (MVP)
 86  ❌ 0             return Decrypt(encryptedKey, _masterKey);
 87  ❌ 0         }
 88           
 89               private static byte[] Encrypt(byte[] plaintext, byte[] key)
 90  ❌ 0         {
 91                   // Format: Nonce (12) + Tag (16) + Ciphertext (N)
 92  ❌ 0             var nonce = new byte[12];
 93  ❌ 0             RandomNumberGenerator.Fill(nonce);
 94           
 95  ❌ 0             var ciphertext = new byte[plaintext.Length];
 96  ❌ 0             var tag = new byte[16];
 97           
 98  ❌ 0             using var aes = new AesGcm(key, 16);
 99  ❌ 0             aes.Encrypt(nonce, plaintext, ciphertext, tag);
100           
101  ❌ 0             var result = new byte[nonce.Length + tag.Length + ciphertext.Length];
102  ❌ 0             Buffer.BlockCopy(nonce, 0, result, 0, nonce.Length);
103  ❌ 0             Buffer.BlockCopy(tag, 0, result, nonce.Length, tag.Length);
104  ❌ 0             Buffer.BlockCopy(ciphertext, 0, result, nonce.Length + tag.Length, ciphertext.Length);
105           
106  ❌ 0             return result;
107  ❌ 0         }
108           
109               private static byte[] Decrypt(byte[] encrypted, byte[] key)
110  ❌ 0         {
111  ❌ 0  ○          if (encrypted.Length < 28) throw new ArgumentException("Invalid ciphertext");
112           
113  ❌ 0             var nonce = encrypted.AsSpan(0, 12);
114  ❌ 0             var tag = encrypted.AsSpan(12, 16);
115  ❌ 0             var ciphertext = encrypted.AsSpan(28);
116           
117  ❌ 0             var plaintext = new byte[ciphertext.Length];
118           
119  ❌ 0             using var aes = new AesGcm(key, 16);
120  ❌ 0             aes.Decrypt(nonce, ciphertext, tag, plaintext);
121           
122  ❌ 0             return plaintext;
123  ❌ 0         }
124           }
```
# Synaxis.InferenceGateway.Infrastructure.Security.ApiKeyService

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Security.ApiKeyService |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Security/ApiKeyService.cs |
| **Line coverage:** | 100% (17 of 17) |
| Covered lines: | 17 |
| Uncovered lines: | 0 |
| Coverable lines: | 17 |
| Total lines: | 35 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **GenerateKey()** | 100% | 1 | 1 | 100% |
| **HashKey(...)** | 100% | 1 | 1 | 100% |
| **ValidateKey(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Security/ApiKeyService.cs
```
 1            using System.Security.Cryptography;
 2            using System.Text;
 3            using Synaxis.InferenceGateway.Application.Security;
 4            
 5            namespace Synaxis.InferenceGateway.Infrastructure.Security;
 6            
 7            public sealed class ApiKeyService : IApiKeyService
 8            {
 9                private const string Prefix = "sk-synaxis-";
10            
11                public string GenerateKey()
12  ✔  22         {
13  ✔  22             var bytes = new byte[16];
14  ✔  22             RandomNumberGenerator.Fill(bytes);
15                    // Use base62 or hex. Hex is simpler.
16  ✔  22             var hex = Convert.ToHexString(bytes).ToLowerInvariant();
17  ✔  22             return $"{Prefix}{hex}";
18  ✔  22         }
19            
20                public string HashKey(string key)
21  ✔  53         {
22  ✔  53             var bytes = Encoding.UTF8.GetBytes(key);
23  ✔  53             var hash = SHA256.HashData(bytes);
24  ✔  53             return Convert.ToBase64String(hash);
25  ✔  53         }
26            
27                public bool ValidateKey(string key, string hash)
28  ✔  24         {
29  ✔  24             var computed = HashKey(key);
30                    // Constant time comparison
31  ✔  24             return CryptographicOperations.FixedTimeEquals(
32  ✔  24                 Encoding.UTF8.GetBytes(computed),
33  ✔  24                 Encoding.UTF8.GetBytes(hash));
34  ✔  24         }
35            }
```
# Synaxis.InferenceGateway.Infrastructure.Security.AuditService

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Security.AuditService |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Security/AuditService.cs |
| **Line coverage:** | 100% (20 of 20) |
| Covered lines: | 20 |
| Uncovered lines: | 0 |
| Coverable lines: | 20 |
| Total lines: | 37 |
| **Branch coverage:** | 100% (4 of 4) |
| Covered branches: | 4 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 2 | 100% |
| **LogAsync()** | 100% | 2 | 2 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Security/AuditService.cs
```
 1            using System.Text.Json;
 2            using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 3            using Synaxis.InferenceGateway.Application.Security;
 4            using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 5            
 6            namespace Synaxis.InferenceGateway.Infrastructure.Security;
 7            
 8            public sealed class AuditService : IAuditService
 9            {
10                private readonly ControlPlaneDbContext _dbContext;
11            
12  ✔  27         public AuditService(ControlPlaneDbContext dbContext)
13  ✔  27         {
14  ✔  27  ●          if (dbContext is null)
15  ✔   1             {
16  ✔   1                 throw new ArgumentNullException(nameof(dbContext));
17                    }
18            
19  ✔  26             _dbContext = dbContext;
20  ✔  26         }
21            
22                public async Task LogAsync(Guid tenantId, Guid? userId, string action, object? payload, CancellationToken cancellati
23  ✔  22         {
24  ✔  22  ●          var log = new AuditLog
25  ✔  22             {
26  ✔  22                 Id = Guid.NewGuid(),
27  ✔  22                 TenantId = tenantId,
28  ✔  22                 UserId = userId,
29  ✔  22                 Action = action,
30  ✔  22                 PayloadJson = payload != null ? JsonSerializer.Serialize(payload) : null,
31  ✔  22                 CreatedAt = DateTimeOffset.UtcNow
32  ✔  22             };
33            
34  ✔  22             _dbContext.AuditLogs.Add(log);
35  ✔  22             await _dbContext.SaveChangesAsync(cancellationToken);
36  ✔  21         }
37            }
```
# Synaxis.InferenceGateway.Infrastructure.Security.JwtService

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.Security.JwtService |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Security/JwtService.cs |
| **Line coverage:** | 100% (32 of 32) |
| Covered lines: | 32 |
| Uncovered lines: | 0 |
| Coverable lines: | 32 |
| Total lines: | 59 |
| **Branch coverage:** | 100% (8 of 8) |
| Covered branches: | 8 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 2 | 100% |
| **GenerateToken(...)** | 100% | 6 | 6 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/Security/JwtService.cs
```
 1            using System.IdentityModel.Tokens.Jwt;
 2            using System.Security.Claims;
 3            using System.Text;
 4            using Microsoft.Extensions.Options;
 5            using Microsoft.IdentityModel.Tokens;
 6            using Synaxis.InferenceGateway.Application.Configuration;
 7            using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 8            using Synaxis.InferenceGateway.Application.Security;
 9            
10            namespace Synaxis.InferenceGateway.Infrastructure.Security;
11            
12            public sealed class JwtService : IJwtService
13            {
14                private readonly SynaxisConfiguration _config;
15            
16  ✔  22         public JwtService(IOptions<SynaxisConfiguration> config)
17  ✔  22         {
18  ✔  22  ●          if (config is null)
19  ✔   1             {
20  ✔   1                 throw new ArgumentNullException(nameof(config));
21                    }
22            
23  ✔  21             _config = config.Value;
24  ✔  21         }
25            
26                    public string GenerateToken(User user)
27  ✔  61             {
28  ✔  61                 var tokenHandler = new JwtSecurityTokenHandler();
29  ✔  61                 var secret = _config.JwtSecret;
30            
31                        // Do not allow an empty/whitespace JWT secret. Require explicit configuration.
32  ✔  61  ●              if (string.IsNullOrWhiteSpace(secret))
33  ✔   2                 {
34  ✔   2                     throw new InvalidOperationException("Synaxis:InferenceGateway:JwtSecret must be configured.");
35                        }
36            
37  ✔  59                 var key = Encoding.ASCII.GetBytes(secret);
38            
39  ✔  59             var claims = new List<Claim>
40  ✔  59             {
41  ✔  59                 new Claim(JwtRegisteredClaimNames.Sub, user.Id.ToString()),
42  ✔  59                 new Claim(JwtRegisteredClaimNames.Email, user.Email),
43  ✔  59                 new Claim("role", user.Role.ToString()),
44  ✔  59                 new Claim("tenantId", user.TenantId.ToString())
45  ✔  59             };
46            
47  ✔  59  ●          var tokenDescriptor = new SecurityTokenDescriptor
48  ✔  59             {
49  ✔  59                 Subject = new ClaimsIdentity(claims),
50  ✔  59                 Expires = DateTime.UtcNow.AddDays(7),
51  ✔  59                 Issuer = _config.JwtIssuer ?? "Synaxis",
52  ✔  59                 Audience = _config.JwtAudience ?? "Synaxis",
53  ✔  59                 SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Sign
54  ✔  59             };
55            
56  ✔  59             var token = tokenHandler.CreateToken(tokenDescriptor);
57  ✔  59             return tokenHandler.WriteToken(token);
58  ✔  59         }
59            }
```
# Synaxis.InferenceGateway.Infrastructure.SystemInstruction

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.SystemInstruction |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Parts()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.IO;
  4           using System.Linq;
  5           using System.Net.Http;
  6           using System.Net.Http.Headers;
  7           using System.Runtime.CompilerServices;
  8           using System.Text;
  9           using System.Text.Json;
 10           using System.Text.Json.Serialization;
 11           using System.Threading;
 12           using System.Threading.Tasks;
 13           using Microsoft.Extensions.AI;
 14           using Synaxis.InferenceGateway.Infrastructure.Auth;
 15           
 16           namespace Synaxis.InferenceGateway.Infrastructure;
 17           
 18           /// <summary>
 19           /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20           /// Implements strict protocol compliance including the wrapper object and custom headers.
 21           /// </summary>
 22           public class AntigravityChatClient : IChatClient
 23           {
 24               private readonly HttpClient _httpClient;
 25               private readonly string _modelId;
 26               private readonly string _projectId;
 27               private readonly ITokenProvider _tokenProvider;
 28               private readonly ChatClientMetadata _metadata;
 29           
 30               // Endpoints are now relative to the configured HttpClient.BaseAddress
 31               private const string EndpointRelative = "/v1/chat/completions";
 32               private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33           
 34               public AntigravityChatClient(
 35                   HttpClient httpClient,
 36                   string modelId,
 37                   string projectId,
 38                   ITokenProvider tokenProvider)
 39               {
 40                   _httpClient = httpClient;
 41                   _modelId = modelId;
 42                   _projectId = projectId;
 43                   _tokenProvider = tokenProvider;
 44                   // Prefer the configured BaseAddress on the provided HttpClient when available
 45                   _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46               }
 47           
 48               public ChatClientMetadata Metadata => _metadata;
 49           
 50               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51               {
 52                   var messagesList = chatMessages.ToList();
 53                   var request = BuildRequest(messagesList, options);
 54                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55           
 56                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58           
 59                   await PrepareRequestAsync(httpRequest, cancellationToken);
 60           
 61                   using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                   await EnsureSuccessAsync(response);
 63           
 64                   var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                   var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66           
 67                   return MapResponse(agResponse?.Response);
 68               }
 69           
 70               public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                   IEnumerable<ChatMessage> chatMessages,
 72                   ChatOptions? options = null,
 73                   [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74               {
 75                   var messagesList = chatMessages.ToList();
 76                   var request = BuildRequest(messagesList, options);
 77                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78           
 79                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                   httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82           
 83                   await PrepareRequestAsync(httpRequest, cancellationToken);
 84           
 85                   using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                   await EnsureSuccessAsync(response);
 87           
 88                   using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                   using var reader = new StreamReader(stream);
 90           
 91                   while (!cancellationToken.IsCancellationRequested)
 92                   {
 93                       var line = await reader.ReadLineAsync(cancellationToken);
 94                       if (line == null) break; // End of stream
 95                       if (string.IsNullOrWhiteSpace(line)) continue;
 96           
 97                       if (line.StartsWith("data: "))
 98                       {
 99                           var data = line.Substring(6).Trim();
100                           if (data == "[DONE]") break;
101           
102                           AntigravityResponseWrapper? wrapper = null;
103                           try
104                           {
105                               wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                           }
107                           catch (JsonException) { /* Ignore malformed lines */ }
108           
109                           if (wrapper?.Response?.Candidates != null)
110                           {
111                               foreach (var candidate in wrapper.Response.Candidates)
112                               {
113                                   if (candidate.Content?.Parts != null)
114                                   {
115                                       foreach (var part in candidate.Content.Parts)
116                                       {
117                                           if (!string.IsNullOrEmpty(part.Text))
118                                           {
119                                               yield return new ChatResponseUpdate
120                                               {
121                                                   Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                   Contents = { new TextContent(part.Text) }
123                                               };
124                                           }
125                                       }
126                                   }
127                               }
128                           }
129                       }
130                   }
131               }
132           
133               private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134               {
135                   var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                   request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137           
138                   // Strict Headers required by Antigravity
139                   request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                   request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                   request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142               }
143           
144               private async Task EnsureSuccessAsync(HttpResponseMessage response)
145               {
146                   if (!response.IsSuccessStatusCode)
147                   {
148                       var error = await response.Content.ReadAsStringAsync();
149                       throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                   }
151               }
152           
153               private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154               {
155                   var contentList = new List<Content>();
156                   SystemInstruction? systemInstruction = null;
157           
158                   foreach (var msg in messages)
159                   {
160                       if (msg.Role == ChatRole.System)
161                       {
162                           // Antigravity requires system instructions in a separate field, not in contents
163                           if (systemInstruction == null)
164                           {
165                               systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                           }
167                           systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                       }
169                       else
170                       {
171                           var role = msg.Role == ChatRole.User ? "user" : "model";
172                           contentList.Add(new Content
173                           {
174                               Role = role,
175                               Parts = new List<Part> { new Part { Text = msg.Text } }
176                           });
177                       }
178                   }
179           
180                   var config = new GenerationConfig
181                   {
182                       MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                       Temperature = options?.Temperature ?? 0.7f,
184                       TopP = options?.TopP ?? 0.95f,
185                       StopSequences = options?.StopSequences
186                   };
187           
188                   // Handle Thinking Config
189                   if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                   {
191                        // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                        // For now, we'll try to extract budget if present, or default
193                        if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                        {
195                            // Simple extraction logic or default
196                            config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                        }
198                   }
199           
200                   return new AntigravityRequest
201                   {
202                       Project = _projectId,
203                       Model = _modelId,
204                       RequestPayload = new RequestPayload
205                       {
206                           Contents = contentList,
207                           SystemInstruction = systemInstruction,
208                           GenerationConfig = config
209                       }
210                   };
211               }
212           
213               private ChatResponse MapResponse(AntigravityResponse? response)
214               {
215                   if (response?.Candidates == null || response.Candidates.Count == 0)
216                       return new ChatResponse(new List<ChatMessage>());
217           
218                   var candidate = response.Candidates[0];
219                   var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220           
221                   return new ChatResponse(new List<ChatMessage>
222                   {
223                       new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                   })
225                   {
226                       ResponseId = response.ResponseId,
227                       ModelId = response.ModelVersion
228                   };
229               }
230           
231               // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232               public void Dispose() { }
233               public object? GetService(Type serviceType, object? serviceKey = null) =>
234                   serviceType == typeof(IChatClient) ? this : null;
235           }
236           
237           internal class AntigravityRequest
238           {
239               [JsonPropertyName("project")] public string Project { get; set; } = "";
240               [JsonPropertyName("model")] public string Model { get; set; } = "";
241               [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242           }
243           
244           internal class RequestPayload
245           {
246               [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247               [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248               [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249           }
250           
251           internal class Content
252           {
253               [JsonPropertyName("role")] public string Role { get; set; } = "user";
254               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255           }
256           
257           internal class SystemInstruction
258           {
259  ✔  4         [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260           }
261           
262           internal class Part
263           {
264               [JsonPropertyName("text")] public string? Text { get; set; }
265           }
266           
267           internal class GenerationConfig
268           {
269               [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270               [JsonPropertyName("temperature")] public float Temperature { get; set; }
271               [JsonPropertyName("topP")] public float TopP { get; set; }
272               [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273               [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274           }
275           
276           internal class ThinkingConfig
277           {
278               [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279               [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280           }
281           
282           internal class AntigravityResponseWrapper
283           {
284               [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285           }
286           
287           internal class AntigravityResponse
288           {
289               [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290               [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291               [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292           }
293           
294           internal class Candidate
295           {
296               [JsonPropertyName("content")] public Content? Content { get; set; }
297               [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298           }
299           
300           [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301           [JsonSerializable(typeof(AntigravityRequest))]
302           [JsonSerializable(typeof(AntigravityResponseWrapper))]
303           internal partial class AntigravityJsonContext : JsonSerializerContext
304           {
305           }
```
# Synaxis.InferenceGateway.Infrastructure.ThinkingConfig

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.Infrastructure.ThinkingConfig |
| Assembly: | Synaxis.InferenceGateway.Infrastructure |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 305 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_ThinkingBudget()** | 100% | 2 | 1 | 0% |
| **get_IncludeThoughts()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/Infrastructure/AntigravityChatClient.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.IO;
  4           using System.Linq;
  5           using System.Net.Http;
  6           using System.Net.Http.Headers;
  7           using System.Runtime.CompilerServices;
  8           using System.Text;
  9           using System.Text.Json;
 10           using System.Text.Json.Serialization;
 11           using System.Threading;
 12           using System.Threading.Tasks;
 13           using Microsoft.Extensions.AI;
 14           using Synaxis.InferenceGateway.Infrastructure.Auth;
 15           
 16           namespace Synaxis.InferenceGateway.Infrastructure;
 17           
 18           /// <summary>
 19           /// A robust, upstream-compatible client for Google's Antigravity Gateway.
 20           /// Implements strict protocol compliance including the wrapper object and custom headers.
 21           /// </summary>
 22           public class AntigravityChatClient : IChatClient
 23           {
 24               private readonly HttpClient _httpClient;
 25               private readonly string _modelId;
 26               private readonly string _projectId;
 27               private readonly ITokenProvider _tokenProvider;
 28               private readonly ChatClientMetadata _metadata;
 29           
 30               // Endpoints are now relative to the configured HttpClient.BaseAddress
 31               private const string EndpointRelative = "/v1/chat/completions";
 32               private const string StreamEndpointRelative = "/v1/chat/completions?alt=sse";
 33           
 34               public AntigravityChatClient(
 35                   HttpClient httpClient,
 36                   string modelId,
 37                   string projectId,
 38                   ITokenProvider tokenProvider)
 39               {
 40                   _httpClient = httpClient;
 41                   _modelId = modelId;
 42                   _projectId = projectId;
 43                   _tokenProvider = tokenProvider;
 44                   // Prefer the configured BaseAddress on the provided HttpClient when available
 45                   _metadata = new ChatClientMetadata("Antigravity", _httpClient.BaseAddress ?? new Uri("https://cloudcode-pa.googl
 46               }
 47           
 48               public ChatClientMetadata Metadata => _metadata;
 49           
 50               public async Task<ChatResponse> GetResponseAsync(IEnumerable<ChatMessage> chatMessages, ChatOptions? options = null,
 51               {
 52                   var messagesList = chatMessages.ToList();
 53                   var request = BuildRequest(messagesList, options);
 54                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 55           
 56                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, EndpointRelative);
 57                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 58           
 59                   await PrepareRequestAsync(httpRequest, cancellationToken);
 60           
 61                   using var response = await _httpClient.SendAsync(httpRequest, cancellationToken);
 62                   await EnsureSuccessAsync(response);
 63           
 64                   var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
 65                   var agResponse = JsonSerializer.Deserialize(responseJson, AntigravityJsonContext.Default.AntigravityResponseWrap
 66           
 67                   return MapResponse(agResponse?.Response);
 68               }
 69           
 70               public async IAsyncEnumerable<ChatResponseUpdate> GetStreamingResponseAsync(
 71                   IEnumerable<ChatMessage> chatMessages,
 72                   ChatOptions? options = null,
 73                   [EnumeratorCancellation] CancellationToken cancellationToken = default)
 74               {
 75                   var messagesList = chatMessages.ToList();
 76                   var request = BuildRequest(messagesList, options);
 77                   var json = JsonSerializer.Serialize(request, AntigravityJsonContext.Default.AntigravityRequest);
 78           
 79                   using var httpRequest = new HttpRequestMessage(HttpMethod.Post, StreamEndpointRelative);
 80                   httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");
 81                   httpRequest.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));
 82           
 83                   await PrepareRequestAsync(httpRequest, cancellationToken);
 84           
 85                   using var response = await _httpClient.SendAsync(httpRequest, HttpCompletionOption.ResponseHeadersRead, cancella
 86                   await EnsureSuccessAsync(response);
 87           
 88                   using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
 89                   using var reader = new StreamReader(stream);
 90           
 91                   while (!cancellationToken.IsCancellationRequested)
 92                   {
 93                       var line = await reader.ReadLineAsync(cancellationToken);
 94                       if (line == null) break; // End of stream
 95                       if (string.IsNullOrWhiteSpace(line)) continue;
 96           
 97                       if (line.StartsWith("data: "))
 98                       {
 99                           var data = line.Substring(6).Trim();
100                           if (data == "[DONE]") break;
101           
102                           AntigravityResponseWrapper? wrapper = null;
103                           try
104                           {
105                               wrapper = JsonSerializer.Deserialize(data, AntigravityJsonContext.Default.AntigravityResponseWrapper
106                           }
107                           catch (JsonException) { /* Ignore malformed lines */ }
108           
109                           if (wrapper?.Response?.Candidates != null)
110                           {
111                               foreach (var candidate in wrapper.Response.Candidates)
112                               {
113                                   if (candidate.Content?.Parts != null)
114                                   {
115                                       foreach (var part in candidate.Content.Parts)
116                                       {
117                                           if (!string.IsNullOrEmpty(part.Text))
118                                           {
119                                               yield return new ChatResponseUpdate
120                                               {
121                                                   Role = new ChatRole(candidate.Content.Role ?? "model"),
122                                                   Contents = { new TextContent(part.Text) }
123                                               };
124                                           }
125                                       }
126                                   }
127                               }
128                           }
129                       }
130                   }
131               }
132           
133               private async Task PrepareRequestAsync(HttpRequestMessage request, CancellationToken cancellationToken)
134               {
135                   var token = await _tokenProvider.GetTokenAsync(cancellationToken);
136                   request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
137           
138                   // Strict Headers required by Antigravity
139                   request.Headers.TryAddWithoutValidation("User-Agent", "antigravity/1.11.5 windows/amd64");
140                   request.Headers.TryAddWithoutValidation("X-Goog-Api-Client", "google-cloud-sdk vscode_cloudshelleditor/0.1");
141                   request.Headers.TryAddWithoutValidation("Client-Metadata", "{\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLAT
142               }
143           
144               private async Task EnsureSuccessAsync(HttpResponseMessage response)
145               {
146                   if (!response.IsSuccessStatusCode)
147                   {
148                       var error = await response.Content.ReadAsStringAsync();
149                       throw new HttpRequestException($"Antigravity API Error ({response.StatusCode}): {error}");
150                   }
151               }
152           
153               private AntigravityRequest BuildRequest(IList<ChatMessage> messages, ChatOptions? options)
154               {
155                   var contentList = new List<Content>();
156                   SystemInstruction? systemInstruction = null;
157           
158                   foreach (var msg in messages)
159                   {
160                       if (msg.Role == ChatRole.System)
161                       {
162                           // Antigravity requires system instructions in a separate field, not in contents
163                           if (systemInstruction == null)
164                           {
165                               systemInstruction = new SystemInstruction { Parts = new List<Part>() };
166                           }
167                           systemInstruction.Parts.Add(new Part { Text = msg.Text });
168                       }
169                       else
170                       {
171                           var role = msg.Role == ChatRole.User ? "user" : "model";
172                           contentList.Add(new Content
173                           {
174                               Role = role,
175                               Parts = new List<Part> { new Part { Text = msg.Text } }
176                           });
177                       }
178                   }
179           
180                   var config = new GenerationConfig
181                   {
182                       MaxOutputTokens = options?.MaxOutputTokens ?? 4000,
183                       Temperature = options?.Temperature ?? 0.7f,
184                       TopP = options?.TopP ?? 0.95f,
185                       StopSequences = options?.StopSequences
186                   };
187           
188                   // Handle Thinking Config
189                   if (options?.AdditionalProperties != null && options.AdditionalProperties.TryGetValue("thinking", out var thinki
190                   {
191                        // Assuming thinkingObj is a dictionary or object that can be serialized to ThinkingConfig
192                        // For now, we'll try to extract budget if present, or default
193                        if (thinkingObj is JsonElement je && je.ValueKind == JsonValueKind.Object)
194                        {
195                            // Simple extraction logic or default
196                            config.ThinkingConfig = new ThinkingConfig { IncludeThoughts = true, ThinkingBudget = 2000 };
197                        }
198                   }
199           
200                   return new AntigravityRequest
201                   {
202                       Project = _projectId,
203                       Model = _modelId,
204                       RequestPayload = new RequestPayload
205                       {
206                           Contents = contentList,
207                           SystemInstruction = systemInstruction,
208                           GenerationConfig = config
209                       }
210                   };
211               }
212           
213               private ChatResponse MapResponse(AntigravityResponse? response)
214               {
215                   if (response?.Candidates == null || response.Candidates.Count == 0)
216                       return new ChatResponse(new List<ChatMessage>());
217           
218                   var candidate = response.Candidates[0];
219                   var text = string.Join("", candidate.Content?.Parts?.Select(p => p.Text) ?? Array.Empty<string>());
220           
221                   return new ChatResponse(new List<ChatMessage>
222                   {
223                       new ChatMessage(new ChatRole(candidate.Content?.Role ?? "model"), text)
224                   })
225                   {
226                       ResponseId = response.ResponseId,
227                       ModelId = response.ModelVersion
228                   };
229               }
230           
231               // Do not dispose HttpClient instances provided by IHttpClientFactory - let the factory manage lifetime.
232               public void Dispose() { }
233               public object? GetService(Type serviceType, object? serviceKey = null) =>
234                   serviceType == typeof(IChatClient) ? this : null;
235           }
236           
237           internal class AntigravityRequest
238           {
239               [JsonPropertyName("project")] public string Project { get; set; } = "";
240               [JsonPropertyName("model")] public string Model { get; set; } = "";
241               [JsonPropertyName("request")] public RequestPayload RequestPayload { get; set; } = new();
242           }
243           
244           internal class RequestPayload
245           {
246               [JsonPropertyName("contents")] public List<Content> Contents { get; set; } = new();
247               [JsonPropertyName("systemInstruction")] public SystemInstruction? SystemInstruction { get; set; }
248               [JsonPropertyName("generationConfig")] public GenerationConfig GenerationConfig { get; set; } = new();
249           }
250           
251           internal class Content
252           {
253               [JsonPropertyName("role")] public string Role { get; set; } = "user";
254               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
255           }
256           
257           internal class SystemInstruction
258           {
259               [JsonPropertyName("parts")] public List<Part> Parts { get; set; } = new();
260           }
261           
262           internal class Part
263           {
264               [JsonPropertyName("text")] public string? Text { get; set; }
265           }
266           
267           internal class GenerationConfig
268           {
269               [JsonPropertyName("maxOutputTokens")] public int MaxOutputTokens { get; set; }
270               [JsonPropertyName("temperature")] public float Temperature { get; set; }
271               [JsonPropertyName("topP")] public float TopP { get; set; }
272               [JsonPropertyName("stopSequences")] public IList<string>? StopSequences { get; set; }
273               [JsonPropertyName("thinkingConfig")] public ThinkingConfig? ThinkingConfig { get; set; }
274           }
275           
276           internal class ThinkingConfig
277           {
278  ❌ 0         [JsonPropertyName("thinkingBudget")] public int ThinkingBudget { get; set; }
279  ❌ 0         [JsonPropertyName("includeThoughts")] public bool IncludeThoughts { get; set; }
280           }
281           
282           internal class AntigravityResponseWrapper
283           {
284               [JsonPropertyName("response")] public AntigravityResponse? Response { get; set; }
285           }
286           
287           internal class AntigravityResponse
288           {
289               [JsonPropertyName("candidates")] public List<Candidate> Candidates { get; set; } = new();
290               [JsonPropertyName("modelVersion")] public string ModelVersion { get; set; } = "";
291               [JsonPropertyName("responseId")] public string ResponseId { get; set; } = "";
292           }
293           
294           internal class Candidate
295           {
296               [JsonPropertyName("content")] public Content? Content { get; set; }
297               [JsonPropertyName("finishReason")] public string? FinishReason { get; set; }
298           }
299           
300           [JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnore
301           [JsonSerializable(typeof(AntigravityRequest))]
302           [JsonSerializable(typeof(AntigravityResponseWrapper))]
303           internal partial class AntigravityJsonContext : JsonSerializerContext
304           {
305           }
```
# Mediator.AssemblyReference

## Summary

|||
|:---|:---|
| Class: | Mediator.AssemblyReference |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/AssemblyReference.g.cs |
| **Line coverage:** | 0% (0 of 7) |
| Covered lines: | 0 |
| Uncovered lines: | 7 |
| Coverable lines: | 7 |
| Total lines: | 37 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Assembly()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **op_Implicit(...)** | 100% | 2 | 1 | 0% |
| **op_Implicit(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/AssemblyReference.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/AssemblyReference.g.cs' does not exist (any more).

# Mediator.Internals.CommandHandlerWrapper<T1, T2>

## Summary

|||
|:---|:---|
| Class: | Mediator.Internals.CommandHandlerWrapper<T1, T2> |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 0% (0 of 39) |
| Covered lines: | 0 |
| Uncovered lines: | 39 |
| Coverable lines: | 39 |
| Total lines: | 338 |
| **Branch coverage:** | 0% (0 of 6) |
| Covered branches: | 0 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Handle(...)** | 0% | 42 | 6 | 0% |
| **Handle(...)** | 100% | 2 | 1 | 0% |
| **Handle()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Mediator.Internals.ContainerMetadata

## Summary

|||
|:---|:---|
| Class: | Mediator.Internals.ContainerMetadata |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 100% (25 of 25) |
| Covered lines: | 25 |
| Uncovered lines: | 0 |
| Coverable lines: | 25 |
| Total lines: | 677 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Mediator.Internals.NotificationHandlerWrapper<T>

## Summary

|||
|:---|:---|
| Class: | Mediator.Internals.NotificationHandlerWrapper<T> |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 0% (0 of 28) |
| Covered lines: | 0 |
| Uncovered lines: | 28 |
| Coverable lines: | 28 |
| Total lines: | 618 |
| **Branch coverage:** | 0% (0 of 8) |
| Covered branches: | 0 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Handle(...)** | 0% | 72 | 8 | 0% |
| **Handle(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Mediator.Internals.QueryHandlerWrapper<T1, T2>

## Summary

|||
|:---|:---|
| Class: | Mediator.Internals.QueryHandlerWrapper<T1, T2> |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 0% (0 of 39) |
| Covered lines: | 0 |
| Uncovered lines: | 39 |
| Coverable lines: | 39 |
| Total lines: | 491 |
| **Branch coverage:** | 0% (0 of 6) |
| Covered branches: | 0 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Handle(...)** | 0% | 42 | 6 | 0% |
| **Handle(...)** | 100% | 2 | 1 | 0% |
| **Handle()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Mediator.Internals.RequestHandlerWrapper<T1, T2>

## Summary

|||
|:---|:---|
| Class: | Mediator.Internals.RequestHandlerWrapper<T1, T2> |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 41% (16 of 39) |
| Covered lines: | 16 |
| Uncovered lines: | 23 |
| Coverable lines: | 39 |
| Total lines: | 185 |
| **Branch coverage:** | 33.3% (2 of 6) |
| Covered branches: | 2 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Handle(...)** | 33.33% | 11 | 6 | 48.48% |
| **Handle(...)** | 100% | 2 | 1 | 0% |
| **Handle()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Mediator.Internals.StreamCommandHandlerWrapper<T1, T2>

## Summary

|||
|:---|:---|
| Class: | Mediator.Internals.StreamCommandHandlerWrapper<T1, T2> |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 0% (0 of 40) |
| Covered lines: | 0 |
| Uncovered lines: | 40 |
| Coverable lines: | 40 |
| Total lines: | 415 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Handle(...)** | 0% | 42 | 6 | 0% |
| **Handle(...)** | 100% | 2 | 1 | 0% |
| **Handle()** | 0% | 42 | 6 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Mediator.Internals.StreamQueryHandlerWrapper<T1, T2>

## Summary

|||
|:---|:---|
| Class: | Mediator.Internals.StreamQueryHandlerWrapper<T1, T2> |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 0% (0 of 40) |
| Covered lines: | 0 |
| Uncovered lines: | 40 |
| Coverable lines: | 40 |
| Total lines: | 568 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Handle(...)** | 0% | 42 | 6 | 0% |
| **Handle(...)** | 100% | 2 | 1 | 0% |
| **Handle()** | 0% | 42 | 6 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Mediator.Internals.StreamRequestHandlerWrapper<T1, T2>

## Summary

|||
|:---|:---|
| Class: | Mediator.Internals.StreamRequestHandlerWrapper<T1, T2> |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 40% (16 of 40) |
| Covered lines: | 16 |
| Uncovered lines: | 24 |
| Coverable lines: | 40 |
| Total lines: | 262 |
| **Branch coverage:** | 16.6% (2 of 12) |
| Covered branches: | 2 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Handle(...)** | 33.33% | 11 | 6 | 48.48% |
| **Handle(...)** | 100% | 2 | 1 | 0% |
| **Handle()** | 0% | 42 | 6 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Mediator.Mediator

## Summary

|||
|:---|:---|
| Class: | Mediator.Mediator |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 18.9% (38 of 201) |
| Covered lines: | 38 |
| Uncovered lines: | 163 |
| Coverable lines: | 201 |
| Total lines: | 1241 |
| **Branch coverage:** | 8.8% (6 of 68) |
| Covered branches: | 6 |
| Total branches: | 68 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get__containerMetadata()** | 100% | 2 | 2 | 100% |
| **get_NotificationPublisher()** | 0% | 6 | 2 | 0% |
| **get_ServicesUnderlyingTypeIsArray()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **Send(...)** | 100% | 1 | 1 | 100% |
| **CreateStream(...)** | 100% | 1 | 1 | 100% |
| **Send(...)** | 50.0% | 5 | 4 | 66.66% |
| **SendAsync()** | 0% | 6 | 2 | 0% |
| **CreateStream(...)** | 50.0% | 2 | 2 | 66.66% |
| **Send(...)** | 100% | 2 | 1 | 0% |
| **SendAsync()** | 100% | 2 | 1 | 0% |
| **CreateStream(...)** | 100% | 2 | 1 | 0% |
| **Send(...)** | 100% | 2 | 1 | 0% |
| **SendAsync()** | 100% | 2 | 1 | 0% |
| **CreateStream(...)** | 100% | 2 | 1 | 0% |
| **Send()** | 0% | 72 | 8 | 0% |
| **CreateStream(...)** | 0% | 72 | 8 | 0% |
| **Publish(...)** | 100% | 2 | 1 | 0% |
| **Publish(...)** | 100% | 2 | 1 | 0% |
| **ThrowMissingHandler(...)** | 100% | 2 | 1 | 0% |
| **ThrowInvalidMessage(...)** | 0% | 20 | 4 | 0% |
| **ThrowInvalidRequest(...)** | 0% | 20 | 4 | 0% |
| **ThrowInvalidCommand(...)** | 0% | 20 | 4 | 0% |
| **ThrowInvalidQuery(...)** | 0% | 20 | 4 | 0% |
| **ThrowInvalidStreamMessage(...)** | 0% | 20 | 4 | 0% |
| **ThrowInvalidStreamRequest(...)** | 0% | 20 | 4 | 0% |
| **ThrowInvalidStreamCommand(...)** | 0% | 20 | 4 | 0% |
| **ThrowInvalidStreamQuery(...)** | 0% | 20 | 4 | 0% |
| **ThrowArgumentNull(...)** | 100% | 2 | 1 | 0% |
| **ThrowInvalidMessage(...)** | 100% | 2 | 1 | 0% |
| **ThrowIfNull(...)** | 50.0% | 2 | 2 | 75.00% |
| **ThrowInvalidNotification(...)** | 0% | 20 | 4 | 0% |
| **ThrowAggregateException(...)** | 100% | 2 | 1 | 0% |
| **MaybeThrowAggregateException(...)** | 0% | 6 | 2 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Mediator.MediatorOptions

## Summary

|||
|:---|:---|
| Class: | Mediator.MediatorOptions |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/MediatorOptions.g.cs |
| **Line coverage:** | 100% (8 of 8) |
| Covered lines: | 8 |
| Uncovered lines: | 0 |
| Coverable lines: | 8 |
| Total lines: | 54 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Namespace()** | 100% | 1 | 1 | 100% |
| **get_GenerateTypesAsInternal()** | 100% | 1 | 1 | 100% |
| **get_NotificationPublisherType()** | 100% | 1 | 1 | 100% |
| **get_ServiceLifetime()** | 100% | 1 | 1 | 100% |
| **.ctor()** | 100% | 1 | 1 | 100% |
| **get_Assemblies()** | 100% | 1 | 1 | 100% |
| **get_PipelineBehaviors()** | 100% | 1 | 1 | 100% |
| **get_StreamPipelineBehaviors()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/MediatorOptions.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/MediatorOptions.g.cs' does not exist (any more).

# Mediator.MediatorOptionsAttribute

## Summary

|||
|:---|:---|
| Class: | Mediator.MediatorOptionsAttribute |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/MediatorOptionsAttribute.g.cs |
| **Line coverage:** | 0% (0 of 4) |
| Covered lines: | 0 |
| Uncovered lines: | 4 |
| Coverable lines: | 4 |
| Total lines: | 32 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Namespace()** | 100% | 2 | 1 | 0% |
| **get_NotificationPublisherType()** | 100% | 2 | 1 | 0% |
| **get_ServiceLifetime()** | 100% | 2 | 1 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/MediatorOptionsAttribute.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/MediatorOptionsAttribute.g.cs' does not exist (any more).

# Microsoft.AspNetCore.OpenApi.Generated

## Summary

|||
|:---|:---|
| Class: | Microsoft.AspNetCore.OpenApi.Generated |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs |
| **Line coverage:** | 1% (4 of 381) |
| Covered lines: | 4 |
| Uncovered lines: | 377 |
| Coverable lines: | 381 |
| Total lines: | 606 |
| **Branch coverage:** | 0% (0 of 206) |
| Covered branches: | 0 |
| Total branches: | 206 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Summary()** | 100% | 2 | 1 | 0% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_Remarks()** | 100% | 2 | 1 | 0% |
| **get_Returns()** | 100% | 2 | 1 | 0% |
| **get_Value()** | 100% | 2 | 1 | 0% |
| **get_Deprecated()** | 100% | 2 | 1 | 0% |
| **get_Examples()** | 100% | 2 | 1 | 0% |
| **get_Parameters()** | 100% | 2 | 1 | 0% |
| **get_Responses()** | 100% | 2 | 1 | 0% |
| **get_Name()** | 100% | 2 | 1 | 0% |
| **get_Code()** | 100% | 2 | 1 | 0% |
| **get_Cache()** | 0% | 6 | 2 | 0% |
| **GenerateCacheEntries()** | 100% | 2 | 1 | 0% |
| **CreateDocumentationId(...)** | 0% | 6 | 2 | 0% |
| **CreateDocumentationId(...)** | 0% | 110 | 10 | 0% |
| **CreateDocumentationId(...)** | 0% | 20 | 4 | 0% |
| **CreateDocumentationId(...)** | 0% | 342 | 18 | 0% |
| **GetTypeDocId(...)** | 0% | 812 | 28 | 0% |
| **NormalizeDocId(...)** | 0% | 42 | 6 | 0% |
| **TransformAsync(...)** | 0% | 8930 | 94 | 0% |
| **UnwrapOpenApiParameter(...)** | 0% | 42 | 6 | 0% |
| **TransformAsync(...)** | 0% | 1190 | 34 | 0% |
| **Parse(...)** | 0% | 6 | 2 | 0% |
| **AddOpenApi(...)** | 100% | 1 | 1 | 57.14% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs' does not exist (any more).

# Microsoft.Extensions.DependencyInjection.MediatorDependencyInjectionExtensions

## Summary

|||
|:---|:---|
| Class: | Microsoft.Extensions.DependencyInjection.MediatorDependencyInjectionExtensions |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs |
| **Line coverage:** | 71.8% (23 of 32) |
| Covered lines: | 23 |
| Uncovered lines: | 9 |
| Coverable lines: | 32 |
| Total lines: | 77 |
| **Branch coverage:** | 66.6% (4 of 6) |
| Covered branches: | 4 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddMediator(...)** | 100% | 2 | 1 | 0% |
| **AddMediator(...)** | 66.66% | 6 | 6 | 79.31% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Mediator.SourceGenerator/Mediator.SourceGenerator.IncrementalMediatorGenerator/Mediator.g.cs' does not exist (any more).

# Program

## Summary

|||
|:---|:---|
| Class: | Program |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Program.cs |
| **Line coverage:** | 97.4% (155 of 159) |
| Covered lines: | 155 |
| Uncovered lines: | 4 |
| Coverable lines: | 159 |
| Total lines: | 246 |
| **Branch coverage:** | 83.3% (5 of 6) |
| Covered branches: | 5 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **<Main>$()** | 83.33% | 6 | 6 | 97.48% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Program.cs
```
  1             using System.Text.Json;
  2             using System.Linq;
  3             using System.Collections.Generic;
  4             using DotNetEnv;
  5             using Microsoft.Extensions.AI;
  6             using Synaxis.InferenceGateway.Application.Extensions;
  7             using Synaxis.InferenceGateway.Application.Configuration;
  8             using Synaxis.InferenceGateway.Infrastructure.Extensions;
  9             using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 10             using Microsoft.Extensions.Options;
 11             using Microsoft.Agents.AI.Hosting.OpenAI;
 12             using Microsoft.AspNetCore.OpenApi;
 13             using Synaxis.InferenceGateway.WebApi.Agents;
 14             using Synaxis.InferenceGateway.WebApi.Middleware;
 15             using Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity;
 16             using Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 17             using Synaxis.InferenceGateway.WebApi.Endpoints.Identity;
 18             using Synaxis.InferenceGateway.WebApi.Endpoints.Admin;
 19             using Quartz;
 20             using Synaxis.InferenceGateway.Infrastructure.Jobs;
 21             
 22             using Scalar.AspNetCore;
 23             
 24             using Microsoft.AspNetCore.Authentication.JwtBearer;
 25             using Microsoft.IdentityModel.Tokens;
 26             using System.Text;
 27             using Microsoft.AspNetCore.Diagnostics.HealthChecks;
 28             using Microsoft.Extensions.Diagnostics.HealthChecks;
 29             using Microsoft.Extensions.DependencyInjection;
 30             using Synaxis.InferenceGateway.WebApi.Health;
 31             using StackExchange.Redis;
 32             using Serilog;
 33             using OpenTelemetry.Trace;
 34             using OpenTelemetry.Resources;
 35             using System.Diagnostics;
 36             
 37             
 38             
 39  ✔   37     Log.Logger = new LoggerConfiguration()
 40  ✔   37         .WriteTo.Console()
 41  ✔   37         .CreateLogger();
 42             
 43             // Load .env files as early as possible so environment variables are available
 44  ✔   37     DotNetEnv.Env.TraversePath().Load();
 45             
 46             try
 47  ✔   37     {
 48  ✔   37         Log.Information("Starting web host");
 49             
 50  ✔   37         var builder = WebApplication.CreateBuilder(args);
 51             
 52                 // Map .env / Docker-style environment variables to configuration keys
 53  ✔   37         var envMapping = new Dictionary<string, string?>
 54  ✔   37         {
 55  ✔   37             { "Synaxis:InferenceGateway:Providers:Groq:Key", Environment.GetEnvironmentVariable("GROQ_API_KEY") },
 56  ✔   37             { "Synaxis:InferenceGateway:Providers:Cohere:Key", Environment.GetEnvironmentVariable("COHERE_API_KEY") },
 57  ✔   37             { "Synaxis:InferenceGateway:Providers:Cloudflare:Key", Environment.GetEnvironmentVariable("CLOUDFLARE_API_KEY") 
 58  ✔   37             { "Synaxis:InferenceGateway:Providers:Cloudflare:AccountId", Environment.GetEnvironmentVariable("CLOUDFLARE_ACCO
 59  ✔   37             { "Synaxis:InferenceGateway:Providers:Gemini:Key", Environment.GetEnvironmentVariable("GEMINI_API_KEY") },
 60  ✔   37             { "Synaxis:InferenceGateway:Providers:OpenRouter:Key", Environment.GetEnvironmentVariable("OPENROUTER_API_KEY") 
 61  ✔   37             { "Synaxis:InferenceGateway:Providers:DeepSeek:Key", Environment.GetEnvironmentVariable("DEEPSEEK_API_KEY") },
 62  ✔   37             { "Synaxis:InferenceGateway:Providers:DeepSeek:Endpoint", Environment.GetEnvironmentVariable("DEEPSEEK_API_ENDPO
 63  ✔   37             { "Synaxis:InferenceGateway:Providers:OpenAI:Key", Environment.GetEnvironmentVariable("OPENAI_API_KEY") },
 64  ✔   37             { "Synaxis:InferenceGateway:Providers:OpenAI:Endpoint", Environment.GetEnvironmentVariable("OPENAI_API_ENDPOINT"
 65  ✔   37             { "Synaxis:InferenceGateway:Providers:Antigravity:ProjectId", Environment.GetEnvironmentVariable("ANTIGRAVITY_PR
 66  ✔   37             { "Synaxis:InferenceGateway:Providers:Antigravity:Endpoint", Environment.GetEnvironmentVariable("ANTIGRAVITY_API
 67  ✔   37             { "Synaxis:InferenceGateway:Providers:Antigravity:FallbackEndpoint", Environment.GetEnvironmentVariable("ANTIGRA
 68  ✔   37             { "Synaxis:InferenceGateway:Providers:KiloCode:Key", Environment.GetEnvironmentVariable("KILOCODE_API_KEY") },
 69  ✔   37             { "Synaxis:InferenceGateway:Providers:NVIDIA:Key", Environment.GetEnvironmentVariable("NVIDIA_API_KEY") },
 70  ✔   37             { "Synaxis:InferenceGateway:Providers:HuggingFace:Key", Environment.GetEnvironmentVariable("HUGGINGFACE_API_KEY"
 71  ✔   37         };
 72             
 73                 // Filter out null or empty values so we don't overwrite other config values with nulls
 74  ✔  629         var filteredMapping = envMapping.Where(kv => !string.IsNullOrEmpty(kv.Value))
 75  ✔  851                                         .ToDictionary(kv => kv.Key, kv => kv.Value);
 76             
 77  ✔   37         builder.Configuration.AddInMemoryCollection(filteredMapping);
 78             
 79  ✔   37         builder.Host.UseSerilog();
 80             
 81                 // Configure faster shutdown for development
 82  ✔   37         builder.Services.Configure<HostOptions>(options =>
 83  ✔   37         {
 84  ✔   37  ●          if (builder.Environment.IsDevelopment())
 85  ✔   34             {
 86  ✔   34                 options.ShutdownTimeout = TimeSpan.FromSeconds(3);
 87  ✔   34             }
 88  ✔   74         });
 89             
 90             // 1. Add Services
 91  ✔   37     builder.Services.AddHttpClient();
 92  ✔   37     builder.Services.AddHttpContextAccessor();
 93  ✔   37     builder.Services.AddControlPlane(builder.Configuration);
 94  ✔   37     builder.Services.AddSynaxisInfrastructure(builder.Configuration);
 95  ✔   37     builder.Services.AddSynaxisApplication(builder.Configuration);
 96  ✔   37     builder.Services.AddOpenApi();
 97             
 98             // Quartz.NET - schedule periodic jobs
 99  ✔   37     builder.Services.AddQuartz(q =>
100  ✔   37     {
101  ✔   37         // Create a job key for ModelsDevSyncJob
102  ✔   37         var modelsDevSyncJobKey = new JobKey("ModelsDevSyncJob");
103  ✔   37     
104  ✔   37         // Register the job with the scheduler
105  ✔   74         q.AddJob<ModelsDevSyncJob>(opts => opts.WithIdentity(modelsDevSyncJobKey));
106  ✔   37     
107  ✔   37         // Trigger: start now, repeat every 24 hours
108  ✔   74         q.AddTrigger(opts => opts
109  ✔   74             .ForJob(modelsDevSyncJobKey)
110  ✔   74             .StartNow()
111  ✔   74             .WithSimpleSchedule(x => x.WithInterval(TimeSpan.FromHours(24)).RepeatForever())
112  ✔   37         );
113  ✔   37     
114  ✔   37         // Create a job key for ProviderDiscoveryJob
115  ✔   37         var providerDiscoveryJobKey = new JobKey("ProviderDiscoveryJob");
116  ✔   37     
117  ✔   37         // Register the ProviderDiscoveryJob with the scheduler
118  ✔   74         q.AddJob<ProviderDiscoveryJob>(opts => opts.WithIdentity(providerDiscoveryJobKey));
119  ✔   37     
120  ✔   37         // Trigger: start now, repeat every 1 hour
121  ✔   74         q.AddTrigger(opts => opts
122  ✔   74             .ForJob(providerDiscoveryJobKey)
123  ✔   74             .StartNow()
124  ✔   74             .WithSimpleSchedule(x => x.WithInterval(TimeSpan.FromHours(1)).RepeatForever())
125  ✔   37         );
126  ✔   74     });
127             
128             // Add hosted service to run Quartz and wait for jobs to complete on shutdown
129  ✔   74     builder.Services.AddQuartzHostedService(opt => opt.WaitForJobsToComplete = true);
130             
131             // OpenTelemetry
132  ✔   37     builder.Services.AddOpenTelemetry()
133  ✔   37         .WithTracing(tracing =>
134  ✔   37         {
135  ✔   37             tracing.AddSource("Synaxis.InferenceGateway")
136  ✔   37                 .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("synaxis-gateway"))
137  ✔   37                 .AddAspNetCoreInstrumentation()
138  ✔   37                 .AddHttpClientInstrumentation()
139  ✔   37                 .AddOtlpExporter();
140  ✔   74         });
141             
142             // Health Checks
143  ✔   37     builder.Services.AddHealthChecks()
144  ✔    2         .AddCheck("self", () => HealthCheckResult.Healthy(), tags: new[] { "liveness" })
145  ✔   37         .AddDbContextCheck<ControlPlaneDbContext>(tags: new[] { "readiness" })
146  ✔    1         .AddRedis(sp => sp.GetRequiredService<IConnectionMultiplexer>(), tags: new[] { "readiness" })
147  ✔   37         .AddCheck<ConfigHealthCheck>("config", tags: new[] { "readiness" })
148  ✔   37         .AddCheck<ProviderConnectivityHealthCheck>("providers", tags: new[] { "readiness" });
149             
150  ✔   37     builder.Services.AddScoped<RoutingService>();
151  ✔   37     builder.Services.AddScoped<RoutingAgent>();
152  ✔   74     builder.Services.AddMediator(options => options.ServiceLifetime = ServiceLifetime.Scoped);
153  ✔   37     builder.AddOpenAIChatCompletions();
154  ✔   37     builder.AddOpenAIResponses();
155  ✔   37     builder.AddOpenAIConversations();
156             
157             // Auth
158  ✓   37  ◑  var jwtSecret = builder.Configuration["Synaxis:InferenceGateway:JwtSecret"] ?? "SynaxisDefaultSecretKeyDoNotUseInProd123
159  ✔   37     var key = Encoding.ASCII.GetBytes(jwtSecret);
160             
161  ✔   37     builder.Services.AddAuthentication(x =>
162  ✔   37     {
163  ✔   37         x.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
164  ✔   37         x.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
165  ✔   37     })
166  ✔   37     .AddJwtBearer(x =>
167  ✔   35     {
168  ✔   35         x.RequireHttpsMetadata = false;
169  ✔   35         x.SaveToken = true;
170  ✔   35         x.TokenValidationParameters = new TokenValidationParameters
171  ✔   35         {
172  ✔   35             ValidateIssuerSigningKey = true,
173  ✔   35             IssuerSigningKey = new SymmetricSecurityKey(key),
174  ✔   35             ValidateIssuer = false,
175  ✔   35             ValidateAudience = false
176  ✔   35         };
177  ✔   72     });
178             
179  ✔   37     builder.Services.AddAuthorization();
180  ✔   37     builder.Services.AddControllers();
181             
182  ✔   37     var app = builder.Build();
183             
184  ✔   37  ●  if (app.Environment.IsDevelopment())
185  ✔   34     {
186  ✔   34         app.MapOpenApi();
187  ✔   34         app.MapScalarApiReference();
188  ✔   34     }
189             
190             // Initialize the database on startup. Wrap in try/catch so the
191             // application can still start in environments where the database
192             // is not available (CI/local test runs). Migration failures are
193             // logged but do not crash the host.
194             try
195  ✔   37     {
196  ✔   37         await app.InitializeDatabaseAsync();
197  ✔   34     }
198  ✔    3     catch (Exception ex)
199  ✔    3     {
200  ✔    3         Log.Warning(ex, "Database initialization failed, continuing without migrations. Some features may be unavailable.");
201  ✔    3     }
202             
203  ✔   37     app.UseHttpsRedirection();
204             
205  ✔   37     app.UseAuthentication();
206  ✔   37     app.UseAuthorization();
207             
208  ✔   37     app.Use(async (context, next) =>
209  ✔  125     {
210  ✔  125         context.Request.EnableBuffering();
211  ✔  125         await next();
212  ✔  162     });
213             
214  ✔   37     app.UseMiddleware<OpenAIErrorHandlerMiddleware>();
215  ✔   37     app.UseMiddleware<OpenAIMetadataMiddleware>();
216             
217  ✔   37         app.MapOpenAIEndpoints();
218  ✔   37         app.MapAntigravityEndpoints();
219  ✔   37         app.MapIdentityEndpoints();
220  ✔   37         app.MapAdminEndpoints();
221  ✔   37         app.MapControllers();
222             
223             // NOTE: Removed temporary debug endpoint that created AggregateException for testing.
224             
225  ✔   37     app.MapHealthChecks("/health/liveness", new HealthCheckOptions
226  ✔   37     {
227  ✔   10         Predicate = r => r.Tags.Contains("liveness")
228  ✔   37     });
229             
230  ✔   37     app.MapHealthChecks("/health/readiness", new HealthCheckOptions
231  ✔   37     {
232  ✔    5         Predicate = r => r.Tags.Contains("readiness")
233  ✔   37     });
234             
235  ✔   37         app.Run();
236  ✔   37     }
237  ❌   0     catch (Exception ex)
238  ❌   0     {
239  ❌   0         Log.Fatal(ex, "Host terminated unexpectedly");
240  ❌   0     }
241             finally
242  ✔   37     {
243  ✔   37         Log.CloseAndFlush();
244  ✔   37     }
245             
246             public partial class Program { }
```
# Synaxis.InferenceGateway.WebApi.Agents.RoutingAgent

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Agents.RoutingAgent |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Agents/RoutingAgent.cs |
| **Line coverage:** | 92.2% (71 of 77) |
| Covered lines: | 71 |
| Uncovered lines: | 6 |
| Coverable lines: | 77 |
| Total lines: | 153 |
| **Branch coverage:** | 61.1% (33 of 54) |
| Covered branches: | 33 |
| Total branches: | 54 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Name()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **RunCoreAsync()** | 60.71% | 29 | 28 | 90.90% |
| **RunCoreStreamingAsync()** | 61.53% | 26 | 26 | 100% |
| **GetNewThreadAsync(...)** | 100% | 2 | 1 | 0% |
| **DeserializeThreadAsync(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Agents/RoutingAgent.cs
```
  1            using Microsoft.Agents.AI;
  2            using Microsoft.AspNetCore.Http;
  3            using Microsoft.Extensions.DependencyInjection;
  4            using Microsoft.Extensions.Logging;
  5            using Microsoft.Extensions.AI;
  6            using Synaxis.InferenceGateway.Application.Translation;
  7            using Synaxis.InferenceGateway.Application.Routing;
  8            using Synaxis.InferenceGateway.WebApi.Helpers;
  9            using Synaxis.InferenceGateway.WebApi.Middleware;
 10            using System.Text.Json;
 11            using System.Runtime.CompilerServices;
 12            using System.Collections.Generic;
 13            using System.Threading;
 14            using System.Threading.Tasks;
 15            
 16            namespace Synaxis.InferenceGateway.WebApi.Agents;
 17            
 18            public class RoutingAgentThread : AgentThread { }
 19            
 20            public class RoutingAgent : Microsoft.Agents.AI.AIAgent
 21            {
 22  ❌  0         public override string Name => "Synaxis";
 23            
 24                private readonly IChatClient _chatClient;
 25                private readonly ITranslationPipeline _translator;
 26                private readonly IHttpContextAccessor _httpContextAccessor;
 27                private readonly ILogger<RoutingAgent> _logger;
 28            
 29  ✔  14         public RoutingAgent(
 30  ✔  14             IChatClient chatClient,
 31  ✔  14             ITranslationPipeline translator,
 32  ✔  14             IHttpContextAccessor httpContextAccessor,
 33  ✔  14             ILogger<RoutingAgent> logger)
 34  ✔  14         {
 35  ✔  14             _chatClient = chatClient;
 36  ✔  14             _translator = translator;
 37  ✔  14             _httpContextAccessor = httpContextAccessor;
 38  ✔  14             _logger = logger;
 39  ✔  14         }
 40            
 41                protected override async Task<Microsoft.Agents.AI.AgentResponse> RunCoreAsync(
 42                    IEnumerable<ChatMessage> messages,
 43                    Microsoft.Agents.AI.AgentThread? thread = null,
 44                    Microsoft.Agents.AI.AgentRunOptions? options = null,
 45                    CancellationToken cancellationToken = default)
 46  ✔  11         {
 47  ✓  11  ◑          var httpContext = _httpContextAccessor?.HttpContext;
 48            
 49                    // 1. Parse Input
 50  ✓  11  ◑          var openReq = await OpenAIRequestParser.ParseAsync(httpContext, cancellationToken)
 51  ✔  11                           ?? new OpenAIRequest { Model = "default" };
 52            
 53                    // 2. Map to Canonical
 54  ✔  11             var canonicalRequest = OpenAIRequestMapper.ToCanonicalRequest(openReq, messages);
 55            
 56                    // 3. Translate Request
 57  ✔  11             var translatedRequest = _translator.TranslateRequest(canonicalRequest);
 58            
 59                    // 4. Prepare Options
 60  ✔  11             var chatOptions = new ChatOptions { ModelId = translatedRequest.Model };
 61            
 62                    // 5. Execute
 63  ✔  11             var response = await _chatClient.GetResponseAsync(translatedRequest.Messages, chatOptions, cancellationToken);
 64            
 65                    // 6. Translate Response
 66  ✓  11  ◑          var message = response.Messages.FirstOrDefault() ?? new ChatMessage(ChatRole.Assistant, "");
 67  ✔  11             var toolCalls = message.Contents.OfType<FunctionCallContent>().ToList();
 68  ✔  11             var canonicalResponse = new CanonicalResponse(message.Text, toolCalls);
 69  ✔  11             var translatedResponse = _translator.TranslateResponse(canonicalResponse);
 70            
 71                    // 7. Log Routing Context
 72  ✓  11  ◑          if (httpContext != null && response.AdditionalProperties != null)
 73  ✔  11             {
 74  ✓  11  ◑              if (response.AdditionalProperties.TryGetValue("model_id", out var resolvedModel) &&
 75  ✔  11                     response.AdditionalProperties.TryGetValue("provider_name", out var provider))
 76  ✔  11                 {
 77  ✓  11  ◑                  httpContext.Items["RoutingContext"] = new RoutingContext(
 78  ✔  11                         openReq.Model ?? "default",
 79  ✔  11                         resolvedModel?.ToString() ?? string.Empty,
 80  ✔  11                         provider?.ToString() ?? string.Empty);
 81  ✔  11                 }
 82  ✔  11             }
 83            
 84                    // 8. Build Agent Response
 85  ✔  11             var agentMessage = new ChatMessage(ChatRole.Assistant, translatedResponse.Content);
 86  ✔  11  ●          if (translatedResponse.ToolCalls != null)
 87  ✔  11             {
 88  ✓  33  ◑              foreach (var toolCall in translatedResponse.ToolCalls)
 89  ❌  0                 {
 90  ❌  0                     agentMessage.Contents.Add(toolCall);
 91  ❌  0                 }
 92  ✔  11             }
 93            
 94  ✔  11             return new Microsoft.Agents.AI.AgentResponse(agentMessage);
 95  ✔  11         }
 96            
 97                protected override async IAsyncEnumerable<Microsoft.Agents.AI.AgentResponseUpdate> RunCoreStreamingAsync(
 98                    IEnumerable<ChatMessage> messages,
 99                    Microsoft.Agents.AI.AgentThread? thread = null,
100                    Microsoft.Agents.AI.AgentRunOptions? options = null,
101                    [EnumeratorCancellation] CancellationToken cancellationToken = default)
102  ✔   3         {
103  ✓   3  ◑          var httpContext = _httpContextAccessor?.HttpContext;
104            
105                    // 1. Parse Input
106  ✓   3  ◑          var openReq = await OpenAIRequestParser.ParseAsync(httpContext, cancellationToken)
107  ✔   3                           ?? new OpenAIRequest { Model = "default" };
108            
109                    // 2. Map to Canonical
110  ✔   3             var canonicalRequest = OpenAIRequestMapper.ToCanonicalRequest(openReq, messages);
111            
112                    // 3. Translate Request
113  ✔   3             var translatedRequest = _translator.TranslateRequest(canonicalRequest);
114            
115                    // 4. Prepare Options
116  ✔   3             var chatOptions = new ChatOptions { ModelId = translatedRequest.Model };
117            
118                    // 5. Execute Streaming
119  ✔   3             var updates = _chatClient.GetStreamingResponseAsync(translatedRequest.Messages, chatOptions, cancellationToken);
120            
121                    // 6. Translate and Yield Updates
122  ✔  25  ●          await foreach (var update in updates.WithCancellation(cancellationToken))
123  ✔   8             {
124  ✔   8                 var translatedUpdate = _translator.TranslateUpdate(update);
125            
126                        // 7. Log Routing Context (on first update if available)
127  ✓   8  ◑              if (httpContext != null && translatedUpdate.AdditionalProperties != null && !httpContext.Items.ContainsKey("
128  ✔   2                 {
129  ✓   2  ◑                  if (translatedUpdate.AdditionalProperties.TryGetValue("model_id", out var resolvedModel) &&
130  ✔   2                         translatedUpdate.AdditionalProperties.TryGetValue("provider_name", out var provider))
131  ✔   2                     {
132  ✓   2  ◑                      httpContext.Items["RoutingContext"] = new RoutingContext(
133  ✔   2                             openReq.Model ?? "default",
134  ✔   2                             resolvedModel?.ToString() ?? string.Empty,
135  ✔   2                             provider?.ToString() ?? string.Empty);
136  ✔   2                     }
137  ✔   2                 }
138            
139  ✔   8                 yield return new Microsoft.Agents.AI.AgentResponseUpdate
140  ✔   8                 {
141  ✔   8                     Role = translatedUpdate.Role,
142  ✔   8                     Contents = translatedUpdate.Contents,
143  ✔   8                     AdditionalProperties = translatedUpdate.AdditionalProperties
144  ✔   8                 };
145  ✔   8             }
146  ✔   2         }
147            
148                public override ValueTask<AgentThread> GetNewThreadAsync(CancellationToken cancellationToken = default)
149  ❌  0             => new ValueTask<AgentThread>(new RoutingAgentThread());
150            
151                public override ValueTask<AgentThread> DeserializeThreadAsync(JsonElement serializedThread, JsonSerializerOptions? j
152  ❌  0             => new ValueTask<AgentThread>(new RoutingAgentThread());
153            }
```
# Synaxis.InferenceGateway.WebApi.Agents.RoutingService

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Agents.RoutingService |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Agents/RoutingService.cs |
| **Line coverage:** | 0% (0 of 52) |
| Covered lines: | 0 |
| Uncovered lines: | 52 |
| Coverable lines: | 52 |
| Total lines: | 103 |
| **Branch coverage:** | 0% (0 of 26) |
| Covered branches: | 0 |
| Total branches: | 26 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **HandleAsync()** | 0% | 42 | 6 | 0% |
| **HandleStreamingAsync()** | 0% | 6 | 2 | 0% |
| **LogRoutingContext(...)** | 0% | 342 | 18 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Agents/RoutingService.cs
```
  1           using Microsoft.Agents.AI;
  2           using AgentsAI = Microsoft.Agents.AI;
  3           using Microsoft.AspNetCore.Http;
  4           using Microsoft.Extensions.AI;
  5           using Microsoft.Extensions.Logging;
  6           using Synaxis.InferenceGateway.Application.Translation;
  7           using Synaxis.InferenceGateway.WebApi.Helpers;
  8           using Synaxis.InferenceGateway.WebApi.Middleware;
  9           using System.Collections.Generic;
 10           using System.Runtime.CompilerServices;
 11           using System.Text.Json;
 12           using System.Threading;
 13           using System.Threading.Tasks;
 14           
 15           namespace Synaxis.InferenceGateway.WebApi.Agents
 16           {
 17               // Scoped service that contains the routing logic and relies on constructor injection
 18               public class RoutingService
 19               {
 20                   private readonly IChatClient _chatClient;
 21                   private readonly ITranslationPipeline _translator;
 22                   private readonly IHttpContextAccessor _httpContextAccessor;
 23                   private readonly ILogger<RoutingService> _logger;
 24           
 25  ❌ 0             public RoutingService(IChatClient chatClient, ITranslationPipeline translator, IHttpContextAccessor httpContextA
 26  ❌ 0             {
 27  ❌ 0                 _chatClient = chatClient;
 28  ❌ 0                 _translator = translator;
 29  ❌ 0                 _httpContextAccessor = httpContextAccessor;
 30  ❌ 0                 _logger = logger;
 31  ❌ 0             }
 32           
 33                   public async Task<AgentsAI.AgentResponse> HandleAsync(OpenAIRequest openAIRequest, IEnumerable<ChatMessage> mess
 34  ❌ 0             {
 35  ❌ 0                 var httpContext = _httpContextAccessor.HttpContext;
 36           
 37                       // 1. Input is already parsed and passed as arguments
 38           
 39                       // 2. Map to Canonical
 40  ❌ 0                 var canonicalRequest = OpenAIRequestMapper.ToCanonicalRequest(openAIRequest, messages);
 41           
 42                       // 3. Translate Request
 43  ❌ 0                 var translatedRequest = _translator.TranslateRequest(canonicalRequest);
 44           
 45                       // 4. Prepare Options
 46  ❌ 0                 var chatOptions = new ChatOptions { ModelId = translatedRequest.Model };
 47           
 48                       // 5. Execute
 49  ❌ 0                 var response = await _chatClient.GetResponseAsync(translatedRequest.Messages, chatOptions, cancellationToken
 50           
 51                       // 6. Translate Response
 52  ❌ 0  ○              var message = response.Messages.FirstOrDefault() ?? new ChatMessage(ChatRole.Assistant, "");
 53  ❌ 0                 var toolCalls = message.Contents.OfType<FunctionCallContent>().ToList();
 54  ❌ 0                 var canonicalResponse = new CanonicalResponse(message.Text, toolCalls);
 55  ❌ 0                 var translatedResponse = _translator.TranslateResponse(canonicalResponse);
 56           
 57                       // 7. Log Routing Context
 58  ❌ 0                 LogRoutingContext(httpContext, openAIRequest.Model, response.AdditionalProperties);
 59           
 60                       // 8. Build Agent Response
 61  ❌ 0                 var agentMessage = new ChatMessage(ChatRole.Assistant, translatedResponse.Content);
 62  ❌ 0  ○              if (translatedResponse.ToolCalls != null)
 63  ❌ 0                 {
 64  ❌ 0  ○                  foreach (var toolCall in translatedResponse.ToolCalls)
 65  ❌ 0                     {
 66  ❌ 0                         agentMessage.Contents.Add(toolCall);
 67  ❌ 0                     }
 68  ❌ 0                 }
 69           
 70  ❌ 0                 return new AgentsAI.AgentResponse(agentMessage);
 71  ❌ 0             }
 72           
 73                   public async IAsyncEnumerable<AgentsAI.AgentResponseUpdate> HandleStreamingAsync(OpenAIRequest openAIRequest, IE
 74  ❌ 0             {
 75  ❌ 0                 var httpContext = _httpContextAccessor.HttpContext;
 76           
 77  ❌ 0                 var canonicalRequest = OpenAIRequestMapper.ToCanonicalRequest(openAIRequest, messages);
 78  ❌ 0                 var translatedRequest = _translator.TranslateRequest(canonicalRequest);
 79  ❌ 0                 var chatOptions = new ChatOptions { ModelId = translatedRequest.Model };
 80           
 81  ❌ 0  ○              await foreach (var update in _chatClient.GetStreamingResponseAsync(translatedRequest.Messages, chatOptions, 
 82  ❌ 0                 {
 83  ❌ 0                     var translatedUpdate = _translator.TranslateUpdate(update);
 84  ❌ 0                     yield return new AgentsAI.AgentResponseUpdate(translatedUpdate);
 85  ❌ 0                 }
 86  ❌ 0             }
 87           
 88                   private void LogRoutingContext(HttpContext? httpContext, string? requestedModel, AdditionalPropertiesDictionary?
 89  ❌ 0             {
 90  ❌ 0  ○              if (httpContext != null && properties != null)
 91  ❌ 0                 {
 92  ❌ 0  ○                  if (properties.TryGetValue("model_id", out var resolvedModel) &&
 93  ❌ 0                         properties.TryGetValue("provider_name", out var provider))
 94  ❌ 0                     {
 95  ❌ 0  ○                      httpContext.Items["RoutingContext"] = new RoutingContext(
 96  ❌ 0                             requestedModel ?? "default",
 97  ❌ 0                             resolvedModel?.ToString() ?? "",
 98  ❌ 0                             provider?.ToString() ?? "");
 99  ❌ 0                     }
100  ❌ 0                 }
101  ❌ 0             }
102               }
103           }
```
# Synaxis.InferenceGateway.WebApi.Controllers.ApiKeysController

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Controllers.ApiKeysController |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Controllers/ApiKeysController.cs |
| **Line coverage:** | 100% (40 of 40) |
| Covered lines: | 40 |
| Uncovered lines: | 0 |
| Coverable lines: | 40 |
| Total lines: | 83 |
| **Branch coverage:** | 75% (6 of 8) |
| Covered branches: | 6 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **CreateKey()** | 75.00% | 4 | 4 | 100% |
| **RevokeKey()** | 75.00% | 4 | 4 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Controllers/ApiKeysController.cs
```
 1            using Microsoft.AspNetCore.Authorization;
 2            using Microsoft.AspNetCore.Mvc;
 3            using Microsoft.EntityFrameworkCore;
 4            using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 5            using Synaxis.InferenceGateway.Application.Security;
 6            using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 7            using System.Security.Claims;
 8            
 9            namespace Synaxis.InferenceGateway.WebApi.Controllers;
10            
11            [ApiController]
12            [Route("projects/{projectId}/keys")]
13            [Authorize]
14            public class ApiKeysController : ControllerBase
15            {
16                private readonly ControlPlaneDbContext _dbContext;
17                private readonly IApiKeyService _apiKeyService;
18                private readonly IAuditService _auditService;
19            
20  ✔  11         public ApiKeysController(ControlPlaneDbContext dbContext, IApiKeyService apiKeyService, IAuditService auditService)
21  ✔  11         {
22  ✔  11             _dbContext = dbContext;
23  ✔  11             _apiKeyService = apiKeyService;
24  ✔  11             _auditService = auditService;
25  ✔  11         }
26            
27                [HttpPost]
28                public async Task<IActionResult> CreateKey(Guid projectId, [FromBody] CreateKeyRequest request, CancellationToken ca
29  ✔   6         {
30  ✓   6  ◑          var userId = Guid.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier) ?? User.FindFirstValue("sub")!);
31  ✔   6             var tenantId = Guid.Parse(User.FindFirstValue("tenantId")!);
32            
33  ✔   6             var project = await _dbContext.Projects
34  ✔   6                 .FirstOrDefaultAsync(p => p.Id == projectId && p.TenantId == tenantId, cancellationToken);
35            
36  ✔   8  ●          if (project == null) return NotFound("Project not found");
37            
38  ✔   4             var rawKey = _apiKeyService.GenerateKey();
39  ✔   4             var hash = _apiKeyService.HashKey(rawKey);
40            
41  ✔   4             var apiKey = new ApiKey
42  ✔   4             {
43  ✔   4                 Id = Guid.NewGuid(),
44  ✔   4                 ProjectId = projectId,
45  ✔   4                 Name = request.Name,
46  ✔   4                 KeyHash = hash,
47  ✔   4                 Status = ApiKeyStatus.Active,
48  ✔   4                 CreatedAt = DateTimeOffset.UtcNow
49  ✔   4             };
50            
51  ✔   4             _dbContext.ApiKeys.Add(apiKey);
52  ✔   4             await _dbContext.SaveChangesAsync(cancellationToken);
53            
54  ✔   4             await _auditService.LogAsync(tenantId, userId, "CreateApiKey", new { ApiKeyId = apiKey.Id, ProjectId = projectId
55            
56  ✔   4             return Ok(new { Id = apiKey.Id, Key = rawKey, Name = apiKey.Name });
57  ✔   6         }
58            
59                [HttpDelete("{keyId}")]
60                public async Task<IActionResult> RevokeKey(Guid projectId, Guid keyId, CancellationToken cancellationToken)
61  ✔   5         {
62  ✓   5  ◑          var userId = Guid.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier) ?? User.FindFirstValue("sub")!);
63  ✔   5             var tenantId = Guid.Parse(User.FindFirstValue("tenantId")!);
64            
65  ✔   5             var apiKey = await _dbContext.ApiKeys
66  ✔   5                 .Include(k => k.Project)
67  ✔   5                 .FirstOrDefaultAsync(k => k.Id == keyId && k.ProjectId == projectId && k.Project!.TenantId == tenantId, canc
68            
69  ✔   8  ●          if (apiKey == null) return NotFound("API Key not found");
70            
71  ✔   2             apiKey.Status = ApiKeyStatus.Revoked;
72  ✔   2             await _dbContext.SaveChangesAsync(cancellationToken);
73            
74  ✔   2             await _auditService.LogAsync(tenantId, userId, "RevokeApiKey", new { ApiKeyId = keyId }, cancellationToken);
75            
76  ✔   2             return NoContent();
77  ✔   5         }
78            }
79            
80            public class CreateKeyRequest
81            {
82                public string Name { get; set; } = string.Empty;
83            }
```
# Synaxis.InferenceGateway.WebApi.Controllers.AuthController

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Controllers.AuthController |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Controllers/AuthController.cs |
| **Line coverage:** | 100% (27 of 27) |
| Covered lines: | 27 |
| Uncovered lines: | 0 |
| Coverable lines: | 27 |
| Total lines: | 56 |
| **Branch coverage:** | 100% (2 of 2) |
| Covered branches: | 2 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **DevLogin()** | 100% | 2 | 2 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Controllers/AuthController.cs
```
 1            using Microsoft.AspNetCore.Mvc;
 2            using Synaxis.InferenceGateway.Application.Security;
 3            using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 4            using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 5            using Microsoft.EntityFrameworkCore;
 6            
 7            namespace Synaxis.InferenceGateway.WebApi.Controllers;
 8            
 9            [ApiController]
10            [Route("auth")]
11            public class AuthController : ControllerBase
12            {
13                private readonly IJwtService _jwtService;
14                private readonly ControlPlaneDbContext _dbContext;
15            
16  ✔  45         public AuthController(IJwtService jwtService, ControlPlaneDbContext dbContext)
17  ✔  45         {
18  ✔  45             _jwtService = jwtService;
19  ✔  45             _dbContext = dbContext;
20  ✔  45         }
21            
22                [HttpPost("dev-login")]
23                public async Task<IActionResult> DevLogin([FromBody] DevLoginRequest request, CancellationToken cancellationToken)
24  ✔  45         {
25                    // Only for dev/MVP
26  ✔  45             var user = await _dbContext.Users
27  ✔  45                 .FirstOrDefaultAsync(u => u.Email == request.Email, cancellationToken);
28            
29  ✔  45  ●          if (user == null)
30  ✔  16             {
31                        // Auto-register for dev
32  ✔  16                 var tenant = new Tenant { Id = Guid.NewGuid(), Name = "Dev Tenant", Region = TenantRegion.Us, Status = Tenan
33  ✔  16                 _dbContext.Tenants.Add(tenant);
34            
35  ✔  16                 user = new User
36  ✔  16                 {
37  ✔  16                     Id = Guid.NewGuid(),
38  ✔  16                     TenantId = tenant.Id,
39  ✔  16                     Email = request.Email,
40  ✔  16                     Role = UserRole.Owner,
41  ✔  16                     AuthProvider = "dev",
42  ✔  16                     ProviderUserId = request.Email
43  ✔  16                 };
44  ✔  16                 _dbContext.Users.Add(user);
45  ✔  16                 await _dbContext.SaveChangesAsync(cancellationToken);
46  ✔  16             }
47            
48  ✔  45             var token = _jwtService.GenerateToken(user);
49  ✔  45             return Ok(new { token });
50  ✔  45         }
51            }
52            
53            public class DevLoginRequest
54            {
55                public string Email { get; set; } = string.Empty;
56            }
```
# Synaxis.InferenceGateway.WebApi.Controllers.CreateKeyRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Controllers.CreateKeyRequest |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Controllers/ApiKeysController.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 83 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Name()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Controllers/ApiKeysController.cs
```
 1            using Microsoft.AspNetCore.Authorization;
 2            using Microsoft.AspNetCore.Mvc;
 3            using Microsoft.EntityFrameworkCore;
 4            using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 5            using Synaxis.InferenceGateway.Application.Security;
 6            using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 7            using System.Security.Claims;
 8            
 9            namespace Synaxis.InferenceGateway.WebApi.Controllers;
10            
11            [ApiController]
12            [Route("projects/{projectId}/keys")]
13            [Authorize]
14            public class ApiKeysController : ControllerBase
15            {
16                private readonly ControlPlaneDbContext _dbContext;
17                private readonly IApiKeyService _apiKeyService;
18                private readonly IAuditService _auditService;
19            
20                public ApiKeysController(ControlPlaneDbContext dbContext, IApiKeyService apiKeyService, IAuditService auditService)
21                {
22                    _dbContext = dbContext;
23                    _apiKeyService = apiKeyService;
24                    _auditService = auditService;
25                }
26            
27                [HttpPost]
28                public async Task<IActionResult> CreateKey(Guid projectId, [FromBody] CreateKeyRequest request, CancellationToken ca
29                {
30                    var userId = Guid.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier) ?? User.FindFirstValue("sub")!);
31                    var tenantId = Guid.Parse(User.FindFirstValue("tenantId")!);
32            
33                    var project = await _dbContext.Projects
34                        .FirstOrDefaultAsync(p => p.Id == projectId && p.TenantId == tenantId, cancellationToken);
35            
36                    if (project == null) return NotFound("Project not found");
37            
38                    var rawKey = _apiKeyService.GenerateKey();
39                    var hash = _apiKeyService.HashKey(rawKey);
40            
41                    var apiKey = new ApiKey
42                    {
43                        Id = Guid.NewGuid(),
44                        ProjectId = projectId,
45                        Name = request.Name,
46                        KeyHash = hash,
47                        Status = ApiKeyStatus.Active,
48                        CreatedAt = DateTimeOffset.UtcNow
49                    };
50            
51                    _dbContext.ApiKeys.Add(apiKey);
52                    await _dbContext.SaveChangesAsync(cancellationToken);
53            
54                    await _auditService.LogAsync(tenantId, userId, "CreateApiKey", new { ApiKeyId = apiKey.Id, ProjectId = projectId
55            
56                    return Ok(new { Id = apiKey.Id, Key = rawKey, Name = apiKey.Name });
57                }
58            
59                [HttpDelete("{keyId}")]
60                public async Task<IActionResult> RevokeKey(Guid projectId, Guid keyId, CancellationToken cancellationToken)
61                {
62                    var userId = Guid.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier) ?? User.FindFirstValue("sub")!);
63                    var tenantId = Guid.Parse(User.FindFirstValue("tenantId")!);
64            
65                    var apiKey = await _dbContext.ApiKeys
66                        .Include(k => k.Project)
67                        .FirstOrDefaultAsync(k => k.Id == keyId && k.ProjectId == projectId && k.Project!.TenantId == tenantId, canc
68            
69                    if (apiKey == null) return NotFound("API Key not found");
70            
71                    apiKey.Status = ApiKeyStatus.Revoked;
72                    await _dbContext.SaveChangesAsync(cancellationToken);
73            
74                    await _auditService.LogAsync(tenantId, userId, "RevokeApiKey", new { ApiKeyId = keyId }, cancellationToken);
75            
76                    return NoContent();
77                }
78            }
79            
80            public class CreateKeyRequest
81            {
82  ✔  22         public string Name { get; set; } = string.Empty;
83            }
```
# Synaxis.InferenceGateway.WebApi.Controllers.DevLoginRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Controllers.DevLoginRequest |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Controllers/AuthController.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 56 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Email()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Controllers/AuthController.cs
```
 1             using Microsoft.AspNetCore.Mvc;
 2             using Synaxis.InferenceGateway.Application.Security;
 3             using Synaxis.InferenceGateway.Application.ControlPlane.Entities;
 4             using Synaxis.InferenceGateway.Infrastructure.ControlPlane;
 5             using Microsoft.EntityFrameworkCore;
 6             
 7             namespace Synaxis.InferenceGateway.WebApi.Controllers;
 8             
 9             [ApiController]
10             [Route("auth")]
11             public class AuthController : ControllerBase
12             {
13                 private readonly IJwtService _jwtService;
14                 private readonly ControlPlaneDbContext _dbContext;
15             
16                 public AuthController(IJwtService jwtService, ControlPlaneDbContext dbContext)
17                 {
18                     _jwtService = jwtService;
19                     _dbContext = dbContext;
20                 }
21             
22                 [HttpPost("dev-login")]
23                 public async Task<IActionResult> DevLogin([FromBody] DevLoginRequest request, CancellationToken cancellationToken)
24                 {
25                     // Only for dev/MVP
26                     var user = await _dbContext.Users
27                         .FirstOrDefaultAsync(u => u.Email == request.Email, cancellationToken);
28             
29                     if (user == null)
30                     {
31                         // Auto-register for dev
32                         var tenant = new Tenant { Id = Guid.NewGuid(), Name = "Dev Tenant", Region = TenantRegion.Us, Status = Tenan
33                         _dbContext.Tenants.Add(tenant);
34             
35                         user = new User
36                         {
37                             Id = Guid.NewGuid(),
38                             TenantId = tenant.Id,
39                             Email = request.Email,
40                             Role = UserRole.Owner,
41                             AuthProvider = "dev",
42                             ProviderUserId = request.Email
43                         };
44                         _dbContext.Users.Add(user);
45                         await _dbContext.SaveChangesAsync(cancellationToken);
46                     }
47             
48                     var token = _jwtService.GenerateToken(user);
49                     return Ok(new { token });
50                 }
51             }
52             
53             public class DevLoginRequest
54             {
55  ✔  212         public string Email { get; set; } = string.Empty;
56             }
```
# Synaxis.InferenceGateway.WebApi.DTOs.CompletionRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.DTOs.CompletionRequest |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/CompletionRequest.cs |
| **Line coverage:** | 60% (6 of 10) |
| Covered lines: | 6 |
| Uncovered lines: | 4 |
| Coverable lines: | 10 |
| Total lines: | 29 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_Prompt()** | 100% | 1 | 1 | 100% |
| **get_MaxTokens()** | 100% | 1 | 1 | 100% |
| **get_Temperature()** | 100% | 1 | 1 | 100% |
| **get_Stream()** | 100% | 1 | 1 | 100% |
| **get_User()** | 100% | 2 | 1 | 0% |
| **get_Echo()** | 100% | 2 | 1 | 0% |
| **get_Stop()** | 100% | 2 | 1 | 0% |
| **get_BestOf()** | 100% | 1 | 1 | 100% |
| **get_ExtensionData()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/CompletionRequest.cs
```
 1           using System.Collections.Generic;
 2           using System.Text.Json.Serialization;
 3           
 4           namespace Synaxis.InferenceGateway.WebApi.DTOs;
 5           
 6           public class CompletionRequest
 7           {
 8               [JsonPropertyName("model")]
 9  ✔  8         public string Model { get; set; } = "";
10               [JsonPropertyName("prompt")]
11  ✔  4         public object? Prompt { get; set; } // string or array of strings
12               [JsonPropertyName("max_tokens")]
13  ✔  3         public int? MaxTokens { get; set; }
14               [JsonPropertyName("temperature")]
15  ✔  2         public double? Temperature { get; set; }
16               [JsonPropertyName("stream")]
17  ✔  7         public bool Stream { get; set; }
18               [JsonPropertyName("user")]
19  ❌ 0         public string? User { get; set; }
20               [JsonPropertyName("echo")]
21  ❌ 0         public bool Echo { get; set; }
22               [JsonPropertyName("stop")]
23  ❌ 0         public object? Stop { get; set; } // string or array
24               [JsonPropertyName("best_of")]
25  ✔  1         public int? BestOf { get; set; }
26           
27               [JsonExtensionData]
28  ❌ 0         public Dictionary<string, object>? ExtensionData { get; set; }
29           }
```
# Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChoice

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChoice |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 130 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Index()** | 100% | 1 | 1 | 100% |
| **get_Message()** | 100% | 1 | 1 | 100% |
| **get_FinishReason()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs
```
  1           using System.Text.Json.Serialization;
  2           
  3           namespace Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
  4           
  5           public class ChatCompletionRequest
  6           {
  7               [JsonPropertyName("model")]
  8               public string Model { get; set; } = string.Empty;
  9           
 10               [JsonPropertyName("messages")]
 11               public List<ChatCompletionMessageDto> Messages { get; set; } = new();
 12           
 13               [JsonPropertyName("stream")]
 14               public bool Stream { get; set; } = false;
 15           
 16               [JsonPropertyName("temperature")]
 17               public double? Temperature { get; set; }
 18           
 19               [JsonPropertyName("max_tokens")]
 20               public int? MaxTokens { get; set; }
 21           
 22               [JsonPropertyName("top_p")]
 23               public double? TopP { get; set; }
 24           
 25               [JsonPropertyName("tools")]
 26               public List<object>? Tools { get; set; }
 27           }
 28           
 29           public class ChatCompletionMessageDto
 30           {
 31               [JsonPropertyName("role")]
 32               public string Role { get; set; } = string.Empty;
 33           
 34               [JsonPropertyName("content")]
 35               public object? Content { get; set; } // string or list
 36           
 37               [JsonPropertyName("name")]
 38               public string? Name { get; set; }
 39           
 40               [JsonPropertyName("tool_calls")]
 41               public List<object>? ToolCalls { get; set; }
 42           }
 43           
 44           public class ChatCompletionResponse
 45           {
 46               [JsonPropertyName("id")]
 47               public string Id { get; set; } = string.Empty;
 48           
 49               [JsonPropertyName("object")]
 50               public string Object { get; set; } = "chat.completion";
 51           
 52               [JsonPropertyName("created")]
 53               public long Created { get; set; }
 54           
 55               [JsonPropertyName("model")]
 56               public string Model { get; set; } = string.Empty;
 57           
 58               [JsonPropertyName("choices")]
 59               public List<ChatCompletionChoice> Choices { get; set; } = new();
 60           
 61               [JsonPropertyName("usage")]
 62               public ChatCompletionUsage? Usage { get; set; }
 63           }
 64           
 65           public class ChatCompletionChoice
 66           {
 67               [JsonPropertyName("index")]
 68  ✔  4         public int Index { get; set; }
 69           
 70               [JsonPropertyName("message")]
 71  ✔  6         public ChatCompletionMessageDto Message { get; set; } = new();
 72           
 73               [JsonPropertyName("finish_reason")]
 74  ✔  4         public string? FinishReason { get; set; }
 75           }
 76           
 77           public class ChatCompletionUsage
 78           {
 79               [JsonPropertyName("prompt_tokens")]
 80               public int PromptTokens { get; set; }
 81           
 82               [JsonPropertyName("completion_tokens")]
 83               public int CompletionTokens { get; set; }
 84           
 85               [JsonPropertyName("total_tokens")]
 86               public int TotalTokens { get; set; }
 87           }
 88           
 89           // Chunk DTOs for Streaming
 90           public class ChatCompletionChunk
 91           {
 92               [JsonPropertyName("id")]
 93               public string Id { get; set; } = string.Empty;
 94           
 95               [JsonPropertyName("object")]
 96               public string Object { get; set; } = "chat.completion.chunk";
 97           
 98               [JsonPropertyName("created")]
 99               public long Created { get; set; }
100           
101               [JsonPropertyName("model")]
102               public string Model { get; set; } = string.Empty;
103           
104               [JsonPropertyName("choices")]
105               public List<ChatCompletionChunkChoice> Choices { get; set; } = new();
106           }
107           
108           public class ChatCompletionChunkChoice
109           {
110               [JsonPropertyName("index")]
111               public int Index { get; set; }
112           
113               [JsonPropertyName("delta")]
114               public ChatCompletionChunkDelta Delta { get; set; } = new();
115           
116               [JsonPropertyName("finish_reason")]
117               public string? FinishReason { get; set; }
118           }
119           
120           public class ChatCompletionChunkDelta
121           {
122               [JsonPropertyName("role")]
123               public string? Role { get; set; }
124           
125               [JsonPropertyName("content")]
126               public string? Content { get; set; }
127           
128               [JsonPropertyName("tool_calls")]
129               public List<object>? ToolCalls { get; set; }
130           }
```
# Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChunk

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChunk |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs |
| **Line coverage:** | 100% (5 of 5) |
| Covered lines: | 5 |
| Uncovered lines: | 0 |
| Coverable lines: | 5 |
| Total lines: | 130 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Object()** | 100% | 1 | 1 | 100% |
| **get_Created()** | 100% | 1 | 1 | 100% |
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_Choices()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs
```
  1            using System.Text.Json.Serialization;
  2            
  3            namespace Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
  4            
  5            public class ChatCompletionRequest
  6            {
  7                [JsonPropertyName("model")]
  8                public string Model { get; set; } = string.Empty;
  9            
 10                [JsonPropertyName("messages")]
 11                public List<ChatCompletionMessageDto> Messages { get; set; } = new();
 12            
 13                [JsonPropertyName("stream")]
 14                public bool Stream { get; set; } = false;
 15            
 16                [JsonPropertyName("temperature")]
 17                public double? Temperature { get; set; }
 18            
 19                [JsonPropertyName("max_tokens")]
 20                public int? MaxTokens { get; set; }
 21            
 22                [JsonPropertyName("top_p")]
 23                public double? TopP { get; set; }
 24            
 25                [JsonPropertyName("tools")]
 26                public List<object>? Tools { get; set; }
 27            }
 28            
 29            public class ChatCompletionMessageDto
 30            {
 31                [JsonPropertyName("role")]
 32                public string Role { get; set; } = string.Empty;
 33            
 34                [JsonPropertyName("content")]
 35                public object? Content { get; set; } // string or list
 36            
 37                [JsonPropertyName("name")]
 38                public string? Name { get; set; }
 39            
 40                [JsonPropertyName("tool_calls")]
 41                public List<object>? ToolCalls { get; set; }
 42            }
 43            
 44            public class ChatCompletionResponse
 45            {
 46                [JsonPropertyName("id")]
 47                public string Id { get; set; } = string.Empty;
 48            
 49                [JsonPropertyName("object")]
 50                public string Object { get; set; } = "chat.completion";
 51            
 52                [JsonPropertyName("created")]
 53                public long Created { get; set; }
 54            
 55                [JsonPropertyName("model")]
 56                public string Model { get; set; } = string.Empty;
 57            
 58                [JsonPropertyName("choices")]
 59                public List<ChatCompletionChoice> Choices { get; set; } = new();
 60            
 61                [JsonPropertyName("usage")]
 62                public ChatCompletionUsage? Usage { get; set; }
 63            }
 64            
 65            public class ChatCompletionChoice
 66            {
 67                [JsonPropertyName("index")]
 68                public int Index { get; set; }
 69            
 70                [JsonPropertyName("message")]
 71                public ChatCompletionMessageDto Message { get; set; } = new();
 72            
 73                [JsonPropertyName("finish_reason")]
 74                public string? FinishReason { get; set; }
 75            }
 76            
 77            public class ChatCompletionUsage
 78            {
 79                [JsonPropertyName("prompt_tokens")]
 80                public int PromptTokens { get; set; }
 81            
 82                [JsonPropertyName("completion_tokens")]
 83                public int CompletionTokens { get; set; }
 84            
 85                [JsonPropertyName("total_tokens")]
 86                public int TotalTokens { get; set; }
 87            }
 88            
 89            // Chunk DTOs for Streaming
 90            public class ChatCompletionChunk
 91            {
 92                [JsonPropertyName("id")]
 93  ✔  12         public string Id { get; set; } = string.Empty;
 94            
 95                [JsonPropertyName("object")]
 96  ✔  12         public string Object { get; set; } = "chat.completion.chunk";
 97            
 98                [JsonPropertyName("created")]
 99  ✔   8         public long Created { get; set; }
100            
101                [JsonPropertyName("model")]
102  ✔  12         public string Model { get; set; } = string.Empty;
103            
104                [JsonPropertyName("choices")]
105  ✔  12         public List<ChatCompletionChunkChoice> Choices { get; set; } = new();
106            }
107            
108            public class ChatCompletionChunkChoice
109            {
110                [JsonPropertyName("index")]
111                public int Index { get; set; }
112            
113                [JsonPropertyName("delta")]
114                public ChatCompletionChunkDelta Delta { get; set; } = new();
115            
116                [JsonPropertyName("finish_reason")]
117                public string? FinishReason { get; set; }
118            }
119            
120            public class ChatCompletionChunkDelta
121            {
122                [JsonPropertyName("role")]
123                public string? Role { get; set; }
124            
125                [JsonPropertyName("content")]
126                public string? Content { get; set; }
127            
128                [JsonPropertyName("tool_calls")]
129                public List<object>? ToolCalls { get; set; }
130            }
```
# Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChunkChoice

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChunkChoice |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 130 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Index()** | 100% | 1 | 1 | 100% |
| **get_Delta()** | 100% | 1 | 1 | 100% |
| **get_FinishReason()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs
```
  1            using System.Text.Json.Serialization;
  2            
  3            namespace Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
  4            
  5            public class ChatCompletionRequest
  6            {
  7                [JsonPropertyName("model")]
  8                public string Model { get; set; } = string.Empty;
  9            
 10                [JsonPropertyName("messages")]
 11                public List<ChatCompletionMessageDto> Messages { get; set; } = new();
 12            
 13                [JsonPropertyName("stream")]
 14                public bool Stream { get; set; } = false;
 15            
 16                [JsonPropertyName("temperature")]
 17                public double? Temperature { get; set; }
 18            
 19                [JsonPropertyName("max_tokens")]
 20                public int? MaxTokens { get; set; }
 21            
 22                [JsonPropertyName("top_p")]
 23                public double? TopP { get; set; }
 24            
 25                [JsonPropertyName("tools")]
 26                public List<object>? Tools { get; set; }
 27            }
 28            
 29            public class ChatCompletionMessageDto
 30            {
 31                [JsonPropertyName("role")]
 32                public string Role { get; set; } = string.Empty;
 33            
 34                [JsonPropertyName("content")]
 35                public object? Content { get; set; } // string or list
 36            
 37                [JsonPropertyName("name")]
 38                public string? Name { get; set; }
 39            
 40                [JsonPropertyName("tool_calls")]
 41                public List<object>? ToolCalls { get; set; }
 42            }
 43            
 44            public class ChatCompletionResponse
 45            {
 46                [JsonPropertyName("id")]
 47                public string Id { get; set; } = string.Empty;
 48            
 49                [JsonPropertyName("object")]
 50                public string Object { get; set; } = "chat.completion";
 51            
 52                [JsonPropertyName("created")]
 53                public long Created { get; set; }
 54            
 55                [JsonPropertyName("model")]
 56                public string Model { get; set; } = string.Empty;
 57            
 58                [JsonPropertyName("choices")]
 59                public List<ChatCompletionChoice> Choices { get; set; } = new();
 60            
 61                [JsonPropertyName("usage")]
 62                public ChatCompletionUsage? Usage { get; set; }
 63            }
 64            
 65            public class ChatCompletionChoice
 66            {
 67                [JsonPropertyName("index")]
 68                public int Index { get; set; }
 69            
 70                [JsonPropertyName("message")]
 71                public ChatCompletionMessageDto Message { get; set; } = new();
 72            
 73                [JsonPropertyName("finish_reason")]
 74                public string? FinishReason { get; set; }
 75            }
 76            
 77            public class ChatCompletionUsage
 78            {
 79                [JsonPropertyName("prompt_tokens")]
 80                public int PromptTokens { get; set; }
 81            
 82                [JsonPropertyName("completion_tokens")]
 83                public int CompletionTokens { get; set; }
 84            
 85                [JsonPropertyName("total_tokens")]
 86                public int TotalTokens { get; set; }
 87            }
 88            
 89            // Chunk DTOs for Streaming
 90            public class ChatCompletionChunk
 91            {
 92                [JsonPropertyName("id")]
 93                public string Id { get; set; } = string.Empty;
 94            
 95                [JsonPropertyName("object")]
 96                public string Object { get; set; } = "chat.completion.chunk";
 97            
 98                [JsonPropertyName("created")]
 99                public long Created { get; set; }
100            
101                [JsonPropertyName("model")]
102                public string Model { get; set; } = string.Empty;
103            
104                [JsonPropertyName("choices")]
105                public List<ChatCompletionChunkChoice> Choices { get; set; } = new();
106            }
107            
108            public class ChatCompletionChunkChoice
109            {
110                [JsonPropertyName("index")]
111  ✔   8         public int Index { get; set; }
112            
113                [JsonPropertyName("delta")]
114  ✔  12         public ChatCompletionChunkDelta Delta { get; set; } = new();
115            
116                [JsonPropertyName("finish_reason")]
117  ✔   8         public string? FinishReason { get; set; }
118            }
119            
120            public class ChatCompletionChunkDelta
121            {
122                [JsonPropertyName("role")]
123                public string? Role { get; set; }
124            
125                [JsonPropertyName("content")]
126                public string? Content { get; set; }
127            
128                [JsonPropertyName("tool_calls")]
129                public List<object>? ToolCalls { get; set; }
130            }
```
# Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChunkDelta

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionChunkDelta |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 130 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Role()** | 100% | 1 | 1 | 100% |
| **get_Content()** | 100% | 1 | 1 | 100% |
| **get_ToolCalls()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs
```
  1           using System.Text.Json.Serialization;
  2           
  3           namespace Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
  4           
  5           public class ChatCompletionRequest
  6           {
  7               [JsonPropertyName("model")]
  8               public string Model { get; set; } = string.Empty;
  9           
 10               [JsonPropertyName("messages")]
 11               public List<ChatCompletionMessageDto> Messages { get; set; } = new();
 12           
 13               [JsonPropertyName("stream")]
 14               public bool Stream { get; set; } = false;
 15           
 16               [JsonPropertyName("temperature")]
 17               public double? Temperature { get; set; }
 18           
 19               [JsonPropertyName("max_tokens")]
 20               public int? MaxTokens { get; set; }
 21           
 22               [JsonPropertyName("top_p")]
 23               public double? TopP { get; set; }
 24           
 25               [JsonPropertyName("tools")]
 26               public List<object>? Tools { get; set; }
 27           }
 28           
 29           public class ChatCompletionMessageDto
 30           {
 31               [JsonPropertyName("role")]
 32               public string Role { get; set; } = string.Empty;
 33           
 34               [JsonPropertyName("content")]
 35               public object? Content { get; set; } // string or list
 36           
 37               [JsonPropertyName("name")]
 38               public string? Name { get; set; }
 39           
 40               [JsonPropertyName("tool_calls")]
 41               public List<object>? ToolCalls { get; set; }
 42           }
 43           
 44           public class ChatCompletionResponse
 45           {
 46               [JsonPropertyName("id")]
 47               public string Id { get; set; } = string.Empty;
 48           
 49               [JsonPropertyName("object")]
 50               public string Object { get; set; } = "chat.completion";
 51           
 52               [JsonPropertyName("created")]
 53               public long Created { get; set; }
 54           
 55               [JsonPropertyName("model")]
 56               public string Model { get; set; } = string.Empty;
 57           
 58               [JsonPropertyName("choices")]
 59               public List<ChatCompletionChoice> Choices { get; set; } = new();
 60           
 61               [JsonPropertyName("usage")]
 62               public ChatCompletionUsage? Usage { get; set; }
 63           }
 64           
 65           public class ChatCompletionChoice
 66           {
 67               [JsonPropertyName("index")]
 68               public int Index { get; set; }
 69           
 70               [JsonPropertyName("message")]
 71               public ChatCompletionMessageDto Message { get; set; } = new();
 72           
 73               [JsonPropertyName("finish_reason")]
 74               public string? FinishReason { get; set; }
 75           }
 76           
 77           public class ChatCompletionUsage
 78           {
 79               [JsonPropertyName("prompt_tokens")]
 80               public int PromptTokens { get; set; }
 81           
 82               [JsonPropertyName("completion_tokens")]
 83               public int CompletionTokens { get; set; }
 84           
 85               [JsonPropertyName("total_tokens")]
 86               public int TotalTokens { get; set; }
 87           }
 88           
 89           // Chunk DTOs for Streaming
 90           public class ChatCompletionChunk
 91           {
 92               [JsonPropertyName("id")]
 93               public string Id { get; set; } = string.Empty;
 94           
 95               [JsonPropertyName("object")]
 96               public string Object { get; set; } = "chat.completion.chunk";
 97           
 98               [JsonPropertyName("created")]
 99               public long Created { get; set; }
100           
101               [JsonPropertyName("model")]
102               public string Model { get; set; } = string.Empty;
103           
104               [JsonPropertyName("choices")]
105               public List<ChatCompletionChunkChoice> Choices { get; set; } = new();
106           }
107           
108           public class ChatCompletionChunkChoice
109           {
110               [JsonPropertyName("index")]
111               public int Index { get; set; }
112           
113               [JsonPropertyName("delta")]
114               public ChatCompletionChunkDelta Delta { get; set; } = new();
115           
116               [JsonPropertyName("finish_reason")]
117               public string? FinishReason { get; set; }
118           }
119           
120           public class ChatCompletionChunkDelta
121           {
122               [JsonPropertyName("role")]
123  ✔  4         public string? Role { get; set; }
124           
125               [JsonPropertyName("content")]
126  ✔  7         public string? Content { get; set; }
127           
128               [JsonPropertyName("tool_calls")]
129  ✔  4         public List<object>? ToolCalls { get; set; }
130           }
```
# Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionMessageDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionMessageDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 130 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Role()** | 100% | 1 | 1 | 100% |
| **get_Content()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_ToolCalls()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs
```
  1           using System.Text.Json.Serialization;
  2           
  3           namespace Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
  4           
  5           public class ChatCompletionRequest
  6           {
  7               [JsonPropertyName("model")]
  8               public string Model { get; set; } = string.Empty;
  9           
 10               [JsonPropertyName("messages")]
 11               public List<ChatCompletionMessageDto> Messages { get; set; } = new();
 12           
 13               [JsonPropertyName("stream")]
 14               public bool Stream { get; set; } = false;
 15           
 16               [JsonPropertyName("temperature")]
 17               public double? Temperature { get; set; }
 18           
 19               [JsonPropertyName("max_tokens")]
 20               public int? MaxTokens { get; set; }
 21           
 22               [JsonPropertyName("top_p")]
 23               public double? TopP { get; set; }
 24           
 25               [JsonPropertyName("tools")]
 26               public List<object>? Tools { get; set; }
 27           }
 28           
 29           public class ChatCompletionMessageDto
 30           {
 31               [JsonPropertyName("role")]
 32  ✔  8         public string Role { get; set; } = string.Empty;
 33           
 34               [JsonPropertyName("content")]
 35  ✔  4         public object? Content { get; set; } // string or list
 36           
 37               [JsonPropertyName("name")]
 38  ✔  2         public string? Name { get; set; }
 39           
 40               [JsonPropertyName("tool_calls")]
 41  ✔  2         public List<object>? ToolCalls { get; set; }
 42           }
 43           
 44           public class ChatCompletionResponse
 45           {
 46               [JsonPropertyName("id")]
 47               public string Id { get; set; } = string.Empty;
 48           
 49               [JsonPropertyName("object")]
 50               public string Object { get; set; } = "chat.completion";
 51           
 52               [JsonPropertyName("created")]
 53               public long Created { get; set; }
 54           
 55               [JsonPropertyName("model")]
 56               public string Model { get; set; } = string.Empty;
 57           
 58               [JsonPropertyName("choices")]
 59               public List<ChatCompletionChoice> Choices { get; set; } = new();
 60           
 61               [JsonPropertyName("usage")]
 62               public ChatCompletionUsage? Usage { get; set; }
 63           }
 64           
 65           public class ChatCompletionChoice
 66           {
 67               [JsonPropertyName("index")]
 68               public int Index { get; set; }
 69           
 70               [JsonPropertyName("message")]
 71               public ChatCompletionMessageDto Message { get; set; } = new();
 72           
 73               [JsonPropertyName("finish_reason")]
 74               public string? FinishReason { get; set; }
 75           }
 76           
 77           public class ChatCompletionUsage
 78           {
 79               [JsonPropertyName("prompt_tokens")]
 80               public int PromptTokens { get; set; }
 81           
 82               [JsonPropertyName("completion_tokens")]
 83               public int CompletionTokens { get; set; }
 84           
 85               [JsonPropertyName("total_tokens")]
 86               public int TotalTokens { get; set; }
 87           }
 88           
 89           // Chunk DTOs for Streaming
 90           public class ChatCompletionChunk
 91           {
 92               [JsonPropertyName("id")]
 93               public string Id { get; set; } = string.Empty;
 94           
 95               [JsonPropertyName("object")]
 96               public string Object { get; set; } = "chat.completion.chunk";
 97           
 98               [JsonPropertyName("created")]
 99               public long Created { get; set; }
100           
101               [JsonPropertyName("model")]
102               public string Model { get; set; } = string.Empty;
103           
104               [JsonPropertyName("choices")]
105               public List<ChatCompletionChunkChoice> Choices { get; set; } = new();
106           }
107           
108           public class ChatCompletionChunkChoice
109           {
110               [JsonPropertyName("index")]
111               public int Index { get; set; }
112           
113               [JsonPropertyName("delta")]
114               public ChatCompletionChunkDelta Delta { get; set; } = new();
115           
116               [JsonPropertyName("finish_reason")]
117               public string? FinishReason { get; set; }
118           }
119           
120           public class ChatCompletionChunkDelta
121           {
122               [JsonPropertyName("role")]
123               public string? Role { get; set; }
124           
125               [JsonPropertyName("content")]
126               public string? Content { get; set; }
127           
128               [JsonPropertyName("tool_calls")]
129               public List<object>? ToolCalls { get; set; }
130           }
```
# Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionRequest |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs |
| **Line coverage:** | 0% (0 of 7) |
| Covered lines: | 0 |
| Uncovered lines: | 7 |
| Coverable lines: | 7 |
| Total lines: | 130 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Model()** | 100% | 2 | 1 | 0% |
| **get_Messages()** | 100% | 2 | 1 | 0% |
| **get_Stream()** | 100% | 2 | 1 | 0% |
| **get_Temperature()** | 100% | 2 | 1 | 0% |
| **get_MaxTokens()** | 100% | 2 | 1 | 0% |
| **get_TopP()** | 100% | 2 | 1 | 0% |
| **get_Tools()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs
```
  1           using System.Text.Json.Serialization;
  2           
  3           namespace Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
  4           
  5           public class ChatCompletionRequest
  6           {
  7               [JsonPropertyName("model")]
  8  ❌ 0         public string Model { get; set; } = string.Empty;
  9           
 10               [JsonPropertyName("messages")]
 11  ❌ 0         public List<ChatCompletionMessageDto> Messages { get; set; } = new();
 12           
 13               [JsonPropertyName("stream")]
 14  ❌ 0         public bool Stream { get; set; } = false;
 15           
 16               [JsonPropertyName("temperature")]
 17  ❌ 0         public double? Temperature { get; set; }
 18           
 19               [JsonPropertyName("max_tokens")]
 20  ❌ 0         public int? MaxTokens { get; set; }
 21           
 22               [JsonPropertyName("top_p")]
 23  ❌ 0         public double? TopP { get; set; }
 24           
 25               [JsonPropertyName("tools")]
 26  ❌ 0         public List<object>? Tools { get; set; }
 27           }
 28           
 29           public class ChatCompletionMessageDto
 30           {
 31               [JsonPropertyName("role")]
 32               public string Role { get; set; } = string.Empty;
 33           
 34               [JsonPropertyName("content")]
 35               public object? Content { get; set; } // string or list
 36           
 37               [JsonPropertyName("name")]
 38               public string? Name { get; set; }
 39           
 40               [JsonPropertyName("tool_calls")]
 41               public List<object>? ToolCalls { get; set; }
 42           }
 43           
 44           public class ChatCompletionResponse
 45           {
 46               [JsonPropertyName("id")]
 47               public string Id { get; set; } = string.Empty;
 48           
 49               [JsonPropertyName("object")]
 50               public string Object { get; set; } = "chat.completion";
 51           
 52               [JsonPropertyName("created")]
 53               public long Created { get; set; }
 54           
 55               [JsonPropertyName("model")]
 56               public string Model { get; set; } = string.Empty;
 57           
 58               [JsonPropertyName("choices")]
 59               public List<ChatCompletionChoice> Choices { get; set; } = new();
 60           
 61               [JsonPropertyName("usage")]
 62               public ChatCompletionUsage? Usage { get; set; }
 63           }
 64           
 65           public class ChatCompletionChoice
 66           {
 67               [JsonPropertyName("index")]
 68               public int Index { get; set; }
 69           
 70               [JsonPropertyName("message")]
 71               public ChatCompletionMessageDto Message { get; set; } = new();
 72           
 73               [JsonPropertyName("finish_reason")]
 74               public string? FinishReason { get; set; }
 75           }
 76           
 77           public class ChatCompletionUsage
 78           {
 79               [JsonPropertyName("prompt_tokens")]
 80               public int PromptTokens { get; set; }
 81           
 82               [JsonPropertyName("completion_tokens")]
 83               public int CompletionTokens { get; set; }
 84           
 85               [JsonPropertyName("total_tokens")]
 86               public int TotalTokens { get; set; }
 87           }
 88           
 89           // Chunk DTOs for Streaming
 90           public class ChatCompletionChunk
 91           {
 92               [JsonPropertyName("id")]
 93               public string Id { get; set; } = string.Empty;
 94           
 95               [JsonPropertyName("object")]
 96               public string Object { get; set; } = "chat.completion.chunk";
 97           
 98               [JsonPropertyName("created")]
 99               public long Created { get; set; }
100           
101               [JsonPropertyName("model")]
102               public string Model { get; set; } = string.Empty;
103           
104               [JsonPropertyName("choices")]
105               public List<ChatCompletionChunkChoice> Choices { get; set; } = new();
106           }
107           
108           public class ChatCompletionChunkChoice
109           {
110               [JsonPropertyName("index")]
111               public int Index { get; set; }
112           
113               [JsonPropertyName("delta")]
114               public ChatCompletionChunkDelta Delta { get; set; } = new();
115           
116               [JsonPropertyName("finish_reason")]
117               public string? FinishReason { get; set; }
118           }
119           
120           public class ChatCompletionChunkDelta
121           {
122               [JsonPropertyName("role")]
123               public string? Role { get; set; }
124           
125               [JsonPropertyName("content")]
126               public string? Content { get; set; }
127           
128               [JsonPropertyName("tool_calls")]
129               public List<object>? ToolCalls { get; set; }
130           }
```
# Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionResponse

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionResponse |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs |
| **Line coverage:** | 100% (6 of 6) |
| Covered lines: | 6 |
| Uncovered lines: | 0 |
| Coverable lines: | 6 |
| Total lines: | 130 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Object()** | 100% | 1 | 1 | 100% |
| **get_Created()** | 100% | 1 | 1 | 100% |
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_Choices()** | 100% | 1 | 1 | 100% |
| **get_Usage()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs
```
  1           using System.Text.Json.Serialization;
  2           
  3           namespace Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
  4           
  5           public class ChatCompletionRequest
  6           {
  7               [JsonPropertyName("model")]
  8               public string Model { get; set; } = string.Empty;
  9           
 10               [JsonPropertyName("messages")]
 11               public List<ChatCompletionMessageDto> Messages { get; set; } = new();
 12           
 13               [JsonPropertyName("stream")]
 14               public bool Stream { get; set; } = false;
 15           
 16               [JsonPropertyName("temperature")]
 17               public double? Temperature { get; set; }
 18           
 19               [JsonPropertyName("max_tokens")]
 20               public int? MaxTokens { get; set; }
 21           
 22               [JsonPropertyName("top_p")]
 23               public double? TopP { get; set; }
 24           
 25               [JsonPropertyName("tools")]
 26               public List<object>? Tools { get; set; }
 27           }
 28           
 29           public class ChatCompletionMessageDto
 30           {
 31               [JsonPropertyName("role")]
 32               public string Role { get; set; } = string.Empty;
 33           
 34               [JsonPropertyName("content")]
 35               public object? Content { get; set; } // string or list
 36           
 37               [JsonPropertyName("name")]
 38               public string? Name { get; set; }
 39           
 40               [JsonPropertyName("tool_calls")]
 41               public List<object>? ToolCalls { get; set; }
 42           }
 43           
 44           public class ChatCompletionResponse
 45           {
 46               [JsonPropertyName("id")]
 47  ✔  6         public string Id { get; set; } = string.Empty;
 48           
 49               [JsonPropertyName("object")]
 50  ✔  6         public string Object { get; set; } = "chat.completion";
 51           
 52               [JsonPropertyName("created")]
 53  ✔  4         public long Created { get; set; }
 54           
 55               [JsonPropertyName("model")]
 56  ✔  6         public string Model { get; set; } = string.Empty;
 57           
 58               [JsonPropertyName("choices")]
 59  ✔  6         public List<ChatCompletionChoice> Choices { get; set; } = new();
 60           
 61               [JsonPropertyName("usage")]
 62  ✔  4         public ChatCompletionUsage? Usage { get; set; }
 63           }
 64           
 65           public class ChatCompletionChoice
 66           {
 67               [JsonPropertyName("index")]
 68               public int Index { get; set; }
 69           
 70               [JsonPropertyName("message")]
 71               public ChatCompletionMessageDto Message { get; set; } = new();
 72           
 73               [JsonPropertyName("finish_reason")]
 74               public string? FinishReason { get; set; }
 75           }
 76           
 77           public class ChatCompletionUsage
 78           {
 79               [JsonPropertyName("prompt_tokens")]
 80               public int PromptTokens { get; set; }
 81           
 82               [JsonPropertyName("completion_tokens")]
 83               public int CompletionTokens { get; set; }
 84           
 85               [JsonPropertyName("total_tokens")]
 86               public int TotalTokens { get; set; }
 87           }
 88           
 89           // Chunk DTOs for Streaming
 90           public class ChatCompletionChunk
 91           {
 92               [JsonPropertyName("id")]
 93               public string Id { get; set; } = string.Empty;
 94           
 95               [JsonPropertyName("object")]
 96               public string Object { get; set; } = "chat.completion.chunk";
 97           
 98               [JsonPropertyName("created")]
 99               public long Created { get; set; }
100           
101               [JsonPropertyName("model")]
102               public string Model { get; set; } = string.Empty;
103           
104               [JsonPropertyName("choices")]
105               public List<ChatCompletionChunkChoice> Choices { get; set; } = new();
106           }
107           
108           public class ChatCompletionChunkChoice
109           {
110               [JsonPropertyName("index")]
111               public int Index { get; set; }
112           
113               [JsonPropertyName("delta")]
114               public ChatCompletionChunkDelta Delta { get; set; } = new();
115           
116               [JsonPropertyName("finish_reason")]
117               public string? FinishReason { get; set; }
118           }
119           
120           public class ChatCompletionChunkDelta
121           {
122               [JsonPropertyName("role")]
123               public string? Role { get; set; }
124           
125               [JsonPropertyName("content")]
126               public string? Content { get; set; }
127           
128               [JsonPropertyName("tool_calls")]
129               public List<object>? ToolCalls { get; set; }
130           }
```
# Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionUsage

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.DTOs.OpenAi.ChatCompletionUsage |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 130 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_PromptTokens()** | 100% | 1 | 1 | 100% |
| **get_CompletionTokens()** | 100% | 1 | 1 | 100% |
| **get_TotalTokens()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/DTOs/OpenAi/ChatDtos.cs
```
  1           using System.Text.Json.Serialization;
  2           
  3           namespace Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
  4           
  5           public class ChatCompletionRequest
  6           {
  7               [JsonPropertyName("model")]
  8               public string Model { get; set; } = string.Empty;
  9           
 10               [JsonPropertyName("messages")]
 11               public List<ChatCompletionMessageDto> Messages { get; set; } = new();
 12           
 13               [JsonPropertyName("stream")]
 14               public bool Stream { get; set; } = false;
 15           
 16               [JsonPropertyName("temperature")]
 17               public double? Temperature { get; set; }
 18           
 19               [JsonPropertyName("max_tokens")]
 20               public int? MaxTokens { get; set; }
 21           
 22               [JsonPropertyName("top_p")]
 23               public double? TopP { get; set; }
 24           
 25               [JsonPropertyName("tools")]
 26               public List<object>? Tools { get; set; }
 27           }
 28           
 29           public class ChatCompletionMessageDto
 30           {
 31               [JsonPropertyName("role")]
 32               public string Role { get; set; } = string.Empty;
 33           
 34               [JsonPropertyName("content")]
 35               public object? Content { get; set; } // string or list
 36           
 37               [JsonPropertyName("name")]
 38               public string? Name { get; set; }
 39           
 40               [JsonPropertyName("tool_calls")]
 41               public List<object>? ToolCalls { get; set; }
 42           }
 43           
 44           public class ChatCompletionResponse
 45           {
 46               [JsonPropertyName("id")]
 47               public string Id { get; set; } = string.Empty;
 48           
 49               [JsonPropertyName("object")]
 50               public string Object { get; set; } = "chat.completion";
 51           
 52               [JsonPropertyName("created")]
 53               public long Created { get; set; }
 54           
 55               [JsonPropertyName("model")]
 56               public string Model { get; set; } = string.Empty;
 57           
 58               [JsonPropertyName("choices")]
 59               public List<ChatCompletionChoice> Choices { get; set; } = new();
 60           
 61               [JsonPropertyName("usage")]
 62               public ChatCompletionUsage? Usage { get; set; }
 63           }
 64           
 65           public class ChatCompletionChoice
 66           {
 67               [JsonPropertyName("index")]
 68               public int Index { get; set; }
 69           
 70               [JsonPropertyName("message")]
 71               public ChatCompletionMessageDto Message { get; set; } = new();
 72           
 73               [JsonPropertyName("finish_reason")]
 74               public string? FinishReason { get; set; }
 75           }
 76           
 77           public class ChatCompletionUsage
 78           {
 79               [JsonPropertyName("prompt_tokens")]
 80  ✔  4         public int PromptTokens { get; set; }
 81           
 82               [JsonPropertyName("completion_tokens")]
 83  ✔  4         public int CompletionTokens { get; set; }
 84           
 85               [JsonPropertyName("total_tokens")]
 86  ✔  4         public int TotalTokens { get; set; }
 87           }
 88           
 89           // Chunk DTOs for Streaming
 90           public class ChatCompletionChunk
 91           {
 92               [JsonPropertyName("id")]
 93               public string Id { get; set; } = string.Empty;
 94           
 95               [JsonPropertyName("object")]
 96               public string Object { get; set; } = "chat.completion.chunk";
 97           
 98               [JsonPropertyName("created")]
 99               public long Created { get; set; }
100           
101               [JsonPropertyName("model")]
102               public string Model { get; set; } = string.Empty;
103           
104               [JsonPropertyName("choices")]
105               public List<ChatCompletionChunkChoice> Choices { get; set; } = new();
106           }
107           
108           public class ChatCompletionChunkChoice
109           {
110               [JsonPropertyName("index")]
111               public int Index { get; set; }
112           
113               [JsonPropertyName("delta")]
114               public ChatCompletionChunkDelta Delta { get; set; } = new();
115           
116               [JsonPropertyName("finish_reason")]
117               public string? FinishReason { get; set; }
118           }
119           
120           public class ChatCompletionChunkDelta
121           {
122               [JsonPropertyName("role")]
123               public string? Role { get; set; }
124           
125               [JsonPropertyName("content")]
126               public string? Content { get; set; }
127           
128               [JsonPropertyName("tool_calls")]
129               public List<object>? ToolCalls { get; set; }
130           }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Admin.AdminEndpoints

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Admin.AdminEndpoints |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs |
| **Line coverage:** | 99.2% (140 of 141) |
| Covered lines: | 140 |
| Uncovered lines: | 1 |
| Coverable lines: | 141 |
| Total lines: | 221 |
| **Branch coverage:** | 85.7% (24 of 28) |
| Covered branches: | 24 |
| Total branches: | 28 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **MapAdminEndpoints(...)** | 100% | 20 | 20 | 100% |
| **DetermineOverallStatus(...)** | 50.0% | 8 | 8 | 85.71% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs
```
  1              using Microsoft.AspNetCore.Builder;
  2              using Microsoft.AspNetCore.Http;
  3              using Microsoft.AspNetCore.Routing;
  4              using Microsoft.Extensions.Options;
  5              using Synaxis.InferenceGateway.Application.Configuration;
  6              using Synaxis.InferenceGateway.Application.ControlPlane;
  7              using System;
  8              using System.Collections.Generic;
  9              using System.Linq;
 10              using System.Security.Claims;
 11              
 12              namespace Synaxis.InferenceGateway.WebApi.Endpoints.Admin;
 13              
 14              public static class AdminEndpoints
 15              {
 16                  public static IEndpointRouteBuilder MapAdminEndpoints(this IEndpointRouteBuilder app)
 17  ✔    37         {
 18  ✔    37             var adminGroup = app.MapGroup("/admin")
 19  ✔    74                 .RequireAuthorization(policy => policy.RequireAuthenticatedUser());
 20              
 21  ✔    37             adminGroup.MapGet("/providers", (IOptions<SynaxisConfiguration> config) =>
 22  ✔     8             {
 23  ✔   152                 var providers = config.Value.Providers.Select(p => new ProviderAdminDto
 24  ✔   152                 {
 25  ✔   152                     Id = p.Key,
 26  ✔   152                     Name = p.Key,
 27  ✔   152                     Type = p.Value.Type,
 28  ✔   152                     Enabled = p.Value.Enabled,
 29  ✔   152                     Tier = p.Value.Tier,
 30  ✔   152                     Endpoint = p.Value.Endpoint,
 31  ✔   152                     KeyConfigured = !string.IsNullOrEmpty(p.Value.Key),
 32  ✔   152                     Models = config.Value.CanonicalModels
 33  ✔  5760                         .Where(m => m.Provider == p.Key)
 34  ✔   320                         .Select(m => new ProviderModelDto
 35  ✔   320                         {
 36  ✔   320                             Id = m.Id,
 37  ✔   320                             Name = m.ModelPath,
 38  ✔   320                             Enabled = true
 39  ✔   320                         })
 40  ✔   152                         .ToList(),
 41  ✔   152                     Status = "unknown",
 42  ✔   152                     Latency = null
 43  ✔   152                 }).ToList();
 44  ✔    37     
 45  ✔     8                 return Results.Ok(providers);
 46  ✔     8             })
 47  ✔    37             .WithTags("Admin")
 48  ✔    37             .WithSummary("List all providers")
 49  ✔    37             .WithDescription("Returns a list of all configured AI providers with their settings and status");
 50              
 51  ✔    37             adminGroup.MapPut("/providers/{providerId}", (
 52  ✔    37                 string providerId,
 53  ✔    37                 ProviderUpdateRequest request,
 54  ✔    37                 IOptions<SynaxisConfiguration> config) =>
 55  ✔     5             {
 56  ✔     5  ●              if (!config.Value.Providers.ContainsKey(providerId))
 57  ✔     1                 {
 58  ✔     1                     return Results.NotFound(new { error = $"Provider '{providerId}' not found" });
 59  ✔    37                 }
 60  ✔    37     
 61  ✔     4                 var provider = config.Value.Providers[providerId];
 62  ✔    37     
 63  ✔     4  ●              if (request.Enabled.HasValue)
 64  ✔     1                 {
 65  ✔     1                     provider.Enabled = request.Enabled.Value;
 66  ✔     1                 }
 67  ✔    37     
 68  ✔     4  ●              if (!string.IsNullOrEmpty(request.Key))
 69  ✔     1                 {
 70  ✔     1                     provider.Key = request.Key;
 71  ✔     1                 }
 72  ✔    37     
 73  ✔     4  ●              if (!string.IsNullOrEmpty(request.Endpoint))
 74  ✔     1                 {
 75  ✔     1                     provider.Endpoint = request.Endpoint;
 76  ✔     1                 }
 77  ✔    37     
 78  ✔     4  ●              if (request.Tier.HasValue)
 79  ✔     1                 {
 80  ✔     1                     provider.Tier = request.Tier.Value;
 81  ✔     1                 }
 82  ✔    37     
 83  ✔     4                 return Results.Ok(new { success = true, message = $"Provider '{providerId}' updated successfully" });
 84  ✔     5             })
 85  ✔    37             .WithTags("Admin")
 86  ✔    37             .WithSummary("Update provider configuration")
 87  ✔    37             .WithDescription("Update provider settings including enabled status, API key, endpoint, and tier");
 88              
 89  ✔    37             adminGroup.MapGet("/health", (
 90  ✔    37                 IOptions<SynaxisConfiguration> config) =>
 91  ✔     5             {
 92  ✔     5                 var services = new List<ServiceHealthDto>();
 93  ✔     5                 var providers = new List<ProviderHealthDto>();
 94  ✔    37     
 95  ✔     5                 services.Add(new ServiceHealthDto
 96  ✔     5                 {
 97  ✔     5                     Name = "API Gateway",
 98  ✔     5                     Status = "healthy",
 99  ✔     5                     LastChecked = DateTime.UtcNow.ToString("O")
100  ✔     5                 });
101  ✔    37     
102  ✔     5                 services.Add(new ServiceHealthDto
103  ✔     5                 {
104  ✔     5                     Name = "PostgreSQL",
105  ✔     5                     Status = "healthy",
106  ✔     5                     Latency = 15,
107  ✔     5                     LastChecked = DateTime.UtcNow.ToString("O")
108  ✔     5                 });
109  ✔    37     
110  ✔     5                 services.Add(new ServiceHealthDto
111  ✔     5                 {
112  ✔     5                     Name = "Redis",
113  ✔     5                     Status = "healthy",
114  ✔     5                     Latency = 5,
115  ✔     5                     LastChecked = DateTime.UtcNow.ToString("O")
116  ✔     5                 });
117  ✔    37     
118  ✔   285  ●              foreach (var p in config.Value.Providers.Where(p => p.Value.Enabled))
119  ✔    90                 {
120  ✔    90                     var hasKey = !string.IsNullOrEmpty(p.Value.Key);
121  ✔    90  ●                  var providerHealth = new ProviderHealthDto
122  ✔    90                     {
123  ✔    90                         Id = p.Key,
124  ✔    90                         Name = p.Key,
125  ✔    90                         Status = hasKey ? "online" : "unknown",
126  ✔    90                         LastChecked = DateTime.UtcNow.ToString("O"),
127  ✔    90                         SuccessRate = hasKey ? 98.5 : null,
128  ✔    90                         Latency = hasKey ? new Random().Next(20, 150) : null
129  ✔    90                     };
130  ✔    37     
131  ✔    90  ●                  if (!hasKey)
132  ✔    15                     {
133  ✔    15                         providerHealth.ErrorMessage = "API key not configured";
134  ✔    15                     }
135  ✔    37     
136  ✔    90                     providers.Add(providerHealth);
137  ✔    90                 }
138  ✔    37     
139  ✔     5                 var overallStatus = DetermineOverallStatus(services, providers);
140  ✔    37     
141  ✔     5                 return Results.Ok(new HealthDataDto
142  ✔     5                 {
143  ✔     5                     Services = services,
144  ✔     5                     Providers = providers,
145  ✔     5                     OverallStatus = overallStatus,
146  ✔     5                     Timestamp = DateTime.UtcNow.ToString("O")
147  ✔     5                 });
148  ✔     5             })
149  ✔    37             .WithTags("Admin")
150  ✔    37             .WithSummary("Get system health status")
151  ✔    37             .WithDescription("Returns detailed health information about services and AI providers");
152              
153  ✔    37             return app;
154  ✔    37         }
155              
156                  private static string DetermineOverallStatus(List<ServiceHealthDto> services, List<ProviderHealthDto> providers)
157  ✔     5         {
158  ✓   110  ◑          var anyUnhealthy = services.Any(s => s.Status == "unhealthy") || providers.Any(p => p.Status == "offline");
159  ✓    30  ◑          var anyDegraded = providers.Any(p => p.Status == "degraded" || p.Status == "unknown");
160              
161  ✓     5  ◑          if (anyUnhealthy) return "unhealthy";
162  ✓    10  ◑          if (anyDegraded) return "degraded";
163  ❌    0             return "healthy";
164  ✔     5         }
165              }
166              
167              public class ProviderAdminDto
168              {
169                  public string Id { get; set; } = "";
170                  public string Name { get; set; } = "";
171                  public string Type { get; set; } = "";
172                  public bool Enabled { get; set; }
173                  public int Tier { get; set; }
174                  public string? Endpoint { get; set; }
175                  public bool KeyConfigured { get; set; }
176                  public List<ProviderModelDto> Models { get; set; } = new();
177                  public string Status { get; set; } = "unknown";
178                  public int? Latency { get; set; }
179              }
180              
181              public class ProviderModelDto
182              {
183                  public string Id { get; set; } = "";
184                  public string Name { get; set; } = "";
185                  public bool Enabled { get; set; }
186              }
187              
188              public class ProviderUpdateRequest
189              {
190                  public bool? Enabled { get; set; }
191                  public string? Key { get; set; }
192                  public string? Endpoint { get; set; }
193                  public int? Tier { get; set; }
194              }
195              
196              public class ServiceHealthDto
197              {
198                  public string Name { get; set; } = "";
199                  public string Status { get; set; } = "";
200                  public int? Latency { get; set; }
201                  public string LastChecked { get; set; } = "";
202              }
203              
204              public class ProviderHealthDto
205              {
206                  public string Id { get; set; } = "";
207                  public string Name { get; set; } = "";
208                  public string Status { get; set; } = "";
209                  public int? Latency { get; set; }
210                  public double? SuccessRate { get; set; }
211                  public string LastChecked { get; set; } = "";
212                  public string? ErrorMessage { get; set; }
213              }
214              
215              public class HealthDataDto
216              {
217                  public List<ServiceHealthDto> Services { get; set; } = new();
218                  public List<ProviderHealthDto> Providers { get; set; } = new();
219                  public string OverallStatus { get; set; } = "";
220                  public string Timestamp { get; set; } = "";
221              }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Admin.HealthDataDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Admin.HealthDataDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 221 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Services()** | 100% | 1 | 1 | 100% |
| **get_Providers()** | 100% | 1 | 1 | 100% |
| **get_OverallStatus()** | 100% | 1 | 1 | 100% |
| **get_Timestamp()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Http;
  3            using Microsoft.AspNetCore.Routing;
  4            using Microsoft.Extensions.Options;
  5            using Synaxis.InferenceGateway.Application.Configuration;
  6            using Synaxis.InferenceGateway.Application.ControlPlane;
  7            using System;
  8            using System.Collections.Generic;
  9            using System.Linq;
 10            using System.Security.Claims;
 11            
 12            namespace Synaxis.InferenceGateway.WebApi.Endpoints.Admin;
 13            
 14            public static class AdminEndpoints
 15            {
 16                public static IEndpointRouteBuilder MapAdminEndpoints(this IEndpointRouteBuilder app)
 17                {
 18                    var adminGroup = app.MapGroup("/admin")
 19                        .RequireAuthorization(policy => policy.RequireAuthenticatedUser());
 20            
 21                    adminGroup.MapGet("/providers", (IOptions<SynaxisConfiguration> config) =>
 22                    {
 23                        var providers = config.Value.Providers.Select(p => new ProviderAdminDto
 24                        {
 25                            Id = p.Key,
 26                            Name = p.Key,
 27                            Type = p.Value.Type,
 28                            Enabled = p.Value.Enabled,
 29                            Tier = p.Value.Tier,
 30                            Endpoint = p.Value.Endpoint,
 31                            KeyConfigured = !string.IsNullOrEmpty(p.Value.Key),
 32                            Models = config.Value.CanonicalModels
 33                                .Where(m => m.Provider == p.Key)
 34                                .Select(m => new ProviderModelDto
 35                                {
 36                                    Id = m.Id,
 37                                    Name = m.ModelPath,
 38                                    Enabled = true
 39                                })
 40                                .ToList(),
 41                            Status = "unknown",
 42                            Latency = null
 43                        }).ToList();
 44            
 45                        return Results.Ok(providers);
 46                    })
 47                    .WithTags("Admin")
 48                    .WithSummary("List all providers")
 49                    .WithDescription("Returns a list of all configured AI providers with their settings and status");
 50            
 51                    adminGroup.MapPut("/providers/{providerId}", (
 52                        string providerId,
 53                        ProviderUpdateRequest request,
 54                        IOptions<SynaxisConfiguration> config) =>
 55                    {
 56                        if (!config.Value.Providers.ContainsKey(providerId))
 57                        {
 58                            return Results.NotFound(new { error = $"Provider '{providerId}' not found" });
 59                        }
 60            
 61                        var provider = config.Value.Providers[providerId];
 62            
 63                        if (request.Enabled.HasValue)
 64                        {
 65                            provider.Enabled = request.Enabled.Value;
 66                        }
 67            
 68                        if (!string.IsNullOrEmpty(request.Key))
 69                        {
 70                            provider.Key = request.Key;
 71                        }
 72            
 73                        if (!string.IsNullOrEmpty(request.Endpoint))
 74                        {
 75                            provider.Endpoint = request.Endpoint;
 76                        }
 77            
 78                        if (request.Tier.HasValue)
 79                        {
 80                            provider.Tier = request.Tier.Value;
 81                        }
 82            
 83                        return Results.Ok(new { success = true, message = $"Provider '{providerId}' updated successfully" });
 84                    })
 85                    .WithTags("Admin")
 86                    .WithSummary("Update provider configuration")
 87                    .WithDescription("Update provider settings including enabled status, API key, endpoint, and tier");
 88            
 89                    adminGroup.MapGet("/health", (
 90                        IOptions<SynaxisConfiguration> config) =>
 91                    {
 92                        var services = new List<ServiceHealthDto>();
 93                        var providers = new List<ProviderHealthDto>();
 94            
 95                        services.Add(new ServiceHealthDto
 96                        {
 97                            Name = "API Gateway",
 98                            Status = "healthy",
 99                            LastChecked = DateTime.UtcNow.ToString("O")
100                        });
101            
102                        services.Add(new ServiceHealthDto
103                        {
104                            Name = "PostgreSQL",
105                            Status = "healthy",
106                            Latency = 15,
107                            LastChecked = DateTime.UtcNow.ToString("O")
108                        });
109            
110                        services.Add(new ServiceHealthDto
111                        {
112                            Name = "Redis",
113                            Status = "healthy",
114                            Latency = 5,
115                            LastChecked = DateTime.UtcNow.ToString("O")
116                        });
117            
118                        foreach (var p in config.Value.Providers.Where(p => p.Value.Enabled))
119                        {
120                            var hasKey = !string.IsNullOrEmpty(p.Value.Key);
121                            var providerHealth = new ProviderHealthDto
122                            {
123                                Id = p.Key,
124                                Name = p.Key,
125                                Status = hasKey ? "online" : "unknown",
126                                LastChecked = DateTime.UtcNow.ToString("O"),
127                                SuccessRate = hasKey ? 98.5 : null,
128                                Latency = hasKey ? new Random().Next(20, 150) : null
129                            };
130            
131                            if (!hasKey)
132                            {
133                                providerHealth.ErrorMessage = "API key not configured";
134                            }
135            
136                            providers.Add(providerHealth);
137                        }
138            
139                        var overallStatus = DetermineOverallStatus(services, providers);
140            
141                        return Results.Ok(new HealthDataDto
142                        {
143                            Services = services,
144                            Providers = providers,
145                            OverallStatus = overallStatus,
146                            Timestamp = DateTime.UtcNow.ToString("O")
147                        });
148                    })
149                    .WithTags("Admin")
150                    .WithSummary("Get system health status")
151                    .WithDescription("Returns detailed health information about services and AI providers");
152            
153                    return app;
154                }
155            
156                private static string DetermineOverallStatus(List<ServiceHealthDto> services, List<ProviderHealthDto> providers)
157                {
158                    var anyUnhealthy = services.Any(s => s.Status == "unhealthy") || providers.Any(p => p.Status == "offline");
159                    var anyDegraded = providers.Any(p => p.Status == "degraded" || p.Status == "unknown");
160            
161                    if (anyUnhealthy) return "unhealthy";
162                    if (anyDegraded) return "degraded";
163                    return "healthy";
164                }
165            }
166            
167            public class ProviderAdminDto
168            {
169                public string Id { get; set; } = "";
170                public string Name { get; set; } = "";
171                public string Type { get; set; } = "";
172                public bool Enabled { get; set; }
173                public int Tier { get; set; }
174                public string? Endpoint { get; set; }
175                public bool KeyConfigured { get; set; }
176                public List<ProviderModelDto> Models { get; set; } = new();
177                public string Status { get; set; } = "unknown";
178                public int? Latency { get; set; }
179            }
180            
181            public class ProviderModelDto
182            {
183                public string Id { get; set; } = "";
184                public string Name { get; set; } = "";
185                public bool Enabled { get; set; }
186            }
187            
188            public class ProviderUpdateRequest
189            {
190                public bool? Enabled { get; set; }
191                public string? Key { get; set; }
192                public string? Endpoint { get; set; }
193                public int? Tier { get; set; }
194            }
195            
196            public class ServiceHealthDto
197            {
198                public string Name { get; set; } = "";
199                public string Status { get; set; } = "";
200                public int? Latency { get; set; }
201                public string LastChecked { get; set; } = "";
202            }
203            
204            public class ProviderHealthDto
205            {
206                public string Id { get; set; } = "";
207                public string Name { get; set; } = "";
208                public string Status { get; set; } = "";
209                public int? Latency { get; set; }
210                public double? SuccessRate { get; set; }
211                public string LastChecked { get; set; } = "";
212                public string? ErrorMessage { get; set; }
213            }
214            
215            public class HealthDataDto
216            {
217  ✔  15         public List<ServiceHealthDto> Services { get; set; } = new();
218  ✔  15         public List<ProviderHealthDto> Providers { get; set; } = new();
219  ✔  15         public string OverallStatus { get; set; } = "";
220  ✔  15         public string Timestamp { get; set; } = "";
221            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderAdminDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderAdminDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs |
| **Line coverage:** | 100% (10 of 10) |
| Covered lines: | 10 |
| Uncovered lines: | 0 |
| Coverable lines: | 10 |
| Total lines: | 221 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_Enabled()** | 100% | 1 | 1 | 100% |
| **get_Tier()** | 100% | 1 | 1 | 100% |
| **get_Endpoint()** | 100% | 1 | 1 | 100% |
| **get_KeyConfigured()** | 100% | 1 | 1 | 100% |
| **get_Models()** | 100% | 1 | 1 | 100% |
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_Latency()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs
```
  1             using Microsoft.AspNetCore.Builder;
  2             using Microsoft.AspNetCore.Http;
  3             using Microsoft.AspNetCore.Routing;
  4             using Microsoft.Extensions.Options;
  5             using Synaxis.InferenceGateway.Application.Configuration;
  6             using Synaxis.InferenceGateway.Application.ControlPlane;
  7             using System;
  8             using System.Collections.Generic;
  9             using System.Linq;
 10             using System.Security.Claims;
 11             
 12             namespace Synaxis.InferenceGateway.WebApi.Endpoints.Admin;
 13             
 14             public static class AdminEndpoints
 15             {
 16                 public static IEndpointRouteBuilder MapAdminEndpoints(this IEndpointRouteBuilder app)
 17                 {
 18                     var adminGroup = app.MapGroup("/admin")
 19                         .RequireAuthorization(policy => policy.RequireAuthenticatedUser());
 20             
 21                     adminGroup.MapGet("/providers", (IOptions<SynaxisConfiguration> config) =>
 22                     {
 23                         var providers = config.Value.Providers.Select(p => new ProviderAdminDto
 24                         {
 25                             Id = p.Key,
 26                             Name = p.Key,
 27                             Type = p.Value.Type,
 28                             Enabled = p.Value.Enabled,
 29                             Tier = p.Value.Tier,
 30                             Endpoint = p.Value.Endpoint,
 31                             KeyConfigured = !string.IsNullOrEmpty(p.Value.Key),
 32                             Models = config.Value.CanonicalModels
 33                                 .Where(m => m.Provider == p.Key)
 34                                 .Select(m => new ProviderModelDto
 35                                 {
 36                                     Id = m.Id,
 37                                     Name = m.ModelPath,
 38                                     Enabled = true
 39                                 })
 40                                 .ToList(),
 41                             Status = "unknown",
 42                             Latency = null
 43                         }).ToList();
 44             
 45                         return Results.Ok(providers);
 46                     })
 47                     .WithTags("Admin")
 48                     .WithSummary("List all providers")
 49                     .WithDescription("Returns a list of all configured AI providers with their settings and status");
 50             
 51                     adminGroup.MapPut("/providers/{providerId}", (
 52                         string providerId,
 53                         ProviderUpdateRequest request,
 54                         IOptions<SynaxisConfiguration> config) =>
 55                     {
 56                         if (!config.Value.Providers.ContainsKey(providerId))
 57                         {
 58                             return Results.NotFound(new { error = $"Provider '{providerId}' not found" });
 59                         }
 60             
 61                         var provider = config.Value.Providers[providerId];
 62             
 63                         if (request.Enabled.HasValue)
 64                         {
 65                             provider.Enabled = request.Enabled.Value;
 66                         }
 67             
 68                         if (!string.IsNullOrEmpty(request.Key))
 69                         {
 70                             provider.Key = request.Key;
 71                         }
 72             
 73                         if (!string.IsNullOrEmpty(request.Endpoint))
 74                         {
 75                             provider.Endpoint = request.Endpoint;
 76                         }
 77             
 78                         if (request.Tier.HasValue)
 79                         {
 80                             provider.Tier = request.Tier.Value;
 81                         }
 82             
 83                         return Results.Ok(new { success = true, message = $"Provider '{providerId}' updated successfully" });
 84                     })
 85                     .WithTags("Admin")
 86                     .WithSummary("Update provider configuration")
 87                     .WithDescription("Update provider settings including enabled status, API key, endpoint, and tier");
 88             
 89                     adminGroup.MapGet("/health", (
 90                         IOptions<SynaxisConfiguration> config) =>
 91                     {
 92                         var services = new List<ServiceHealthDto>();
 93                         var providers = new List<ProviderHealthDto>();
 94             
 95                         services.Add(new ServiceHealthDto
 96                         {
 97                             Name = "API Gateway",
 98                             Status = "healthy",
 99                             LastChecked = DateTime.UtcNow.ToString("O")
100                         });
101             
102                         services.Add(new ServiceHealthDto
103                         {
104                             Name = "PostgreSQL",
105                             Status = "healthy",
106                             Latency = 15,
107                             LastChecked = DateTime.UtcNow.ToString("O")
108                         });
109             
110                         services.Add(new ServiceHealthDto
111                         {
112                             Name = "Redis",
113                             Status = "healthy",
114                             Latency = 5,
115                             LastChecked = DateTime.UtcNow.ToString("O")
116                         });
117             
118                         foreach (var p in config.Value.Providers.Where(p => p.Value.Enabled))
119                         {
120                             var hasKey = !string.IsNullOrEmpty(p.Value.Key);
121                             var providerHealth = new ProviderHealthDto
122                             {
123                                 Id = p.Key,
124                                 Name = p.Key,
125                                 Status = hasKey ? "online" : "unknown",
126                                 LastChecked = DateTime.UtcNow.ToString("O"),
127                                 SuccessRate = hasKey ? 98.5 : null,
128                                 Latency = hasKey ? new Random().Next(20, 150) : null
129                             };
130             
131                             if (!hasKey)
132                             {
133                                 providerHealth.ErrorMessage = "API key not configured";
134                             }
135             
136                             providers.Add(providerHealth);
137                         }
138             
139                         var overallStatus = DetermineOverallStatus(services, providers);
140             
141                         return Results.Ok(new HealthDataDto
142                         {
143                             Services = services,
144                             Providers = providers,
145                             OverallStatus = overallStatus,
146                             Timestamp = DateTime.UtcNow.ToString("O")
147                         });
148                     })
149                     .WithTags("Admin")
150                     .WithSummary("Get system health status")
151                     .WithDescription("Returns detailed health information about services and AI providers");
152             
153                     return app;
154                 }
155             
156                 private static string DetermineOverallStatus(List<ServiceHealthDto> services, List<ProviderHealthDto> providers)
157                 {
158                     var anyUnhealthy = services.Any(s => s.Status == "unhealthy") || providers.Any(p => p.Status == "offline");
159                     var anyDegraded = providers.Any(p => p.Status == "degraded" || p.Status == "unknown");
160             
161                     if (anyUnhealthy) return "unhealthy";
162                     if (anyDegraded) return "degraded";
163                     return "healthy";
164                 }
165             }
166             
167             public class ProviderAdminDto
168             {
169  ✔  432         public string Id { get; set; } = "";
170  ✔  432         public string Name { get; set; } = "";
171  ✔  432         public string Type { get; set; } = "";
172  ✔  288         public bool Enabled { get; set; }
173  ✔  288         public int Tier { get; set; }
174  ✔  288         public string? Endpoint { get; set; }
175  ✔  288         public bool KeyConfigured { get; set; }
176  ✔  432         public List<ProviderModelDto> Models { get; set; } = new();
177  ✔  432         public string Status { get; set; } = "unknown";
178  ✔  288         public int? Latency { get; set; }
179             }
180             
181             public class ProviderModelDto
182             {
183                 public string Id { get; set; } = "";
184                 public string Name { get; set; } = "";
185                 public bool Enabled { get; set; }
186             }
187             
188             public class ProviderUpdateRequest
189             {
190                 public bool? Enabled { get; set; }
191                 public string? Key { get; set; }
192                 public string? Endpoint { get; set; }
193                 public int? Tier { get; set; }
194             }
195             
196             public class ServiceHealthDto
197             {
198                 public string Name { get; set; } = "";
199                 public string Status { get; set; } = "";
200                 public int? Latency { get; set; }
201                 public string LastChecked { get; set; } = "";
202             }
203             
204             public class ProviderHealthDto
205             {
206                 public string Id { get; set; } = "";
207                 public string Name { get; set; } = "";
208                 public string Status { get; set; } = "";
209                 public int? Latency { get; set; }
210                 public double? SuccessRate { get; set; }
211                 public string LastChecked { get; set; } = "";
212                 public string? ErrorMessage { get; set; }
213             }
214             
215             public class HealthDataDto
216             {
217                 public List<ServiceHealthDto> Services { get; set; } = new();
218                 public List<ProviderHealthDto> Providers { get; set; } = new();
219                 public string OverallStatus { get; set; } = "";
220                 public string Timestamp { get; set; } = "";
221             }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderHealthDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderHealthDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs |
| **Line coverage:** | 100% (7 of 7) |
| Covered lines: | 7 |
| Uncovered lines: | 0 |
| Coverable lines: | 7 |
| Total lines: | 221 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_Latency()** | 100% | 1 | 1 | 100% |
| **get_SuccessRate()** | 100% | 1 | 1 | 100% |
| **get_LastChecked()** | 100% | 1 | 1 | 100% |
| **get_ErrorMessage()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs
```
  1             using Microsoft.AspNetCore.Builder;
  2             using Microsoft.AspNetCore.Http;
  3             using Microsoft.AspNetCore.Routing;
  4             using Microsoft.Extensions.Options;
  5             using Synaxis.InferenceGateway.Application.Configuration;
  6             using Synaxis.InferenceGateway.Application.ControlPlane;
  7             using System;
  8             using System.Collections.Generic;
  9             using System.Linq;
 10             using System.Security.Claims;
 11             
 12             namespace Synaxis.InferenceGateway.WebApi.Endpoints.Admin;
 13             
 14             public static class AdminEndpoints
 15             {
 16                 public static IEndpointRouteBuilder MapAdminEndpoints(this IEndpointRouteBuilder app)
 17                 {
 18                     var adminGroup = app.MapGroup("/admin")
 19                         .RequireAuthorization(policy => policy.RequireAuthenticatedUser());
 20             
 21                     adminGroup.MapGet("/providers", (IOptions<SynaxisConfiguration> config) =>
 22                     {
 23                         var providers = config.Value.Providers.Select(p => new ProviderAdminDto
 24                         {
 25                             Id = p.Key,
 26                             Name = p.Key,
 27                             Type = p.Value.Type,
 28                             Enabled = p.Value.Enabled,
 29                             Tier = p.Value.Tier,
 30                             Endpoint = p.Value.Endpoint,
 31                             KeyConfigured = !string.IsNullOrEmpty(p.Value.Key),
 32                             Models = config.Value.CanonicalModels
 33                                 .Where(m => m.Provider == p.Key)
 34                                 .Select(m => new ProviderModelDto
 35                                 {
 36                                     Id = m.Id,
 37                                     Name = m.ModelPath,
 38                                     Enabled = true
 39                                 })
 40                                 .ToList(),
 41                             Status = "unknown",
 42                             Latency = null
 43                         }).ToList();
 44             
 45                         return Results.Ok(providers);
 46                     })
 47                     .WithTags("Admin")
 48                     .WithSummary("List all providers")
 49                     .WithDescription("Returns a list of all configured AI providers with their settings and status");
 50             
 51                     adminGroup.MapPut("/providers/{providerId}", (
 52                         string providerId,
 53                         ProviderUpdateRequest request,
 54                         IOptions<SynaxisConfiguration> config) =>
 55                     {
 56                         if (!config.Value.Providers.ContainsKey(providerId))
 57                         {
 58                             return Results.NotFound(new { error = $"Provider '{providerId}' not found" });
 59                         }
 60             
 61                         var provider = config.Value.Providers[providerId];
 62             
 63                         if (request.Enabled.HasValue)
 64                         {
 65                             provider.Enabled = request.Enabled.Value;
 66                         }
 67             
 68                         if (!string.IsNullOrEmpty(request.Key))
 69                         {
 70                             provider.Key = request.Key;
 71                         }
 72             
 73                         if (!string.IsNullOrEmpty(request.Endpoint))
 74                         {
 75                             provider.Endpoint = request.Endpoint;
 76                         }
 77             
 78                         if (request.Tier.HasValue)
 79                         {
 80                             provider.Tier = request.Tier.Value;
 81                         }
 82             
 83                         return Results.Ok(new { success = true, message = $"Provider '{providerId}' updated successfully" });
 84                     })
 85                     .WithTags("Admin")
 86                     .WithSummary("Update provider configuration")
 87                     .WithDescription("Update provider settings including enabled status, API key, endpoint, and tier");
 88             
 89                     adminGroup.MapGet("/health", (
 90                         IOptions<SynaxisConfiguration> config) =>
 91                     {
 92                         var services = new List<ServiceHealthDto>();
 93                         var providers = new List<ProviderHealthDto>();
 94             
 95                         services.Add(new ServiceHealthDto
 96                         {
 97                             Name = "API Gateway",
 98                             Status = "healthy",
 99                             LastChecked = DateTime.UtcNow.ToString("O")
100                         });
101             
102                         services.Add(new ServiceHealthDto
103                         {
104                             Name = "PostgreSQL",
105                             Status = "healthy",
106                             Latency = 15,
107                             LastChecked = DateTime.UtcNow.ToString("O")
108                         });
109             
110                         services.Add(new ServiceHealthDto
111                         {
112                             Name = "Redis",
113                             Status = "healthy",
114                             Latency = 5,
115                             LastChecked = DateTime.UtcNow.ToString("O")
116                         });
117             
118                         foreach (var p in config.Value.Providers.Where(p => p.Value.Enabled))
119                         {
120                             var hasKey = !string.IsNullOrEmpty(p.Value.Key);
121                             var providerHealth = new ProviderHealthDto
122                             {
123                                 Id = p.Key,
124                                 Name = p.Key,
125                                 Status = hasKey ? "online" : "unknown",
126                                 LastChecked = DateTime.UtcNow.ToString("O"),
127                                 SuccessRate = hasKey ? 98.5 : null,
128                                 Latency = hasKey ? new Random().Next(20, 150) : null
129                             };
130             
131                             if (!hasKey)
132                             {
133                                 providerHealth.ErrorMessage = "API key not configured";
134                             }
135             
136                             providers.Add(providerHealth);
137                         }
138             
139                         var overallStatus = DetermineOverallStatus(services, providers);
140             
141                         return Results.Ok(new HealthDataDto
142                         {
143                             Services = services,
144                             Providers = providers,
145                             OverallStatus = overallStatus,
146                             Timestamp = DateTime.UtcNow.ToString("O")
147                         });
148                     })
149                     .WithTags("Admin")
150                     .WithSummary("Get system health status")
151                     .WithDescription("Returns detailed health information about services and AI providers");
152             
153                     return app;
154                 }
155             
156                 private static string DetermineOverallStatus(List<ServiceHealthDto> services, List<ProviderHealthDto> providers)
157                 {
158                     var anyUnhealthy = services.Any(s => s.Status == "unhealthy") || providers.Any(p => p.Status == "offline");
159                     var anyDegraded = providers.Any(p => p.Status == "degraded" || p.Status == "unknown");
160             
161                     if (anyUnhealthy) return "unhealthy";
162                     if (anyDegraded) return "degraded";
163                     return "healthy";
164                 }
165             }
166             
167             public class ProviderAdminDto
168             {
169                 public string Id { get; set; } = "";
170                 public string Name { get; set; } = "";
171                 public string Type { get; set; } = "";
172                 public bool Enabled { get; set; }
173                 public int Tier { get; set; }
174                 public string? Endpoint { get; set; }
175                 public bool KeyConfigured { get; set; }
176                 public List<ProviderModelDto> Models { get; set; } = new();
177                 public string Status { get; set; } = "unknown";
178                 public int? Latency { get; set; }
179             }
180             
181             public class ProviderModelDto
182             {
183                 public string Id { get; set; } = "";
184                 public string Name { get; set; } = "";
185                 public bool Enabled { get; set; }
186             }
187             
188             public class ProviderUpdateRequest
189             {
190                 public bool? Enabled { get; set; }
191                 public string? Key { get; set; }
192                 public string? Endpoint { get; set; }
193                 public int? Tier { get; set; }
194             }
195             
196             public class ServiceHealthDto
197             {
198                 public string Name { get; set; } = "";
199                 public string Status { get; set; } = "";
200                 public int? Latency { get; set; }
201                 public string LastChecked { get; set; } = "";
202             }
203             
204             public class ProviderHealthDto
205             {
206  ✔  270         public string Id { get; set; } = "";
207  ✔  270         public string Name { get; set; } = "";
208  ✔  410         public string Status { get; set; } = "";
209  ✔  180         public int? Latency { get; set; }
210  ✔  180         public double? SuccessRate { get; set; }
211  ✔  270         public string LastChecked { get; set; } = "";
212  ✔  105         public string? ErrorMessage { get; set; }
213             }
214             
215             public class HealthDataDto
216             {
217                 public List<ServiceHealthDto> Services { get; set; } = new();
218                 public List<ProviderHealthDto> Providers { get; set; } = new();
219                 public string OverallStatus { get; set; } = "";
220                 public string Timestamp { get; set; } = "";
221             }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderModelDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderModelDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 221 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Enabled()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs
```
  1             using Microsoft.AspNetCore.Builder;
  2             using Microsoft.AspNetCore.Http;
  3             using Microsoft.AspNetCore.Routing;
  4             using Microsoft.Extensions.Options;
  5             using Synaxis.InferenceGateway.Application.Configuration;
  6             using Synaxis.InferenceGateway.Application.ControlPlane;
  7             using System;
  8             using System.Collections.Generic;
  9             using System.Linq;
 10             using System.Security.Claims;
 11             
 12             namespace Synaxis.InferenceGateway.WebApi.Endpoints.Admin;
 13             
 14             public static class AdminEndpoints
 15             {
 16                 public static IEndpointRouteBuilder MapAdminEndpoints(this IEndpointRouteBuilder app)
 17                 {
 18                     var adminGroup = app.MapGroup("/admin")
 19                         .RequireAuthorization(policy => policy.RequireAuthenticatedUser());
 20             
 21                     adminGroup.MapGet("/providers", (IOptions<SynaxisConfiguration> config) =>
 22                     {
 23                         var providers = config.Value.Providers.Select(p => new ProviderAdminDto
 24                         {
 25                             Id = p.Key,
 26                             Name = p.Key,
 27                             Type = p.Value.Type,
 28                             Enabled = p.Value.Enabled,
 29                             Tier = p.Value.Tier,
 30                             Endpoint = p.Value.Endpoint,
 31                             KeyConfigured = !string.IsNullOrEmpty(p.Value.Key),
 32                             Models = config.Value.CanonicalModels
 33                                 .Where(m => m.Provider == p.Key)
 34                                 .Select(m => new ProviderModelDto
 35                                 {
 36                                     Id = m.Id,
 37                                     Name = m.ModelPath,
 38                                     Enabled = true
 39                                 })
 40                                 .ToList(),
 41                             Status = "unknown",
 42                             Latency = null
 43                         }).ToList();
 44             
 45                         return Results.Ok(providers);
 46                     })
 47                     .WithTags("Admin")
 48                     .WithSummary("List all providers")
 49                     .WithDescription("Returns a list of all configured AI providers with their settings and status");
 50             
 51                     adminGroup.MapPut("/providers/{providerId}", (
 52                         string providerId,
 53                         ProviderUpdateRequest request,
 54                         IOptions<SynaxisConfiguration> config) =>
 55                     {
 56                         if (!config.Value.Providers.ContainsKey(providerId))
 57                         {
 58                             return Results.NotFound(new { error = $"Provider '{providerId}' not found" });
 59                         }
 60             
 61                         var provider = config.Value.Providers[providerId];
 62             
 63                         if (request.Enabled.HasValue)
 64                         {
 65                             provider.Enabled = request.Enabled.Value;
 66                         }
 67             
 68                         if (!string.IsNullOrEmpty(request.Key))
 69                         {
 70                             provider.Key = request.Key;
 71                         }
 72             
 73                         if (!string.IsNullOrEmpty(request.Endpoint))
 74                         {
 75                             provider.Endpoint = request.Endpoint;
 76                         }
 77             
 78                         if (request.Tier.HasValue)
 79                         {
 80                             provider.Tier = request.Tier.Value;
 81                         }
 82             
 83                         return Results.Ok(new { success = true, message = $"Provider '{providerId}' updated successfully" });
 84                     })
 85                     .WithTags("Admin")
 86                     .WithSummary("Update provider configuration")
 87                     .WithDescription("Update provider settings including enabled status, API key, endpoint, and tier");
 88             
 89                     adminGroup.MapGet("/health", (
 90                         IOptions<SynaxisConfiguration> config) =>
 91                     {
 92                         var services = new List<ServiceHealthDto>();
 93                         var providers = new List<ProviderHealthDto>();
 94             
 95                         services.Add(new ServiceHealthDto
 96                         {
 97                             Name = "API Gateway",
 98                             Status = "healthy",
 99                             LastChecked = DateTime.UtcNow.ToString("O")
100                         });
101             
102                         services.Add(new ServiceHealthDto
103                         {
104                             Name = "PostgreSQL",
105                             Status = "healthy",
106                             Latency = 15,
107                             LastChecked = DateTime.UtcNow.ToString("O")
108                         });
109             
110                         services.Add(new ServiceHealthDto
111                         {
112                             Name = "Redis",
113                             Status = "healthy",
114                             Latency = 5,
115                             LastChecked = DateTime.UtcNow.ToString("O")
116                         });
117             
118                         foreach (var p in config.Value.Providers.Where(p => p.Value.Enabled))
119                         {
120                             var hasKey = !string.IsNullOrEmpty(p.Value.Key);
121                             var providerHealth = new ProviderHealthDto
122                             {
123                                 Id = p.Key,
124                                 Name = p.Key,
125                                 Status = hasKey ? "online" : "unknown",
126                                 LastChecked = DateTime.UtcNow.ToString("O"),
127                                 SuccessRate = hasKey ? 98.5 : null,
128                                 Latency = hasKey ? new Random().Next(20, 150) : null
129                             };
130             
131                             if (!hasKey)
132                             {
133                                 providerHealth.ErrorMessage = "API key not configured";
134                             }
135             
136                             providers.Add(providerHealth);
137                         }
138             
139                         var overallStatus = DetermineOverallStatus(services, providers);
140             
141                         return Results.Ok(new HealthDataDto
142                         {
143                             Services = services,
144                             Providers = providers,
145                             OverallStatus = overallStatus,
146                             Timestamp = DateTime.UtcNow.ToString("O")
147                         });
148                     })
149                     .WithTags("Admin")
150                     .WithSummary("Get system health status")
151                     .WithDescription("Returns detailed health information about services and AI providers");
152             
153                     return app;
154                 }
155             
156                 private static string DetermineOverallStatus(List<ServiceHealthDto> services, List<ProviderHealthDto> providers)
157                 {
158                     var anyUnhealthy = services.Any(s => s.Status == "unhealthy") || providers.Any(p => p.Status == "offline");
159                     var anyDegraded = providers.Any(p => p.Status == "degraded" || p.Status == "unknown");
160             
161                     if (anyUnhealthy) return "unhealthy";
162                     if (anyDegraded) return "degraded";
163                     return "healthy";
164                 }
165             }
166             
167             public class ProviderAdminDto
168             {
169                 public string Id { get; set; } = "";
170                 public string Name { get; set; } = "";
171                 public string Type { get; set; } = "";
172                 public bool Enabled { get; set; }
173                 public int Tier { get; set; }
174                 public string? Endpoint { get; set; }
175                 public bool KeyConfigured { get; set; }
176                 public List<ProviderModelDto> Models { get; set; } = new();
177                 public string Status { get; set; } = "unknown";
178                 public int? Latency { get; set; }
179             }
180             
181             public class ProviderModelDto
182             {
183  ✔  960         public string Id { get; set; } = "";
184  ✔  960         public string Name { get; set; } = "";
185  ✔  640         public bool Enabled { get; set; }
186             }
187             
188             public class ProviderUpdateRequest
189             {
190                 public bool? Enabled { get; set; }
191                 public string? Key { get; set; }
192                 public string? Endpoint { get; set; }
193                 public int? Tier { get; set; }
194             }
195             
196             public class ServiceHealthDto
197             {
198                 public string Name { get; set; } = "";
199                 public string Status { get; set; } = "";
200                 public int? Latency { get; set; }
201                 public string LastChecked { get; set; } = "";
202             }
203             
204             public class ProviderHealthDto
205             {
206                 public string Id { get; set; } = "";
207                 public string Name { get; set; } = "";
208                 public string Status { get; set; } = "";
209                 public int? Latency { get; set; }
210                 public double? SuccessRate { get; set; }
211                 public string LastChecked { get; set; } = "";
212                 public string? ErrorMessage { get; set; }
213             }
214             
215             public class HealthDataDto
216             {
217                 public List<ServiceHealthDto> Services { get; set; } = new();
218                 public List<ProviderHealthDto> Providers { get; set; } = new();
219                 public string OverallStatus { get; set; } = "";
220                 public string Timestamp { get; set; } = "";
221             }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderUpdateRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ProviderUpdateRequest |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 221 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Enabled()** | 100% | 1 | 1 | 100% |
| **get_Key()** | 100% | 1 | 1 | 100% |
| **get_Endpoint()** | 100% | 1 | 1 | 100% |
| **get_Tier()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs
```
  1           using Microsoft.AspNetCore.Builder;
  2           using Microsoft.AspNetCore.Http;
  3           using Microsoft.AspNetCore.Routing;
  4           using Microsoft.Extensions.Options;
  5           using Synaxis.InferenceGateway.Application.Configuration;
  6           using Synaxis.InferenceGateway.Application.ControlPlane;
  7           using System;
  8           using System.Collections.Generic;
  9           using System.Linq;
 10           using System.Security.Claims;
 11           
 12           namespace Synaxis.InferenceGateway.WebApi.Endpoints.Admin;
 13           
 14           public static class AdminEndpoints
 15           {
 16               public static IEndpointRouteBuilder MapAdminEndpoints(this IEndpointRouteBuilder app)
 17               {
 18                   var adminGroup = app.MapGroup("/admin")
 19                       .RequireAuthorization(policy => policy.RequireAuthenticatedUser());
 20           
 21                   adminGroup.MapGet("/providers", (IOptions<SynaxisConfiguration> config) =>
 22                   {
 23                       var providers = config.Value.Providers.Select(p => new ProviderAdminDto
 24                       {
 25                           Id = p.Key,
 26                           Name = p.Key,
 27                           Type = p.Value.Type,
 28                           Enabled = p.Value.Enabled,
 29                           Tier = p.Value.Tier,
 30                           Endpoint = p.Value.Endpoint,
 31                           KeyConfigured = !string.IsNullOrEmpty(p.Value.Key),
 32                           Models = config.Value.CanonicalModels
 33                               .Where(m => m.Provider == p.Key)
 34                               .Select(m => new ProviderModelDto
 35                               {
 36                                   Id = m.Id,
 37                                   Name = m.ModelPath,
 38                                   Enabled = true
 39                               })
 40                               .ToList(),
 41                           Status = "unknown",
 42                           Latency = null
 43                       }).ToList();
 44           
 45                       return Results.Ok(providers);
 46                   })
 47                   .WithTags("Admin")
 48                   .WithSummary("List all providers")
 49                   .WithDescription("Returns a list of all configured AI providers with their settings and status");
 50           
 51                   adminGroup.MapPut("/providers/{providerId}", (
 52                       string providerId,
 53                       ProviderUpdateRequest request,
 54                       IOptions<SynaxisConfiguration> config) =>
 55                   {
 56                       if (!config.Value.Providers.ContainsKey(providerId))
 57                       {
 58                           return Results.NotFound(new { error = $"Provider '{providerId}' not found" });
 59                       }
 60           
 61                       var provider = config.Value.Providers[providerId];
 62           
 63                       if (request.Enabled.HasValue)
 64                       {
 65                           provider.Enabled = request.Enabled.Value;
 66                       }
 67           
 68                       if (!string.IsNullOrEmpty(request.Key))
 69                       {
 70                           provider.Key = request.Key;
 71                       }
 72           
 73                       if (!string.IsNullOrEmpty(request.Endpoint))
 74                       {
 75                           provider.Endpoint = request.Endpoint;
 76                       }
 77           
 78                       if (request.Tier.HasValue)
 79                       {
 80                           provider.Tier = request.Tier.Value;
 81                       }
 82           
 83                       return Results.Ok(new { success = true, message = $"Provider '{providerId}' updated successfully" });
 84                   })
 85                   .WithTags("Admin")
 86                   .WithSummary("Update provider configuration")
 87                   .WithDescription("Update provider settings including enabled status, API key, endpoint, and tier");
 88           
 89                   adminGroup.MapGet("/health", (
 90                       IOptions<SynaxisConfiguration> config) =>
 91                   {
 92                       var services = new List<ServiceHealthDto>();
 93                       var providers = new List<ProviderHealthDto>();
 94           
 95                       services.Add(new ServiceHealthDto
 96                       {
 97                           Name = "API Gateway",
 98                           Status = "healthy",
 99                           LastChecked = DateTime.UtcNow.ToString("O")
100                       });
101           
102                       services.Add(new ServiceHealthDto
103                       {
104                           Name = "PostgreSQL",
105                           Status = "healthy",
106                           Latency = 15,
107                           LastChecked = DateTime.UtcNow.ToString("O")
108                       });
109           
110                       services.Add(new ServiceHealthDto
111                       {
112                           Name = "Redis",
113                           Status = "healthy",
114                           Latency = 5,
115                           LastChecked = DateTime.UtcNow.ToString("O")
116                       });
117           
118                       foreach (var p in config.Value.Providers.Where(p => p.Value.Enabled))
119                       {
120                           var hasKey = !string.IsNullOrEmpty(p.Value.Key);
121                           var providerHealth = new ProviderHealthDto
122                           {
123                               Id = p.Key,
124                               Name = p.Key,
125                               Status = hasKey ? "online" : "unknown",
126                               LastChecked = DateTime.UtcNow.ToString("O"),
127                               SuccessRate = hasKey ? 98.5 : null,
128                               Latency = hasKey ? new Random().Next(20, 150) : null
129                           };
130           
131                           if (!hasKey)
132                           {
133                               providerHealth.ErrorMessage = "API key not configured";
134                           }
135           
136                           providers.Add(providerHealth);
137                       }
138           
139                       var overallStatus = DetermineOverallStatus(services, providers);
140           
141                       return Results.Ok(new HealthDataDto
142                       {
143                           Services = services,
144                           Providers = providers,
145                           OverallStatus = overallStatus,
146                           Timestamp = DateTime.UtcNow.ToString("O")
147                       });
148                   })
149                   .WithTags("Admin")
150                   .WithSummary("Get system health status")
151                   .WithDescription("Returns detailed health information about services and AI providers");
152           
153                   return app;
154               }
155           
156               private static string DetermineOverallStatus(List<ServiceHealthDto> services, List<ProviderHealthDto> providers)
157               {
158                   var anyUnhealthy = services.Any(s => s.Status == "unhealthy") || providers.Any(p => p.Status == "offline");
159                   var anyDegraded = providers.Any(p => p.Status == "degraded" || p.Status == "unknown");
160           
161                   if (anyUnhealthy) return "unhealthy";
162                   if (anyDegraded) return "degraded";
163                   return "healthy";
164               }
165           }
166           
167           public class ProviderAdminDto
168           {
169               public string Id { get; set; } = "";
170               public string Name { get; set; } = "";
171               public string Type { get; set; } = "";
172               public bool Enabled { get; set; }
173               public int Tier { get; set; }
174               public string? Endpoint { get; set; }
175               public bool KeyConfigured { get; set; }
176               public List<ProviderModelDto> Models { get; set; } = new();
177               public string Status { get; set; } = "unknown";
178               public int? Latency { get; set; }
179           }
180           
181           public class ProviderModelDto
182           {
183               public string Id { get; set; } = "";
184               public string Name { get; set; } = "";
185               public bool Enabled { get; set; }
186           }
187           
188           public class ProviderUpdateRequest
189           {
190  ✔  7         public bool? Enabled { get; set; }
191  ✔  6         public string? Key { get; set; }
192  ✔  6         public string? Endpoint { get; set; }
193  ✔  6         public int? Tier { get; set; }
194           }
195           
196           public class ServiceHealthDto
197           {
198               public string Name { get; set; } = "";
199               public string Status { get; set; } = "";
200               public int? Latency { get; set; }
201               public string LastChecked { get; set; } = "";
202           }
203           
204           public class ProviderHealthDto
205           {
206               public string Id { get; set; } = "";
207               public string Name { get; set; } = "";
208               public string Status { get; set; } = "";
209               public int? Latency { get; set; }
210               public double? SuccessRate { get; set; }
211               public string LastChecked { get; set; } = "";
212               public string? ErrorMessage { get; set; }
213           }
214           
215           public class HealthDataDto
216           {
217               public List<ServiceHealthDto> Services { get; set; } = new();
218               public List<ProviderHealthDto> Providers { get; set; } = new();
219               public string OverallStatus { get; set; } = "";
220               public string Timestamp { get; set; } = "";
221           }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ServiceHealthDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Admin.ServiceHealthDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 221 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Status()** | 100% | 1 | 1 | 100% |
| **get_Latency()** | 100% | 1 | 1 | 100% |
| **get_LastChecked()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Admin/AdminEndpoints.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Http;
  3            using Microsoft.AspNetCore.Routing;
  4            using Microsoft.Extensions.Options;
  5            using Synaxis.InferenceGateway.Application.Configuration;
  6            using Synaxis.InferenceGateway.Application.ControlPlane;
  7            using System;
  8            using System.Collections.Generic;
  9            using System.Linq;
 10            using System.Security.Claims;
 11            
 12            namespace Synaxis.InferenceGateway.WebApi.Endpoints.Admin;
 13            
 14            public static class AdminEndpoints
 15            {
 16                public static IEndpointRouteBuilder MapAdminEndpoints(this IEndpointRouteBuilder app)
 17                {
 18                    var adminGroup = app.MapGroup("/admin")
 19                        .RequireAuthorization(policy => policy.RequireAuthenticatedUser());
 20            
 21                    adminGroup.MapGet("/providers", (IOptions<SynaxisConfiguration> config) =>
 22                    {
 23                        var providers = config.Value.Providers.Select(p => new ProviderAdminDto
 24                        {
 25                            Id = p.Key,
 26                            Name = p.Key,
 27                            Type = p.Value.Type,
 28                            Enabled = p.Value.Enabled,
 29                            Tier = p.Value.Tier,
 30                            Endpoint = p.Value.Endpoint,
 31                            KeyConfigured = !string.IsNullOrEmpty(p.Value.Key),
 32                            Models = config.Value.CanonicalModels
 33                                .Where(m => m.Provider == p.Key)
 34                                .Select(m => new ProviderModelDto
 35                                {
 36                                    Id = m.Id,
 37                                    Name = m.ModelPath,
 38                                    Enabled = true
 39                                })
 40                                .ToList(),
 41                            Status = "unknown",
 42                            Latency = null
 43                        }).ToList();
 44            
 45                        return Results.Ok(providers);
 46                    })
 47                    .WithTags("Admin")
 48                    .WithSummary("List all providers")
 49                    .WithDescription("Returns a list of all configured AI providers with their settings and status");
 50            
 51                    adminGroup.MapPut("/providers/{providerId}", (
 52                        string providerId,
 53                        ProviderUpdateRequest request,
 54                        IOptions<SynaxisConfiguration> config) =>
 55                    {
 56                        if (!config.Value.Providers.ContainsKey(providerId))
 57                        {
 58                            return Results.NotFound(new { error = $"Provider '{providerId}' not found" });
 59                        }
 60            
 61                        var provider = config.Value.Providers[providerId];
 62            
 63                        if (request.Enabled.HasValue)
 64                        {
 65                            provider.Enabled = request.Enabled.Value;
 66                        }
 67            
 68                        if (!string.IsNullOrEmpty(request.Key))
 69                        {
 70                            provider.Key = request.Key;
 71                        }
 72            
 73                        if (!string.IsNullOrEmpty(request.Endpoint))
 74                        {
 75                            provider.Endpoint = request.Endpoint;
 76                        }
 77            
 78                        if (request.Tier.HasValue)
 79                        {
 80                            provider.Tier = request.Tier.Value;
 81                        }
 82            
 83                        return Results.Ok(new { success = true, message = $"Provider '{providerId}' updated successfully" });
 84                    })
 85                    .WithTags("Admin")
 86                    .WithSummary("Update provider configuration")
 87                    .WithDescription("Update provider settings including enabled status, API key, endpoint, and tier");
 88            
 89                    adminGroup.MapGet("/health", (
 90                        IOptions<SynaxisConfiguration> config) =>
 91                    {
 92                        var services = new List<ServiceHealthDto>();
 93                        var providers = new List<ProviderHealthDto>();
 94            
 95                        services.Add(new ServiceHealthDto
 96                        {
 97                            Name = "API Gateway",
 98                            Status = "healthy",
 99                            LastChecked = DateTime.UtcNow.ToString("O")
100                        });
101            
102                        services.Add(new ServiceHealthDto
103                        {
104                            Name = "PostgreSQL",
105                            Status = "healthy",
106                            Latency = 15,
107                            LastChecked = DateTime.UtcNow.ToString("O")
108                        });
109            
110                        services.Add(new ServiceHealthDto
111                        {
112                            Name = "Redis",
113                            Status = "healthy",
114                            Latency = 5,
115                            LastChecked = DateTime.UtcNow.ToString("O")
116                        });
117            
118                        foreach (var p in config.Value.Providers.Where(p => p.Value.Enabled))
119                        {
120                            var hasKey = !string.IsNullOrEmpty(p.Value.Key);
121                            var providerHealth = new ProviderHealthDto
122                            {
123                                Id = p.Key,
124                                Name = p.Key,
125                                Status = hasKey ? "online" : "unknown",
126                                LastChecked = DateTime.UtcNow.ToString("O"),
127                                SuccessRate = hasKey ? 98.5 : null,
128                                Latency = hasKey ? new Random().Next(20, 150) : null
129                            };
130            
131                            if (!hasKey)
132                            {
133                                providerHealth.ErrorMessage = "API key not configured";
134                            }
135            
136                            providers.Add(providerHealth);
137                        }
138            
139                        var overallStatus = DetermineOverallStatus(services, providers);
140            
141                        return Results.Ok(new HealthDataDto
142                        {
143                            Services = services,
144                            Providers = providers,
145                            OverallStatus = overallStatus,
146                            Timestamp = DateTime.UtcNow.ToString("O")
147                        });
148                    })
149                    .WithTags("Admin")
150                    .WithSummary("Get system health status")
151                    .WithDescription("Returns detailed health information about services and AI providers");
152            
153                    return app;
154                }
155            
156                private static string DetermineOverallStatus(List<ServiceHealthDto> services, List<ProviderHealthDto> providers)
157                {
158                    var anyUnhealthy = services.Any(s => s.Status == "unhealthy") || providers.Any(p => p.Status == "offline");
159                    var anyDegraded = providers.Any(p => p.Status == "degraded" || p.Status == "unknown");
160            
161                    if (anyUnhealthy) return "unhealthy";
162                    if (anyDegraded) return "degraded";
163                    return "healthy";
164                }
165            }
166            
167            public class ProviderAdminDto
168            {
169                public string Id { get; set; } = "";
170                public string Name { get; set; } = "";
171                public string Type { get; set; } = "";
172                public bool Enabled { get; set; }
173                public int Tier { get; set; }
174                public string? Endpoint { get; set; }
175                public bool KeyConfigured { get; set; }
176                public List<ProviderModelDto> Models { get; set; } = new();
177                public string Status { get; set; } = "unknown";
178                public int? Latency { get; set; }
179            }
180            
181            public class ProviderModelDto
182            {
183                public string Id { get; set; } = "";
184                public string Name { get; set; } = "";
185                public bool Enabled { get; set; }
186            }
187            
188            public class ProviderUpdateRequest
189            {
190                public bool? Enabled { get; set; }
191                public string? Key { get; set; }
192                public string? Endpoint { get; set; }
193                public int? Tier { get; set; }
194            }
195            
196            public class ServiceHealthDto
197            {
198  ✔  45         public string Name { get; set; } = "";
199  ✔  60         public string Status { get; set; } = "";
200  ✔  25         public int? Latency { get; set; }
201  ✔  45         public string LastChecked { get; set; } = "";
202            }
203            
204            public class ProviderHealthDto
205            {
206                public string Id { get; set; } = "";
207                public string Name { get; set; } = "";
208                public string Status { get; set; } = "";
209                public int? Latency { get; set; }
210                public double? SuccessRate { get; set; }
211                public string LastChecked { get; set; } = "";
212                public string? ErrorMessage { get; set; }
213            }
214            
215            public class HealthDataDto
216            {
217                public List<ServiceHealthDto> Services { get; set; } = new();
218                public List<ProviderHealthDto> Providers { get; set; } = new();
219                public string OverallStatus { get; set; } = "";
220                public string Timestamp { get; set; } = "";
221            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.AntigravityEndpoints

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.AntigravityEndpoints |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Antigravity/AntigravityEndpoints.cs |
| **Line coverage:** | 61.9% (52 of 84) |
| Covered lines: | 52 |
| Uncovered lines: | 32 |
| Coverable lines: | 84 |
| Total lines: | 124 |
| **Branch coverage:** | 31.2% (5 of 16) |
| Covered branches: | 5 |
| Total branches: | 16 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **MapAntigravityEndpoints(...)** | 50.0% | 2 | 2 | 69.84% |
| **ResolveAuthCompletion(...)** | 28.57% | 48 | 14 | 44.44% |
| **RenderCallbackHtml(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Antigravity/AntigravityEndpoints.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Http;
  3            using Microsoft.AspNetCore.Mvc;
  4            using Microsoft.AspNetCore.Routing;
  5            using Synaxis.InferenceGateway.Infrastructure.Auth;
  6            using System;
  7            using System.Threading.Tasks;
  8            
  9            namespace Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity;
 10            
 11            public static class AntigravityEndpoints
 12            {
 13                private const string DefaultRedirectUrl = "http://localhost:51121/oauth/antigravity/callback";
 14            
 15                public static void MapAntigravityEndpoints(this IEndpointRouteBuilder app)
 16  ✔  37         {
 17  ✔  37             app.MapGet("/oauth/antigravity/callback", async (IAntigravityAuthManager authManager, HttpRequest request) =>
 18  ❌  0             {
 19  ❌  0                 var code = request.Query["code"].ToString();
 20  ❌  0                 var state = request.Query["state"].ToString();
 21  ❌  0                 var redirectUrl = $"{request.Scheme}://{request.Host}{request.Path}";
 22  ✔  37     
 23  ❌  0                 if (string.IsNullOrWhiteSpace(code) || string.IsNullOrWhiteSpace(state))
 24  ❌  0                 {
 25  ❌  0                     return Results.Content(RenderCallbackHtml("Missing code or state in callback URL."), "text/html", System
 26  ✔  37                 }
 27  ✔  37     
 28  ✔  37                 try
 29  ❌  0                 {
 30  ❌  0                     await authManager.CompleteAuthFlowAsync(code, redirectUrl, state);
 31  ❌  0                     return Results.Content(RenderCallbackHtml("Authentication successful. You can close this window."), "tex
 32  ✔  37                 }
 33  ❌  0                 catch (Exception ex)
 34  ❌  0                 {
 35  ❌  0                     return Results.Content(RenderCallbackHtml($"Authentication failed: {ex.Message}"), "text/html", System.T
 36  ✔  37                 }
 37  ❌  0             })
 38  ✔  37             .WithTags("Antigravity")
 39  ✔  37             .WithName("AntigravityAuthCallback");
 40            
 41  ✔  37             var group = app.MapGroup("/antigravity")
 42  ✔  37                 .WithTags("Antigravity");
 43            
 44  ✔  37             group.MapGet("/accounts", (IAntigravityAuthManager authManager) =>
 45  ✔   1             {
 46  ✔   1                 return Results.Ok(authManager.ListAccounts());
 47  ✔   1             })
 48  ✔  37             .WithName("ListAntigravityAccounts");
 49            
 50  ✔  37             group.MapPost("/auth/start", (IAntigravityAuthManager authManager, [FromBody] StartAuthRequest request) =>
 51  ✔   1             {
 52  ✓   1  ◑              var redirectUrl = string.IsNullOrWhiteSpace(request.RedirectUrl) ? DefaultRedirectUrl : request.RedirectUrl;
 53  ✔   1                 var url = authManager.StartAuthFlow(redirectUrl);
 54  ✔   1                 return Results.Ok(new
 55  ✔   1                 {
 56  ✔   1                     AuthUrl = url,
 57  ✔   1                     RedirectUrl = redirectUrl,
 58  ✔   1                     Instructions = "Open AuthUrl in your browser. After login, you will be redirected to the callback; no ma
 59  ✔   1                 });
 60  ✔   1             })
 61  ✔  37             .WithName("StartAntigravityAuth");
 62            
 63  ✔  37             group.MapPost("/auth/complete", async (IAntigravityAuthManager authManager, [FromBody] CompleteAuthRequest reque
 64  ✔   1             {
 65  ✔  37                 try
 66  ✔   1                 {
 67  ✔   1                     var (code, state, redirectUrl) = ResolveAuthCompletion(request);
 68  ✔   1                     if (string.IsNullOrWhiteSpace(code) || string.IsNullOrWhiteSpace(state))
 69  ❌  0                     {
 70  ❌  0                         return Results.BadRequest(new { Error = "Both code and state are required. Provide them directly or 
 71  ✔  37                     }
 72  ✔  37     
 73  ✔   1                     await authManager.CompleteAuthFlowAsync(code, redirectUrl, state);
 74  ✔   1                     return Results.Ok(new { Message = "Authentication successful. Account added." });
 75  ✔  37                 }
 76  ❌  0                 catch (System.Exception ex)
 77  ❌  0                 {
 78  ❌  0                     return Results.BadRequest(new { Error = ex.Message });
 79  ✔  37                 }
 80  ✔   1             })
 81  ✔  37             .WithName("CompleteAntigravityAuth");
 82  ✔  37         }
 83            
 84                private static (string Code, string State, string RedirectUrl) ResolveAuthCompletion(CompleteAuthRequest request)
 85  ✔   1         {
 86  ✔   1             var code = request.Code;
 87  ✔   1             var state = request.State;
 88  ✔   1             var redirectUrl = request.RedirectUrl;
 89            
 90  ✓   1  ◑          if (!string.IsNullOrWhiteSpace(request.CallbackUrl))
 91  ❌  0             {
 92  ❌  0                 var callbackUri = new Uri(request.CallbackUrl);
 93  ❌  0                 var query = System.Web.HttpUtility.ParseQueryString(callbackUri.Query);
 94  ❌  0  ○              code ??= query["code"];
 95  ❌  0  ○              state ??= query["state"];
 96  ❌  0  ○              redirectUrl ??= callbackUri.GetLeftPart(UriPartial.Path);
 97  ❌  0             }
 98            
 99  ✓   1  ◑          if (string.IsNullOrWhiteSpace(redirectUrl))
100  ❌  0             {
101  ❌  0                 redirectUrl = DefaultRedirectUrl;
102  ❌  0             }
103            
104  ✓   1  ◑          return (code ?? string.Empty, state ?? string.Empty, redirectUrl);
105  ✔   1         }
106            
107                private static string RenderCallbackHtml(string message)
108  ❌  0         {
109  ❌  0             return $"<!doctype html><html><head><meta charset=\"utf-8\"><title>Antigravity Auth</title></head><body style=\"
110  ❌  0         }
111            }
112            
113            public class StartAuthRequest
114            {
115                public string? RedirectUrl { get; set; }
116            }
117            
118            public class CompleteAuthRequest
119            {
120                public string? Code { get; set; }
121                public string? State { get; set; }
122                public string? RedirectUrl { get; set; }
123                public string? CallbackUrl { get; set; }
124            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.CompleteAuthRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.CompleteAuthRequest |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Antigravity/AntigravityEndpoints.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 124 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Code()** | 100% | 1 | 1 | 100% |
| **get_State()** | 100% | 1 | 1 | 100% |
| **get_RedirectUrl()** | 100% | 1 | 1 | 100% |
| **get_CallbackUrl()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Antigravity/AntigravityEndpoints.cs
```
  1           using Microsoft.AspNetCore.Builder;
  2           using Microsoft.AspNetCore.Http;
  3           using Microsoft.AspNetCore.Mvc;
  4           using Microsoft.AspNetCore.Routing;
  5           using Synaxis.InferenceGateway.Infrastructure.Auth;
  6           using System;
  7           using System.Threading.Tasks;
  8           
  9           namespace Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity;
 10           
 11           public static class AntigravityEndpoints
 12           {
 13               private const string DefaultRedirectUrl = "http://localhost:51121/oauth/antigravity/callback";
 14           
 15               public static void MapAntigravityEndpoints(this IEndpointRouteBuilder app)
 16               {
 17                   app.MapGet("/oauth/antigravity/callback", async (IAntigravityAuthManager authManager, HttpRequest request) =>
 18                   {
 19                       var code = request.Query["code"].ToString();
 20                       var state = request.Query["state"].ToString();
 21                       var redirectUrl = $"{request.Scheme}://{request.Host}{request.Path}";
 22           
 23                       if (string.IsNullOrWhiteSpace(code) || string.IsNullOrWhiteSpace(state))
 24                       {
 25                           return Results.Content(RenderCallbackHtml("Missing code or state in callback URL."), "text/html", System
 26                       }
 27           
 28                       try
 29                       {
 30                           await authManager.CompleteAuthFlowAsync(code, redirectUrl, state);
 31                           return Results.Content(RenderCallbackHtml("Authentication successful. You can close this window."), "tex
 32                       }
 33                       catch (Exception ex)
 34                       {
 35                           return Results.Content(RenderCallbackHtml($"Authentication failed: {ex.Message}"), "text/html", System.T
 36                       }
 37                   })
 38                   .WithTags("Antigravity")
 39                   .WithName("AntigravityAuthCallback");
 40           
 41                   var group = app.MapGroup("/antigravity")
 42                       .WithTags("Antigravity");
 43           
 44                   group.MapGet("/accounts", (IAntigravityAuthManager authManager) =>
 45                   {
 46                       return Results.Ok(authManager.ListAccounts());
 47                   })
 48                   .WithName("ListAntigravityAccounts");
 49           
 50                   group.MapPost("/auth/start", (IAntigravityAuthManager authManager, [FromBody] StartAuthRequest request) =>
 51                   {
 52                       var redirectUrl = string.IsNullOrWhiteSpace(request.RedirectUrl) ? DefaultRedirectUrl : request.RedirectUrl;
 53                       var url = authManager.StartAuthFlow(redirectUrl);
 54                       return Results.Ok(new
 55                       {
 56                           AuthUrl = url,
 57                           RedirectUrl = redirectUrl,
 58                           Instructions = "Open AuthUrl in your browser. After login, you will be redirected to the callback; no ma
 59                       });
 60                   })
 61                   .WithName("StartAntigravityAuth");
 62           
 63                   group.MapPost("/auth/complete", async (IAntigravityAuthManager authManager, [FromBody] CompleteAuthRequest reque
 64                   {
 65                       try
 66                       {
 67                           var (code, state, redirectUrl) = ResolveAuthCompletion(request);
 68                           if (string.IsNullOrWhiteSpace(code) || string.IsNullOrWhiteSpace(state))
 69                           {
 70                               return Results.BadRequest(new { Error = "Both code and state are required. Provide them directly or 
 71                           }
 72           
 73                           await authManager.CompleteAuthFlowAsync(code, redirectUrl, state);
 74                           return Results.Ok(new { Message = "Authentication successful. Account added." });
 75                       }
 76                       catch (System.Exception ex)
 77                       {
 78                           return Results.BadRequest(new { Error = ex.Message });
 79                       }
 80                   })
 81                   .WithName("CompleteAntigravityAuth");
 82               }
 83           
 84               private static (string Code, string State, string RedirectUrl) ResolveAuthCompletion(CompleteAuthRequest request)
 85               {
 86                   var code = request.Code;
 87                   var state = request.State;
 88                   var redirectUrl = request.RedirectUrl;
 89           
 90                   if (!string.IsNullOrWhiteSpace(request.CallbackUrl))
 91                   {
 92                       var callbackUri = new Uri(request.CallbackUrl);
 93                       var query = System.Web.HttpUtility.ParseQueryString(callbackUri.Query);
 94                       code ??= query["code"];
 95                       state ??= query["state"];
 96                       redirectUrl ??= callbackUri.GetLeftPart(UriPartial.Path);
 97                   }
 98           
 99                   if (string.IsNullOrWhiteSpace(redirectUrl))
100                   {
101                       redirectUrl = DefaultRedirectUrl;
102                   }
103           
104                   return (code ?? string.Empty, state ?? string.Empty, redirectUrl);
105               }
106           
107               private static string RenderCallbackHtml(string message)
108               {
109                   return $"<!doctype html><html><head><meta charset=\"utf-8\"><title>Antigravity Auth</title></head><body style=\"
110               }
111           }
112           
113           public class StartAuthRequest
114           {
115               public string? RedirectUrl { get; set; }
116           }
117           
118           public class CompleteAuthRequest
119           {
120  ✔  2         public string? Code { get; set; }
121  ✔  2         public string? State { get; set; }
122  ✔  2         public string? RedirectUrl { get; set; }
123  ✔  1         public string? CallbackUrl { get; set; }
124           }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.StartAuthRequest

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity.StartAuthRequest |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Antigravity/AntigravityEndpoints.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 124 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_RedirectUrl()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Antigravity/AntigravityEndpoints.cs
```
  1           using Microsoft.AspNetCore.Builder;
  2           using Microsoft.AspNetCore.Http;
  3           using Microsoft.AspNetCore.Mvc;
  4           using Microsoft.AspNetCore.Routing;
  5           using Synaxis.InferenceGateway.Infrastructure.Auth;
  6           using System;
  7           using System.Threading.Tasks;
  8           
  9           namespace Synaxis.InferenceGateway.WebApi.Endpoints.Antigravity;
 10           
 11           public static class AntigravityEndpoints
 12           {
 13               private const string DefaultRedirectUrl = "http://localhost:51121/oauth/antigravity/callback";
 14           
 15               public static void MapAntigravityEndpoints(this IEndpointRouteBuilder app)
 16               {
 17                   app.MapGet("/oauth/antigravity/callback", async (IAntigravityAuthManager authManager, HttpRequest request) =>
 18                   {
 19                       var code = request.Query["code"].ToString();
 20                       var state = request.Query["state"].ToString();
 21                       var redirectUrl = $"{request.Scheme}://{request.Host}{request.Path}";
 22           
 23                       if (string.IsNullOrWhiteSpace(code) || string.IsNullOrWhiteSpace(state))
 24                       {
 25                           return Results.Content(RenderCallbackHtml("Missing code or state in callback URL."), "text/html", System
 26                       }
 27           
 28                       try
 29                       {
 30                           await authManager.CompleteAuthFlowAsync(code, redirectUrl, state);
 31                           return Results.Content(RenderCallbackHtml("Authentication successful. You can close this window."), "tex
 32                       }
 33                       catch (Exception ex)
 34                       {
 35                           return Results.Content(RenderCallbackHtml($"Authentication failed: {ex.Message}"), "text/html", System.T
 36                       }
 37                   })
 38                   .WithTags("Antigravity")
 39                   .WithName("AntigravityAuthCallback");
 40           
 41                   var group = app.MapGroup("/antigravity")
 42                       .WithTags("Antigravity");
 43           
 44                   group.MapGet("/accounts", (IAntigravityAuthManager authManager) =>
 45                   {
 46                       return Results.Ok(authManager.ListAccounts());
 47                   })
 48                   .WithName("ListAntigravityAccounts");
 49           
 50                   group.MapPost("/auth/start", (IAntigravityAuthManager authManager, [FromBody] StartAuthRequest request) =>
 51                   {
 52                       var redirectUrl = string.IsNullOrWhiteSpace(request.RedirectUrl) ? DefaultRedirectUrl : request.RedirectUrl;
 53                       var url = authManager.StartAuthFlow(redirectUrl);
 54                       return Results.Ok(new
 55                       {
 56                           AuthUrl = url,
 57                           RedirectUrl = redirectUrl,
 58                           Instructions = "Open AuthUrl in your browser. After login, you will be redirected to the callback; no ma
 59                       });
 60                   })
 61                   .WithName("StartAntigravityAuth");
 62           
 63                   group.MapPost("/auth/complete", async (IAntigravityAuthManager authManager, [FromBody] CompleteAuthRequest reque
 64                   {
 65                       try
 66                       {
 67                           var (code, state, redirectUrl) = ResolveAuthCompletion(request);
 68                           if (string.IsNullOrWhiteSpace(code) || string.IsNullOrWhiteSpace(state))
 69                           {
 70                               return Results.BadRequest(new { Error = "Both code and state are required. Provide them directly or 
 71                           }
 72           
 73                           await authManager.CompleteAuthFlowAsync(code, redirectUrl, state);
 74                           return Results.Ok(new { Message = "Authentication successful. Account added." });
 75                       }
 76                       catch (System.Exception ex)
 77                       {
 78                           return Results.BadRequest(new { Error = ex.Message });
 79                       }
 80                   })
 81                   .WithName("CompleteAntigravityAuth");
 82               }
 83           
 84               private static (string Code, string State, string RedirectUrl) ResolveAuthCompletion(CompleteAuthRequest request)
 85               {
 86                   var code = request.Code;
 87                   var state = request.State;
 88                   var redirectUrl = request.RedirectUrl;
 89           
 90                   if (!string.IsNullOrWhiteSpace(request.CallbackUrl))
 91                   {
 92                       var callbackUri = new Uri(request.CallbackUrl);
 93                       var query = System.Web.HttpUtility.ParseQueryString(callbackUri.Query);
 94                       code ??= query["code"];
 95                       state ??= query["state"];
 96                       redirectUrl ??= callbackUri.GetLeftPart(UriPartial.Path);
 97                   }
 98           
 99                   if (string.IsNullOrWhiteSpace(redirectUrl))
100                   {
101                       redirectUrl = DefaultRedirectUrl;
102                   }
103           
104                   return (code ?? string.Empty, state ?? string.Empty, redirectUrl);
105               }
106           
107               private static string RenderCallbackHtml(string message)
108               {
109                   return $"<!doctype html><html><head><meta charset=\"utf-8\"><title>Antigravity Auth</title></head><body style=\"
110               }
111           }
112           
113           public class StartAuthRequest
114           {
115  ✔  3         public string? RedirectUrl { get; set; }
116           }
117           
118           public class CompleteAuthRequest
119           {
120               public string? Code { get; set; }
121               public string? State { get; set; }
122               public string? RedirectUrl { get; set; }
123               public string? CallbackUrl { get; set; }
124           }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.Identity.IdentityEndpoints

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.Identity.IdentityEndpoints |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Identity/IdentityEndpoints.cs |
| **Line coverage:** | 33.3% (9 of 27) |
| Covered lines: | 9 |
| Uncovered lines: | 18 |
| Coverable lines: | 27 |
| Total lines: | 50 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **MapIdentityEndpoints(...)** | 0% | 8 | 4 | 36.00% |
| **get_Code()** | 100% | 2 | 1 | 0% |
| **get_State()** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/Identity/IdentityEndpoints.cs
```
 1            using System.Collections.Generic;
 2            using System.Linq;
 3            using System.Threading.Tasks;
 4            using Microsoft.AspNetCore.Builder;
 5            using Microsoft.AspNetCore.Http;
 6            using Microsoft.AspNetCore.Mvc;
 7            using Microsoft.AspNetCore.Routing;
 8            using Synaxis.InferenceGateway.Infrastructure.Identity.Core;
 9            
10            namespace Synaxis.InferenceGateway.WebApi.Endpoints.Identity
11            {
12                public static class IdentityEndpoints
13                {
14                    public static void MapIdentityEndpoints(this IEndpointRouteBuilder app)
15  ✔  37             {
16  ✔  37                 var group = app.MapGroup("/api/identity").WithTags("Identity");
17            
18  ✔  37                 group.MapPost("/{provider}/start", async (IdentityManager manager, [FromRoute] string provider) =>
19  ❌  0                 {
20  ❌  0                     var result = await manager.StartAuth(provider);
21  ❌  0                     return Results.Ok(result);
22  ✔  37                 });
23            
24  ✔  37                 group.MapPost("/{provider}/complete", async (IdentityManager manager, [FromRoute] string provider, [FromBody
25  ❌  0                 {
26  ❌  0                     var res = await manager.CompleteAuth(provider, body.Code, body.State);
27  ❌  0                     return Results.Ok(res);
28  ✔  37                 });
29            
30  ✔  37                 group.MapGet("/accounts", async (ISecureTokenStore store) =>
31  ❌  0                 {
32  ❌  0                     var accounts = await store.LoadAsync().ConfigureAwait(false);
33  ❌  0  ○                  var masked = accounts.Select(a => new
34  ❌  0                     {
35  ❌  0                         a.Id,
36  ❌  0                         a.Provider,
37  ❌  0                         a.Email,
38  ❌  0                         AccessToken = string.IsNullOrEmpty(a.AccessToken) ? string.Empty : (a.AccessToken.Length <= 8 ? "***
39  ❌  0                     });
40  ❌  0                     return Results.Ok(masked);
41  ✔  37                 });
42  ✔  37             }
43            
44                    public class CompleteRequest
45                    {
46  ❌  0                 public string Code { get; set; } = string.Empty;
47  ❌  0                 public string State { get; set; } = string.Empty;
48                    }
49                }
50            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.LegacyCompletionsEndpoint

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.LegacyCompletionsEndpoint |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/LegacyCompletionsEndpoint.cs |
| **Line coverage:** | 58.5% (79 of 135) |
| Covered lines: | 79 |
| Uncovered lines: | 56 |
| Coverable lines: | 135 |
| Total lines: | 191 |
| **Branch coverage:** | 18.4% (7 of 38) |
| Covered branches: | 7 |
| Total branches: | 38 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **MapLegacyCompletions(...)** | 100% | 1 | 1 | 90.54% |
| **TryParsePrompt(...)** | 18.42% | 787 | 38 | 19.67% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/LegacyCompletionsEndpoint.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Http;
  3            using Microsoft.AspNetCore.Routing;
  4            using Microsoft.Extensions.AI;
  5            using Microsoft.Extensions.DependencyInjection;
  6            using Microsoft.AspNetCore.OpenApi;
  7            using Synaxis.InferenceGateway.Application.Routing;
  8            using Synaxis.InferenceGateway.WebApi.DTOs;
  9            using Synaxis.InferenceGateway.WebApi.Middleware;
 10            using System;
 11            using System.Collections.Generic;
 12            using System.Linq;
 13            using System.Text.Json;
 14            
 15            namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 16            
 17            public static class LegacyCompletionsEndpoint
 18            {
 19                public static void MapLegacyCompletions(this IEndpointRouteBuilder app)
 20  ✔  37         {
 21  ✔  37             app.MapPost("/v1/completions", async (HttpContext ctx, CompletionRequest request, IChatClient chatClient, IModel
 22  ✔   2             {
 23  ✔   2                 if (request.Stream && (request.BestOf ?? 1) > 1)
 24  ❌  0                 {
 25  ❌  0                     return Results.BadRequest(new { error = new { message = "Cannot stream with best_of > 1", type = "invali
 26  ✔  37                 }
 27  ✔  37     
 28  ✔   2                 var caps = new RequiredCapabilities { Streaming = request.Stream };
 29  ✔   2                 var resolution = await resolver.ResolveAsync(request.Model, EndpointKind.LegacyCompletions, caps);
 30  ✔  37     
 31  ✔   2                 ctx.Items["RoutingContext"] = new RoutingContext(request.Model, resolution.CanonicalId.ToString(), resolutio
 32  ✔  37     
 33  ✔   2                 if (!TryParsePrompt(request.Prompt, out var promptText, out var parseError))
 34  ❌  0                 {
 35  ❌  0                     return Results.BadRequest(new { error = new { message = parseError, type = "invalid_request_error", para
 36  ✔  37                 }
 37  ✔  37     
 38  ✔   2                 var messages = new List<ChatMessage> { new ChatMessage(ChatRole.User, promptText) };
 39  ✔   2                 var options = new ChatOptions
 40  ✔   2                 {
 41  ✔   2                     ModelId = resolution.CanonicalId.ToString(),
 42  ✔   2                     MaxOutputTokens = request.MaxTokens,
 43  ✔   2                     Temperature = (float?)request.Temperature
 44  ✔   2                 };
 45  ✔  37     
 46  ✔   2                 if (request.Stream)
 47  ✔   1                 {
 48  ✔   1                     ctx.Response.Headers.ContentType = "text/event-stream";
 49  ✔  11                     await foreach (var update in chatClient.GetStreamingResponseAsync(messages, options))
 50  ✔   4                     {
 51  ✔   4                         var chunk = new
 52  ✔   4                         {
 53  ✔   4                             id = "cmpl-" + Guid.NewGuid(),
 54  ✔   4                             @object = "text_completion",
 55  ✔   4                             created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
 56  ✔   4                             model = resolution.CanonicalId.ToString(),
 57  ✔   4                             choices = new[]
 58  ✔   4                             {
 59  ✔   4                                 new { text = update.Text, index = 0, finish_reason = update.FinishReason?.ToString().ToLower
 60  ✔   4                             }
 61  ✔   4                         };
 62  ✔   4                         await ctx.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk)}\n\n");
 63  ✔   4                         await ctx.Response.Body.FlushAsync();
 64  ✔   4                     }
 65  ✔   1                     await ctx.Response.WriteAsync("data: [DONE]\n\n");
 66  ✔   1                     return Results.Empty;
 67  ✔  37                 }
 68  ✔  37                 else
 69  ✔   1                 {
 70  ✔   1                     var response = await chatClient.GetResponseAsync(messages, options);
 71  ✔   1                     return Results.Ok(new
 72  ✔   1                     {
 73  ✔   1                         id = "cmpl-" + Guid.NewGuid(),
 74  ✔   1                         @object = "text_completion",
 75  ✔   1                         created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
 76  ✔   1                         model = resolution.CanonicalId.ToString(),
 77  ✔   1                         choices = new[]
 78  ✔   1                         {
 79  ✔   1                             new { text = response.Text, index = 0, finish_reason = response.FinishReason?.ToString().ToLower
 80  ✔   1                         },
 81  ✔   1                         usage = new { prompt_tokens = response.Usage?.InputTokenCount ?? 0, completion_tokens = response.Usa
 82  ✔   1                     });
 83  ✔  37                 }
 84  ✔  37             })
 85  ✔  37             .WithTags("Completions")
 86  ✔  37             .WithSummary("Legacy text completion")
 87  ✔  37             .WithName("CreateCompletion")
 88  ✔  37             .AddOpenApiOperationTransformer((operation, context, ct) =>
 89  ❌  0             {
 90  ❌  0                 operation.Deprecated = true;
 91  ❌  0                 return Task.CompletedTask;
 92  ✔  37             });
 93  ✔  39         }
 94            
 95                private static bool TryParsePrompt(object? promptObj, out string promptText, out string? errorMessage)
 96  ✔   2         {
 97  ✔   2             promptText = string.Empty;
 98  ✔   2             errorMessage = null;
 99            
100  ✓   2  ◑          if (promptObj == null)
101  ❌  0             {
102                        // treat null as empty prompt
103  ❌  0                 return true;
104                    }
105            
106                    // Straight string
107  ✓   2  ◑          if (promptObj is string s)
108  ❌  0             {
109  ❌  0                 promptText = s;
110  ❌  0                 return true;
111                    }
112            
113                    // JsonElement from System.Text.Json (common when model binding raw JSON)
114  ✓   2  ◑          if (promptObj is JsonElement je)
115  ✔   2             {
116                        try
117  ✔   2                 {
118  ✓   2  ◔                  switch (je.ValueKind)
119                            {
120                                case JsonValueKind.String:
121  ✓   2  ◑                          promptText = je.GetString() ?? string.Empty;
122  ✔   2                             return true;
123                                case JsonValueKind.Array:
124  ❌  0                             var parts = new List<string>();
125  ❌  0  ○                          foreach (var el in je.EnumerateArray())
126  ❌  0                             {
127  ❌  0  ○                              if (el.ValueKind == JsonValueKind.String)
128  ❌  0                                 {
129  ❌  0  ○                                  parts.Add(el.GetString() ?? string.Empty);
130  ❌  0                                 }
131                                        else
132  ❌  0                                 {
133  ❌  0                                     errorMessage = "Prompt array must contain only strings.";
134  ❌  0                                     return false;
135                                        }
136  ❌  0                             }
137  ❌  0                             promptText = string.Join("\n", parts);
138  ❌  0                             return true;
139                                case JsonValueKind.Null:
140  ❌  0                             promptText = string.Empty;
141  ❌  0                             return true;
142                                default:
143  ❌  0                             errorMessage = "Prompt must be a string or an array of strings.";
144  ❌  0                             return false;
145                            }
146                        }
147  ❌  0                 catch (Exception ex)
148  ❌  0                 {
149  ❌  0  ○                  errorMessage = "Malformed prompt." + (ex.Message.Length > 0 ? " " + ex.Message : string.Empty);
150  ❌  0                     return false;
151                        }
152                    }
153            
154                    // Enumerable types (e.g., string[] bound by some serializers)
155  ❌  0  ○          if (promptObj is System.Collections.IEnumerable ie)
156  ❌  0             {
157  ❌  0                 var parts = new List<string>();
158  ❌  0  ○              foreach (var item in ie)
159  ❌  0                 {
160  ❌  0  ○                  if (item == null)
161  ❌  0                     {
162  ❌  0                         parts.Add(string.Empty);
163  ❌  0                         continue;
164                            }
165            
166  ❌  0  ○                  if (item is string si)
167  ❌  0                     {
168  ❌  0                         parts.Add(si);
169  ❌  0                         continue;
170                            }
171            
172                            // If items are JsonElement strings
173  ❌  0  ○                  if (item is JsonElement jel && jel.ValueKind == JsonValueKind.String)
174  ❌  0                     {
175  ❌  0  ○                      parts.Add(jel.GetString() ?? string.Empty);
176  ❌  0                         continue;
177                            }
178            
179  ❌  0                     errorMessage = "Prompt array must contain only strings.";
180  ❌  0                     return false;
181                        }
182            
183  ❌  0                 promptText = string.Join("\n", parts);
184  ❌  0                 return true;
185                    }
186            
187                    // Fallback: unsupported type
188  ❌  0             errorMessage = "Prompt must be a string or an array of strings.";
189  ❌  0             return false;
190  ✔   2         }
191            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelCapabilitiesDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelCapabilitiesDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs |
| **Line coverage:** | 100% (5 of 5) |
| Covered lines: | 5 |
| Uncovered lines: | 0 |
| Coverable lines: | 5 |
| Total lines: | 173 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Streaming()** | 100% | 1 | 1 | 100% |
| **get_Tools()** | 100% | 1 | 1 | 100% |
| **get_Vision()** | 100% | 1 | 1 | 100% |
| **get_StructuredOutput()** | 100% | 1 | 1 | 100% |
| **get_LogProbs()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs
```
  1              using Microsoft.AspNetCore.Builder;
  2              using Microsoft.AspNetCore.Http;
  3              using Microsoft.AspNetCore.Routing;
  4              using Microsoft.Extensions.Options;
  5              using Synaxis.InferenceGateway.Application.Configuration;
  6              using System;
  7              using System.Collections.Generic;
  8              using System.Linq;
  9              
 10              namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 11              
 12              public static class ModelsEndpoint
 13              {
 14                  public static void MapModels(this IEndpointRouteBuilder app)
 15                  {
 16                      app.MapGet("/v1/models", (IOptions<SynaxisConfiguration> config) =>
 17                      {
 18                          var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 19                          var models = new List<ModelDto>();
 20              
 21                          foreach (var cm in config.Value.CanonicalModels)
 22                          {
 23                              var providerConfig = config.Value.Providers.GetValueOrDefault(cm.Provider);
 24                              models.Add(new ModelDto
 25                              {
 26                                  Id = cm.Id,
 27                                  Object = "model",
 28                                  Created = now,
 29                                  OwnedBy = cm.Provider,
 30                                  Provider = cm.Provider,
 31                                  ModelPath = cm.ModelPath,
 32                                  Capabilities = new ModelCapabilitiesDto
 33                                  {
 34                                      Streaming = cm.Streaming,
 35                                      Tools = cm.Tools,
 36                                      Vision = cm.Vision,
 37                                      StructuredOutput = cm.StructuredOutput,
 38                                      LogProbs = cm.LogProbs
 39                                  }
 40                              });
 41                          }
 42              
 43                          foreach (var alias in config.Value.Aliases)
 44                          {
 45                              models.Add(new ModelDto
 46                              {
 47                                  Id = alias.Key,
 48                                  Object = "model",
 49                                  Created = now,
 50                                  OwnedBy = "synaxis",
 51                                  Provider = "synaxis",
 52                                  ModelPath = alias.Key,
 53                                  Capabilities = new ModelCapabilitiesDto()
 54                              });
 55                          }
 56              
 57                          var response = new ModelsListResponseDto
 58                          {
 59                              Object = "list",
 60                              Data = models,
 61                              Providers = config.Value.Providers.Select(p => new ProviderSummaryDto
 62                              {
 63                                  Id = p.Key,
 64                                  Type = p.Value.Type,
 65                                  Enabled = p.Value.Enabled,
 66                                  Tier = p.Value.Tier
 67                              }).ToList()
 68                          };
 69              
 70                          return Results.Json(response, ModelJsonContext.Options);
 71                      })
 72                      .WithTags("Models")
 73                      .WithSummary("List models with capabilities and provider information")
 74                      .WithDescription("Returns all available models grouped by provider with their capabilities (streaming, tools, vi
 75              
 76                      app.MapGet("/v1/models/{**id}", (string id, IOptions<SynaxisConfiguration> config) =>
 77                      {
 78                          var cm = config.Value.CanonicalModels.FirstOrDefault(x => x.Id == id);
 79                          if (cm != null)
 80                          {
 81              return Results.Json(new ModelDto
 82                          {
 83                              Id = cm.Id,
 84                              Object = "model",
 85                              Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
 86                              OwnedBy = cm.Provider,
 87                              Provider = cm.Provider,
 88                              ModelPath = cm.ModelPath,
 89                              Capabilities = new ModelCapabilitiesDto
 90                              {
 91                                  Streaming = cm.Streaming,
 92                                  Tools = cm.Tools,
 93                                  Vision = cm.Vision,
 94                                  StructuredOutput = cm.StructuredOutput,
 95                                  LogProbs = cm.LogProbs
 96                              }
 97                          }, ModelJsonContext.Options);
 98                          }
 99              
100                          if (config.Value.Aliases.ContainsKey(id))
101                          {
102                              return Results.Json(new ModelDto
103                              {
104                                  Id = id,
105                                  Object = "model",
106                                  Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
107                                  OwnedBy = "synaxis",
108                                  Provider = "synaxis",
109                                  ModelPath = id,
110                                  Capabilities = new ModelCapabilitiesDto()
111                              }, ModelJsonContext.Options);
112                          }
113              
114                          return Results.Json(new
115                          {
116                              error = new
117                              {
118                                  message = $"The model '{id}' does not exist",
119                                  type = "invalid_request_error",
120                                  param = "model",
121                                  code = "model_not_found"
122                              }
123                          }, ModelJsonContext.Options, statusCode: 404);
124                      })
125                      .WithTags("Models")
126                      .WithSummary("Retrieve model with capabilities")
127                      .WithDescription("Returns detailed information about a specific model including its capabilities");
128                  }
129              }
130              
131              public class ModelDto
132              {
133                  public string Id { get; set; } = "";
134                  public string Object { get; set; } = "";
135                  public long Created { get; set; }
136                  public string OwnedBy { get; set; } = "";
137                  public string Provider { get; set; } = "";
138                  public string ModelPath { get; set; } = "";
139                  public ModelCapabilitiesDto Capabilities { get; set; } = new();
140              }
141              
142              public class ModelCapabilitiesDto
143              {
144  ✔  2008         public bool Streaming { get; set; }
145  ✔  2008         public bool Tools { get; set; }
146  ✔  2008         public bool Vision { get; set; }
147  ✔  2008         public bool StructuredOutput { get; set; }
148  ✔  2008         public bool LogProbs { get; set; }
149              }
150              
151              public class ModelsListResponseDto
152              {
153                  public string Object { get; set; } = "";
154                  public List<ModelDto> Data { get; set; } = new();
155                  public List<ProviderSummaryDto> Providers { get; set; } = new();
156              }
157              
158              public class ProviderSummaryDto
159              {
160                  public string Id { get; set; } = "";
161                  public string Type { get; set; } = "";
162                  public bool Enabled { get; set; }
163                  public int Tier { get; set; }
164              }
165              
166              public static class ModelJsonContext
167              {
168                  public static readonly System.Text.Json.JsonSerializerOptions Options = new()
169                  {
170                      PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.SnakeCaseLower,
171                      PropertyNameCaseInsensitive = true
172                  };
173              }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs |
| **Line coverage:** | 100% (7 of 7) |
| Covered lines: | 7 |
| Uncovered lines: | 0 |
| Coverable lines: | 7 |
| Total lines: | 173 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Object()** | 100% | 1 | 1 | 100% |
| **get_Created()** | 100% | 1 | 1 | 100% |
| **get_OwnedBy()** | 100% | 1 | 1 | 100% |
| **get_Provider()** | 100% | 1 | 1 | 100% |
| **get_ModelPath()** | 100% | 1 | 1 | 100% |
| **get_Capabilities()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs
```
  1              using Microsoft.AspNetCore.Builder;
  2              using Microsoft.AspNetCore.Http;
  3              using Microsoft.AspNetCore.Routing;
  4              using Microsoft.Extensions.Options;
  5              using Synaxis.InferenceGateway.Application.Configuration;
  6              using System;
  7              using System.Collections.Generic;
  8              using System.Linq;
  9              
 10              namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 11              
 12              public static class ModelsEndpoint
 13              {
 14                  public static void MapModels(this IEndpointRouteBuilder app)
 15                  {
 16                      app.MapGet("/v1/models", (IOptions<SynaxisConfiguration> config) =>
 17                      {
 18                          var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 19                          var models = new List<ModelDto>();
 20              
 21                          foreach (var cm in config.Value.CanonicalModels)
 22                          {
 23                              var providerConfig = config.Value.Providers.GetValueOrDefault(cm.Provider);
 24                              models.Add(new ModelDto
 25                              {
 26                                  Id = cm.Id,
 27                                  Object = "model",
 28                                  Created = now,
 29                                  OwnedBy = cm.Provider,
 30                                  Provider = cm.Provider,
 31                                  ModelPath = cm.ModelPath,
 32                                  Capabilities = new ModelCapabilitiesDto
 33                                  {
 34                                      Streaming = cm.Streaming,
 35                                      Tools = cm.Tools,
 36                                      Vision = cm.Vision,
 37                                      StructuredOutput = cm.StructuredOutput,
 38                                      LogProbs = cm.LogProbs
 39                                  }
 40                              });
 41                          }
 42              
 43                          foreach (var alias in config.Value.Aliases)
 44                          {
 45                              models.Add(new ModelDto
 46                              {
 47                                  Id = alias.Key,
 48                                  Object = "model",
 49                                  Created = now,
 50                                  OwnedBy = "synaxis",
 51                                  Provider = "synaxis",
 52                                  ModelPath = alias.Key,
 53                                  Capabilities = new ModelCapabilitiesDto()
 54                              });
 55                          }
 56              
 57                          var response = new ModelsListResponseDto
 58                          {
 59                              Object = "list",
 60                              Data = models,
 61                              Providers = config.Value.Providers.Select(p => new ProviderSummaryDto
 62                              {
 63                                  Id = p.Key,
 64                                  Type = p.Value.Type,
 65                                  Enabled = p.Value.Enabled,
 66                                  Tier = p.Value.Tier
 67                              }).ToList()
 68                          };
 69              
 70                          return Results.Json(response, ModelJsonContext.Options);
 71                      })
 72                      .WithTags("Models")
 73                      .WithSummary("List models with capabilities and provider information")
 74                      .WithDescription("Returns all available models grouped by provider with their capabilities (streaming, tools, vi
 75              
 76                      app.MapGet("/v1/models/{**id}", (string id, IOptions<SynaxisConfiguration> config) =>
 77                      {
 78                          var cm = config.Value.CanonicalModels.FirstOrDefault(x => x.Id == id);
 79                          if (cm != null)
 80                          {
 81              return Results.Json(new ModelDto
 82                          {
 83                              Id = cm.Id,
 84                              Object = "model",
 85                              Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
 86                              OwnedBy = cm.Provider,
 87                              Provider = cm.Provider,
 88                              ModelPath = cm.ModelPath,
 89                              Capabilities = new ModelCapabilitiesDto
 90                              {
 91                                  Streaming = cm.Streaming,
 92                                  Tools = cm.Tools,
 93                                  Vision = cm.Vision,
 94                                  StructuredOutput = cm.StructuredOutput,
 95                                  LogProbs = cm.LogProbs
 96                              }
 97                          }, ModelJsonContext.Options);
 98                          }
 99              
100                          if (config.Value.Aliases.ContainsKey(id))
101                          {
102                              return Results.Json(new ModelDto
103                              {
104                                  Id = id,
105                                  Object = "model",
106                                  Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
107                                  OwnedBy = "synaxis",
108                                  Provider = "synaxis",
109                                  ModelPath = id,
110                                  Capabilities = new ModelCapabilitiesDto()
111                              }, ModelJsonContext.Options);
112                          }
113              
114                          return Results.Json(new
115                          {
116                              error = new
117                              {
118                                  message = $"The model '{id}' does not exist",
119                                  type = "invalid_request_error",
120                                  param = "model",
121                                  code = "model_not_found"
122                              }
123                          }, ModelJsonContext.Options, statusCode: 404);
124                      })
125                      .WithTags("Models")
126                      .WithSummary("Retrieve model with capabilities")
127                      .WithDescription("Returns detailed information about a specific model including its capabilities");
128                  }
129              }
130              
131              public class ModelDto
132              {
133  ✔  3729         public string Id { get; set; } = "";
134  ✔  3729         public string Object { get; set; } = "";
135  ✔  2486         public long Created { get; set; }
136  ✔  3729         public string OwnedBy { get; set; } = "";
137  ✔  3729         public string Provider { get; set; } = "";
138  ✔  3729         public string ModelPath { get; set; } = "";
139  ✔  3747         public ModelCapabilitiesDto Capabilities { get; set; } = new();
140              }
141              
142              public class ModelCapabilitiesDto
143              {
144                  public bool Streaming { get; set; }
145                  public bool Tools { get; set; }
146                  public bool Vision { get; set; }
147                  public bool StructuredOutput { get; set; }
148                  public bool LogProbs { get; set; }
149              }
150              
151              public class ModelsListResponseDto
152              {
153                  public string Object { get; set; } = "";
154                  public List<ModelDto> Data { get; set; } = new();
155                  public List<ProviderSummaryDto> Providers { get; set; } = new();
156              }
157              
158              public class ProviderSummaryDto
159              {
160                  public string Id { get; set; } = "";
161                  public string Type { get; set; } = "";
162                  public bool Enabled { get; set; }
163                  public int Tier { get; set; }
164              }
165              
166              public static class ModelJsonContext
167              {
168                  public static readonly System.Text.Json.JsonSerializerOptions Options = new()
169                  {
170                      PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.SnakeCaseLower,
171                      PropertyNameCaseInsensitive = true
172                  };
173              }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelJsonContext

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelJsonContext |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs |
| **Line coverage:** | 100% (5 of 5) |
| Covered lines: | 5 |
| Uncovered lines: | 0 |
| Coverable lines: | 5 |
| Total lines: | 173 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs
```
  1           using Microsoft.AspNetCore.Builder;
  2           using Microsoft.AspNetCore.Http;
  3           using Microsoft.AspNetCore.Routing;
  4           using Microsoft.Extensions.Options;
  5           using Synaxis.InferenceGateway.Application.Configuration;
  6           using System;
  7           using System.Collections.Generic;
  8           using System.Linq;
  9           
 10           namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 11           
 12           public static class ModelsEndpoint
 13           {
 14               public static void MapModels(this IEndpointRouteBuilder app)
 15               {
 16                   app.MapGet("/v1/models", (IOptions<SynaxisConfiguration> config) =>
 17                   {
 18                       var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 19                       var models = new List<ModelDto>();
 20           
 21                       foreach (var cm in config.Value.CanonicalModels)
 22                       {
 23                           var providerConfig = config.Value.Providers.GetValueOrDefault(cm.Provider);
 24                           models.Add(new ModelDto
 25                           {
 26                               Id = cm.Id,
 27                               Object = "model",
 28                               Created = now,
 29                               OwnedBy = cm.Provider,
 30                               Provider = cm.Provider,
 31                               ModelPath = cm.ModelPath,
 32                               Capabilities = new ModelCapabilitiesDto
 33                               {
 34                                   Streaming = cm.Streaming,
 35                                   Tools = cm.Tools,
 36                                   Vision = cm.Vision,
 37                                   StructuredOutput = cm.StructuredOutput,
 38                                   LogProbs = cm.LogProbs
 39                               }
 40                           });
 41                       }
 42           
 43                       foreach (var alias in config.Value.Aliases)
 44                       {
 45                           models.Add(new ModelDto
 46                           {
 47                               Id = alias.Key,
 48                               Object = "model",
 49                               Created = now,
 50                               OwnedBy = "synaxis",
 51                               Provider = "synaxis",
 52                               ModelPath = alias.Key,
 53                               Capabilities = new ModelCapabilitiesDto()
 54                           });
 55                       }
 56           
 57                       var response = new ModelsListResponseDto
 58                       {
 59                           Object = "list",
 60                           Data = models,
 61                           Providers = config.Value.Providers.Select(p => new ProviderSummaryDto
 62                           {
 63                               Id = p.Key,
 64                               Type = p.Value.Type,
 65                               Enabled = p.Value.Enabled,
 66                               Tier = p.Value.Tier
 67                           }).ToList()
 68                       };
 69           
 70                       return Results.Json(response, ModelJsonContext.Options);
 71                   })
 72                   .WithTags("Models")
 73                   .WithSummary("List models with capabilities and provider information")
 74                   .WithDescription("Returns all available models grouped by provider with their capabilities (streaming, tools, vi
 75           
 76                   app.MapGet("/v1/models/{**id}", (string id, IOptions<SynaxisConfiguration> config) =>
 77                   {
 78                       var cm = config.Value.CanonicalModels.FirstOrDefault(x => x.Id == id);
 79                       if (cm != null)
 80                       {
 81           return Results.Json(new ModelDto
 82                       {
 83                           Id = cm.Id,
 84                           Object = "model",
 85                           Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
 86                           OwnedBy = cm.Provider,
 87                           Provider = cm.Provider,
 88                           ModelPath = cm.ModelPath,
 89                           Capabilities = new ModelCapabilitiesDto
 90                           {
 91                               Streaming = cm.Streaming,
 92                               Tools = cm.Tools,
 93                               Vision = cm.Vision,
 94                               StructuredOutput = cm.StructuredOutput,
 95                               LogProbs = cm.LogProbs
 96                           }
 97                       }, ModelJsonContext.Options);
 98                       }
 99           
100                       if (config.Value.Aliases.ContainsKey(id))
101                       {
102                           return Results.Json(new ModelDto
103                           {
104                               Id = id,
105                               Object = "model",
106                               Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
107                               OwnedBy = "synaxis",
108                               Provider = "synaxis",
109                               ModelPath = id,
110                               Capabilities = new ModelCapabilitiesDto()
111                           }, ModelJsonContext.Options);
112                       }
113           
114                       return Results.Json(new
115                       {
116                           error = new
117                           {
118                               message = $"The model '{id}' does not exist",
119                               type = "invalid_request_error",
120                               param = "model",
121                               code = "model_not_found"
122                           }
123                       }, ModelJsonContext.Options, statusCode: 404);
124                   })
125                   .WithTags("Models")
126                   .WithSummary("Retrieve model with capabilities")
127                   .WithDescription("Returns detailed information about a specific model including its capabilities");
128               }
129           }
130           
131           public class ModelDto
132           {
133               public string Id { get; set; } = "";
134               public string Object { get; set; } = "";
135               public long Created { get; set; }
136               public string OwnedBy { get; set; } = "";
137               public string Provider { get; set; } = "";
138               public string ModelPath { get; set; } = "";
139               public ModelCapabilitiesDto Capabilities { get; set; } = new();
140           }
141           
142           public class ModelCapabilitiesDto
143           {
144               public bool Streaming { get; set; }
145               public bool Tools { get; set; }
146               public bool Vision { get; set; }
147               public bool StructuredOutput { get; set; }
148               public bool LogProbs { get; set; }
149           }
150           
151           public class ModelsListResponseDto
152           {
153               public string Object { get; set; } = "";
154               public List<ModelDto> Data { get; set; } = new();
155               public List<ProviderSummaryDto> Providers { get; set; } = new();
156           }
157           
158           public class ProviderSummaryDto
159           {
160               public string Id { get; set; } = "";
161               public string Type { get; set; } = "";
162               public bool Enabled { get; set; }
163               public int Tier { get; set; }
164           }
165           
166           public static class ModelJsonContext
167           {
168  ✔  1         public static readonly System.Text.Json.JsonSerializerOptions Options = new()
169  ✔  1         {
170  ✔  1             PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.SnakeCaseLower,
171  ✔  1             PropertyNameCaseInsensitive = true
172  ✔  1         };
173           }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelsEndpoint

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelsEndpoint |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs |
| **Line coverage:** | 90.2% (102 of 113) |
| Covered lines: | 102 |
| Uncovered lines: | 11 |
| Coverable lines: | 113 |
| Total lines: | 173 |
| **Branch coverage:** | 87.5% (7 of 8) |
| Covered branches: | 7 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **MapModels(...)** | 87.50% | 8 | 8 | 90.26% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs
```
  1              using Microsoft.AspNetCore.Builder;
  2              using Microsoft.AspNetCore.Http;
  3              using Microsoft.AspNetCore.Routing;
  4              using Microsoft.Extensions.Options;
  5              using Synaxis.InferenceGateway.Application.Configuration;
  6              using System;
  7              using System.Collections.Generic;
  8              using System.Linq;
  9              
 10              namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 11              
 12              public static class ModelsEndpoint
 13              {
 14                  public static void MapModels(this IEndpointRouteBuilder app)
 15  ✔    37         {
 16  ✔    37             app.MapGet("/v1/models", (IOptions<SynaxisConfiguration> config) =>
 17  ✔    19             {
 18  ✔    19                 var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 19  ✔    19                 var models = new List<ModelDto>();
 20  ✔    37     
 21  ✔  1577  ●              foreach (var cm in config.Value.CanonicalModels)
 22  ✔   760                 {
 23  ✔   760                     var providerConfig = config.Value.Providers.GetValueOrDefault(cm.Provider);
 24  ✔   760                     models.Add(new ModelDto
 25  ✔   760                     {
 26  ✔   760                         Id = cm.Id,
 27  ✔   760                         Object = "model",
 28  ✔   760                         Created = now,
 29  ✔   760                         OwnedBy = cm.Provider,
 30  ✔   760                         Provider = cm.Provider,
 31  ✔   760                         ModelPath = cm.ModelPath,
 32  ✔   760                         Capabilities = new ModelCapabilitiesDto
 33  ✔   760                         {
 34  ✔   760                             Streaming = cm.Streaming,
 35  ✔   760                             Tools = cm.Tools,
 36  ✔   760                             Vision = cm.Vision,
 37  ✔   760                             StructuredOutput = cm.StructuredOutput,
 38  ✔   760                             LogProbs = cm.LogProbs
 39  ✔   760                         }
 40  ✔   760                     });
 41  ✔   760                 }
 42  ✔    37     
 43  ✔  1013  ●              foreach (var alias in config.Value.Aliases)
 44  ✔   478                 {
 45  ✔   478                     models.Add(new ModelDto
 46  ✔   478                     {
 47  ✔   478                         Id = alias.Key,
 48  ✔   478                         Object = "model",
 49  ✔   478                         Created = now,
 50  ✔   478                         OwnedBy = "synaxis",
 51  ✔   478                         Provider = "synaxis",
 52  ✔   478                         ModelPath = alias.Key,
 53  ✔   478                         Capabilities = new ModelCapabilitiesDto()
 54  ✔   478                     });
 55  ✔   478                 }
 56  ✔    37     
 57  ✔    19                 var response = new ModelsListResponseDto
 58  ✔    19                 {
 59  ✔    19                     Object = "list",
 60  ✔    19                     Data = models,
 61  ✔   344                     Providers = config.Value.Providers.Select(p => new ProviderSummaryDto
 62  ✔   344                     {
 63  ✔   344                         Id = p.Key,
 64  ✔   344                         Type = p.Value.Type,
 65  ✔   344                         Enabled = p.Value.Enabled,
 66  ✔   344                         Tier = p.Value.Tier
 67  ✔   344                     }).ToList()
 68  ✔    19                 };
 69  ✔    37     
 70  ✔    19                 return Results.Json(response, ModelJsonContext.Options);
 71  ✔    19             })
 72  ✔    37             .WithTags("Models")
 73  ✔    37             .WithSummary("List models with capabilities and provider information")
 74  ✔    37             .WithDescription("Returns all available models grouped by provider with their capabilities (streaming, tools, vi
 75              
 76  ✔    37             app.MapGet("/v1/models/{**id}", (string id, IOptions<SynaxisConfiguration> config) =>
 77  ✔     7             {
 78  ✔    92                 var cm = config.Value.CanonicalModels.FirstOrDefault(x => x.Id == id);
 79  ✔     7  ●              if (cm != null)
 80  ✔     5                 {
 81  ✔     5     return Results.Json(new ModelDto
 82  ✔     5                 {
 83  ✔     5                     Id = cm.Id,
 84  ✔     5                     Object = "model",
 85  ✔     5                     Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
 86  ✔     5                     OwnedBy = cm.Provider,
 87  ✔     5                     Provider = cm.Provider,
 88  ✔     5                     ModelPath = cm.ModelPath,
 89  ✔     5                     Capabilities = new ModelCapabilitiesDto
 90  ✔     5                     {
 91  ✔     5                         Streaming = cm.Streaming,
 92  ✔     5                         Tools = cm.Tools,
 93  ✔     5                         Vision = cm.Vision,
 94  ✔     5                         StructuredOutput = cm.StructuredOutput,
 95  ✔     5                         LogProbs = cm.LogProbs
 96  ✔     5                     }
 97  ✔     5                 }, ModelJsonContext.Options);
 98  ✔    37                 }
 99  ✔    37     
100  ✓     2  ◑              if (config.Value.Aliases.ContainsKey(id))
101  ❌    0                 {
102  ❌    0                     return Results.Json(new ModelDto
103  ❌    0                     {
104  ❌    0                         Id = id,
105  ❌    0                         Object = "model",
106  ❌    0                         Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
107  ❌    0                         OwnedBy = "synaxis",
108  ❌    0                         Provider = "synaxis",
109  ❌    0                         ModelPath = id,
110  ❌    0                         Capabilities = new ModelCapabilitiesDto()
111  ❌    0                     }, ModelJsonContext.Options);
112  ✔    37                 }
113  ✔    37     
114  ✔     2                 return Results.Json(new
115  ✔     2                 {
116  ✔     2                     error = new
117  ✔     2                     {
118  ✔     2                         message = $"The model '{id}' does not exist",
119  ✔     2                         type = "invalid_request_error",
120  ✔     2                         param = "model",
121  ✔     2                         code = "model_not_found"
122  ✔     2                     }
123  ✔     2                 }, ModelJsonContext.Options, statusCode: 404);
124  ✔     7             })
125  ✔    37             .WithTags("Models")
126  ✔    37             .WithSummary("Retrieve model with capabilities")
127  ✔    37             .WithDescription("Returns detailed information about a specific model including its capabilities");
128  ✔    37         }
129              }
130              
131              public class ModelDto
132              {
133                  public string Id { get; set; } = "";
134                  public string Object { get; set; } = "";
135                  public long Created { get; set; }
136                  public string OwnedBy { get; set; } = "";
137                  public string Provider { get; set; } = "";
138                  public string ModelPath { get; set; } = "";
139                  public ModelCapabilitiesDto Capabilities { get; set; } = new();
140              }
141              
142              public class ModelCapabilitiesDto
143              {
144                  public bool Streaming { get; set; }
145                  public bool Tools { get; set; }
146                  public bool Vision { get; set; }
147                  public bool StructuredOutput { get; set; }
148                  public bool LogProbs { get; set; }
149              }
150              
151              public class ModelsListResponseDto
152              {
153                  public string Object { get; set; } = "";
154                  public List<ModelDto> Data { get; set; } = new();
155                  public List<ProviderSummaryDto> Providers { get; set; } = new();
156              }
157              
158              public class ProviderSummaryDto
159              {
160                  public string Id { get; set; } = "";
161                  public string Type { get; set; } = "";
162                  public bool Enabled { get; set; }
163                  public int Tier { get; set; }
164              }
165              
166              public static class ModelJsonContext
167              {
168                  public static readonly System.Text.Json.JsonSerializerOptions Options = new()
169                  {
170                      PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.SnakeCaseLower,
171                      PropertyNameCaseInsensitive = true
172                  };
173              }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelsListResponseDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ModelsListResponseDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 173 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Object()** | 100% | 1 | 1 | 100% |
| **get_Data()** | 100% | 1 | 1 | 100% |
| **get_Providers()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Http;
  3            using Microsoft.AspNetCore.Routing;
  4            using Microsoft.Extensions.Options;
  5            using Synaxis.InferenceGateway.Application.Configuration;
  6            using System;
  7            using System.Collections.Generic;
  8            using System.Linq;
  9            
 10            namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 11            
 12            public static class ModelsEndpoint
 13            {
 14                public static void MapModels(this IEndpointRouteBuilder app)
 15                {
 16                    app.MapGet("/v1/models", (IOptions<SynaxisConfiguration> config) =>
 17                    {
 18                        var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 19                        var models = new List<ModelDto>();
 20            
 21                        foreach (var cm in config.Value.CanonicalModels)
 22                        {
 23                            var providerConfig = config.Value.Providers.GetValueOrDefault(cm.Provider);
 24                            models.Add(new ModelDto
 25                            {
 26                                Id = cm.Id,
 27                                Object = "model",
 28                                Created = now,
 29                                OwnedBy = cm.Provider,
 30                                Provider = cm.Provider,
 31                                ModelPath = cm.ModelPath,
 32                                Capabilities = new ModelCapabilitiesDto
 33                                {
 34                                    Streaming = cm.Streaming,
 35                                    Tools = cm.Tools,
 36                                    Vision = cm.Vision,
 37                                    StructuredOutput = cm.StructuredOutput,
 38                                    LogProbs = cm.LogProbs
 39                                }
 40                            });
 41                        }
 42            
 43                        foreach (var alias in config.Value.Aliases)
 44                        {
 45                            models.Add(new ModelDto
 46                            {
 47                                Id = alias.Key,
 48                                Object = "model",
 49                                Created = now,
 50                                OwnedBy = "synaxis",
 51                                Provider = "synaxis",
 52                                ModelPath = alias.Key,
 53                                Capabilities = new ModelCapabilitiesDto()
 54                            });
 55                        }
 56            
 57                        var response = new ModelsListResponseDto
 58                        {
 59                            Object = "list",
 60                            Data = models,
 61                            Providers = config.Value.Providers.Select(p => new ProviderSummaryDto
 62                            {
 63                                Id = p.Key,
 64                                Type = p.Value.Type,
 65                                Enabled = p.Value.Enabled,
 66                                Tier = p.Value.Tier
 67                            }).ToList()
 68                        };
 69            
 70                        return Results.Json(response, ModelJsonContext.Options);
 71                    })
 72                    .WithTags("Models")
 73                    .WithSummary("List models with capabilities and provider information")
 74                    .WithDescription("Returns all available models grouped by provider with their capabilities (streaming, tools, vi
 75            
 76                    app.MapGet("/v1/models/{**id}", (string id, IOptions<SynaxisConfiguration> config) =>
 77                    {
 78                        var cm = config.Value.CanonicalModels.FirstOrDefault(x => x.Id == id);
 79                        if (cm != null)
 80                        {
 81            return Results.Json(new ModelDto
 82                        {
 83                            Id = cm.Id,
 84                            Object = "model",
 85                            Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
 86                            OwnedBy = cm.Provider,
 87                            Provider = cm.Provider,
 88                            ModelPath = cm.ModelPath,
 89                            Capabilities = new ModelCapabilitiesDto
 90                            {
 91                                Streaming = cm.Streaming,
 92                                Tools = cm.Tools,
 93                                Vision = cm.Vision,
 94                                StructuredOutput = cm.StructuredOutput,
 95                                LogProbs = cm.LogProbs
 96                            }
 97                        }, ModelJsonContext.Options);
 98                        }
 99            
100                        if (config.Value.Aliases.ContainsKey(id))
101                        {
102                            return Results.Json(new ModelDto
103                            {
104                                Id = id,
105                                Object = "model",
106                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
107                                OwnedBy = "synaxis",
108                                Provider = "synaxis",
109                                ModelPath = id,
110                                Capabilities = new ModelCapabilitiesDto()
111                            }, ModelJsonContext.Options);
112                        }
113            
114                        return Results.Json(new
115                        {
116                            error = new
117                            {
118                                message = $"The model '{id}' does not exist",
119                                type = "invalid_request_error",
120                                param = "model",
121                                code = "model_not_found"
122                            }
123                        }, ModelJsonContext.Options, statusCode: 404);
124                    })
125                    .WithTags("Models")
126                    .WithSummary("Retrieve model with capabilities")
127                    .WithDescription("Returns detailed information about a specific model including its capabilities");
128                }
129            }
130            
131            public class ModelDto
132            {
133                public string Id { get; set; } = "";
134                public string Object { get; set; } = "";
135                public long Created { get; set; }
136                public string OwnedBy { get; set; } = "";
137                public string Provider { get; set; } = "";
138                public string ModelPath { get; set; } = "";
139                public ModelCapabilitiesDto Capabilities { get; set; } = new();
140            }
141            
142            public class ModelCapabilitiesDto
143            {
144                public bool Streaming { get; set; }
145                public bool Tools { get; set; }
146                public bool Vision { get; set; }
147                public bool StructuredOutput { get; set; }
148                public bool LogProbs { get; set; }
149            }
150            
151            public class ModelsListResponseDto
152            {
153  ✔  57         public string Object { get; set; } = "";
154  ✔  76         public List<ModelDto> Data { get; set; } = new();
155  ✔  57         public List<ProviderSummaryDto> Providers { get; set; } = new();
156            }
157            
158            public class ProviderSummaryDto
159            {
160                public string Id { get; set; } = "";
161                public string Type { get; set; } = "";
162                public bool Enabled { get; set; }
163                public int Tier { get; set; }
164            }
165            
166            public static class ModelJsonContext
167            {
168                public static readonly System.Text.Json.JsonSerializerOptions Options = new()
169                {
170                    PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.SnakeCaseLower,
171                    PropertyNameCaseInsensitive = true
172                };
173            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.OpenAIEndpointsExtensions

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.OpenAIEndpointsExtensions |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs |
| **Line coverage:** | 97.1% (206 of 212) |
| Covered lines: | 206 |
| Uncovered lines: | 6 |
| Coverable lines: | 212 |
| Total lines: | 277 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **MapOpenAIEndpoints(...)** | 100% | 1 | 1 | 100% |
| **MapOpenAIRoutes(...)** | 100% | 1 | 1 | 97.08% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Routing;
  3            using Microsoft.Extensions.DependencyInjection;
  4            using Microsoft.AspNetCore.OpenApi;
  5            using Microsoft.Agents.AI.Hosting.OpenAI;
  6            using Synaxis.InferenceGateway.WebApi.Agents;
  7            using Synaxis.InferenceGateway.WebApi.Helpers;
  8            using System;
  9            using System.Threading.Tasks;
 10            using System.Text.Json;
 11            using System.Linq;
 12            using Microsoft.AspNetCore.Http;
 13            using Mediator;
 14            using Synaxis.InferenceGateway.WebApi.Features.Chat.Commands;
 15            using Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
 16            
 17            namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 18            
 19            public static class OpenAIEndpointsExtensions
 20            {
 21                public static IEndpointRouteBuilder MapOpenAIEndpoints(this IEndpointRouteBuilder endpoints)
 22  ✔  37         {
 23  ✔  37             var group = endpoints.MapGroup("/openai");
 24  ✔  37             var apiPrefix = typeof(OpenAIEndpointsExtensions).Assembly.GetName().Name!.Split('.')[0];
 25  ✔  37             MapOpenAIRoutes(group, apiPrefix);
 26  ✔  37             return group;
 27  ✔  37         }
 28            
 29                private static void MapOpenAIRoutes(IEndpointRouteBuilder group, string apiPrefix)
 30  ✔  37         {
 31                    // Chat Completions
 32  ✔  37             group.MapPost("/v1/chat/completions", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
 33  ✔   6             {
 34  ✔  37                 // 1. Parse Request
 35  ✔   6                 var request = await OpenAIRequestParser.ParseAsync(context, ct);
 36  ✔   6                 if (request == null) return Results.BadRequest("Invalid request body");
 37  ✔  37     
 38  ✔  37                 // 2. Map Messages
 39  ✔   4                 var messages = OpenAIRequestMapper.ToChatMessages(request);
 40  ✔  37     
 41  ✔  37                 // 3. Handle Streaming
 42  ✔   4                 if (request.Stream)
 43  ✔   2                 {
 44  ✔   2                     context.Response.Headers.ContentType = "text/event-stream";
 45  ✔   2                     context.Response.Headers.CacheControl = "no-cache";
 46  ✔   2                     context.Response.Headers.Connection = "keep-alive";
 47  ✔  37     
 48  ✔   2                     var id = "chatcmpl-" + Guid.NewGuid().ToString("N");
 49  ✔   2                     var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 50  ✔  37     
 51  ✔   2                     var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
 52  ✔  37     
 53  ✔  14                     await foreach (var update in stream)
 54  ✔   4                     {
 55  ✔   4                         var content = update.Text;
 56  ✔  37     
 57  ✔   5                         if (string.IsNullOrEmpty(content)) continue;
 58  ✔  37     
 59  ✔   3                         var chunk = new ChatCompletionChunk
 60  ✔   3                         {
 61  ✔   3                             Id = id,
 62  ✔   3                             Object = "chat.completion.chunk",
 63  ✔   3                             Created = created,
 64  ✔   3                             Model = request.Model ?? "default",
 65  ✔   3                             Choices = new List<ChatCompletionChunkChoice>
 66  ✔   3                             {
 67  ✔   3                                 new ChatCompletionChunkChoice
 68  ✔   3                                 {
 69  ✔   3                                     Index = 0,
 70  ✔   3                                     Delta = new ChatCompletionChunkDelta { Content = content },
 71  ✔   3                                     FinishReason = null
 72  ✔   3                                 }
 73  ✔   3                             }
 74  ✔   3                         };
 75  ✔   3                         await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk)}\n\n", ct);
 76  ✔   3                         await context.Response.Body.FlushAsync(ct);
 77  ✔   3                     }
 78  ✔  37     
 79  ✔   1                     var finalChunk = new ChatCompletionChunk
 80  ✔   1                     {
 81  ✔   1                         Id = id,
 82  ✔   1                         Object = "chat.completion.chunk",
 83  ✔   1                         Created = created,
 84  ✔   1                         Model = request.Model ?? "default",
 85  ✔   1                         Choices = new List<ChatCompletionChunkChoice>
 86  ✔   1                         {
 87  ✔   1                             new ChatCompletionChunkChoice
 88  ✔   1                             {
 89  ✔   1                                 Index = 0,
 90  ✔   1                                 Delta = new ChatCompletionChunkDelta(),
 91  ✔   1                                 FinishReason = "stop"
 92  ✔   1                             }
 93  ✔   1                         }
 94  ✔   1                     };
 95  ✔   1                     await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk)}\n\n", ct);
 96  ✔   1                     await context.Response.WriteAsync("data: [DONE]\n\n", ct);
 97  ✔  37     
 98  ✔   1                     return Results.Empty;
 99  ✔  37                 }
100  ✔  37                 else
101  ✔   2                 {
102  ✔  37                     // 4. Handle Non-Streaming
103  ✔   2                     var response = await mediator.Send(new ChatCommand(request, messages), ct);
104  ✔  37     
105  ✔   2                     var message = response.Messages.FirstOrDefault();
106  ✔   2                     var content = message?.Text ?? "";
107  ✔   2                     var role = message?.Role.Value ?? "assistant";
108  ✔  37     
109  ✔   2                     var openAIResponse = new ChatCompletionResponse
110  ✔   2                     {
111  ✔   2                         Id = "chatcmpl-" + Guid.NewGuid().ToString("N"),
112  ✔   2                         Object = "chat.completion",
113  ✔   2                         Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
114  ✔   2                         Model = request.Model ?? "default",
115  ✔   2                         Choices = new List<ChatCompletionChoice>
116  ✔   2                         {
117  ✔   2                             new ChatCompletionChoice
118  ✔   2                             {
119  ✔   2                                 Index = 0,
120  ✔   2                                 Message = new ChatCompletionMessageDto
121  ✔   2                                 {
122  ✔   2                                     Role = role,
123  ✔   2                                     Content = content,
124  ✔   2                                 },
125  ✔   2                                 FinishReason = "stop"
126  ✔   2                             }
127  ✔   2                         },
128  ✔   2                         Usage = new ChatCompletionUsage
129  ✔   2                         {
130  ✔   2                             PromptTokens = 0,
131  ✔   2                             CompletionTokens = 0,
132  ✔   2                             TotalTokens = 0
133  ✔   2                         }
134  ✔   2                     };
135  ✔  37     
136  ✔   2                     return Results.Json(openAIResponse);
137  ✔  37                 }
138  ✔  37             })
139  ✔  37             .WithTags("Chat")
140  ✔  37             .AddOpenApiOperationTransformer((operation, context, ct) =>
141  ❌  0             {
142  ❌  0                 operation.Summary = "Chat Completions";
143  ❌  0                 operation.Description = "OpenAI-compatible chat completions endpoint.";
144  ❌  0                 operation.OperationId = $"{apiPrefix}/CreateChatCompletion";
145  ❌  0                 return Task.CompletedTask;
146  ❌  0             })
147  ✔  37             .WithName("ChatCompletions");
148            
149            // Responses
150  ✔  37             group.MapPost("/v1/responses", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
151  ✔   9             {
152  ✔   9                 var request = await OpenAIRequestParser.ParseAsync(context, ct);
153  ✔   9                 if (request == null) return Results.BadRequest("Invalid request body");
154  ✔  37     
155  ✔   9                 var messages = OpenAIRequestMapper.ToChatMessages(request);
156  ✔  37     
157  ✔   9                 if (request.Stream)
158  ✔   1                 {
159  ✔   1                     context.Response.Headers.ContentType = "text/event-stream";
160  ✔   1                     context.Response.Headers.CacheControl = "no-cache";
161  ✔   1                     context.Response.Headers.Connection = "keep-alive";
162  ✔  37     
163  ✔   1                     var id = "resp_" + Guid.NewGuid().ToString("N");
164  ✔   1                     var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
165  ✔  37     
166  ✔   1                     var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
167  ✔  37     
168  ✔  11                     await foreach (var update in stream)
169  ✔   4                     {
170  ✔   4                         var content = update.Text;
171  ✔  37     
172  ✔   5                         if (string.IsNullOrEmpty(content)) continue;
173  ✔  37     
174  ✔   3                         var chunk = new ResponseStreamChunk
175  ✔   3                         {
176  ✔   3                             Id = id,
177  ✔   3                             Object = "response.output_item.delta",
178  ✔   3                             Created = created,
179  ✔   3                             Model = request.Model ?? "default",
180  ✔   3                             Delta = new ResponseDelta { Content = content }
181  ✔   3                         };
182  ✔   3                         await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk, ModelJsonContext.Options)
183  ✔   3                         await context.Response.Body.FlushAsync(ct);
184  ✔   3                     }
185  ✔  37     
186  ✔   1                     var finalChunk = new ResponseStreamChunk
187  ✔   1                     {
188  ✔   1                         Id = id,
189  ✔   1                         Object = "response.completed",
190  ✔   1                         Created = created,
191  ✔   1                         Model = request.Model ?? "default",
192  ✔   1                         Delta = new ResponseDelta()
193  ✔   1                     };
194  ✔   1                     await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk, ModelJsonContext.Options
195  ✔   1                     await context.Response.WriteAsync("data: [DONE]\n\n", ct);
196  ✔  37     
197  ✔   1                     return Results.Empty;
198  ✔  37                 }
199  ✔  37                 else
200  ✔   8                 {
201  ✔   8                     var response = await mediator.Send(new ChatCommand(request, messages), ct);
202  ✔  37     
203  ✔   8                     var message = response.Messages.FirstOrDefault();
204  ✔   8                     var content = message?.Text ?? "";
205  ✔  37     
206  ✔   8                     var openAIResponse = new ResponseCompletion
207  ✔   8                     {
208  ✔   8                         Id = "resp_" + Guid.NewGuid().ToString("N"),
209  ✔   8                         Object = "response",
210  ✔   8                         Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
211  ✔   8                         Model = request.Model ?? "default",
212  ✔   8                         Output = new List<ResponseOutput>
213  ✔   8                         {
214  ✔   8                             new ResponseOutput
215  ✔   8                             {
216  ✔   8                                 Type = "message",
217  ✔   8                                 Role = "assistant",
218  ✔   8                                 Content = new List<ResponseContent>
219  ✔   8                                 {
220  ✔   8                                     new ResponseContent
221  ✔   8                                     {
222  ✔   8                                         Type = "output_text",
223  ✔   8                                         Text = content
224  ✔   8                                     }
225  ✔   8                                 }
226  ✔   8                             }
227  ✔   8                         }
228  ✔   8                     };
229  ✔  37     
230  ✔   8                     return Results.Json(openAIResponse, ModelJsonContext.Options);
231  ✔  37                 }
232  ✔  37             })
233  ✔  37             .WithTags("Responses")
234  ✔  37             .WithSummary("Create response")
235  ✔  37             .WithDescription("OpenAI-compatible responses endpoint supporting both streaming and non-streaming modes");
236            
237            // Legacy & Models
238  ✔  37             group.MapLegacyCompletions();
239  ✔  37             group.MapModels();
240  ✔  50         }
241            }
242            
243            public class ResponseStreamChunk
244            {
245                public string Id { get; set; } = "";
246                public string Object { get; set; } = "";
247                public long Created { get; set; }
248                public string Model { get; set; } = "";
249                public ResponseDelta Delta { get; set; } = new();
250            }
251            
252            public class ResponseDelta
253            {
254                public string Content { get; set; } = "";
255            }
256            
257            public class ResponseCompletion
258            {
259                public string Id { get; set; } = "";
260                public string Object { get; set; } = "";
261                public long Created { get; set; }
262                public string Model { get; set; } = "";
263                public List<ResponseOutput> Output { get; set; } = new();
264            }
265            
266            public class ResponseOutput
267            {
268                public string Type { get; set; } = "";
269                public string Role { get; set; } = "";
270                public List<ResponseContent> Content { get; set; } = new();
271            }
272            
273            public class ResponseContent
274            {
275                public string Type { get; set; } = "";
276                public string Text { get; set; } = "";
277            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ProviderSummaryDto

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ProviderSummaryDto |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 173 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_Enabled()** | 100% | 1 | 1 | 100% |
| **get_Tier()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/ModelsEndpoint.cs
```
  1              using Microsoft.AspNetCore.Builder;
  2              using Microsoft.AspNetCore.Http;
  3              using Microsoft.AspNetCore.Routing;
  4              using Microsoft.Extensions.Options;
  5              using Synaxis.InferenceGateway.Application.Configuration;
  6              using System;
  7              using System.Collections.Generic;
  8              using System.Linq;
  9              
 10              namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 11              
 12              public static class ModelsEndpoint
 13              {
 14                  public static void MapModels(this IEndpointRouteBuilder app)
 15                  {
 16                      app.MapGet("/v1/models", (IOptions<SynaxisConfiguration> config) =>
 17                      {
 18                          var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 19                          var models = new List<ModelDto>();
 20              
 21                          foreach (var cm in config.Value.CanonicalModels)
 22                          {
 23                              var providerConfig = config.Value.Providers.GetValueOrDefault(cm.Provider);
 24                              models.Add(new ModelDto
 25                              {
 26                                  Id = cm.Id,
 27                                  Object = "model",
 28                                  Created = now,
 29                                  OwnedBy = cm.Provider,
 30                                  Provider = cm.Provider,
 31                                  ModelPath = cm.ModelPath,
 32                                  Capabilities = new ModelCapabilitiesDto
 33                                  {
 34                                      Streaming = cm.Streaming,
 35                                      Tools = cm.Tools,
 36                                      Vision = cm.Vision,
 37                                      StructuredOutput = cm.StructuredOutput,
 38                                      LogProbs = cm.LogProbs
 39                                  }
 40                              });
 41                          }
 42              
 43                          foreach (var alias in config.Value.Aliases)
 44                          {
 45                              models.Add(new ModelDto
 46                              {
 47                                  Id = alias.Key,
 48                                  Object = "model",
 49                                  Created = now,
 50                                  OwnedBy = "synaxis",
 51                                  Provider = "synaxis",
 52                                  ModelPath = alias.Key,
 53                                  Capabilities = new ModelCapabilitiesDto()
 54                              });
 55                          }
 56              
 57                          var response = new ModelsListResponseDto
 58                          {
 59                              Object = "list",
 60                              Data = models,
 61                              Providers = config.Value.Providers.Select(p => new ProviderSummaryDto
 62                              {
 63                                  Id = p.Key,
 64                                  Type = p.Value.Type,
 65                                  Enabled = p.Value.Enabled,
 66                                  Tier = p.Value.Tier
 67                              }).ToList()
 68                          };
 69              
 70                          return Results.Json(response, ModelJsonContext.Options);
 71                      })
 72                      .WithTags("Models")
 73                      .WithSummary("List models with capabilities and provider information")
 74                      .WithDescription("Returns all available models grouped by provider with their capabilities (streaming, tools, vi
 75              
 76                      app.MapGet("/v1/models/{**id}", (string id, IOptions<SynaxisConfiguration> config) =>
 77                      {
 78                          var cm = config.Value.CanonicalModels.FirstOrDefault(x => x.Id == id);
 79                          if (cm != null)
 80                          {
 81              return Results.Json(new ModelDto
 82                          {
 83                              Id = cm.Id,
 84                              Object = "model",
 85                              Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
 86                              OwnedBy = cm.Provider,
 87                              Provider = cm.Provider,
 88                              ModelPath = cm.ModelPath,
 89                              Capabilities = new ModelCapabilitiesDto
 90                              {
 91                                  Streaming = cm.Streaming,
 92                                  Tools = cm.Tools,
 93                                  Vision = cm.Vision,
 94                                  StructuredOutput = cm.StructuredOutput,
 95                                  LogProbs = cm.LogProbs
 96                              }
 97                          }, ModelJsonContext.Options);
 98                          }
 99              
100                          if (config.Value.Aliases.ContainsKey(id))
101                          {
102                              return Results.Json(new ModelDto
103                              {
104                                  Id = id,
105                                  Object = "model",
106                                  Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
107                                  OwnedBy = "synaxis",
108                                  Provider = "synaxis",
109                                  ModelPath = id,
110                                  Capabilities = new ModelCapabilitiesDto()
111                              }, ModelJsonContext.Options);
112                          }
113              
114                          return Results.Json(new
115                          {
116                              error = new
117                              {
118                                  message = $"The model '{id}' does not exist",
119                                  type = "invalid_request_error",
120                                  param = "model",
121                                  code = "model_not_found"
122                              }
123                          }, ModelJsonContext.Options, statusCode: 404);
124                      })
125                      .WithTags("Models")
126                      .WithSummary("Retrieve model with capabilities")
127                      .WithDescription("Returns detailed information about a specific model including its capabilities");
128                  }
129              }
130              
131              public class ModelDto
132              {
133                  public string Id { get; set; } = "";
134                  public string Object { get; set; } = "";
135                  public long Created { get; set; }
136                  public string OwnedBy { get; set; } = "";
137                  public string Provider { get; set; } = "";
138                  public string ModelPath { get; set; } = "";
139                  public ModelCapabilitiesDto Capabilities { get; set; } = new();
140              }
141              
142              public class ModelCapabilitiesDto
143              {
144                  public bool Streaming { get; set; }
145                  public bool Tools { get; set; }
146                  public bool Vision { get; set; }
147                  public bool StructuredOutput { get; set; }
148                  public bool LogProbs { get; set; }
149              }
150              
151              public class ModelsListResponseDto
152              {
153                  public string Object { get; set; } = "";
154                  public List<ModelDto> Data { get; set; } = new();
155                  public List<ProviderSummaryDto> Providers { get; set; } = new();
156              }
157              
158              public class ProviderSummaryDto
159              {
160  ✔  1032         public string Id { get; set; } = "";
161  ✔  1032         public string Type { get; set; } = "";
162  ✔   688         public bool Enabled { get; set; }
163  ✔   688         public int Tier { get; set; }
164              }
165              
166              public static class ModelJsonContext
167              {
168                  public static readonly System.Text.Json.JsonSerializerOptions Options = new()
169                  {
170                      PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.SnakeCaseLower,
171                      PropertyNameCaseInsensitive = true
172                  };
173              }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseCompletion

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseCompletion |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs |
| **Line coverage:** | 100% (5 of 5) |
| Covered lines: | 5 |
| Uncovered lines: | 0 |
| Coverable lines: | 5 |
| Total lines: | 277 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Object()** | 100% | 1 | 1 | 100% |
| **get_Created()** | 100% | 1 | 1 | 100% |
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_Output()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Routing;
  3            using Microsoft.Extensions.DependencyInjection;
  4            using Microsoft.AspNetCore.OpenApi;
  5            using Microsoft.Agents.AI.Hosting.OpenAI;
  6            using Synaxis.InferenceGateway.WebApi.Agents;
  7            using Synaxis.InferenceGateway.WebApi.Helpers;
  8            using System;
  9            using System.Threading.Tasks;
 10            using System.Text.Json;
 11            using System.Linq;
 12            using Microsoft.AspNetCore.Http;
 13            using Mediator;
 14            using Synaxis.InferenceGateway.WebApi.Features.Chat.Commands;
 15            using Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
 16            
 17            namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 18            
 19            public static class OpenAIEndpointsExtensions
 20            {
 21                public static IEndpointRouteBuilder MapOpenAIEndpoints(this IEndpointRouteBuilder endpoints)
 22                {
 23                    var group = endpoints.MapGroup("/openai");
 24                    var apiPrefix = typeof(OpenAIEndpointsExtensions).Assembly.GetName().Name!.Split('.')[0];
 25                    MapOpenAIRoutes(group, apiPrefix);
 26                    return group;
 27                }
 28            
 29                private static void MapOpenAIRoutes(IEndpointRouteBuilder group, string apiPrefix)
 30                {
 31                    // Chat Completions
 32                    group.MapPost("/v1/chat/completions", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
 33                    {
 34                        // 1. Parse Request
 35                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
 36                        if (request == null) return Results.BadRequest("Invalid request body");
 37            
 38                        // 2. Map Messages
 39                        var messages = OpenAIRequestMapper.ToChatMessages(request);
 40            
 41                        // 3. Handle Streaming
 42                        if (request.Stream)
 43                        {
 44                            context.Response.Headers.ContentType = "text/event-stream";
 45                            context.Response.Headers.CacheControl = "no-cache";
 46                            context.Response.Headers.Connection = "keep-alive";
 47            
 48                            var id = "chatcmpl-" + Guid.NewGuid().ToString("N");
 49                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 50            
 51                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
 52            
 53                            await foreach (var update in stream)
 54                            {
 55                                var content = update.Text;
 56            
 57                                if (string.IsNullOrEmpty(content)) continue;
 58            
 59                                var chunk = new ChatCompletionChunk
 60                                {
 61                                    Id = id,
 62                                    Object = "chat.completion.chunk",
 63                                    Created = created,
 64                                    Model = request.Model ?? "default",
 65                                    Choices = new List<ChatCompletionChunkChoice>
 66                                    {
 67                                        new ChatCompletionChunkChoice
 68                                        {
 69                                            Index = 0,
 70                                            Delta = new ChatCompletionChunkDelta { Content = content },
 71                                            FinishReason = null
 72                                        }
 73                                    }
 74                                };
 75                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk)}\n\n", ct);
 76                                await context.Response.Body.FlushAsync(ct);
 77                            }
 78            
 79                            var finalChunk = new ChatCompletionChunk
 80                            {
 81                                Id = id,
 82                                Object = "chat.completion.chunk",
 83                                Created = created,
 84                                Model = request.Model ?? "default",
 85                                Choices = new List<ChatCompletionChunkChoice>
 86                                {
 87                                    new ChatCompletionChunkChoice
 88                                    {
 89                                        Index = 0,
 90                                        Delta = new ChatCompletionChunkDelta(),
 91                                        FinishReason = "stop"
 92                                    }
 93                                }
 94                            };
 95                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk)}\n\n", ct);
 96                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
 97            
 98                            return Results.Empty;
 99                        }
100                        else
101                        {
102                            // 4. Handle Non-Streaming
103                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
104            
105                            var message = response.Messages.FirstOrDefault();
106                            var content = message?.Text ?? "";
107                            var role = message?.Role.Value ?? "assistant";
108            
109                            var openAIResponse = new ChatCompletionResponse
110                            {
111                                Id = "chatcmpl-" + Guid.NewGuid().ToString("N"),
112                                Object = "chat.completion",
113                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
114                                Model = request.Model ?? "default",
115                                Choices = new List<ChatCompletionChoice>
116                                {
117                                    new ChatCompletionChoice
118                                    {
119                                        Index = 0,
120                                        Message = new ChatCompletionMessageDto
121                                        {
122                                            Role = role,
123                                            Content = content,
124                                        },
125                                        FinishReason = "stop"
126                                    }
127                                },
128                                Usage = new ChatCompletionUsage
129                                {
130                                    PromptTokens = 0,
131                                    CompletionTokens = 0,
132                                    TotalTokens = 0
133                                }
134                            };
135            
136                            return Results.Json(openAIResponse);
137                        }
138                    })
139                    .WithTags("Chat")
140                    .AddOpenApiOperationTransformer((operation, context, ct) =>
141                    {
142                        operation.Summary = "Chat Completions";
143                        operation.Description = "OpenAI-compatible chat completions endpoint.";
144                        operation.OperationId = $"{apiPrefix}/CreateChatCompletion";
145                        return Task.CompletedTask;
146                    })
147                    .WithName("ChatCompletions");
148            
149            // Responses
150                    group.MapPost("/v1/responses", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
151                    {
152                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
153                        if (request == null) return Results.BadRequest("Invalid request body");
154            
155                        var messages = OpenAIRequestMapper.ToChatMessages(request);
156            
157                        if (request.Stream)
158                        {
159                            context.Response.Headers.ContentType = "text/event-stream";
160                            context.Response.Headers.CacheControl = "no-cache";
161                            context.Response.Headers.Connection = "keep-alive";
162            
163                            var id = "resp_" + Guid.NewGuid().ToString("N");
164                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
165            
166                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
167            
168                            await foreach (var update in stream)
169                            {
170                                var content = update.Text;
171            
172                                if (string.IsNullOrEmpty(content)) continue;
173            
174                                var chunk = new ResponseStreamChunk
175                                {
176                                    Id = id,
177                                    Object = "response.output_item.delta",
178                                    Created = created,
179                                    Model = request.Model ?? "default",
180                                    Delta = new ResponseDelta { Content = content }
181                                };
182                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk, ModelJsonContext.Options)
183                                await context.Response.Body.FlushAsync(ct);
184                            }
185            
186                            var finalChunk = new ResponseStreamChunk
187                            {
188                                Id = id,
189                                Object = "response.completed",
190                                Created = created,
191                                Model = request.Model ?? "default",
192                                Delta = new ResponseDelta()
193                            };
194                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk, ModelJsonContext.Options
195                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
196            
197                            return Results.Empty;
198                        }
199                        else
200                        {
201                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
202            
203                            var message = response.Messages.FirstOrDefault();
204                            var content = message?.Text ?? "";
205            
206                            var openAIResponse = new ResponseCompletion
207                            {
208                                Id = "resp_" + Guid.NewGuid().ToString("N"),
209                                Object = "response",
210                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
211                                Model = request.Model ?? "default",
212                                Output = new List<ResponseOutput>
213                                {
214                                    new ResponseOutput
215                                    {
216                                        Type = "message",
217                                        Role = "assistant",
218                                        Content = new List<ResponseContent>
219                                        {
220                                            new ResponseContent
221                                            {
222                                                Type = "output_text",
223                                                Text = content
224                                            }
225                                        }
226                                    }
227                                }
228                            };
229            
230                            return Results.Json(openAIResponse, ModelJsonContext.Options);
231                        }
232                    })
233                    .WithTags("Responses")
234                    .WithSummary("Create response")
235                    .WithDescription("OpenAI-compatible responses endpoint supporting both streaming and non-streaming modes");
236            
237            // Legacy & Models
238                    group.MapLegacyCompletions();
239                    group.MapModels();
240                }
241            }
242            
243            public class ResponseStreamChunk
244            {
245                public string Id { get; set; } = "";
246                public string Object { get; set; } = "";
247                public long Created { get; set; }
248                public string Model { get; set; } = "";
249                public ResponseDelta Delta { get; set; } = new();
250            }
251            
252            public class ResponseDelta
253            {
254                public string Content { get; set; } = "";
255            }
256            
257            public class ResponseCompletion
258            {
259  ✔  24         public string Id { get; set; } = "";
260  ✔  24         public string Object { get; set; } = "";
261  ✔  16         public long Created { get; set; }
262  ✔  24         public string Model { get; set; } = "";
263  ✔  24         public List<ResponseOutput> Output { get; set; } = new();
264            }
265            
266            public class ResponseOutput
267            {
268                public string Type { get; set; } = "";
269                public string Role { get; set; } = "";
270                public List<ResponseContent> Content { get; set; } = new();
271            }
272            
273            public class ResponseContent
274            {
275                public string Type { get; set; } = "";
276                public string Text { get; set; } = "";
277            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseContent

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseContent |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs |
| **Line coverage:** | 100% (2 of 2) |
| Covered lines: | 2 |
| Uncovered lines: | 0 |
| Coverable lines: | 2 |
| Total lines: | 277 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_Text()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Routing;
  3            using Microsoft.Extensions.DependencyInjection;
  4            using Microsoft.AspNetCore.OpenApi;
  5            using Microsoft.Agents.AI.Hosting.OpenAI;
  6            using Synaxis.InferenceGateway.WebApi.Agents;
  7            using Synaxis.InferenceGateway.WebApi.Helpers;
  8            using System;
  9            using System.Threading.Tasks;
 10            using System.Text.Json;
 11            using System.Linq;
 12            using Microsoft.AspNetCore.Http;
 13            using Mediator;
 14            using Synaxis.InferenceGateway.WebApi.Features.Chat.Commands;
 15            using Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
 16            
 17            namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 18            
 19            public static class OpenAIEndpointsExtensions
 20            {
 21                public static IEndpointRouteBuilder MapOpenAIEndpoints(this IEndpointRouteBuilder endpoints)
 22                {
 23                    var group = endpoints.MapGroup("/openai");
 24                    var apiPrefix = typeof(OpenAIEndpointsExtensions).Assembly.GetName().Name!.Split('.')[0];
 25                    MapOpenAIRoutes(group, apiPrefix);
 26                    return group;
 27                }
 28            
 29                private static void MapOpenAIRoutes(IEndpointRouteBuilder group, string apiPrefix)
 30                {
 31                    // Chat Completions
 32                    group.MapPost("/v1/chat/completions", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
 33                    {
 34                        // 1. Parse Request
 35                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
 36                        if (request == null) return Results.BadRequest("Invalid request body");
 37            
 38                        // 2. Map Messages
 39                        var messages = OpenAIRequestMapper.ToChatMessages(request);
 40            
 41                        // 3. Handle Streaming
 42                        if (request.Stream)
 43                        {
 44                            context.Response.Headers.ContentType = "text/event-stream";
 45                            context.Response.Headers.CacheControl = "no-cache";
 46                            context.Response.Headers.Connection = "keep-alive";
 47            
 48                            var id = "chatcmpl-" + Guid.NewGuid().ToString("N");
 49                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 50            
 51                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
 52            
 53                            await foreach (var update in stream)
 54                            {
 55                                var content = update.Text;
 56            
 57                                if (string.IsNullOrEmpty(content)) continue;
 58            
 59                                var chunk = new ChatCompletionChunk
 60                                {
 61                                    Id = id,
 62                                    Object = "chat.completion.chunk",
 63                                    Created = created,
 64                                    Model = request.Model ?? "default",
 65                                    Choices = new List<ChatCompletionChunkChoice>
 66                                    {
 67                                        new ChatCompletionChunkChoice
 68                                        {
 69                                            Index = 0,
 70                                            Delta = new ChatCompletionChunkDelta { Content = content },
 71                                            FinishReason = null
 72                                        }
 73                                    }
 74                                };
 75                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk)}\n\n", ct);
 76                                await context.Response.Body.FlushAsync(ct);
 77                            }
 78            
 79                            var finalChunk = new ChatCompletionChunk
 80                            {
 81                                Id = id,
 82                                Object = "chat.completion.chunk",
 83                                Created = created,
 84                                Model = request.Model ?? "default",
 85                                Choices = new List<ChatCompletionChunkChoice>
 86                                {
 87                                    new ChatCompletionChunkChoice
 88                                    {
 89                                        Index = 0,
 90                                        Delta = new ChatCompletionChunkDelta(),
 91                                        FinishReason = "stop"
 92                                    }
 93                                }
 94                            };
 95                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk)}\n\n", ct);
 96                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
 97            
 98                            return Results.Empty;
 99                        }
100                        else
101                        {
102                            // 4. Handle Non-Streaming
103                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
104            
105                            var message = response.Messages.FirstOrDefault();
106                            var content = message?.Text ?? "";
107                            var role = message?.Role.Value ?? "assistant";
108            
109                            var openAIResponse = new ChatCompletionResponse
110                            {
111                                Id = "chatcmpl-" + Guid.NewGuid().ToString("N"),
112                                Object = "chat.completion",
113                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
114                                Model = request.Model ?? "default",
115                                Choices = new List<ChatCompletionChoice>
116                                {
117                                    new ChatCompletionChoice
118                                    {
119                                        Index = 0,
120                                        Message = new ChatCompletionMessageDto
121                                        {
122                                            Role = role,
123                                            Content = content,
124                                        },
125                                        FinishReason = "stop"
126                                    }
127                                },
128                                Usage = new ChatCompletionUsage
129                                {
130                                    PromptTokens = 0,
131                                    CompletionTokens = 0,
132                                    TotalTokens = 0
133                                }
134                            };
135            
136                            return Results.Json(openAIResponse);
137                        }
138                    })
139                    .WithTags("Chat")
140                    .AddOpenApiOperationTransformer((operation, context, ct) =>
141                    {
142                        operation.Summary = "Chat Completions";
143                        operation.Description = "OpenAI-compatible chat completions endpoint.";
144                        operation.OperationId = $"{apiPrefix}/CreateChatCompletion";
145                        return Task.CompletedTask;
146                    })
147                    .WithName("ChatCompletions");
148            
149            // Responses
150                    group.MapPost("/v1/responses", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
151                    {
152                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
153                        if (request == null) return Results.BadRequest("Invalid request body");
154            
155                        var messages = OpenAIRequestMapper.ToChatMessages(request);
156            
157                        if (request.Stream)
158                        {
159                            context.Response.Headers.ContentType = "text/event-stream";
160                            context.Response.Headers.CacheControl = "no-cache";
161                            context.Response.Headers.Connection = "keep-alive";
162            
163                            var id = "resp_" + Guid.NewGuid().ToString("N");
164                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
165            
166                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
167            
168                            await foreach (var update in stream)
169                            {
170                                var content = update.Text;
171            
172                                if (string.IsNullOrEmpty(content)) continue;
173            
174                                var chunk = new ResponseStreamChunk
175                                {
176                                    Id = id,
177                                    Object = "response.output_item.delta",
178                                    Created = created,
179                                    Model = request.Model ?? "default",
180                                    Delta = new ResponseDelta { Content = content }
181                                };
182                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk, ModelJsonContext.Options)
183                                await context.Response.Body.FlushAsync(ct);
184                            }
185            
186                            var finalChunk = new ResponseStreamChunk
187                            {
188                                Id = id,
189                                Object = "response.completed",
190                                Created = created,
191                                Model = request.Model ?? "default",
192                                Delta = new ResponseDelta()
193                            };
194                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk, ModelJsonContext.Options
195                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
196            
197                            return Results.Empty;
198                        }
199                        else
200                        {
201                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
202            
203                            var message = response.Messages.FirstOrDefault();
204                            var content = message?.Text ?? "";
205            
206                            var openAIResponse = new ResponseCompletion
207                            {
208                                Id = "resp_" + Guid.NewGuid().ToString("N"),
209                                Object = "response",
210                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
211                                Model = request.Model ?? "default",
212                                Output = new List<ResponseOutput>
213                                {
214                                    new ResponseOutput
215                                    {
216                                        Type = "message",
217                                        Role = "assistant",
218                                        Content = new List<ResponseContent>
219                                        {
220                                            new ResponseContent
221                                            {
222                                                Type = "output_text",
223                                                Text = content
224                                            }
225                                        }
226                                    }
227                                }
228                            };
229            
230                            return Results.Json(openAIResponse, ModelJsonContext.Options);
231                        }
232                    })
233                    .WithTags("Responses")
234                    .WithSummary("Create response")
235                    .WithDescription("OpenAI-compatible responses endpoint supporting both streaming and non-streaming modes");
236            
237            // Legacy & Models
238                    group.MapLegacyCompletions();
239                    group.MapModels();
240                }
241            }
242            
243            public class ResponseStreamChunk
244            {
245                public string Id { get; set; } = "";
246                public string Object { get; set; } = "";
247                public long Created { get; set; }
248                public string Model { get; set; } = "";
249                public ResponseDelta Delta { get; set; } = new();
250            }
251            
252            public class ResponseDelta
253            {
254                public string Content { get; set; } = "";
255            }
256            
257            public class ResponseCompletion
258            {
259                public string Id { get; set; } = "";
260                public string Object { get; set; } = "";
261                public long Created { get; set; }
262                public string Model { get; set; } = "";
263                public List<ResponseOutput> Output { get; set; } = new();
264            }
265            
266            public class ResponseOutput
267            {
268                public string Type { get; set; } = "";
269                public string Role { get; set; } = "";
270                public List<ResponseContent> Content { get; set; } = new();
271            }
272            
273            public class ResponseContent
274            {
275  ✔  24         public string Type { get; set; } = "";
276  ✔  24         public string Text { get; set; } = "";
277            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseDelta

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseDelta |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 277 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Content()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Routing;
  3            using Microsoft.Extensions.DependencyInjection;
  4            using Microsoft.AspNetCore.OpenApi;
  5            using Microsoft.Agents.AI.Hosting.OpenAI;
  6            using Synaxis.InferenceGateway.WebApi.Agents;
  7            using Synaxis.InferenceGateway.WebApi.Helpers;
  8            using System;
  9            using System.Threading.Tasks;
 10            using System.Text.Json;
 11            using System.Linq;
 12            using Microsoft.AspNetCore.Http;
 13            using Mediator;
 14            using Synaxis.InferenceGateway.WebApi.Features.Chat.Commands;
 15            using Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
 16            
 17            namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 18            
 19            public static class OpenAIEndpointsExtensions
 20            {
 21                public static IEndpointRouteBuilder MapOpenAIEndpoints(this IEndpointRouteBuilder endpoints)
 22                {
 23                    var group = endpoints.MapGroup("/openai");
 24                    var apiPrefix = typeof(OpenAIEndpointsExtensions).Assembly.GetName().Name!.Split('.')[0];
 25                    MapOpenAIRoutes(group, apiPrefix);
 26                    return group;
 27                }
 28            
 29                private static void MapOpenAIRoutes(IEndpointRouteBuilder group, string apiPrefix)
 30                {
 31                    // Chat Completions
 32                    group.MapPost("/v1/chat/completions", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
 33                    {
 34                        // 1. Parse Request
 35                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
 36                        if (request == null) return Results.BadRequest("Invalid request body");
 37            
 38                        // 2. Map Messages
 39                        var messages = OpenAIRequestMapper.ToChatMessages(request);
 40            
 41                        // 3. Handle Streaming
 42                        if (request.Stream)
 43                        {
 44                            context.Response.Headers.ContentType = "text/event-stream";
 45                            context.Response.Headers.CacheControl = "no-cache";
 46                            context.Response.Headers.Connection = "keep-alive";
 47            
 48                            var id = "chatcmpl-" + Guid.NewGuid().ToString("N");
 49                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 50            
 51                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
 52            
 53                            await foreach (var update in stream)
 54                            {
 55                                var content = update.Text;
 56            
 57                                if (string.IsNullOrEmpty(content)) continue;
 58            
 59                                var chunk = new ChatCompletionChunk
 60                                {
 61                                    Id = id,
 62                                    Object = "chat.completion.chunk",
 63                                    Created = created,
 64                                    Model = request.Model ?? "default",
 65                                    Choices = new List<ChatCompletionChunkChoice>
 66                                    {
 67                                        new ChatCompletionChunkChoice
 68                                        {
 69                                            Index = 0,
 70                                            Delta = new ChatCompletionChunkDelta { Content = content },
 71                                            FinishReason = null
 72                                        }
 73                                    }
 74                                };
 75                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk)}\n\n", ct);
 76                                await context.Response.Body.FlushAsync(ct);
 77                            }
 78            
 79                            var finalChunk = new ChatCompletionChunk
 80                            {
 81                                Id = id,
 82                                Object = "chat.completion.chunk",
 83                                Created = created,
 84                                Model = request.Model ?? "default",
 85                                Choices = new List<ChatCompletionChunkChoice>
 86                                {
 87                                    new ChatCompletionChunkChoice
 88                                    {
 89                                        Index = 0,
 90                                        Delta = new ChatCompletionChunkDelta(),
 91                                        FinishReason = "stop"
 92                                    }
 93                                }
 94                            };
 95                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk)}\n\n", ct);
 96                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
 97            
 98                            return Results.Empty;
 99                        }
100                        else
101                        {
102                            // 4. Handle Non-Streaming
103                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
104            
105                            var message = response.Messages.FirstOrDefault();
106                            var content = message?.Text ?? "";
107                            var role = message?.Role.Value ?? "assistant";
108            
109                            var openAIResponse = new ChatCompletionResponse
110                            {
111                                Id = "chatcmpl-" + Guid.NewGuid().ToString("N"),
112                                Object = "chat.completion",
113                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
114                                Model = request.Model ?? "default",
115                                Choices = new List<ChatCompletionChoice>
116                                {
117                                    new ChatCompletionChoice
118                                    {
119                                        Index = 0,
120                                        Message = new ChatCompletionMessageDto
121                                        {
122                                            Role = role,
123                                            Content = content,
124                                        },
125                                        FinishReason = "stop"
126                                    }
127                                },
128                                Usage = new ChatCompletionUsage
129                                {
130                                    PromptTokens = 0,
131                                    CompletionTokens = 0,
132                                    TotalTokens = 0
133                                }
134                            };
135            
136                            return Results.Json(openAIResponse);
137                        }
138                    })
139                    .WithTags("Chat")
140                    .AddOpenApiOperationTransformer((operation, context, ct) =>
141                    {
142                        operation.Summary = "Chat Completions";
143                        operation.Description = "OpenAI-compatible chat completions endpoint.";
144                        operation.OperationId = $"{apiPrefix}/CreateChatCompletion";
145                        return Task.CompletedTask;
146                    })
147                    .WithName("ChatCompletions");
148            
149            // Responses
150                    group.MapPost("/v1/responses", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
151                    {
152                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
153                        if (request == null) return Results.BadRequest("Invalid request body");
154            
155                        var messages = OpenAIRequestMapper.ToChatMessages(request);
156            
157                        if (request.Stream)
158                        {
159                            context.Response.Headers.ContentType = "text/event-stream";
160                            context.Response.Headers.CacheControl = "no-cache";
161                            context.Response.Headers.Connection = "keep-alive";
162            
163                            var id = "resp_" + Guid.NewGuid().ToString("N");
164                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
165            
166                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
167            
168                            await foreach (var update in stream)
169                            {
170                                var content = update.Text;
171            
172                                if (string.IsNullOrEmpty(content)) continue;
173            
174                                var chunk = new ResponseStreamChunk
175                                {
176                                    Id = id,
177                                    Object = "response.output_item.delta",
178                                    Created = created,
179                                    Model = request.Model ?? "default",
180                                    Delta = new ResponseDelta { Content = content }
181                                };
182                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk, ModelJsonContext.Options)
183                                await context.Response.Body.FlushAsync(ct);
184                            }
185            
186                            var finalChunk = new ResponseStreamChunk
187                            {
188                                Id = id,
189                                Object = "response.completed",
190                                Created = created,
191                                Model = request.Model ?? "default",
192                                Delta = new ResponseDelta()
193                            };
194                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk, ModelJsonContext.Options
195                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
196            
197                            return Results.Empty;
198                        }
199                        else
200                        {
201                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
202            
203                            var message = response.Messages.FirstOrDefault();
204                            var content = message?.Text ?? "";
205            
206                            var openAIResponse = new ResponseCompletion
207                            {
208                                Id = "resp_" + Guid.NewGuid().ToString("N"),
209                                Object = "response",
210                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
211                                Model = request.Model ?? "default",
212                                Output = new List<ResponseOutput>
213                                {
214                                    new ResponseOutput
215                                    {
216                                        Type = "message",
217                                        Role = "assistant",
218                                        Content = new List<ResponseContent>
219                                        {
220                                            new ResponseContent
221                                            {
222                                                Type = "output_text",
223                                                Text = content
224                                            }
225                                        }
226                                    }
227                                }
228                            };
229            
230                            return Results.Json(openAIResponse, ModelJsonContext.Options);
231                        }
232                    })
233                    .WithTags("Responses")
234                    .WithSummary("Create response")
235                    .WithDescription("OpenAI-compatible responses endpoint supporting both streaming and non-streaming modes");
236            
237            // Legacy & Models
238                    group.MapLegacyCompletions();
239                    group.MapModels();
240                }
241            }
242            
243            public class ResponseStreamChunk
244            {
245                public string Id { get; set; } = "";
246                public string Object { get; set; } = "";
247                public long Created { get; set; }
248                public string Model { get; set; } = "";
249                public ResponseDelta Delta { get; set; } = new();
250            }
251            
252            public class ResponseDelta
253            {
254  ✔  15         public string Content { get; set; } = "";
255            }
256            
257            public class ResponseCompletion
258            {
259                public string Id { get; set; } = "";
260                public string Object { get; set; } = "";
261                public long Created { get; set; }
262                public string Model { get; set; } = "";
263                public List<ResponseOutput> Output { get; set; } = new();
264            }
265            
266            public class ResponseOutput
267            {
268                public string Type { get; set; } = "";
269                public string Role { get; set; } = "";
270                public List<ResponseContent> Content { get; set; } = new();
271            }
272            
273            public class ResponseContent
274            {
275                public string Type { get; set; } = "";
276                public string Text { get; set; } = "";
277            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseOutput

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseOutput |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 277 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_Role()** | 100% | 1 | 1 | 100% |
| **get_Content()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Routing;
  3            using Microsoft.Extensions.DependencyInjection;
  4            using Microsoft.AspNetCore.OpenApi;
  5            using Microsoft.Agents.AI.Hosting.OpenAI;
  6            using Synaxis.InferenceGateway.WebApi.Agents;
  7            using Synaxis.InferenceGateway.WebApi.Helpers;
  8            using System;
  9            using System.Threading.Tasks;
 10            using System.Text.Json;
 11            using System.Linq;
 12            using Microsoft.AspNetCore.Http;
 13            using Mediator;
 14            using Synaxis.InferenceGateway.WebApi.Features.Chat.Commands;
 15            using Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
 16            
 17            namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 18            
 19            public static class OpenAIEndpointsExtensions
 20            {
 21                public static IEndpointRouteBuilder MapOpenAIEndpoints(this IEndpointRouteBuilder endpoints)
 22                {
 23                    var group = endpoints.MapGroup("/openai");
 24                    var apiPrefix = typeof(OpenAIEndpointsExtensions).Assembly.GetName().Name!.Split('.')[0];
 25                    MapOpenAIRoutes(group, apiPrefix);
 26                    return group;
 27                }
 28            
 29                private static void MapOpenAIRoutes(IEndpointRouteBuilder group, string apiPrefix)
 30                {
 31                    // Chat Completions
 32                    group.MapPost("/v1/chat/completions", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
 33                    {
 34                        // 1. Parse Request
 35                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
 36                        if (request == null) return Results.BadRequest("Invalid request body");
 37            
 38                        // 2. Map Messages
 39                        var messages = OpenAIRequestMapper.ToChatMessages(request);
 40            
 41                        // 3. Handle Streaming
 42                        if (request.Stream)
 43                        {
 44                            context.Response.Headers.ContentType = "text/event-stream";
 45                            context.Response.Headers.CacheControl = "no-cache";
 46                            context.Response.Headers.Connection = "keep-alive";
 47            
 48                            var id = "chatcmpl-" + Guid.NewGuid().ToString("N");
 49                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 50            
 51                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
 52            
 53                            await foreach (var update in stream)
 54                            {
 55                                var content = update.Text;
 56            
 57                                if (string.IsNullOrEmpty(content)) continue;
 58            
 59                                var chunk = new ChatCompletionChunk
 60                                {
 61                                    Id = id,
 62                                    Object = "chat.completion.chunk",
 63                                    Created = created,
 64                                    Model = request.Model ?? "default",
 65                                    Choices = new List<ChatCompletionChunkChoice>
 66                                    {
 67                                        new ChatCompletionChunkChoice
 68                                        {
 69                                            Index = 0,
 70                                            Delta = new ChatCompletionChunkDelta { Content = content },
 71                                            FinishReason = null
 72                                        }
 73                                    }
 74                                };
 75                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk)}\n\n", ct);
 76                                await context.Response.Body.FlushAsync(ct);
 77                            }
 78            
 79                            var finalChunk = new ChatCompletionChunk
 80                            {
 81                                Id = id,
 82                                Object = "chat.completion.chunk",
 83                                Created = created,
 84                                Model = request.Model ?? "default",
 85                                Choices = new List<ChatCompletionChunkChoice>
 86                                {
 87                                    new ChatCompletionChunkChoice
 88                                    {
 89                                        Index = 0,
 90                                        Delta = new ChatCompletionChunkDelta(),
 91                                        FinishReason = "stop"
 92                                    }
 93                                }
 94                            };
 95                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk)}\n\n", ct);
 96                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
 97            
 98                            return Results.Empty;
 99                        }
100                        else
101                        {
102                            // 4. Handle Non-Streaming
103                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
104            
105                            var message = response.Messages.FirstOrDefault();
106                            var content = message?.Text ?? "";
107                            var role = message?.Role.Value ?? "assistant";
108            
109                            var openAIResponse = new ChatCompletionResponse
110                            {
111                                Id = "chatcmpl-" + Guid.NewGuid().ToString("N"),
112                                Object = "chat.completion",
113                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
114                                Model = request.Model ?? "default",
115                                Choices = new List<ChatCompletionChoice>
116                                {
117                                    new ChatCompletionChoice
118                                    {
119                                        Index = 0,
120                                        Message = new ChatCompletionMessageDto
121                                        {
122                                            Role = role,
123                                            Content = content,
124                                        },
125                                        FinishReason = "stop"
126                                    }
127                                },
128                                Usage = new ChatCompletionUsage
129                                {
130                                    PromptTokens = 0,
131                                    CompletionTokens = 0,
132                                    TotalTokens = 0
133                                }
134                            };
135            
136                            return Results.Json(openAIResponse);
137                        }
138                    })
139                    .WithTags("Chat")
140                    .AddOpenApiOperationTransformer((operation, context, ct) =>
141                    {
142                        operation.Summary = "Chat Completions";
143                        operation.Description = "OpenAI-compatible chat completions endpoint.";
144                        operation.OperationId = $"{apiPrefix}/CreateChatCompletion";
145                        return Task.CompletedTask;
146                    })
147                    .WithName("ChatCompletions");
148            
149            // Responses
150                    group.MapPost("/v1/responses", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
151                    {
152                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
153                        if (request == null) return Results.BadRequest("Invalid request body");
154            
155                        var messages = OpenAIRequestMapper.ToChatMessages(request);
156            
157                        if (request.Stream)
158                        {
159                            context.Response.Headers.ContentType = "text/event-stream";
160                            context.Response.Headers.CacheControl = "no-cache";
161                            context.Response.Headers.Connection = "keep-alive";
162            
163                            var id = "resp_" + Guid.NewGuid().ToString("N");
164                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
165            
166                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
167            
168                            await foreach (var update in stream)
169                            {
170                                var content = update.Text;
171            
172                                if (string.IsNullOrEmpty(content)) continue;
173            
174                                var chunk = new ResponseStreamChunk
175                                {
176                                    Id = id,
177                                    Object = "response.output_item.delta",
178                                    Created = created,
179                                    Model = request.Model ?? "default",
180                                    Delta = new ResponseDelta { Content = content }
181                                };
182                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk, ModelJsonContext.Options)
183                                await context.Response.Body.FlushAsync(ct);
184                            }
185            
186                            var finalChunk = new ResponseStreamChunk
187                            {
188                                Id = id,
189                                Object = "response.completed",
190                                Created = created,
191                                Model = request.Model ?? "default",
192                                Delta = new ResponseDelta()
193                            };
194                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk, ModelJsonContext.Options
195                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
196            
197                            return Results.Empty;
198                        }
199                        else
200                        {
201                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
202            
203                            var message = response.Messages.FirstOrDefault();
204                            var content = message?.Text ?? "";
205            
206                            var openAIResponse = new ResponseCompletion
207                            {
208                                Id = "resp_" + Guid.NewGuid().ToString("N"),
209                                Object = "response",
210                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
211                                Model = request.Model ?? "default",
212                                Output = new List<ResponseOutput>
213                                {
214                                    new ResponseOutput
215                                    {
216                                        Type = "message",
217                                        Role = "assistant",
218                                        Content = new List<ResponseContent>
219                                        {
220                                            new ResponseContent
221                                            {
222                                                Type = "output_text",
223                                                Text = content
224                                            }
225                                        }
226                                    }
227                                }
228                            };
229            
230                            return Results.Json(openAIResponse, ModelJsonContext.Options);
231                        }
232                    })
233                    .WithTags("Responses")
234                    .WithSummary("Create response")
235                    .WithDescription("OpenAI-compatible responses endpoint supporting both streaming and non-streaming modes");
236            
237            // Legacy & Models
238                    group.MapLegacyCompletions();
239                    group.MapModels();
240                }
241            }
242            
243            public class ResponseStreamChunk
244            {
245                public string Id { get; set; } = "";
246                public string Object { get; set; } = "";
247                public long Created { get; set; }
248                public string Model { get; set; } = "";
249                public ResponseDelta Delta { get; set; } = new();
250            }
251            
252            public class ResponseDelta
253            {
254                public string Content { get; set; } = "";
255            }
256            
257            public class ResponseCompletion
258            {
259                public string Id { get; set; } = "";
260                public string Object { get; set; } = "";
261                public long Created { get; set; }
262                public string Model { get; set; } = "";
263                public List<ResponseOutput> Output { get; set; } = new();
264            }
265            
266            public class ResponseOutput
267            {
268  ✔  24         public string Type { get; set; } = "";
269  ✔  24         public string Role { get; set; } = "";
270  ✔  24         public List<ResponseContent> Content { get; set; } = new();
271            }
272            
273            public class ResponseContent
274            {
275                public string Type { get; set; } = "";
276                public string Text { get; set; } = "";
277            }
```
# Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseStreamChunk

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI.ResponseStreamChunk |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs |
| **Line coverage:** | 100% (5 of 5) |
| Covered lines: | 5 |
| Uncovered lines: | 0 |
| Coverable lines: | 5 |
| Total lines: | 277 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Object()** | 100% | 1 | 1 | 100% |
| **get_Created()** | 100% | 1 | 1 | 100% |
| **get_Model()** | 100% | 1 | 1 | 100% |
| **get_Delta()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Endpoints/OpenAI/OpenAIEndpointsExtensions.cs
```
  1            using Microsoft.AspNetCore.Builder;
  2            using Microsoft.AspNetCore.Routing;
  3            using Microsoft.Extensions.DependencyInjection;
  4            using Microsoft.AspNetCore.OpenApi;
  5            using Microsoft.Agents.AI.Hosting.OpenAI;
  6            using Synaxis.InferenceGateway.WebApi.Agents;
  7            using Synaxis.InferenceGateway.WebApi.Helpers;
  8            using System;
  9            using System.Threading.Tasks;
 10            using System.Text.Json;
 11            using System.Linq;
 12            using Microsoft.AspNetCore.Http;
 13            using Mediator;
 14            using Synaxis.InferenceGateway.WebApi.Features.Chat.Commands;
 15            using Synaxis.InferenceGateway.WebApi.DTOs.OpenAi;
 16            
 17            namespace Synaxis.InferenceGateway.WebApi.Endpoints.OpenAI;
 18            
 19            public static class OpenAIEndpointsExtensions
 20            {
 21                public static IEndpointRouteBuilder MapOpenAIEndpoints(this IEndpointRouteBuilder endpoints)
 22                {
 23                    var group = endpoints.MapGroup("/openai");
 24                    var apiPrefix = typeof(OpenAIEndpointsExtensions).Assembly.GetName().Name!.Split('.')[0];
 25                    MapOpenAIRoutes(group, apiPrefix);
 26                    return group;
 27                }
 28            
 29                private static void MapOpenAIRoutes(IEndpointRouteBuilder group, string apiPrefix)
 30                {
 31                    // Chat Completions
 32                    group.MapPost("/v1/chat/completions", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
 33                    {
 34                        // 1. Parse Request
 35                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
 36                        if (request == null) return Results.BadRequest("Invalid request body");
 37            
 38                        // 2. Map Messages
 39                        var messages = OpenAIRequestMapper.ToChatMessages(request);
 40            
 41                        // 3. Handle Streaming
 42                        if (request.Stream)
 43                        {
 44                            context.Response.Headers.ContentType = "text/event-stream";
 45                            context.Response.Headers.CacheControl = "no-cache";
 46                            context.Response.Headers.Connection = "keep-alive";
 47            
 48                            var id = "chatcmpl-" + Guid.NewGuid().ToString("N");
 49                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
 50            
 51                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
 52            
 53                            await foreach (var update in stream)
 54                            {
 55                                var content = update.Text;
 56            
 57                                if (string.IsNullOrEmpty(content)) continue;
 58            
 59                                var chunk = new ChatCompletionChunk
 60                                {
 61                                    Id = id,
 62                                    Object = "chat.completion.chunk",
 63                                    Created = created,
 64                                    Model = request.Model ?? "default",
 65                                    Choices = new List<ChatCompletionChunkChoice>
 66                                    {
 67                                        new ChatCompletionChunkChoice
 68                                        {
 69                                            Index = 0,
 70                                            Delta = new ChatCompletionChunkDelta { Content = content },
 71                                            FinishReason = null
 72                                        }
 73                                    }
 74                                };
 75                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk)}\n\n", ct);
 76                                await context.Response.Body.FlushAsync(ct);
 77                            }
 78            
 79                            var finalChunk = new ChatCompletionChunk
 80                            {
 81                                Id = id,
 82                                Object = "chat.completion.chunk",
 83                                Created = created,
 84                                Model = request.Model ?? "default",
 85                                Choices = new List<ChatCompletionChunkChoice>
 86                                {
 87                                    new ChatCompletionChunkChoice
 88                                    {
 89                                        Index = 0,
 90                                        Delta = new ChatCompletionChunkDelta(),
 91                                        FinishReason = "stop"
 92                                    }
 93                                }
 94                            };
 95                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk)}\n\n", ct);
 96                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
 97            
 98                            return Results.Empty;
 99                        }
100                        else
101                        {
102                            // 4. Handle Non-Streaming
103                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
104            
105                            var message = response.Messages.FirstOrDefault();
106                            var content = message?.Text ?? "";
107                            var role = message?.Role.Value ?? "assistant";
108            
109                            var openAIResponse = new ChatCompletionResponse
110                            {
111                                Id = "chatcmpl-" + Guid.NewGuid().ToString("N"),
112                                Object = "chat.completion",
113                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
114                                Model = request.Model ?? "default",
115                                Choices = new List<ChatCompletionChoice>
116                                {
117                                    new ChatCompletionChoice
118                                    {
119                                        Index = 0,
120                                        Message = new ChatCompletionMessageDto
121                                        {
122                                            Role = role,
123                                            Content = content,
124                                        },
125                                        FinishReason = "stop"
126                                    }
127                                },
128                                Usage = new ChatCompletionUsage
129                                {
130                                    PromptTokens = 0,
131                                    CompletionTokens = 0,
132                                    TotalTokens = 0
133                                }
134                            };
135            
136                            return Results.Json(openAIResponse);
137                        }
138                    })
139                    .WithTags("Chat")
140                    .AddOpenApiOperationTransformer((operation, context, ct) =>
141                    {
142                        operation.Summary = "Chat Completions";
143                        operation.Description = "OpenAI-compatible chat completions endpoint.";
144                        operation.OperationId = $"{apiPrefix}/CreateChatCompletion";
145                        return Task.CompletedTask;
146                    })
147                    .WithName("ChatCompletions");
148            
149            // Responses
150                    group.MapPost("/v1/responses", async (HttpContext context, IMediator mediator, CancellationToken ct) =>
151                    {
152                        var request = await OpenAIRequestParser.ParseAsync(context, ct);
153                        if (request == null) return Results.BadRequest("Invalid request body");
154            
155                        var messages = OpenAIRequestMapper.ToChatMessages(request);
156            
157                        if (request.Stream)
158                        {
159                            context.Response.Headers.ContentType = "text/event-stream";
160                            context.Response.Headers.CacheControl = "no-cache";
161                            context.Response.Headers.Connection = "keep-alive";
162            
163                            var id = "resp_" + Guid.NewGuid().ToString("N");
164                            var created = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
165            
166                            var stream = mediator.CreateStream(new ChatStreamCommand(request, messages), ct);
167            
168                            await foreach (var update in stream)
169                            {
170                                var content = update.Text;
171            
172                                if (string.IsNullOrEmpty(content)) continue;
173            
174                                var chunk = new ResponseStreamChunk
175                                {
176                                    Id = id,
177                                    Object = "response.output_item.delta",
178                                    Created = created,
179                                    Model = request.Model ?? "default",
180                                    Delta = new ResponseDelta { Content = content }
181                                };
182                                await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(chunk, ModelJsonContext.Options)
183                                await context.Response.Body.FlushAsync(ct);
184                            }
185            
186                            var finalChunk = new ResponseStreamChunk
187                            {
188                                Id = id,
189                                Object = "response.completed",
190                                Created = created,
191                                Model = request.Model ?? "default",
192                                Delta = new ResponseDelta()
193                            };
194                            await context.Response.WriteAsync($"data: {JsonSerializer.Serialize(finalChunk, ModelJsonContext.Options
195                            await context.Response.WriteAsync("data: [DONE]\n\n", ct);
196            
197                            return Results.Empty;
198                        }
199                        else
200                        {
201                            var response = await mediator.Send(new ChatCommand(request, messages), ct);
202            
203                            var message = response.Messages.FirstOrDefault();
204                            var content = message?.Text ?? "";
205            
206                            var openAIResponse = new ResponseCompletion
207                            {
208                                Id = "resp_" + Guid.NewGuid().ToString("N"),
209                                Object = "response",
210                                Created = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
211                                Model = request.Model ?? "default",
212                                Output = new List<ResponseOutput>
213                                {
214                                    new ResponseOutput
215                                    {
216                                        Type = "message",
217                                        Role = "assistant",
218                                        Content = new List<ResponseContent>
219                                        {
220                                            new ResponseContent
221                                            {
222                                                Type = "output_text",
223                                                Text = content
224                                            }
225                                        }
226                                    }
227                                }
228                            };
229            
230                            return Results.Json(openAIResponse, ModelJsonContext.Options);
231                        }
232                    })
233                    .WithTags("Responses")
234                    .WithSummary("Create response")
235                    .WithDescription("OpenAI-compatible responses endpoint supporting both streaming and non-streaming modes");
236            
237            // Legacy & Models
238                    group.MapLegacyCompletions();
239                    group.MapModels();
240                }
241            }
242            
243            public class ResponseStreamChunk
244            {
245  ✔  12         public string Id { get; set; } = "";
246  ✔  12         public string Object { get; set; } = "";
247  ✔   8         public long Created { get; set; }
248  ✔  12         public string Model { get; set; } = "";
249  ✔  12         public ResponseDelta Delta { get; set; } = new();
250            }
251            
252            public class ResponseDelta
253            {
254                public string Content { get; set; } = "";
255            }
256            
257            public class ResponseCompletion
258            {
259                public string Id { get; set; } = "";
260                public string Object { get; set; } = "";
261                public long Created { get; set; }
262                public string Model { get; set; } = "";
263                public List<ResponseOutput> Output { get; set; } = new();
264            }
265            
266            public class ResponseOutput
267            {
268                public string Type { get; set; } = "";
269                public string Role { get; set; } = "";
270                public List<ResponseContent> Content { get; set; } = new();
271            }
272            
273            public class ResponseContent
274            {
275                public string Type { get; set; } = "";
276                public string Text { get; set; } = "";
277            }
```
# Synaxis.InferenceGateway.WebApi.Features.Chat.Commands.ChatCommand

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Features.Chat.Commands.ChatCommand |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Features/Chat/Commands/ChatCommands.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 15 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Request()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Features/Chat/Commands/ChatCommands.cs
```
 1            using Mediator;
 2            using Microsoft.Extensions.AI;
 3            using Synaxis.InferenceGateway.Application.Translation;
 4            using System.Collections.Generic;
 5            using Microsoft.Agents.AI;
 6            
 7            namespace Synaxis.InferenceGateway.WebApi.Features.Chat.Commands;
 8            
 9            // Command for non-streaming chat completion
10  ✔  20     public record ChatCommand(OpenAIRequest Request, IEnumerable<ChatMessage> Messages)
11                : IRequest<Microsoft.Agents.AI.AgentResponse>;
12            
13            // Command for streaming chat completion
14            public record ChatStreamCommand(OpenAIRequest Request, IEnumerable<ChatMessage> Messages)
15                : IStreamRequest<Microsoft.Agents.AI.AgentResponseUpdate>;
```
# Synaxis.InferenceGateway.WebApi.Features.Chat.Commands.ChatStreamCommand

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Features.Chat.Commands.ChatStreamCommand |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Features/Chat/Commands/ChatCommands.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 15 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Request()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Features/Chat/Commands/ChatCommands.cs
```
 1           using Mediator;
 2           using Microsoft.Extensions.AI;
 3           using Synaxis.InferenceGateway.Application.Translation;
 4           using System.Collections.Generic;
 5           using Microsoft.Agents.AI;
 6           
 7           namespace Synaxis.InferenceGateway.WebApi.Features.Chat.Commands;
 8           
 9           // Command for non-streaming chat completion
10           public record ChatCommand(OpenAIRequest Request, IEnumerable<ChatMessage> Messages)
11               : IRequest<Microsoft.Agents.AI.AgentResponse>;
12           
13           // Command for streaming chat completion
14  ✔  6     public record ChatStreamCommand(OpenAIRequest Request, IEnumerable<ChatMessage> Messages)
15               : IStreamRequest<Microsoft.Agents.AI.AgentResponseUpdate>;
```
# Synaxis.InferenceGateway.WebApi.Features.Chat.Handlers.ChatCompletionHandler

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Features.Chat.Handlers.ChatCompletionHandler |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Features/Chat/Handlers/ChatCompletionHandler.cs |
| **Line coverage:** | 100% (10 of 10) |
| Covered lines: | 10 |
| Uncovered lines: | 0 |
| Coverable lines: | 10 |
| Total lines: | 31 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **Handle()** | 100% | 1 | 1 | 100% |
| **Handle(...)** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Features/Chat/Handlers/ChatCompletionHandler.cs
```
 1            using Mediator;
 2            using Microsoft.Agents.AI;
 3            using Synaxis.InferenceGateway.WebApi.Agents;
 4            using Synaxis.InferenceGateway.WebApi.Features.Chat.Commands;
 5            using System.Collections.Generic;
 6            using System.Threading;
 7            using System.Threading.Tasks;
 8            
 9            namespace Synaxis.InferenceGateway.WebApi.Features.Chat.Handlers;
10            
11            public class ChatCompletionHandler :
12                IRequestHandler<ChatCommand, Microsoft.Agents.AI.AgentResponse>,
13                IStreamRequestHandler<ChatStreamCommand, Microsoft.Agents.AI.AgentResponseUpdate>
14            {
15                private readonly RoutingAgent _agent;
16            
17  ✔  13         public ChatCompletionHandler(RoutingAgent agent)
18  ✔  13         {
19  ✔  13             _agent = agent;
20  ✔  13         }
21            
22                public async ValueTask<AgentResponse> Handle(ChatCommand request, CancellationToken cancellationToken)
23  ✔  10         {
24  ✔  10             return await _agent.RunAsync(request.Messages, cancellationToken: cancellationToken);
25  ✔  10         }
26            
27                public IAsyncEnumerable<AgentResponseUpdate> Handle(ChatStreamCommand request, CancellationToken cancellationToken)
28  ✔   3         {
29  ✔   3             return _agent.RunStreamingAsync(request.Messages, cancellationToken: cancellationToken);
30  ✔   3         }
31            }
```
# Synaxis.InferenceGateway.WebApi.Health.ConfigHealthCheck

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Health.ConfigHealthCheck |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Health/ConfigHealthCheck.cs |
| **Line coverage:** | 100% (25 of 25) |
| Covered lines: | 25 |
| Uncovered lines: | 0 |
| Coverable lines: | 25 |
| Total lines: | 44 |
| **Branch coverage:** | 92.8% (13 of 14) |
| Covered branches: | 13 |
| Total branches: | 14 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **CheckHealthAsync(...)** | 92.85% | 14 | 14 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Health/ConfigHealthCheck.cs
```
 1             using Microsoft.Extensions.Diagnostics.HealthChecks;
 2             using Microsoft.Extensions.Options;
 3             using Synaxis.InferenceGateway.Application.Configuration;
 4             
 5             namespace Synaxis.InferenceGateway.WebApi.Health;
 6             
 7             public class ConfigHealthCheck : IHealthCheck
 8             {
 9                 private readonly SynaxisConfiguration _config;
10             
11  ✔    5         public ConfigHealthCheck(IOptions<SynaxisConfiguration> config)
12  ✔    5         {
13  ✔    5             _config = config.Value;
14  ✔    5         }
15             
16                 public Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken = de
17  ✔    5         {
18  ✓    5  ◑          if (_config.Providers == null || _config.Providers.Count == 0)
19  ✔    1             {
20  ✔    1                 return Task.FromResult(HealthCheckResult.Unhealthy("No providers configured."));
21                     }
22             
23  ✔   97  ●          foreach (var model in _config.CanonicalModels)
24  ✔   43             {
25  ✔   43  ●              if (!_config.Providers.ContainsKey(model.Provider))
26  ✔    1                 {
27  ✔    1                     return Task.FromResult(HealthCheckResult.Unhealthy($"Canonical model '{model.Id}' references unknown pro
28                         }
29  ✔   42             }
30             
31  ✔   29  ●          foreach (var alias in _config.Aliases)
32  ✔   11             {
33  ✔   55  ●              foreach (var candidate in alias.Value.Candidates)
34  ✔   12                 {
35  ✔  192  ●                  if (!_config.CanonicalModels.Any(m => m.Id == candidate))
36  ✔    2                     {
37  ✔    2                         return Task.FromResult(HealthCheckResult.Unhealthy($"Alias '{alias.Key}' references unknown canonica
38                             }
39  ✔   10                 }
40  ✔    9             }
41             
42  ✔    1             return Task.FromResult(HealthCheckResult.Healthy("Configuration is consistent."));
43  ✔    5         }
44             }
```
# Synaxis.InferenceGateway.WebApi.Health.ProviderConnectivityHealthCheck

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Health.ProviderConnectivityHealthCheck |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Health/ProviderConnectivityHealthCheck.cs |
| **Line coverage:** | 97.9% (94 of 96) |
| Covered lines: | 94 |
| Uncovered lines: | 2 |
| Coverable lines: | 96 |
| Total lines: | 140 |
| **Branch coverage:** | 85.2% (75 of 88) |
| Covered branches: | 75 |
| Total branches: | 88 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **CheckHealthAsync()** | 87.50% | 24 | 24 | 100% |
| **CheckConnectivityAsync()** | 71.42% | 14 | 14 | 100% |
| **GetDefaultEndpoint(...)** | 89.58% | 55 | 48 | 85.71% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Health/ProviderConnectivityHealthCheck.cs
```
  1            using System.Net;
  2            using System.Net.Sockets;
  3            using System.Net.Security;
  4            using Microsoft.Extensions.Diagnostics.HealthChecks;
  5            using Microsoft.Extensions.Options;
  6            using Synaxis.InferenceGateway.Application.Configuration;
  7            
  8            namespace Synaxis.InferenceGateway.WebApi.Health;
  9            
 10            public class ProviderConnectivityHealthCheck : IHealthCheck
 11            {
 12                private readonly SynaxisConfiguration _config;
 13                private readonly ILogger<ProviderConnectivityHealthCheck> _logger;
 14            
 15  ✔   4         public ProviderConnectivityHealthCheck(IOptions<SynaxisConfiguration> config, ILogger<ProviderConnectivityHealthChec
 16  ✔   4         {
 17  ✔   4             _config = config.Value;
 18  ✔   4             _logger = logger;
 19  ✔   4         }
 20            
 21                public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToke
 22  ✔   4         {
 23  ✔   4             var failures = new List<string>();
 24            
 25  ✔  56  ●          foreach (var entry in _config.Providers)
 26  ✔  22             {
 27  ✔  22                 var name = entry.Key;
 28  ✔  22                 var provider = entry.Value;
 29            
 30  ✔  24  ●              if (!provider.Enabled) continue;
 31            
 32  ✔  20                 var endpoints = new List<string>();
 33  ✔  27  ●              if (!string.IsNullOrWhiteSpace(provider.Endpoint)) endpoints.Add(provider.Endpoint);
 34  ✓  20  ◑              if (!string.IsNullOrWhiteSpace(provider.FallbackEndpoint)) endpoints.Add(provider.FallbackEndpoint);
 35            
 36  ✔  20  ●              if (endpoints.Count == 0)
 37  ✔  13                 {
 38  ✔  13                     var defaultEndpoint = GetDefaultEndpoint(provider.Type);
 39  ✔  13  ●                  if (!string.IsNullOrWhiteSpace(defaultEndpoint))
 40  ✔   8                     {
 41  ✔   8                         endpoints.Add(defaultEndpoint);
 42  ✔   8                     }
 43  ✔  13                 }
 44            
 45  ✔  20  ●              if (endpoints.Count == 0)
 46  ✔   5                 {
 47  ✔   5                     _logger.LogWarning("Provider {Provider} is enabled but has no endpoint and no default for type {Type}.",
 48  ✔   5                     _logger.LogError("Provider {Provider} health check failed due to missing endpoint.", name);
 49  ✔   5                     failures.Add($"{name}: Missing endpoint");
 50  ✔   5                     continue;
 51                        }
 52            
 53  ✔  15                 Exception? lastError = null;
 54  ✔  15                 var reachable = false;
 55            
 56  ✔  63  ●              foreach (var endpoint in endpoints)
 57  ✔  15                 {
 58                            try
 59  ✔  15                     {
 60  ✔  15                         await CheckConnectivityAsync(name, endpoint, cancellationToken);
 61  ✔  12                         reachable = true;
 62  ✔  12                         break;
 63                            }
 64  ✔   3                     catch (Exception ex)
 65  ✔   3                     {
 66  ✔   3                         lastError = ex;
 67  ✔   3                         _logger.LogWarning(ex, "Provider {Provider} connectivity check failed.", name);
 68  ✔   3                         _logger.LogError(ex, "Connectivity check failed for provider {Provider} at {Endpoint}", name, endpoi
 69  ✔   3                     }
 70  ✔   3                 }
 71            
 72  ✔  15  ●              if (!reachable)
 73  ✔   3                 {
 74  ✓   3  ◑                  failures.Add($"{name}: {lastError?.Message ?? "Connectivity check failed"}");
 75  ✔   3                 }
 76  ✔  15             }
 77            
 78  ✔   4  ●          if (failures.Count > 0)
 79  ✔   2             {
 80  ✔   2                 return HealthCheckResult.Unhealthy($"Provider connectivity failures: {string.Join(", ", failures)}");
 81                    }
 82            
 83  ✔   2             return HealthCheckResult.Healthy("All enabled providers are reachable.");
 84  ✔   4         }
 85            
 86                private async Task CheckConnectivityAsync(string name, string endpoint, CancellationToken ct)
 87  ✔  15         {
 88  ✓  15  ◑          var normalized = endpoint.StartsWith("http://", StringComparison.OrdinalIgnoreCase) || endpoint.StartsWith("http
 89  ✔  15                 ? endpoint
 90  ✔  15                 : $"https://{endpoint}";
 91  ✔  15             var uri = new Uri(normalized);
 92  ✔  15             var host = uri.Host;
 93  ✓  15  ○          var port = uri.Port > 0 ? uri.Port : (uri.Scheme == "https" ? 443 : 80);
 94            
 95                    // 1. DNS (500ms)
 96  ✔  15  ●          using var dnsCts = CancellationTokenSource.CreateLinkedTokenSource(ct);
 97  ✔  15             dnsCts.CancelAfter(TimeSpan.FromMilliseconds(500));
 98  ✔  15             var addresses = await Dns.GetHostAddressesAsync(host, dnsCts.Token);
 99  ✓  30  ◑          var ip = addresses.First(a => a.AddressFamily == AddressFamily.InterNetwork || a.AddressFamily == AddressFamily.
100            
101                    // 2. TCP (800ms)
102  ✔  15  ●          using var tcpClient = new TcpClient();
103  ✔  15             using var tcpCts = CancellationTokenSource.CreateLinkedTokenSource(ct);
104  ✔  15             tcpCts.CancelAfter(TimeSpan.FromMilliseconds(800));
105  ✔  15             await tcpClient.ConnectAsync(ip, port, tcpCts.Token);
106            
107                    // 3. TLS (1200ms) - only if https
108  ✔  15  ●          if (uri.Scheme == "https")
109  ✔  14             {
110  ✔  14                 using var tlsCts = CancellationTokenSource.CreateLinkedTokenSource(ct);
111  ✔  14                 tlsCts.CancelAfter(TimeSpan.FromMilliseconds(1200));
112  ✔  14                 using var sslStream = new SslStream(tcpClient.GetStream(), false);
113  ✔  14                 await sslStream.AuthenticateAsClientAsync(new SslClientAuthenticationOptions { TargetHost = host }, tlsCts.T
114  ✔  14             }
115            
116                    // 4. HTTP HEAD (500ms)
117  ✔  15             using var httpCts = CancellationTokenSource.CreateLinkedTokenSource(ct);
118  ✔  15             httpCts.CancelAfter(TimeSpan.FromMilliseconds(500));
119  ✔  15             using var httpClient = new HttpClient { Timeout = TimeSpan.FromMilliseconds(500) };
120  ✔  15             var request = new HttpRequestMessage(HttpMethod.Head, uri);
121  ✔  15             var response = await httpClient.SendAsync(request, httpCts.Token);
122                    // We don't strictly require 200 OK, just that the server responded.
123                    // Many APIs return 401/404 on HEAD without tokens, which is fine for connectivity.
124  ✔  12         }
125            
126  ✓  13  ◕      private string? GetDefaultEndpoint(string type) => type?.ToLowerInvariant() switch
127  ✔  13         {
128  ❌  0             "openai" => "https://api.openai.com/v1",
129  ✔   1             "groq" => "https://api.groq.com/openai/v1",
130  ✔   1             "cohere" => "https://api.cohere.ai/v1",
131  ✔   1             "cloudflare" => "https://api.cloudflare.com/client/v4",
132  ✔   1             "gemini" => "https://generativelanguage.googleapis.com",
133  ❌  0             "antigravity" => "https://cloudcode-pa.googleapis.com",
134  ✔   1             "openrouter" => "https://openrouter.ai/api/v1",
135  ✔   1             "nvidia" => "https://integrate.api.nvidia.com/v1",
136  ✔   1             "huggingface" => "https://router.huggingface.co",
137  ✔   1             "pollinations" => "https://pollinations.ai",
138  ✔   5             _ => null
139  ✔  13         };
140            }
```
# Synaxis.InferenceGateway.WebApi.Helpers.OpenAIRequestMapper

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Helpers.OpenAIRequestMapper |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Helpers/OpenAIRequestMapper.cs |
| **Line coverage:** | 97.8% (93 of 95) |
| Covered lines: | 93 |
| Uncovered lines: | 2 |
| Coverable lines: | 95 |
| Total lines: | 133 |
| **Branch coverage:** | 94.8% (55 of 58) |
| Covered branches: | 55 |
| Total branches: | 58 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **ToCanonicalRequest(...)** | 100% | 6 | 6 | 100% |
| **ToChatMessages(...)** | 100% | 30 | 30 | 100% |
| **MapTools(...)** | 80.0% | 10 | 10 | 93.75% |
| **MapStopSequences(...)** | 91.66% | 12 | 12 | 95.00% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Helpers/OpenAIRequestMapper.cs
```
  1             using Microsoft.Extensions.AI;
  2             using Synaxis.InferenceGateway.Application.Translation;
  3             using Synaxis.InferenceGateway.Application.Routing;
  4             using System.Text.Json;
  5             using System.Collections.Generic;
  6             
  7             namespace Synaxis.InferenceGateway.WebApi.Helpers;
  8             
  9             public static class OpenAIRequestMapper
 10             {
 11                 public static CanonicalRequest ToCanonicalRequest(OpenAIRequest openAIRequest, IEnumerable<ChatMessage> messages)
 12  ✔   25         {
 13  ✔   25  ●          var modelId = !string.IsNullOrWhiteSpace(openAIRequest.Model) ? openAIRequest.Model : "default";
 14             
 15  ✔   25  ●          return new CanonicalRequest(
 16  ✔   25                 EndpointKind.ChatCompletions,
 17  ✔   25                 modelId,
 18  ✔   25                 messages.ToList(),
 19  ✔   25                 Tools: MapTools(openAIRequest.Tools),
 20  ✔   25                 ToolChoice: openAIRequest.ToolChoice,
 21  ✔   25                 ResponseFormat: openAIRequest.ResponseFormat,
 22  ✔   25                 AdditionalOptions: new ChatOptions
 23  ✔   25                 {
 24  ✔   25                     Temperature = (float?)openAIRequest.Temperature,
 25  ✔   25                     TopP = (float?)openAIRequest.TopP,
 26  ✔   25                     MaxOutputTokens = openAIRequest.MaxTokens,
 27  ✔   25                     StopSequences = MapStopSequences(openAIRequest.Stop)
 28  ✔   25                 });
 29  ✔   24         }
 30             
 31                 public static IEnumerable<ChatMessage> ToChatMessages(OpenAIRequest request)
 32  ✔   30         {
 33  ✔   31  ●          if (request.Messages == null) return Enumerable.Empty<ChatMessage>();
 34             
 35  ✔   29             var messages = new List<ChatMessage>();
 36  ✔  145  ●          foreach (var msg in request.Messages)
 37  ✔   29             {
 38  ✔   29  ●              var role = msg.Role switch
 39  ✔   29                 {
 40  ✔    2                     "system" => ChatRole.System,
 41  ✔   16                     "user" => ChatRole.User,
 42  ✔    7                     "assistant" => ChatRole.Assistant,
 43  ✔    3                     "tool" => ChatRole.Tool,
 44  ✔    1                     _ => new ChatRole(msg.Role)
 45  ✔   29                 };
 46             
 47  ✔   29  ●              var content = msg.Content?.ToString() ?? "";
 48                         // Note: This is a simplification. Real OpenAI messages can have array content (multimodal).
 49                         // Assuming string for now as per current project usage patterns or we'd need deeper parsing.
 50             
 51  ✔   29                 var chatMessage = new ChatMessage(role, content);
 52  ✔   29  ●              if (!string.IsNullOrEmpty(msg.Name))
 53  ✔    1                 {
 54  ✔    1                     chatMessage.AuthorName = msg.Name;
 55  ✔    1                 }
 56             
 57                         // Map tool calls if present
 58  ✔   29  ●              if (msg.ToolCalls != null)
 59  ✔    5                 {
 60  ✔   25  ●                  foreach (var toolCall in msg.ToolCalls)
 61  ✔    5                     {
 62  ✔    5  ●                      if (toolCall.Function != null)
 63  ✔    4                         {
 64  ✔    4  ●                          chatMessage.Contents.Add(new FunctionCallContent(
 65  ✔    4                                 toolCall.Id,
 66  ✔    4                                 toolCall.Function.Name,
 67  ✔    4                                 string.IsNullOrEmpty(toolCall.Function.Arguments) ? null : JsonSerializer.Deserialize<IDicti
 68  ✔    4                             ));
 69  ✔    4                         }
 70  ✔    5                     }
 71  ✔    5                 }
 72             
 73                         // Map tool response (tool_call_id)
 74  ✔   29  ●              if (role == ChatRole.Tool && !string.IsNullOrEmpty(msg.ToolCallId))
 75  ✔    2                 {
 76                             // In Microsoft.Extensions.AI, tool responses are often handled by matching ID.
 77                             // We might need to store ToolCallId in metadata or as a property if ChatMessage supports it.
 78                             // ChatMessage doesn't have ToolCallId directly, but FunctionResultContent does.
 79                             // If role is Tool, content is usually the result.
 80  ✔    2                     chatMessage.Contents.Clear();
 81  ✔    2                     chatMessage.Contents.Add(new FunctionResultContent(msg.ToolCallId, content));
 82  ✔    2                 }
 83             
 84  ✔   29                 messages.Add(chatMessage);
 85  ✔   29             }
 86  ✔   29             return messages;
 87  ✔   30         }
 88             
 89                 private static IList<AITool>? MapTools(List<OpenAITool>? tools)
 90  ✔   24         {
 91  ✔   47  ●          if (tools == null) return null;
 92  ✔    1             var result = new List<AITool>();
 93  ✔    5  ●          foreach (var tool in tools)
 94  ✔    1             {
 95  ✓    1  ◑              if (tool.Type == "function" && tool.Function != null)
 96  ✔    1                 {
 97                             // We create a function definition using the AIFunctionFactory for metadata purposes.
 98                             // The actual execution delegate is a dummy since we are just routing.
 99  ✔    1                     var function = AIFunctionFactory.Create(
100  ❌   0                         (string args) => Task.CompletedTask,
101  ✔    1                         tool.Function.Name,
102  ✔    1                         tool.Function.Description);
103             
104  ✔    1                     result.Add(function);
105  ✔    1                 }
106  ✔    1             }
107  ✓    1  ◑          return result.Count > 0 ? result : null;
108  ✔   24         }
109             
110                 private static IList<string>? MapStopSequences(object? stop)
111  ✔   24         {
112  ✔   24  ●          if (stop is JsonElement element)
113  ✔    2             {
114  ✔    2  ●              if (element.ValueKind == JsonValueKind.String)
115  ✔    1                 {
116  ✔    1                     return new List<string> { element.GetString()! };
117                         }
118  ✓    1  ◑              else if (element.ValueKind == JsonValueKind.Array)
119  ✔    1                 {
120  ✔    1                     var list = new List<string>();
121  ✔    7  ●                  foreach (var item in element.EnumerateArray())
122  ✔    2                     {
123  ✔    2  ●                      if (item.ValueKind == JsonValueKind.String)
124  ✔    2                         {
125  ✔    2                             list.Add(item.GetString()!);
126  ✔    2                         }
127  ✔    2                     }
128  ✔    1                     return list;
129                         }
130  ❌   0             }
131  ✔   22             return null;
132  ✔   24         }
133             }
```
# Synaxis.InferenceGateway.WebApi.Helpers.OpenAIRequestParser

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Helpers.OpenAIRequestParser |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Helpers/OpenAIRequestParser.cs |
| **Line coverage:** | 61.2% (30 of 49) |
| Covered lines: | 30 |
| Uncovered lines: | 19 |
| Coverable lines: | 49 |
| Total lines: | 90 |
| **Branch coverage:** | 50% (10 of 20) |
| Covered branches: | 10 |
| Total branches: | 20 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **ParseAsync()** | 50.0% | 43 | 20 | 61.22% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Helpers/OpenAIRequestParser.cs
```
 1            using Microsoft.AspNetCore.Http;
 2            using Synaxis.InferenceGateway.Application.Translation;
 3            using System.Text;
 4            using System.Text.Json;
 5            
 6            namespace Synaxis.InferenceGateway.WebApi.Helpers;
 7            
 8            public static class OpenAIRequestParser
 9            {
10                public static async Task<OpenAIRequest?> ParseAsync(HttpContext? context, CancellationToken cancellationToken = defa
11  ✓  29  ◑      {
12  ✓  29  ◑          if (context == null) return null;
13            
14                    // Resolve configured max request body size from DI. Fall back to 10 MB if not available.
15  ✔  29             long MaxBodySize = 10L * 1024 * 1024; // 10 MB default
16                    try
17  ✔  29             {
18  ✔  29                 var opts = context.RequestServices.GetService(typeof(Microsoft.Extensions.Options.IOptions<Synaxis.Inference
19  ✓  28  ◑              if (opts?.Value != null)
20  ✔  28                 {
21  ✔  28                     MaxBodySize = opts.Value.MaxRequestBodySize;
22  ✔  28                 }
23  ✔  28             }
24  ✔   1             catch
25  ✔   1             {
26                        // swallow - use default
27  ✔   1             }
28            
29                    // If the client provided a Content-Length header, enforce it immediately.
30  ✔  29             var contentLength = context.Request.ContentLength;
31  ✓  29  ◑          if (contentLength.HasValue && contentLength.Value > MaxBodySize)
32  ❌  0             {
33  ❌  0                 throw new BadHttpRequestException($"Request body too large. Limit is {MaxBodySize} bytes.");
34                    }
35            
36                    // Enable buffering so we can read and then rewind for downstream middleware.
37  ✔  29             context.Request.EnableBuffering();
38  ✔  29             context.Request.Body.Position = 0; // Rewind just in case
39            
40                    string body;
41            
42  ✓  29  ◑          if (contentLength.HasValue)
43  ✔  29             {
44                        // Content-Length is known and already checked against the limit above.
45  ✔  29                 using var reader = new StreamReader(context.Request.Body, Encoding.UTF8, detectEncodingFromByteOrderMarks: t
46  ✔  29                 body = await reader.ReadToEndAsync(cancellationToken);
47  ✔  29             }
48                    else
49  ❌  0             {
50                        // Content-Length is unknown. Read the stream in bounded chunks to avoid OOM/DoS.
51  ❌  0                 using var ms = new MemoryStream();
52  ❌  0                 var buffer = new byte[8192];
53                        int bytesRead;
54  ❌  0                 long totalRead = 0;
55            
56  ❌  0  ○              while ((bytesRead = await context.Request.Body.ReadAsync(buffer.AsMemory(0, buffer.Length), cancellationToke
57  ❌  0                 {
58  ❌  0                     totalRead += bytesRead;
59  ❌  0  ○                  if (totalRead > MaxBodySize)
60  ❌  0                     {
61                                // Reset position for downstream just in case, then reject.
62  ❌  0                         context.Request.Body.Position = 0;
63  ❌  0                         throw new BadHttpRequestException($"Request body too large. Limit is {MaxBodySize} bytes.");
64                            }
65            
66  ❌  0                     ms.Write(buffer, 0, bytesRead);
67  ❌  0                 }
68            
69  ❌  0                 ms.Position = 0;
70  ❌  0                 using var reader = new StreamReader(ms, Encoding.UTF8, detectEncodingFromByteOrderMarks: true);
71  ❌  0                 body = await reader.ReadToEndAsync(cancellationToken);
72  ❌  0             }
73            
74                    // Reset the request body position so subsequent middleware can read it.
75  ✔  29             context.Request.Body.Position = 0;
76            
77  ✔  30  ●          if (string.IsNullOrWhiteSpace(body)) return null;
78            
79                    try
80  ✔  28             {
81  ✔  28                 return JsonSerializer.Deserialize<OpenAIRequest>(body, new JsonSerializerOptions { PropertyNameCaseInsensiti
82                    }
83  ✔   1             catch (JsonException ex)
84  ✔   1             {
85                        // If the body is invalid JSON for an OpenAI request, throw a BadHttpRequestException
86                        // so middleware can convert it to a 400. Do not swallow other exceptions (OOM, etc.).
87  ✔   1                 throw new BadHttpRequestException("Invalid JSON body", ex);
88                    }
89  ✔  28         }
90            }
```
# Synaxis.InferenceGateway.WebApi.Middleware.OpenAIErrorHandlerMiddleware

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Middleware.OpenAIErrorHandlerMiddleware |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Middleware/OpenAIErrorHandlerMiddleware.cs |
| **Line coverage:** | 86.2% (88 of 102) |
| Covered lines: | 88 |
| Uncovered lines: | 14 |
| Coverable lines: | 102 |
| Total lines: | 151 |
| **Branch coverage:** | 61.2% (38 of 62) |
| Covered branches: | 38 |
| Total branches: | 62 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **InvokeAsync()** | 61.53% | 62 | 52 | 84.78% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Middleware/OpenAIErrorHandlerMiddleware.cs
```
  1             using Microsoft.AspNetCore.Http;
  2             using System;
  3             using System.Collections.Generic;
  4             using System.Linq;
  5             using System.Net;
  6             using System.Text.Json;
  7             using System.Threading.Tasks;
  8             
  9             namespace Synaxis.InferenceGateway.WebApi.Middleware;
 10             
 11             public class OpenAIErrorHandlerMiddleware
 12             {
 13                 private readonly RequestDelegate _next;
 14             
 15  ✔   48         public OpenAIErrorHandlerMiddleware(RequestDelegate next)
 16  ✔   48         {
 17  ✔   48             _next = next;
 18  ✔   48         }
 19             
 20                 public async Task InvokeAsync(HttpContext context)
 21  ✔  136         {
 22                     try
 23  ✔  136             {
 24  ✔  136                 await _next(context);
 25  ✔  124             }
 26  ✔   12             catch (Exception ex)
 27  ✔   12             {
 28  ✔   13  ●              if (context.Response.HasStarted) throw;
 29             
 30                         // Special handling for AggregateException produced by the router
 31  ✔   11  ●              if (ex is AggregateException agg)
 32  ✔    4                 {
 33  ✔    4                     var flat = agg.Flatten();
 34  ✔    4                     var details = new List<object>();
 35  ✔    4                     var summaries = new List<string>();
 36  ✔    4                     var statusCodes = new List<int>();
 37             
 38  ✔   24  ●                  foreach (var inner in flat.InnerExceptions)
 39  ✔    6                     {
 40                                 // Provider name: try Data["ProviderName"], then Source, then exception type name
 41  ✓    6  ◕                      string provider = inner.Data.Contains("ProviderName") && inner.Data["ProviderName"] is string p && !
 42  ✔    6                             ? p
 43  ✔    6                             : (!string.IsNullOrEmpty(inner.Source) ? inner.Source : inner.GetType().Name);
 44             
 45                                 // Try to extract a status code from common exception types or reflection as fallback
 46  ✔    6                         int status = 500;
 47  ✔    6  ●                      if (inner is HttpRequestException hre && hre.StatusCode.HasValue)
 48  ✔    5                         {
 49  ✔    5                             status = (int)hre.StatusCode.Value;
 50  ✔    5                         }
 51                                 else
 52  ✔    1                         {
 53                                     // Use robust reflection to avoid AmbiguousMatchException when multiple
 54                                     // properties with the same name are present (explicit interface impls, etc).
 55  ✔    1                             var statusProp = inner.GetType().GetProperties()
 56  ✓   10  ○                              .FirstOrDefault(p => string.Equals(p.Name, "StatusCode", StringComparison.OrdinalIgnoreCase)
 57  ✔   10                                                      && (p.PropertyType == typeof(int)
 58  ✔   10                                                          || p.PropertyType == typeof(HttpStatusCode)
 59  ✔   10                                                          || p.PropertyType == typeof(System.Net.HttpStatusCode)));
 60  ✓    1  ◑                          if (statusProp != null)
 61  ❌   0                             {
 62                                         try
 63  ❌   0                                 {
 64  ❌   0                                     var val = statusProp.GetValue(inner);
 65  ❌   0  ○                                  if (val is int i) status = i;
 66  ❌   0  ○                                  else if (val is HttpStatusCode hc) status = (int)hc;
 67  ❌   0  ○                                  else if (val is System.Net.HttpStatusCode hcc) status = (int)hcc;
 68  ❌   0                                 }
 69  ❌   0                                 catch
 70  ❌   0                                 {
 71                                             // ignore reflection failures and keep default
 72  ❌   0                                 }
 73  ❌   0                             }
 74  ✔    1                         }
 75             
 76  ✔    6                         statusCodes.Add(status);
 77             
 78                                 // Clean up message: remove newlines for summary
 79  ✓    6  ◑                      var cleanMsg = inner.Message?.Replace("\r", "")?.Replace("\n", " ") ?? "Unknown error";
 80  ✓    6  ◑                      if (cleanMsg.Length > 100) cleanMsg = cleanMsg.Substring(0, 97) + "...";
 81             
 82  ✔    6                         summaries.Add($"[{provider}: {status} - {cleanMsg}]");
 83             
 84  ✔    6                         details.Add(new
 85  ✔    6                         {
 86  ✔    6                             provider,
 87  ✔    6                             message = inner.Message,
 88  ✔    6                             status = status
 89  ✔    6                         });
 90  ✔    6                     }
 91             
 92                             // Determine overall status code
 93                             int overallStatus;
 94  ✔    9  ●                  bool anyRetriable = statusCodes.Any(sc => sc == 429 || (sc >= 500 && sc < 600));
 95  ✔    9  ●                  bool allClientErrors400or404 = statusCodes.Count > 0 && statusCodes.All(sc => sc == 400 || sc == 404);
 96             
 97  ✔    4  ●                  if (anyRetriable)
 98  ✔    3                     {
 99  ✔    3                         overallStatus = (int)HttpStatusCode.BadGateway; // 502
100  ✔    3                     }
101  ✓    1  ◑                  else if (allClientErrors400or404)
102  ✔    1                     {
103  ✔    1                         overallStatus = (int)HttpStatusCode.BadRequest; // 400
104  ✔    1                     }
105                             else
106  ❌   0                     {
107  ❌   0                         overallStatus = (int)HttpStatusCode.InternalServerError; // fallback
108  ❌   0                     }
109             
110  ✔    4                     var message = $"Routing failed. Details: {string.Join(", ", summaries)}";
111             
112  ✔    4                     context.Response.StatusCode = overallStatus;
113  ✔    4                     context.Response.ContentType = "application/json";
114             
115  ✔    4                     var error = new
116  ✔    4                     {
117  ✔    4                         error = new
118  ✔    4                         {
119  ✔    4                             message = message,
120  ✔    4                             code = "upstream_routing_failure",
121  ✔    4                             details = details
122  ✔    4                         }
123  ✔    4                     };
124             
125  ✔    4                     await context.Response.WriteAsync(JsonSerializer.Serialize(error));
126  ✔    4                     return;
127                         }
128             
129                         // Non-aggregate exceptions: keep previous behavior
130  ✔    7  ●              var statusCode = ex is ArgumentException ? (int)HttpStatusCode.BadRequest : (int)HttpStatusCode.InternalServ
131  ✔    7  ●              var type = ex is ArgumentException ? "invalid_request_error" : "server_error";
132  ✔    7  ●              var code = ex is ArgumentException ? "invalid_value" : "internal_error";
133             
134  ✔    7                 context.Response.StatusCode = statusCode;
135  ✔    7                 context.Response.ContentType = "application/json";
136             
137  ✔    7                 var singleError = new
138  ✔    7                 {
139  ✔    7                     error = new
140  ✔    7                     {
141  ✔    7                         message = ex.Message,
142  ✔    7                         type = type,
143  ✔    7                         param = (string?)null,
144  ✔    7                         code = code
145  ✔    7                     }
146  ✔    7                 };
147             
148  ✔    7                 await context.Response.WriteAsync(JsonSerializer.Serialize(singleError));
149  ✔    7             }
150  ✔  135         }
151             }
```
# Synaxis.InferenceGateway.WebApi.Middleware.OpenAIMetadataMiddleware

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Middleware.OpenAIMetadataMiddleware |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Middleware/OpenAIMetadataMiddleware.cs |
| **Line coverage:** | 100% (30 of 30) |
| Covered lines: | 30 |
| Uncovered lines: | 0 |
| Coverable lines: | 30 |
| Total lines: | 43 |
| **Branch coverage:** | 100% (6 of 6) |
| Covered branches: | 6 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **InvokeAsync()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Middleware/OpenAIMetadataMiddleware.cs
```
 1             using Microsoft.AspNetCore.Http;
 2             using System.Threading.Tasks;
 3             
 4             namespace Synaxis.InferenceGateway.WebApi.Middleware;
 5             
 6             public class OpenAIMetadataMiddleware
 7             {
 8                 private readonly RequestDelegate _next;
 9             
10  ✔   37         public OpenAIMetadataMiddleware(RequestDelegate next)
11  ✔   37         {
12  ✔   37             _next = next;
13  ✔   37         }
14             
15                 public async Task InvokeAsync(HttpContext context)
16  ✔  125         {
17  ✔  125             context.Response.OnStarting(() =>
18  ✔  125             {
19  ✔  125  ●              if (context.Items.TryGetValue("RoutingContext", out var value) && value is RoutingContext rc)
20  ✔   14                 {
21  ✔   14                     context.Response.Headers["x-gateway-model-requested"] = rc.RequestedModel;
22  ✔   14                     context.Response.Headers["x-gateway-model-resolved"] = rc.ResolvedCanonicalId;
23  ✔   14                     context.Response.Headers["x-gateway-provider"] = rc.Provider;
24  ✔   14                 }
25  ✔  125                 else
26  ✔  111                 {
27  ✔  125                     // Ensure headers are present even if empty
28  ✔  111                     context.Response.Headers["x-gateway-model-requested"] = "";
29  ✔  111                     context.Response.Headers["x-gateway-model-resolved"] = "";
30  ✔  111                     context.Response.Headers["x-gateway-provider"] = "";
31  ✔  111                 }
32  ✔  125     
33  ✔  125  ●              if (!context.Response.Headers.ContainsKey("x-request-id"))
34  ✔  125                 {
35  ✔  125                     context.Response.Headers["x-request-id"] = context.TraceIdentifier;
36  ✔  125                 }
37  ✔  125     
38  ✔  125                 return Task.CompletedTask;
39  ✔  250             });
40             
41  ✔  125             await _next(context);
42  ✔  123         }
43             }
```
# Synaxis.InferenceGateway.WebApi.Middleware.RoutingContext

## Summary

|||
|:---|:---|
| Class: | Synaxis.InferenceGateway.WebApi.Middleware.RoutingContext |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Middleware/RoutingContext.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 2 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_RequestedModel()** | 100% | 1 | 1 | 100% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/Middleware/RoutingContext.cs
```
1            namespace Synaxis.InferenceGateway.WebApi.Middleware;
2  ✔  60     public record RoutingContext(string RequestedModel, string ResolvedCanonicalId, string Provider);
```
# System.Runtime.CompilerServices

## Summary

|||
|:---|:---|
| Class: | System.Runtime.CompilerServices |
| Assembly: | Synaxis.InferenceGateway.WebApi |
| **File(s):** | /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs |
| **Line coverage:** | 0% (0 of 3) |
| Covered lines: | 0 |
| Uncovered lines: | 3 |
| Coverable lines: | 3 |
| Total lines: | 23 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |

## File(s)

### /home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs
File '/home/rrj/src/github/rudironsoni/Synaxis/src/InferenceGateway/WebApi/obj/Debug/net10.0/Microsoft.AspNetCore.OpenApi.SourceGenerators/Microsoft.AspNetCore.OpenApi.SourceGenerators.XmlCommentGenerator/OpenApiXmlCommentSupport.generated.cs' does not exist (any more).

